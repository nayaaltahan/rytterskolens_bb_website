web.DAL=Ext.extend(one.backend.Base,{
baseUrl:'/api',
defaultUrl:'',
domain:'',
displayDomain:'',
constructor:function(config){
this.addEvents('needlogin','needmigrate');
this.version='v1';
this.isSessionActive=false;
web.DAL.superclass.constructor.call(this,config);
if(config.domain){
this.setDomain(this.domain)
}
this.uiState=new web.UIState({dal:this})
},
queueRequest:function(ajaxOptions,inFront){
one.fatal.recordDALAjaxRequests=one.fatal.recordDALAjaxRequests||'';
one.fatal.recordDALAjaxRequests+=ajaxOptions.url+' ;\n'||'Unable to get URL ;\n';
var headers=ajaxOptions.headers||{};
headers=Ext.apply({dataversionnumber:typeof 37!=='undefined'?37:''},headers);
web.DAL.superclass.queueRequest.call(this,Ext.applyIf({
headers:headers,
failure:Ext.emptyFn,
success:Ext.emptyFn,
scope:this,
callback:function(options,success,response){
var data,error;
if(response.status===412){
data=Ext.decode(response.responseText);
error=data?data.error:null;
if(error==='NeedsMigration'){
if(!this.isNeedMigrateFired){
this.isNeedMigrateFired=true;
this.fireEvent('needmigrate')
}
return
}
}
if(response.status===0||response.status===-1){
ajaxOptions.retry=ajaxOptions.retry||0;
if(ajaxOptions.retry<3){
ajaxOptions.retry+=1;
this.queueRequest(ajaxOptions,true);
return
}
}
if(response.status===401||response.status===403&&Ext.decode(response.responseText).error==='INVALIDORMISSINGCOOKIE'){
this.paused=true;
this.queueRequest(ajaxOptions,true);
if(Ext.decode(response.responseText).error==='INVALIDORMISSINGCOOKIE'&&this.isSessionActive){
Ext.Msg.show({
iconCls:'web-warning-icon',
cls:'web-modal-warning x-window-dlg',
title:'Attention',
msg:'You have been logged out.',
closable:false,
buttons:{ok:'OK'},
fn:function(buttonId){
this.fireEvent('needlogin')
},
scope:this
})
}else{
this.fireEvent('needlogin')
}
}else{
this.isSessionActive=true;
if(success){
if(ajaxOptions.success){
ajaxOptions.success.call(ajaxOptions.scope||this,response,ajaxOptions)
}
}else if(ajaxOptions.failure){
ajaxOptions.failure.call(ajaxOptions.scope||this,response,ajaxOptions)
}
if(ajaxOptions.callback){
ajaxOptions.callback.call(ajaxOptions.scope||this,ajaxOptions,success,response)
}
}
}
},ajaxOptions),inFront)
},
setDomain:function(domain){
this.domain=domain;
this.displayDomain=purify.domainIdn(domain);
this.defaultUrl=this.baseUrl+'/'+this.version+'/'+this.domain
},
getDomain:function(){
return this.domain
},
getDisplayDomain:function(){
return this.displayDomain
},
getEncryptedDomain:function(callback,scope){
this.queueRequest({
method:'GET',
url:this.defaultUrl+'/encryptedDomain',
callback:callback,
scope:scope||this
})
},
parseErrors:function(response){
var responseObj=Ext.decode(response.responseText);
if(responseObj.error&&responseObj.error.message==='Unauthorized'){
return[{isAuthenticationFailure:true}]
}
return[]
},
destroy:function(){
},
get:function(type,id,callback,scope){
this.queueRequest({
url:this.defaultUrl+'/doc/'+type+'/'+(type==='web.data.Site'?'site':id),
method:'GET',
callback:callback,
scope:scope||this
})
},
getWithDependents:function(id,type,callback,scope){
this.queueRequest({
url:this.defaultUrl+'/doc/'+type+'/'+id,
params:{all:true},
method:'GET',
callback:callback,
scope:scope||this
})
},
getWithDependentsAtTime:function(id,type,time,callback,scope){
this.queueRequest({
url:this.defaultUrl+'/doc/'+type+'/'+id,
params:{
all:true,
time:time
},
method:'GET',
callback:callback,
scope:scope||this
})
},
getCopyWithDependents:function(id,type,callback,scope){
this.queueRequest({
url:this.defaultUrl+'/doc/'+type+'/'+id,
params:{all:'copy'},
method:'GET',
callback:callback,
scope:scope
})
},
getAllPageData:function(pageId,callback,scope){
this.getWithDependents(pageId,'web.data.components.Page',callback,scope)
},
getAllTemplateData:function(templateId,callback,scope){
this.getWithDependents(templateId,'web.data.components.Template',callback,scope)
},
getList:function(type,stubsOk,callback,scope){
var url=this.defaultUrl+'/doc/'+type;
if(arguments.length===3){
scope=callback;
callback=stubsOk;
stubsOk=false
}
if(stubsOk){
url+='?stubs=true&type='+type
}
this.queueRequest({
url:url,
method:'GET',
callback:callback,
scope:scope
})
},
getDocsWithProperty:function(prop,value,callback,scope){
this.queueRequest({
url:this.defaultUrl+'/doc/?prop='+prop+'&value='+value+'&stubs=true',
method:'GET',
callback:callback,
scope:scope||window
})
},
set:function(part,callback,scope){
var obj,url;
if(part.check()){
obj=part.toJSON();
if(obj.type==='web.User'){
url=this.defaultUrl+'/preferences/1/webEditorUiState';
obj._rev=obj._rev||obj.etag
}else{
url=this.defaultUrl+'/doc/'+obj.type+'/'+obj.id
}
this.queueRequest({
method:'PUT',
url:url,
jsonData:obj,
success:function(xhr){
try{
var responseBody=Ext.decode(xhr.responseText);
part.etag=responseBody.etag;
if(responseBody.rev){
part.rev=responseBody.rev
}else if(responseBody._rev){
part._rev=responseBody._rev
}
}catch(e){
return
}
},
callback:callback,
scope:scope||this
})
}else{
one.fatal('Part is invalid',part);
throw'Part is invalid'
}
},
migrate:function(callback,scope){
this.queueRequest({
method:'POST',
url:this.defaultUrl+'/migrate',
timeout:5*60*1000,
callback:function done(opts,success,response){
callback.call(scope,success,success?Ext.decode(response.responseText):null)
},
scope:scope||this
})
},
getPublishedState:function(callback,scope){
this.queueRequest({
method:'GET',
url:this.defaultUrl+'/publish',
callback:callback,
scope:scope||this
})
},
getTimeline:function(threshold,numSavePoints,callback,scope){
this.queueRequest({
method:'GET',
url:this.defaultUrl+'/doc/timeline',
params:function(){
var ob={};
ob.threshold=threshold||10000||10000;
if(numSavePoints){
ob.numSavePoints=numSavePoints;
ob.reservedForPublications=0
}
return ob
}(),
callback:callback,
scope:scope||this
})
},
getSitemapAtTime:function(time,callback,scope){
this.queueRequest({
method:'GET',
url:this.defaultUrl+'/doc/web.data.Site/site?time='+time,
callback:callback,
scope:scope||this
})
},
getPreview:function(obj,id,callback,scope){
this.queueRequest({
method:obj?'POST':'GET',
url:this.defaultUrl+'/preview/'+id+'.html',
jsonData:obj,
callback:callback,
scope:scope||this
})
},
getPagePreviewUrl:function(pageId,options){
options=options||{};
if(options.prefersNewWSB){
this.getPagePreviewUrl.userPreferredNewWsbAtThatSavePoint=true;
return this.defaultUrl+'/preview-wbtgen/'+pageId+'.html'
}else{
this.getPagePreviewUrl.userPreferredNewWsbAtThatSavePoint=false;
return this.defaultUrl+'/preview/'+pageId+'.html'
}
},
getPagePreviewImageUrl:function(pageId){
return this.defaultUrl+'/preview/'+pageId+'.png'
},
getPreviewImageUrl:function(templateId,width,height,screenWidth){
var pageAsEncodedJson=encodeURIComponent(Ext.encode({
page:{
id:Math.uuid(),
type:'web.data.components.Page',
containers:[],
templateId:templateId
}
})),zoom=width/(screenWidth?screenWidth:1024);
return this.defaultUrl+'/preview/png?templateselectorpreview=desktop&body='+pageAsEncodedJson+'&zoom='+zoom+'&width='+width+'&height='+height+'&cropw='+width+'&croph='+height
},
getPreviewUrl:function(templateId){
var pageAsEncodedJson=encodeURIComponent(Ext.encode({
page:{
id:Math.uuid(),
type:'web.data.components.Page',
containers:[],
templateId:templateId
}
}));
return this.defaultUrl+'/preview/html?templateselectorpreview=desktop&body='+pageAsEncodedJson
},
getWebspaceContent:function(path,callback,scope){
this.queueRequest({
method:'GET',
url:this.defaultUrl+'/webspace'+path,
callback:callback,
scope:scope||this
})
},
getWebspaceFileMetadata:function(encodedPath,callback,scope){
this.queueRequest({
method:'GET',
url:this.defaultUrl+'/webspace'+encodedPath+(encodedPath.indexOf('?')===-1?'?':'&')+'metadata',
callback:callback,
scope:scope||this
})
},
getWebspacePath:function(path){
if(path.indexOf('repository:')===0){
return'/api/v1/repository/webspace'+path.replace('repository:','')
}else{
return this.defaultUrl+'/webspace'+path
}
},
doesWebspaceFileExist:function(encodedPath,callback,scope){
this.queueRequest({
method:'HEAD',
url:this.defaultUrl+'/webspace'+encodedPath,
callback:function(opts,success,response){
callback.call(scope,success&&(response.status>=200||response.status<400),response.status)
},
scope:scope||this
})
},
getPageImportData:function(path,callback,scope){
this.queueRequest({
method:'GET',
url:this.defaultUrl+'/reader?path='+this.encodeURI(path),
callback:callback,
scope:scope||this
})
},
publish:function(force,callback,scope){
var that=this;
that.queueRequest({
url:this.defaultUrl+'/publish',
timeout:4*60*1000,
params:force?{force:true}:undefined,
method:'POST',
callback:function(opts,success,response){
callback.call(scope||this,opts,success,response)
}
})
},
deletePart:function(type,id,callback,scope){
this.queueRequest({
url:this.defaultUrl+'/doc/'+type+'/'+id,
method:'DELETE',
callback:callback,
scope:scope||this
})
},
uploadToWebspace:function(data,encodedPath,etag,cbFunctions,scope){
var directoryPath=encodedPath.split('/').slice(0,-1).join('/'),req={
url:this.defaultUrl+'/webspace'+encodedPath,
method:'PUT',
headers:{},
timeout:120000,
callback:function(opts,success,response){
if(success){
this.getWebspaceFileMetadata(encodedPath,cbFunctions.onComplete,scope)
}else{
cbFunctions.onComplete.apply(scope||window,[
opts,
false,
response
])
}
},
onprogress:function(evt){
if(cbFunctions.onProgress){
cbFunctions.onProgress.apply(scope||window,[evt])
}
},
scope:this
},invalid=false;
function editRequestForDataUri(dataUri,dal){
var matches=dataUri.match(/^(?:data:)([^\/;]+\/[^;,]+)?(;base64)?,(.+)/),decodeBase64=Ext.ux.Base64.decode,extension,encoded,decoded;
encodedPath='/onewebmedia/'+new Date().getTime();
req.url=dal.defaultUrl+'/webspace'+encodedPath;
if(matches){
if(matches[1]&&/^image\//.test(matches[1])){
encoded=matches[3];
extension='.'+matches[1].replace(/^image\//,'');
encodedPath+=extension;
req.url+=extension
}else if(matches[2]===';base64'){
encoded=matches[3];
decoded=decodeBase64(encoded);
if(/^R0lGOD[l|D]B/.test(encoded)){
encodedPath+='.gif';
req.url+='.gif'
}else if(decodeBase64('/9g=')===decoded.slice(0,2)){
encodedPath+='.jpg';
req.url+='.jpg'
}else if(decodeBase64('iVBORw0KGgo=')===decoded.slice(0,8)){
encodedPath+='.png';
req.url+='.png'
}
}else{
invalid=true
}
req.url+='?base64=true';
req.file=encoded
}else{
invalid=true
}
}
if(Ext.isString(data)){
if(/^https?:\//.test(data)){
req.url+='?url='+encodeURIComponent(data)
}else if(/^data/.test(data)){
editRequestForDataUri(data,this)
}else{
invalid=true
}
}else{
if(window.File&&data instanceof window.File){
req.file=data
}else{
Ext.apply(req,{
url:this.defaultUrl+'/webspace'+directoryPath+'/',
isUpload:true,
form:Ext.DomHelper.append(Ext.getBody(),{
tag:'form',
action:req.url,
style:'display: none'
})
});
req.form.appendChild(data)
}
}
if(invalid){
cbFunctions.onComplete.apply(scope||window,[
req,
false,
null
])
}else{
this.queueRequest(req)
}
},
createWebspaceDirectory:function(path,callback,scope){
this.queueRequest({
url:this.defaultUrl+'/webspace'+path,
method:'PUT',
callback:callback,
scope:scope||this
})
},
canUseNewWebsiteBuilder:function(options,callback,scope){
var app=options.app,movingToNewWSB=options.movingToNewWSB;
var that=this,domain=that.domain;
var cb=function(canUse,failureReason,betaWsbCode){
callback(canUse,betaWsbCode);
if(canUse){
delete web.DAL.prototype.canUseNewWebsiteBuilder.lastFailureReason
}else{
web.DAL.prototype.canUseNewWebsiteBuilder.lastFailureReason=failureReason
}
};
if(!domain){
cb(false,'NEW_WSB_DOMAIN_NOT_AVAILABLE');
return
}
var hashCode=function(str){
str=str||'';
var hash=0;
var char;
if(str.length===0){
return hash
}
for(var i=0;i<str.length;i++){
char=str.charCodeAt(i);
hash=(hash<<5)-hash+char;
hash=hash&hash
}
return hash
};
var detectIeVersion=function(){
var ua=window.navigator.userAgent;
var msie=ua.indexOf('MSIE ');
if(msie>0){
return parseInt(ua.substring(msie+5,ua.indexOf('.',msie)),10)
}
var trident=ua.indexOf('Trident/');
if(trident>0){
var rv=ua.indexOf('rv:');
return parseInt(ua.substring(rv+3,ua.indexOf('.',rv)),10)
}
var edge=ua.indexOf('Edge/');
if(edge>0){
return parseInt(ua.substring(edge+5,ua.indexOf('.',edge)),10)
}
return false
};
var ieVersion=detectIeVersion(),isIe=!!ieVersion,isSupportedBrowser=false;
if(isIe){
if(ieVersion>=15){
isSupportedBrowser=true
}
}else{
isSupportedBrowser=true
}
var isChrome=function(){
var isChromium=window.chrome,winNav=window.navigator,vendorName=winNav.vendor,isOpera=winNav.userAgent.indexOf('OPR')>-1,isIEedge=winNav.userAgent.indexOf('Edge')>-1,isIOSChrome=winNav.userAgent.match('CriOS');
if(isIOSChrome){
return true
}else if(isChromium!==null&&typeof isChromium!=='undefined'&&vendorName==='Google Inc.'&&isOpera===false&&isIEedge===false){
return true
}else{
return false
}
};
if(isChrome()){
isSupportedBrowser=true
}else{
isSupportedBrowser=false
}
isSupportedBrowser=true;
var userHasAlreadyTriedOutNewWsb=((app.site||{}).betaWsbCode||'').length===40;
var shaObj=new jsSHA('SHA-1','TEXT');
shaObj.update(domain);
var shaHash=shaObj.getHash('HEX'),domainIsBlackListed=(['b505e91c4f0eb447007adeb466114f3d4e01261b']||[]).indexOf(shaHash)>=0,domainIsWhiteListed=([
'62f3d4e74f273b2fc90e955eaf6e3147d7f89c66',
'e4d59908b5db3b46723499f5896fa0bfc1165c2a',
'3a83c4ed2a51605e1d1b8b21f2bae2c0747d2d7b',
'6d2ecd9c36114106b886d924936cdfca2104ed99',
'bb3323417e565dc4800d12bac0005cb5c3e209e4',
'7fe11ed84a8bfd51492236d507fd964a681ab9c3',
'68d74f83a84ca42d74918f1b9b9e4a7c7417ad62',
'31a524986af77e9f0e6079ac2a64b90b4fbeb197',
'3d9d81cc761190b2a75ac5b3860a5ae0d34c5281',
'80aceade4f19b01a519da7ba7fce5165917cd745',
'80b534dadc5d5e8a7cce2a603a04953f1d6e7a2a',
'3553b09ffe4080c2076e8b5208ddda6143457b68',
'2e6b536f6dfd50a80795b110a2e8ac7d52212b6b',
'1616f86103625c1f25d5d4a7d456eea4d08c75a2',
'0f54651f3671fac48777cff5487a140852f7579c',
'09f57ed51773f5382f15a97641fb1b415cbd1927',
'64db771c10a7841548314a282b164c2a504b3b51',
'dff2d3446a8769edf69e58807431047ef7824f97',
'301e12bf0e95df5c8e49a5e4edfca23fbe7b7b2b',
'9de149261a605f57ea156271328c929642d0b6a1',
'd6872760f3994e97b0b5691c49e7ec61a63aa337',
'501231a59d1bf555557605606df2eb5afeeca050',
'cb10525c36191e223f4680d7f4d06b0ec688c7c6',
'c1345d6e4177a9cf7a44f1f5d6a8815bbd56c049',
'4eb6949e198faa1e82c9e89870a6b6dd40d2c4b5',
'541aa3fc9c8245b3ea3ceb33304ca0c612ea3fd1',
'515c599318355064936a0540edbd02e626ab54f5',
'415f0707fe556cdccd7d17e6ee06c8ffbc09dc64',
'b1ef880f067e054a3444738962794dd365ea0549',
'ad3be5bfabbf71a1a42ef6b8fb3a00c7d349facc',
'a19be8650968792098f8282260de8fb27575af9c',
'cf550ae6262c06204d069349d8d6fee6c6f6b377',
'b0cb44ee262c635906311cf5928c72370b23d284',
'9636a67660390dbbef1fdffa825e00474d88db7b',
'e2655cca389f1f87cb027e2288a337ccd356e23e',
'5d53caad2a62b328043186e6f3120ea0852d8987',
'33367fcfd7b8c003064122260fa7175fca9524b6',
'b1a4dcddd056593193d2b4c62243c4dcedc1cc10',
'0d090416d202dd78ec5273053c0bf76634d2efec',
'09890b809d66e20dcc145d27ea55ba89fd1fb10d',
'7fc7f27dd83424a1fdaf23c1321bf3aee935925b',
'fa822bb0e7cd2c9d5f3613838ed340898e57144d',
'89893c8d2c25e19202072dedf4a5d123048f4453',
'47682756071bc30c243c6558edd89e17393ea156',
'916a3bc75a85d1f49cd2ecf67d764ebb542ba2dd',
'877ff76ea6cb28ece69c6c6115adaca1fb036fdf',
'2b9e1903045e0de1ff4541359be2a3928c7e4fec',
'fdcc498283199d44d90fc640a2e6560e302b7801',
'a64eb87b75dbc25b65fb0cc4623d126d79cc542f',
'e77628ac9cb95c6457282f16e08e27e4b8f06cc8',
'c30e1ca986e5a747b173314eaebd2ed67b0f4703',
'2bb2ab89420b77e8df5700a28cf780e9ad07fe2d',
'84ff48075882d2b0efc10b985883f981e77fae3f',
'77fafe19b131164fde4106756f029887dba97364',
'c5dd21ebd0cc68f34f97ed3c4eae7dda53082b21',
'b06dbeb4ef12a194299b0684f926865d8fafc432',
'c1134b16b6f6cf85468c98da87100e2d7b0e0df5',
'766143a87ec816e683c61c87f3147f8bd61d44a3',
'67faf3000acb5d635e832599df2a1dfe868524ac',
'092f0c95d86f6c34a82f8e895e79a9a23d557c6c',
'4f5344f5b03f75a3123ac84bbdb8f88d45021cd7',
'0a8201f1fd23449ac35321b0d95b3fc9889e024c',
'0d73e45dcba04aa85f94f22dabb282dffbecee6e',
'4841b532c5904a9e68158ec58f208fbd68c10f8a',
'dc78b7f12ba97dbd8c795fd397e943fc26617e79',
'd1f306ca018e708539fafe1aeeebdccb1a92057c',
'482dedc03dca1ce33aaac031bda0d5dae183644c',
'79dfc73f32ebef6266e6819fb6428aae6dffe7f5',
'7f4a640c12e86c2effc5cea7920e4361e2703e85',
'aa48b1bdc158aa728a0a9d4cd9f78516e5d02d18',
'7d891863effbfe11e10a788e86810dbc1705ebd3',
'2c839d9b5b0802091acb0a4500475cd34ef98108',
'758f0d67ab6a877d29c830bf01e5eae132b7867c',
'16d0519fdf2c26377f2dd080d709458c12380473',
'c0f595427af1702f361aeec157a2f5370725faa2',
'0b0f2b2e8059d0b8be4a138c99eab7de4250699a',
'262960239b92f6c8849c6e6c993482acbc1b4665',
'be24182db458240db7c971b7596ae91cc151ebf7',
'e5246c2c6fd9a112b3b57c7f43f83458cade5f55',
'3e85dc71c68c47aa178a28fe704b2aead2d6f4c0',
'b4f15b48e206f7e10a1e8df69119ad4ba64690f5',
'f6ac6ae732e9f1303e1d5ad1434f72f18d8efea2',
'5b0384a44b00052539557db580970c4de6d8d09c',
'7f3c66bd10ea2a3377e4577301bc1cbd7c05ecc4',
'c52fbcfa70b7dddb2c417e53a96d9b217726fdfb',
'c2e3b8acfd93323e71386b1c36c78ad981210426',
'fa22276280d841844db5ea82071f2d3f39d084b4',
'9f2120abcadb7f89377b545d89b7349da9dcefa9',
'70d26987871426cade2480745f99220b2e20c904',
'22e526c23c77e1f90808d67a9fbedb3e8d55491a',
'1e804564ee9b116e9ea650770b8ffda638d4d51b',
'94d7515394dc3cf156a814c3defcbae4a3047f61',
'f16fac39de875e82262e775b221a8b65e8b388dc',
'3b7eed5d3d43039520ce052c0555334cc5c6bc71',
'48265db96fe5985fc658643424537a5519b0ad60',
'5d5123c0948ba90a1fb7271adebd6d47f538a6fe',
'ddbbb0779bf6ae71bd535ab300b155cc62894b58',
'03dc1bf8f7a1bd54db4b1a112601089e9ea44c99',
'2154637a4753649de1b272a192e506bd067caf2d',
'157af01fa944815d5525ee6f41c5fe37a41a18ba',
'cb2ff08b19426c501166b40c015d6edcdd1cdc0a',
'44a4c5c76bbfc2761cc00b2377e81b3c7705fd7e',
'426134b9123365766962729279110fa7af56ef2d',
'9e46fdc03d205e41874a7cf046683cc283cb544f',
'e2655cca389f1f87cb027e2288a337ccd356e23e',
'8dd4dd6a4cb5b2dc2d0a9920b890c71f4071ce10',
'd5f5c02bd72873500253e7999cb2e7f8a7aed218',
'66af15e7652a921fe23f43746b28843478dbe3f2',
'7fed8a8ee0f3aac190cabf69f98cc91cb4d7576f',
'9d2535296c7232176e5f214762bcf048c0a5ae8b',
'6416ce625f4efc2ee02ed1a34da60f8bfa36f9e7',
'd98907dc0e1dfea7f3fef65e7b0feecec9ab4266',
'9eec36b00843be296cb1042d5ae2e889bc880369',
'e180d2a3fd11aa1725a84d505e7190b465f676bd',
'b6a62e76c91e37b3b36ff515ccf93016718a1bf8',
'c0d90f1ac6f46ce7a7d07f372517843d541880eb',
'501231a59d1bf555557605606df2eb5afeeca050',
'edd4ce385c5db3f2eb8629d96e64942b0fe8ae3c',
'43e7fb4693c528fccea750b713a4346486c50581',
'63205cd5b1fd1a65d309981435fba3814b3d3559',
'f416ee1efc69db60392c134ea745f2a7ec0058b8',
'4360dcedaa29d213057cf0aae1b89ca403a82c4a',
'dc3675922c4c9e833baf52651870ea3a4b91df4e',
'3f7e49d95df81236c7c44eeb871dccc2092e7f78',
'ab3c339df4222e39759efcf86bf9c5d1767d87af',
'84ff48075882d2b0efc10b985883f981e77fae3f',
'79dfc73f32ebef6266e6819fb6428aae6dffe7f5',
'd6872760f3994e97b0b5691c49e7ec61a63aa337',
'6e8c024761b2ca7470f252d9c35772e59ab7494c',
'33225b08198d8de8aa52dbac172d045fc77e0721',
'779dc2122a6b05f598448dfc99e018c7bdd7c008',
'9220a560d4efd633fa6c77664cb0cf728af8c8c8',
'4c779a354c49dc2fe3485612242fb3ce2fb12d83',
'0f439a1781a11e65a179e4412c5f812f69c68575',
'da59c12c48ccfa5f5ace3cffbc9e7c86112e5fac',
'8b13e278847d64b1338aaa100e15d3d4a3ef5031',
'ed63f0d10be0346606735f8da7c085d8dc3c55d8',
'2c839d9b5b0802091acb0a4500475cd34ef98108',
'758f0d67ab6a877d29c830bf01e5eae132b7867c',
'c0f595427af1702f361aeec157a2f5370725faa2',
'8d8494245b63f738a0d2a4727d455d7766868e77',
'48265db96fe5985fc658643424537a5519b0ad60',
'03dc1bf8f7a1bd54db4b1a112601089e9ea44c99',
'2154637a4753649de1b272a192e506bd067caf2d',
'1b68e930617715f8d705ae8a35e6531d28024c9b',
'766143a87ec816e683c61c87f3147f8bd61d44a3',
'67faf3000acb5d635e832599df2a1dfe868524ac',
'88b790d1acbc25153aa5c868a8eea7090e49a406',
'dc78b7f12ba97dbd8c795fd397e943fc26617e79'
]||[]).indexOf(shaHash)>=0,domainSatisfiesRandomCriteria=Math.abs(hashCode(domain)%10000)<(10000||0);
if(domainIsBlackListed){
cb(false,'NEW_WSB_BLACK_LISTED')
}else if(domainSatisfiesRandomCriteria||domainIsWhiteListed||userHasAlreadyTriedOutNewWsb){
if(isSupportedBrowser){
var userPassesSubscriptionCheck;
userPassesSubscriptionCheck=true;
if(!userPassesSubscriptionCheck){
cb(false,'FIRST_TIME_NEW_WSB_USER_NEEDS_TO_BE_NORMAL_USER_WITH_NO_FREE_UPGRADE')
}else{
var domainIsEligible=false;
domainIsEligible=true;
if(domainIsEligible){
var cookieLangCriteriaPassed=true;
if(cookieLangCriteriaPassed){
that.queueRequest({
method:'GET',
url:function(){
var url=that.defaultUrl+'/canUseNewWebsiteBuilder',params=[];
if(userHasAlreadyTriedOutNewWsb){
params.push('pageCountCheck=skip')
}
if(movingToNewWSB){
params.push('movingToNewWSB')
}
if(params.length){
url+='?'+params.join('&')
}
return url
}(),
callback:function(options,success,response){
if(success){
var json={};
try{
json=JSON.parse(response.responseText)
}catch(e){
}
if(json.matchesCriteria){
cb(true,null,json.betaWsbCode)
}else{
cb(false,'NEW_WSB_REJECTED_BY_SERVER_CHECK'+(json.failureReason?'_'+json.failureReason:''))
}
}else{
cb(false,'NEW_WSB_UNEXPECTED_ERROR_IN_SERVER_CHECK')
}
},
scope:scope||that
})
}else{
cb(false,'NEW_WSB_NEEDS_DA_OR_NB_COOKIE_OTHERWISE_EN_COOKIE_FOR_DK_OR_NO')
}
}else{
cb(false,'NEW_WSB_DOMAIN_NAME_NOT_ELIGIBLE')
}
}
}else{
cb(false,'NEW_WSB_BROWSER_NOT_SUPPORTED')
}
}else{
cb(false,'NEW_WSB_NEITHER_WHITELISTED_NOR_SATISFIES_RANDOM_CRITERIA_'+Math.abs(hashCode(domain)%10000))
}
},
getDomainOwnerData:function(callback,scope){
this.queueRequest({
method:'GET',
url:this.defaultUrl+'/ownerInfo',
callback:callback,
scope:scope||this
})
},
getEmailData:function(callback,scope){
this.queueRequest({
method:'GET',
url:this.defaultUrl+'/ownerInfo',
params:{email:true},
callback:callback,
scope:scope||this
})
},
encodeURI:function(path){
return path.split('/').map(encodeURIComponent).join('/')
},
jsonp:function(options){
return oneJQuery.jsonp({
url:options.url,
callbackParameter:'callback',
error:function(xOptions,textStatus){
options.error(xOptions,textStatus)
},
success:function(response,textStatus,xOptions){
options.success(response,textStatus,xOptions)
}
})
}
});
web.DAL.decodeHref=function(href){
try{
return decodeURIComponent(href)
}catch(e){
return window.unescape(href)
}
};
web.DM=Ext.extend(Object,{
Dict:function(){
var Dict=function(){
this.map={};
this.tree={}
};
Dict.prototype={
iterateTree:function(callback,subtree){
var prop,tree=subtree||this.tree;
for(prop in tree){
if(tree.hasOwnProperty(prop)){
if(callback.call(this,prop,tree,tree[prop])){
return true
}
if(this.iterateTree(callback,tree[prop])){
return true
}
}
}
},
getMapSize:function(){
var prop,amount=0;
for(prop in this.map){
if(this.map.hasOwnProperty(prop)){
amount+=1
}
}
return amount
},
push:function(obj){
var parent=obj.getParent(),path=[],lastItem=this.tree;
this.map[obj.getId()]=obj;
path.unshift(obj.id);
while(parent){
path.unshift(parent.id);
parent=parent.getParent()
}
path.forEach(function(item){
if(lastItem.hasOwnProperty(item)){
lastItem=lastItem[item]
}else{
lastItem[item]={};
lastItem=lastItem[item]
}
},this)
},
remove:function(item){
var id=Ext.isString(item)?item:item.getId(),map=this.map;
if(delete map[id]){
this.iterateTree(function(prop,tree){
if(prop===id){
this.iterateTree(function(prop){
delete this.map[prop]
},tree[prop]);
delete tree[prop];
return true
}
})
}
},
update:function(id,newParentId){
this.iterateTree(function(prop,tree){
if(prop===id){
var subtreeToMove=tree[prop];
delete tree[prop];
this.iterateTree(function(prop,tree){
if(prop===newParentId){
tree[prop][id]=subtreeToMove;
return true
}
});
return true
}
})
},
get:function(id){
return this.map[id]
}
};
return Dict
}(),
cacheSize:20,
site:null,
constructor:function(){
this.site=null;
this.dict=new this.Dict;
this.lru={
p:[],
t:[],
s:[]
}
},
destroy:function(){
var map=this.dict.map;
Object.keys(map).forEach(function(id){
if(map[id]){
map[id].set=null;
this.unregister(map[id])
}
},this);
this.dict.map=null;
this.dict.tree=null;
this.dict=null;
this.site=null;
this.lru=null
},
create:function(config){
this.cache(config);
var item=this.dict.get(config.id),i,instance,msg,ns,Construct;
if(item){
return item
}
if(!config.type){
one.fatal('Custom - config.type is not available',config)
}
ns=config.type.split('.');
Construct=web;
for(i=1;i<ns.length;i+=1){
if(!Construct[ns[i]]){
Construct=web.data.components.Block;
break
}
Construct=Construct[ns[i]]
}
if(Construct&&Construct.prototype){
instance=new Construct(Ext.apply({dm:this},config))
}else{
msg='Class '+config.type+' not found.';
one.debug(msg);
throw new Error(msg)
}
this.instrumentSet(instance);
this.register(instance);
return instance
},
instrumentSet:function(instance){
if(!instance._originalSet){
var lastId=instance.getId(),lastPid=instance.getParent()&&instance.getParent().getId()||null;
instance.dict=this.dict;
instance._originalSet=instance.set;
instance.set=function(){
var id=this.getId(),pid=this.getParent()&&this.getParent().getId();
this._originalSet.apply(this,arguments);
if(pid===null){
pid=this.getParent()&&this.getParent().getId()
}
if(lastId===id&&lastPid!==pid){
this.dict.update(id,pid)
}
lastId=id;
lastPid=pid
}
}
},
register:function(part){
var partId=part.getId?part.getId():part.id;
if(partId){
if(!this.dict.get(partId)){
this.dict.push(part);
if(part.getType&&part.getType()==='web.data.Site'){
this.site=part
}
return true
}else{
return false
}
}else{
one.error('Tried to register an object with no id',part);
return false
}
},
cache:function(config){
var lru=this.lru,page,template,stylesheet,templateId,stylesheetId;
config.id=config.id||Math.uuid();
if(config.type==='web.data.components.Page'){
lru.p.push(config.id);
if(lru.p.length>this.cacheSize){
page=this.get(lru.p.shift());
template=this.get(lru.t.shift());
templateId=template?template.getId():null;
stylesheet=this.get(lru.s.shift());
stylesheetId=stylesheet?stylesheet.getId():null;
if(templateId&&page&&page.templateId!==templateId&&!lru.t.some(function(item){
if(templateId===item){
return true
}
},this)){
this.unregister(template)
}
if(stylesheetId&&template&&template.stylesheetId!==stylesheetId&&!lru.s.some(function(item){
if(stylesheetId===item){
return true
}
},this)){
this.unregister(stylesheet)
}
if(page){
this.unregister(page)
}
}
}
if(config.type==='web.data.components.Template'){
lru.t.push(config.id)
}
if(config.type==='web.data.styles.Stylesheet'){
lru.s.push(config.id)
}
},
unregister:function(obj){
this.dict.remove(obj)
},
get:function(id){
var item=this.dict.get(id);
if(item){
return item
}else{
one.warn('Tried to fetch an unregistered id',id);
return undefined
}
},
getSite:function(){
return this.site
},
some:function(fn,scope){
var map=this.dict.map,result=false,prop;
scope=scope||window;
for(prop in map){
if(map.hasOwnProperty(prop)){
if(fn.call(scope,map[prop])){
result=true;
break
}
}
}
return result
}
});
web.Document=Ext.extend(Object,{
page:null,
styles:null,
styleMap:null,
onloadScripts:null,
seoHead:'',
head:null,
body:null,
footer:null,
requiredScripts:null,
scripts:null,
dm:null,
domain:null,
devHead:null,
devFooter:null,
preDocTypeCode:'',
previewTarget:null,
targetPreviewMode:null,
constructor:function(config){
this.impressions=[];
this.head=[];
this.endHead=[];
this.devHead=[];
this.body=[];
this.footer=[];
this.onloadScripts=[];
this.devFooter=[];
this.requiredScripts={};
this.scripts=[];
this.styles=[];
this.styleMap={};
this.css=[];
this.dm=null;
this.domain=null;
this.labels={};
this.editMode=false;
this.previewMode=false;
this.seoHead='';
this.preDocTypeCode='';
this.previewTarget=null;
this.targetPreviewMode=null;
this.time=null;
this.mobileMinWidth=320;
this.mobileMaxWidth=650;
this.cssMobile=[];
this.classPrefix=config.classPrefix;
if(config){
if(config.dm){
this.dm=config.dm
}
if(config.page){
this.page=config.page
}
if(config.domain){
this.domain=config.domain
}
if(config.labels){
this.labels=config.labels
}
if(config.editMode){
this.editMode=config.editMode
}
if(config.previewMode){
this.previewMode=config.previewMode
}
if(config.templateSelectorPreviewMode){
this.templateSelectorPreviewMode=config.templateSelectorPreviewMode
}
if(config.previewBackup){
this.previewBackup=config.previewBackup
}
if(config.visitor){
this.visitor=config.visitor
}
if(config.forceMobile){
this.forceMobile=config.forceMobile
}
if(config.previewTarget){
this.previewTarget=config.previewTarget
}
if(config.targetPreviewMode){
this.targetPreviewMode=config.targetPreviewMode
}
if(config.time){
this.time=config.time
}
if(config.isShadowRendering){
this.isShadowRendering=config.isShadowRendering
}
this.hdImages=config.hdImages===true
}
},
destroy:function(){
this.impressions=null;
this.head=null;
this.endHead=null;
this.devHead=null;
this.body=null;
this.footer=null;
this.devFooter=null;
this.footer=null;
this.requiredScripts=null;
this.scripts=null;
this.styles=null;
this.styleMap=null;
this.css=null;
this.dm=null;
this.onloadScripts=null;
this.seoHead=null;
this.preDocTypeCode=null;
this.cssMobile=null
},
reset:function(){
this.impressions=[];
this.head=[];
this.endHead=[];
this.devHead=[];
this.body=[];
this.footer=[];
this.devFooter=[];
this.requiredScripts=[];
this.scripts=[];
this.styles=[];
this.styleMap={};
this.css=[];
this.onloadScripts=[];
this.seoHead='';
this.preDocTypeCode='';
this.cssMobile=[]
},
setDM:function(dm){
this.dm=dm
},
getDM:function(){
return this.dm
},
getAssetURL:function(){
return'/api/v1/'+this.domain
},
setPage:function(page){
this.page=page
},
getPage:function(){
return this.page
},
toHTML:function(){
var mobileHTML=this.getMobileHTML(),css=this.getCSS(),html=this.preDocTypeCode+'<!DOCTYPE html>\n'+'<html>\n'+'<head>\n'+this.seoHead+'\n'+this.head.join('')+'\n'+'<style type="text/css">\n'+css+'</style>\n';
if(this.onloadScripts.length){
html+='<script type="text/javascript">'+'function  __init() {\n'+this.onloadScripts.join('')+'}'+'</script>\n'
}
html+=this.endHead.join('')+'</head>\n'+'<body class="body blockbody">\n'+mobileHTML+this.body.join('')+'<footer>\n'+this.footer.join('')+'</footer>\n'+'<div class="end"></div>\n';
if(this.onloadScripts.length){
html+='<script type="text/javascript">__init();</script>'
}
html+=this.getRequiredScriptTags()+this.scripts.join('')+'\n';
html+='</body>\n'+'</html>\n';
return html
},
toInnerHTML:function(){
return this.toBodyHTML()+this.toFooterHTML()
},
toBodyHTML:function(){
return this.body.join('')
},
toFooterHTML:function(){
return'<footer>'+this.footer.join('')+'</footer>'
},
setSeoHead:function(tags){
this.seoHead=tags
},
setPreDocTypeCode:function(code){
var id=Math.uuid();
this.preDocTypeCode='<!--#begin code '+id+'-->'+code+'<!--#end code '+id+'-->'
},
getSeoHead:function(){
return this.seoHead
},
addStyle:function(style){
var global;
if(style&&!this.hasStyle(style)){
global=style.getGlobal();
if(global&&!this.hasStyle(global)){
this.styles.push(global);
this.styleMap[global.getId()]=true
}
this.styles.push(style);
this.styleMap[style.getId()]=true
}
},
hasStyle:function(style){
return!!this.styleMap[style.getId()]
},
getStyles:function(){
return[].concat(this.styles)
},
getStylesCSS:function(){
var i,style,styles=this.getStyles(),css=[];
for(i=0;i<styles.length;i+=1){
style=styles[i];
if(style){
css.push(style.toCSS(this))
}
}
return css.join('')
},
getCSS:function(){
return this.getDefaultCSS()+this.css.join('')+this.getStylesCSS()+this.getMobileCSS()
},
getDefaultCSS:function(){
var css='.body{text-align:left;position:relative;}\n'+'body,div,ul,ol,li,h1,h2,h3,h4,h5,h6,form,input,p,td,textarea{margin:0;padding:0}\n'+'table{border-collapse:collapse;border-spacing:0}\n'+'img{border:0}\n'+'ol,ul{list-style:none}\n'+'h1,h2,h3,h4,h5,h6{font-size:100%;font-weight:normal;margin:0}\n'+'html,body{-moz-box-sizing:border-box;box-sizing:border-box}\n'+'.component{-moz-box-sizing:border-box!important;box-sizing:border-box!important}\n'+'html,body,.body{min-height:100%;}\n'+(this.previewMode?'':'body,.body{overflow:visible;}\n')+'*{-webkit-font-smoothing: antialiased;-webkit-text-size-adjust: 100%;-moz-text-size-adjust: 100%;-ms-text-size-adjust: 100%;}\n'+'.textend,.end{clear:both;}\n'+'.stretch{min-width:100%;border-left:0px none!important;border-right:0px none!important;}\n'+(this.editMode?'':'.block{cursor:default;}\n')+'.menu td{vertical-align:top;}\n'+'.menu table{width:100%;table-layout:fixed;}\n'+'.text{white-space:pre-wrap;line-height:1.2;word-wrap:break-word;}\n'+'.text ol,.text ul{overflow:hidden;}'+'.text ol,.text ul{padding-left:40px}\n'+'.text ol[style*="roman"]{padding-left:65px !important}\n'+'.image,.image>.block{overflow:hidden;}\n'+'.image .imageself{width:100%;height:100%;overflow:hidden;}\n'+'@media (min-width: '+(this.mobileMaxWidth+1)+'px) {\n'+'.image>.imageself>img,'+'.image>.imageself>a>img,'+'.chrome-border-fix.image{-webkit-mask-image:-webkit-radial-gradient(circle, white 100%, black 100%);}\n'+'}\n'+'.textblock{white-space:normal;position:relative;}\n'+'.textblockleft{float:left;clear:left;padding-right:10px;}\n'+'.textblockright{float:right;clear:right;padding-left:10px;}\n'+'.textblockcenter{display:block;margin:0px auto;clear:both;}\n'+'.texttable{table-layout:fixed;border-collapse:collapse;}\n'+'.texttable .textblock{position:relative;}\n'+'.body a img{border-width:0}\n'+'.body a .xh,.body a .xp,'+'.body a:hover .xi,.body a:active .xi{display:none}\n'+'.body a:hover .xh,.body a:active .xp{display:inline}\n'+'.menuself ul, .bodysubmenu ul{display:table;list-style:none;margin:0;clear:both}\n'+'.menuself li, .bodysubmenu li{margin:0; position:relative;}\n'+'.menuself .menuitem, .bodysubmenu .menuitem{display:block;cursor:pointer}\n'+'.menuself .menuitem.disabled, .bodysubmenu .menuitem.disabled{cursor:auto}\n'+'.menuself .indent, .bodysubmenu .indent{display:block}\n'+'.menuself .divider, .bodysubmenu .divider{line-height:0}\n'+'.menuitem {transition:background-color .2s ease-out,color .2s ease-out}\n'+'.menuhorizontal>ul{font-size:0px;}\n'+'.menuhorizontal>ul>li{display:inline-table;}\n'+'.menuhorizontal>ul>li>div, .bodysubmenu > div {display:table-cell}\n'+'.menuhorizontal>ul>li>.divider{width:0px}\n'+'.menuhorizontal.menuhorizontalfit>ul>li{float:none;display:table-cell}\n'+'.menuhorizontalleft>ul{float:left;text-align:left;}\n'+'.menuhorizontalcenter>ul{margin:0px auto;text-align:center;}\n'+'.menuhorizontalright>ul{float:right;text-align:right;}\n'+'.menuhorizontalfit ul{-moz-box-sizing:border-box;box-sizing:border-box;width:100%;}\n'+'.menuhorizontal.menuhorizontalfit ul{width:100%;}\n'+'.menuself{display:table-cell;height:100%}\n'+'.menuverticalmiddle{vertical-align:middle}\n'+'.menuverticalbottom{vertical-align:bottom}\n'+'.menucascade{background:url(/api/v1/repository/webspace/transparent.gif);}'+'.menuself li:hover>.menucascadeanchor>.menucascade,'+'.menuself li:hover>div>.menucascadeanchor>.menucascade,'+'.bodysubmenu>.menucascadeanchor>.menucascade,'+'.bodysubmenu li:hover>.menucascadeanchor>.menucascade,'+'.bodysubmenu li:hover>div>.menucascadeanchor>.menucascade{display:block;z-index:3000;}'+'.menuself .menucascadeanchor, .bodysubmenu .menucascadeanchor{position:absolute;}'+'.menuhorizontal.menuhorizontalright .menucascade .menucascade{right:0px;}'+'.menuself ul.menucascade, .bodysubmenu ul.menucascade{position:absolute;display:none;}'+'.bodysubmenu{position:absolute;display:none;z-index:900;}'+'.menucascade .menucascadeanchor, .menuvertical .menucascadeanchor{top:0px;right:0px;}'+'.menuhorizontal.menuhorizontalright .menucascade .menucascadeanchor{left:0px;right:auto;}'+'.displayNone{display: none !important;}'+'.menuself .menucascade .menuitem, .bodysubmenu .menucascade .menuitem{display:block;width:auto;float:none;clear:none;}'+'.menuself .menucascade li, .bodysubmenu .menucascade li{display:block;float:left;clear:both;width:100%;}'+'.menuself .menucascade .divider, .bodysubmenu .menucascade .divider{display:block;width:auto;float:none;clear:both;}'+'.button,.previewbutton{display:inline-block}'+'input.previewbutton{padding:5px 10px;cursor:pointer;min-width:130px;min-height:50px;text-align:center;background-clip:border-box!important}'+'.buttonself>div{text-align:center;height:inherit;box-sizing:border-box;overflow:hidden;transition:background-color .2s ease-out,border .2s ease-out,color .2s ease-out;background-clip:border-box!important}'+'.buttonself>div>a{color:inherit;text-decoration:none;white-space:nowrap;padding:5px 10px;display:table;height:100%;width:100%;box-sizing:border-box}'+'.buttonself>div>a>span{display:table-cell;vertical-align:middle;line-height:1}'+'input.contact-form-submit-btn{padding:5px 10px}'+'.contact-form-field-container select {max-width: 100%!important;}\n'+'.shareself>div{width:inherit;display:inline-block;overflow:hidden;}\n'+'.shareself>div>div{height:inherit;display:table;vertical-align:middle;width: 100%;}\n'+'.shareself ul.shareButtonCntnr{display:table-cell;width:99%;vertical-align:middle;}\n'+'.shareself ul.shareButtonCntnr.center{text-align:center}\n'+'.shareself ul.shareButtonCntnr.right{text-align:right}\n'+'.shareself ul.verticalCountCls{padding-bottom:40px;}\n'+'.shareself ul.withoutCountCls{padding-bottom:5px;}\n'+'.shareself ul.extraInfoCls{padding-top:9px;}\n'+'.shareself ul.roundStyleCls{padding-bottom: 16px;}\n'+'.shareself ul.squareStyleCls{padding-bottom: 18px;}\n'+'.shareself ul.shareButtonCntnr li {display:inline-block;height:20px;margin-right:15px;line-height:12px}\n'+'.shareself ul.shareButtonCntnr li.linkedInCls {margin-right:10px;}\n'+'.shareself ul.shareButtonCntnr.verticalCountCls li {height:auto;}\n'+'.shareself ul.withoutCountCls li.withoutCountFblikeCntnr, .withoutCountFblikeCntnr {line-height:0;overflow:hidden;}\n'+'.shareself ul.withoutCountCls li.g-plusone-cntnr {line-height:0;}\n'+'.shareself ul.withoutCountCls li.linkedInwithoutcntCls {width:59px;}\n'+'.shareself ul.withoutCountCls li.twtrCls {line-height:0;width:56px;}\n'+'.shareself ul.extraInfoCls li {display:block;height:auto;margin-right:0 !important;}\n'+'.shareself ul.extraInfoCls li.fbLikeExtraInfoCls {height:24px;}\n'+'.shareself ul.extraInfoCls li.g-plusone-cntnr {padding-top: 4px;padding-bottom:6px;}\n'+'.shareself ul.extraInfoCls li.linkedInCls {padding-top: 1px;}\n'+'.shareself ul.extraInfoCls li.twtrCls {padding-top: 6px;}\n'+'.shareself ul.roundStyleCls li, .shareself ul.squareStyleCls li {width:39px;height:auto;}\n'+'.shareself ul.roundStyleCls li div.icon, .shareself ul.squareStyleCls li div.icon{height:39px;}\n'+'.shareself ul.shareButtonCntnr li:nth-last-child(1) {margin-right: 0px;}\n'+'.imagesliderself .slider-caption {position:absolute;padding:5px;color:#fff;background-color: #000;background-color: rgb(0, 0, 0);background-color: rgba(0, 0, 0, 0.5);}'+'.imagesliderself .textnormal p.slider-caption > * {color: #fff}'+'.imagesliderself .owl-pagination-visibility-never .slide-cntnr.bottom p.slider-caption{bottom:0px}'+'.imagesliderself .owl-pagination-visibility-never .owl-pagination{display:none}'+'.imagesliderself .owl-navigation-visibility-never .owl-buttons{display:none}'+'.imagesliderself .slide-cntnr.bottom p.slider-caption{bottom:35px}'+'.imagesliderself .slide-cntnr.top p.slider-caption{top:0}'+'.imagesliderself .slide-cntnr.middle p.slider-caption{bottom:0;top:0;margin: auto;height:15px}'+'.gallery img{display:block;margin:auto;}'+'.gallery .gallery-cell{display:inline-block;vertical-align:top;overflow:hidden;}'+'.gallery .gallery-cell div{margin:auto;}'+'.gallery .gallery-caption{margin:auto;box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;}'+'.container-link {cursor:pointer;}';
if(this.editMode){
css+='.clear{border:1px dashed #999;height:100%;'+'-moz-box-sizing:border-box!important;'+'box-sizing:border-box!important;}\n';
css+='.empty,.emptyerror{border:1px dashed #999;'+'padding:3px 4px;color:#999;font:12px/1 tahoma, arial, helvetica, sans-serif;overflow:hidden}\n'+'.emptyerror{border-color:#C33;color:#C33}\n'
}
return css
},
getRequiredScriptTags:function(){
var requiredScripts=this.requiredScripts,prop,tags='';
for(prop in requiredScripts){
if(requiredScripts.hasOwnProperty(prop)){
tags+=requiredScripts[prop]
}
}
return tags
},
addOnloadScript:function(js,once){
if(typeof js==='function'){
js=js.toString();
js=js.slice(js.indexOf('{')+1,js.lastIndexOf('}'))
}
if(!once||once&&this.onloadScripts.indexOf(js)<0){
this.onloadScripts.push('(function () {\n'+js+'\n})();\n')
}
},
appendToHead:function(html,once){
if(!once||once&&this.head.indexOf(html)<0){
this.head.push(html)
}
},
appendToEndHead:function(html,once){
if(!once||once&&this.head.indexOf(html)<0){
this.endHead.push(html)
}
},
appendToDevHead:function(html){
this.devHead.push(html)
},
appendToCSS:function(css){
this.css.push(css)
},
requireScript:function(js){
var script=web.Document.scripts[js];
if(script&&!this.requiredScripts[js]){
this.appendToHead('<script id=\'bootstrapper\'>\n'+'GETSTATICURL = function (url) {\n'+'   var placeHolderValues = Array.prototype.slice.call(arguments, 1);\n'+'   return url.replace(/\\*\\*?/g, function ($0) {\n'+'       return placeHolderValues.shift();\n'+'   });\n'+'};\n'+'</script>',true);
if(Ext.isString(script)){
this.requiredScripts[js]=script
}else{
if(script.deps){
script.deps.forEach(function(dependency){
this.requireScript(dependency)
},this)
}
if(script.css){
this.appendToHead(script.css,true)
}
this.requiredScripts[js]=script.src
}
}
},
prependToScripts:function(html){
this.scripts.splice(0,0,html)
},
appendToScripts:function(html){
this.scripts.push(html)
},
openTag:function(config){
var tag=config.tag?config.tag:'div',cfg=Ext.apply({},config),newLine=true,html,att,name,atts={
cls:'class',
style:'style',
href:'href',
target:'target'
};
if(this.previewMode){
atts.title='title'
}
if(cfg.newLine!==undefined){
newLine=cfg.newLine;
delete cfg.newLine
}
html='<'+tag;
for(att in cfg){
if(cfg.hasOwnProperty(att)){
if(att!=='tag'&&cfg[att]){
if(Ext.isObject(cfg[att])){
for(name in cfg[att]){
if(cfg[att].hasOwnProperty(name)){
html+=' '+name+'="'+cfg[att][name]+'"'
}
}
}else{
html+=' '+(atts[att]?atts[att]:'data-'+att)+'="'+cfg[att]+'"'
}
}
}
}
html+='>'+(newLine?'\n':'');
this.body.push(html)
},
closeTag:function(cfg){
cfg=typeof cfg==='object'?cfg:{tag:cfg};
var tag=cfg.tag?cfg.tag:'div',newLine=cfg.newLine!==undefined?cfg.newLine:true;
this.body.push('</'+tag+'>'+(newLine?'\n':''))
},
prependToBody:function(html,once){
if(!once||once&&this.body.indexOf(html)<0){
this.body.splice(0,0,html)
}
},
appendToBody:function(html,once){
if(!once||once&&this.body.indexOf(html)<0){
this.body.push(html)
}
},
appendLabel:function(name){
var label=this.labels[name];
if(label){
this.body.push(label+'\n')
}
},
prependToFooter:function(html,once){
if(!once||once&&this.footer.indexOf(html)<0){
this.footer.splice(0,0,html)
}
},
appendToFooter:function(html,once){
if(!once||once&&this.footer.indexOf(html)<0){
this.footer.push(html)
}
},
appendToDevFooter:function(html){
this.devFooter.push(html)
},
isMobile:function(){
try{
return this.forceMobile||this.getPage().getTemplate().isMobile()
}catch(e){
return false
}
},
appendToCSSMobile:function(css){
this.cssMobile.push(css)
},
getMobileCSS:function(){
var css='';
if(!this.isMobile()){
return''
}
css+='\n@media (max-width: '+this.mobileMaxWidth+'px) {\n'+'html {'+'-webkit-text-size-adjust:100%;'+'}\n'+'.body {'+'border-width:0px!important;'+'padding:0px!important;'+'}\n'+'.block, .self, .row, .col, .extra, .menu, .component {'+'position:static!important;'+'display:block!important;'+'float:none!important;'+'clear:both!important;'+'width:100%!important;'+'height:auto!important;'+'min-width:0px!important;'+'min-height:0px!important;'+'-moz-box-sizing:border-box!important;'+'box-sizing:border-box!important;'+'z-index:0;'+'}\n'+'.block, .extra, .col, .row {'+'padding:0px!important;'+'margin:0px!important;'+'border-width:0px!important;'+'border-radius:0px!important;'+'}\n'+'.empty {'+'display:none;'+'}\n'+'.mobile-leaf {'+'padding:10px 18px!important;'+'}\n'+'.textblock .mobile-leaf {'+'padding: 0 !important;'+'}\n'+'.mobile-forcehide {'+'display:none!important;'+'}\n'+'.mobile-leaf.code {'+'white-space: normal;'+'word-wrap: break-word;'+'}\n'+'.web-widget.web-widget-document-viewer {'+'height:90vh!important;'+'}\n'+'img {'+'margin:0px auto!important;'+'}\n'+'img.mobile-shrunk {'+'width:100%!important;'+'height:auto!important;'+'}\n'+'.imageself>img{max-width:100%;height:auto;}\n'+'.imageself>a>img{max-width:100%;height:auto;}\n'+'.image .imageself .container-link{min-height: auto !important;}\n'+'.mobile-leaf .texttable {'+'width:100%!important;'+'}\n'+'.mobile-leaf .texttable col {'+'display:none;'+'}\n'+'.menuself {'+'display:none!important;'+'}\n'+'.mobile-leaf.menuself {'+'display:block!important;'+'padding:5px!important;'+'}\n'+'.mobile-leaf.menuself ul {'+'display:none!important;'+'}\n'+'.text ul,.text div.mb-indent{padding-left:20px !important}\n'+'.text ol{padding-left:45px !important}\n'+'.text ol[style*="roman"]{padding-left:65px !important}\n'+'.text .image {'+'padding:0px 0px 5px!important;'+'margin:0px!important;'+'}\n'+'.text .image img {'+'max-width:100%!important;'+'height:auto!important;'+'}\n'+'.imageself>a {'+'display:block;'+'width:100%!important;'+'min-height:inherit!important;'+'text-decoration:inherit;'+'}\n'+'.text .textblock {'+'-moz-box-sizing:border-box!important;'+'box-sizing:border-box!important;'+'min-width:20%!important;'+'max-width:50%!important;'+'margin:0px!important;'+'height:auto!important;'+'}\n'+'.text .textblockleft {'+'float:left!important;'+'clear:left!important;'+'padding-right:10px!important;'+'width:auto!important;'+'}\n'+'.text .textblockright {'+'float:right!important;'+'clear:right!important;'+'padding-left:10px!important;'+'width:auto!important;'+'}\n'+'.text .textblockcenter {'+'margin:0px auto!important;'+'}\n'+'.text .textheading1.mobile-oversized {'+'font-size:40px!important;'+'}\n'+'.text .textheading2.mobile-oversized {'+'font-size:28px!important;'+'}\n'+'.text .textheading3.mobile-oversized {'+'font-size:24px!important;'+'}\n'+'.text .mobile-oversized {'+'font-size:20px!important;'+'}\n'+'.mobile-oversized p>*, .mobile-oversized ol, .mobile-oversized ul {'+'font-size:20px;'+'}\n'+'.text .mobile-undersized-lower {'+'font-size:12px!important;'+'}\n'+'.mobile-undersized-lower p>*, .mobile-undersized-lower ol, .mobile-undersized-lower ul {'+'font-size:12px;'+'}\n'+'.imagesliderself .slider-caption {display: none;}\n'+'.imagesliderself > div,'+'.owl-item .slide-cntnr,'+'.owl-item .slider-item {'+'min-height: auto !important;'+'}'+'.buttonself{text-align:center;padding:10px 18px!important;}\n'+'.buttonself>div{display:table;width:100%;padding:5px 10px;min-height: 50px;table-layout:fixed;}\n'+'.buttonself>div>a{display:flex;align-items:center;justify-content:center;padding:0;min-height:40px;}\n'+'.buttonself>div>a>span{white-space:normal;word-wrap:break-word;vertical-align:middle;font-size:16px!important;display:table-cell;}\n'+'input.contact-form-submit-btn{text-align:center;font-size:16px;width:100%!important;min-height:50px!important;}\n'+'.contact-form-field-container select {max-width: 100%!important;}\n'+'.contactFormContainer form>div {padding: 0px !important}\n'+'.contactFormContainer form>div.contact-form-submit-btn-container {padding: 5px 0px !important}\n'+'.contactFormContainer .oneWebCntForm, contactFormContainer .contactFormResponseStatus {padding: 0px 0px 10px 0px}\n'+'.webshop-comp {margin-left: -16px; margin-right: -16px}\n'+'.gallery {padding: 10px 13px !important}\n'+'.gallery .gallery-cell{'+'box-sizing: border-box !important;'+'-moz-box-sizing:border-box !important;'+'-webkit-box-sizing:border-box !important;'+'width:50% !important;'+'padding:5px !important;'+'}\n'+'.gallery.uncropped .img{'+'height:80px !important;'+'}\n'+'.gallery img{'+'width:100% !important;'+'height:auto !important;'+'}\n'+'.gallery-caption{'+'width:auto !important;'+'}\n'+'.shareContainer{'+'width:auto !important;'+'}\n'+'.fblikeHCntnr{'+'width:88px'+'}\n'+'.fblikeVCntnr{'+'width:47px'+'}\n'+'.fbrecomendHCntnr{'+'width:128px'+'}\n'+'.fbrecomendVCntnr{'+'width:92px'+'}\n'+'.fbrecomendHCntnr~li{width:132px;}\n';
css+=this.cssMobile.join('');
css+='}\n';
css+='\n@media (min-width: '+Math.round((this.mobileMinWidth+this.mobileMaxWidth)/2)+'px) and (max-width: '+this.mobileMaxWidth+'px) {\n'+'.text .mobile-undersized-upper {'+'font-size:16px!important;'+'}\n'+'.mobile-undersized-upper p>*, .mobile-undersized-upper ol, .mobile-undersized-upper ul {'+'font-size:16px;'+'}\n'+'}\n';
css+='\n@media (max-width: '+this.mobileMaxWidth+'px) {\n'+'img.mobile-fit {'+'max-width:100%!important;'+'height:auto!important;'+'}\n'+'}\n';
css+='\n@media (max-width: '+this.mobileMinWidth+'px) {\n'+'img.mobile-fit {'+'width:100%!important;'+'height:auto!important;'+'}\n'+'}\n';
return css
},
shouldMenuBeShown:function(){
function findVisibleItems(items){
return items.filter(function(item){
return!item.hidden
})
}
var showMenu=true,items=this.dm.site.folder.getItems(),visible=findVisibleItems(items);
if(1===items.length&&0===findVisibleItems(items[0].getItems()).length){
showMenu=false
}else{
if(items.length>0&&0===visible.length){
showMenu=false
}else if(1===visible.length&&this.dm.site.homePageId===visible[0].id){
showMenu=false;
if(findVisibleItems(visible[0].getItems()).length>0){
showMenu=true
}
}
}
return showMenu
},
getMobileHTML:function(){
var css='\n',cssMobile='\n',html='\n',htmlHead='\n',site=this.dm.site,page=this.getPage(),pageId=page.getId(),link=site.getLink(page.id),name=link?link.getName():page?page.getTitle():'',showMenu=this.shouldMenuBeShown();
if(!this.isMobile()){
return''
}
css+='.mm,#mm{display:none;}\n';
css+='.mobile-show{display:none;}\n';
cssMobile+='.mm,#mm{display:block!important;z-index:100;}\n';
cssMobile+='.mobile-hide,.mobile-leaf.mobile-hide{display:none!important;}\n';
cssMobile+='.mobile-show{display:block!important;}\n';
if(!this.editMode){
cssMobile+='.mobile-forcehide,.mobile-leaf.mobile-forcehide{display:none!important;}\n'
}
htmlHead+='<meta name="HandheldFriendly" content="True">'+'<meta name="MobileOptimized" content="320">'+'<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0" templatewidth="'+this.page.getTemplate().getWidth()+'">\n';
function drawItems(items){
var len=items?items.length:0,html='',hasExpanded;
if(len){
html+='\n<ul>\n';
for(var i=0;i<len;i+=1){
if(!items[i].isPublic()||items[i].isHidden()){
continue
}
var item=items[i],itemItems=item.getItems(),url=item.getURL(this),target=item.getTarget?item.getTarget():'',targetStr=target&&target!=='_self'?' target="'+target+'"':'',isCurrent=item.pageId===page.id,diResult=drawItems.call(this,itemItems),isExpanded=diResult[1]||isCurrent,liCls=isExpanded?' class="expanded"':'',aCls=isCurrent?' class="current"':'';
hasExpanded=hasExpanded||isExpanded;
html+='<li'+liCls+'>';
html+='<a href="'+url+'"'+targetStr+aCls+'>'+item.getName()+'</a>';
if(itemItems&&itemItems.length){
html+='<div></div>';
html+=diResult[0]
}
html+='</li>\n'
}
html+='</ul>\n'
}
return[
html,
hasExpanded
]
}
if(showMenu){
var folder=site.folder;
html+='<div class="mm">'+'<div id="mmt">'+name+'</div>\n'+'<div id="mmb"></div>\n'+'</div>\n';
html+='<div id="mm">';
if(this.templateSelectorPreviewMode&&'repository'===this.domain){
folder.getItems().forEach(function(repository){
if('Templates'===repository.title){
repository.getItems().forEach(function(template){
folder=template.getAllItems().some(function(page){
return page.pageId===pageId
})?template:folder
})
}
})
}
html+=drawItems.call(this,folder.getItems())[0];
html+='</div>\n';
this.requireScript('mobileMenu')
}
this.requireScript('mobileSort');
this.appendToCSS(css);
this.appendToCSSMobile(cssMobile);
this.appendToHead(htmlHead,true);
this.addOnloadScript(function(){
var mobileMaxWidth=650,desktopTemplateWidth=Math.max(parseInt(document.querySelector('meta[name="viewport"]').getAttribute('templatewidth'),10),mobileMaxWidth+1);
function determineZoomAbility(){
var temp=document.createElement('head'),head=document.querySelector('head'),isApple=!!navigator.userAgent.toLowerCase().match(/(?:iphone|ipad)/),isMobileMode;
if(isApple){
var isPortrait=window.innerHeight>window.innerWidth;
isMobileMode=window.matchMedia((isPortrait?'(max-device-width: ':'(max-device-height: ')+mobileMaxWidth+'px)').matches
}else{
isMobileMode=window.matchMedia?window.matchMedia('(max-device-width: '+mobileMaxWidth+'px)').matches:window.screen.width<=mobileMaxWidth
}
var metaTag=document.createElement('meta');
metaTag.setAttribute('name','viewport');
if(isMobileMode){
metaTag.setAttribute('content','width=device-width, initial-scale=1.0, minimum-scale=1.0')
}else{
metaTag.setAttribute('content','width='+desktopTemplateWidth)
}
temp.appendChild(metaTag);
head.removeChild(document.querySelector('meta[name="viewport"]'));
while(temp.firstChild){
head.appendChild(temp.firstChild)
}
}
determineZoomAbility();
window.addEventListener('orientationchange',determineZoomAbility,false)
},true);
html+='<script>'+'if ((window.innerWidth <= 650) && (window.getComputedStyle(document.body).backgroundAttachment === "fixed")) {';
html+='document.write(\'<div class="blockbody" style="position: fixed;left: 0px;top: 0px;right: 0px;bottom: 0px;z-index: -1;background-attachment: initial!important;"></div>\');';
html+='}</script>';
return html
}
});
web.Document.scripts={
'jquery':'<script src="/renderStatic/3rdparty/jquery/jquery.js"></script>'+'<script src="/renderStatic/3rdparty/jquery/jquery-noconflict.js"></script>',
'extjs':'<script src="js/3rdparty/Ext/ext-all.js"></script>'+'<script src="js/3rdparty/Ext/adapter/ext-base.js"></script>',
'prettyPhoto':{
deps:['jquery'],
src:'<script src="/renderStatic/3rdparty/prettyPhoto/js/one.jquery.prettyPhoto.js"></script>'+'<script src="/renderStatic/lightbox/lightbox.js"></script>',
css:'<link href="/renderStatic/3rdparty/prettyPhoto/css/prettyPhoto.css" rel="stylesheet" type="text/css"/>'+'<link href="/renderStatic/lightbox/lightbox.css" rel="stylesheet" type="text/css"/>'
},
'imageSlider':{
deps:['jquery'],
src:'<script src="/renderStatic/3rdparty/owlcarousel/one.owl.carousel.js"></script>',
css:'<link href="/renderStatic/3rdparty/owlcarousel/owl.carousel.css" rel="stylesheet" type="text/css"/>'+'<link href="/renderStatic/3rdparty/owlcarousel/owl.transitions.css" rel="stylesheet" type="text/css"/>'+'<link href="/renderStatic/3rdparty/owlcarousel/one.fx.css" rel="stylesheet" type="text/css"/>'
},
'shinybox':{
deps:['jquery'],
src:'<script src="/renderStatic/lightbox/populateJquery.js"></script>'+'<script src="/renderStatic/3rdparty/shinybox/jquery.shinybox.js"></script>'+'<script src="/renderStatic/lightbox/removeJquery.js"></script>'+'<script src="/renderStatic/lightbox/lightbox.js"></script>',
css:'<link href="/renderStatic/3rdparty/shinybox/shinybox.css" rel="stylesheet" type="text/css"/>'+'<link href="/renderStatic/lightbox/lightbox.css" rel="stylesheet" type="text/css"/>'
},
'mobileMenu':{
src:'<script src="/renderStatic/mobileMenu/mobileMenu.js"></script>',
css:'<link href="/renderStatic/mobileMenu/mobileMenu.css" rel="stylesheet" type="text/css"/>'
},
'mobileSort':'<script src="/renderStatic/mobileSort/mobileSort.js"></script>',
'dropDownMenu':{
deps:['jquery'],
src:'<script src="/renderStatic/dropDownMenu/dropDownMenu.js"></script>'
},
'contactForm':{
deps:['jquery'],
src:'<script src="/renderStatic/contactForm/contactFormValidation.js"></script>'
},
'linkOpener':{src:'<script src="/renderStatic/linkOpener/linkOpener.js"></script>'},
'shareButtons':{
deps:['jquery'],
src:'<script type="text/javascript" src="/renderStatic/shareButtons/ShareButtons.js"></script>'
},
'fbPagePluginResize':{
deps:['jquery'],
src:'<script type="text/javascript" src="/renderStatic/facebook/resize.js"></script>'
}
};
web.Document.prototype.append=web.Document.prototype.appendToBody;
Ext.ns('web.windows');
web.windows.Window=Ext.extend(Ext.Window,{
initComponent:function(){
this.addEvents([
'ok',
'cancel'
]);
this.addClass('web-window');
this.border=false;
if(!Ext.isIE8){
this.shadow=false
}
web.windows.Window.superclass.initComponent.apply(this,arguments);
this.initListeners()
},
initListeners:Ext.emptyFn
});
Ext.ns('web.pageImport');
Ext.ns('web.pageImport.transforms');
web.pageImport.transforms.setIds=function(){
function setIds(part){
var children=part.items||[];
if(!('id'in part)){
part.id=Math.uuid()
}
children.forEach(function(component){
if(!('id'in component)){
component.id=Math.uuid()
}
})
}
return function(data){
setIds(data.template);
setIds(data.stylesheet);
setIds(data.page||{})
}
}();
web.pageImport.transforms.textFonts=function(){
function removeQuotes(str){
var s=str[0],e=str[str.length-1];
if(s==='"'&&e==='"'||s==='\''&&e==='\''){
return str.slice(1,-1)
}
return str
}
function fixFont(style){
style=style[2];
if(!style.font||typeof style.font==='number'){
return
}
var computedFonts=style.font.split(', '),validFonts={},fontTypes=web.data.styles.Font.types,cssValues=web.data.styles.Font.cssValues,resolve={
'sans-serif':fontTypes.arial,
'serif':fontTypes.georgia,
'helvetica':fontTypes.helvetica
};
cssValues.forEach(function(fontString,index){
var fontList=fontString.split(','),i,len;
for(i=0,len=fontList.length;i<len;i+=1){
validFonts[removeQuotes(fontList[i].toLowerCase())]=index
}
});
var useFont=null;
computedFonts.some(function(font){
font=removeQuotes(font.toLowerCase());
if(!Ext.isNumber(useFont)&&(Ext.isNumber(resolve[font])||Ext.isNumber(validFonts[font]))){
useFont=resolve[font];
if(!Ext.isNumber(useFont)){
useFont=validFonts[font]
}
return true
}
});
if(!Ext.isNumber(useFont)){
if(computedFonts.length===1){
useFont='google://'+removeQuotes(style.font)
}else{
useFont=0
}
}
style.font=useFont
}
return function(data){
var pageComponents=[];
if(data.page){
pageComponents=data.page.items
}
data.template.items.concat(pageComponents).forEach(function(component){
if((component.type==='web.data.components.Text'||component.type==='web.data.components.Table')&&component.styles){
component.styles.forEach(fixFont)
}
})
}
}();
web.pageImport.transforms.rewriteTextLinks=function(data){
var template=data.template,pageComponents=[],webspaceReplaceRegex=new RegExp('.+?/api/v1/'+data.dal.domain+'/webspace/');
if(data.page){
pageComponents=data.page.items
}
template.items.concat(pageComponents).forEach(function(component){
if((component.type==='web.data.components.Text'||component.type==='web.data.components.Table')&&component.links){
component.links.forEach(function(linkRef){
if(linkRef[2].link){
linkRef[2].link.url=linkRef[2].link.url.replace(webspaceReplaceRegex,'webspace:/');
if(linkRef[2].link.name===undefined){
linkRef[2].link.name=linkRef[2].link.url
}
}
})
}
})
};
web.pageImport.Utils={
sortFloatsByTop:function(floats){
if(!floats){
return[]
}
var sortedFloats=floats.concat();
sortedFloats.sort(function(a,b){
a=a.bbox;
b=b.bbox;
if(a.top<b.top){
return-1
}else if(a.top>b.top){
return 1
}else{
if(a.left<b.left){
return-1
}else if(a.left>b.left){
return 1
}else{
if(a.type==='web.data.components.Block'){
return-1
}else if(b.type==='web.data.components.Block'){
return 1
}else{
return 0
}
}
}
});
return sortedFloats
},
sortFloatsByLeft:function(floats){
if(!floats){
return[]
}
var sortedFloats=floats.map(function(item){
return item
});
sortedFloats.sort(function(a,b){
a=a.bbox;
b=b.bbox;
if(a.left<b.left){
return-1
}else if(a.left>b.left){
return 1
}else{
if(a.top<b.top){
return-1
}else if(a.top>b.top){
return 1
}else{
return 0
}
}
});
return sortedFloats
}
};
web.pageImport.transforms.makeRels=function makeRels(data){
var template=data.template,Node=function(){
var map={};
return function Node(component){
if(map[component.id]){
return map[component.id]
}else{
this.id=component.id;
this.component=component;
this.parent=null;
this.overlaps=[];
this.components=[];
this.overlapping=false;
this.isParent=null;
map[component.id]=this
}
}
}();
Node.prototype={
isOverlapping:function(){
return this.overlapping||this.parent&&this.parent.isOverlapping()
},
getId:function(){
return this.id
},
getParent:function(){
return this.parent
},
getOverlappingAncestor:function(){
if(this.overlapping){
return this
}else if(this.parent){
return this.parent.getOverlappingAncestor()
}else{
return null
}
},
addOverlap:function(node){
node.removeFromParent();
node.parent=this;
node.overlapping=true;
this.overlaps.push(node);
this.isParent=true
},
addComponent:function(node){
if(this.component.type==='web.data.components.resources.Image'){
this.addOverlap(node)
}else{
node.removeFromParent();
node.parent=this;
node.overlapping=false;
this.components.push(node);
this.isParent=true
}
},
removeFromParent:function(){
var parent=this.parent,index;
if(parent){
index=parent.overlaps.indexOf(this);
if(index!==-1){
parent.overlaps.splice(index,1)
}else{
index=parent.components.indexOf(this);
if(index!==-1){
parent.components.splice(index,1)
}
}
}
this.parent=null;
return index
},
isAncestor:function(node){
var that=this,found=false;
do{
if(that===node){
found=true
}
}while(that=that.parent);
return found
}
};
function removeDuplicates(parts){
var unique=[],map={},id;
parts.forEach(function(part){
if(map[part.id]===undefined){
map[part.id]=part
}
});
for(id in map){
if(map.hasOwnProperty(id)){
unique.push(map[id])
}
}
return unique
}
function contains(x,y){
var xBox=x.bbox,yBox=y.bbox;
if(x.type!=='web.data.components.Block'&&x.type!=='web.data.components.Template'){
return false
}
return xBox.top<=yBox.top&&xBox.left<=yBox.left&&xBox.right>=yBox.right&&xBox.bottom>=yBox.bottom
}
function doesProjectionsOverlap(a1,a2,b1,b2){
return!(a2<b1||b2<a1)
}
function findIntersections(component,components){
var componentTop=component.bbox.top,componentLeft=component.bbox.left,componentRight=component.bbox.right,componentBottom=component.bbox.bottom,componentNode=new Node(component);
return components.filter(function(part){
if(part===component){
return false
}
var partTop=part.bbox.top,partLeft=part.bbox.left,partRight=part.bbox.right,partBottom=part.bbox.bottom;
if(partTop===componentTop&&partRight===componentRight&&partBottom===componentBottom&&partLeft===componentLeft){
return componentNode.parent!==new Node(part)
}else if(contains(part,component)){
return false
}else{
return doesProjectionsOverlap(componentLeft,componentRight,partLeft,partRight)&&doesProjectionsOverlap(componentTop,componentBottom,partTop,partBottom)
}
})
}
function attachOverlapsToLargestComponent(refComponent,parts){
if(!refComponent.nodeInfo.inPage){
parts=parts.filter(function(part){
return!part.nodeInfo.inPage
})
}
parts=parts.concat(refComponent);
var largest=parts.reduce(function(prev,current){
var prevArea=prev.width*prev.height,currentArea=current.width*current.height;
return prevArea>=currentArea?prev:current
},{
width:0,
height:0
}),largestNode=new Node(largest);
removeDuplicates(parts).forEach(function(part){
var partNode=new Node(part);
if(partNode!==largestNode&&!largestNode.isAncestor(partNode)){
largestNode.addOverlap(partNode)
}
});
return largestNode
}
var components=web.pageImport.Utils.sortFloatsByTop(template.items.concat(data.page.items));
components.forEach(function(component){
component.nodeInfo=component.nodeInfo||{}
});
var inPage={};
data.page.items.forEach(function(component){
inPage[component.id]=true;
component.nodeInfo.inPage=true
});
components.forEach(function(component){
var componentNode=new Node(component),partialIntersects=[];
findIntersections(component,components).forEach(function(part){
var node=new Node(part);
if(contains(component,part)){
if(!componentNode.isAncestor(node)&&!node.isAncestor(componentNode)){
componentNode.addComponent(node)
}
}else{
partialIntersects.push(part)
}
});
if(componentNode.isOverlapping()){
var ancestor=componentNode.getOverlappingAncestor(),commonAncestors=partialIntersects.filter(function(item){
return ancestor===new Node(item).getOverlappingAncestor()
});
if(commonAncestors.length===0){
return
}
}
if(partialIntersects.length){
attachOverlapsToLargestComponent(component,partialIntersects)
}
});
var relIns={};
components.forEach(function(component){
var parent=new Node(component).getParent();
if(parent){
relIns[parent.getId()]=relIns[parent.getId()]||[];
relIns[parent.getId()].push(component);
component.relIn={
id:parent.getId(),
top:component.bbox.top-parent.component.bbox.top,
left:component.bbox.left-parent.component.bbox.left,
bottom:component.bbox.bottom-parent.component.bbox.bottom,
right:component.bbox.right-parent.component.bbox.right
}
}else{
relIns[template.id]=relIns[template.id]||[];
relIns[template.id].push(component)
}
});
Ext.iterate(relIns,function(id,cmps){
cmps=web.pageImport.Utils.sortFloatsByTop(cmps);
cmps.forEach(function(component,i){
for(i-=1;i>=0;i-=1){
var prev=cmps[i];
if(prev.bbox.bottom<=component.bbox.top&&doesProjectionsOverlap(prev.bbox.left,prev.bbox.right,component.bbox.left,component.bbox.right)){
if(!inPage[component.id]&&inPage[prev.id]){
if(!component.relPage){
var pageId=component.getPage().id;
component.relPage={};
component.relPage[pageId]=component.bbox.top-prev.bbox.bottom
}
}else{
component.relTo={
id:prev.id,
below:component.bbox.top-prev.bbox.bottom
};
break
}
}
}
})
})
};
web.pageImport.transforms.joinText=function(){
function joinText(prevSibling,component){
var len=prevSibling.text.length+1;
if(component.styles){
component.styles.forEach(function(style){
style[0]+=len;
style[1]+=len;
prevSibling.styles=prevSibling.styles||[];
prevSibling.styles.push(style)
})
}
if(component.links){
component.links.forEach(function(link){
link[0]+=len;
link[1]+=len;
prevSibling.links=prevSibling.links||[];
prevSibling.links.push(link)
})
}
if(component.paras){
component.paras.forEach(function(para){
para[0]+=len;
para[1]+=len
});
prevSibling.paras=(prevSibling.paras||[]).concat(component.paras);
var smallestRightPadding=prevSibling.paras.reduce(function(prev,cur){
var rightPadding=cur[2].padding?cur[2].padding[1]:0;
return rightPadding<prev?rightPadding:prev
},Infinity);
prevSibling.paras.forEach(function(aspect){
if(aspect[2].padding){
aspect[2].padding[1]=smallestRightPadding
}
})
}
prevSibling.text+='\n'+component.text;
if(component.bbox.left<prevSibling.bbox.left){
prevSibling.bbox.left=component.bbox.left
}
if(component.bbox.right<prevSibling.bbox.right){
prevSibling.bbox.right=component.bbox.right
}
return prevSibling
}
function inRange(val,start,end){
return start<=val&&val<=end
}
function isMarginJoinable(text1,text2){
var bbox1=text1.bbox,bbox2=text2.bbox,textAlign1='left',textAlign2='left';
if(text1.paras&&text1.paras.length&&text1.paras[0][2].align){
textAlign1=text1.paras[0][2].align
}
if(text2.paras&&text2.paras.length&&text2.paras[0][2].align){
textAlign2=text2.paras[0][2].align
}
if(textAlign1===textAlign2){
switch(textAlign1){
case'left':
return bbox1.left===bbox2.left;
case'right':
return bbox1.right===bbox2.right;
case'center':
var left1=bbox1.left,right1=bbox1.right,left2=bbox2.left,right2=bbox2.right;
return inRange(left1,left2,right2)&&inRange(right1,left2,right2)||inRange(left2,left1,right1)&&inRange(right2,left1,right1)
}
}
return false
}
function isBorderJoinable(b1,b2){
return!(b1||b2)
}
function isBackgroundJoinable(b1,b2){
var isEqual,defaultBackground={
asset:null,
color:null,
gradient:null
};
b1=b1||defaultBackground;
b2=b2||defaultBackground;
isEqual=b1.color&&b2.color&&b1.color.hex()===b2.color.hex()||b1.color===null&&b2.color===null;
isEqual=isEqual&&!(b1.asset||b2.asset||b1.gradient||b2.gradient);
return isEqual
}
function isJoinable(text1,text2){
var blockStyle1=text1.style||{},blockStyle2=text2.style||{};
return isMarginJoinable(text1,text2)&&isBorderJoinable(blockStyle1.border,blockStyle2.border)&&isBackgroundJoinable(blockStyle1.background,blockStyle2.background)
}
function traverse(parent){
if(parent.type==='web.data.components.Page'||parent.type==='web.data.components.Template'){
var component,prevSibling,i,len;
if(parent.items){
for(i=0,len=parent.items.length;i<len;i+=1){
component=parent.items[i];
prevSibling=parent.items[i-1]||null;
if(component.type==='web.data.components.Text'&&prevSibling&&prevSibling.type===component.type&&parent.layout!=='horizontal'){
if(isJoinable(prevSibling,component)){
component=joinText(prevSibling,component);
parent.items.splice(i-1,2,component);
i-=1;
len-=1
}
}
}
}
}
}
return function(data){
traverse(data.template);
if(data.page){
traverse(data.page)
}
}
}();
web.pageImport.ImageRestorer=function(dal){
this.dal=dal;
this.filenameCache={};
this.isLoading=false
};
Ext.apply(web.pageImport.ImageRestorer.prototype,{
fixImage:function(image,cb,scope){
var that=this;
async.waterfall([
function(next){
that.populateCache(next)
},
function(next){
var url=that.findOriginalFile(image,next);
if(/onewebstatic/.test(url)){
that.moveToMediaDirectory(url,next)
}else{
next(null,url)
}
}
],function(err,url){
if(err){
return cb.call(scope,false)
}
cb.call(scope,true,url)
})
},
populateCache:function(cb){
if(Object.keys(this.filenameCache).length){
return setTimeout(cb,0)
}else if(this.isLoading){
return setTimeout(this.populateCache.createDelegate(this,[cb]),500)
}
this.isLoading=true;
var level=0,dirsToRead=[
'/',
'/onewebmedia/'
],dirsAlreadyRead={'/onewebstatic/':true},that=this,dal=this.dal;
async.whilst(function(){
return level<4&&dirsToRead.length&&Object.keys(dirsAlreadyRead).length<100
},function(next){
var dirToRead=dirsToRead.shift();
if(dirsAlreadyRead[dirToRead]){
return setTimeout(next,0)
}
dirsAlreadyRead[dirToRead]=true;
dal.getWebspaceContent(dirToRead,function(opts,success,response){
if(!success){
return next('Could not read directory '+dirToRead)
}
var directoryPath=opts.url.replace(dal.defaultUrl+'/webspace/','/'),entries=Ext.decode(response.responseText).entries;
level=(directoryPath.match(/\//g)||[]).length;
entries.forEach(function(entry){
var resourceType=entry.resourceType||entry.resourcetype,contentType=entry.contentType||entry.getcontenttype;
if(resourceType==='collection'&&entry.href!=='.'){
dirsToRead.push(directoryPath+entry.href)
}else if(/^image\/jpg|jpeg|png|gif$/.test(contentType)){
that.filenameCache[directoryPath+entry.href]=true
}
},this);
next()
})
},function(err){
that.isLoading=false;
cb(err)
})
},
findOriginalFile:function(image){
var targetFilename=image.originalUrl.match(/\/[a-f0-9]{10}\-([^\.\/]+\.(?:jpg|png|gif))$/),foundPath;
if(!targetFilename){
return image.originalUrl
}
targetFilename=targetFilename[1];
foundPath=this.findFilenameInCache(targetFilename);
if(foundPath){
return this.dal.defaultUrl+'/webspace'+foundPath
}else{
return image.originalUrl
}
},
findFilenameInCache:function(filename){
var foundPath;
Object.keys(this.filenameCache).some(function(path){
var hyphenatedPath=path.replace(/^\/onewebmedia\//,'').replace('/','-');
if(filename===hyphenatedPath){
foundPath=path;
return true
}
});
return foundPath
},
moveToMediaDirectory:function(source,cb){
var destination='/onewebmedia/'+this.getRandomFilename(source.split('.').reverse()[0].toLowerCase()),dal=this.dal;
source=source.replace(/^.+?onewebstatic\//,'http://'+dal.domain+'/onewebstatic/');
this.dal.uploadToWebspace(source,this.dal.encodeURI(destination),'',{
onComplete:function(opts,success,response){
if(!success){
return cb('Could not upload '+source)
}
destination=dal.defaultUrl+'/webspace'+destination;
cb(null,destination)
}
})
},
getRandomFilename:function(fileExtension){
var chars=[
'0',
'1',
'2',
'3',
'4',
'5',
'6',
'7',
'8',
'9',
'a',
'b',
'c',
'd',
'e',
'f'
],filename='';
for(var i=0;i<10;i+=1){
filename+=chars[0|Math.random()*16]
}
filename+='-'+Date.now();
return filename+'.'+fileExtension
}
});
Ext.ns('web.pageImport.filters');
web.pageImport.filters.globalTextStyles=function(){
function compareLinkStyle(linkstyle1,linkstyle2){
var equal=true,color1,color2;
if(linkstyle1.color){
color1=one.color(linkstyle1.color)
}
if(linkstyle2.color){
color2=one.color(linkstyle2.color)
}
if(color1&&color2){
equal=color1.equals(color2)
}else{
equal=color1===undefined&&color2===undefined
}
if(equal){
equal=linkstyle1.underline===linkstyle2.underline
}
return equal
}
function estimateGlobalLinkStyle(links){
var unique=[];
Ext.each(links,function(link,index){
var inactiveStyle=link.getPart().getStyle().getInactive(),found=false;
if(index!==0){
unique.some(function(item){
if(compareLinkStyle(item,inactiveStyle)){
found=item;
return true
}
})
}
if(!found){
inactiveStyle._count=1;
unique.push(inactiveStyle)
}else{
found._count+=1
}
});
var mostUsed=unique.sort(function(a,b){
return a._count-b._count
}).pop();
unique.forEach(function(style){
delete style._count
});
return mostUsed
}
function estimateGlobalTextStyle(styles){
var unique=[];
Ext.each(styles,function(textStyle,index){
var style=textStyle.getPart(),found=false;
if(index!==0){
unique.some(function(item){
if(item.isEqual(style)){
found=item;
return true
}
})
}
if(!found){
style._count=textStyle.getEnd()-textStyle.getStart();
unique.push(style)
}else{
found._count+=textStyle.getEnd()-textStyle.getStart()
}
});
var mostUsed=unique.sort(function(a,b){
return a._count-b._count
}).pop();
unique.forEach(function(style){
delete style._count
});
return extractSpecificTextStyles(mostUsed)
}
function extractSpecificTextStyles(style){
var obj=style.toJSON();
delete obj.id;
return obj
}
return function(dm,docs){
var links=[],textStyles=[],styleToComp={},globalCellStyle=docs.stylesheet.getStyleByRef('normal','StyleCell');
docs.template.items.concat(docs.page.items).forEach(function(component){
if(component.type==='web.data.components.Text'||component.type==='web.data.components.Table'){
var richtext=component.richtext;
if(richtext.links.getCount()){
richtext.links.forEach(function(aspect){
links.push(aspect)
})
}
if(richtext.styles.getCount()){
richtext.styles.forEach(function(aspect,index){
styleToComp[aspect.getId()]={
component:component,
index:index
};
textStyles.push(aspect)
})
}
if(richtext.cells.getCount()){
richtext.cells.forEach(function(aspect){
aspect.getStyleCell().set({
globalId:globalCellStyle.getId(),
globalName:'[normal]'
})
})
}
}
});
if(links.length&&!links[0].getPart().getStyle().getGlobalId()){
var globalLinkStyle=docs.stylesheet.getStyleByRef('link.1','StyleLink');
if(docs.canModifyTemplate){
globalLinkStyle.inactive=dm.create(estimateGlobalLinkStyle(links))
}
links.forEach(function(link){
link.set({
style:{
inactive:{},
visited:{},
hover:{},
press:{},
globalId:globalLinkStyle.getId(),
globalName:'[1]',
type:'web.data.styles.StyleLink'
}
})
})
}
if(textStyles.length){
var globalTextStyle=docs.stylesheet.getStyleByRef('normal','StyleText');
if(docs.canModifyTemplate){
globalTextStyle.set(estimateGlobalTextStyle(textStyles))
}
var i,len,toDelete=[],style;
for(i=0,len=textStyles.length;i<len;i+=1){
style=textStyles[i];
if(globalTextStyle.isEqual(style)){
toDelete.push(style)
}
}
var styleLocation,component,compIdToComp={},compIdToStyleIndices={};
for(i=0,len=toDelete.length;i<len;i+=1){
style=toDelete[i];
styleLocation=styleToComp[style.getId()];
component=styleLocation.component;
compIdToComp[component.getId()]=component;
compIdToStyleIndices[component.getId()]=compIdToStyleIndices[component.getId()]||[];
compIdToStyleIndices[component.getId()].push(styleLocation.index)
}
var numSortFunc=function(a,b){
return a-b
};
Ext.iterate(compIdToStyleIndices,function(componentId,styleIndices){
styleIndices.sort(numSortFunc);
component=compIdToComp[componentId];
for(i=styleIndices.length-1;i>=0;i-=1){
var pos=component.styles[styleIndices[i]];
component.position(pos[0],pos[1]);
component.removeStyles()
}
})
}
}
}();
web.pageImport.filters.makeGlobalMenuStyle=function(dm,data){
function iterate(items,cb){
items.forEach(function(item){
if(item.isContainer()){
if(item.components){
iterate(item.components,cb)
}
if(item.floats){
iterate(item.floats,cb)
}
}else{
cb(item)
}
})
}
var menuStyle=data.stylesheet.getStyleByRef('menu.1'),components=data.template.getItems().concat(data.page.getItems());
if(menuStyle){
iterate(components,function(part){
if(part.type==='web.data.components.Menu'){
part.set({
menuStyle:{
type:'web.data.styles.StyleMenu',
globalId:menuStyle.id
}
})
}
})
}
};
Ext.ns('web.pageImport.ui');
web.pageImport.filters.scaleImages=function scaleImages(dm,data){
function adjustImageComponentScale(image,asset){
var imgWidth=image.getWidth(),imgHeight=image.getHeight(),assetWidth=asset.getWidth(),assetHeight=asset.getHeight(),scaleByWidth,scaleByHeight;
if(imgWidth!==assetWidth||imgHeight!==assetHeight){
scaleByWidth=imgWidth/assetWidth;
scaleByHeight=imgHeight/assetHeight;
if(scaleByWidth<=1||scaleByHeight<=1){
image.set({scale:Math.min(scaleByWidth,scaleByHeight)})
}
}
}
data.template.getAssets().concat(data.page.getAssets()).forEach(function(asset){
var parent=asset.getParent();
if(parent&&parent.type==='web.data.components.resources.Image'){
adjustImageComponentScale(parent,asset)
}
})
};
web.pageImport.Importer=Ext.extend(Ext.util.Observable,{
constructor:function(dal){
this.dm=new web.DM;
this.dal=dal;
this.linkPage=null;
this.template=null;
this.sourceTemplateId=null;
this.defaultStyle={};
this.lastImportData=null;
this.filters=[
web.pageImport.filters.globalTextStyles,
web.pageImport.filters.makeGlobalMenuStyle,
web.pageImport.filters.scaleImages
];
this.transforms=[
web.pageImport.transforms.setIds,
web.pageImport.transforms.textFonts,
web.pageImport.transforms.rewriteTextLinks,
web.pageImport.transforms.makeRels,
web.pageImport.transforms.joinText
];
this.events=['pagesaved'];
this.imageRestorer=new web.pageImport.ImageRestorer(dal);
web.pageImport.Importer.superclass.constructor.call(this)
},
setSite:function(site){
if(Ext.isFunction(site.toJSON)){
site=site.toJSON()
}
this.dm.create(site)
},
setTemplate:function(template){
if(template instanceof web.data.components.Template&&template.dm===this.dm){
this.template=template
}else{
this.template=Ext.isFunction(template.toJSON)?this.dm.create(template.toJSON()):this.dm.create(template)
}
},
setSourceTemplateId:function(templateId){
this.sourceTemplateId=templateId
},
getMenuStyleRef:function(templateId){
var menuStyleRefByTemplateId={
'11001':'menu.26',
'11003':'menu.27',
'11004':'menu.28',
'11006':'menu.29',
'11008':'menu.30',
'11009':'menu.31',
'11013':'menu.32',
'12001':'menu.17',
'12002':'menu.18',
'12003':'menu.19',
'12004':'menu.20',
'12005':'menu.21',
'12007':'menu.22',
'12008':'menu.23',
'12010':'menu.24',
'12012':'menu.25',
'13001':'menu.7',
'13002':'menu.8',
'13003':'menu.9',
'13004':'menu.10',
'13005':'menu.11',
'13006':'menu.12',
'13007':'menu.13',
'13008':'menu.14',
'13009':'menu.15',
'13010':'menu.16',
'14001':'menu.1',
'14002':'menu.2',
'14003':'menu.3',
'14004':'menu.4',
'14005':'menu.5',
'14006':'menu.6'
};
return menuStyleRefByTemplateId[templateId]||menuStyleRefByTemplateId['11003']
},
getMenuOrientation:function(){
var orientationByTemplateId={
'11001':'horizontal',
'11003':'horizontal',
'11004':'horizontal',
'11006':'horizontal',
'11008':'horizontal',
'11009':'horizontal',
'11013':'horizontal',
'12001':'vertical',
'12002':'vertical',
'12003':'horizontal',
'12004':'horizontal',
'12005':'horizontal',
'12007':'vertical',
'12008':'horizontal',
'12010':'horizontal',
'12012':'horizontal',
'13001':'vertical',
'13002':'horizontal',
'13003':'vertical',
'13004':'vertical',
'13005':'horizontal',
'13006':'horizontal',
'13007':'vertical',
'13008':'vertical',
'13009':'vertical',
'13010':'horizontal',
'14001':'horizontal',
'14002':'horizontal',
'14003':'horizontal',
'14004':'horizontal',
'14005':'horizontal',
'14006':'horizontal'
};
return orientationByTemplateId[this.sourceTemplateId]||'horizontal'
},
extractFirstPage:function(componentIds,savePage,info,callback,scope){
this.makePageFromComponentIds(componentIds,function(template,page){
this.template=template;
this.saveTemplateAndStylesheet(function(success){
if(savePage&&success){
this.createPage(page,info,callback,scope)
}else{
callback.call(scope||window,success)
}
},this)
})
},
importTemplate:function(info,callback,scope){
info.canModifyTemplate=true;
this.importPage(info,function(success,data){
if(success){
callback.call(scope||this,true,data)
}else{
callback.call(scope||this,false)
}
},this)
},
importPage:function(info,callback,scope){
var retry=0;
this.dal.getPageImportData(info.url,function handler(opts,success,response){
if(success){
var data=Ext.decode(response.responseText).components,components=data.template.items,guestbooksFound=[];
if(info.name){
data.page.title=data.page.name=data.template.name=data.stylesheet.name=info.name
}
if(!data.page.name){
data.page.name=data.template.name=data.stylesheet.name=info.url.match(/\/([^\/]+)\.html?/i)[1]
}
if(info.hidden!==undefined){
data.page.hidden=info.hidden
}
if(data&&data.images&&data.images.length){
var arrRemoveImages=[];
data.images.forEach(function(img){
if(!img.originalUrl){
arrRemoveImages.push(img)
}
});
for(var i=0;i<arrRemoveImages.length;i+=1){
data.images.remove(arrRemoveImages[i])
}
}
this.lastImportData=data;
data.canModifyTemplate=info.canModifyTemplate||false;
components.forEach(function(component){
if(component.nodeInfo.guestbook){
guestbooksFound.push(component)
}
});
if(guestbooksFound.length){
this.lastImportData.guestbookFound=true
}
guestbooksFound.forEach(function(guestbook){
components.remove(guestbook)
});
web.pageImport.transforms.rewriteTextLinks({
template:data.template,
dal:this.dal
});
this.rewriteImageUrlsAndPopulate(data,callback,scope)
}else if(retry<2){
retry+=1;
this.dal.getPageImportData(info.url,handler,this)
}else{
callback.call(scope||this,false)
}
},this)
},
createPage:function(page,info,callback,scope){
var menuStyleId=this.template.getStylesheet().getStyleByRef('menu.1').id,isVerticalMenu=this.getMenuOrientation()==='vertical',dm=this.dm;
dm.create(dm.get(this.template.id));
dm.create(dm.get(this.template.getStylesheet().id));
this.findComponentsAndSet(page,'web.data.components.Menu',function(component){
var menuStyle=component.getMenuStyle();
if(menuStyle){
menuStyle.set({
globalId:menuStyleId,
vertical:isVerticalMenu
})
}
});
this.dal.set(page,function(opts,success,response){
if(success){
this.fireEvent('pagesaved',page,info);
callback.call(scope||window,success,page.id)
}else{
callback.call(scope||window,success)
}
},this)
},
addExternalLinks:function(links){
this.fireEvent('addlinks',links)
},
saveTemplateAndStylesheet:function(callback,scope){
var dal=this.dal;
dal.set(this.template.getStylesheet(),function(opts,stylesheetSuccess,response){
if(stylesheetSuccess){
dal.set(this.template,function(opts,templateSuccess,response){
callback.call(scope||window,templateSuccess)
},this)
}else{
callback.call(scope||window,false)
}
},this)
},
getDefaultStyle:function(type){
return this.defaultStyle[type]||{}
},
setDefaultStyle:function(cfg){
this.defaultStyle=cfg
},
doesPageExist:function(info,callback,scope){
this.dal.doesWebspaceFileExist(info.url,function(success,status){
if(success){
callback.call(scope||this,true,status)
}else{
var pageName=info.url.substr(1);
if(info.name){
pageName='"'+info.name+'"'
}
if(status===404){
if(!info.isFrontPage){
Ext.Msg.show({
cls:'web-modal-warning x-window-dlg',
iconCls:'web-warning-icon',
title:'The page '+pageName+' does not exist anymore',
msg:'Click '+('<b>'+'OK'+'</b>')+' to skip this page and continue to the next page.',
buttons:Ext.Msg.OK,
fn:function(){
callback.call(scope||this,false,status)
}
})
}else{
Ext.Msg.show({
cls:'web-modal-warning x-window-dlg',
iconCls:'web-warning-icon',
title:'The page '+pageName+' does not exist anymore.',
msg:'Click '+('<b>'+'OK'+'</b>')+' to go back and choose another page as your front page.',
buttons:Ext.Msg.OK,
fn:function(){
callback.call(scope||this,false,status)
}
})
}
}else{
Ext.Msg.show({
cls:'web-modal-warning x-window-dlg',
iconCls:'web-warning-icon',
title:'The page '+pageName+' does not exist anymore.',
msg:'The page '+pageName+' does not exist anymore.',
buttons:Ext.MessageBox.OK
})
}
}
},this)
},
makePageFromComponentIds:function(){
function contains(x,y){
var xBox=x.bbox,yBox=y.bbox;
return xBox.top<=yBox.top&&xBox.left<=yBox.left&&xBox.right>=yBox.right&&xBox.bottom>=yBox.bottom
}
return function(componentIds,callback,scope){
var dm=this.dm,top=Infinity,left=Infinity,right=-Infinity,bottom=-Infinity,template=this.lastImportData.template;
componentIds.forEach(function(id){
var component=dm.get(id);
top=Math.min(top,component.bbox.top);
left=Math.min(left,component.bbox.left);
bottom=Math.max(bottom,component.bbox.bottom);
right=Math.max(right,component.bbox.right)
});
var selectedRegion={
bbox:{
top:top,
left:left,
bottom:bottom,
right:right
}
};
var pageComponents=[];
for(var i=template.items.length-1;i>=0;i-=1){
var component=template.items[i];
if(contains(selectedRegion,component)){
template.items.splice(i,1);
pageComponents.push(component)
}
}
pageComponents.reverse();
var templateJSON=this.template?this.template.toJSON():template,userSelected={
images:this.lastImportData.images,
template:templateJSON,
stylesheet:this.template?this.template.getStylesheet().toJSON():this.lastImportData.stylesheet,
page:Ext.apply(Ext.apply({},this.lastImportData.page),{
templateId:this.template?this.template.getId():'',
items:pageComponents
})
};
this.transforms.forEach(function(transform){
transform(Ext.apply({dal:this.dal},userSelected))
},this);
this.rewriteImageUrlsAndPopulate(userSelected,function(success,populated){
callback.call(scope||this,populated.template,populated.page)
},this)
}
}(),
wasGuestbookFound:function(){
return this.lastImportData.guestbookFound===true
},
createPopulatorFunction:function(iterations,callback,scope){
var counter=0,dm=this.dm,that=this;
return function(data,mapping){
counter+=1;
if(counter>=iterations){
that.addMapping(mapping);
data=that.populate(Ext.apply(data,{mapping:mapping}));
that.filters.forEach(function(filter){
filter(dm,data)
});
callback.call(scope||that,true,data)
}
}
},
populate:function(data){
var populated={images:data.images},oldUrlToNewUrl=data.mapping,dm=this.dm,bodyStyle,menuStyle,defaultStyle;
populated.stylesheet=dm.create(data.stylesheet);
bodyStyle=populated.stylesheet.getStyleByRef('body');
if(bodyStyle){
bodyStyle.set(data.template.style)
}
menuStyle=populated.stylesheet.getStyleByRef('menu.1');
if(menuStyle){
defaultStyle=this.getDefaultStyle('menu');
menuStyle.set(defaultStyle)
}
function clone(o){
return JSON.parse(JSON.stringify(o))
}
populated.template=dm.create(Ext.applyIf({
stylesheetId:populated.stylesheet.getId(),
style:undefined
},clone(data.template)));
populated.page=dm.create(Ext.applyIf({templateId:populated.template.getId()},clone(data.page)));
this.findComponentsAndSet(populated.template,'web.data.components.Menu',{vertical:this.getMenuOrientation()==='vertical'});
populated.page.getAssets().forEach(function(asset){
asset.set(oldUrlToNewUrl[asset.url])
},this);
populated.template.getAssets().forEach(function(asset){
asset.set(oldUrlToNewUrl[asset.url])
},this);
populated.stylesheet.getAssets().forEach(function(asset){
asset.set(oldUrlToNewUrl[asset.url])
},this);
populated.canModifyTemplate=data.canModifyTemplate;
return populated
},
rewriteImageUrlsAndPopulate:function(data,callback,scope){
var dal=this.dal,progress=this.createPopulatorFunction(data.images.length,callback,scope),webspaceTestRegex=new RegExp('/api/v1/'+dal.domain+'/webspace/'),webspaceReplaceRegex=new RegExp('.*?/api/v1/'+dal.domain+'/webspace/'),oldUrlToNewUrl={};
if(data.images.length){
var fetchImages=function(){
dal.getWebspaceContent('/onewebmedia/',function(opts,success,response){
if(!success&&response.status===404){
dal.createWebspaceDirectory('/onewebmedia/',fetchImages,this)
}
if(success){
var existingFilenames=Ext.decode(response.responseText).entries.map(function(resource){
return resource.href
});
data.images.forEach(function(img){
var filename=img.originalUrl.replace(/^.+\//,'').split('?')[0],filenameSuffix=1,newFilename=filename,previouslyUploadedImage=this.getUploadedFile(img.originalUrl);
if(previouslyUploadedImage){
oldUrlToNewUrl[img.originalUrl]=previouslyUploadedImage;
progress(data,oldUrlToNewUrl)
}else{
if(/^http/.test(img.originalUrl)){
if(/\bonewebstatic\//.test(img.originalUrl)){
this.imageRestorer.fixImage(img,function(success,url){
if(success){
oldUrlToNewUrl[img.originalUrl]={url:url.replace(webspaceReplaceRegex,'webspace:/')}
}
progress(data,oldUrlToNewUrl)
},this)
}else if(webspaceTestRegex.test(img.originalUrl)){
newFilename=img.originalUrl.replace(webspaceReplaceRegex,'');
dal.getWebspaceFileMetadata('/'+newFilename,function(opts,success,response){
if(success){
oldUrlToNewUrl[img.originalUrl]=Ext.applyIf({url:'webspace:/'+newFilename},Ext.decode(response.responseText))
}
progress(data,oldUrlToNewUrl)
},this)
}else{
while(existingFilenames.indexOf(newFilename)!==-1){
newFilename=filename.replace(/^(.+?)(\..+)?$/,'$1-'+filenameSuffix+'$2');
filenameSuffix+=1
}
dal.uploadToWebspace(img.originalUrl,'/onewebmedia/'+newFilename,null,{
onComplete:function(opts,success,response){
if(success){
oldUrlToNewUrl[img.originalUrl]=Ext.applyIf({url:'webspace:/onewebmedia/'+newFilename},Ext.decode(response.responseText))
}
progress(data,oldUrlToNewUrl)
}
},this)
}
}else if(/^data:/.test(img.originalUrl)){
dal.uploadToWebspace(img.originalUrl,'/onewebmedia/'+filename,null,{
onComplete:function(opts,success,response){
var newFilename=opts.url.replace(/^.+\//,'').replace(/\?.+$/,'');
if(success){
oldUrlToNewUrl[img.originalUrl]=Ext.applyIf({url:'webspace:/onewebmedia/'+newFilename},Ext.decode(response.responseText))
}
progress(data,oldUrlToNewUrl)
}
},this)
}else{
progress(data,oldUrlToNewUrl);
one.fatal('Import: Image URL could not be read properly')
}
}
},this)
}
},this)
};
fetchImages.call(this)
}else{
progress(data,oldUrlToNewUrl)
}
},
addMapping:function(mapping){
Ext.applyIf(web.pageImport.Importer.sourceUrlToWebspaceUrl,mapping)
},
getUploadedFile:function(sourceUrl){
return web.pageImport.Importer.sourceUrlToWebspaceUrl[sourceUrl]
},
findComponentsAndSet:function(component,objType,opts){
component.getItems().forEach(function(obj){
if(obj.type===objType){
if(Ext.isFunction(opts)){
opts.call(this,obj)
}else{
obj.set(opts)
}
}
})
}
});
web.pageImport.Importer.sourceUrlToWebspaceUrl={};
web.pageImport.ui.Panel=Ext.extend(Ext.Panel,{
messages:{
guestbook:{
title:'Website Builder',
text:'Website Builder cannot import the Guestbook that was found on this page. We are working on a solution for importing WebCreator Guestbooks.'
}
},
initComponent:function(){
if(this.bodyItems){
this.layout='vbox';
this.layoutConfig={align:'stretch'};
this.items=[{
xtype:'container',
cls:'import-ui-header',
layout:'hflex',
items:[
{
flex:1,
xtype:'container',
cls:'import-ui-header-text',
html:'Recreate WebCreator pages'
},
{
xtype:'button',
text:'Close',
cls:'x-btn-primary large wide',
handler:function(){
this.fireEvent('closepanel')
},
scope:this
}
]
}];
if(!Ext.isDefined(this.bodyMargin)){
this.bodyMargin=true
}
if(this.bodyMargin){
var len=this.bodyItems.length;
this.bodyItems.forEach(function(o,i){
var margin=[
0,
30,
0,
30
];
if(!i){
margin[0]=30
}
if(i===len-1){
margin[2]=30
}
o.margins=margin.join(' ')
},this)
}
this.items=this.items.concat(this.bodyItems)
}
this.buttons=this.buttons||[
{
ref:'../previousButton',
xtype:'button',
text:'Back',
cls:'import-back-btn',
width:'auto',
autoWidth:true,
handler:function(){
this.fireEvent('previous')
},
scope:this
},
'->',
{
ref:'../nextButton',
text:'Continue',
cls:'x-btn-primary large wide',
autoWidth:true,
handler:function(){
this.fireEvent('next',true)
},
scope:this
}
];
if(!this.buttons.length){
this.buttons=null
}
this.addEvents('next','previous','closepanel');
web.pageImport.ui.Panel.superclass.initComponent.call(this)
},
enableNextButton:function(){
this.nextButton.enable()
},
enablePreviousButton:function(){
this.previousButton.enable()
},
disableNextButton:function(){
this.nextButton.disable()
},
disablePreviousButton:function(){
this.previousButton.disable()
}
});
Ext.ns('web.ui');
web.ui.Breadcrumbs=Ext.extend(Ext.ButtonGroup,{
xtype:'web-ui-breadcrumbs',
frame:false,
keepTailButtons:false,
rootButtonConfig:{
xtype:'button',
path:'/',
text:'Web space',
enableToggle:true,
toggleGroup:'path',
pressed:true
},
initComponent:function(){
this.setActivePath(this.rootButtonConfig.path);
this.hideBorders=true;
this.addEvents('buttonclick');
this.items=this.rootButtonConfig;
web.ui.Breadcrumbs.superclass.initComponent.call(this)
},
updateButtons:function(encodedPath){
var existingButton;
encodedPath=encodedPath||'/';
encodedPath=encodedPath.replace(/^webspace:/,'');
this.setActivePath(encodedPath);
existingButton=this.getButtonByPath(encodedPath);
if(existingButton){
existingButton.toggle(true);
this.doLayout();
if(this.keepTailButtons){
return
}
}
this.removeAll();
var cmps=encodedPath.split('/'),root='/';
this.add(Ext.applyIf({
pressed:false,
handler:this.onClick,
style:'height:23px;line-height:23px;',
scope:this
},this.rootButtonConfig));
cmps.forEach(function(pathComponent){
if(pathComponent!==''){
root+=pathComponent+'/';
this.add({
xtype:'button',
cls:'breadcrumb separator',
iconCls:'icon icon-breadcrumb-arrow',
disabled:true
});
this.add({
xtype:'button',
style:'height:23px;line-height:23px;',
path:root,
text:web.DAL.decodeHref(pathComponent),
enableToggle:true,
toggleGroup:'path',
handler:this.onClick,
scope:this,
pressed:root===encodedPath
})
}
},this);
this.doLayout()
},
onClick:function(button){
this.fireEvent('buttonclick',button.path,this.coreFileOb);
button.toggle(true,true);
this.updateButtons(button.path)
},
getButtonByPath:function(encodedPath){
var index=this.items.findIndex('path',encodedPath,0,false,true);
return index===-1?null:this.items.itemAt(index)
},
getActivePath:function(){
return this.activePath
},
setActivePath:function(path){
this.activePath=path
}
});
Ext.reg('web-ui-breadcrumbs',web.ui.Breadcrumbs);
Ext.ns('Ext.ux.grid');
Ext.ux.grid.BufferView=Ext.extend(Ext.grid.GridView,{
rowHeight:19,
borderHeight:2,
scrollDelay:100,
cacheSize:20,
cleanDelay:500,
initTemplates:function(){
Ext.ux.grid.BufferView.superclass.initTemplates.call(this);
var ts=this.templates;
ts.rowHolder=new Ext.Template('<div class="x-grid3-row {alt}" style="{tstyle}"></div>');
ts.rowHolder.disableFormats=true;
ts.rowHolder.compile();
ts.rowBody=new Ext.Template('<table class="x-grid3-row-table" border="0" cellspacing="0" cellpadding="0" style="{tstyle}">','<tbody><tr>{cells}</tr>',this.enableRowBody?'<tr class="x-grid3-row-body-tr" style="{bodyStyle}"><td colspan="{cols}" class="x-grid3-body-cell" tabIndex="0" hidefocus="on"><div class="x-grid3-row-body">{body}</div></td></tr>':'','</tbody></table>');
ts.rowBody.disableFormats=true;
ts.rowBody.compile()
},
getStyleRowHeight:function(){
return Ext.isBorderBox?this.rowHeight+this.borderHeight:this.rowHeight
},
getCalculatedRowHeight:function(){
return this.rowHeight+this.borderHeight
},
getVisibleRowCount:function(){
var rh=this.getCalculatedRowHeight(),visibleHeight=this.scroller.dom.clientHeight;
return visibleHeight<1?0:Math.ceil(visibleHeight/rh)
},
getVisibleRows:function(){
var count=this.getVisibleRowCount(),sc=this.scroller.dom.scrollTop,start=sc===0?0:Math.floor(sc/this.getCalculatedRowHeight())-1;
return{
first:Math.max(start,0),
last:Math.min(start+count+2,this.ds.getCount()-1)
}
},
doRender:function(cs,rs,ds,startRow,colCount,stripe,onlyBody){
var ts=this.templates,ct=ts.cell,rt=ts.row,rb=ts.rowBody,last=colCount-1,rh=this.getStyleRowHeight(),vr=this.getVisibleRows(),tstyle='width:'+this.getTotalWidth()+';height:'+rh+'px;',buf=[],cb,c,p={},rp={tstyle:tstyle},r;
for(var j=0,len=rs.length;j<len;j++){
r=rs[j];
cb=[];
var rowIndex=j+startRow,visible=rowIndex>=vr.first&&rowIndex<=vr.last;
if(visible){
for(var i=0;i<colCount;i++){
c=cs[i];
p.id=c.id;
p.css=i===0?'x-grid3-cell-first ':i==last?'x-grid3-cell-last ':'';
p.attr=p.cellAttr='';
p.value=c.renderer(r.data[c.name],p,r,rowIndex,i,ds);
p.style=c.style;
if(p.value===undefined||p.value===''){
p.value='&#160;'
}
if(r.dirty&&typeof r.modified[c.name]!=='undefined'){
p.css+=' x-grid3-dirty-cell'
}
cb[cb.length]=ct.apply(p)
}
}
var alt=[];
if(stripe&&(rowIndex+1)%2===0){
alt[0]='x-grid3-row-alt'
}
if(r.dirty){
alt[1]=' x-grid3-dirty-row'
}
rp.cols=colCount;
if(this.getRowClass){
alt[2]=this.getRowClass(r,rowIndex,rp,ds)
}
rp.alt=alt.join(' ');
rp.cells=cb.join('');
buf[buf.length]=!visible?ts.rowHolder.apply(rp):onlyBody?rb.apply(rp):rt.apply(rp)
}
return buf.join('')
},
isRowRendered:function(index){
var row=this.getRow(index);
return row&&row.childNodes.length>0
},
syncScroll:function(){
Ext.ux.grid.BufferView.superclass.syncScroll.apply(this,arguments);
this.update()
},
update:function(){
if(this.scrollDelay){
if(!this.renderTask){
this.renderTask=new Ext.util.DelayedTask(this.doUpdate,this)
}
this.renderTask.delay(this.scrollDelay)
}else{
this.doUpdate()
}
},
onRemove:function(ds,record,index,isUpdate){
Ext.ux.grid.BufferView.superclass.onRemove.apply(this,arguments);
if(isUpdate!==true){
this.update()
}
},
doUpdate:function(){
if(this.getVisibleRowCount()>0){
var g=this.grid,cm=g.colModel,ds=g.store,cs=this.getColumnData(),vr=this.getVisibleRows(),row;
for(var i=vr.first;i<=vr.last;i++){
if(!this.isRowRendered(i)&&(row=this.getRow(i))){
var html=this.doRender(cs,[ds.getAt(i)],ds,i,cm.getColumnCount(),g.stripeRows,true);
row.innerHTML=html
}
}
this.clean()
}
},
clean:function(){
if(!this.cleanTask){
this.cleanTask=new Ext.util.DelayedTask(this.doClean,this)
}
this.cleanTask.delay(this.cleanDelay)
},
doClean:function(){
if(this.getVisibleRowCount()>0){
var vr=this.getVisibleRows();
vr.first-=this.cacheSize;
vr.last+=this.cacheSize;
var i=0,rows=this.getRows();
if(vr.first<=0){
i=vr.last+1
}
for(var len=this.ds.getCount();i<len;i++){
if((i<vr.first||i>vr.last)&&rows[i].innerHTML){
rows[i].innerHTML=''
}
}
}
},
removeTask:function(name){
var task=this[name];
if(task&&task.cancel){
task.cancel();
this[name]=null
}
},
destroy:function(){
this.removeTask('cleanTask');
this.removeTask('renderTask');
Ext.ux.grid.BufferView.superclass.destroy.call(this)
},
layout:function(){
Ext.ux.grid.BufferView.superclass.layout.call(this);
this.update()
}
});
web.ui.FilesOnlyCheckboxSelectionModel=Ext.extend(Ext.grid.CheckboxSelectionModel,{
renderer:function(v,p,record){
var path=record.data.path;
if(path.charAt(path.length-1)==='/'){
return''
}else{
return Ext.grid.CheckboxSelectionModel.prototype.renderer(v,p,record)
}
},
selectAll:function(){
this.fireEvent('beforeselectall');
var i,len,path;
if(this.isLocked()){
return
}
this.selections.clear();
for(i=0,len=this.grid.store.getCount();i<len;i+=1){
path=this.grid.store.getAt(i).data.path;
if(path.charAt(path.length-1)!=='/'){
this.selectRow(i,true)
}
}
},
handleMouseDown:function(g,rowIndex,e){
if(e.button!==0||this.isLocked()){
return
}
var view=this.grid.getView();
if(e.shiftKey&&!this.singleSelect&&this.last!==false){
var last=this.last;
this.selectRange(last,rowIndex,e.ctrlKey);
this.last=last;
view.focusRow(rowIndex)
}else{
var isSelected=this.isSelected(rowIndex);
if(isSelected){
this.deselectRow(rowIndex)
}else if(!isSelected||this.getCount()>1){
this.selectRow(rowIndex,true);
view.focusRow(rowIndex)
}
}
}
});
Ext.ns('iconlib');
(function(){
function Mime(){
}
iconlib.Mime=Mime;
Ext.apply(iconlib.Mime,{
lookup:function(mimetype,extension,icon_size){
if(mimetype){
mimetype=mimetype.replace('/','-');
if(iconlib.Mime.mimetypes[mimetype.replace('/','-')]){
return iconlib.Mime.mimetypes[mimetype.replace('/','-')][icon_size]
}
}
var parts=extension.split('.'),ext='.'+parts[parts.length-1];
if(iconlib.Mime.extensions[ext]){
return iconlib.Mime.extensions[ext][icon_size]
}
if(mimetype){
var mime_generic=mimetype.split('-')[0]+'-x-generic';
if(iconlib.Mime.mimetypes[mime_generic]){
return iconlib.Mime.mimetypes[mime_generic][icon_size]
}
}
return iconlib.Mime.mimetypes['x-file-generic'][icon_size]
}
})
}());
Ext.apply(iconlib.Mime,{
mimetypes:{
'application-x-php':{
'48':'mimetypes-application-x-php-48',
'32':'mimetypes-application-x-php-32',
'22':'mimetypes-application-x-php-22',
'16':'mimetypes-application-x-php-16'
},
'application-pdf':{'16':'mimetypes-document-pdf-16'},
'application-java-archive':{
'32':'mimetypes-package-x-generic-32',
'16':'mimetypes-package-x-generic-16',
'22':'mimetypes-package-x-generic-22'
},
'application-vnd.oasis.opendocument.text':{
'32':'mimetypes-x-office-document-32',
'16':'mimetypes-x-office-document-16',
'22':'mimetypes-x-office-document-22'
},
'x-office-document':{
'32':'mimetypes-x-office-document-32',
'16':'mimetypes-x-office-document-16',
'22':'mimetypes-x-office-document-22'
},
'audio-x-generic':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'x-file-generic':{
'48':'mimetypes-x-file-generic-48',
'32':'mimetypes-x-file-generic-32',
'22':'mimetypes-x-file-generic-22',
'16':'mimetypes-x-file-generic-16'
},
'package-x-generic':{
'32':'mimetypes-package-x-generic-32',
'16':'mimetypes-package-x-generic-16',
'22':'mimetypes-package-x-generic-22'
},
'x-office-spreadsheet':{
'32':'mimetypes-x-office-spreadsheet-32',
'16':'mimetypes-x-office-spreadsheet-16',
'22':'mimetypes-x-office-spreadsheet-22'
},
'application-vnd.openxmlformats-officedocument.wordprocessingml.document':{
'32':'mimetypes-x-office-document-32',
'16':'mimetypes-x-office-document-16',
'22':'mimetypes-x-office-document-22'
},
'text-x-python':{
'48':'mimetypes-text-x-python-48',
'32':'mimetypes-text-x-python-32',
'22':'mimetypes-text-x-python-22',
'16':'mimetypes-text-x-python-16'
},
'text-x-java':{
'48':'mimetypes-text-x-java-source-48',
'32':'mimetypes-text-x-java-source-32',
'22':'mimetypes-text-x-java-source-22',
'16':'mimetypes-text-x-java-source-16'
},
'text-x-generic':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'application-x-sh':{
'32':'mimetypes-application-x-executable-32',
'16':'mimetypes-application-x-executable-16',
'22':'mimetypes-application-x-executable-22'
},
'application-vnd.ms-excel':{
'32':'mimetypes-x-office-spreadsheet-32',
'16':'mimetypes-x-office-spreadsheet-16',
'22':'mimetypes-x-office-spreadsheet-22'
},
'application-vnd.ms-powerpoint':{
'32':'mimetypes-x-office-presentation-32',
'16':'mimetypes-x-office-presentation-16',
'22':'mimetypes-x-office-presentation-22'
},
'document-pdf':{'16':'mimetypes-document-pdf-16'},
'application-x-shellscript':{
'32':'mimetypes-application-x-executable-32',
'16':'mimetypes-application-x-executable-16',
'22':'mimetypes-application-x-executable-22'
},
'application-vnd.oasis.opendocument.presentation':{
'32':'mimetypes-x-office-presentation-32',
'16':'mimetypes-x-office-presentation-16',
'22':'mimetypes-x-office-presentation-22'
},
'application-vnd.openxmlformats-officedocument.spreadsheetml.sheet':{
'32':'mimetypes-x-office-spreadsheet-32',
'16':'mimetypes-x-office-spreadsheet-16',
'22':'mimetypes-x-office-spreadsheet-22'
},
'application-rar':{
'32':'mimetypes-package-x-generic-32',
'16':'mimetypes-package-x-generic-16',
'22':'mimetypes-package-x-generic-22'
},
'application-vnd.openxmlformats-officedocument.presentationml.presentation':{
'32':'mimetypes-x-office-presentation-32',
'16':'mimetypes-x-office-presentation-16',
'22':'mimetypes-x-office-presentation-22'
},
'x-office-presentation':{
'32':'mimetypes-x-office-presentation-32',
'16':'mimetypes-x-office-presentation-16',
'22':'mimetypes-x-office-presentation-22'
},
'application-x-lzh':{
'32':'mimetypes-package-x-generic-32',
'16':'mimetypes-package-x-generic-16',
'22':'mimetypes-package-x-generic-22'
},
'application-x-ruby':{
'48':'mimetypes-application-x-ruby-48',
'32':'mimetypes-application-x-ruby-32',
'22':'mimetypes-application-x-ruby-22',
'16':'mimetypes-application-x-ruby-16'
},
'text-x-boo':{
'48':'mimetypes-text-x-boo-48',
'32':'mimetypes-text-x-boo-32',
'22':'mimetypes-text-x-boo-22',
'16':'mimetypes-text-x-boo-16'
},
'video-x-generic':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'application-x-executable':{
'32':'mimetypes-application-x-executable-32',
'16':'mimetypes-application-x-executable-16',
'22':'mimetypes-application-x-executable-22'
},
'image-x-generic':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'font-x-generic':{
'32':'mimetypes-font-x-generic-32',
'16':'mimetypes-font-x-generic-16',
'22':'mimetypes-font-x-generic-22'
},
'text-x-java-source':{
'48':'mimetypes-text-x-java-source-48',
'32':'mimetypes-text-x-java-source-32',
'22':'mimetypes-text-x-java-source-22',
'16':'mimetypes-text-x-java-source-16'
},
'application-vnd.oasis.opendocument.spreadsheet':{
'32':'mimetypes-x-office-spreadsheet-32',
'16':'mimetypes-x-office-spreadsheet-16',
'22':'mimetypes-x-office-spreadsheet-22'
},
'text-html':{
'32':'mimetypes-text-html-32',
'16':'mimetypes-text-html-16',
'22':'mimetypes-text-html-22'
},
'message-x-generic':{
'32':'mimetypes-message-x-generic-32',
'16':'mimetypes-message-x-generic-16',
'22':'mimetypes-message-x-generic-22'
},
'application-x-msdos-program':{
'32':'mimetypes-application-x-executable-32',
'16':'mimetypes-application-x-executable-16',
'22':'mimetypes-application-x-executable-22'
},
'application-zip':{
'32':'mimetypes-package-x-generic-32',
'16':'mimetypes-package-x-generic-16',
'22':'mimetypes-package-x-generic-22'
},
'text-x-tex':{
'48':'mimetypes-text-x-tex-48',
'32':'mimetypes-text-x-tex-32',
'22':'mimetypes-text-x-tex-22',
'16':'mimetypes-text-x-tex-16'
},
'application-postscript':{'16':'mimetypes-document-pdf-16'},
'application-msword':{
'32':'mimetypes-x-office-document-32',
'16':'mimetypes-x-office-document-16',
'22':'mimetypes-x-office-document-22'
},
'application-x-httpd-php':{
'48':'mimetypes-application-x-php-48',
'32':'mimetypes-application-x-php-32',
'22':'mimetypes-application-x-php-22',
'16':'mimetypes-application-x-php-16'
},
'application-x-dvi':{
'48':'mimetypes-text-x-tex-48',
'32':'mimetypes-text-x-tex-32',
'22':'mimetypes-text-x-tex-22',
'16':'mimetypes-text-x-tex-16'
},
'application-x-latex':{
'48':'mimetypes-text-x-tex-48',
'32':'mimetypes-text-x-tex-32',
'22':'mimetypes-text-x-tex-22',
'16':'mimetypes-text-x-tex-16'
}
},
extensions:{
'.wax':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.rm':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.rb':{
'48':'mimetypes-application-x-ruby-48',
'32':'mimetypes-application-x-ruby-32',
'22':'mimetypes-application-x-ruby-22',
'16':'mimetypes-application-x-ruby-16'
},
'.ra':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.wvx':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.boo':{
'48':'mimetypes-text-x-boo-48',
'32':'mimetypes-text-x-boo-32',
'22':'mimetypes-text-x-boo-22',
'16':'mimetypes-text-x-boo-16'
},
'.dll':{
'32':'mimetypes-application-x-executable-32',
'16':'mimetypes-application-x-executable-16',
'22':'mimetypes-application-x-executable-22'
},
'.cc':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.sty':{
'48':'mimetypes-text-x-tex-48',
'32':'mimetypes-text-x-tex-32',
'22':'mimetypes-text-x-tex-22',
'16':'mimetypes-text-x-tex-16'
},
'.mkv':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.wsc':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.ras':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.rar':{
'32':'mimetypes-package-x-generic-32',
'16':'mimetypes-package-x-generic-16',
'22':'mimetypes-package-x-generic-22'
},
'.ram':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.sco':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.jng':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.mid':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.cxx':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.xwd':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.avi':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.bmp':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.jad':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.dvi':{
'48':'mimetypes-text-x-tex-48',
'32':'mimetypes-text-x-tex-32',
'22':'mimetypes-text-x-tex-22',
'16':'mimetypes-text-x-tex-16'
},
'.aif':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.eps':{'16':'mimetypes-document-pdf-16'},
'.dot':{
'32':'mimetypes-x-office-document-32',
'16':'mimetypes-x-office-document-16',
'22':'mimetypes-x-office-document-22'
},
'.icz':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.shtml':{
'32':'mimetypes-text-html-32',
'16':'mimetypes-text-html-16',
'22':'mimetypes-text-html-22'
},
'.wml':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.hxx':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.ics':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.csv':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.cdr':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.cr2':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.css':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.pls':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.wmx':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.csh':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.ico':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.hpp':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.csd':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.nef':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.wmv':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.pm':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.pl':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.wbmp':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.mp4':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.cdt':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.htc':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.djv':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.jpg':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.py':{
'48':'mimetypes-text-x-python-48',
'32':'mimetypes-text-x-python-32',
'22':'mimetypes-text-x-python-22',
'16':'mimetypes-text-x-python-16'
},
'.cpp':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.pcx':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.mpga':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.jpeg':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.ps':{'16':'mimetypes-document-pdf-16'},
'.zip':{
'32':'mimetypes-package-x-generic-32',
'16':'mimetypes-package-x-generic-16',
'22':'mimetypes-package-x-generic-22'
},
'.mml':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.m3u':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.sid':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.tsv':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.asx':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.cls':{
'48':'mimetypes-text-x-tex-48',
'32':'mimetypes-text-x-tex-32',
'22':'mimetypes-text-x-tex-22',
'16':'mimetypes-text-x-tex-16'
},
'.ltx':{
'48':'mimetypes-text-x-tex-48',
'32':'mimetypes-text-x-tex-32',
'22':'mimetypes-text-x-tex-22',
'16':'mimetypes-text-x-tex-16'
},
'.asc':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.au':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.asf':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.gsm':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.appcache':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.srt':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.jar':{
'32':'mimetypes-package-x-generic-32',
'16':'mimetypes-package-x-generic-16',
'22':'mimetypes-package-x-generic-22'
},
'.sh':{
'32':'mimetypes-application-x-executable-32',
'16':'mimetypes-application-x-executable-16',
'22':'mimetypes-application-x-executable-22'
},
'.c':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.ief':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.xlb':{
'32':'mimetypes-x-office-spreadsheet-32',
'16':'mimetypes-x-office-spreadsheet-16',
'22':'mimetypes-x-office-spreadsheet-22'
},
'.pptx':{
'32':'mimetypes-x-office-presentation-32',
'16':'mimetypes-x-office-presentation-16',
'22':'mimetypes-x-office-presentation-22'
},
'.gcd':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.pbm':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.axa':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.hh':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.p':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.hs':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.lhs':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.xls':{
'32':'mimetypes-x-office-spreadsheet-32',
'16':'mimetypes-x-office-spreadsheet-16',
'22':'mimetypes-x-office-spreadsheet-22'
},
'.xlt':{
'32':'mimetypes-x-office-spreadsheet-32',
'16':'mimetypes-x-office-spreadsheet-16',
'22':'mimetypes-x-office-spreadsheet-22'
},
'.c++':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.sd2':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.tex':{
'48':'mimetypes-text-x-tex-48',
'32':'mimetypes-text-x-tex-32',
'22':'mimetypes-text-x-tex-22',
'16':'mimetypes-text-x-tex-16'
},
'.ogg':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.pdf':{'16':'mimetypes-document-pdf-16'},
'.kar':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.sct':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.orf':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.html':{
'32':'mimetypes-text-html-32',
'16':'mimetypes-text-html-16',
'22':'mimetypes-text-html-22'
},
'.aiff':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.aifc':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.exe':{
'32':'mimetypes-application-x-executable-32',
'16':'mimetypes-application-x-executable-16',
'22':'mimetypes-application-x-executable-22'
},
'.crw':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.flv':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.pps':{
'32':'mimetypes-x-office-presentation-32',
'16':'mimetypes-x-office-presentation-16',
'22':'mimetypes-x-office-presentation-22'
},
'.fli':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.com':{
'32':'mimetypes-application-x-executable-32',
'16':'mimetypes-application-x-executable-16',
'22':'mimetypes-application-x-executable-22'
},
'.axv':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.pas':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.xpm':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.mpeg':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.pat':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.epsi':{'16':'mimetypes-document-pdf-16'},
'.gif':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.moc':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.ppt':{
'32':'mimetypes-x-office-presentation-32',
'16':'mimetypes-x-office-presentation-16',
'22':'mimetypes-x-office-presentation-22'
},
'.spx':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.epsf':{'16':'mimetypes-document-pdf-16'},
'.djvu':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.ppm':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.lzh':{
'32':'mimetypes-package-x-generic-32',
'16':'mimetypes-package-x-generic-16',
'22':'mimetypes-package-x-generic-22'
},
'.latex':{
'48':'mimetypes-text-x-tex-48',
'32':'mimetypes-text-x-tex-32',
'22':'mimetypes-text-x-tex-22',
'16':'mimetypes-text-x-tex-16'
},
'.bat':{
'32':'mimetypes-application-x-executable-32',
'16':'mimetypes-application-x-executable-16',
'22':'mimetypes-application-x-executable-22'
},
'.mov':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.uls':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.qt':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.eml':{
'32':'mimetypes-message-x-generic-32',
'16':'mimetypes-message-x-generic-16',
'22':'mimetypes-message-x-generic-22'
},
'.diff':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.png':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.bib':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.erf':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.h':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.tcl':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.jpe':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.art':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.ogv':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.ai':{'16':'mimetypes-document-pdf-16'},
'.d':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.svgz':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.wav':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.vcs':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.vcf':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.xbm':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.txt':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.psd':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.cpt':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.scala':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.eps3':{'16':'mimetypes-document-pdf-16'},
'.eps2':{'16':'mimetypes-document-pdf-16'},
'.midi':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.oga':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.tiff':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.awb':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.mxu':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.ts':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.rgb':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.rtx':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.odt':{
'32':'mimetypes-x-office-document-32',
'16':'mimetypes-x-office-document-16',
'22':'mimetypes-x-office-document-22'
},
'.tk':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.tm':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.odp':{
'32':'mimetypes-x-office-presentation-32',
'16':'mimetypes-x-office-presentation-16',
'22':'mimetypes-x-office-presentation-22'
},
'.ods':{
'32':'mimetypes-x-office-spreadsheet-32',
'16':'mimetypes-x-office-spreadsheet-16',
'22':'mimetypes-x-office-spreadsheet-22'
},
'.docx':{
'32':'mimetypes-x-office-document-32',
'16':'mimetypes-x-office-document-16',
'22':'mimetypes-x-office-document-22'
},
'.h++':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.text':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.orc':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.dl':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.tif':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.xlsx':{
'32':'mimetypes-x-office-spreadsheet-32',
'16':'mimetypes-x-office-spreadsheet-16',
'22':'mimetypes-x-office-spreadsheet-22'
},
'.amr':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.mpg':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.mpe':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.doc':{
'32':'mimetypes-x-office-document-32',
'16':'mimetypes-x-office-document-16',
'22':'mimetypes-x-office-document-22'
},
'.pgm':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.pot':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.svg':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.htm':{
'32':'mimetypes-text-html-32',
'16':'mimetypes-text-html-16',
'22':'mimetypes-text-html-22'
},
'.mpv':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.dv':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.3gp':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.brf':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.ly':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.dif':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.wmls':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.webm':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.sfv':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.patch':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.etx':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.wm':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.movie':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.lsf':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.wma':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.m4a':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.gl':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.pnm':{
'32':'mimetypes-image-x-generic-32',
'16':'mimetypes-image-x-generic-16',
'22':'mimetypes-image-x-generic-22'
},
'.mpega':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.flac':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.snd':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.mng':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
},
'.mp3':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.mp2':{
'32':'mimetypes-audio-x-generic-32',
'16':'mimetypes-audio-x-generic-16',
'22':'mimetypes-audio-x-generic-22'
},
'.java':{
'48':'mimetypes-text-x-java-source-48',
'32':'mimetypes-text-x-java-source-32',
'22':'mimetypes-text-x-java-source-22',
'16':'mimetypes-text-x-java-source-16'
},
'.323':{
'32':'mimetypes-text-x-generic-32',
'16':'mimetypes-text-x-generic-16',
'22':'mimetypes-text-x-generic-22'
},
'.lsx':{
'32':'mimetypes-video-x-generic-32',
'16':'mimetypes-video-x-generic-16',
'22':'mimetypes-video-x-generic-22'
}
}
});
web.ui.FileSizeColumn=Ext.extend(Ext.grid.Column,{
renderer:function(value){
if(Ext.isNumber(value)){
return Ext.util.Format.fileSize(value)
}
}
});
Ext.grid.Column.types.filesizecolumn=web.ui.FileSizeColumn;
(function($,window,document,undefined){
var $window=$(window);
$.fn.lazyload=function(options){
var elements=this;
var $container;
var settings={
threshold:0,
failure_limit:0,
event:'scroll',
effect:'show',
container:window,
data_attribute:'original',
skip_invisible:false,
appear:null,
load:null,
placeholder:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC'
};
function update(){
var counter=0;
elements.each(function(){
var $this=$(this);
if(settings.skip_invisible&&!$this.is(':visible')){
return
}
if($.abovethetop(this,settings)||$.leftofbegin(this,settings)){
}else if(!$.belowthefold(this,settings)&&!$.rightoffold(this,settings)){
if(settings.ignoreIfScrolledPast){
setTimeout(function(){
if($this.isInViewport({viewport:settings.container}).length){
$this.trigger('appear');
counter=0
}
},settings.scrolledPastDelay||500)
}else{
$this.trigger('appear');
counter=0
}
}else{
if(++counter>settings.failure_limit){
return false
}
}
})
}
if(options){
if(undefined!==options.failurelimit){
options.failure_limit=options.failurelimit;
delete options.failurelimit
}
if(undefined!==options.effectspeed){
options.effect_speed=options.effectspeed;
delete options.effectspeed
}
$.extend(settings,options)
}
$container=settings.container===undefined||settings.container===window?$window:$(settings.container);
if(0===settings.event.indexOf('scroll')){
$container.bind(settings.event,function(){
return update()
})
}
this.each(function(){
var self=this;
var $self=$(self);
self.loaded=false;
if($self.attr('src')===undefined||$self.attr('src')===false){
if($self.is('img')){
$self.attr('src',settings.placeholder)
}
}
$self.on('appear',function(){
if(!this.loaded){
if(settings.appear){
var elements_left=elements.length;
settings.appear.call(self,elements_left,settings)
}
var original=$self.attr('data-'+settings.data_attribute);
var $img;
var updateAttributes=function(){
$self.off('appear');
$self.hide();
if(settings.appearedCallback){
settings.appearedCallback(original)
}else{
if($self.is('img')){
$self.attr('src',original)
}else{
$self.css('background-image','url(\''+original+'\')')
}
}
$self[settings.effect](settings.effect_speed);
self.loaded=true;
var temp=$.grep(elements,function(element){
return!element.loaded
});
elements=$(temp);
if(settings.load){
var elements_left=elements.length;
settings.load.call(self,elements_left,settings)
}
};
var attachEvents=function(){
$img=$('<img />').bind('load',updateAttributes).bind('error',function(){
$self.trigger('unsuccessful.lazy')
})
};
attachEvents();
if(!settings.appearedCallback){
$img.attr('src',$self.attr('data-'+settings.data_attribute))
}else{
updateAttributes()
}
}
});
if(0!==settings.event.indexOf('scroll')){
$self.bind(settings.event,function(){
if(!self.loaded){
$self.trigger('appear')
}
})
}
});
$window.bind('resize',function(){
update()
});
if(/(?:iphone|ipod|ipad).*os 5/gi.test(navigator.appVersion)){
$window.bind('pageshow',function(event){
if(event.originalEvent&&event.originalEvent.persisted){
elements.each(function(){
$(this).trigger('appear')
})
}
})
}
$(document).ready(function(){
update()
});
return this
};
$.belowthefold=function(element,settings){
var fold;
if(settings.container===undefined||settings.container===window){
fold=(window.innerHeight?window.innerHeight:$window.height())+$window.scrollTop()
}else{
fold=$(settings.container).offset().top+$(settings.container).height()
}
return fold<=$(element).offset().top-settings.threshold
};
$.rightoffold=function(element,settings){
var fold;
if(settings.container===undefined||settings.container===window){
fold=$window.width()+$window.scrollLeft()
}else{
fold=$(settings.container).offset().left+$(settings.container).width()
}
return fold<=$(element).offset().left-settings.threshold
};
$.abovethetop=function(element,settings){
var fold;
if(settings.container===undefined||settings.container===window){
fold=$window.scrollTop()
}else{
fold=$(settings.container).offset().top
}
return fold>=$(element).offset().top+settings.threshold+$(element).height()
};
$.leftofbegin=function(element,settings){
var fold;
if(settings.container===undefined||settings.container===window){
fold=$window.scrollLeft()
}else{
fold=$(settings.container).offset().left
}
return fold>=$(element).offset().left+settings.threshold+$(element).width()
};
$.inviewport=function(element,settings){
return!$.rightoffold(element,settings)&&!$.leftofbegin(element,settings)&&!$.belowthefold(element,settings)&&!$.abovethetop(element,settings)
};
$.extend($.expr[':'],{
'below-the-fold':function(a){
return $.belowthefold(a,{threshold:0})
},
'above-the-top':function(a){
return!$.belowthefold(a,{threshold:0})
},
'right-of-screen':function(a){
return $.rightoffold(a,{threshold:0})
},
'left-of-screen':function(a){
return!$.rightoffold(a,{threshold:0})
},
'in-viewport':function(a){
return $.inviewport(a,{threshold:0})
},
'above-the-fold':function(a){
return!$.belowthefold(a,{threshold:0})
},
'right-of-fold':function(a){
return $.rightoffold(a,{threshold:0})
},
'left-of-fold':function(a){
return!$.rightoffold(a,{threshold:0})
}
})
}(oneJQuery,window,document));
/*
 * @author  Mudit Ameta
 * @license https://github.com/zeusdeux/isInViewport/blob/master/license.md MIT
 */
!function(a,b){
function c(b){
var c,d=a('<div></div>').css({width:'100%'});
return b.append(d),c=b.width()-d.width(),d.remove(),c
}
function d(e,f){
var g=e.getBoundingClientRect(),h=g.top,i=g.bottom,j=g.left,k=g.right,l=a.extend({
tolerance:0,
viewport:b
},f),m=!1,n=l.viewport.jquery?l.viewport:a(l.viewport);
n.length||(console.warn('isInViewport: The viewport selector you have provided matches no element on page.'),console.warn('isInViewport: Defaulting to viewport as window'),n=a(b));
var o=n.height(),p=n.width(),q=n[0].toString();
if(n[0]!==b&&'[object Window]'!==q&&'[object DOMWindow]'!==q){
var r=n[0].getBoundingClientRect();
h-=r.top,i-=r.top,j-=r.left,k-=r.left,d.scrollBarWidth=d.scrollBarWidth||c(n),p-=d.scrollBarWidth
}
return l.tolerance=~~Math.round(parseFloat(l.tolerance)),l.tolerance<0&&(l.tolerance=o+l.tolerance),0>=k||j>=p?m:m=l.tolerance?!!(h<=l.tolerance&&i>=l.tolerance):!!(i>0&&o>=h)
}
String.prototype.hasOwnProperty('trim')||(String.prototype.trim=function(){
return this.replace(/^\s*(.*?)\s*$/,'$1')
});
var e=function(b){
if(1===arguments.length&&'function'==typeof b&&(b=[b]),!(b instanceof Array))
throw new SyntaxError('isInViewport: Argument(s) passed to .do/.run should be a function or an array of functions');
for(var c=0;c<b.length;c++)
if('function'==typeof b[c])
for(var d=0;d<this.length;d++)
b[c].call(a(this[d]));
else
console.warn('isInViewport: Argument(s) passed to .do/.run should be a function or an array of functions'),console.warn('isInViewport: Ignoring non-function values in array and moving on');
return this
};
a.fn['do']=function(a){
return console.warn('isInViewport: .do is deprecated as it causes issues in IE and some browsers since it\'s a reserved word. Use $.fn.run instead i.e., $(el).run(fn).'),e(a)
},a.fn.run=e;
var f=function(b){
if(b){
var c=b.split(',');
return 1===c.length&&isNaN(c[0])&&(c[1]=c[0],c[0]=void 0),{
tolerance:c[0]?c[0].trim():void 0,
viewport:c[1]?a(c[1].trim()):void 0
}
}
return{}
};
a.extend(a.expr[':'],{
'in-viewport':a.expr.createPseudo?a.expr.createPseudo(function(a){
return function(b){
return d(b,f(a))
}
}):function(a,b,c){
return d(a,f(c[3]))
}
}),a.fn.isInViewport=function(a){
return this.filter(function(b,c){
return d(c,a)
})
}
}(oneJQuery,window);
web.ui.FileChooser=Ext.extend(Ext.grid.GridPanel,{
defaultDir:'/onewebmedia/',
border:false,
contentTypeFilter:null,
multiSelect:false,
maxFiles:null,
errorStrings:null,
selectedPaths:[],
constructor:function(config){
web.ui.FileChooser.superclass.constructor.call(this,config)
},
initComponent:function(){
this.cls=(this.cls||'')+' web-ui-filechooser';
if(this.multiSelect){
this.addClass('no-selection-checkbox')
}
this.files=[];
this.currentPath=null;
this.store=new Ext.data.GroupingStore({
data:{data:[]},
groupField:'resource',
groupDir:'ASC',
groupOnSort:true,
sortInfo:{
field:'filename',
direction:'ASC'
},
reader:new Ext.data.JsonReader({
root:'data',
fields:[
{
name:'filename',
sortType:Ext.data.SortTypes.asUCString
},
'path',
'fileExt',
'resource',
'size',
'lastModified',
'contentType',
'etag'
]
})
});
this.store.on('load',function(){
var that=this;
setTimeout(function(){
var index=that.store.find('path',that.lastReadPath);
that.getView().focusRow(index)
},100)
},this);
this.autoExpandColumn=1;
this.enableColumnMove=false;
this.initSelectionModel();
this.initColumnModel();
var that=this;
this.view=new Ext.grid.GridView({
rowHeight:49,
borderHeight:0,
forceFit:true,
markDirty:false,
templates:function(){
if(that.viewType==='grid-view'){
return{
body:new Ext.Template('{rows}'),
cell:function(){
return new Ext.Template('<div class="x-grid3-td-{id} {css}" style="{style}" tabIndex="0" {cellAttr}>','{value}','</div>')
}(),
row:function(){
var innerText=['{cells}'].join('');
return new Ext.Template('<div class="x-grid3-row {alt}" style="{tstyle}">'+innerText+'</div>')
}()
}
}else{
return{}
}
}(),
emptyText:'No files in this folder',
refresh:function(headersToo){
this.fireEvent('beforerefresh',this);
if(!this.grid){
one.fatal('Grid not available')
}
this.grid.stopEditing(true);
var result=this.renderBody();
this.mainBody.update(result).setWidth(this.getTotalWidth());
if(headersToo===true){
this.updateHeaders();
this.updateHeaderSortState();
that.lazyLoad()
}
this.processRows(0,true);
this.layout();
this.applyEmptyText()
},
doUpdate:function(){
Ext.ux.grid.BufferView.prototype.doUpdate.call(this);
this.fireEvent('refresh',this)
}
});
this.breadcrumbs.on('buttonclick',function(path,coreFileOb){
if(coreFileOb.fileChooser.viewType===this.viewType){
this.readPath(path)
}
},this);
this.listeners={
rowclick:function(grid,row,e){
this.selectRecord(grid.getStore().getAt(row))
},
rowdblclick:function(grid,row,e){
if(this.view.findCellIndex(e.target)===0){
return
}
this.handleRowDoubleClick(row)
},
render:function(){
this.el.mask('','animated-loading-dots',true,true)
},
sortchange:function(grid,sortInfo){
try{
this.showSelection()
}catch(e){
}
},
scope:this
};
this.addEvents('directoryselected','fileselected','filedeselected','fileconfirmed','selectionchange');
web.ui.FileChooser.superclass.initComponent.call(this)
},
setSelectedPaths:function(paths){
this.selectedPaths=paths
},
getSelectedPaths:function(){
return this.selectedPaths
},
addSelectedPaths:function(paths){
if(this.multiSelect){
this.selectedPaths=this.selectedPaths.concat(paths)
}else{
this.selectedPaths=[paths[0]]
}
},
enableMultiSelect:function(multiSelect){
var sm=this.getSelectionModel();
this.multiSelect=multiSelect;
sm.checkOnly=multiSelect;
if(multiSelect){
sm.singleSelect=false;
this.removeClass('no-selection-checkbox')
}else{
sm.singleSelect=true;
this.addClass('no-selection-checkbox')
}
},
unmask:function(){
if(this.rendered){
this.el.unmask()
}
},
getCurrentFileList:function(){
return this.files.concat()
},
getCurrentPath:function(){
return this.currentPath
},
getSelectedFiles:function(){
return this.getSelectionModel().getSelections()
},
showDefaultPath:function(){
this.readPath(this.defaultDir,true);
this.breadcrumbs.updateButtons(this.defaultDir)
},
showPath:function(path){
this.readPath(path,false);
this.breadcrumbs.updateButtons(path.replace(/\/[^\/]*$/,'/'))
},
showSelection:function(){
var store=this.getStore(),sm=this.getSelectionModel(),map={},selectedRows=[],i,storePath;
if(this.selectedPaths){
this.selectedPaths.forEach(function(path){
try{
map[decodeURI(path.file)]=1
}catch(e){
map[unescape(path.file)]=1
}
})
}
for(i=0;i<store.getCount();i+=1){
var tempPath=store.getAt(i).data.path;
try{
storePath=decodeURI(tempPath)
}catch(e){
storePath=unescape(tempPath)
}
if(map[storePath]){
selectedRows.push(i)
}
}
sm.selectRows(selectedRows)
},
initSelectionModel:function(){
var that=this,userWarning={},updateHTML;
updateHTML=function(){
var imgWinEl=Ext.get(that.el.findParent('.web-windows-image')),el=imgWinEl&&imgWinEl.query('[data-bind=FileChooser.numberOfFiles]');
if(el&&el.length){
el.pop().innerHTML=that.selectedPaths.length
}
};
userWarning.show=function(){
var time=new Date().getTime(),multiple;
if(userWarning.timerId){
clearTimeout(userWarning.timerId)
}
multiple=time-userWarning.timestamp<500;
userWarning.timestamp=new Date().getTime();
userWarning.timerId=setTimeout(function(){
if(multiple){
one.error(that.errorStrings.tooManyFilesMultipleSelect[0],that.errorStrings.tooManyFilesMultipleSelect[1]);
Ext.get(Ext.query('.x-grid3-hd-inner.x-grid3-hd-checker')).removeClass('x-grid3-hd-checker-on')
}else{
one.error(that.errorStrings.tooManyFilesSingleSelect[0],that.errorStrings.tooManyFilesSingleSelect[1])
}
},100)
};
this.sm=new web.ui.FilesOnlyCheckboxSelectionModel({
width:42,
singleSelect:!this.multiSelect,
checkOnly:this.multiSelect,
listeners:{
beforeselectall:function(){
var candidateFiles=this.store.data.length,globalSelectedLength=this.getSelectedPaths().length,mapPaths={};
this.getSelectedPaths().forEach(function(element){
mapPaths[element.file]=true
});
this.store.data.items.forEach(function(element){
if(mapPaths[element.json.path]){
candidateFiles-=1
}
});
if(globalSelectedLength+candidateFiles>this.maxFiles){
var sm=this.getSelectionModel();
sm.lock();
setTimeout(function(){
sm.unlock()
},100);
oneJQuery(this.el.dom).find('.x-grid3-hd-checker-on').removeClass('x-grid3-hd-checker-on');
one.error(that.errorStrings.tooManyFilesHeaderSelect[0],that.errorStrings.tooManyFilesHeaderSelect[1])
}
},
rowselect:function(sm,row,record){
var name=record.get('path'),etag=record.get('etag'),isUploading=record.get('isUploading')===true,contentType=record.get('contentType'),path,fileArr=this.selectedPaths.map(function(item){
return item.file
});
if(record.get('resource')!=='collection'){
if(this.maxFiles&&this.selectedPaths.length>=this.maxFiles&&fileArr.indexOf(this.store.getAt(row).data.path)===-1){
sm.deselectRow(row,false);
userWarning.show();
return false
}
this.fireEvent('fileselected',{
fileChooser:this,
path:name,
etag:etag,
contentType:contentType,
isUploading:isUploading
})
}
if(record.data.resource==='file'){
path=record.data.path;
if(this.selectedPaths.map(function(e){
return e.file
}).indexOf(path)===-1){
if(!this.multiSelect){
this.selectedPaths=[]
}
this.selectedPaths.push({
file:path,
etag:record.data.etag
})
}
if(this.selectedPathsDeselectCandidates){
this.selectedPathsDeselectCandidates.remove(path)
}
}else if(record.data.resource==='collection'){
clearTimeout(this.selectedPathsDeselectTimer);
this.selectedPathsDeselectTimer=null;
this.selectedPathsDeselectCandidates=[]
}
updateHTML()
},
rowdeselect:function(sm,row,record){
var that=this;
this.selectedPathsDeselectCandidates=this.selectedPathsDeselectCandidates||[];
this.selectedPathsDeselectCandidates.push(record.data.path);
if(!this.selectedPathsDeselectTimer){
this.selectedPathsDeselectTimer=setTimeout(function(){
that.selectedPathsDeselectCandidates.forEach(function(item){
var index=that.selectedPaths.map(function(e){
return e.file
}).indexOf(item);
if(index>=0){
that.selectedPaths.splice(index,1)
}
});
that.selectedPathsDeselectCandidates=[];
that.selectedPathsDeselectTimer=null;
updateHTML()
},300)
}
this.fireEvent('filedeselected',this,row,record)
},
selectionchange:function(sm){
this.fireEvent('selectionchange',sm)
},
scope:this
}
});
this.addHeaderCheckerBehaviour()
},
initColumnModel:function(){
var that=this,mapFileTypes={
'jpg':'image',
'jpeg':'image',
'gif':'image',
'png':'image',
'ico':'image',
'css':'css',
'htm':'code',
'html':'code',
'js':'code'
};
this.cm=new Ext.grid.ColumnModel({
defaults:{
menuDisabled:true,
sortable:true,
resizable:false
},
columns:function(selectionModel){
var columnImage={
dataIndex:'icon',
renderer:function(value,metaData,record){
var data=record.data,path=data.path,isImage=/^image\/[a-z\.]+$/.test(data.contentType),isFolder=data.resource==='collection',filename=data.filename;
var htmlEncodedFileName=Ext.util.Format.htmlEncode(filename),htmlEncodedFileNameLimited=Ext.util.Format.htmlEncode(Ext.util.Format.ellipsis(filename,60));
path=that.app.dal.getWebspacePath(path);
var thumbId=that.makeImageCls(path);
if(isFolder){
return'<div class="resource-icon-container">'+'<div class="filechooser-item filechooser-directory">'+'<div class="file-name" title="'+htmlEncodedFileName+'">'+htmlEncodedFileNameLimited+'</div>'+'</div>'+'</div>'
}else if(isImage){
return[
'<div class="resource-icon-container">',
'<div class="filechooser-file">',
'<div class="filechooser-item filechooser-image" data-original="'+path+'" data-thumb-id="'+thumbId+'">',
'<div class="file-name" title="'+htmlEncodedFileName+'">'+htmlEncodedFileNameLimited+'</div>',
'<div class="click-to-select">'+'Click to select'+'</div>',
'<div class="click-to-deselect">'+'Click to deselect'+'</div>',
'<div>&nbsp;</div>',
'</div>',
'</div>',
'</div>'
].join('\n')
}else if(filename.split('.').reverse()[0]==='ico'){
return'<div class="resource-icon-container">'+'<div class="filechooser-item filechooser-image" data-original="'+path+'" data-thumb-id="'+thumbId+'">&nbsp;</div>'+'</div>'
}else{
return'<div class="resource-icon-container">'+'<div class="filechooser-item filechooser-'+(mapFileTypes[filename.split('.').reverse()[0].toLowerCase()]||'file')+'">&nbsp;</div>'+'</div>'
}
},
width:44
};
var columnName={
header:'Name',
dataIndex:'filename',
width:140,
renderer:function(value,metaData,record){
var filename=value.replace(/\.[a-z0-9]+$/i,'');
return'<div class="file-name" ext:qtip="'+Ext.util.Format.htmlEncode(filename)+'">'+Ext.util.Format.htmlEncode(filename)+'</div>'
}
};
var columnType={
header:'Type',
dataIndex:'fileExt',
width:45,
renderer:function(value,metaData,record){
return value
}
};
var columnSize={
xtype:'filesizecolumn',
header:'Size',
dataIndex:'size',
align:'right',
width:40,
renderer:function(value,metaData,record){
return record.get('resource')==='collection'?'':Ext.util.Format.fileSize(value)
}
};
var columnDate={
header:'Added',
dataIndex:'lastModified',
align:'right',
renderer:function(value,metaData,record){
return one.locale.getDateRenderer('yMMdd')(new Date(value))
},
width:70
};
var columnsForGridView=[columnImage];
var columnsForListView=[
columnImage,
columnName,
columnType,
columnSize,
columnDate
];
var columns;
if(that.viewType==='list-view'){
columns=columnsForListView
}else if(that.viewType==='grid-view'){
columns=columnsForGridView
}else{
one.fatal('Custom - viewType is neither list-view nor grid-view. This should never occur.')
}
if(selectionModel instanceof Ext.grid.CheckboxSelectionModel){
columns.unshift(selectionModel);
columnsForGridView.unshift(selectionModel)
}
return columns
}(this.sm)
})
},
getFileExt:function(filename){
return filename.split('.').pop()||''
},
readPath:function(path,createIfNotFound){
var that=this;
if(this.el){
this.el.mask('','animated-loading-dots',true,true)
}
path=path.replace(/^webspace:/,'');
this.lastReadPath=path;
var directoryPath,filename,propertyMapping={
creationdate:'createdDate',
getlastmodified:'lastModified',
getcontenttype:'contentType',
getcontentlength:'size',
resourcetype:'resourceType',
getetag:'etag'
},parseResponse=function(context,response){
var items=Ext.decode(response).entries,data=[],found;
items=items.map(function(item){
if(item.resourceType==='file'){
item.fileExt=that.getFileExt(item.href).toUpperCase()
}else{
item.fileExt=''
}
return item
});
items.forEach(function(item){
var href=item.href;
if(href!=='.'&&directoryPath+href!=='/onewebstatic/'){
Object.keys(propertyMapping).forEach(function(oldKey){
var newKey=propertyMapping[oldKey];
if(oldKey in item){
item[newKey]=item[oldKey];
delete item[oldKey]
}
});
if(item.resourceType==='file'&&this.contentTypeFilter){
if(!item.contentType||!this.contentTypeFilter.test(item.contentType)){
return
}
}
if(filename&&href===filename){
found=true
}
data.push({
filename:web.DAL.decodeHref(href.replace(/\/$/,'')),
path:directoryPath+href,
fileExt:item.fileExt,
resource:item.resourceType,
size:item.size,
etag:item.etag,
lastModified:item.modifiedDate,
contentType:item.contentType
});
this.files.push({
filename:href,
etag:item.etag
})
}
},context);
if(data.length){
context.store.loadData({data:data})
}else{
var view=context.getView();
if(view.grid){
view.refresh()
}
}
context.unmask();
context.showSelection()
};
if(/\/$/.test(path)){
directoryPath=path
}else{
directoryPath=path.replace(/\/[^\/]*$/,'/');
filename=path.replace(directoryPath,'')
}
this.currentPath=directoryPath;
this.store.removeAll();
this.files=[];
this.app.dal.getWebspaceContent(directoryPath,function(opts,success,result){
if(!success||!result.responseText){
if(result.status===404&&createIfNotFound){
one.info(path+' not available. Creating.');
this.app.dal.createWebspaceDirectory(path,function(createOpts,createSuccess,createResponse){
if(createSuccess){
parseResponse(this,'{"entries": []}')
}else{
this.unmask();
one.error('\''+path+'\' could not be created.')
}
},this)
}else{
this.unmask();
var errorObject={};
try{
errorObject=Ext.decode(result.responseText)
}catch(e){
}
if(result.status===403&&errorObject.error==='Forbidden'&&errorObject.name==='ServiceSuspended'){
one.error('Access to the website\'s file system has been suspended for this domain.'+'<br /><br />'+'Please contact our support for further assistance.','Access suspended')
}else{
one.error('<b>'+'Website Builder cannot connect to your web space.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.')
}
}
}else{
parseResponse(this,result.responseText)
}
},this);
if(/\/$/.test(path)){
this.fireEvent('directoryselected',this,path)
}
},
lazyLoad:function(){
oneJQuery(this.el.dom).find('.filechooser-image[data-original]').lazyload({
container:oneJQuery(this.el.dom).find('.x-grid3-scroller'),
ignoreIfScrolledPast:true,
scrolledPastDelay:500,
appearedCallback:function(path){
this.onAppearedHandler.call(this,path)
}.bind(this)
})
},
selectRecord:function(record){
var path=record.get('path');
if(record.get('resource')==='collection'){
this.readPath(path);
this.breadcrumbs.updateButtons(path);
this.fireEvent('directoryselected',this,path)
}
},
handleRowDoubleClick:function(row){
var record=this.getStore().getAt(row);
if(record.get('resource')!=='collection'){
this.fireEvent('fileconfirmed',this,record.get('path'))
}
},
makeImageCls:function(path){
var i,hex='';
for(i=0;i<path.length;i+=1){
hex+=''+path.charCodeAt(i).toString(16)
}
return hex
},
onAppearedHandler:function(path){
if(path.match(/\.ico$/)){
this.resizeToSmallThumb(path,{
formatOnly:true,
formatOptions:{'to':'png'}
})
}else if(this.viewType==='grid-view'){
this.resizeToSmallThumb(path,{
w:160,
h:160
})
}else{
this.resizeToSmallThumb(path)
}
},
addHeaderCheckerBehaviour:function(){
var updateHeaderChecker=function(){
var files=this.store.data.items.filter(function(element){
return element.data.resource!=='collection'
}).length,el=oneJQuery(this.el.dom).find('.x-grid3-hd-inner.x-grid3-hd-checker'),cls='x-grid3-hd-checker-on';
if(files===this.getSelectionModel().getCount()){
el.addClass(cls)
}else{
el.removeClass(cls)
}
};
this.on('fileselected',updateHeaderChecker,this);
this.on('filedeselected',updateHeaderChecker,this)
},
resizeToSmallThumb:function(path,options){
options=options||{};
var thumbId=this.makeImageCls(path),params=[];
if(options.etag){
params.push('etag='+encodeURIComponent(options.etag))
}
if(options.formatOptions){
params.push(options.formatOptions.to)
}
if(!options.formatOnly){
var resize='resize='+(options.w||30)+','+(options.h||30);
params.push(resize,'crop=center')
}
path+='?'+params.join('&');
setTimeout(function(){
oneJQuery('[data-thumb-id='+thumbId+']').attr('style','background-image: url("'+path+'")');
oneJQuery('[data-thumb-id='+thumbId+']').append('<img src="'+path+'" class="onload-helper-img-invisible" onload="oneJQuery(this).parent().parent().addClass(\'filechooser-none\');">')
},100)
},
showFileUploadProgress:function(upload){
var percent=Math.min(Math.max(100*(upload.loaded||0)/upload.size,0),100);
var store=this.getStore(),rec=store.data.find(function(storeItem){
return storeItem.data.filename===web.DAL.decodeHref(upload.filename)
}),recIndex=store.indexOf(rec),gridRowEl;
if(recIndex===-1){
if(upload.strict){
return
}else{
var RecordType=Ext.data.Record.create({});
rec=new RecordType({
icon:'',
filename:web.DAL.decodeHref(upload.filename),
path:upload.path,
fileExt:this.getFileExt(upload.filename).toUpperCase(),
resource:'file',
size:upload.size||0,
etag:null,
isUploading:true,
lastModified:new Date,
contentType:upload.contentType
});
store.addSorted(rec);
recIndex=store.indexOf(rec)
}
}
gridRowEl=this.getEl().query('.x-grid3-row')[recIndex];
if(percent===0){
gridRowEl.style.backgroundImage='url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAAAAAA6fptVAAAACklEQVR4nGO6CwAA4wDgUvZgwAAAAABJRU5ErkJggg==")';
gridRowEl.style.backgroundRepeat='no-repeat';
gridRowEl.style.backgroundSize='200% 100%';
gridRowEl.style.backgroundPositionX=200-percent-1+'%'
}else if(percent===100){
if(rec.get('isUploading')){
rec.set('isUploading',false);
gridRowEl.firstChild.style.height=gridRowEl.style.height;
oneJQuery(gridRowEl).animate({backgroundPositionX:'100%'},300,function(){
setTimeout(function(){
gridRowEl.style.backgroundPositionX='200%'
},500);
setTimeout(function(){
gridRowEl.style.backgroundPositionX='100%'
},600);
setTimeout(function(){
gridRowEl.style.backgroundPositionX='200%'
},900)
})
}
}else{
oneJQuery(gridRowEl).animate({backgroundPositionX:200-percent+'%'},300)
}
var el=this.el.query('.x-grid3-body')[0],row=el&&el.children[recIndex];
if(row&&this.multiSelect){
Ext.get(row).addClass('x-grid3-row-selected')
}
return{index:recIndex}
},
removeFileUploadProgress:function(upload){
var store=this.getStore(),rec=store.data.find(function(storeItem){
return storeItem.data.filename===web.DAL.decodeHref(upload.filename)
});
if(!rec){
var count=0;
rec=store.data.find(function(storeItem){
var up=storeItem.data.isUploading;
if(up){
count+=1
}
return up
});
if(count!==1){
rec=null
}
}
if(rec){
store.remove(rec)
}
}
});
Ext.reg('web-ui-filechooser',web.ui.FileChooser);
web.pageImport.ui.PageChooser=Ext.extend(web.pageImport.ui.Panel,{
xtype:'web-pageimport-ui-pagechooser',
initComponent:function(){
var breadcrumbs=Ext.create({
xtype:'web-ui-breadcrumbs',
cls:'file-tbar-btn-group',
height:50,
style:{marginTop:'20px'}
});
this.selectedPath=null;
this.bodyItems=[
{
ref:'selectPagesLabel',
xtype:'label',
text:'Please select the pages you wish to import content from:',
height:35
},
breadcrumbs,
{
ref:'pageChooser',
xtype:'web-ui-filechooser',
viewType:'list-view',
defaultDir:'/',
contentTypeFilter:/text\/html/,
breadcrumbs:breadcrumbs,
multiSelect:true,
app:this.app,
flex:1,
enableCheckbox:true,
multiSelectFilesOnly:true,
listeners:{
directoryselected:function(){
this.disableNextButton()
},
fileselected:function(){
this.enableNextButton()
},
fileconfirmed:function(){
this.fireEvent('next',true)
},
scope:this
}
}
];
this.listeners={
show:function(){
this.pageChooser.showDefaultPath()
},
scope:this
};
this.buttons=[
{
ref:'../previousButton',
xtype:'button',
text:'Back',
cls:'import-back-btn',
width:'auto',
autoWidth:true,
handler:function(){
this.fireEvent('previous')
},
scope:this
},
'->',
{
ref:'../nextButton',
text:'Select page',
cls:'x-btn-primary large wide',
autoWidth:true,
handler:function(){
this.fireEvent('next',true)
},
scope:this
}
];
web.pageImport.ui.PageChooser.superclass.initComponent.call(this);
this.pageChooser.enableMultiSelect(true);
breadcrumbs.coreFileOb={fileChooser:this.pageChooser}
},
enableNextButton:function(){
this.nextButton.enable()
},
disableNextButton:function(){
this.nextButton.disable()
},
getSelected:function(){
return this.pageChooser.getSelectionModel().getSelections().map(function(selection){
return{
type:'page',
url:selection.data.path
}
})
}
});
Ext.reg('web-pageimport-ui-pagechooser',web.pageImport.ui.PageChooser);
web.pageImport.ui.ProjectChooser=Ext.extend(web.pageImport.ui.Panel,{
cls:'web-pageimport-ui-projectchooser',
initComponent:function(){
this.bodyItems=[
{
xtype:'label',
text:'Please select the project you want to recreate.',
height:50
},
{
ref:'grid',
xtype:'grid',
flex:1,
enableColumnHide:false,
store:new Ext.data.Store({
data:{data:[]},
reader:new Ext.data.JsonReader({
root:'data',
fields:[
'name',
'url',
'menuItems',
'templateId'
]
}),
sortInfo:{
field:'name',
direction:'ASC'
}
}),
cm:new Ext.grid.ColumnModel({
columns:[{
xtype:'templatecolumn',
dataIndex:'project',
header:'Project name',
tpl:'{name} <a href="{url}" target="_blank">'+'View'+'</a>'
}]
}),
sm:new Ext.grid.RowSelectionModel({singleSelect:true}),
viewConfig:{
emptyText:'No projects found. <a id="web-ui-projectChooser-gotoselectpages" href="#">Click here</a> to recreate single pages that are not a part of a WebCreator project.',
forceFit:true,
headersDisabled:true,
listeners:{
refresh:function(){
if(this.grid.getStore().getCount()>0){
this.grid.getSelectionModel().selectFirstRow();
this.recreateSinglePagesNote.show();
this.doLayout();
this.nextButton.enable()
}else{
Ext.select('#web-ui-projectChooser-gotoselectpages').on('click',function(e){
e.preventDefault();
this.fireEvent('selectindividualpages',this.from)
},this);
this.recreateSinglePagesNote.hide();
this.nextButton.disable()
}
},
scope:this
}
},
listeners:{
dblclick:function(){
if(this.grid.getStore().getCount()>0){
this.fireEvent('next',true)
}
},
scope:this
}
},
{
xtype:'container',
ref:'recreateSinglePagesNote',
style:{paddingTop:'20px'},
items:[
{
xtype:'container',
html:'If the listed projects do not contain the pages you want to recreate, you can recreate single pages that are not part of a WebCreator project.',
style:{paddingBottom:'10px'}
},
{
xtype:'button',
cls:'x-btn-primary large web-ui-projectchooser-blue-wide',
text:'Recreate single pages',
listeners:{
click:function(){
this.fireEvent('selectindividualpages',this.from)
},
scope:this
}
}
]
}
];
web.pageImport.ui.ProjectChooser.superclass.initComponent.call(this)
},
setFrom:function(from){
this.from=from
},
refresh:function(){
var data=[],dal=this.app.dal;
if(this.rendered){
this.showLoading()
}
this.grid.store.removeAll();
dal.getWebspaceContent('/.ilosoft/menu/',function(opts,success,result){
if(success){
var projects=Ext.decode(result.responseText).entries,numProjects,numResponses=0;
projects=projects.filter(function(project){
return/\.menu$/.test(project.href)
});
numProjects=projects.length;
if(numProjects<1){
this.grid.store.loadData({data:[]});
this.hideLoading();
this.nextButton.disable()
}
projects.forEach(function(project){
dal.getWebspaceContent('/.ilosoft/project/'+project.href.replace(/\.menu$/,'.proj'),function(opts,projectSuccess,projectResult){
if(projectSuccess){
var templateId=projectResult.responseText.match(/base\-template\: "(\d+)"/);
if(templateId){
templateId=templateId[1]
}
dal.getWebspaceContent('/.ilosoft/menu/'+project.href+'?detectCharset=true',function(opts,innerSuccess,innerResult){
if(innerSuccess){
var menuItems=innerResult.responseText.split('\n'),projectName=project.href.replace(/\.menu$/,''),regex=/^(menu|link)-item: "([^"]+)" "([^"]+)" (true|false)(?: "([^"]+)")?/,items=[],homeIndex;
menuItems.forEach(function(menuItem,index){
var match=menuItem.match(regex);
if(match){
if(match[1]==='menu'){
items.push({
name:web.DAL.decodeHref(match[2]),
url:match[3],
type:'page',
hidden:match[4]==='false'
});
if(homeIndex===undefined||match[3]==='index.html'){
homeIndex=index
}
}else{
items.push({
name:web.DAL.decodeHref(match[2]),
url:match[3],
target:match[5]||'_blank',
type:'link',
hidden:match[4]==='false'
})
}
}
},null);
data.push({
name:web.DAL.decodeHref(projectName),
url:'http://'+dal.domain+items[homeIndex].url,
menuItems:items,
templateId:templateId
})
}
numResponses+=1;
if(numResponses>=numProjects){
this.grid.store.loadData({data:data});
if(this.rendered){
this.hideLoading()
}
}
},this)
}else{
numProjects-=1;
if(numProjects<1){
this.grid.store.loadData({data:[]});
this.hideLoading();
this.nextButton.disable()
}
}
},this)
},this)
}else{
this.grid.store.loadData({data:[]});
this.hideLoading();
this.nextButton.disable()
}
},this)
},
getSelected:function(){
var project=this.grid.getSelectionModel().getSelected();
return project?project.data:null
},
showLoading:function(){
this.el.mask('Loading project data...');
this.nextButton.disable();
this.previousButton.disable()
},
hideLoading:function(){
this.el.unmask();
this.nextButton.enable();
this.previousButton.enable()
}
});
Ext.reg('web-pageimport-ui-projectchooser',web.pageImport.ui.ProjectChooser);
web.pageImport.ui.ProjectPageChooser=Ext.extend(web.pageImport.ui.Panel,{
xtype:'web-pageimport-ui-projectpagechooser',
initComponent:function(){
this.bodyItems=[
{
xtype:'label',
text:'Please select your front page. In most cases it\'s the index.html file. We will use this to make the template for your recreated pages.',
height:50
},
{
ref:'grid',
xtype:'grid',
flex:1,
deferRowRender:false,
enableColumnHide:false,
store:new Ext.data.Store({
data:{pages:[]},
reader:new Ext.data.JsonReader({
root:'pages',
fields:[
'name',
'url',
'liveUrl',
'displayUrl'
]
}),
listeners:{
load:function(){
if(this.grid){
this.grid.getSelectionModel().selectFirstRow()
}
},
scope:this
}
}),
cm:new Ext.grid.ColumnModel({
columns:[{
xtype:'templatecolumn',
dataIndex:'name',
header:'File name',
tpl:'<tpl if="!!name">'+'{name} ({displayUrl})'+'</tpl>'+'<tpl if="!name">'+'{displayUrl}'+'</tpl>'+' <a href="{liveUrl}" target="_blank">'+'View'+'</a>'
}]
}),
sm:new Ext.grid.RowSelectionModel({singleSelect:true}),
viewConfig:{
emptyText:'No files found',
forceFit:true,
headersDisabled:true
},
listeners:{
dblclick:function(){
this.fireEvent('next',true)
},
scope:this
}
}
];
this.buttons=[
{
ref:'../previousButton',
xtype:'button',
text:'Back',
cls:'import-back-btn',
width:'auto',
autoWidth:true,
handler:function(){
this.fireEvent('previous')
},
scope:this
},
'->',
{
ref:'../nextButton',
text:'Select front page',
cls:'x-btn-primary large wide',
autoWidth:true,
handler:function(){
this.fireEvent('next',true)
},
scope:this
}
];
web.pageImport.ui.ProjectPageChooser.superclass.initComponent.call(this)
},
update:function(pages){
var domain=this.app.dal.domain;
pages.forEach(function(item){
item.liveUrl='http://'+domain+item.url;
item.displayUrl=item.url.substr(1)
});
this.grid.store.loadData({pages:pages})
},
getSelected:function(){
var page=this.grid.getSelectionModel().getSelected();
if(page){
return page.data.url
}else{
return null
}
}
});
Ext.reg('web-pageimport-ui-projectpagechooser',web.pageImport.ui.ProjectPageChooser);
(function(glob){
var version='0.4.0',has='hasOwnProperty',separator=/[\.\/]/,wildcard='*',fun=function(){
},numsort=function(a,b){
return a-b
},current_event,stop,events={n:{}},eve=function(name,scope){
var e=events,oldstop=stop,args=Array.prototype.slice.call(arguments,2),listeners=eve.listeners(name),z=0,f=false,l,indexed=[],queue={},out=[],errors=[];
current_event=name;
stop=0;
for(var i=0,ii=listeners.length;i<ii;i++)
if('zIndex'in listeners[i]){
indexed.push(listeners[i].zIndex);
if(listeners[i].zIndex<0){
queue[listeners[i].zIndex]=listeners[i]
}
}
indexed.sort(numsort);
while(indexed[z]<0){
l=queue[indexed[z++]];
out.push(l.apply(scope,args));
if(stop){
stop=oldstop;
return out
}
}
for(i=0;i<ii;i++){
l=listeners[i];
if('zIndex'in l){
if(l.zIndex==indexed[z]){
out.push(l.apply(scope,args));
if(stop){
stop=oldstop;
return out
}
do{
z++;
l=queue[indexed[z]];
l&&out.push(l.apply(scope,args));
if(stop){
stop=oldstop;
return out
}
}while(l)
}else{
queue[l.zIndex]=l
}
}else{
out.push(l.apply(scope,args));
if(stop){
stop=oldstop;
return out
}
}
}
stop=oldstop;
return out.length?out:null
};
eve.listeners=function(name){
var names=name.split(separator),e=events,item,items,k,i,ii,j,jj,nes,es=[e],out=[];
for(i=0,ii=names.length;i<ii;i++){
nes=[];
for(j=0,jj=es.length;j<jj;j++){
e=es[j].n;
items=[
e[names[i]],
e[wildcard]
];
k=2;
while(k--){
item=items[k];
if(item){
nes.push(item);
out=out.concat(item.f||[])
}
}
}
es=nes
}
return out
};
eve.on=function(name,f){
var names=name.split(separator),e=events;
for(var i=0,ii=names.length;i<ii;i++){
e=e.n;
!e[names[i]]&&(e[names[i]]={n:{}});
e=e[names[i]]
}
e.f=e.f||[];
for(i=0,ii=e.f.length;i<ii;i++)
if(e.f[i]==f){
return fun
}
e.f.push(f);
return function(zIndex){
if(+zIndex==+zIndex){
f.zIndex=+zIndex
}
}
};
eve.stop=function(){
stop=1
};
eve.nt=function(subname){
if(subname){
return new RegExp('(?:\\.|\\/|^)'+subname+'(?:\\.|\\/|$)').test(current_event)
}
return current_event
};
eve.unbind=function(name,f){
var names=name.split(separator),e,key,splice,i,ii,j,jj,cur=[events];
for(i=0,ii=names.length;i<ii;i++){
for(j=0;j<cur.length;j+=splice.length-2){
splice=[
j,
1
];
e=cur[j].n;
if(names[i]!=wildcard){
if(e[names[i]]){
splice.push(e[names[i]])
}
}else{
for(key in e)
if(e[has](key)){
splice.push(e[key])
}
}
cur.splice.apply(cur,splice)
}
}
for(i=0,ii=cur.length;i<ii;i++){
e=cur[i];
while(e.n){
if(f){
if(e.f){
for(j=0,jj=e.f.length;j<jj;j++)
if(e.f[j]==f){
e.f.splice(j,1);
break
}
!e.f.length&&delete e.f
}
for(key in e.n)
if(e.n[has](key)&&e.n[key].f){
var funcs=e.n[key].f;
for(j=0,jj=funcs.length;j<jj;j++)
if(funcs[j]==f){
funcs.splice(j,1);
break
}
!funcs.length&&delete e.n[key].f
}
}else{
delete e.f;
for(key in e.n)
if(e.n[has](key)&&e.n[key].f){
delete e.n[key].f
}
}
e=e.n
}
}
};
eve.once=function(name,f){
var f2=function(){
f.apply(this,arguments);
eve.unbind(name,f2)
};
return eve.on(name,f2)
};
eve.version=version;
eve.toString=function(){
return'You are running Eve '+version
};
typeof module!='undefined'&&module.exports?module.exports=eve:glob.eve=eve
}(this));
(function(){
function R(first){
if(R.is(first,'function')){
return loaded?first():eve.on('DOMload',first)
}else if(R.is(first,array)){
return R._engine.create[apply](R,first.splice(0,3+R.is(first[0],nu))).add(first)
}else{
var args=Array.prototype.slice.call(arguments,0);
if(R.is(args[args.length-1],'function')){
var f=args.pop();
return loaded?f.call(R._engine.create[apply](R,args)):eve.on('DOMload',function(){
f.call(R._engine.create[apply](R,args))
})
}else{
return R._engine.create[apply](R,arguments)
}
}
}
R.version='2.0.1';
R.eve=eve;
var loaded,separator=/[, ]+/,elements={
circle:1,
rect:1,
path:1,
ellipse:1,
text:1,
image:1
},formatrg=/\{(\d+)\}/g,proto='prototype',has='hasOwnProperty',g={
doc:document,
win:window
},oldRaphael={
was:Object.prototype[has].call(g.win,'Raphael'),
is:g.win.Raphael
},Paper=function(){
this.ca=this.customAttributes={}
},paperproto,appendChild='appendChild',apply='apply',concat='concat',supportsTouch='createTouch'in g.doc,E='',S=' ',Str=String,split='split',events='click dblclick mousedown mousemove mouseout mouseover mouseup touchstart touchmove touchend touchcancel'[split](S),touchMap={
mousedown:'touchstart',
mousemove:'touchmove',
mouseup:'touchend'
},lowerCase=Str.prototype.toLowerCase,math=Math,mmax=math.max,mmin=math.min,abs=math.abs,pow=math.pow,PI=math.PI,nu='number',string='string',array='array',toString='toString',fillString='fill',objectToString=Object.prototype.toString,paper={},push='push',ISURL=R._ISURL=/^url\(['"]?([^\)]+?)['"]?\)$/i,colourRegExp=/^\s*((#[a-f\d]{6})|(#[a-f\d]{3})|rgba?\(\s*([\d\.]+%?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+%?(?:\s*,\s*[\d\.]+%?)?)\s*\)|hsba?\(\s*([\d\.]+(?:deg|\xb0|%)?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\)|hsla?\(\s*([\d\.]+(?:deg|\xb0|%)?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\))\s*$/i,isnan={
'NaN':1,
'Infinity':1,
'-Infinity':1
},bezierrg=/^(?:cubic-)?bezier\(([^,]+),([^,]+),([^,]+),([^\)]+)\)/,round=math.round,setAttribute='setAttribute',toFloat=parseFloat,toInt=parseInt,upperCase=Str.prototype.toUpperCase,availableAttrs=R._availableAttrs={
'arrow-end':'none',
'arrow-start':'none',
blur:0,
'clip-rect':'0 0 1e9 1e9',
cursor:'default',
cx:0,
cy:0,
fill:'#fff',
'fill-opacity':1,
font:'10px "Arial"',
'font-family':'"Arial"',
'font-size':'10',
'font-style':'normal',
'font-weight':400,
gradient:0,
height:0,
href:'http://raphaeljs.com/',
'letter-spacing':0,
opacity:1,
path:'M0,0',
r:0,
rx:0,
ry:0,
src:'',
stroke:'#000',
'stroke-dasharray':'',
'stroke-linecap':'butt',
'stroke-linejoin':'butt',
'stroke-miterlimit':0,
'stroke-opacity':1,
'stroke-width':1,
target:'_blank',
'text-anchor':'middle',
title:'Raphael',
transform:'',
width:0,
x:0,
y:0
},availableAnimAttrs=R._availableAnimAttrs={
blur:nu,
'clip-rect':'csv',
cx:nu,
cy:nu,
fill:'colour',
'fill-opacity':nu,
'font-size':nu,
height:nu,
opacity:nu,
path:'path',
r:nu,
rx:nu,
ry:nu,
stroke:'colour',
'stroke-opacity':nu,
'stroke-width':nu,
transform:'transform',
width:nu,
x:nu,
y:nu
},commaSpaces=/\s*,\s*/,hsrg={
hs:1,
rg:1
},p2s=/,?([achlmqrstvxz]),?/gi,pathCommand=/([achlmrqstvz])[\s,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?\s*,?\s*)+)/gi,tCommand=/([rstm])[\s,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?\s*,?\s*)+)/gi,pathValues=/(-?\d*\.?\d*(?:e[\-+]?\d+)?)\s*,?\s*/gi,radial_gradient=R._radial_gradient=/^r(?:\(([^,]+?)\s*,\s*([^\)]+?)\))?/,eldata={},sortByKey=function(a,b){
return a.key-b.key
},sortByNumber=function(a,b){
return toFloat(a)-toFloat(b)
},fun=function(){
},pipe=function(x){
return x
},rectPath=R._rectPath=function(x,y,w,h,r){
if(r){
return[
[
'M',
x+r,
y
],
[
'l',
w-r*2,
0
],
[
'a',
r,
r,
0,
0,
1,
r,
r
],
[
'l',
0,
h-r*2
],
[
'a',
r,
r,
0,
0,
1,
-r,
r
],
[
'l',
r*2-w,
0
],
[
'a',
r,
r,
0,
0,
1,
-r,
-r
],
[
'l',
0,
r*2-h
],
[
'a',
r,
r,
0,
0,
1,
r,
-r
],
['z']
]
}
return[
[
'M',
x,
y
],
[
'l',
w,
0
],
[
'l',
0,
h
],
[
'l',
-w,
0
],
['z']
]
},ellipsePath=function(x,y,rx,ry){
if(ry==null){
ry=rx
}
return[
[
'M',
x,
y
],
[
'm',
0,
-ry
],
[
'a',
rx,
ry,
0,
1,
1,
0,
2*ry
],
[
'a',
rx,
ry,
0,
1,
1,
0,
-2*ry
],
['z']
]
},getPath=R._getPath={
path:function(el){
return el.attr('path')
},
circle:function(el){
var a=el.attrs;
return ellipsePath(a.cx,a.cy,a.r)
},
ellipse:function(el){
var a=el.attrs;
return ellipsePath(a.cx,a.cy,a.rx,a.ry)
},
rect:function(el){
var a=el.attrs;
return rectPath(a.x,a.y,a.width,a.height,a.r)
},
image:function(el){
var a=el.attrs;
return rectPath(a.x,a.y,a.width,a.height)
},
text:function(el){
var bbox=el._getBBox();
return rectPath(bbox.x,bbox.y,bbox.width,bbox.height)
}
},mapPath=R.mapPath=function(path,matrix){
if(!matrix){
return path
}
var x,y,i,j,ii,jj,pathi;
path=path2curve(path);
for(i=0,ii=path.length;i<ii;i++){
pathi=path[i];
for(j=1,jj=pathi.length;j<jj;j+=2){
x=matrix.x(pathi[j],pathi[j+1]);
y=matrix.y(pathi[j],pathi[j+1]);
pathi[j]=x;
pathi[j+1]=y
}
}
return path
};
R._g=g;
R.type=g.win.SVGAngle||g.doc.implementation.hasFeature('http://www.w3.org/TR/SVG11/feature#BasicStructure','1.1')?'SVG':'VML';
if(R.type=='VML'){
var d=g.doc.createElement('div'),b;
d.innerHTML='<v:shape adj="1"/>';
b=d.firstChild;
b.style.behavior='url(#default#VML)';
if(!(b&&typeof b.adj=='object')){
return R.type=E
}
d=null
}
R.svg=!(R.vml=R.type=='VML');
R._Paper=Paper;
R.fn=paperproto=Paper.prototype=R.prototype;
R._id=0;
R._oid=0;
R.is=function(o,type){
type=lowerCase.call(type);
if(type=='finite'){
return!isnan[has](+o)
}
if(type=='array'){
return o instanceof Array
}
return type=='null'&&o===null||type==typeof o&&o!==null||type=='object'&&o===Object(o)||type=='array'&&Array.isArray&&Array.isArray(o)||objectToString.call(o).slice(8,-1).toLowerCase()==type
};
R.angle=function(x1,y1,x2,y2,x3,y3){
if(x3==null){
var x=x1-x2,y=y1-y2;
if(!x&&!y){
return 0
}
return(180+math.atan2(-y,-x)*180/PI+360)%360
}else{
return R.angle(x1,y1,x3,y3)-R.angle(x2,y2,x3,y3)
}
};
R.rad=function(deg){
return deg%360*PI/180
};
R.deg=function(rad){
return rad*180/PI%360
};
R.snapTo=function(values,value,tolerance){
tolerance=R.is(tolerance,'finite')?tolerance:10;
if(R.is(values,array)){
var i=values.length;
while(i--)
if(abs(values[i]-value)<=tolerance){
return values[i]
}
}else{
values=+values;
var rem=value%values;
if(rem<tolerance){
return value-rem
}
if(rem>values-tolerance){
return value-rem+values
}
}
return value
};
var createUUID=R.createUUID=function(uuidRegEx,uuidReplacer){
return function(){
return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(uuidRegEx,uuidReplacer).toUpperCase()
}
}(/[xy]/g,function(c){
var r=math.random()*16|0,v=c=='x'?r:r&3|8;
return v.toString(16)
});
R.setWindow=function(newwin){
eve('setWindow',R,g.win,newwin);
g.win=newwin;
g.doc=g.win.document;
if(R._engine.initWin){
R._engine.initWin(g.win)
}
};
var toHex=function(color){
if(R.vml){
var trim=/^\s+|\s+$/g;
var bod;
try{
var docum=new ActiveXObject('htmlfile');
docum.write('<body>');
docum.close();
bod=docum.body
}catch(e){
bod=createPopup().document.body
}
var range=bod.createTextRange();
toHex=cacher(function(color){
try{
bod.style.color=Str(color).replace(trim,E);
var value=range.queryCommandValue('ForeColor');
value=(value&255)<<16|value&65280|(value&16711680)>>>16;
return'#'+('000000'+value.toString(16)).slice(-6)
}catch(e){
return'none'
}
})
}else{
var i=g.doc.createElement('i');
i.title='Raphal Colour Picker';
i.style.display='none';
g.doc.body.appendChild(i);
toHex=cacher(function(color){
i.style.color=color;
return g.doc.defaultView.getComputedStyle(i,E).getPropertyValue('color')
})
}
return toHex(color)
},hsbtoString=function(){
return'hsb('+[
this.h,
this.s,
this.b
]+')'
},hsltoString=function(){
return'hsl('+[
this.h,
this.s,
this.l
]+')'
},rgbtoString=function(){
return this.hex
},prepareRGB=function(r,g,b){
if(g==null&&R.is(r,'object')&&'r'in r&&'g'in r&&'b'in r){
b=r.b;
g=r.g;
r=r.r
}
if(g==null&&R.is(r,string)){
var clr=R.getRGB(r);
r=clr.r;
g=clr.g;
b=clr.b
}
if(r>1||g>1||b>1){
r/=255;
g/=255;
b/=255
}
return[
r,
g,
b
]
},packageRGB=function(r,g,b,o){
r*=255;
g*=255;
b*=255;
var rgb={
r:r,
g:g,
b:b,
hex:R.rgb(r,g,b),
toString:rgbtoString
};
R.is(o,'finite')&&(rgb.opacity=o);
return rgb
};
R.color=function(clr){
var rgb;
if(R.is(clr,'object')&&'h'in clr&&'s'in clr&&'b'in clr){
rgb=R.hsb2rgb(clr);
clr.r=rgb.r;
clr.g=rgb.g;
clr.b=rgb.b;
clr.hex=rgb.hex
}else if(R.is(clr,'object')&&'h'in clr&&'s'in clr&&'l'in clr){
rgb=R.hsl2rgb(clr);
clr.r=rgb.r;
clr.g=rgb.g;
clr.b=rgb.b;
clr.hex=rgb.hex
}else{
if(R.is(clr,'string')){
clr=R.getRGB(clr)
}
if(R.is(clr,'object')&&'r'in clr&&'g'in clr&&'b'in clr){
rgb=R.rgb2hsl(clr);
clr.h=rgb.h;
clr.s=rgb.s;
clr.l=rgb.l;
rgb=R.rgb2hsb(clr);
clr.v=rgb.b
}else{
clr={hex:'none'};
clr.r=clr.g=clr.b=clr.h=clr.s=clr.v=clr.l=-1
}
}
clr.toString=rgbtoString;
return clr
};
R.hsb2rgb=function(h,s,v,o){
if(this.is(h,'object')&&'h'in h&&'s'in h&&'b'in h){
v=h.b;
s=h.s;
h=h.h;
o=h.o
}
h*=360;
var R,G,B,X,C;
h=h%360/60;
C=v*s;
X=C*(1-abs(h%2-1));
R=G=B=v-C;
h=~~h;
R+=[
C,
X,
0,
0,
X,
C
][h];
G+=[
X,
C,
C,
X,
0,
0
][h];
B+=[
0,
0,
X,
C,
C,
X
][h];
return packageRGB(R,G,B,o)
};
R.hsl2rgb=function(h,s,l,o){
if(this.is(h,'object')&&'h'in h&&'s'in h&&'l'in h){
l=h.l;
s=h.s;
h=h.h
}
if(h>1||s>1||l>1){
h/=360;
s/=100;
l/=100
}
h*=360;
var R,G,B,X,C;
h=h%360/60;
C=2*s*(l<0.5?l:1-l);
X=C*(1-abs(h%2-1));
R=G=B=l-C/2;
h=~~h;
R+=[
C,
X,
0,
0,
X,
C
][h];
G+=[
X,
C,
C,
X,
0,
0
][h];
B+=[
0,
0,
X,
C,
C,
X
][h];
return packageRGB(R,G,B,o)
};
R.rgb2hsb=function(r,g,b){
b=prepareRGB(r,g,b);
r=b[0];
g=b[1];
b=b[2];
var H,S,V,C;
V=mmax(r,g,b);
C=V-mmin(r,g,b);
H=C==0?null:V==r?(g-b)/C:V==g?(b-r)/C+2:(r-g)/C+4;
H=(H+360)%6*60/360;
S=C==0?0:C/V;
return{
h:H,
s:S,
b:V,
toString:hsbtoString
}
};
R.rgb2hsl=function(r,g,b){
b=prepareRGB(r,g,b);
r=b[0];
g=b[1];
b=b[2];
var H,S,L,M,m,C;
M=mmax(r,g,b);
m=mmin(r,g,b);
C=M-m;
H=C==0?null:M==r?(g-b)/C:M==g?(b-r)/C+2:(r-g)/C+4;
H=(H+360)%6*60/360;
L=(M+m)/2;
S=C==0?0:L<0.5?C/(2*L):C/(2-2*L);
return{
h:H,
s:S,
l:L,
toString:hsltoString
}
};
R._path2string=function(){
return this.join(',').replace(p2s,'$1')
};
function repush(array,item){
for(var i=0,ii=array.length;i<ii;i++)
if(array[i]===item){
return array.push(array.splice(i,1)[0])
}
}
function cacher(f,scope,postprocessor){
function newf(){
var arg=Array.prototype.slice.call(arguments,0),args=arg.join(''),cache=newf.cache=newf.cache||{},count=newf.count=newf.count||[];
if(cache[has](args)){
repush(count,args);
return postprocessor?postprocessor(cache[args]):cache[args]
}
count.length>=1000&&delete cache[count.shift()];
count.push(args);
cache[args]=f[apply](scope,arg);
return postprocessor?postprocessor(cache[args]):cache[args]
}
return newf
}
var preload=R._preload=function(src,f){
var img=g.doc.createElement('img');
img.style.cssText='position:absolute;left:-9999em;top:-9999em';
img.onload=function(){
f.call(this);
this.onload=null;
g.doc.body.removeChild(this)
};
img.onerror=function(){
g.doc.body.removeChild(this)
};
g.doc.body.appendChild(img);
img.src=src
};
function clrToString(){
return this.hex
}
R.getRGB=cacher(function(colour){
if(!colour||!!((colour=Str(colour)).indexOf('-')+1)){
return{
r:-1,
g:-1,
b:-1,
hex:'none',
error:1,
toString:clrToString
}
}
if(colour=='none'){
return{
r:-1,
g:-1,
b:-1,
hex:'none',
toString:clrToString
}
}
!(hsrg[has](colour.toLowerCase().substring(0,2))||colour.charAt()=='#')&&(colour=toHex(colour));
var res,red,green,blue,opacity,t,values,rgb=colour.match(colourRegExp);
if(rgb){
if(rgb[2]){
blue=toInt(rgb[2].substring(5),16);
green=toInt(rgb[2].substring(3,5),16);
red=toInt(rgb[2].substring(1,3),16)
}
if(rgb[3]){
blue=toInt((t=rgb[3].charAt(3))+t,16);
green=toInt((t=rgb[3].charAt(2))+t,16);
red=toInt((t=rgb[3].charAt(1))+t,16)
}
if(rgb[4]){
values=rgb[4][split](commaSpaces);
red=toFloat(values[0]);
values[0].slice(-1)=='%'&&(red*=2.55);
green=toFloat(values[1]);
values[1].slice(-1)=='%'&&(green*=2.55);
blue=toFloat(values[2]);
values[2].slice(-1)=='%'&&(blue*=2.55);
rgb[1].toLowerCase().slice(0,4)=='rgba'&&(opacity=toFloat(values[3]));
values[3]&&values[3].slice(-1)=='%'&&(opacity/=100)
}
if(rgb[5]){
values=rgb[5][split](commaSpaces);
red=toFloat(values[0]);
values[0].slice(-1)=='%'&&(red*=2.55);
green=toFloat(values[1]);
values[1].slice(-1)=='%'&&(green*=2.55);
blue=toFloat(values[2]);
values[2].slice(-1)=='%'&&(blue*=2.55);
(values[0].slice(-3)=='deg'||values[0].slice(-1)=='')&&(red/=360);
rgb[1].toLowerCase().slice(0,4)=='hsba'&&(opacity=toFloat(values[3]));
values[3]&&values[3].slice(-1)=='%'&&(opacity/=100);
return R.hsb2rgb(red,green,blue,opacity)
}
if(rgb[6]){
values=rgb[6][split](commaSpaces);
red=toFloat(values[0]);
values[0].slice(-1)=='%'&&(red*=2.55);
green=toFloat(values[1]);
values[1].slice(-1)=='%'&&(green*=2.55);
blue=toFloat(values[2]);
values[2].slice(-1)=='%'&&(blue*=2.55);
(values[0].slice(-3)=='deg'||values[0].slice(-1)=='')&&(red/=360);
rgb[1].toLowerCase().slice(0,4)=='hsla'&&(opacity=toFloat(values[3]));
values[3]&&values[3].slice(-1)=='%'&&(opacity/=100);
return R.hsl2rgb(red,green,blue,opacity)
}
rgb={
r:red,
g:green,
b:blue,
toString:clrToString
};
rgb.hex='#'+(16777216|blue|green<<8|red<<16).toString(16).slice(1);
R.is(opacity,'finite')&&(rgb.opacity=opacity);
return rgb
}
return{
r:-1,
g:-1,
b:-1,
hex:'none',
error:1,
toString:clrToString
}
},R);
R.hsb=cacher(function(h,s,b){
return R.hsb2rgb(h,s,b).hex
});
R.hsl=cacher(function(h,s,l){
return R.hsl2rgb(h,s,l).hex
});
R.rgb=cacher(function(r,g,b){
return'#'+(16777216|b|g<<8|r<<16).toString(16).slice(1)
});
R.getColor=function(value){
var start=this.getColor.start=this.getColor.start||{
h:0,
s:1,
b:value||0.75
},rgb=this.hsb2rgb(start.h,start.s,start.b);
start.h+=0.075;
if(start.h>1){
start.h=0;
start.s-=0.2;
start.s<=0&&(this.getColor.start={
h:0,
s:1,
b:start.b
})
}
return rgb.hex
};
R.getColor.reset=function(){
delete this.start
};
function catmullRom2bezier(crp){
var d=[];
for(var i=0,iLen=crp.length;iLen-2>i;i+=2){
var p=[
{
x:+crp[i],
y:+crp[i+1]
},
{
x:+crp[i],
y:+crp[i+1]
},
{
x:+crp[i+2],
y:+crp[i+3]
},
{
x:+crp[i+4],
y:+crp[i+5]
}
];
if(iLen-4==i){
p[0]={
x:+crp[i-2],
y:+crp[i-1]
};
p[3]=p[2]
}else if(i){
p[0]={
x:+crp[i-2],
y:+crp[i-1]
}
}
d.push([
'C',
(-p[0].x+6*p[1].x+p[2].x)/6,
(-p[0].y+6*p[1].y+p[2].y)/6,
(p[1].x+6*p[2].x-p[3].x)/6,
(p[1].y+6*p[2].y-p[3].y)/6,
p[2].x,
p[2].y
])
}
return d
}
R.parsePathString=cacher(function(pathString){
if(!pathString){
return null
}
var paramCounts={
a:7,
c:6,
h:1,
l:2,
m:2,
r:4,
q:4,
s:4,
t:2,
v:1,
z:0
},data=[];
if(R.is(pathString,array)&&R.is(pathString[0],array)){
data=pathClone(pathString)
}
if(!data.length){
Str(pathString).replace(pathCommand,function(a,b,c){
var params=[],name=b.toLowerCase();
c.replace(pathValues,function(a,b){
b&&params.push(+b)
});
if(name=='m'&&params.length>2){
data.push([b][concat](params.splice(0,2)));
name='l';
b=b=='m'?'l':'L'
}
if(name=='r'){
data.push([b][concat](params))
}else
while(params.length>=paramCounts[name]){
data.push([b][concat](params.splice(0,paramCounts[name])));
if(!paramCounts[name]){
break
}
}
})
}
data.toString=R._path2string;
return data
});
R.parseTransformString=cacher(function(TString){
if(!TString){
return null
}
var paramCounts={
r:3,
s:4,
t:2,
m:6
},data=[];
if(R.is(TString,array)&&R.is(TString[0],array)){
data=pathClone(TString)
}
if(!data.length){
Str(TString).replace(tCommand,function(a,b,c){
var params=[],name=lowerCase.call(b);
c.replace(pathValues,function(a,b){
b&&params.push(+b)
});
data.push([b][concat](params))
})
}
data.toString=R._path2string;
return data
});
R.findDotsAtSegment=function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t){
var t1=1-t,t13=pow(t1,3),t12=pow(t1,2),t2=t*t,t3=t2*t,x=t13*p1x+t12*3*t*c1x+t1*3*t*t*c2x+t3*p2x,y=t13*p1y+t12*3*t*c1y+t1*3*t*t*c2y+t3*p2y,mx=p1x+2*t*(c1x-p1x)+t2*(c2x-2*c1x+p1x),my=p1y+2*t*(c1y-p1y)+t2*(c2y-2*c1y+p1y),nx=c1x+2*t*(c2x-c1x)+t2*(p2x-2*c2x+c1x),ny=c1y+2*t*(c2y-c1y)+t2*(p2y-2*c2y+c1y),ax=t1*p1x+t*c1x,ay=t1*p1y+t*c1y,cx=t1*c2x+t*p2x,cy=t1*c2y+t*p2y,alpha=90-math.atan2(mx-nx,my-ny)*180/PI;
(mx>nx||my<ny)&&(alpha+=180);
return{
x:x,
y:y,
m:{
x:mx,
y:my
},
n:{
x:nx,
y:ny
},
start:{
x:ax,
y:ay
},
end:{
x:cx,
y:cy
},
alpha:alpha
}
};
R._removedFactory=function(methodname){
return function(){
throw new Error('Raphal: you are calling to method '+methodname+' of removed object')
}
};
var pathDimensions=cacher(function(path){
if(!path){
return{
x:0,
y:0,
width:0,
height:0
}
}
path=path2curve(path);
var x=0,y=0,X=[],Y=[],p;
for(var i=0,ii=path.length;i<ii;i++){
p=path[i];
if(p[0]=='M'){
x=p[1];
y=p[2];
X.push(x);
Y.push(y)
}else{
var dim=curveDim(x,y,p[1],p[2],p[3],p[4],p[5],p[6]);
X=X[concat](dim.min.x,dim.max.x);
Y=Y[concat](dim.min.y,dim.max.y);
x=p[5];
y=p[6]
}
}
var xmin=mmin[apply](0,X),ymin=mmin[apply](0,Y);
return{
x:xmin,
y:ymin,
width:mmax[apply](0,X)-xmin,
height:mmax[apply](0,Y)-ymin
}
},null,function(o){
return{
x:o.x,
y:o.y,
width:o.width,
height:o.height
}
}),pathClone=function(pathArray){
var res=[];
if(!R.is(pathArray,array)||!R.is(pathArray&&pathArray[0],array)){
pathArray=R.parsePathString(pathArray)
}
for(var i=0,ii=pathArray.length;i<ii;i++){
res[i]=[];
for(var j=0,jj=pathArray[i].length;j<jj;j++){
res[i][j]=pathArray[i][j]
}
}
res.toString=R._path2string;
return res
},pathToRelative=R._pathToRelative=cacher(function(pathArray){
if(!R.is(pathArray,array)||!R.is(pathArray&&pathArray[0],array)){
pathArray=R.parsePathString(pathArray)
}
var res=[],x=0,y=0,mx=0,my=0,start=0;
if(pathArray[0][0]=='M'){
x=pathArray[0][1];
y=pathArray[0][2];
mx=x;
my=y;
start++;
res.push([
'M',
x,
y
])
}
for(var i=start,ii=pathArray.length;i<ii;i++){
var r=res[i]=[],pa=pathArray[i];
if(pa[0]!=lowerCase.call(pa[0])){
r[0]=lowerCase.call(pa[0]);
switch(r[0]){
case'a':
r[1]=pa[1];
r[2]=pa[2];
r[3]=pa[3];
r[4]=pa[4];
r[5]=pa[5];
r[6]=+(pa[6]-x).toFixed(3);
r[7]=+(pa[7]-y).toFixed(3);
break;
case'v':
r[1]=+(pa[1]-y).toFixed(3);
break;
case'm':
mx=pa[1];
my=pa[2];
default:
for(var j=1,jj=pa.length;j<jj;j++){
r[j]=+(pa[j]-(j%2?x:y)).toFixed(3)
}
}
}else{
r=res[i]=[];
if(pa[0]=='m'){
mx=pa[1]+x;
my=pa[2]+y
}
for(var k=0,kk=pa.length;k<kk;k++){
res[i][k]=pa[k]
}
}
var len=res[i].length;
switch(res[i][0]){
case'z':
x=mx;
y=my;
break;
case'h':
x+=+res[i][len-1];
break;
case'v':
y+=+res[i][len-1];
break;
default:
x+=+res[i][len-2];
y+=+res[i][len-1]
}
}
res.toString=R._path2string;
return res
},0,pathClone),pathToAbsolute=R._pathToAbsolute=cacher(function(pathArray){
if(!R.is(pathArray,array)||!R.is(pathArray&&pathArray[0],array)){
pathArray=R.parsePathString(pathArray)
}
if(!pathArray||!pathArray.length){
return[[
'M',
0,
0
]]
}
var res=[],x=0,y=0,mx=0,my=0,start=0;
if(pathArray[0][0]=='M'){
x=+pathArray[0][1];
y=+pathArray[0][2];
mx=x;
my=y;
start++;
res[0]=[
'M',
x,
y
]
}
for(var r,pa,i=start,ii=pathArray.length;i<ii;i++){
res.push(r=[]);
pa=pathArray[i];
if(pa[0]!=upperCase.call(pa[0])){
r[0]=upperCase.call(pa[0]);
switch(r[0]){
case'A':
r[1]=pa[1];
r[2]=pa[2];
r[3]=pa[3];
r[4]=pa[4];
r[5]=pa[5];
r[6]=+(pa[6]+x);
r[7]=+(pa[7]+y);
break;
case'V':
r[1]=+pa[1]+y;
break;
case'H':
r[1]=+pa[1]+x;
break;
case'R':
var dots=[
x,
y
][concat](pa.slice(1));
for(var j=2,jj=dots.length;j<jj;j++){
dots[j]=+dots[j]+x;
dots[++j]=+dots[j]+y
}
res.pop();
res=res[concat](catmullRom2bezier(dots));
break;
case'M':
mx=+pa[1]+x;
my=+pa[2]+y;
default:
for(j=1,jj=pa.length;j<jj;j++){
r[j]=+pa[j]+(j%2?x:y)
}
}
}else if(pa[0]=='R'){
dots=[
x,
y
][concat](pa.slice(1));
res.pop();
res=res[concat](catmullRom2bezier(dots));
r=['R'][concat](pa.slice(-2))
}else{
for(var k=0,kk=pa.length;k<kk;k++){
r[k]=pa[k]
}
}
switch(r[0]){
case'Z':
x=mx;
y=my;
break;
case'H':
x=r[1];
break;
case'V':
y=r[1];
break;
case'M':
mx=r[r.length-2];
my=r[r.length-1];
default:
x=r[r.length-2];
y=r[r.length-1]
}
}
res.toString=R._path2string;
return res
},null,pathClone),l2c=function(x1,y1,x2,y2){
return[
x1,
y1,
x2,
y2,
x2,
y2
]
},q2c=function(x1,y1,ax,ay,x2,y2){
var _13=1/3,_23=2/3;
return[
_13*x1+_23*ax,
_13*y1+_23*ay,
_13*x2+_23*ax,
_13*y2+_23*ay,
x2,
y2
]
},a2c=function(x1,y1,rx,ry,angle,large_arc_flag,sweep_flag,x2,y2,recursive){
var _120=PI*120/180,rad=PI/180*(+angle||0),res=[],xy,rotate=cacher(function(x,y,rad){
var X=x*math.cos(rad)-y*math.sin(rad),Y=x*math.sin(rad)+y*math.cos(rad);
return{
x:X,
y:Y
}
});
if(!recursive){
xy=rotate(x1,y1,-rad);
x1=xy.x;
y1=xy.y;
xy=rotate(x2,y2,-rad);
x2=xy.x;
y2=xy.y;
var cos=math.cos(PI/180*angle),sin=math.sin(PI/180*angle),x=(x1-x2)/2,y=(y1-y2)/2;
var h=x*x/(rx*rx)+y*y/(ry*ry);
if(h>1){
h=math.sqrt(h);
rx=h*rx;
ry=h*ry
}
var rx2=rx*rx,ry2=ry*ry,k=(large_arc_flag==sweep_flag?-1:1)*math.sqrt(abs((rx2*ry2-rx2*y*y-ry2*x*x)/(rx2*y*y+ry2*x*x))),cx=k*rx*y/ry+(x1+x2)/2,cy=k*-ry*x/rx+(y1+y2)/2,f1=math.asin(((y1-cy)/ry).toFixed(9)),f2=math.asin(((y2-cy)/ry).toFixed(9));
f1=x1<cx?PI-f1:f1;
f2=x2<cx?PI-f2:f2;
f1<0&&(f1=PI*2+f1);
f2<0&&(f2=PI*2+f2);
if(sweep_flag&&f1>f2){
f1=f1-PI*2
}
if(!sweep_flag&&f2>f1){
f2=f2-PI*2
}
}else{
f1=recursive[0];
f2=recursive[1];
cx=recursive[2];
cy=recursive[3]
}
var df=f2-f1;
if(abs(df)>_120){
var f2old=f2,x2old=x2,y2old=y2;
f2=f1+_120*(sweep_flag&&f2>f1?1:-1);
x2=cx+rx*math.cos(f2);
y2=cy+ry*math.sin(f2);
res=a2c(x2,y2,rx,ry,angle,0,sweep_flag,x2old,y2old,[
f2,
f2old,
cx,
cy
])
}
df=f2-f1;
var c1=math.cos(f1),s1=math.sin(f1),c2=math.cos(f2),s2=math.sin(f2),t=math.tan(df/4),hx=4/3*rx*t,hy=4/3*ry*t,m1=[
x1,
y1
],m2=[
x1+hx*s1,
y1-hy*c1
],m3=[
x2+hx*s2,
y2-hy*c2
],m4=[
x2,
y2
];
m2[0]=2*m1[0]-m2[0];
m2[1]=2*m1[1]-m2[1];
if(recursive){
return[
m2,
m3,
m4
][concat](res)
}else{
res=[
m2,
m3,
m4
][concat](res).join()[split](',');
var newres=[];
for(var i=0,ii=res.length;i<ii;i++){
newres[i]=i%2?rotate(res[i-1],res[i],rad).y:rotate(res[i],res[i+1],rad).x
}
return newres
}
},findDotAtSegment=function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t){
var t1=1-t;
return{
x:pow(t1,3)*p1x+pow(t1,2)*3*t*c1x+t1*3*t*t*c2x+pow(t,3)*p2x,
y:pow(t1,3)*p1y+pow(t1,2)*3*t*c1y+t1*3*t*t*c2y+pow(t,3)*p2y
}
},curveDim=cacher(function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y){
var a=c2x-2*c1x+p1x-(p2x-2*c2x+c1x),b=2*(c1x-p1x)-2*(c2x-c1x),c=p1x-c1x,t1=(-b+math.sqrt(b*b-4*a*c))/2/a,t2=(-b-math.sqrt(b*b-4*a*c))/2/a,y=[
p1y,
p2y
],x=[
p1x,
p2x
],dot;
abs(t1)>'1e12'&&(t1=0.5);
abs(t2)>'1e12'&&(t2=0.5);
if(t1>0&&t1<1){
dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t1);
x.push(dot.x);
y.push(dot.y)
}
if(t2>0&&t2<1){
dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t2);
x.push(dot.x);
y.push(dot.y)
}
a=c2y-2*c1y+p1y-(p2y-2*c2y+c1y);
b=2*(c1y-p1y)-2*(c2y-c1y);
c=p1y-c1y;
t1=(-b+math.sqrt(b*b-4*a*c))/2/a;
t2=(-b-math.sqrt(b*b-4*a*c))/2/a;
abs(t1)>'1e12'&&(t1=0.5);
abs(t2)>'1e12'&&(t2=0.5);
if(t1>0&&t1<1){
dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t1);
x.push(dot.x);
y.push(dot.y)
}
if(t2>0&&t2<1){
dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t2);
x.push(dot.x);
y.push(dot.y)
}
return{
min:{
x:mmin[apply](0,x),
y:mmin[apply](0,y)
},
max:{
x:mmax[apply](0,x),
y:mmax[apply](0,y)
}
}
}),path2curve=R._path2curve=cacher(function(path,path2){
var p=pathToAbsolute(path),p2=path2&&pathToAbsolute(path2),attrs={
x:0,
y:0,
bx:0,
by:0,
X:0,
Y:0,
qx:null,
qy:null
},attrs2={
x:0,
y:0,
bx:0,
by:0,
X:0,
Y:0,
qx:null,
qy:null
},processPath=function(path,d){
var nx,ny;
if(!path){
return[
'C',
d.x,
d.y,
d.x,
d.y,
d.x,
d.y
]
}
!(path[0]in{
T:1,
Q:1
})&&(d.qx=d.qy=null);
switch(path[0]){
case'M':
d.X=path[1];
d.Y=path[2];
break;
case'A':
path=['C'][concat](a2c[apply](0,[
d.x,
d.y
][concat](path.slice(1))));
break;
case'S':
nx=d.x+(d.x-(d.bx||d.x));
ny=d.y+(d.y-(d.by||d.y));
path=[
'C',
nx,
ny
][concat](path.slice(1));
break;
case'T':
d.qx=d.x+(d.x-(d.qx||d.x));
d.qy=d.y+(d.y-(d.qy||d.y));
path=['C'][concat](q2c(d.x,d.y,d.qx,d.qy,path[1],path[2]));
break;
case'Q':
d.qx=path[1];
d.qy=path[2];
path=['C'][concat](q2c(d.x,d.y,path[1],path[2],path[3],path[4]));
break;
case'L':
path=['C'][concat](l2c(d.x,d.y,path[1],path[2]));
break;
case'H':
path=['C'][concat](l2c(d.x,d.y,path[1],d.y));
break;
case'V':
path=['C'][concat](l2c(d.x,d.y,d.x,path[1]));
break;
case'Z':
path=['C'][concat](l2c(d.x,d.y,d.X,d.Y));
break
}
return path
},fixArc=function(pp,i){
if(pp[i].length>7){
pp[i].shift();
var pi=pp[i];
while(pi.length){
pp.splice(i++,0,['C'][concat](pi.splice(0,6)))
}
pp.splice(i,1);
ii=mmax(p.length,p2&&p2.length||0)
}
},fixM=function(path1,path2,a1,a2,i){
if(path1&&path2&&path1[i][0]=='M'&&path2[i][0]!='M'){
path2.splice(i,0,[
'M',
a2.x,
a2.y
]);
a1.bx=0;
a1.by=0;
a1.x=path1[i][1];
a1.y=path1[i][2];
ii=mmax(p.length,p2&&p2.length||0)
}
};
for(var i=0,ii=mmax(p.length,p2&&p2.length||0);i<ii;i++){
p[i]=processPath(p[i],attrs);
fixArc(p,i);
p2&&(p2[i]=processPath(p2[i],attrs2));
p2&&fixArc(p2,i);
fixM(p,p2,attrs,attrs2,i);
fixM(p2,p,attrs2,attrs,i);
var seg=p[i],seg2=p2&&p2[i],seglen=seg.length,seg2len=p2&&seg2.length;
attrs.x=seg[seglen-2];
attrs.y=seg[seglen-1];
attrs.bx=toFloat(seg[seglen-4])||attrs.x;
attrs.by=toFloat(seg[seglen-3])||attrs.y;
attrs2.bx=p2&&(toFloat(seg2[seg2len-4])||attrs2.x);
attrs2.by=p2&&(toFloat(seg2[seg2len-3])||attrs2.y);
attrs2.x=p2&&seg2[seg2len-2];
attrs2.y=p2&&seg2[seg2len-1]
}
return p2?[
p,
p2
]:p
},null,pathClone),parseDots=R._parseDots=cacher(function(gradient){
var dots=[];
for(var i=0,ii=gradient.length;i<ii;i++){
var dot={},par=gradient[i].match(/^([^:]*):?([\d\.]*)/);
dot.color=R.getRGB(par[1]);
if(dot.color.error){
return null
}
dot.color=dot.color.hex;
par[2]&&(dot.offset=par[2]+'%');
dots.push(dot)
}
for(i=1,ii=dots.length-1;i<ii;i++){
if(!dots[i].offset){
var start=toFloat(dots[i-1].offset||0),end=0;
for(var j=i+1;j<ii;j++){
if(dots[j].offset){
end=dots[j].offset;
break
}
}
if(!end){
end=100;
j=ii
}
end=toFloat(end);
var d=(end-start)/(j-i+1);
for(;i<j;i++){
start+=d;
dots[i].offset=start+'%'
}
}
}
return dots
}),tear=R._tear=function(el,paper){
el==paper.top&&(paper.top=el.prev);
el==paper.bottom&&(paper.bottom=el.next);
el.next&&(el.next.prev=el.prev);
el.prev&&(el.prev.next=el.next)
},tofront=R._tofront=function(el,paper){
if(paper.top===el){
return
}
tear(el,paper);
el.next=null;
el.prev=paper.top;
paper.top.next=el;
paper.top=el
},toback=R._toback=function(el,paper){
if(paper.bottom===el){
return
}
tear(el,paper);
el.next=paper.bottom;
el.prev=null;
paper.bottom.prev=el;
paper.bottom=el
},insertafter=R._insertafter=function(el,el2,paper){
tear(el,paper);
el2==paper.top&&(paper.top=el);
el2.next&&(el2.next.prev=el);
el.next=el2.next;
el.prev=el2;
el2.next=el
},insertbefore=R._insertbefore=function(el,el2,paper){
tear(el,paper);
el2==paper.bottom&&(paper.bottom=el);
el2.prev&&(el2.prev.next=el);
el.prev=el2.prev;
el2.prev=el;
el.next=el2
},extractTransform=R._extractTransform=function(el,tstr){
if(tstr==null){
return el._.transform
}
tstr=Str(tstr).replace(/\.{3}|\u2026/g,el._.transform||E);
var tdata=R.parseTransformString(tstr),deg=0,dx=0,dy=0,sx=1,sy=1,_=el._,m=new Matrix;
_.transform=tdata||[];
if(tdata){
for(var i=0,ii=tdata.length;i<ii;i++){
var t=tdata[i],tlen=t.length,command=Str(t[0]).toLowerCase(),absolute=t[0]!=command,inver=absolute?m.invert():0,x1,y1,x2,y2,bb;
if(command=='t'&&tlen==3){
if(absolute){
x1=inver.x(0,0);
y1=inver.y(0,0);
x2=inver.x(t[1],t[2]);
y2=inver.y(t[1],t[2]);
m.translate(x2-x1,y2-y1)
}else{
m.translate(t[1],t[2])
}
}else if(command=='r'){
if(tlen==2){
bb=bb||el.getBBox(1);
m.rotate(t[1],bb.x+bb.width/2,bb.y+bb.height/2);
deg+=t[1]
}else if(tlen==4){
if(absolute){
x2=inver.x(t[2],t[3]);
y2=inver.y(t[2],t[3]);
m.rotate(t[1],x2,y2)
}else{
m.rotate(t[1],t[2],t[3])
}
deg+=t[1]
}
}else if(command=='s'){
if(tlen==2||tlen==3){
bb=bb||el.getBBox(1);
m.scale(t[1],t[tlen-1],bb.x+bb.width/2,bb.y+bb.height/2);
sx*=t[1];
sy*=t[tlen-1]
}else if(tlen==5){
if(absolute){
x2=inver.x(t[3],t[4]);
y2=inver.y(t[3],t[4]);
m.scale(t[1],t[2],x2,y2)
}else{
m.scale(t[1],t[2],t[3],t[4])
}
sx*=t[1];
sy*=t[2]
}
}else if(command=='m'&&tlen==7){
m.add(t[1],t[2],t[3],t[4],t[5],t[6])
}
_.dirtyT=1;
el.matrix=m
}
}
el.matrix=m;
_.sx=sx;
_.sy=sy;
_.deg=deg;
_.dx=dx=m.e;
_.dy=dy=m.f;
if(sx==1&&sy==1&&!deg&&_.bbox){
_.bbox.x+=+dx;
_.bbox.y+=+dy
}else{
_.dirtyT=1
}
},getEmpty=function(item){
var l=item[0];
switch(l.toLowerCase()){
case't':
return[
l,
0,
0
];
case'm':
return[
l,
1,
0,
0,
1,
0,
0
];
case'r':
if(item.length==4){
return[
l,
0,
item[2],
item[3]
]
}else{
return[
l,
0
]
}
case's':
if(item.length==5){
return[
l,
1,
1,
item[3],
item[4]
]
}else if(item.length==3){
return[
l,
1,
1
]
}else{
return[
l,
1
]
}
}
},equaliseTransform=R._equaliseTransform=function(t1,t2){
t2=Str(t2).replace(/\.{3}|\u2026/g,t1);
t1=R.parseTransformString(t1)||[];
t2=R.parseTransformString(t2)||[];
var maxlength=mmax(t1.length,t2.length),from=[],to=[],i=0,j,jj,tt1,tt2;
for(;i<maxlength;i++){
tt1=t1[i]||getEmpty(t2[i]);
tt2=t2[i]||getEmpty(tt1);
if(tt1[0]!=tt2[0]||tt1[0].toLowerCase()=='r'&&(tt1[2]!=tt2[2]||tt1[3]!=tt2[3])||tt1[0].toLowerCase()=='s'&&(tt1[3]!=tt2[3]||tt1[4]!=tt2[4])){
return
}
from[i]=[];
to[i]=[];
for(j=0,jj=mmax(tt1.length,tt2.length);j<jj;j++){
j in tt1&&(from[i][j]=tt1[j]);
j in tt2&&(to[i][j]=tt2[j])
}
}
return{
from:from,
to:to
}
};
R._getContainer=function(x,y,w,h){
var container;
container=h==null&&!R.is(x,'object')?g.doc.getElementById(x):x;
if(container==null){
return
}
if(container.tagName){
if(y==null){
return{
container:container,
width:container.style.pixelWidth||container.offsetWidth,
height:container.style.pixelHeight||container.offsetHeight
}
}else{
return{
container:container,
width:y,
height:w
}
}
}
return{
container:1,
x:x,
y:y,
width:w,
height:h
}
};
R.pathToRelative=pathToRelative;
R._engine={};
R.path2curve=path2curve;
R.matrix=function(a,b,c,d,e,f){
return new Matrix(a,b,c,d,e,f)
};
function Matrix(a,b,c,d,e,f){
if(a!=null){
this.a=+a;
this.b=+b;
this.c=+c;
this.d=+d;
this.e=+e;
this.f=+f
}else{
this.a=1;
this.b=0;
this.c=0;
this.d=1;
this.e=0;
this.f=0
}
}
(function(matrixproto){
matrixproto.add=function(a,b,c,d,e,f){
var out=[
[],
[],
[]
],m=[
[
this.a,
this.c,
this.e
],
[
this.b,
this.d,
this.f
],
[
0,
0,
1
]
],matrix=[
[
a,
c,
e
],
[
b,
d,
f
],
[
0,
0,
1
]
],x,y,z,res;
if(a&&a instanceof Matrix){
matrix=[
[
a.a,
a.c,
a.e
],
[
a.b,
a.d,
a.f
],
[
0,
0,
1
]
]
}
for(x=0;x<3;x++){
for(y=0;y<3;y++){
res=0;
for(z=0;z<3;z++){
res+=m[x][z]*matrix[z][y]
}
out[x][y]=res
}
}
this.a=out[0][0];
this.b=out[1][0];
this.c=out[0][1];
this.d=out[1][1];
this.e=out[0][2];
this.f=out[1][2]
};
matrixproto.invert=function(){
var me=this,x=me.a*me.d-me.b*me.c;
return new Matrix(me.d/x,-me.b/x,-me.c/x,me.a/x,(me.c*me.f-me.d*me.e)/x,(me.b*me.e-me.a*me.f)/x)
};
matrixproto.clone=function(){
return new Matrix(this.a,this.b,this.c,this.d,this.e,this.f)
};
matrixproto.translate=function(x,y){
this.add(1,0,0,1,x,y)
};
matrixproto.scale=function(x,y,cx,cy){
y==null&&(y=x);
(cx||cy)&&this.add(1,0,0,1,cx,cy);
this.add(x,0,0,y,0,0);
(cx||cy)&&this.add(1,0,0,1,-cx,-cy)
};
matrixproto.rotate=function(a,x,y){
a=R.rad(a);
x=x||0;
y=y||0;
var cos=+math.cos(a).toFixed(9),sin=+math.sin(a).toFixed(9);
this.add(cos,sin,-sin,cos,x,y);
this.add(1,0,0,1,-x,-y)
};
matrixproto.x=function(x,y){
return x*this.a+y*this.c+this.e
};
matrixproto.y=function(x,y){
return x*this.b+y*this.d+this.f
};
matrixproto.get=function(i){
return+this[Str.fromCharCode(97+i)].toFixed(4)
};
matrixproto.toString=function(){
return R.svg?'matrix('+[
this.get(0),
this.get(1),
this.get(2),
this.get(3),
this.get(4),
this.get(5)
].join()+')':[
this.get(0),
this.get(2),
this.get(1),
this.get(3),
0,
0
].join()
};
matrixproto.toFilter=function(){
return'progid:DXImageTransform.Microsoft.Matrix(M11='+this.get(0)+', M12='+this.get(2)+', M21='+this.get(1)+', M22='+this.get(3)+', Dx='+this.get(4)+', Dy='+this.get(5)+', sizingmethod=\'auto expand\')'
};
matrixproto.offset=function(){
return[
this.e.toFixed(4),
this.f.toFixed(4)
]
};
function norm(a){
return a[0]*a[0]+a[1]*a[1]
}
function normalize(a){
var mag=math.sqrt(norm(a));
a[0]&&(a[0]/=mag);
a[1]&&(a[1]/=mag)
}
matrixproto.split=function(){
var out={};
out.dx=this.e;
out.dy=this.f;
var row=[
[
this.a,
this.c
],
[
this.b,
this.d
]
];
out.scalex=math.sqrt(norm(row[0]));
normalize(row[0]);
out.shear=row[0][0]*row[1][0]+row[0][1]*row[1][1];
row[1]=[
row[1][0]-row[0][0]*out.shear,
row[1][1]-row[0][1]*out.shear
];
out.scaley=math.sqrt(norm(row[1]));
normalize(row[1]);
out.shear/=out.scaley;
var sin=-row[0][1],cos=row[1][1];
if(cos<0){
out.rotate=R.deg(math.acos(cos));
if(sin<0){
out.rotate=360-out.rotate
}
}else{
out.rotate=R.deg(math.asin(sin))
}
out.isSimple=!+out.shear.toFixed(9)&&(out.scalex.toFixed(9)==out.scaley.toFixed(9)||!out.rotate);
out.isSuperSimple=!+out.shear.toFixed(9)&&out.scalex.toFixed(9)==out.scaley.toFixed(9)&&!out.rotate;
out.noRotation=!+out.shear.toFixed(9)&&!out.rotate;
return out
};
matrixproto.toTransformString=function(shorter){
var s=shorter||this[split]();
if(s.isSimple){
s.scalex=+s.scalex.toFixed(4);
s.scaley=+s.scaley.toFixed(4);
s.rotate=+s.rotate.toFixed(4);
return(s.dx&&s.dy?'t'+[
s.dx,
s.dy
]:E)+(s.scalex!=1||s.scaley!=1?'s'+[
s.scalex,
s.scaley,
0,
0
]:E)+(s.rotate?'r'+[
s.rotate,
0,
0
]:E)
}else{
return'm'+[
this.get(0),
this.get(1),
this.get(2),
this.get(3),
this.get(4),
this.get(5)
]
}
}
}(Matrix.prototype));
var version=navigator.userAgent.match(/Version\/(.*?)\s/)||navigator.userAgent.match(/Chrome\/(\d+)/);
if(navigator.vendor=='Apple Computer, Inc.'&&(version&&version[1]<4||navigator.platform.slice(0,2)=='iP')||navigator.vendor=='Google Inc.'&&version&&version[1]<8){
paperproto.safari=function(){
var rect=this.rect(-99,-99,this.width+99,this.height+99).attr({stroke:'none'});
setTimeout(function(){
rect.remove()
})
}
}else{
paperproto.safari=fun
}
var preventDefault=function(){
this.returnValue=false
},preventTouch=function(){
return this.originalEvent.preventDefault()
},stopPropagation=function(){
this.cancelBubble=true
},stopTouch=function(){
return this.originalEvent.stopPropagation()
},addEvent=function(){
if(g.doc.addEventListener){
return function(obj,type,fn,element){
var realName=supportsTouch&&touchMap[type]?touchMap[type]:type,f=function(e){
var scrollY=g.doc.documentElement.scrollTop||g.doc.body.scrollTop,scrollX=g.doc.documentElement.scrollLeft||g.doc.body.scrollLeft,x=e.clientX+scrollX,y=e.clientY+scrollY;
if(supportsTouch&&touchMap[has](type)){
for(var i=0,ii=e.targetTouches&&e.targetTouches.length;i<ii;i++){
if(e.targetTouches[i].target==obj){
var olde=e;
e=e.targetTouches[i];
e.originalEvent=olde;
e.preventDefault=preventTouch;
e.stopPropagation=stopTouch;
break
}
}
}
return fn.call(element,e,x,y)
};
obj.addEventListener(realName,f,false);
return function(){
obj.removeEventListener(realName,f,false);
return true
}
}
}else if(g.doc.attachEvent){
return function(obj,type,fn,element){
var f=function(e){
e=e||g.win.event;
var scrollY=g.doc.documentElement.scrollTop||g.doc.body.scrollTop,scrollX=g.doc.documentElement.scrollLeft||g.doc.body.scrollLeft,x=e.clientX+scrollX,y=e.clientY+scrollY;
e.preventDefault=e.preventDefault||preventDefault;
e.stopPropagation=e.stopPropagation||stopPropagation;
return fn.call(element,e,x,y)
};
obj.attachEvent('on'+type,f);
var detacher=function(){
obj.detachEvent('on'+type,f);
return true
};
return detacher
}
}
}(),drag=[],dragMove=function(e){
var x=e.clientX,y=e.clientY,scrollY=g.doc.documentElement.scrollTop||g.doc.body.scrollTop,scrollX=g.doc.documentElement.scrollLeft||g.doc.body.scrollLeft,dragi,j=drag.length;
while(j--){
dragi=drag[j];
if(supportsTouch){
var i=e.touches.length,touch;
while(i--){
touch=e.touches[i];
if(touch.identifier==dragi.el._drag.id){
x=touch.clientX;
y=touch.clientY;
(e.originalEvent?e.originalEvent:e).preventDefault();
break
}
}
}else{
e.preventDefault()
}
var node=dragi.el.node,o,next=node.nextSibling,parent=node.parentNode,display=node.style.display;
g.win.opera&&parent.removeChild(node);
node.style.display='none';
o=dragi.el.paper.getElementByPoint(x,y);
node.style.display=display;
g.win.opera&&(next?parent.insertBefore(node,next):parent.appendChild(node));
o&&eve('drag.over.'+dragi.el.id,dragi.el,o);
x+=scrollX;
y+=scrollY;
eve('drag.move.'+dragi.el.id,dragi.move_scope||dragi.el,x-dragi.el._drag.x,y-dragi.el._drag.y,x,y,e)
}
},dragUp=function(e){
R.unmousemove(dragMove).unmouseup(dragUp);
var i=drag.length,dragi;
while(i--){
dragi=drag[i];
dragi.el._drag={};
eve('drag.end.'+dragi.el.id,dragi.end_scope||dragi.start_scope||dragi.move_scope||dragi.el,e)
}
drag=[]
},elproto=R.el={};
for(var i=events.length;i--;){
(function(eventName){
R[eventName]=elproto[eventName]=function(fn,scope){
if(R.is(fn,'function')){
this.events=this.events||[];
this.events.push({
name:eventName,
f:fn,
unbind:addEvent(this.shape||this.node||g.doc,eventName,fn,scope||this)
})
}
return this
};
R['un'+eventName]=elproto['un'+eventName]=function(fn){
var events=this.events,l=events.length;
while(l--)
if(events[l].name==eventName&&events[l].f==fn){
events[l].unbind();
events.splice(l,1);
!events.length&&delete this.events;
return this
}
return this
}
}(events[i]))
}
elproto.data=function(key,value){
var data=eldata[this.id]=eldata[this.id]||{};
if(arguments.length==1){
if(R.is(key,'object')){
for(var i in key)
if(key[has](i)){
this.data(i,key[i])
}
return this
}
eve('data.get.'+this.id,this,data[key],key);
return data[key]
}
data[key]=value;
eve('data.set.'+this.id,this,value,key);
return this
};
elproto.removeData=function(key){
if(key==null){
eldata[this.id]={}
}else{
eldata[this.id]&&delete eldata[this.id][key]
}
return this
};
elproto.hover=function(f_in,f_out,scope_in,scope_out){
return this.mouseover(f_in,scope_in).mouseout(f_out,scope_out||scope_in)
};
elproto.unhover=function(f_in,f_out){
return this.unmouseover(f_in).unmouseout(f_out)
};
var draggable=[];
elproto.drag=function(onmove,onstart,onend,move_scope,start_scope,end_scope){
function start(e){
(e.originalEvent||e).preventDefault();
var scrollY=g.doc.documentElement.scrollTop||g.doc.body.scrollTop,scrollX=g.doc.documentElement.scrollLeft||g.doc.body.scrollLeft;
this._drag.x=e.clientX+scrollX;
this._drag.y=e.clientY+scrollY;
this._drag.id=e.identifier;
!drag.length&&R.mousemove(dragMove).mouseup(dragUp);
drag.push({
el:this,
move_scope:move_scope,
start_scope:start_scope,
end_scope:end_scope
});
onstart&&eve.on('drag.start.'+this.id,onstart);
onmove&&eve.on('drag.move.'+this.id,onmove);
onend&&eve.on('drag.end.'+this.id,onend);
eve('drag.start.'+this.id,start_scope||move_scope||this,e.clientX+scrollX,e.clientY+scrollY,e)
}
this._drag={};
draggable.push({
el:this,
start:start
});
this.mousedown(start);
return this
};
elproto.onDragOver=function(f){
f?eve.on('drag.over.'+this.id,f):eve.unbind('drag.over.'+this.id)
};
elproto.undrag=function(){
var i=draggable.length;
while(i--)
if(draggable[i].el==this){
this.unmousedown(draggable[i].start);
draggable.splice(i,1);
eve.unbind('drag.*.'+this.id)
}
!draggable.length&&R.unmousemove(dragMove).unmouseup(dragUp)
};
paperproto.circle=function(x,y,r){
var out=R._engine.circle(this,x||0,y||0,r||0);
this.__set__&&this.__set__.push(out);
return out
};
paperproto.rect=function(x,y,w,h,r){
var out=R._engine.rect(this,x||0,y||0,w||0,h||0,r||0);
this.__set__&&this.__set__.push(out);
return out
};
paperproto.ellipse=function(x,y,rx,ry){
var out=R._engine.ellipse(this,x||0,y||0,rx||0,ry||0);
this.__set__&&this.__set__.push(out);
return out
};
paperproto.path=function(pathString){
pathString&&!R.is(pathString,string)&&!R.is(pathString[0],array)&&(pathString+=E);
var out=R._engine.path(R.format[apply](R,arguments),this);
this.__set__&&this.__set__.push(out);
return out
};
paperproto.image=function(src,x,y,w,h){
var out=R._engine.image(this,src||'about:blank',x||0,y||0,w||0,h||0);
this.__set__&&this.__set__.push(out);
return out
};
paperproto.text=function(x,y,text){
var out=R._engine.text(this,x||0,y||0,Str(text));
this.__set__&&this.__set__.push(out);
return out
};
paperproto.set=function(itemsArray){
!R.is(itemsArray,'array')&&(itemsArray=Array.prototype.splice.call(arguments,0,arguments.length));
var out=new Set(itemsArray);
this.__set__&&this.__set__.push(out);
return out
};
paperproto.setStart=function(set){
this.__set__=set||this.set()
};
paperproto.setFinish=function(set){
var out=this.__set__;
delete this.__set__;
return out
};
paperproto.setSize=function(width,height){
return R._engine.setSize.call(this,width,height)
};
paperproto.setViewBox=function(x,y,w,h,fit){
return R._engine.setViewBox.call(this,x,y,w,h,fit)
};
paperproto.top=paperproto.bottom=null;
paperproto.raphael=R;
var getOffset=function(elem){
var box=elem.getBoundingClientRect(),doc=elem.ownerDocument,body=doc.body,docElem=doc.documentElement,clientTop=docElem.clientTop||body.clientTop||0,clientLeft=docElem.clientLeft||body.clientLeft||0,top=box.top+(g.win.pageYOffset||docElem.scrollTop||body.scrollTop)-clientTop,left=box.left+(g.win.pageXOffset||docElem.scrollLeft||body.scrollLeft)-clientLeft;
return{
y:top,
x:left
}
};
paperproto.getElementByPoint=function(x,y){
var paper=this,svg=paper.canvas,target=g.doc.elementFromPoint(x,y);
if(g.win.opera&&target.tagName=='svg'){
var so=getOffset(svg),sr=svg.createSVGRect();
sr.x=x-so.x;
sr.y=y-so.y;
sr.width=sr.height=1;
var hits=svg.getIntersectionList(sr,null);
if(hits.length){
target=hits[hits.length-1]
}
}
if(!target){
return null
}
while(target.parentNode&&target!=svg.parentNode&&!target.raphael){
target=target.parentNode
}
target==paper.canvas.parentNode&&(target=svg);
target=target&&target.raphael?paper.getById(target.raphaelid):null;
return target
};
paperproto.getById=function(id){
var bot=this.bottom;
while(bot){
if(bot.id==id){
return bot
}
bot=bot.next
}
return null
};
paperproto.forEach=function(callback,thisArg){
var bot=this.bottom;
while(bot){
if(callback.call(thisArg,bot)===false){
return this
}
bot=bot.next
}
return this
};
function x_y(){
return this.x+S+this.y
}
function x_y_w_h(){
return this.x+S+this.y+S+this.width+'  '+this.height
}
elproto.getBBox=function(isWithoutTransform){
if(this.removed){
return{}
}
var _=this._;
if(isWithoutTransform){
if(_.dirty||!_.bboxwt){
this.realPath=getPath[this.type](this);
_.bboxwt=pathDimensions(this.realPath);
_.bboxwt.toString=x_y_w_h;
_.dirty=0
}
return _.bboxwt
}
if(_.dirty||_.dirtyT||!_.bbox){
if(_.dirty||!this.realPath){
_.bboxwt=0;
this.realPath=getPath[this.type](this)
}
_.bbox=pathDimensions(mapPath(this.realPath,this.matrix));
_.bbox.toString=x_y_w_h;
_.dirty=_.dirtyT=0
}
return _.bbox
};
elproto.clone=function(){
if(this.removed){
return null
}
var out=this.paper[this.type]().attr(this.attr());
this.__set__&&this.__set__.push(out);
return out
};
elproto.glow=function(glow){
if(this.type=='text'){
return null
}
glow=glow||{};
var s={
width:(glow.width||10)+(+this.attr('stroke-width')||1),
fill:glow.fill||false,
opacity:glow.opacity||0.5,
offsetx:glow.offsetx||0,
offsety:glow.offsety||0,
color:glow.color||'#000'
},c=s.width/2,r=this.paper,out=r.set(),path=this.realPath||getPath[this.type](this);
path=this.matrix?mapPath(path,this.matrix):path;
for(var i=1;i<c+1;i++){
out.push(r.path(path).attr({
stroke:s.color,
fill:s.fill?s.color:'none',
'stroke-linejoin':'round',
'stroke-linecap':'round',
'stroke-width':+(s.width/c*i).toFixed(3),
opacity:+(s.opacity/c).toFixed(3)
}))
}
return out.insertBefore(this).translate(s.offsetx,s.offsety)
};
var curveslengths={},getPointAtSegmentLength=function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,length){
var len=0,precision=100,name=[
p1x,
p1y,
c1x,
c1y,
c2x,
c2y,
p2x,
p2y
].join(),cache=curveslengths[name],old,dot;
!cache&&(curveslengths[name]=cache={data:[]});
cache.timer&&clearTimeout(cache.timer);
cache.timer=setTimeout(function(){
delete curveslengths[name]
},2000);
if(length!=null&&!cache.precision){
var total=getPointAtSegmentLength(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y);
cache.precision=~~total*10;
cache.data=[]
}
precision=cache.precision||precision;
for(var i=0;i<precision+1;i++){
if(cache.data[i*precision]){
dot=cache.data[i*precision]
}else{
dot=R.findDotsAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,i/precision);
cache.data[i*precision]=dot
}
i&&(len+=pow(pow(old.x-dot.x,2)+pow(old.y-dot.y,2),0.5));
if(length!=null&&len>=length){
return dot
}
old=dot
}
if(length==null){
return len
}
},getLengthFactory=function(istotal,subpath){
return function(path,length,onlystart){
path=path2curve(path);
var x,y,p,l,sp='',subpaths={},point,len=0;
for(var i=0,ii=path.length;i<ii;i++){
p=path[i];
if(p[0]=='M'){
x=+p[1];
y=+p[2]
}else{
l=getPointAtSegmentLength(x,y,p[1],p[2],p[3],p[4],p[5],p[6]);
if(len+l>length){
if(subpath&&!subpaths.start){
point=getPointAtSegmentLength(x,y,p[1],p[2],p[3],p[4],p[5],p[6],length-len);
sp+=[
'C'+point.start.x,
point.start.y,
point.m.x,
point.m.y,
point.x,
point.y
];
if(onlystart){
return sp
}
subpaths.start=sp;
sp=[
'M'+point.x,
point.y+'C'+point.n.x,
point.n.y,
point.end.x,
point.end.y,
p[5],
p[6]
].join();
len+=l;
x=+p[5];
y=+p[6];
continue
}
if(!istotal&&!subpath){
point=getPointAtSegmentLength(x,y,p[1],p[2],p[3],p[4],p[5],p[6],length-len);
return{
x:point.x,
y:point.y,
alpha:point.alpha
}
}
}
len+=l;
x=+p[5];
y=+p[6]
}
sp+=p.shift()+p
}
subpaths.end=sp;
point=istotal?len:subpath?subpaths:R.findDotsAtSegment(x,y,p[0],p[1],p[2],p[3],p[4],p[5],1);
point.alpha&&(point={
x:point.x,
y:point.y,
alpha:point.alpha
});
return point
}
};
var getTotalLength=getLengthFactory(1),getPointAtLength=getLengthFactory(),getSubpathsAtLength=getLengthFactory(0,1);
R.getTotalLength=getTotalLength;
R.getPointAtLength=getPointAtLength;
R.getSubpath=function(path,from,to){
if(this.getTotalLength(path)-to<0.000001){
return getSubpathsAtLength(path,from).end
}
var a=getSubpathsAtLength(path,to,1);
return from?getSubpathsAtLength(a,from).end:a
};
elproto.getTotalLength=function(){
if(this.type!='path'){
return
}
if(this.node.getTotalLength){
return this.node.getTotalLength()
}
return getTotalLength(this.attrs.path)
};
elproto.getPointAtLength=function(length){
if(this.type!='path'){
return
}
return getPointAtLength(this.attrs.path,length)
};
elproto.getSubpath=function(from,to){
if(this.type!='path'){
return
}
return R.getSubpath(this.attrs.path,from,to)
};
var ef=R.easing_formulas={
linear:function(n){
return n
},
'<':function(n){
return pow(n,1.7)
},
'>':function(n){
return pow(n,0.48)
},
'<>':function(n){
var q=0.48-n/1.04,Q=math.sqrt(0.1734+q*q),x=Q-q,X=pow(abs(x),1/3)*(x<0?-1:1),y=-Q-q,Y=pow(abs(y),1/3)*(y<0?-1:1),t=X+Y+0.5;
return(1-t)*3*t*t+t*t*t
},
backIn:function(n){
var s=1.70158;
return n*n*((s+1)*n-s)
},
backOut:function(n){
n=n-1;
var s=1.70158;
return n*n*((s+1)*n+s)+1
},
elastic:function(n){
if(n==!!n){
return n
}
return pow(2,-10*n)*math.sin((n-0.075)*(2*PI)/0.3)+1
},
bounce:function(n){
var s=7.5625,p=2.75,l;
if(n<1/p){
l=s*n*n
}else{
if(n<2/p){
n-=1.5/p;
l=s*n*n+0.75
}else{
if(n<2.5/p){
n-=2.25/p;
l=s*n*n+0.9375
}else{
n-=2.625/p;
l=s*n*n+0.984375
}
}
}
return l
}
};
ef.easeIn=ef['ease-in']=ef['<'];
ef.easeOut=ef['ease-out']=ef['>'];
ef.easeInOut=ef['ease-in-out']=ef['<>'];
ef['back-in']=ef.backIn;
ef['back-out']=ef.backOut;
var animationElements=[],requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){
setTimeout(callback,16)
},animation=function(){
var Now=+new Date,l=0;
for(;l<animationElements.length;l++){
var e=animationElements[l];
if(e.el.removed||e.paused){
continue
}
var time=Now-e.start,ms=e.ms,easing=e.easing,from=e.from,diff=e.diff,to=e.to,t=e.t,that=e.el,set={},now,init={},key;
if(e.initstatus){
time=(e.initstatus*e.anim.top-e.prev)/(e.percent-e.prev)*ms;
e.status=e.initstatus;
delete e.initstatus;
e.stop&&animationElements.splice(l--,1)
}else{
e.status=(e.prev+(e.percent-e.prev)*(time/ms))/e.anim.top
}
if(time<0){
continue
}
if(time<ms){
var pos=easing(time/ms);
for(var attr in from)
if(from[has](attr)){
switch(availableAnimAttrs[attr]){
case nu:
now=+from[attr]+pos*ms*diff[attr];
break;
case'colour':
now='rgb('+[
upto255(round(from[attr].r+pos*ms*diff[attr].r)),
upto255(round(from[attr].g+pos*ms*diff[attr].g)),
upto255(round(from[attr].b+pos*ms*diff[attr].b))
].join(',')+')';
break;
case'path':
now=[];
for(var i=0,ii=from[attr].length;i<ii;i++){
now[i]=[from[attr][i][0]];
for(var j=1,jj=from[attr][i].length;j<jj;j++){
now[i][j]=+from[attr][i][j]+pos*ms*diff[attr][i][j]
}
now[i]=now[i].join(S)
}
now=now.join(S);
break;
case'transform':
if(diff[attr].real){
now=[];
for(i=0,ii=from[attr].length;i<ii;i++){
now[i]=[from[attr][i][0]];
for(j=1,jj=from[attr][i].length;j<jj;j++){
now[i][j]=from[attr][i][j]+pos*ms*diff[attr][i][j]
}
}
}else{
var get=function(i){
return+from[attr][i]+pos*ms*diff[attr][i]
};
now=[[
'm',
get(0),
get(1),
get(2),
get(3),
get(4),
get(5)
]]
}
break;
case'csv':
if(attr=='clip-rect'){
now=[];
i=4;
while(i--){
now[i]=+from[attr][i]+pos*ms*diff[attr][i]
}
}
break;
default:
var from2=[][concat](from[attr]);
now=[];
i=that.paper.customAttributes[attr].length;
while(i--){
now[i]=+from2[i]+pos*ms*diff[attr][i]
}
break
}
set[attr]=now
}
that.attr(set);
(function(id,that,anim){
setTimeout(function(){
eve('anim.frame.'+id,that,anim)
})
}(that.id,that,e.anim))
}else{
(function(f,el,a){
setTimeout(function(){
eve('anim.frame.'+el.id,el,a);
eve('anim.finish.'+el.id,el,a);
R.is(f,'function')&&f.call(el)
})
}(e.callback,that,e.anim));
that.attr(to);
animationElements.splice(l--,1);
if(e.repeat>1&&!e.next){
for(key in to)
if(to[has](key)){
init[key]=e.totalOrigin[key]
}
e.el.attr(init);
runAnimation(e.anim,e.el,e.anim.percents[0],null,e.totalOrigin,e.repeat-1)
}
if(e.next&&!e.stop){
runAnimation(e.anim,e.el,e.next,null,e.totalOrigin,e.repeat)
}
}
}
R.svg&&that&&that.paper&&that.paper.safari();
animationElements.length&&requestAnimFrame(animation)
},upto255=function(color){
return color>255?255:color<0?0:color
};
elproto.animateWith=function(element,anim,params,ms,easing,callback){
var a=params?R.animation(params,ms,easing,callback):anim,status=element.status(anim);
return this.animate(a).status(a,status*anim.ms/a.ms)
};
function CubicBezierAtTime(t,p1x,p1y,p2x,p2y,duration){
var cx=3*p1x,bx=3*(p2x-p1x)-cx,ax=1-cx-bx,cy=3*p1y,by=3*(p2y-p1y)-cy,ay=1-cy-by;
function sampleCurveX(t){
return((ax*t+bx)*t+cx)*t
}
function solve(x,epsilon){
var t=solveCurveX(x,epsilon);
return((ay*t+by)*t+cy)*t
}
function solveCurveX(x,epsilon){
var t0,t1,t2,x2,d2,i;
for(t2=x,i=0;i<8;i++){
x2=sampleCurveX(t2)-x;
if(abs(x2)<epsilon){
return t2
}
d2=(3*ax*t2+2*bx)*t2+cx;
if(abs(d2)<0.000001){
break
}
t2=t2-x2/d2
}
t0=0;
t1=1;
t2=x;
if(t2<t0){
return t0
}
if(t2>t1){
return t1
}
while(t0<t1){
x2=sampleCurveX(t2);
if(abs(x2-x)<epsilon){
return t2
}
if(x>x2){
t0=t2
}else{
t1=t2
}
t2=(t1-t0)/2+t0
}
return t2
}
return solve(t,1/(200*duration))
}
elproto.onAnimation=function(f){
f?eve.on('anim.frame.'+this.id,f):eve.unbind('anim.frame.'+this.id);
return this
};
function Animation(anim,ms){
var percents=[],newAnim={};
this.ms=ms;
this.times=1;
if(anim){
for(var attr in anim)
if(anim[has](attr)){
newAnim[toFloat(attr)]=anim[attr];
percents.push(toFloat(attr))
}
percents.sort(sortByNumber)
}
this.anim=newAnim;
this.top=percents[percents.length-1];
this.percents=percents
}
Animation.prototype.delay=function(delay){
var a=new Animation(this.anim,this.ms);
a.times=this.times;
a.del=+delay||0;
return a
};
Animation.prototype.repeat=function(times){
var a=new Animation(this.anim,this.ms);
a.del=this.del;
a.times=math.floor(mmax(times,0))||1;
return a
};
function runAnimation(anim,element,percent,status,totalOrigin,times){
percent=toFloat(percent);
var params,isInAnim,isInAnimSet,percents=[],next,prev,timestamp,ms=anim.ms,from={},to={},diff={};
if(status){
for(i=0,ii=animationElements.length;i<ii;i++){
var e=animationElements[i];
if(e.el.id==element.id&&e.anim==anim){
if(e.percent!=percent){
animationElements.splice(i,1);
isInAnimSet=1
}else{
isInAnim=e
}
element.attr(e.totalOrigin);
break
}
}
}else{
status=+to
}
for(var i=0,ii=anim.percents.length;i<ii;i++){
if(anim.percents[i]==percent||anim.percents[i]>status*anim.top){
percent=anim.percents[i];
prev=anim.percents[i-1]||0;
ms=ms/anim.top*(percent-prev);
next=anim.percents[i+1];
params=anim.anim[percent];
break
}else if(status){
element.attr(anim.anim[anim.percents[i]])
}
}
if(!params){
return
}
if(!isInAnim){
for(var attr in params)
if(params[has](attr)){
if(availableAnimAttrs[has](attr)||element.paper.customAttributes[has](attr)){
from[attr]=element.attr(attr);
from[attr]==null&&(from[attr]=availableAttrs[attr]);
to[attr]=params[attr];
switch(availableAnimAttrs[attr]){
case nu:
diff[attr]=(to[attr]-from[attr])/ms;
break;
case'colour':
from[attr]=R.getRGB(from[attr]);
var toColour=R.getRGB(to[attr]);
diff[attr]={
r:(toColour.r-from[attr].r)/ms,
g:(toColour.g-from[attr].g)/ms,
b:(toColour.b-from[attr].b)/ms
};
break;
case'path':
var pathes=path2curve(from[attr],to[attr]),toPath=pathes[1];
from[attr]=pathes[0];
diff[attr]=[];
for(i=0,ii=from[attr].length;i<ii;i++){
diff[attr][i]=[0];
for(var j=1,jj=from[attr][i].length;j<jj;j++){
diff[attr][i][j]=(toPath[i][j]-from[attr][i][j])/ms
}
}
break;
case'transform':
var _=element._,eq=equaliseTransform(_[attr],to[attr]);
if(eq){
from[attr]=eq.from;
to[attr]=eq.to;
diff[attr]=[];
diff[attr].real=true;
for(i=0,ii=from[attr].length;i<ii;i++){
diff[attr][i]=[from[attr][i][0]];
for(j=1,jj=from[attr][i].length;j<jj;j++){
diff[attr][i][j]=(to[attr][i][j]-from[attr][i][j])/ms
}
}
}else{
var m=element.matrix||new Matrix,to2={
_:{transform:_.transform},
getBBox:function(){
return element.getBBox(1)
}
};
from[attr]=[
m.a,
m.b,
m.c,
m.d,
m.e,
m.f
];
extractTransform(to2,to[attr]);
to[attr]=to2._.transform;
diff[attr]=[
(to2.matrix.a-m.a)/ms,
(to2.matrix.b-m.b)/ms,
(to2.matrix.c-m.c)/ms,
(to2.matrix.d-m.d)/ms,
(to2.matrix.e-m.e)/ms,
(to2.matrix.e-m.f)/ms
]
}
break;
case'csv':
var values=Str(params[attr])[split](separator),from2=Str(from[attr])[split](separator);
if(attr=='clip-rect'){
from[attr]=from2;
diff[attr]=[];
i=from2.length;
while(i--){
diff[attr][i]=(values[i]-from[attr][i])/ms
}
}
to[attr]=values;
break;
default:
values=[][concat](params[attr]);
from2=[][concat](from[attr]);
diff[attr]=[];
i=element.paper.customAttributes[attr].length;
while(i--){
diff[attr][i]=((values[i]||0)-(from2[i]||0))/ms
}
break
}
}
}
var easing=params.easing,easyeasy=R.easing_formulas[easing];
if(!easyeasy){
easyeasy=Str(easing).match(bezierrg);
if(easyeasy&&easyeasy.length==5){
var curve=easyeasy;
easyeasy=function(t){
return CubicBezierAtTime(t,+curve[1],+curve[2],+curve[3],+curve[4],ms)
}
}else{
easyeasy=pipe
}
}
timestamp=params.start||anim.start||+new Date;
e={
anim:anim,
percent:percent,
timestamp:timestamp,
start:timestamp+(anim.del||0),
status:0,
initstatus:status||0,
stop:false,
ms:ms,
easing:easyeasy,
from:from,
diff:diff,
to:to,
el:element,
callback:params.callback,
prev:prev,
next:next,
repeat:times||anim.times,
origin:element.attr(),
totalOrigin:totalOrigin
};
animationElements.push(e);
if(status&&!isInAnim&&!isInAnimSet){
e.stop=true;
e.start=new Date-ms*status;
if(animationElements.length==1){
return animation()
}
}
if(isInAnimSet){
e.start=new Date-e.ms*status
}
animationElements.length==1&&requestAnimFrame(animation)
}else{
isInAnim.initstatus=status;
isInAnim.start=new Date-isInAnim.ms*status
}
eve('anim.start.'+element.id,element,anim)
}
R.animation=function(params,ms,easing,callback){
if(params instanceof Animation){
return params
}
if(R.is(easing,'function')||!easing){
callback=callback||easing||null;
easing=null
}
params=Object(params);
ms=+ms||0;
var p={},json,attr;
for(attr in params)
if(params[has](attr)&&toFloat(attr)!=attr&&toFloat(attr)+'%'!=attr){
json=true;
p[attr]=params[attr]
}
if(!json){
return new Animation(params,ms)
}else{
easing&&(p.easing=easing);
callback&&(p.callback=callback);
return new Animation({100:p},ms)
}
};
elproto.animate=function(params,ms,easing,callback){
var element=this;
if(element.removed){
callback&&callback.call(element);
return element
}
var anim=params instanceof Animation?params:R.animation(params,ms,easing,callback);
runAnimation(anim,element,anim.percents[0],null,element.attr());
return element
};
elproto.setTime=function(anim,value){
if(anim&&value!=null){
this.status(anim,mmin(value,anim.ms)/anim.ms)
}
return this
};
elproto.status=function(anim,value){
var out=[],i=0,len,e;
if(value!=null){
runAnimation(anim,this,-1,mmin(value,1));
return this
}else{
len=animationElements.length;
for(;i<len;i++){
e=animationElements[i];
if(e.el.id==this.id&&(!anim||e.anim==anim)){
if(anim){
return e.status
}
out.push({
anim:e.anim,
status:e.status
})
}
}
if(anim){
return 0
}
return out
}
};
elproto.pause=function(anim){
for(var i=0;i<animationElements.length;i++)
if(animationElements[i].el.id==this.id&&(!anim||animationElements[i].anim==anim)){
if(eve('anim.pause.'+this.id,this,animationElements[i].anim)!==false){
animationElements[i].paused=true
}
}
return this
};
elproto.resume=function(anim){
for(var i=0;i<animationElements.length;i++)
if(animationElements[i].el.id==this.id&&(!anim||animationElements[i].anim==anim)){
var e=animationElements[i];
if(eve('anim.resume.'+this.id,this,e.anim)!==false){
delete e.paused;
this.status(e.anim,e.status)
}
}
return this
};
elproto.stop=function(anim){
for(var i=0;i<animationElements.length;i++)
if(animationElements[i].el.id==this.id&&(!anim||animationElements[i].anim==anim)){
if(eve('anim.stop.'+this.id,this,animationElements[i].anim)!==false){
animationElements.splice(i--,1)
}
}
return this
};
elproto.toString=function(){
return'Raphals object'
};
var Set=function(items){
this.items=[];
this.length=0;
this.type='set';
if(items){
for(var i=0,ii=items.length;i<ii;i++){
if(items[i]&&(items[i].constructor==elproto.constructor||items[i].constructor==Set)){
this[this.items.length]=this.items[this.items.length]=items[i];
this.length++
}
}
}
},setproto=Set.prototype;
setproto.push=function(){
var item,len;
for(var i=0,ii=arguments.length;i<ii;i++){
item=arguments[i];
if(item&&(item.constructor==elproto.constructor||item.constructor==Set)){
len=this.items.length;
this[len]=this.items[len]=item;
this.length++
}
}
return this
};
setproto.pop=function(){
this.length&&delete this[this.length--];
return this.items.pop()
};
setproto.forEach=function(callback,thisArg){
for(var i=0,ii=this.items.length;i<ii;i++){
if(callback.call(thisArg,this.items[i],i)===false){
return this
}
}
return this
};
for(var method in elproto)
if(elproto[has](method)){
setproto[method]=function(methodname){
return function(){
var arg=arguments;
return this.forEach(function(el){
el[methodname][apply](el,arg)
})
}
}(method)
}
setproto.attr=function(name,value){
if(name&&R.is(name,array)&&R.is(name[0],'object')){
for(var j=0,jj=name.length;j<jj;j++){
this.items[j].attr(name[j])
}
}else{
for(var i=0,ii=this.items.length;i<ii;i++){
this.items[i].attr(name,value)
}
}
return this
};
setproto.clear=function(){
while(this.length){
this.pop()
}
};
setproto.splice=function(index,count,insertion){
index=index<0?mmax(this.length+index,0):index;
count=mmax(0,mmin(this.length-index,count));
var tail=[],todel=[],args=[],i;
for(i=2;i<arguments.length;i++){
args.push(arguments[i])
}
for(i=0;i<count;i++){
todel.push(this[index+i])
}
for(;i<this.length-index;i++){
tail.push(this[index+i])
}
var arglen=args.length;
for(i=0;i<arglen+tail.length;i++){
this.items[index+i]=this[index+i]=i<arglen?args[i]:tail[i-arglen]
}
i=this.items.length=this.length-=count-arglen;
while(this[i]){
delete this[i++]
}
return new Set(todel)
};
setproto.exclude=function(el){
for(var i=0,ii=this.length;i<ii;i++)
if(this[i]==el){
this.splice(i,1);
return true
}
};
setproto.animate=function(params,ms,easing,callback){
(R.is(easing,'function')||!easing)&&(callback=easing||null);
var len=this.items.length,i=len,item,set=this,collector;
if(!len){
return this
}
callback&&(collector=function(){
!--len&&callback.call(set)
});
easing=R.is(easing,string)?easing:collector;
var anim=R.animation(params,ms,easing,collector);
item=this.items[--i].animate(anim);
while(i--){
this.items[i]&&!this.items[i].removed&&this.items[i].animateWith(item,anim)
}
return this
};
setproto.insertAfter=function(el){
var i=this.items.length;
while(i--){
this.items[i].insertAfter(el)
}
return this
};
setproto.getBBox=function(){
var x=[],y=[],w=[],h=[];
for(var i=this.items.length;i--;)
if(!this.items[i].removed){
var box=this.items[i].getBBox();
x.push(box.x);
y.push(box.y);
w.push(box.x+box.width);
h.push(box.y+box.height)
}
x=mmin[apply](0,x);
y=mmin[apply](0,y);
return{
x:x,
y:y,
width:mmax[apply](0,w)-x,
height:mmax[apply](0,h)-y
}
};
setproto.clone=function(s){
s=new Set;
for(var i=0,ii=this.items.length;i<ii;i++){
s.push(this.items[i].clone())
}
return s
};
setproto.toString=function(){
return'Raphals set'
};
R.registerFont=function(font){
if(!font.face){
return font
}
this.fonts=this.fonts||{};
var fontcopy={
w:font.w,
face:{},
glyphs:{}
},family=font.face['font-family'];
for(var prop in font.face)
if(font.face[has](prop)){
fontcopy.face[prop]=font.face[prop]
}
if(this.fonts[family]){
this.fonts[family].push(fontcopy)
}else{
this.fonts[family]=[fontcopy]
}
if(!font.svg){
fontcopy.face['units-per-em']=toInt(font.face['units-per-em'],10);
for(var glyph in font.glyphs)
if(font.glyphs[has](glyph)){
var path=font.glyphs[glyph];
fontcopy.glyphs[glyph]={
w:path.w,
k:{},
d:path.d&&'M'+path.d.replace(/[mlcxtrv]/g,function(command){
return{
l:'L',
c:'C',
x:'z',
t:'m',
r:'l',
v:'c'
}[command]||'M'
})+'z'
};
if(path.k){
for(var k in path.k)
if(path[has](k)){
fontcopy.glyphs[glyph].k[k]=path.k[k]
}
}
}
}
return font
};
paperproto.getFont=function(family,weight,style,stretch){
stretch=stretch||'normal';
style=style||'normal';
weight=+weight||{
normal:400,
bold:700,
lighter:300,
bolder:800
}[weight]||400;
if(!R.fonts){
return
}
var font=R.fonts[family];
if(!font){
var name=new RegExp('(^|\\s)'+family.replace(/[^\w\d\s+!~.:_-]/g,E)+'(\\s|$)','i');
for(var fontName in R.fonts)
if(R.fonts[has](fontName)){
if(name.test(fontName)){
font=R.fonts[fontName];
break
}
}
}
var thefont;
if(font){
for(var i=0,ii=font.length;i<ii;i++){
thefont=font[i];
if(thefont.face['font-weight']==weight&&(thefont.face['font-style']==style||!thefont.face['font-style'])&&thefont.face['font-stretch']==stretch){
break
}
}
}
return thefont
};
paperproto.print=function(x,y,string,font,size,origin,letter_spacing){
origin=origin||'middle';
letter_spacing=mmax(mmin(letter_spacing||0,1),-1);
var out=this.set(),letters=Str(string)[split](E),shift=0,path=E,scale;
R.is(font,string)&&(font=this.getFont(font));
if(font){
scale=(size||16)/font.face['units-per-em'];
var bb=font.face.bbox[split](separator),top=+bb[0],height=+bb[1]+(origin=='baseline'?bb[3]-bb[1]+ +font.face.descent:(bb[3]-bb[1])/2);
for(var i=0,ii=letters.length;i<ii;i++){
var prev=i&&font.glyphs[letters[i-1]]||{},curr=font.glyphs[letters[i]];
shift+=i?(prev.w||font.w)+(prev.k&&prev.k[letters[i]]||0)+font.w*letter_spacing:0;
curr&&curr.d&&out.push(this.path(curr.d).attr({
fill:'#000',
stroke:'none',
transform:[[
't',
shift*scale,
0
]]
}))
}
out.transform([
'...s',
scale,
scale,
top,
height,
't',
(x-top)/scale,
(y-height)/scale
])
}
return out
};
paperproto.add=function(json){
if(R.is(json,'array')){
var res=this.set(),i=0,ii=json.length,j;
for(;i<ii;i++){
j=json[i]||{};
elements[has](j.type)&&res.push(this[j.type]().attr(j))
}
}
return res
};
R.format=function(token,params){
var args=R.is(params,array)?[0][concat](params):arguments;
token&&R.is(token,string)&&args.length-1&&(token=token.replace(formatrg,function(str,i){
return args[++i]==null?E:args[i]
}));
return token||E
};
R.fullfill=function(){
var tokenRegex=/\{([^\}]+)\}/g,objNotationRegex=/(?:(?:^|\.)(.+?)(?=\[|\.|$|\()|\[('|")(.+?)\2\])(\(\))?/g,replacer=function(all,key,obj){
var res=obj;
key.replace(objNotationRegex,function(all,name,quote,quotedName,isFunc){
name=name||quotedName;
if(res){
if(name in res){
res=res[name]
}
typeof res=='function'&&isFunc&&(res=res())
}
});
res=(res==null||res==obj?all:res)+'';
return res
};
return function(str,obj){
return String(str).replace(tokenRegex,function(all,key){
return replacer(all,key,obj)
})
}
}();
R.ninja=function(){
oldRaphael.was?g.win.Raphael=oldRaphael.is:delete Raphael;
return R
};
R.st=setproto;
(function(doc,loaded,f){
if(doc.readyState==null&&doc.addEventListener){
doc.addEventListener(loaded,f=function(){
doc.removeEventListener(loaded,f,false);
doc.readyState='complete'
},false);
doc.readyState='loading'
}
function isLoaded(){
/in/.test(doc.readyState)?setTimeout(isLoaded,9):R.eve('DOMload')
}
isLoaded()
}(document,'DOMContentLoaded'));
oldRaphael.was?g.win.Raphael=R:Raphael=R;
eve.on('DOMload',function(){
loaded=true
})
}());
window.Raphael.svg&&function(R){
var has='hasOwnProperty',Str=String,toFloat=parseFloat,toInt=parseInt,math=Math,mmax=math.max,abs=math.abs,pow=math.pow,separator=/[, ]+/,eve=R.eve,E='',S=' ';
var xlink='http://www.w3.org/1999/xlink',markers={
block:'M5,0 0,2.5 5,5z',
classic:'M5,0 0,2.5 5,5 3.5,3 3.5,2z',
diamond:'M2.5,0 5,2.5 2.5,5 0,2.5z',
open:'M6,1 1,3.5 6,6',
oval:'M2.5,0A2.5,2.5,0,0,1,2.5,5 2.5,2.5,0,0,1,2.5,0z'
},markerCounter={};
R.toString=function(){
return'Your browser supports SVG.\nYou are running Raphal '+this.version
};
var $=function(el,attr){
if(attr){
if(typeof el=='string'){
el=$(el)
}
for(var key in attr)
if(attr[has](key)){
if(key.substring(0,6)=='xlink:'){
el.setAttributeNS(xlink,key.substring(6),Str(attr[key]))
}else{
el.setAttribute(key,Str(attr[key]))
}
}
}else{
el=R._g.doc.createElementNS('http://www.w3.org/2000/svg',el);
el.style&&(el.style.webkitTapHighlightColor='rgba(0,0,0,0)')
}
return el
},addGradientFill=function(element,gradient){
var type='linear',id=element.id+gradient,fx=0.5,fy=0.5,o=element.node,SVG=element.paper,s=o.style,el=R._g.doc.getElementById(id);
if(!el){
gradient=Str(gradient).replace(R._radial_gradient,function(all,_fx,_fy){
type='radial';
if(_fx&&_fy){
fx=toFloat(_fx);
fy=toFloat(_fy);
var dir=(fy>0.5)*2-1;
pow(fx-0.5,2)+pow(fy-0.5,2)>0.25&&(fy=math.sqrt(0.25-pow(fx-0.5,2))*dir+0.5)&&fy!=0.5&&(fy=fy.toFixed(5)-0.00001*dir)
}
return E
});
gradient=gradient.split(/\s*\-\s*/);
if(type=='linear'){
var angle=gradient.shift();
angle=-toFloat(angle);
if(isNaN(angle)){
return null
}
var vector=[
0,
0,
math.cos(R.rad(angle)),
math.sin(R.rad(angle))
],max=1/(mmax(abs(vector[2]),abs(vector[3]))||1);
vector[2]*=max;
vector[3]*=max;
if(vector[2]<0){
vector[0]=-vector[2];
vector[2]=0
}
if(vector[3]<0){
vector[1]=-vector[3];
vector[3]=0
}
}
var dots=R._parseDots(gradient);
if(!dots){
return null
}
id=id.replace(/[\(\)\s,\xb0#]/g,'_');
if(element.gradient&&id!=element.gradient.id){
SVG.defs.removeChild(element.gradient);
delete element.gradient
}
if(!element.gradient){
el=$(type+'Gradient',{id:id});
element.gradient=el;
$(el,type=='radial'?{
fx:fx,
fy:fy
}:{
x1:vector[0],
y1:vector[1],
x2:vector[2],
y2:vector[3],
gradientTransform:element.matrix.invert()
});
SVG.defs.appendChild(el);
for(var i=0,ii=dots.length;i<ii;i++){
el.appendChild($('stop',{
offset:dots[i].offset?dots[i].offset:i?'100%':'0%',
'stop-color':dots[i].color||'#fff'
}))
}
}
}
$(o,{
fill:'url(#'+id+')',
opacity:1,
'fill-opacity':1
});
s.fill=E;
s.opacity=1;
s.fillOpacity=1;
return 1
},updatePosition=function(o){
var bbox=o.getBBox(1);
$(o.pattern,{patternTransform:o.matrix.invert()+' translate('+bbox.x+','+bbox.y+')'})
},addArrow=function(o,value,isEnd){
if(o.type=='path'){
var values=Str(value).toLowerCase().split('-'),p=o.paper,se=isEnd?'end':'start',node=o.node,attrs=o.attrs,stroke=attrs['stroke-width'],i=values.length,type='classic',from,to,dx,refX,attr,w=3,h=3,t=5;
while(i--){
switch(values[i]){
case'block':
case'classic':
case'oval':
case'diamond':
case'open':
case'none':
type=values[i];
break;
case'wide':
h=5;
break;
case'narrow':
h=2;
break;
case'long':
w=5;
break;
case'short':
w=2;
break
}
}
if(type=='open'){
w+=2;
h+=2;
t+=2;
dx=1;
refX=isEnd?4:1;
attr={
fill:'none',
stroke:attrs.stroke
}
}else{
refX=dx=w/2;
attr={
fill:attrs.stroke,
stroke:'none'
}
}
if(o._.arrows){
if(isEnd){
o._.arrows.endPath&&markerCounter[o._.arrows.endPath]--;
o._.arrows.endMarker&&markerCounter[o._.arrows.endMarker]--
}else{
o._.arrows.startPath&&markerCounter[o._.arrows.startPath]--;
o._.arrows.startMarker&&markerCounter[o._.arrows.startMarker]--
}
}else{
o._.arrows={}
}
if(type!='none'){
var pathId='raphael-marker-'+type,markerId='raphael-marker-'+se+type+w+h;
if(!R._g.doc.getElementById(pathId)){
p.defs.appendChild($($('path'),{
'stroke-linecap':'round',
d:markers[type],
id:pathId
}));
markerCounter[pathId]=1
}else{
markerCounter[pathId]++
}
var marker=R._g.doc.getElementById(markerId),use;
if(!marker){
marker=$($('marker'),{
id:markerId,
markerHeight:h,
markerWidth:w,
orient:'auto',
refX:refX,
refY:h/2
});
use=$($('use'),{
'xlink:href':'#'+pathId,
transform:(isEnd?' rotate(180 '+w/2+' '+h/2+') ':S)+'scale('+w/t+','+h/t+')',
'stroke-width':1/((w/t+h/t)/2)
});
marker.appendChild(use);
p.defs.appendChild(marker);
markerCounter[markerId]=1
}else{
markerCounter[markerId]++;
use=marker.getElementsByTagName('use')[0]
}
$(use,attr);
var delta=dx*(type!='diamond'&&type!='oval');
if(isEnd){
from=o._.arrows.startdx*stroke||0;
to=R.getTotalLength(attrs.path)-delta*stroke
}else{
from=delta*stroke;
to=R.getTotalLength(attrs.path)-(o._.arrows.enddx*stroke||0)
}
attr={};
attr['marker-'+se]='url(#'+markerId+')';
if(to||from){
attr.d=Raphael.getSubpath(attrs.path,from,to)
}
$(node,attr);
o._.arrows[se+'Path']=pathId;
o._.arrows[se+'Marker']=markerId;
o._.arrows[se+'dx']=delta;
o._.arrows[se+'Type']=type;
o._.arrows[se+'String']=value
}else{
if(isEnd){
from=o._.arrows.startdx*stroke||0;
to=R.getTotalLength(attrs.path)-from
}else{
from=0;
to=R.getTotalLength(attrs.path)-(o._.arrows.enddx*stroke||0)
}
o._.arrows[se+'Path']&&$(node,{d:Raphael.getSubpath(attrs.path,from,to)});
delete o._.arrows[se+'Path'];
delete o._.arrows[se+'Marker'];
delete o._.arrows[se+'dx'];
delete o._.arrows[se+'Type'];
delete o._.arrows[se+'String']
}
for(attr in markerCounter)
if(markerCounter[has](attr)&&!markerCounter[attr]){
var item=R._g.doc.getElementById(attr);
item&&item.parentNode.removeChild(item)
}
}
},dasharray={
'':[0],
'none':[0],
'-':[
3,
1
],
'.':[
1,
1
],
'-.':[
3,
1,
1,
1
],
'-..':[
3,
1,
1,
1,
1,
1
],
'. ':[
1,
3
],
'- ':[
4,
3
],
'--':[
8,
3
],
'- .':[
4,
3,
1,
3
],
'--.':[
8,
3,
1,
3
],
'--..':[
8,
3,
1,
3,
1,
3
]
},addDashes=function(o,value,params){
value=dasharray[Str(value).toLowerCase()];
if(value){
var width=o.attrs['stroke-width']||'1',butt={
round:width,
square:width,
butt:0
}[o.attrs['stroke-linecap']||params['stroke-linecap']]||0,dashes=[],i=value.length;
while(i--){
dashes[i]=value[i]*width+(i%2?1:-1)*butt
}
$(o.node,{'stroke-dasharray':dashes.join(',')})
}
},setFillAndStroke=function(o,params){
var node=o.node,attrs=o.attrs,vis=node.style.visibility;
node.style.visibility='hidden';
for(var att in params){
if(params[has](att)){
if(!R._availableAttrs[has](att)){
continue
}
var value=params[att];
attrs[att]=value;
switch(att){
case'blur':
o.blur(value);
break;
case'href':
case'title':
case'target':
var pn=node.parentNode;
if(pn.tagName.toLowerCase()!='a'){
var hl=$('a');
pn.insertBefore(hl,node);
hl.appendChild(node);
pn=hl
}
if(att=='target'&&value=='blank'){
pn.setAttributeNS(xlink,'show','new')
}else{
pn.setAttributeNS(xlink,att,value)
}
break;
case'cursor':
node.style.cursor=value;
break;
case'transform':
o.transform(value);
break;
case'arrow-start':
addArrow(o,value);
break;
case'arrow-end':
addArrow(o,value,1);
break;
case'clip-rect':
var rect=Str(value).split(separator);
if(rect.length==4){
o.clip&&o.clip.parentNode.parentNode.removeChild(o.clip.parentNode);
var el=$('clipPath'),rc=$('rect');
el.id=R.createUUID();
$(rc,{
x:rect[0],
y:rect[1],
width:rect[2],
height:rect[3]
});
el.appendChild(rc);
o.paper.defs.appendChild(el);
$(node,{'clip-path':'url(#'+el.id+')'});
o.clip=rc
}
if(!value){
var path=node.getAttribute('clip-path');
if(path){
var clip=R._g.doc.getElementById(path.replace(/(^url\(#|\)$)/g,E));
clip&&clip.parentNode.removeChild(clip);
$(node,{'clip-path':E});
delete o.clip
}
}
break;
case'path':
if(o.type=='path'){
$(node,{d:value?attrs.path=R._pathToAbsolute(value):'M0,0'});
o._.dirty=1;
if(o._.arrows){
'startString'in o._.arrows&&addArrow(o,o._.arrows.startString);
'endString'in o._.arrows&&addArrow(o,o._.arrows.endString,1)
}
}
break;
case'width':
node.setAttribute(att,value);
o._.dirty=1;
if(attrs.fx){
att='x';
value=attrs.x
}else{
break
}
case'x':
if(attrs.fx){
value=-attrs.x-(attrs.width||0)
}
case'rx':
if(att=='rx'&&o.type=='rect'){
break
}
case'cx':
node.setAttribute(att,value);
o.pattern&&updatePosition(o);
o._.dirty=1;
break;
case'height':
node.setAttribute(att,value);
o._.dirty=1;
if(attrs.fy){
att='y';
value=attrs.y
}else{
break
}
case'y':
if(attrs.fy){
value=-attrs.y-(attrs.height||0)
}
case'ry':
if(att=='ry'&&o.type=='rect'){
break
}
case'cy':
node.setAttribute(att,value);
o.pattern&&updatePosition(o);
o._.dirty=1;
break;
case'r':
if(o.type=='rect'){
$(node,{
rx:value,
ry:value
})
}else{
node.setAttribute(att,value)
}
o._.dirty=1;
break;
case'src':
if(o.type=='image'){
node.setAttributeNS(xlink,'href',value)
}
break;
case'stroke-width':
if(o._.sx!=1||o._.sy!=1){
value/=mmax(abs(o._.sx),abs(o._.sy))||1
}
if(o.paper._vbSize){
value*=o.paper._vbSize
}
node.setAttribute(att,value);
if(attrs['stroke-dasharray']){
addDashes(o,attrs['stroke-dasharray'],params)
}
if(o._.arrows){
'startString'in o._.arrows&&addArrow(o,o._.arrows.startString);
'endString'in o._.arrows&&addArrow(o,o._.arrows.endString,1)
}
break;
case'stroke-dasharray':
addDashes(o,value,params);
break;
case'fill':
var isURL=Str(value).match(R._ISURL);
if(isURL){
el=$('pattern');
var ig=$('image');
el.id=R.createUUID();
$(el,{
x:0,
y:0,
patternUnits:'userSpaceOnUse',
height:1,
width:1
});
$(ig,{
x:0,
y:0,
'xlink:href':isURL[1]
});
el.appendChild(ig);
(function(el){
R._preload(isURL[1],function(){
var w=this.offsetWidth,h=this.offsetHeight;
$(el,{
width:w,
height:h
});
$(ig,{
width:w,
height:h
});
o.paper.safari()
})
}(el));
o.paper.defs.appendChild(el);
node.style.fill='url(#'+el.id+')';
$(node,{fill:'url(#'+el.id+')'});
o.pattern=el;
o.pattern&&updatePosition(o);
break
}
var clr=R.getRGB(value);
if(!clr.error){
delete params.gradient;
delete attrs.gradient;
!R.is(attrs.opacity,'undefined')&&R.is(params.opacity,'undefined')&&$(node,{opacity:attrs.opacity});
!R.is(attrs['fill-opacity'],'undefined')&&R.is(params['fill-opacity'],'undefined')&&$(node,{'fill-opacity':attrs['fill-opacity']})
}else if((o.type=='circle'||o.type=='ellipse'||Str(value).charAt()!='r')&&addGradientFill(o,value)){
if('opacity'in attrs||'fill-opacity'in attrs){
var gradient=R._g.doc.getElementById(node.getAttribute('fill').replace(/^url\(#|\)$/g,E));
if(gradient){
var stops=gradient.getElementsByTagName('stop');
$(stops[stops.length-1],{'stop-opacity':('opacity'in attrs?attrs.opacity:1)*('fill-opacity'in attrs?attrs['fill-opacity']:1)})
}
}
attrs.gradient=value;
attrs.fill='none';
break
}
clr[has]('opacity')&&$(node,{'fill-opacity':clr.opacity>1?clr.opacity/100:clr.opacity});
case'stroke':
clr=R.getRGB(value);
node.setAttribute(att,clr.hex);
att=='stroke'&&clr[has]('opacity')&&$(node,{'stroke-opacity':clr.opacity>1?clr.opacity/100:clr.opacity});
if(att=='stroke'&&o._.arrows){
'startString'in o._.arrows&&addArrow(o,o._.arrows.startString);
'endString'in o._.arrows&&addArrow(o,o._.arrows.endString,1)
}
break;
case'gradient':
(o.type=='circle'||o.type=='ellipse'||Str(value).charAt()!='r')&&addGradientFill(o,value);
break;
case'opacity':
if(attrs.gradient&&!attrs[has]('stroke-opacity')){
$(node,{'stroke-opacity':value>1?value/100:value})
}
case'fill-opacity':
if(attrs.gradient){
gradient=R._g.doc.getElementById(node.getAttribute('fill').replace(/^url\(#|\)$/g,E));
if(gradient){
stops=gradient.getElementsByTagName('stop');
$(stops[stops.length-1],{'stop-opacity':value})
}
break
}
default:
att=='font-size'&&(value=toInt(value,10)+'px');
var cssrule=att.replace(/(\-.)/g,function(w){
return w.substring(1).toUpperCase()
});
node.style[cssrule]=value;
o._.dirty=1;
node.setAttribute(att,value);
break
}
}
}
tuneText(o,params);
node.style.visibility=vis
},leading=1.2,tuneText=function(el,params){
if(el.type!='text'||!(params[has]('text')||params[has]('font')||params[has]('font-size')||params[has]('x')||params[has]('y'))){
return
}
var a=el.attrs,node=el.node,fontSize=node.firstChild?toInt(R._g.doc.defaultView.getComputedStyle(node.firstChild,E).getPropertyValue('font-size'),10):10;
if(params[has]('text')){
a.text=params.text;
while(node.firstChild){
node.removeChild(node.firstChild)
}
var texts=Str(params.text).split('\n'),tspans=[],tspan;
for(var i=0,ii=texts.length;i<ii;i++){
tspan=$('tspan');
i&&$(tspan,{
dy:fontSize*leading,
x:a.x
});
tspan.appendChild(R._g.doc.createTextNode(texts[i]));
node.appendChild(tspan);
tspans[i]=tspan
}
}else{
tspans=node.getElementsByTagName('tspan');
for(i=0,ii=tspans.length;i<ii;i++)
if(i){
$(tspans[i],{
dy:fontSize*leading,
x:a.x
})
}else{
$(tspans[0],{dy:0})
}
}
$(node,{
x:a.x,
y:a.y
});
el._.dirty=1;
var bb=el._getBBox(),dif=a.y-(bb.y+bb.height/2);
dif&&R.is(dif,'finite')&&$(tspans[0],{dy:dif})
},Element=function(node,svg){
var X=0,Y=0;
this[0]=this.node=node;
node.raphael=true;
this.id=R._oid++;
node.raphaelid=this.id;
this.matrix=R.matrix();
this.realPath=null;
this.paper=svg;
this.attrs=this.attrs||{};
this._={
transform:[],
sx:1,
sy:1,
deg:0,
dx:0,
dy:0,
dirty:1
};
!svg.bottom&&(svg.bottom=this);
this.prev=svg.top;
svg.top&&(svg.top.next=this);
svg.top=this;
this.next=null
},elproto=R.el;
Element.prototype=elproto;
elproto.constructor=Element;
R._engine.path=function(pathString,SVG){
var el=$('path');
SVG.canvas&&SVG.canvas.appendChild(el);
var p=new Element(el,SVG);
p.type='path';
setFillAndStroke(p,{
fill:'none',
stroke:'#000',
path:pathString
});
return p
};
elproto.rotate=function(deg,cx,cy){
if(this.removed){
return this
}
deg=Str(deg).split(separator);
if(deg.length-1){
cx=toFloat(deg[1]);
cy=toFloat(deg[2])
}
deg=toFloat(deg[0]);
cy==null&&(cx=cy);
if(cx==null||cy==null){
var bbox=this.getBBox(1);
cx=bbox.x+bbox.width/2;
cy=bbox.y+bbox.height/2
}
this.transform(this._.transform.concat([[
'r',
deg,
cx,
cy
]]));
return this
};
elproto.scale=function(sx,sy,cx,cy){
if(this.removed){
return this
}
sx=Str(sx).split(separator);
if(sx.length-1){
sy=toFloat(sx[1]);
cx=toFloat(sx[2]);
cy=toFloat(sx[3])
}
sx=toFloat(sx[0]);
sy==null&&(sy=sx);
cy==null&&(cx=cy);
if(cx==null||cy==null){
var bbox=this.getBBox(1)
}
cx=cx==null?bbox.x+bbox.width/2:cx;
cy=cy==null?bbox.y+bbox.height/2:cy;
this.transform(this._.transform.concat([[
's',
sx,
sy,
cx,
cy
]]));
return this
};
elproto.translate=function(dx,dy){
if(this.removed){
return this
}
dx=Str(dx).split(separator);
if(dx.length-1){
dy=toFloat(dx[1])
}
dx=toFloat(dx[0])||0;
dy=+dy||0;
this.transform(this._.transform.concat([[
't',
dx,
dy
]]));
return this
};
elproto.transform=function(tstr){
var _=this._;
if(tstr==null){
return _.transform
}
R._extractTransform(this,tstr);
this.clip&&$(this.clip,{transform:this.matrix.invert()});
this.pattern&&updatePosition(this);
this.node&&$(this.node,{transform:this.matrix});
if(_.sx!=1||_.sy!=1){
var sw=this.attrs[has]('stroke-width')?this.attrs['stroke-width']:1;
this.attr({'stroke-width':sw})
}
return this
};
elproto.hide=function(){
!this.removed&&this.paper.safari(this.node.style.display='none');
return this
};
elproto.show=function(){
!this.removed&&this.paper.safari(this.node.style.display='');
return this
};
elproto.remove=function(){
if(this.removed){
return
}
var paper=this.paper;
paper.__set__&&paper.__set__.exclude(this);
eve.unbind('*.*.'+this.id);
if(this.gradient){
paper.defs.removeChild(this.gradient)
}
R._tear(this,paper);
this.node.parentNode.removeChild(this.node);
for(var i in this){
this[i]=typeof this[i]=='function'?R._removedFactory(i):null
}
this.removed=true
};
elproto._getBBox=function(){
if(this.node.style.display=='none'){
this.show();
var hide=true
}
var bbox={};
try{
bbox=this.node.getBBox()
}catch(e){
}finally{
bbox=bbox||{}
}
hide&&this.hide();
return bbox
};
elproto.attr=function(name,value){
if(this.removed){
return this
}
if(name==null){
var res={};
for(var a in this.attrs)
if(this.attrs[has](a)){
res[a]=this.attrs[a]
}
res.gradient&&res.fill=='none'&&(res.fill=res.gradient)&&delete res.gradient;
res.transform=this._.transform;
return res
}
if(value==null&&R.is(name,'string')){
if(name=='fill'&&this.attrs.fill=='none'&&this.attrs.gradient){
return this.attrs.gradient
}
if(name=='transform'){
return this._.transform
}
var names=name.split(separator),out={};
for(var i=0,ii=names.length;i<ii;i++){
name=names[i];
if(name in this.attrs){
out[name]=this.attrs[name]
}else if(R.is(this.paper.customAttributes[name],'function')){
out[name]=this.paper.customAttributes[name].def
}else{
out[name]=R._availableAttrs[name]
}
}
return ii-1?out:out[names[0]]
}
if(value==null&&R.is(name,'array')){
out={};
for(i=0,ii=name.length;i<ii;i++){
out[name[i]]=this.attr(name[i])
}
return out
}
if(value!=null){
var params={};
params[name]=value
}else if(name!=null&&R.is(name,'object')){
params=name
}
for(var key in params){
eve('attr.'+key+'.'+this.id,this,params[key])
}
for(key in this.paper.customAttributes)
if(this.paper.customAttributes[has](key)&&params[has](key)&&R.is(this.paper.customAttributes[key],'function')){
var par=this.paper.customAttributes[key].apply(this,[].concat(params[key]));
this.attrs[key]=params[key];
for(var subkey in par)
if(par[has](subkey)){
params[subkey]=par[subkey]
}
}
setFillAndStroke(this,params);
return this
};
elproto.toFront=function(){
if(this.removed){
return this
}
if(this.node.parentNode.tagName.toLowerCase()=='a'){
this.node.parentNode.parentNode.appendChild(this.node.parentNode)
}else{
this.node.parentNode.appendChild(this.node)
}
var svg=this.paper;
svg.top!=this&&R._tofront(this,svg);
return this
};
elproto.toBack=function(){
if(this.removed){
return this
}
var parent=this.node.parentNode;
if(parent.tagName.toLowerCase()=='a'){
parent.parentNode.insertBefore(this.node.parentNode,this.node.parentNode.parentNode.firstChild)
}else if(parent.firstChild!=this.node){
parent.insertBefore(this.node,this.node.parentNode.firstChild)
}
R._toback(this,this.paper);
var svg=this.paper;
return this
};
elproto.insertAfter=function(element){
if(this.removed){
return this
}
var node=element.node||element[element.length-1].node;
if(node.nextSibling){
node.parentNode.insertBefore(this.node,node.nextSibling)
}else{
node.parentNode.appendChild(this.node)
}
R._insertafter(this,element,this.paper);
return this
};
elproto.insertBefore=function(element){
if(this.removed){
return this
}
var node=element.node||element[0].node;
node.parentNode.insertBefore(this.node,node);
R._insertbefore(this,element,this.paper);
return this
};
elproto.blur=function(size){
var t=this;
if(+size!==0){
var fltr=$('filter'),blur=$('feGaussianBlur');
t.attrs.blur=size;
fltr.id=R.createUUID();
$(blur,{stdDeviation:+size||1.5});
fltr.appendChild(blur);
t.paper.defs.appendChild(fltr);
t._blur=fltr;
$(t.node,{filter:'url(#'+fltr.id+')'})
}else{
if(t._blur){
t._blur.parentNode.removeChild(t._blur);
delete t._blur;
delete t.attrs.blur
}
t.node.removeAttribute('filter')
}
};
R._engine.circle=function(svg,x,y,r){
var el=$('circle');
svg.canvas&&svg.canvas.appendChild(el);
var res=new Element(el,svg);
res.attrs={
cx:x,
cy:y,
r:r,
fill:'none',
stroke:'#000'
};
res.type='circle';
$(el,res.attrs);
return res
};
R._engine.rect=function(svg,x,y,w,h,r){
var el=$('rect');
svg.canvas&&svg.canvas.appendChild(el);
var res=new Element(el,svg);
res.attrs={
x:x,
y:y,
width:w,
height:h,
r:r||0,
rx:r||0,
ry:r||0,
fill:'none',
stroke:'#000'
};
res.type='rect';
$(el,res.attrs);
return res
};
R._engine.ellipse=function(svg,x,y,rx,ry){
var el=$('ellipse');
svg.canvas&&svg.canvas.appendChild(el);
var res=new Element(el,svg);
res.attrs={
cx:x,
cy:y,
rx:rx,
ry:ry,
fill:'none',
stroke:'#000'
};
res.type='ellipse';
$(el,res.attrs);
return res
};
R._engine.image=function(svg,src,x,y,w,h){
var el=$('image');
$(el,{
x:x,
y:y,
width:w,
height:h,
preserveAspectRatio:'none'
});
el.setAttributeNS(xlink,'href',src);
svg.canvas&&svg.canvas.appendChild(el);
var res=new Element(el,svg);
res.attrs={
x:x,
y:y,
width:w,
height:h,
src:src
};
res.type='image';
return res
};
R._engine.text=function(svg,x,y,text){
var el=$('text');
svg.canvas&&svg.canvas.appendChild(el);
var res=new Element(el,svg);
res.attrs={
x:x,
y:y,
'text-anchor':'middle',
text:text,
font:R._availableAttrs.font,
stroke:'none',
fill:'#000'
};
res.type='text';
setFillAndStroke(res,res.attrs);
return res
};
R._engine.setSize=function(width,height){
this.width=width||this.width;
this.height=height||this.height;
this.canvas.setAttribute('width',this.width);
this.canvas.setAttribute('height',this.height);
if(this._viewBox){
this.setViewBox.apply(this,this._viewBox)
}
return this
};
R._engine.create=function(){
var con=R._getContainer.apply(0,arguments),container=con&&con.container,x=con.x,y=con.y,width=con.width,height=con.height;
if(!container){
throw new Error('SVG container not found.')
}
var cnvs=$('svg'),css='overflow:hidden;',isFloating;
x=x||0;
y=y||0;
width=width||512;
height=height||342;
$(cnvs,{
height:height,
version:1.1,
width:width,
xmlns:'http://www.w3.org/2000/svg'
});
if(container==1){
cnvs.style.cssText=css+'position:absolute;left:'+x+'px;top:'+y+'px';
R._g.doc.body.appendChild(cnvs);
isFloating=1
}else{
cnvs.style.cssText=css+'position:relative';
if(container.firstChild){
container.insertBefore(cnvs,container.firstChild)
}else{
container.appendChild(cnvs)
}
}
container=new R._Paper;
container.width=width;
container.height=height;
container.canvas=cnvs;
container.clear();
container._left=container._top=0;
isFloating&&(container.renderfix=function(){
});
container.renderfix();
return container
};
R._engine.setViewBox=function(x,y,w,h,fit){
eve('setViewBox',this,this._viewBox,[
x,
y,
w,
h,
fit
]);
var size=mmax(w/this.width,h/this.height),top=this.top,aspectRatio=fit?'meet':'xMinYMin',vb,sw;
if(x==null){
if(this._vbSize){
size=1
}
delete this._vbSize;
vb='0 0 '+this.width+S+this.height
}else{
this._vbSize=size;
vb=x+S+y+S+w+S+h
}
$(this.canvas,{
viewBox:vb,
preserveAspectRatio:aspectRatio
});
while(size&&top){
sw='stroke-width'in top.attrs?top.attrs['stroke-width']:1;
top.attr({'stroke-width':sw});
top._.dirty=1;
top._.dirtyT=1;
top=top.prev
}
this._viewBox=[
x,
y,
w,
h,
!!fit
];
return this
};
R.prototype.renderfix=function(){
var cnvs=this.canvas,s=cnvs.style,pos=cnvs.getScreenCTM()||cnvs.createSVGMatrix(),left=-pos.e%1,top=-pos.f%1;
if(left||top){
if(left){
this._left=(this._left+left)%1;
s.left=this._left+'px'
}
if(top){
this._top=(this._top+top)%1;
s.top=this._top+'px'
}
}
};
R.prototype.clear=function(){
R.eve('clear',this);
var c=this.canvas;
while(c.firstChild){
c.removeChild(c.firstChild)
}
this.bottom=this.top=null;
(this.desc=$('desc')).appendChild(R._g.doc.createTextNode('Created with Raphal '+R.version));
c.appendChild(this.desc);
c.appendChild(this.defs=$('defs'))
};
R.prototype.remove=function(){
eve('remove',this);
this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas);
for(var i in this){
this[i]=typeof this[i]=='function'?R._removedFactory(i):null
}
};
var setproto=R.st;
for(var method in elproto)
if(elproto[has](method)&&!setproto[has](method)){
setproto[method]=function(methodname){
return function(){
var arg=arguments;
return this.forEach(function(el){
el[methodname].apply(el,arg)
})
}
}(method)
}
}(window.Raphael);
window.Raphael.vml&&function(R){
var has='hasOwnProperty',Str=String,toFloat=parseFloat,math=Math,round=math.round,mmax=math.max,mmin=math.min,abs=math.abs,fillString='fill',separator=/[, ]+/,eve=R.eve,ms=' progid:DXImageTransform.Microsoft',S=' ',E='',map={
M:'m',
L:'l',
C:'c',
Z:'x',
m:'t',
l:'r',
c:'v',
z:'x'
},bites=/([clmz]),?([^clmz]*)/gi,blurregexp=/ progid:\S+Blur\([^\)]+\)/g,val=/-?[^,\s-]+/g,cssDot='position:absolute;left:0;top:0;width:1px;height:1px',zoom=21600,pathTypes={
path:1,
rect:1,
image:1
},ovalTypes={
circle:1,
ellipse:1
},path2vml=function(path){
var total=/[ahqstv]/gi,command=R._pathToAbsolute;
Str(path).match(total)&&(command=R._path2curve);
total=/[clmz]/g;
if(command==R._pathToAbsolute&&!Str(path).match(total)){
var res=Str(path).replace(bites,function(all,command,args){
var vals=[],isMove=command.toLowerCase()=='m',res=map[command];
args.replace(val,function(value){
if(isMove&&vals.length==2){
res+=vals+map[command=='m'?'l':'L'];
vals=[]
}
vals.push(round(value*zoom))
});
return res+vals
});
return res
}
var pa=command(path),p,r;
res=[];
for(var i=0,ii=pa.length;i<ii;i++){
p=pa[i];
r=pa[i][0].toLowerCase();
r=='z'&&(r='x');
for(var j=1,jj=p.length;j<jj;j++){
r+=round(p[j]*zoom)+(j!=jj-1?',':E)
}
res.push(r)
}
return res.join(S)
},compensation=function(deg,dx,dy){
var m=R.matrix();
m.rotate(-deg,0.5,0.5);
return{
dx:m.x(dx,dy),
dy:m.y(dx,dy)
}
},setCoords=function(p,sx,sy,dx,dy,deg){
var _=p._,m=p.matrix,fillpos=_.fillpos,o=p.node,s=o.style,y=1,flip='',dxdy,kx=zoom/sx,ky=zoom/sy;
s.visibility='hidden';
if(!sx||!sy){
return
}
o.coordsize=abs(kx)+S+abs(ky);
s.rotation=deg*(sx*sy<0?-1:1);
if(deg){
var c=compensation(deg,dx,dy);
dx=c.dx;
dy=c.dy
}
sx<0&&(flip+='x');
sy<0&&(flip+=' y')&&(y=-1);
s.flip=flip;
o.coordorigin=dx*-kx+S+dy*-ky;
if(fillpos||_.fillsize){
var fill=o.getElementsByTagName(fillString);
fill=fill&&fill[0];
o.removeChild(fill);
if(fillpos){
c=compensation(deg,m.x(fillpos[0],fillpos[1]),m.y(fillpos[0],fillpos[1]));
fill.position=c.dx*y+S+c.dy*y
}
if(_.fillsize){
fill.size=_.fillsize[0]*abs(sx)+S+_.fillsize[1]*abs(sy)
}
o.appendChild(fill)
}
s.visibility='visible'
};
R.toString=function(){
return'Your browser doesnt support SVG. Falling down to VML.\nYou are running Raphal '+this.version
};
var addArrow=function(o,value,isEnd){
var values=Str(value).toLowerCase().split('-'),se=isEnd?'end':'start',i=values.length,type='classic',w='medium',h='medium';
while(i--){
switch(values[i]){
case'block':
case'classic':
case'oval':
case'diamond':
case'open':
case'none':
type=values[i];
break;
case'wide':
case'narrow':
h=values[i];
break;
case'long':
case'short':
w=values[i];
break
}
}
var stroke=o.node.getElementsByTagName('stroke')[0];
stroke[se+'arrow']=type;
stroke[se+'arrowlength']=w;
stroke[se+'arrowwidth']=h
},setFillAndStroke=function(o,params){
o.attrs=o.attrs||{};
var node=o.node,a=o.attrs,s=node.style,xy,newpath=pathTypes[o.type]&&(params.x!=a.x||params.y!=a.y||params.width!=a.width||params.height!=a.height||params.cx!=a.cx||params.cy!=a.cy||params.rx!=a.rx||params.ry!=a.ry||params.r!=a.r),isOval=ovalTypes[o.type]&&(a.cx!=params.cx||a.cy!=params.cy||a.r!=params.r||a.rx!=params.rx||a.ry!=params.ry),res=o;
for(var par in params)
if(params[has](par)){
a[par]=params[par]
}
if(newpath){
a.path=R._getPath[o.type](o);
o._.dirty=1
}
params.href&&(node.href=params.href);
params.title&&(node.title=params.title);
params.target&&(node.target=params.target);
params.cursor&&(s.cursor=params.cursor);
'blur'in params&&o.blur(params.blur);
if(params.path&&o.type=='path'||newpath){
node.path=path2vml(~Str(a.path).toLowerCase().indexOf('r')?R._pathToAbsolute(a.path):a.path);
if(o.type=='image'){
o._.fillpos=[
a.x,
a.y
];
o._.fillsize=[
a.width,
a.height
];
setCoords(o,1,1,0,0,0)
}
}
'transform'in params&&o.transform(params.transform);
if(isOval){
var cx=+a.cx,cy=+a.cy,rx=+a.rx||+a.r||0,ry=+a.ry||+a.r||0;
node.path=R.format('ar{0},{1},{2},{3},{4},{1},{4},{1}x',round((cx-rx)*zoom),round((cy-ry)*zoom),round((cx+rx)*zoom),round((cy+ry)*zoom),round(cx*zoom))
}
if('clip-rect'in params){
var rect=Str(params['clip-rect']).split(separator);
if(rect.length==4){
rect[2]=+rect[2]+ +rect[0];
rect[3]=+rect[3]+ +rect[1];
var div=node.clipRect||R._g.doc.createElement('div'),dstyle=div.style;
dstyle.clip=R.format('rect({1}px {2}px {3}px {0}px)',rect);
if(!node.clipRect){
dstyle.position='absolute';
dstyle.top=0;
dstyle.left=0;
dstyle.width=o.paper.width+'px';
dstyle.height=o.paper.height+'px';
node.parentNode.insertBefore(div,node);
div.appendChild(node);
node.clipRect=div
}
}
if(!params['clip-rect']){
node.clipRect&&(node.clipRect.style.clip='auto')
}
}
if(o.textpath){
var textpathStyle=o.textpath.style;
params.font&&(textpathStyle.font=params.font);
params['font-family']&&(textpathStyle.fontFamily='"'+params['font-family'].split(',')[0].replace(/^['"]+|['"]+$/g,E)+'"');
params['font-size']&&(textpathStyle.fontSize=params['font-size']);
params['font-weight']&&(textpathStyle.fontWeight=params['font-weight']);
params['font-style']&&(textpathStyle.fontStyle=params['font-style'])
}
if('arrow-start'in params){
addArrow(res,params['arrow-start'])
}
if('arrow-end'in params){
addArrow(res,params['arrow-end'],1)
}
if(params.opacity!=null||params['stroke-width']!=null||params.fill!=null||params.src!=null||params.stroke!=null||params['stroke-width']!=null||params['stroke-opacity']!=null||params['fill-opacity']!=null||params['stroke-dasharray']!=null||params['stroke-miterlimit']!=null||params['stroke-linejoin']!=null||params['stroke-linecap']!=null){
var fill=node.getElementsByTagName(fillString),newfill=false;
fill=fill&&fill[0];
!fill&&(newfill=fill=createNode(fillString));
if(o.type=='image'&&params.src){
fill.src=params.src
}
params.fill&&(fill.on=true);
if(fill.on==null||params.fill=='none'||params.fill===null){
fill.on=false
}
if(fill.on&&params.fill){
var isURL=Str(params.fill).match(R._ISURL);
if(isURL){
fill.parentNode==node&&node.removeChild(fill);
fill.rotate=true;
fill.src=isURL[1];
fill.type='tile';
var bbox=o.getBBox(1);
fill.position=bbox.x+S+bbox.y;
o._.fillpos=[
bbox.x,
bbox.y
];
R._preload(isURL[1],function(){
o._.fillsize=[
this.offsetWidth,
this.offsetHeight
]
})
}else{
fill.color=R.getRGB(params.fill).hex;
fill.src=E;
fill.type='solid';
if(R.getRGB(params.fill).error&&(res.type in{
circle:1,
ellipse:1
}||Str(params.fill).charAt()!='r')&&addGradientFill(res,params.fill,fill)){
a.fill='none';
a.gradient=params.fill;
fill.rotate=false
}
}
}
if('fill-opacity'in params||'opacity'in params){
var opacity=((+a['fill-opacity']+1||2)-1)*((+a.opacity+1||2)-1)*((+R.getRGB(params.fill).o+1||2)-1);
opacity=mmin(mmax(opacity,0),1);
fill.opacity=opacity;
if(fill.src){
fill.color='none'
}
}
node.appendChild(fill);
var stroke=node.getElementsByTagName('stroke')&&node.getElementsByTagName('stroke')[0],newstroke=false;
!stroke&&(newstroke=stroke=createNode('stroke'));
if(params.stroke&&params.stroke!='none'||params['stroke-width']||params['stroke-opacity']!=null||params['stroke-dasharray']||params['stroke-miterlimit']||params['stroke-linejoin']||params['stroke-linecap']){
stroke.on=true
}
(params.stroke=='none'||params.stroke===null||stroke.on==null||params.stroke==0||params['stroke-width']==0)&&(stroke.on=false);
var strokeColor=R.getRGB(params.stroke);
stroke.on&&params.stroke&&(stroke.color=strokeColor.hex);
opacity=((+a['stroke-opacity']+1||2)-1)*((+a.opacity+1||2)-1)*((+strokeColor.o+1||2)-1);
var width=(toFloat(params['stroke-width'])||1)*0.75;
opacity=mmin(mmax(opacity,0),1);
params['stroke-width']==null&&(width=a['stroke-width']);
params['stroke-width']&&(stroke.weight=width);
width&&width<1&&(opacity*=width)&&(stroke.weight=1);
stroke.opacity=opacity;
params['stroke-linejoin']&&(stroke.joinstyle=params['stroke-linejoin']||'miter');
stroke.miterlimit=params['stroke-miterlimit']||8;
params['stroke-linecap']&&(stroke.endcap=params['stroke-linecap']=='butt'?'flat':params['stroke-linecap']=='square'?'square':'round');
if(params['stroke-dasharray']){
var dasharray={
'-':'shortdash',
'.':'shortdot',
'-.':'shortdashdot',
'-..':'shortdashdotdot',
'. ':'dot',
'- ':'dash',
'--':'longdash',
'- .':'dashdot',
'--.':'longdashdot',
'--..':'longdashdotdot'
};
stroke.dashstyle=dasharray[has](params['stroke-dasharray'])?dasharray[params['stroke-dasharray']]:E
}
newstroke&&node.appendChild(stroke)
}
if(res.type=='text'){
res.paper.canvas.style.display=E;
var span=res.paper.span,m=100,fontSize=a.font&&a.font.match(/\d+(?:\.\d*)?(?=px)/);
s=span.style;
a.font&&(s.font=a.font);
a['font-family']&&(s.fontFamily=a['font-family']);
a['font-weight']&&(s.fontWeight=a['font-weight']);
a['font-style']&&(s.fontStyle=a['font-style']);
fontSize=toFloat(a['font-size']||fontSize&&fontSize[0])||10;
s.fontSize=fontSize*m+'px';
res.textpath.string&&(span.innerHTML=Str(res.textpath.string).replace(/</g,'&#60;').replace(/&/g,'&#38;').replace(/\n/g,'<br>'));
var brect=span.getBoundingClientRect();
res.W=a.w=(brect.right-brect.left)/m;
res.H=a.h=(brect.bottom-brect.top)/m;
res.X=a.x;
res.Y=a.y+res.H/2;
('x'in params||'y'in params)&&(res.path.v=R.format('m{0},{1}l{2},{1}',round(a.x*zoom),round(a.y*zoom),round(a.x*zoom)+1));
var dirtyattrs=[
'x',
'y',
'text',
'font',
'font-family',
'font-weight',
'font-style',
'font-size'
];
for(var d=0,dd=dirtyattrs.length;d<dd;d++)
if(dirtyattrs[d]in params){
res._.dirty=1;
break
}
switch(a['text-anchor']){
case'start':
res.textpath.style['v-text-align']='left';
res.bbx=res.W/2;
break;
case'end':
res.textpath.style['v-text-align']='right';
res.bbx=-res.W/2;
break;
default:
res.textpath.style['v-text-align']='center';
res.bbx=0;
break
}
res.textpath.style['v-text-kern']=true
}
},addGradientFill=function(o,gradient,fill){
o.attrs=o.attrs||{};
var attrs=o.attrs,pow=Math.pow,opacity,oindex,type='linear',fxfy='.5 .5';
o.attrs.gradient=gradient;
gradient=Str(gradient).replace(R._radial_gradient,function(all,fx,fy){
type='radial';
if(fx&&fy){
fx=toFloat(fx);
fy=toFloat(fy);
pow(fx-0.5,2)+pow(fy-0.5,2)>0.25&&(fy=math.sqrt(0.25-pow(fx-0.5,2))*((fy>0.5)*2-1)+0.5);
fxfy=fx+S+fy
}
return E
});
gradient=gradient.split(/\s*\-\s*/);
if(type=='linear'){
var angle=gradient.shift();
angle=-toFloat(angle);
if(isNaN(angle)){
return null
}
}
var dots=R._parseDots(gradient);
if(!dots){
return null
}
o=o.shape||o.node;
if(dots.length){
o.removeChild(fill);
fill.on=true;
fill.method='none';
fill.color=dots[0].color;
fill.color2=dots[dots.length-1].color;
var clrs=[];
for(var i=0,ii=dots.length;i<ii;i++){
dots[i].offset&&clrs.push(dots[i].offset+S+dots[i].color)
}
fill.colors=clrs.length?clrs.join():'0% '+fill.color;
if(type=='radial'){
fill.type='gradientTitle';
fill.focus='100%';
fill.focussize='0 0';
fill.focusposition=fxfy;
fill.angle=0
}else{
fill.type='gradient';
fill.angle=(270-angle)%360
}
o.appendChild(fill)
}
return 1
},Element=function(node,vml){
this[0]=this.node=node;
node.raphael=true;
this.id=R._oid++;
node.raphaelid=this.id;
this.X=0;
this.Y=0;
this.attrs={};
this.paper=vml;
this.matrix=R.matrix();
this._={
transform:[],
sx:1,
sy:1,
dx:0,
dy:0,
deg:0,
dirty:1,
dirtyT:1
};
!vml.bottom&&(vml.bottom=this);
this.prev=vml.top;
vml.top&&(vml.top.next=this);
vml.top=this;
this.next=null
};
var elproto=R.el;
Element.prototype=elproto;
elproto.constructor=Element;
elproto.transform=function(tstr){
if(tstr==null){
return this._.transform
}
var vbs=this.paper._viewBoxShift,vbt=vbs?'s'+[
vbs.scale,
vbs.scale
]+'-1-1t'+[
vbs.dx,
vbs.dy
]:E,oldt;
if(vbs){
oldt=tstr=Str(tstr).replace(/\.{3}|\u2026/g,this._.transform||E)
}
R._extractTransform(this,vbt+tstr);
var matrix=this.matrix.clone(),skew=this.skew,o=this.node,split,isGrad=~Str(this.attrs.fill).indexOf('-'),isPatt=!Str(this.attrs.fill).indexOf('url(');
matrix.translate(-0.5,-0.5);
if(isPatt||isGrad||this.type=='image'){
skew.matrix='1 0 0 1';
skew.offset='0 0';
split=matrix.split();
if(isGrad&&split.noRotation||!split.isSimple){
o.style.filter=matrix.toFilter();
var bb=this.getBBox(),bbt=this.getBBox(1),dx=bb.x-bbt.x,dy=bb.y-bbt.y;
o.coordorigin=dx*-zoom+S+dy*-zoom;
setCoords(this,1,1,dx,dy,0)
}else{
o.style.filter=E;
setCoords(this,split.scalex,split.scaley,split.dx,split.dy,split.rotate)
}
}else{
o.style.filter=E;
skew.matrix=Str(matrix);
skew.offset=matrix.offset()
}
oldt&&(this._.transform=oldt);
return this
};
elproto.rotate=function(deg,cx,cy){
if(this.removed){
return this
}
if(deg==null){
return
}
deg=Str(deg).split(separator);
if(deg.length-1){
cx=toFloat(deg[1]);
cy=toFloat(deg[2])
}
deg=toFloat(deg[0]);
cy==null&&(cx=cy);
if(cx==null||cy==null){
var bbox=this.getBBox(1);
cx=bbox.x+bbox.width/2;
cy=bbox.y+bbox.height/2
}
this._.dirtyT=1;
this.transform(this._.transform.concat([[
'r',
deg,
cx,
cy
]]));
return this
};
elproto.translate=function(dx,dy){
if(this.removed){
return this
}
dx=Str(dx).split(separator);
if(dx.length-1){
dy=toFloat(dx[1])
}
dx=toFloat(dx[0])||0;
dy=+dy||0;
if(this._.bbox){
this._.bbox.x+=dx;
this._.bbox.y+=dy
}
this.transform(this._.transform.concat([[
't',
dx,
dy
]]));
return this
};
elproto.scale=function(sx,sy,cx,cy){
if(this.removed){
return this
}
sx=Str(sx).split(separator);
if(sx.length-1){
sy=toFloat(sx[1]);
cx=toFloat(sx[2]);
cy=toFloat(sx[3]);
isNaN(cx)&&(cx=null);
isNaN(cy)&&(cy=null)
}
sx=toFloat(sx[0]);
sy==null&&(sy=sx);
cy==null&&(cx=cy);
if(cx==null||cy==null){
var bbox=this.getBBox(1)
}
cx=cx==null?bbox.x+bbox.width/2:cx;
cy=cy==null?bbox.y+bbox.height/2:cy;
this.transform(this._.transform.concat([[
's',
sx,
sy,
cx,
cy
]]));
this._.dirtyT=1;
return this
};
elproto.hide=function(){
!this.removed&&(this.node.style.display='none');
return this
};
elproto.show=function(){
!this.removed&&(this.node.style.display=E);
return this
};
elproto._getBBox=function(){
if(this.removed){
return{}
}
return{
x:this.X+(this.bbx||0)-this.W/2,
y:this.Y-this.H,
width:this.W,
height:this.H
}
};
elproto.remove=function(){
if(this.removed){
return
}
this.paper.__set__&&this.paper.__set__.exclude(this);
R.eve.unbind('*.*.'+this.id);
R._tear(this,this.paper);
this.node.parentNode.removeChild(this.node);
this.shape&&this.shape.parentNode.removeChild(this.shape);
for(var i in this){
this[i]=typeof this[i]=='function'?R._removedFactory(i):null
}
this.removed=true
};
elproto.attr=function(name,value){
if(this.removed){
return this
}
if(name==null){
var res={};
for(var a in this.attrs)
if(this.attrs[has](a)){
res[a]=this.attrs[a]
}
res.gradient&&res.fill=='none'&&(res.fill=res.gradient)&&delete res.gradient;
res.transform=this._.transform;
return res
}
if(value==null&&R.is(name,'string')){
if(name==fillString&&this.attrs.fill=='none'&&this.attrs.gradient){
return this.attrs.gradient
}
var names=name.split(separator),out={};
for(var i=0,ii=names.length;i<ii;i++){
name=names[i];
if(name in this.attrs){
out[name]=this.attrs[name]
}else if(R.is(this.paper.customAttributes[name],'function')){
out[name]=this.paper.customAttributes[name].def
}else{
out[name]=R._availableAttrs[name]
}
}
return ii-1?out:out[names[0]]
}
if(this.attrs&&value==null&&R.is(name,'array')){
out={};
for(i=0,ii=name.length;i<ii;i++){
out[name[i]]=this.attr(name[i])
}
return out
}
var params;
if(value!=null){
params={};
params[name]=value
}
value==null&&R.is(name,'object')&&(params=name);
for(var key in params){
eve('attr.'+key+'.'+this.id,this,params[key])
}
if(params){
for(key in this.paper.customAttributes)
if(this.paper.customAttributes[has](key)&&params[has](key)&&R.is(this.paper.customAttributes[key],'function')){
var par=this.paper.customAttributes[key].apply(this,[].concat(params[key]));
this.attrs[key]=params[key];
for(var subkey in par)
if(par[has](subkey)){
params[subkey]=par[subkey]
}
}
if(params.text&&this.type=='text'){
this.textpath.string=params.text
}
setFillAndStroke(this,params)
}
return this
};
elproto.toFront=function(){
!this.removed&&this.node.parentNode.appendChild(this.node);
this.paper&&this.paper.top!=this&&R._tofront(this,this.paper);
return this
};
elproto.toBack=function(){
if(this.removed){
return this
}
if(this.node.parentNode.firstChild!=this.node){
this.node.parentNode.insertBefore(this.node,this.node.parentNode.firstChild);
R._toback(this,this.paper)
}
return this
};
elproto.insertAfter=function(element){
if(this.removed){
return this
}
if(element.constructor==R.st.constructor){
element=element[element.length-1]
}
if(element.node.nextSibling){
element.node.parentNode.insertBefore(this.node,element.node.nextSibling)
}else{
element.node.parentNode.appendChild(this.node)
}
R._insertafter(this,element,this.paper);
return this
};
elproto.insertBefore=function(element){
if(this.removed){
return this
}
if(element.constructor==R.st.constructor){
element=element[0]
}
element.node.parentNode.insertBefore(this.node,element.node);
R._insertbefore(this,element,this.paper);
return this
};
elproto.blur=function(size){
var s=this.node.runtimeStyle,f=s.filter;
f=f.replace(blurregexp,E);
if(+size!==0){
this.attrs.blur=size;
s.filter=f+S+ms+'.Blur(pixelradius='+(+size||1.5)+')';
s.margin=R.format('-{0}px 0 0 -{0}px',round(+size||1.5))
}else{
s.filter=f;
s.margin=0;
delete this.attrs.blur
}
};
R._engine.path=function(pathString,vml){
var el=createNode('shape');
el.style.cssText=cssDot;
el.coordsize=zoom+S+zoom;
el.coordorigin=vml.coordorigin;
var p=new Element(el,vml),attr={
fill:'none',
stroke:'#000'
};
pathString&&(attr.path=pathString);
p.type='path';
p.path=[];
p.Path=E;
setFillAndStroke(p,attr);
vml.canvas.appendChild(el);
var skew=createNode('skew');
skew.on=true;
el.appendChild(skew);
p.skew=skew;
p.transform(E);
return p
};
R._engine.rect=function(vml,x,y,w,h,r){
var path=R._rectPath(x,y,w,h,r),res=vml.path(path),a=res.attrs;
res.X=a.x=x;
res.Y=a.y=y;
res.W=a.width=w;
res.H=a.height=h;
a.r=r;
a.path=path;
res.type='rect';
return res
};
R._engine.ellipse=function(vml,x,y,rx,ry){
var res=vml.path(),a=res.attrs;
res.X=x-rx;
res.Y=y-ry;
res.W=rx*2;
res.H=ry*2;
res.type='ellipse';
setFillAndStroke(res,{
cx:x,
cy:y,
rx:rx,
ry:ry
});
return res
};
R._engine.circle=function(vml,x,y,r){
var res=vml.path(),a=res.attrs;
res.X=x-r;
res.Y=y-r;
res.W=res.H=r*2;
res.type='circle';
setFillAndStroke(res,{
cx:x,
cy:y,
r:r
});
return res
};
R._engine.image=function(vml,src,x,y,w,h){
var path=R._rectPath(x,y,w,h),res=vml.path(path).attr({stroke:'none'}),a=res.attrs,node=res.node,fill=node.getElementsByTagName(fillString)[0];
a.src=src;
res.X=a.x=x;
res.Y=a.y=y;
res.W=a.width=w;
res.H=a.height=h;
a.path=path;
res.type='image';
fill.parentNode==node&&node.removeChild(fill);
fill.rotate=true;
fill.src=src;
fill.type='tile';
res._.fillpos=[
x,
y
];
res._.fillsize=[
w,
h
];
node.appendChild(fill);
setCoords(res,1,1,0,0,0);
return res
};
R._engine.text=function(vml,x,y,text){
var el=createNode('shape'),path=createNode('path'),o=createNode('textpath');
x=x||0;
y=y||0;
text=text||'';
path.v=R.format('m{0},{1}l{2},{1}',round(x*zoom),round(y*zoom),round(x*zoom)+1);
path.textpathok=true;
o.string=Str(text);
o.on=true;
el.style.cssText=cssDot;
el.coordsize=zoom+S+zoom;
el.coordorigin='0 0';
var p=new Element(el,vml),attr={
fill:'#000',
stroke:'none',
font:R._availableAttrs.font,
text:text
};
p.shape=el;
p.path=path;
p.textpath=o;
p.type='text';
p.attrs.text=Str(text);
p.attrs.x=x;
p.attrs.y=y;
p.attrs.w=1;
p.attrs.h=1;
setFillAndStroke(p,attr);
el.appendChild(o);
el.appendChild(path);
vml.canvas.appendChild(el);
var skew=createNode('skew');
skew.on=true;
el.appendChild(skew);
p.skew=skew;
p.transform(E);
return p
};
R._engine.setSize=function(width,height){
var cs=this.canvas.style;
this.width=width;
this.height=height;
width==+width&&(width+='px');
height==+height&&(height+='px');
cs.width=width;
cs.height=height;
cs.clip='rect(0 '+width+' '+height+' 0)';
if(this._viewBox){
R._engine.setViewBox.apply(this,this._viewBox)
}
return this
};
R._engine.setViewBox=function(x,y,w,h,fit){
R.eve('setViewBox',this,this._viewBox,[
x,
y,
w,
h,
fit
]);
var width=this.width,height=this.height,size=1/mmax(w/width,h/height),H,W;
if(fit){
H=height/h;
W=width/w;
if(w*H<width){
x-=(width-w*H)/2/H
}
if(h*W<height){
y-=(height-h*W)/2/W
}
}
this._viewBox=[
x,
y,
w,
h,
!!fit
];
this._viewBoxShift={
dx:-x,
dy:-y,
scale:size
};
this.forEach(function(el){
el.transform('...')
});
return this
};
var createNode;
R._engine.initWin=function(win){
var doc=win.document;
doc.createStyleSheet().addRule('.rvml','behavior:url(#default#VML)');
try{
!doc.namespaces.rvml&&doc.namespaces.add('rvml','urn:schemas-microsoft-com:vml');
createNode=function(tagName){
return doc.createElement('<rvml:'+tagName+' class="rvml">')
}
}catch(e){
createNode=function(tagName){
return doc.createElement('<'+tagName+' xmlns="urn:schemas-microsoft.com:vml" class="rvml">')
}
}
};
R._engine.initWin(R._g.win);
R._engine.create=function(){
var con=R._getContainer.apply(0,arguments),container=con.container,height=con.height,s,width=con.width,x=con.x,y=con.y;
if(!container){
throw new Error('VML container not found.')
}
var res=new R._Paper,c=res.canvas=R._g.doc.createElement('div'),cs=c.style;
x=x||0;
y=y||0;
width=width||512;
height=height||342;
res.width=width;
res.height=height;
width==+width&&(width+='px');
height==+height&&(height+='px');
res.coordsize=zoom*1000+S+zoom*1000;
res.coordorigin='0 0';
res.span=R._g.doc.createElement('span');
res.span.style.cssText='position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;';
c.appendChild(res.span);
cs.cssText=R.format('top:0;left:0;width:{0};height:{1};display:inline-block;position:relative;clip:rect(0 {0} {1} 0);overflow:hidden',width,height);
if(container==1){
R._g.doc.body.appendChild(c);
cs.left=x+'px';
cs.top=y+'px';
cs.position='absolute'
}else{
if(container.firstChild){
container.insertBefore(c,container.firstChild)
}else{
container.appendChild(c)
}
}
res.renderfix=function(){
};
return res
};
R.prototype.clear=function(){
R.eve('clear',this);
this.canvas.innerHTML=E;
this.span=R._g.doc.createElement('span');
this.span.style.cssText='position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;display:inline;';
this.canvas.appendChild(this.span);
this.bottom=this.top=null
};
R.prototype.remove=function(){
R.eve('remove',this);
this.canvas.parentNode.removeChild(this.canvas);
for(var i in this){
this[i]=typeof this[i]=='function'?R._removedFactory(i):null
}
return true
};
var setproto=R.st;
for(var method in elproto)
if(elproto[has](method)&&!setproto[has](method)){
setproto[method]=function(methodname){
return function(){
var arg=arguments;
return this.forEach(function(el){
el[methodname].apply(el,arg)
})
}
}(method)
}
}(window.Raphael);
Ext.ns('web.pageImport.ui.plugins');
web.pageImport.ui.plugins.AutoScroll=function(){
this.intervalHande=null;
this.xSpeed=0;
this.ySpeed=0;
this.prevXY={
x:0,
y:0
};
this.frameRate=20;
this.velocityChangeRate=0.14
};
web.pageImport.ui.plugins.AutoScroll.prototype={
constructor:web.pageImport.ui.plugins.AutoScroll,
init:function(component){
component.on('overlayrendered',function(cmp){
this.el=cmp.getEl();
this.initScrollListeners()
},this);
component.on('destroy',function(){
Ext.getBody().un('mouseup',this.stopScroll,this)
},this)
},
initScrollListeners:function(){
this.el.on('mousedown',function(e){
var xy=e.getXY(),elOffset=this.el.getOffsetsTo(Ext.getBody());
if(xy[0]<this.el.dom.clientWidth+elOffset[0]&&xy[1]<this.el.dom.clientHeight+elOffset[1]){
this.startScroll()
}
},this);
this.el.on('mousemove',function(e){
this.updatePosition(e.getPageX(),e.getPageY())
},this);
Ext.getBody().on('mouseup',this.stopScroll,this)
},
updatePosition:function(x,y){
if(this.intervalHande){
var region=this.el.getRegion(),change={
x:0,
y:0
},initialSpeed=3;
change.x=x-this.prevXY.x;
change.y=y-this.prevXY.y;
if(change.y){
if(y<region.top+50&&change.y<0){
this.ySpeed=-initialSpeed
}else if(y>region.bottom-50&&change.y>0){
this.ySpeed=initialSpeed
}else{
this.ySpeed=0
}
}
if(change.x){
if(x<region.left+50&&change.x<0){
this.xSpeed=-initialSpeed
}else if(x>region.right-50&&change.x>0){
this.xSpeed=initialSpeed
}else{
this.xSpeed=0
}
}
}
this.prevXY={
x:x,
y:y
}
},
startScroll:function(){
var that=this;
this.stopScroll();
this.intervalHande=setInterval(function(){
that.scroll()
},this.frameRate)
},
stopScroll:function(){
clearInterval(this.intervalHande);
this.intervalHande=null
},
scroll:function(){
var xSpeed=this.xSpeed,ySpeed=this.ySpeed,scroll=this.el.getScroll();
if(xSpeed){
this.el.scrollTo('left',scroll.left+xSpeed);
this.xSpeed+=this.velocityChangeRate*(xSpeed<0?-1:1)
}
if(ySpeed){
this.el.scrollTo('top',scroll.top+ySpeed);
this.ySpeed+=this.velocityChangeRate*(ySpeed<0?-1:1)
}
}
};
web.pageImport.ui.PageContentSelector=Ext.extend(Ext.BoxComponent,{
xtype:'web-pageImport-ui-pageContentSelector',
constructor:function(){
this.addEvents('select','deselect','overlayrendered');
web.pageImport.ui.PageContentSelector.superclass.constructor.apply(this,arguments)
},
initComponent:function(){
this.previewEl=null;
this.refresher=null;
this.dragBox=null;
this.paper=null;
this.mouseDownStarted=false;
this.lastMousePosition=null;
this.highlights={};
this.cls='web-ui-pagecontentselector';
this.autoEl={
tag:'div',
cn:{
tag:'div',
cls:'preview-content'
}
};
this.listeners={
afterrender:function(cmp){
this.initOverlay()
},
scope:this
};
this.plugins=[new web.pageImport.ui.plugins.AutoScroll];
web.pageImport.ui.PageContentSelector.superclass.initComponent.call(this)
},
destroy:function(){
this.clearSelection();
if(this.refresher){
this.refresher.remove()
}
this.drawSelection(null);
if(this.paper){
this.paper.remove()
}
this.selectedEl=null;
this.previewEl=null;
this.refresher=null;
this.dragBox=null;
this.paper=null;
web.pageImport.ui.PageContentSelector.superclass.destroy.call(this)
},
update:function(html){
this.previewEl.update(html);
var texts=this.previewEl.dom.querySelectorAll('.text');
Array.prototype.slice.call(texts,0).forEach(function(text){
text.style.height=text.style.minHeight;
text.style.overflow='hidden'
});
var menus=this.previewEl.dom.querySelectorAll('.menu');
Array.prototype.slice.call(menus,0).forEach(function(menu){
var menuSelf=menu.querySelector('.menuself');
if(menuSelf){
menu.style.height=menuSelf.style.height;
menu.style.overflow='hidden'
}
});
var div=this.previewEl.first('div'),parent;
if(div){
parent=this.previewEl.parent().dom;
div.setHeight(parent.scrollHeight+20);
div.setWidth(parent.scrollWidth);
this.paper.setSize(parent.scrollWidth,parent.scrollHeight)
}
this.clearSelection()
},
clearSelection:function(){
Ext.iterate(this.highlights,function(id,o){
this.drawHighlight(null,o)
},this);
this.highlights={};
this.selectedComponentIds=[];
this.fireEvent('deselect')
},
getSelectedComponentIds:function(){
return this.selectedComponentIds
},
initOverlay:function(){
this.previewEl=this.el.first('div.preview-content');
this.paper=new Raphael(this.el.dom);
var svgEl=this.paper.canvas;
Ext.apply(svgEl.style,{
pointerEvents:'none',
position:'absolute'
});
this.mon(this.el,'scroll',this.handleBodyScroll,this);
this.mon(this.previewEl,'mousemove',this.handleMouseMove,this);
this.mon(this.previewEl,'mousedown',this.handleMouseDown,this);
this.mon(this.previewEl,'mouseup',this.handleMouseUp,this);
web.utils.Event.add(document,'keydown',function(e){
var els=this.el.select('[@data-id]');
if((e.ctrlKey||e.metaKey)&&e.keyCode===65){
this.selectedComponentIds.length=0;
els.each(function(el){
var id=el.getAttribute('data-id');
this.selectedComponentIds.push(id);
this.highlights[id]=this.drawHighlight(el)
},this);
this.fireEvent('select',this.selectedComponentIds);
e.preventDefault()
}
}.createDelegate(this));
Ext.get(svgEl).on('mouseover',this.fixPointerEvents,this);
this.fireEvent('overlayrendered',this)
},
fixPointerEvents:function(){
if(!this.fixedPointer){
if(Ext.isIE){
var paperEl=Ext.get(this.paper.canvas);
Ext.apply(paperEl.dom.style,{visibility:'hidden'});
if(paperEl.dom.nodeName.toLowerCase()==='svg'){
var children=paperEl.dom.childNodes,i,len=children.length;
for(i=0;i<len;i+=1){
children[i].style.visibility='visible'
}
}
paperEl.un('mouseover',this.fixPointerEvents)
}else{
this.drawInIframe()
}
this.fixedPointer=true
}
},
drawInIframe:function(){
var scrollEl=this.previewEl.parent().dom,paperEl=Ext.get(this.paper.canvas),webkitFrameBody;
this.items={};
this.webkitFrame=Ext.DomHelper.createDom({
tag:'iframe',
cls:'isvg',
scrolling:'no'
});
this.webkitFrame.style.width=scrollEl.scrollWidth+'px';
this.webkitFrame.style.height=scrollEl.scrollHeight+'px';
this.el.dom.appendChild(this.webkitFrame);
webkitFrameBody=this.webkitFrame.contentWindow.document.body;
Ext.get(webkitFrameBody).insertFirst(paperEl);
Ext.apply(paperEl.dom.style,{
pointerEvents:'none',
position:'absolute',
zIndex:'100',
left:'0px',
top:'0px'
});
this.fireEvent('redrawiframe')
},
handleMouseDown:function(e){
e.preventDefault();
this.clearSelection();
var offsets=this.el.getOffsetsTo(Ext.getBody()),scroll=this.el.getScroll();
this.mouseDownStarted=[
e.getPageX()-offsets[0]+scroll.left,
e.getPageY()-offsets[1]+scroll.top
]
},
handleMouseUp:function(){
this.mouseDownStarted=null;
this.drawSelection(null);
if(this.selectedComponentIds.length>0){
this.fireEvent('select',this.selectedComponentIds)
}else{
this.fireEvent('deselect')
}
clearInterval(this.adjustScroll)
},
handleMouseMove:function(e){
if(this.mouseDownStarted){
var els=this.el.select('[@data-id]'),offsets=this.el.getOffsetsTo(Ext.getBody()),scroll=this.el.getScroll(),xy=[
e.getPageX()-offsets[0]+scroll.left,
e.getPageY()-offsets[1]+scroll.top
],initialXY=this.mouseDownStarted,selectedRegion={},selectedComponentIds=[];
this.lastMousePosition=e.getXY();
this.drawSelection(this.mouseDownStarted[0],this.mouseDownStarted[1],xy[0],xy[1]);
if(xy[0]>initialXY[0]){
selectedRegion.left=initialXY[0];
selectedRegion.right=xy[0]
}else{
selectedRegion.left=xy[0];
selectedRegion.right=initialXY[0]
}
if(xy[1]>initialXY[1]){
selectedRegion.top=initialXY[1];
selectedRegion.bottom=xy[1]
}else{
selectedRegion.top=xy[1];
selectedRegion.bottom=initialXY[1]
}
var prevHighlights=this.highlights;
this.highlights={};
els.each(function(el){
var region=el.getRegion(),id;
region.top+=scroll.top-offsets[1];
region.right+=scroll.left-offsets[0];
region.bottom+=scroll.top-offsets[1];
region.left+=scroll.left-offsets[0];
if(region.top>=selectedRegion.top&&region.right<=selectedRegion.right&&region.bottom<=selectedRegion.bottom&&region.left>=selectedRegion.left){
id=el.getAttribute('data-id');
selectedComponentIds.push(id);
this.highlights[id]=prevHighlights[id];
if(!prevHighlights[id]){
this.highlights[id]=this.drawHighlight(el)
}
}
},this);
Ext.iterate(prevHighlights,function(id,o){
if(!this.highlights[id]){
this.drawHighlight(null,o)
}
},this);
this.selectedComponentIds=selectedComponentIds
}
},
handleBodyScroll:function(){
if(this.mouseDownStarted){
var offsets=this.el.getOffsetsTo(Ext.getBody()),scroll=this.el.getScroll(),xy=[
this.lastMousePosition[0]-offsets[0]+scroll.left,
this.lastMousePosition[1]-offsets[1]+scroll.top
];
this.drawSelection(this.mouseDownStarted[0],this.mouseDownStarted[1],xy[0],xy[1])
}
if(this.refresher){
this.refresher.attr({
x:-100,
y:-100
})
}else{
this.refresher=this.paper.rect(-100,-100,0,0)
}
},
drawSelection:function(x1,y1,x2,y2){
var box=this.dragBox;
if(box){
box.el1.remove();
box.el2.remove()
}
if(x1===null){
this.dragBox=null;
return
}
var width=Math.abs(x1-x2),height=Math.abs(y1-y2),initialX,initialY,el1,el2;
if(x1>x2){
initialX=x2
}else{
initialX=x1
}
if(y1>y2){
initialY=y2
}else{
initialY=y1
}
el1=this.paper.rect(initialX-1.5,initialY-1.5,width+3,height+3);
el1.attr({
stroke:'#708792',
'stroke-width':1,
'stroke-linejoin':'round'
});
el2=this.paper.rect(initialX-0.5,initialY-0.5,width+1,height+1);
el2.attr({
stroke:'#fff',
'stroke-width':1,
'stroke-linejoin':'round'
});
this.dragBox={
el1:el1,
el2:el2
}
},
drawHighlight:function(el,highlight){
var raphaelElement1=null,raphaelElement2=null,targetBox,panelOffset,scrollOffset,x,y;
if(highlight){
highlight.el1.remove();
highlight.el2.remove()
}
if(el){
targetBox=el.getBox();
panelOffset=this.getPosition();
scrollOffset=this.el.getScroll();
x=targetBox.x-panelOffset[0]+scrollOffset.left;
y=targetBox.y-panelOffset[1]+scrollOffset.top;
raphaelElement1=this.paper.rect(x-1.5,y-1.5,targetBox.width+3,targetBox.height+3);
raphaelElement1.attr({
stroke:'#708792',
'stroke-width':1,
'stroke-linejoin':'round'
});
raphaelElement2=this.paper.rect(x-0.5,y-0.5,targetBox.width+1,targetBox.height+1);
raphaelElement2.attr({
stroke:'#fff',
'stroke-width':1,
'stroke-linejoin':'round'
});
return{
el1:raphaelElement1,
el2:raphaelElement2
}
}
},
getEventTarget:function(e,nonFlyweight){
if(nonFlyweight){
return Ext.get(e.getTarget('[data-id]'))
}else{
return Ext.fly(e.getTarget('[data-id]'))
}
}
});
Ext.reg('web-pageImport-ui-pageContentSelector',web.pageImport.ui.PageContentSelector);
web.pageImport.ui.SelectPageContent=Ext.extend(web.pageImport.ui.Panel,{
initComponent:function(){
this.pageName='';
this.defaultLabelText='Draw a rectangle around the area that contains your page content. Your page content is the part that changes from page to page.';
this.bodyItems=[
{
xtype:'container',
layout:'hflex',
items:[
{
ref:'../selectContentLabel',
xtype:'label',
flex:1,
text:this.defaultLabelText
},
{
ref:'../guideButton',
xtype:'button',
hidden:true,
cls:'x-btn-primary large wide',
text:'Guide'
}
]
},
{
xtype:'spacer',
height:12
},
{
ref:'panel',
xtype:'web-pageImport-ui-pageContentSelector',
flex:1,
listeners:{
select:function(){
this.enableNextButton()
},
deselect:function(){
this.disableNextButton()
},
scope:this
}
}
];
this.listeners={
show:function(){
this.panel.clearSelection()
}
};
this.buttons=[];
this.nextButtonDefaultText='Next Page';
this.fbar={
layout:'hflex',
cls:'footer-extra-padding',
items:[
{
text:'Start Over',
cls:'import-back-btn',
handler:function(){
this.fireEvent('startover');
this.clear()
},
scope:this
},
{
ref:'../counter',
xtype:'container',
flex:1,
style:{
textAlign:'center',
padding:'0 0 0 150px'
},
html:'Number of pages'
},
{
ref:'../skipPageButton',
cls:'x-btn-primary large wide',
margins:'0',
text:'Skip this page',
handler:function(){
this.fireEvent('next',false);
this.clear()
},
scope:this
},
{
xtype:'spacer',
width:6
},
{
ref:'../nextButton',
cls:'x-btn-primary large wide',
margins:'0',
text:this.nextButtonDefaultText,
handler:function(){
this.fireEvent('next',true);
this.clear()
},
scope:this
}
]
};
web.pageImport.ui.SelectPageContent.superclass.initComponent.call(this)
},
initLoad:function(cfg){
var text=cfg.index===cfg.total?'Finish':this.nextButtonDefaultText;
this.nextButton.setText(text);
text=cfg.index>1?'Loading next page...':'Loading page...';
this.el.mask(text);
this.counter.update('<span style="font-weight:bold;">'+('Page '+cfg.index+' of '+cfg.total+':')+'</span> <span style="color: #999;">'+cfg.filename+'</span>');
this.filename=cfg.filename;
this.disableNextButton()
},
update:function(page){
var doc=new web.Document({
dm:new web.DM,
domain:this.app.dal.domain,
editMode:true,
classPrefix:'web-pageImport'
});
page.render(doc);
page.getTemplate().renderBody(doc);
var styles='<style type="text/css">'+doc.getStylesCSS()+'</style>',html='<div class="body blockbody" style="padding: 10px">'+'<div style="width:'+(page.getTemplate().bbox.right-page.getTemplate().bbox.left)+'px;margin:auto;position:relative;">'+doc.toBodyHTML()+'</div>'+'</div>';
this.pageName=doc.getPage().getName()||this.filename.replace(/\.[^\.]+$/,'');
this.panel.update(styles+html);
this.panel.getEl().dom.scrollTop=0
},
clear:function(){
this.panel.update('')
},
updateLabel:function(text){
if(text!==undefined){
this.selectContentLabel.setText(text)
}else{
this.selectContentLabel.setText(this.defaultLabelText)
}
},
showWarning:function(){
var ref=this.messages.guestbook;
Ext.Msg.alert(ref.title,ref.text)
},
hideLoading:function(){
this.el.unmask()
},
hideGuide:function(){
this.guideButton.hide()
},
showGuide:function(){
this.guideButton.show()
},
getSelected:function(){
return this.panel.getSelectedComponentIds()
},
getPageName:function(){
return this.pageName
}
});
Ext.reg('web-pageimport-ui-selectpagecontent',web.pageImport.ui.SelectPageContent);
web.pageImport.ui.SelectSinglePageContentCover=Ext.extend(web.pageImport.ui.Panel,{
initComponent:function(){
this.bodyItems=[
{html:'<div class=coverPanel><p>When recreating you insert the content of your WebCreator page into a existing Website Builder template:</p><p class=imageContainer><span class="image pageContent"></span></p><p>Click <span style=font-weight:700>Continue</span> and select a Website Builder template to insert your WebCreator content into.</p></div>'},
{
ref:'progress',
xtype:'progress',
hidden:true,
width:335,
height:52,
value:1,
style:{margin:'auto'}
}
];
web.pageImport.ui.SelectSinglePageContentCover.superclass.initComponent.call(this)
},
showProgress:function(){
this.progress.show();
this.disableNextButton()
},
hideProgress:function(){
this.progress.hide();
this.enableNextButton()
}
});
Ext.reg('web-pageimport-ui-selectsinglepagecontentcover',web.pageImport.ui.SelectSinglePageContentCover);
Ext.ns('web.utils');
web.utils.Copier=function(){
this.uidDict={
oldToNew:{},
newToOld:{}
}
};
web.utils.Copier.prototype={
copy:function(obj,exempt){
var resultObj={},newUuid;
if(typeof exempt==='string'){
exempt=new RegExp('^'+exempt+'$')
}
if(Ext.isArray(obj)){
return obj.map(function(value){
return this.copy(value,exempt)
},this)
}else if(Ext.isObject(obj)){
Object.keys(obj).forEach(function(keyName){
var value=obj[keyName];
if(exempt&&exempt.test(keyName)&&typeof value==='string'){
resultObj[keyName]=value
}else{
resultObj[keyName]=this.copy(value,exempt)
}
},this);
return resultObj
}else{
if(typeof obj==='string'&&/^(?:[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89ab][a-f0-9]{3}-[a-f0-9]{12})$/i.test(obj)){
if(!this.uidDict.oldToNew[obj]){
newUuid=Math.uuid();
this.uidDict.oldToNew[obj]=newUuid;
this.uidDict.newToOld[newUuid]=obj
}
return this.uidDict.oldToNew[obj]
}else{
return obj
}
}
},
translate:function(uuid,oldToNew){
var direction=oldToNew?'oldToNew':'newToOld';
return this.uidDict[direction][uuid]
}
};
web.ui.TemplateSelectorList=Ext.extend(Ext.DataView,{
xtype:'web-ui-templateselectorlist',
app:null,
repository:null,
category:null,
showMultiPage:null,
multiPageDownload:null,
dal:null,
enableDelete:null,
dm:null,
constructor:function(cfg){
this.app=cfg.app;
this.dm=new web.DM;
this.repository=null;
this.dal=null;
this.category=cfg.category;
this.enableDelete=cfg.enableDelete;
this.multiPageDownload=cfg.multiPageDownload;
this.showMultiPage=cfg.showMultiPage;
this.repositorySiteMap=null;
web.ui.TemplateSelectorList.superclass.constructor.call(this,cfg)
},
initComponent:function(){
this.addEvents('templatedeleted','templateduplicated','templateclickpreview','beforeok','ok','selectionchange');
this.cls='web-ui-templateSelectorlist';
this.store=new Ext.data.Store({
reader:new Ext.data.JsonReader({
idProperty:'id',
fields:[
'id',
'preview',
'pageId',
'templateId',
'stylesheetId',
'name',
'deletable',
'inUse',
'isPlaceholder',
'level',
'subPageIds',
'title',
'isSpacer',
'isLastRow',
'isPremium'
]
})
});
this.singleSelect=true;
this.itemSelector='div.web-ui-templateSelectorlist-thumb';
this.autoScroll=true;
this.emptyText='No templates available.';
this.tpl=new Ext.XTemplate('<tpl for=".">','   <div class="web-ui-templateSelectorlist-item premium-{isPremium} {isSpacer} {isLastRow}">','      <div class="web-ui-templateSelectorlist-thumb" style="background-image:url(\'{preview}\')">','         <div class="buttonpanel">','            <div class="templatename">','               {name}','            </div>','            <a class="previewBtn">','               <div class="icon icon-preview"></div>','               <div>'+'View'+'</div>','            </a>','            <a class="chooseBtn">','               <div class="icon icon-choose"></div>','               <div>'+'Select'+'</div>','            </a>','         </div>','         <div class="premium-ribbon {isPremium}">'+'Premium'+'</div>','      </div>','   </div>','</tpl>');
this.listeners={
click:this.handleRecordClick,
dblclick:this.handleDoubleClick,
scope:this
};
var that=this;
oneJQuery(window).resize(function(){
that.applyWidthToTheThumbsContainer()
});
web.ui.TemplateSelectorList.superclass.initComponent.call(this)
},
updateTemplates:function(templates){
this.store.loadData(templates)
},
getRepository:function(){
return this.repository
},
fetchData:function(filter){
var loadFn;
if(this.category==='standard'){
loadFn='fetchRepositoryTemplateRecords'
}else if(this.category==='modified'){
loadFn='fetchModifiedTemplateRecords'
}else if(this.category==='blank'){
loadFn='fetchRepositoryTemplateRecords'
}
var that=this;
this[loadFn](function(records){
records=records.filter(function(rec){
return!filter||filter.categoryId==='all'||rec.templateCategories.indexOf(filter.categoryId)>=0
});
this.el.scrollTo('top',0);
this.store.loadData(records);
this.fireEvent('onload',that)
});
this.applyWidthToTheThumbsContainer()
},
applyWidthToTheThumbsContainer:function(records){
var thumbWidth=416;
var cols=Math.floor(window.innerWidth/thumbWidth);
oneJQuery('.web-ui-templateSelectorlist').width(cols*thumbWidth)
},
getRawTemplates:function(){
var templates=[];
this.store.data.items.forEach(function(item){
templates.push(item.data)
});
return templates
},
getSelectedTemplateId:function(){
var selected=this.getSelectedRecords();
return selected.length?selected[0].data.templateId:null
},
getSelectedData:function(){
var selected=this.getSelectedRecords();
return selected.length?selected[0].data:null
},
fixMenuComponents:function(json,record){
var minusLevel=record.level>=2?2:1;
(function traverse(obj){
Object.keys(obj).forEach(function(prop){
var value=obj[prop];
if(value!==null){
if(value.type==='web.data.components.Menu'){
value.level-=minusLevel
}
if(value.type||Ext.isArray(value)){
traverse(value)
}
}
},this)
}(json))
},
fetchSelectedTemplate:function(callback,scope){
var repositoryError='<b>'+'Unable to retrieve repository template.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.',selectedRecords=this.getSelectedRecords(),appDM=this.app.dm,templateId,record;
if(selectedRecords.length===0){
callback.call(scope,null)
}
record=selectedRecords[0].data;
templateId=record.templateId;
if(this.category==='modified'){
this.repository.getWithDependents(templateId,'web.data.components.Template',function(opts,success,response){
if(success){
var data=Ext.decode(response.responseText),pageTreeConfig={
page:null,
name:'',
title:'',
hidden:false,
subPageIds:null
};
callback.call(scope,appDM.create(data.template),appDM.create(data.stylesheet),pageTreeConfig)
}else{
one.error(repositoryError)
}
},this)
}else{
this.copyRepositoryTemplateAndStylesheet(record,function(success,template,stylesheet,uidDict){
if(success){
var pageIds;
if(this.addingPage){
pageIds=this._pageNames.map(function(item){
return item[0]
});
if(!pageIds[0]){
one.fatal('Reached unexpected case with page selector.')
}
}else{
pageIds=record.subPageIds;
if(!pageIds[0]){
pageIds=[record.pageId]
}
}
var copier=new web.utils.Copier,pageTreeConfig={
page:null,
name:'',
title:'',
hidden:false,
subPageIds:pageIds
},error;
copier.uidDict=uidDict;
var linkPages=this.repositorySiteMap.getFolder().getLinkPages();
var fetch=function(parentTreeConfig,callback){
async.map(parentTreeConfig.subPageIds,function(subPageId,callback){
var subLinkPage=linkPages.filter(function(page){
return page.pageId===subPageId
})[0];
this.repository.get('web.data.components.Page',subPageId,function(opts,success,response){
if(success){
var json=Ext.decode(response.responseText),subLinkPageJson=subLinkPage.toJSON();
delete subLinkPageJson.items;
if(this.addingPage){
subLinkPageJson.hidden=false
}
this.fixMenuComponents(json,record);
var subTreeConfig={
page:copier.copy(json),
linkPage:copier.copy(subLinkPageJson)
};
if(subLinkPage.items&&subLinkPage.items.length){
subTreeConfig.subPageIds=Ext.pluck(subLinkPage.items,'pageId');
fetch.call(this,subTreeConfig,function(){
callback(null,subTreeConfig)
})
}else{
callback(null,subTreeConfig)
}
}else{
error=true;
callback(error)
}
},this)
}.bind(this),function(err,results){
if(err){
return callback(err)
}
parentTreeConfig.subTreeConfig=results;
delete parentTreeConfig.subPageIds;
callback()
}.bind(this))
};
fetch.call(this,pageTreeConfig,function(){
if(!error){
var isRelPageModified=false;
template.items.forEach(function(item){
if(item.relPage){
isRelPageModified=true;
var oldToNewUid=copier.uidDict.oldToNew;
Object.keys(item.relPage).forEach(function(key){
if(oldToNewUid[key]!==undefined){
item.relPage[oldToNewUid[key]]=item.relPage[key]
}
delete item.relPage[key]
})
}
});
if(isRelPageModified){
this.app.dal.set(template,function(opts,success,response){
if(success){
callback.call(scope,template,stylesheet,pageTreeConfig.subTreeConfig)
}else{
one.error('<b>'+'Unable to retrieve page.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.')
}
},this)
}else{
callback.call(scope,template,stylesheet,pageTreeConfig.subTreeConfig)
}
}else{
one.error('<b>'+'Unable to retrieve page.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.')
}
}.bind(this))
}
})
}
},
handleRecordClick:function(dataView,index,n,e){
this.fireEvent('selectionchange','standard',this,dataView.getRecord(n));
var previewBtn=e.getTarget('.previewBtn',2,true),chooseBtn=e.getTarget('.chooseBtn',2,true);
if(previewBtn){
this.fireEvent('templateclickpreview',this,[n])
}else if(chooseBtn){
this.fireEvent('templateselected',this,[n])
}else{
this.fireEvent('templateclickpreview',this,[n])
}
},
handleDoubleClick:function(dataView,index,node){
this.fireEvent('templateclickpreview',this,[node])
},
createModifiedRecords:function(docs,pages){
var templates=[];
pages=pages||[];
docs.forEach(function(template){
var id=template.id,inUse=false,previewUrl;
previewUrl=this.repository.getPreviewImageUrl(id,760,490,1280);
inUse=pages.some(function(page){
return page.templateId===id
});
templates.push({
id:id,
name:template.name,
templateId:id,
stylesheetId:template.stylesheetId,
preview:previewUrl,
deletable:this.enableDelete,
inUse:inUse
})
},this);
return templates
},
getPage:function(){
if(!this.page){
this.page=this.dm.create({
id:Math.uuid(),
type:'web.data.components.Page'
})
}
return this.page
},
getLoadMask:function(){
return{
show:function(){
oneJQuery('.web-panels-templateselector').css('cursor','wait')
},
hide:function(){
oneJQuery('.web-panels-templateselector').css('cursor','')
}
}
},
filterRecordsByType:function(records,recordType){
var tmpRecords=[];
if(records.length){
records.forEach(function(record){
if(record.type===recordType){
tmpRecords.push(record)
}
})
}
return tmpRecords
},
fetchModifiedTemplateRecords:function(callback){
this.getLoadMask().show();
var dal=this.app.dal;
dal.getList('web.data.components.Template',true,function(opts,success,response){
this.getLoadMask().hide();
if(success){
var templates=this.filterRecordsByType(Ext.decode(response.responseText),'web.data.components.Template');
if(this.enableDelete){
dal.getList('web.data.components.Page',true,function(opts,success,response){
var pages=[],originalPages=[];
if(success){
originalPages=Ext.decode(response.responseText);
pages=originalPages.concat(this.app.getSelected('page'))
}
if(originalPages.length){
dal.get('web.data.Site','site',function(opts,success,response){
var recentSiteCfg=Ext.decode(response.responseText),currentSite=this.app.getSite();
if(currentSite.rev===recentSiteCfg.rev){
var siteLinkPages=currentSite.getFolder().getAllPages(),validPageMap={},truePages=[],falsePages=[];
siteLinkPages.forEach(function(linkPage){
validPageMap[linkPage.pageId]=true
});
originalPages.forEach(function(page){
var id=page.id;
if(page.type==='web.data.components.Page'){
if(validPageMap[id]){
truePages.push(page)
}else{
falsePages.push(page)
}
}
});
pages=truePages;
falsePages.forEach(function(page){
dal.deletePart('web.data.components.Page',page.id)
})
}
callback.call(this,this.createModifiedRecords(templates,pages))
},this)
}else{
callback.call(this,this.createModifiedRecords(templates,pages))
}
},this)
}else{
callback.call(this,this.createModifiedRecords(templates))
}
}else{
one.error('<b>'+'Unable to get templates.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.');
callback.call(this,[])
}
},this)
},
fetchRepositoryTemplateRecords:function(callback){
var linkPages,pages,templates,recordConfigs=[],pagesMap={},processRecords=function(){
if(linkPages&&pages&&templates){
this.getLoadMask().hide();
pages.forEach(function(page){
var linkPage=pagesMap[page.id],templateCategories,isPremium;
if(page.templateId){
if(templates[page.templateId]&&templates[page.templateId].categories){
templateCategories=templates[page.templateId].categories;
isPremium=templateCategories.indexOf('premium')>=0
}else{
templateCategories=[]
}
}
if(linkPage){
var isPlaceholderPage=linkPage.getLevel()===2&&linkPage.items[0];
pagesMap[page.id]={
isPlaceholder:isPlaceholderPage,
level:linkPage.getLevel(),
linkPage:linkPage,
preview:this.getScreenshotUrl(isPlaceholderPage?linkPage.items[0].pageId:page.id,760,490),
pageId:page.id,
isPremium:isPremium,
templateId:page.templateId,
templateCategories:templateCategories,
name:linkPage.name,
deletable:false,
subPageIds:Ext.pluck(linkPage.items.filter(function(page){
return page.isPublic()
}),'pageId')
}
}
},this);
linkPages.forEach(function(page){
var record=pagesMap[page.pageId];
if(record){
recordConfigs.push(record)
}
});
callback.call(this,recordConfigs)
}
};
this.getLoadMask().show();
this.repository.get('web.data.Site','site',function(opts,success,response){
var filterFn=this.getFilterFn(pagesMap);
if(success){
this.repositorySiteMap=this.dm.create(Ext.decode(response.responseText));
linkPages=this.repositorySiteMap.getFolder().getLinkPages();
linkPages.forEach(filterFn);
processRecords.call(this)
}else{
one.error('<b>'+'Unable to get templates.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.')
}
},this);
this.repository.getList('web.data.components.Page',true,function(opts,success,response){
if(success){
pages=Ext.decode(response.responseText);
processRecords.call(this)
}else{
one.error('<b>'+'Unable to get templates.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.')
}
},this);
this.repository.getList('web.data.components.Template',true,function(opts,success,response){
var results;
if(success){
templates={};
results=Ext.decode(response.responseText);
results.forEach(function(template){
templates[template.id]=template
});
processRecords.call(this)
}else{
one.error('<b>'+'Unable to get templates.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.')
}
},this)
},
getFilterFn:function(pagesMap){
var filterFn;
if(this.category==='standard'){
filterFn=function(link){
var isSecondLevelPage=link.getLevel()===2;
if(link.isPublic()&&!/^Layout/i.test(link.name)&&!/^empty template/i.test(link.name)&&!/^blank\-template/.test(link.url)&&isSecondLevelPage){
pagesMap[link.pageId]=link
}
}
}else if(this.category==='blank'){
if(this.showMultiPage){
filterFn=function(link){
if(link.isPublic()&&/^empty template/i.test(link.name)&&!/^blank\-template/.test(link.url)){
pagesMap[link.pageId]=link
}
}
}else{
filterFn=function(link){
if(link.isPublic()&&/^empty\-template/.test(link.name)&&!/^blank\-template/.test(link.url)&&link.getParent()&&pagesMap[link.getParent().pageId]===undefined){
pagesMap[link.pageId]=link
}
}
}
}else{
filterFn=Ext.emptyFn
}
return filterFn
},
copyRepositoryTemplateAndStylesheet:function(record,callback){
var templateId=record.templateId,repositoryError='<b>'+'Unable to retrieve repository template.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.',stylesheetError='<b>'+'Could not get stylesheet.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.',saveError='<b>'+'Could not save template.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.',appDm=this.app.dm;
this.repository.getCopyWithDependents(templateId,'web.data.components.Template',function(opts,success,response){
if(success){
var data=Ext.decode(response.responseText);
this.fixMenuComponents(data.template,record);
var template=appDm.create(data.template),stylesheet=appDm.create(data.stylesheet),uidDict=data.uidDict;
this.app.dal.set(stylesheet,function(opts,success,response){
if(success){
this.fixTemplateName(template,function(name){
template.name=name;
opts.jsonData.name=name;
this.app.dal.set(template,function(opts,success,response){
if(success){
callback.call(this,success,template,stylesheet,uidDict)
}else{
one.error(saveError);
callback.call(this,false)
}
},this)
})
}else{
one.error(stylesheetError);
callback.call(this,false)
}
},this)
}else{
one.error(repositoryError);
callback.call(this,false)
}
},this)
},
getScreenshotUrl:function(id,width,height){
return{
'193':{
'193':{
'0002F0CF-FFCC-48D2-A9E4-1914AB4DC1CF':'//webeditor-static.cdn-one.com/0002F0CF-FFCC-48D2-A9E4-1914AB4DC1CF.7cebfb68cd.png',
'00030EC2-BA43-431D-AA22-D0039A2A089A':'//webeditor-static.cdn-one.com/00030EC2-BA43-431D-AA22-D0039A2A089A.cd946d4c56.png',
'0003EA23-32AC-4F79-B1F4-C3E35A37763F':'//webeditor-static.cdn-one.com/0003EA23-32AC-4F79-B1F4-C3E35A37763F.b4178f98b7.png',
'00047E4B-4FBE-4D84-AD0E-6E90C3F5AF0E':'//webeditor-static.cdn-one.com/00047E4B-4FBE-4D84-AD0E-6E90C3F5AF0E.0e0c86c307.png',
'000485CB-BCA8-4131-8E2F-86F91C88DC55':'//webeditor-static.cdn-one.com/000485CB-BCA8-4131-8E2F-86F91C88DC55.ba116bc8c5.png',
'00049ABB-2008-44A4-BC15-157FE89BA34F':'//webeditor-static.cdn-one.com/00049ABB-2008-44A4-BC15-157FE89BA34F.83a8ae8bf1.png',
'00050173-F15F-4682-A552-6AA0ED9F192F':'//webeditor-static.cdn-one.com/00050173-F15F-4682-A552-6AA0ED9F192F.be89a7359d.png',
'00051CAB-9B31-4F73-A089-8A585C5E4B62':'//webeditor-static.cdn-one.com/00051CAB-9B31-4F73-A089-8A585C5E4B62.8d9f757737.png',
'000589E2-CE21-499A-8DC4-71964CC9F4A0':'//webeditor-static.cdn-one.com/000589E2-CE21-499A-8DC4-71964CC9F4A0.64c31e7cc8.png',
'0006F00F-CCE8-4D55-8A97-7B421ED8CDCA':'//webeditor-static.cdn-one.com/0006F00F-CCE8-4D55-8A97-7B421ED8CDCA.7769bdafa4.png',
'0007008A-7BD8-403D-A7AA-F6456781A38E':'//webeditor-static.cdn-one.com/0007008A-7BD8-403D-A7AA-F6456781A38E.9868c87b6e.png',
'00070730-9978-479E-9FBA-92FC6749B783':'//webeditor-static.cdn-one.com/00070730-9978-479E-9FBA-92FC6749B783.d3ea9311f8.png',
'00070748-CD5C-46BB-91C1-D070B317D79C':'//webeditor-static.cdn-one.com/00070748-CD5C-46BB-91C1-D070B317D79C.d4b4968860.png',
'00070754-94C2-46F1-B465-9C47870B71FE':'//webeditor-static.cdn-one.com/00070754-94C2-46F1-B465-9C47870B71FE.7168f88752.png',
'00070766-F60B-457F-B397-A3673344B990':'//webeditor-static.cdn-one.com/00070766-F60B-457F-B397-A3673344B990.058f5a8978.png',
'00070777-F6E6-4017-B303-5B9292C5B193':'//webeditor-static.cdn-one.com/00070777-F6E6-4017-B303-5B9292C5B193.8fce0c0f8e.png',
'00070834-62D1-461B-BF85-CFC4F85DE88A':'//webeditor-static.cdn-one.com/00070834-62D1-461B-BF85-CFC4F85DE88A.76b10f8f95.png',
'00080021-E0DB-4216-B08F-EC7F81E56703':'//webeditor-static.cdn-one.com/00080021-E0DB-4216-B08F-EC7F81E56703.2f9452bd03.png',
'00080101-2DBA-4BD7-93C2-200ACB39A363':'//webeditor-static.cdn-one.com/00080101-2DBA-4BD7-93C2-200ACB39A363.ba2ff4198f.png',
'00081BC7-E018-4D15-B747-6D52FDA7AB8C':'//webeditor-static.cdn-one.com/00081BC7-E018-4D15-B747-6D52FDA7AB8C.39d0d52b85.png',
'000823A3-063F-4E5C-9676-F209B360BC51':'//webeditor-static.cdn-one.com/000823A3-063F-4E5C-9676-F209B360BC51.bf694fdd65.png',
'001731EA-BAF4-426D-ABBB-89356CC12BF2':'//webeditor-static.cdn-one.com/001731EA-BAF4-426D-ABBB-89356CC12BF2.5f3567a7dd.png',
'001C63DB-8AFA-4381-B313-9264DDF02508':'//webeditor-static.cdn-one.com/001C63DB-8AFA-4381-B313-9264DDF02508.4be23b8ae9.png',
'013DB8BA-39E8-486B-AF3A-A48D903DCDBD':'//webeditor-static.cdn-one.com/013DB8BA-39E8-486B-AF3A-A48D903DCDBD.5bb637a396.png',
'0224F05C-E435-4733-A672-FE547D9FB33F':'//webeditor-static.cdn-one.com/0224F05C-E435-4733-A672-FE547D9FB33F.518dfabd63.png',
'03782AF4-B732-44D4-9B17-2B352438A8F7':'//webeditor-static.cdn-one.com/03782AF4-B732-44D4-9B17-2B352438A8F7.5e862cb176.png',
'0539D130-3B66-4115-B6B7-BEF0843229FC':'//webeditor-static.cdn-one.com/0539D130-3B66-4115-B6B7-BEF0843229FC.f98dba8c00.png',
'084AA085-3E96-4BB7-AF97-52B6841485F2':'//webeditor-static.cdn-one.com/084AA085-3E96-4BB7-AF97-52B6841485F2.783442d79b.png',
'1A508E91-3007-4FD8-8BAA-24ACA61AAA68':'//webeditor-static.cdn-one.com/1A508E91-3007-4FD8-8BAA-24ACA61AAA68.5bc17b8ecb.png',
'1C4669D4-606A-43B8-B5EA-6C3BFCC9171A':'//webeditor-static.cdn-one.com/1C4669D4-606A-43B8-B5EA-6C3BFCC9171A.6b37b94844.png',
'1D5A5942-512F-4899-ABD3-4CCDD4D2EEA6':'//webeditor-static.cdn-one.com/1D5A5942-512F-4899-ABD3-4CCDD4D2EEA6.3bdd3fc892.png',
'1EAEF3EB-411E-4EAA-9FDE-5468F5B5754C':'//webeditor-static.cdn-one.com/1EAEF3EB-411E-4EAA-9FDE-5468F5B5754C.1140fb88f4.png',
'204B64BE-2F2D-444D-879E-FC46D800B95A':'//webeditor-static.cdn-one.com/204B64BE-2F2D-444D-879E-FC46D800B95A.f27537e71d.png',
'23E5F695-A336-415F-8EDE-86F727E54ACE':'//webeditor-static.cdn-one.com/23E5F695-A336-415F-8EDE-86F727E54ACE.b798b75109.png',
'25F00AC7-18E9-4525-A670-4351CEF8FDA8':'//webeditor-static.cdn-one.com/25F00AC7-18E9-4525-A670-4351CEF8FDA8.9cd7070270.png',
'2685289B-22DA-4B34-A683-55E9AFC22105':'//webeditor-static.cdn-one.com/2685289B-22DA-4B34-A683-55E9AFC22105.4e9344c09e.png',
'2AEAE987-A2B8-4EAA-A47A-819314099BF2':'//webeditor-static.cdn-one.com/2AEAE987-A2B8-4EAA-A47A-819314099BF2.bf0a2372c0.png',
'2C44F84E-A6E1-413F-A3F3-5644138137A3':'//webeditor-static.cdn-one.com/2C44F84E-A6E1-413F-A3F3-5644138137A3.0a4d892308.png',
'2E30034F-1AF6-4230-997D-6F48AF1B0011':'//webeditor-static.cdn-one.com/2E30034F-1AF6-4230-997D-6F48AF1B0011.116103fd30.png',
'3043CD74-B431-4AAE-8C0F-A4D93A82AE72':'//webeditor-static.cdn-one.com/3043CD74-B431-4AAE-8C0F-A4D93A82AE72.114564aba7.png',
'311EB8FA-A458-478B-AB21-FD2F7F4FD396':'//webeditor-static.cdn-one.com/311EB8FA-A458-478B-AB21-FD2F7F4FD396.50b1492ec5.png',
'334BBBC7-4FA8-446C-B74D-05735EAA1097':'//webeditor-static.cdn-one.com/334BBBC7-4FA8-446C-B74D-05735EAA1097.972794d94f.png',
'34061178-2E48-4F01-AF05-799E56AC9835':'//webeditor-static.cdn-one.com/34061178-2E48-4F01-AF05-799E56AC9835.06a60fd05f.png',
'34AA3CB7-85D6-4EEB-BA1C-59BE944196FF':'//webeditor-static.cdn-one.com/34AA3CB7-85D6-4EEB-BA1C-59BE944196FF.cdd2787a0c.png',
'3DA86168-AE0B-4931-A922-505298DBD838':'//webeditor-static.cdn-one.com/3DA86168-AE0B-4931-A922-505298DBD838.37fec071e7.png',
'3FD90757-BE66-472E-8101-39727602F40A':'//webeditor-static.cdn-one.com/3FD90757-BE66-472E-8101-39727602F40A.c6046359bc.png',
'42AD43FA-86AC-40EC-817A-D902EB5A2646':'//webeditor-static.cdn-one.com/42AD43FA-86AC-40EC-817A-D902EB5A2646.ae4ab07e8c.png',
'4B88778E-0844-4F29-8C48-25ADD979BE07':'//webeditor-static.cdn-one.com/4B88778E-0844-4F29-8C48-25ADD979BE07.2da4d74817.png',
'4F069106-1AFB-44A0-932C-23AC4E48D717':'//webeditor-static.cdn-one.com/4F069106-1AFB-44A0-932C-23AC4E48D717.1e0fe05891.png',
'54800989-B457-4B9C-83F1-65F53E137C6E':'//webeditor-static.cdn-one.com/54800989-B457-4B9C-83F1-65F53E137C6E.4a7940d1c5.png',
'5658EEBA-488C-463E-A7FE-668EF0C19874':'//webeditor-static.cdn-one.com/5658EEBA-488C-463E-A7FE-668EF0C19874.de8a68c5bd.png',
'56F81F12-2D3C-40E2-9663-C737ED560687':'//webeditor-static.cdn-one.com/56F81F12-2D3C-40E2-9663-C737ED560687.f01a150d6e.png',
'58896882-CB5A-4CC1-992E-31E2B90BF944':'//webeditor-static.cdn-one.com/58896882-CB5A-4CC1-992E-31E2B90BF944.b24416c7e5.png',
'5973DB30-E0E9-4B79-9B01-A6A4803A5B06':'//webeditor-static.cdn-one.com/5973DB30-E0E9-4B79-9B01-A6A4803A5B06.c632cfc816.png',
'5B0B340F-9400-4984-9F75-313A054FCD1E':'//webeditor-static.cdn-one.com/5B0B340F-9400-4984-9F75-313A054FCD1E.aba3cf9a2a.png',
'5E510A6D-585F-4578-89B5-F62FCCB3F9B7':'//webeditor-static.cdn-one.com/5E510A6D-585F-4578-89B5-F62FCCB3F9B7.9a3d456c40.png',
'607B35C9-EF6E-4608-B895-2C48E5604BED':'//webeditor-static.cdn-one.com/607B35C9-EF6E-4608-B895-2C48E5604BED.943fb71ca2.png',
'61B045BC-A215-4DAF-B009-CABD03BB162E':'//webeditor-static.cdn-one.com/61B045BC-A215-4DAF-B009-CABD03BB162E.8f3e03877f.png',
'6462FADC-98D5-4B29-A7DA-2103F9DE5E9B':'//webeditor-static.cdn-one.com/6462FADC-98D5-4B29-A7DA-2103F9DE5E9B.f58e602280.png',
'6483B0E7-059E-4314-8363-C7FB1F3A6CB6':'//webeditor-static.cdn-one.com/6483B0E7-059E-4314-8363-C7FB1F3A6CB6.2a57d7c497.png',
'672EAAD3-66D9-41DB-AA81-1C0EFA461195':'//webeditor-static.cdn-one.com/672EAAD3-66D9-41DB-AA81-1C0EFA461195.6a6e2f4425.png',
'68A1CEC5-8443-49DA-A69E-10FD4EC1158A':'//webeditor-static.cdn-one.com/68A1CEC5-8443-49DA-A69E-10FD4EC1158A.9abad7631a.png',
'6945C55A-DB8F-4511-93EA-0AA6330D841C':'//webeditor-static.cdn-one.com/6945C55A-DB8F-4511-93EA-0AA6330D841C.069d8bd1de.png',
'6A590330-67C5-4CEC-A873-5AFB5D6A5B03':'//webeditor-static.cdn-one.com/6A590330-67C5-4CEC-A873-5AFB5D6A5B03.4b383cf1ad.png',
'6A89F07A-DA86-4645-8D7C-C569598B0570':'//webeditor-static.cdn-one.com/6A89F07A-DA86-4645-8D7C-C569598B0570.aee01dd996.png',
'6FBD0F95-644B-4366-9EA7-9A2D230AFEB7':'//webeditor-static.cdn-one.com/6FBD0F95-644B-4366-9EA7-9A2D230AFEB7.ba0a1afad4.png',
'724DC003-F351-4D99-B050-CA77A7F813AF':'//webeditor-static.cdn-one.com/724DC003-F351-4D99-B050-CA77A7F813AF.9a49ec590c.png',
'73F9B328-08DC-46B8-A2B8-00A9EDFD23F1':'//webeditor-static.cdn-one.com/73F9B328-08DC-46B8-A2B8-00A9EDFD23F1.ce587262c0.png',
'7434549F-3501-4637-B58C-028A7282733E':'//webeditor-static.cdn-one.com/7434549F-3501-4637-B58C-028A7282733E.82708e3c96.png',
'788775F0-0568-458E-AA05-1FF98F9D16AC':'//webeditor-static.cdn-one.com/788775F0-0568-458E-AA05-1FF98F9D16AC.03bd0c8ba9.png',
'7DC3462C-86E8-43D1-AC14-95B9F3CAB7F5':'//webeditor-static.cdn-one.com/7DC3462C-86E8-43D1-AC14-95B9F3CAB7F5.bf0dd3c65d.png',
'7EBF7B3F-AB9C-4BE3-8AA3-F2BCABA29308':'//webeditor-static.cdn-one.com/7EBF7B3F-AB9C-4BE3-8AA3-F2BCABA29308.e16e15e5a2.png',
'86E66F0E-B615-491E-AB93-02EA26E739DF':'//webeditor-static.cdn-one.com/86E66F0E-B615-491E-AB93-02EA26E739DF.395f1f1abf.png',
'8BE71EDA-8B36-4308-8F93-0BFF9D48011F':'//webeditor-static.cdn-one.com/8BE71EDA-8B36-4308-8F93-0BFF9D48011F.fc1177a373.png',
'8E6DAEEB-2149-4D7B-B0B7-48833D6674F9':'//webeditor-static.cdn-one.com/8E6DAEEB-2149-4D7B-B0B7-48833D6674F9.2ee304d391.png',
'90E6AE18-E966-411E-A206-A39CC4249640':'//webeditor-static.cdn-one.com/90E6AE18-E966-411E-A206-A39CC4249640.a3671b4707.png',
'92D17A27-C501-4C1A-9B74-7F2126D476AA':'//webeditor-static.cdn-one.com/92D17A27-C501-4C1A-9B74-7F2126D476AA.98484a2549.png',
'9372BB7F-C33D-4490-8FC1-D9C1748F1B00':'//webeditor-static.cdn-one.com/9372BB7F-C33D-4490-8FC1-D9C1748F1B00.c61c30fa04.png',
'93C20709-9258-4424-8FED-00C0E4F182FE':'//webeditor-static.cdn-one.com/93C20709-9258-4424-8FED-00C0E4F182FE.52ec4a48c2.png',
'9773A4DE-7F3D-480D-806C-47F2072A09F3':'//webeditor-static.cdn-one.com/9773A4DE-7F3D-480D-806C-47F2072A09F3.5af75d8746.png',
'97E75564-601B-4E2D-ADE4-C404293BCEB0':'//webeditor-static.cdn-one.com/97E75564-601B-4E2D-ADE4-C404293BCEB0.8550e2aac6.png',
'98709062-2541-49E5-B719-2BD8EDCEAE34':'//webeditor-static.cdn-one.com/98709062-2541-49E5-B719-2BD8EDCEAE34.5c02eba02f.png',
'98B05EE6-3FF7-4225-8E6C-B364A4D5A4E7':'//webeditor-static.cdn-one.com/98B05EE6-3FF7-4225-8E6C-B364A4D5A4E7.77e2f1941d.png',
'998163D4-6628-4431-9649-39330FF7B1DD':'//webeditor-static.cdn-one.com/998163D4-6628-4431-9649-39330FF7B1DD.424a21094d.png',
'99C5C747-AEE0-4A65-B67F-0D21D4BC7DD8':'//webeditor-static.cdn-one.com/99C5C747-AEE0-4A65-B67F-0D21D4BC7DD8.c14fbae6b1.png',
'9C098D93-215C-4FEC-9920-AF5F689477B7':'//webeditor-static.cdn-one.com/9C098D93-215C-4FEC-9920-AF5F689477B7.035e1a859d.png',
'9C51F5A7-A55E-480E-873C-866C6D9CED96':'//webeditor-static.cdn-one.com/9C51F5A7-A55E-480E-873C-866C6D9CED96.2824e706c0.png',
'A1405D9D-9BE1-4AC5-8604-BE6E20F61A7E':'//webeditor-static.cdn-one.com/A1405D9D-9BE1-4AC5-8604-BE6E20F61A7E.cb4749dac1.png',
'A4227214-40D6-4018-8FED-EFA5B616A7CA':'//webeditor-static.cdn-one.com/A4227214-40D6-4018-8FED-EFA5B616A7CA.77a65ab010.png',
'A4F8FDA5-2AA3-437E-BF0A-904A71B79BD3':'//webeditor-static.cdn-one.com/A4F8FDA5-2AA3-437E-BF0A-904A71B79BD3.a2c2560742.png',
'A51F9476-AC94-41E2-B494-4A42397348F9':'//webeditor-static.cdn-one.com/A51F9476-AC94-41E2-B494-4A42397348F9.5184861de2.png',
'A6B6C9A1-12E6-4B64-8100-460D635BF984':'//webeditor-static.cdn-one.com/A6B6C9A1-12E6-4B64-8100-460D635BF984.07460154d4.png',
'AA325A34-B75F-4838-B136-33296A0F63D2':'//webeditor-static.cdn-one.com/AA325A34-B75F-4838-B136-33296A0F63D2.a77182463d.png',
'AB52975E-0967-4B51-8DA9-785D6F9A3C79':'//webeditor-static.cdn-one.com/AB52975E-0967-4B51-8DA9-785D6F9A3C79.4edc27aa7b.png',
'ABDE7B7D-C2D2-4B0F-8A05-CD93FF231B43':'//webeditor-static.cdn-one.com/ABDE7B7D-C2D2-4B0F-8A05-CD93FF231B43.77a6ff375a.png',
'AD9F5937-B233-4AE6-9EB5-F2B5B8085661':'//webeditor-static.cdn-one.com/AD9F5937-B233-4AE6-9EB5-F2B5B8085661.15740aea05.png',
'B25A8465-F523-41D7-B049-FB3ED84917E0':'//webeditor-static.cdn-one.com/B25A8465-F523-41D7-B049-FB3ED84917E0.88d94f3857.png',
'B4B2FAB4-51EE-4724-870A-74FDD98B307B':'//webeditor-static.cdn-one.com/B4B2FAB4-51EE-4724-870A-74FDD98B307B.962a6fee52.png',
'B4F12329-05EB-40E2-BE7E-BD36C0491D8D':'//webeditor-static.cdn-one.com/B4F12329-05EB-40E2-BE7E-BD36C0491D8D.9d7735003b.png',
'B672CFDA-B43F-4B45-992C-B38A6320EC3A':'//webeditor-static.cdn-one.com/B672CFDA-B43F-4B45-992C-B38A6320EC3A.cc826580bb.png',
'B9E93092-C3DA-445A-A81B-8B1A027F1EE6':'//webeditor-static.cdn-one.com/B9E93092-C3DA-445A-A81B-8B1A027F1EE6.615867eb78.png',
'C14C7795-A390-4B21-860A-C02A36B0DB0D':'//webeditor-static.cdn-one.com/C14C7795-A390-4B21-860A-C02A36B0DB0D.79b621ed81.png',
'C179F788-A044-49E3-AF4D-2D27CBD60E5A':'//webeditor-static.cdn-one.com/C179F788-A044-49E3-AF4D-2D27CBD60E5A.faf89b9b3e.png',
'C685C25D-636C-402B-9F93-26B3D4460920':'//webeditor-static.cdn-one.com/C685C25D-636C-402B-9F93-26B3D4460920.2eae026688.png',
'CFB7058C-1454-4C1B-8E83-7BFF8EF61823':'//webeditor-static.cdn-one.com/CFB7058C-1454-4C1B-8E83-7BFF8EF61823.36be2c0af2.png',
'D16D963A-BF9C-4463-9937-2E2CE154F6DD':'//webeditor-static.cdn-one.com/D16D963A-BF9C-4463-9937-2E2CE154F6DD.a5de307650.png',
'D3FAB447-C620-4ECC-9582-25B60ED8D942':'//webeditor-static.cdn-one.com/D3FAB447-C620-4ECC-9582-25B60ED8D942.6e2dc13097.png',
'D73C7D3F-DCD7-4370-86A4-490A44136013':'//webeditor-static.cdn-one.com/D73C7D3F-DCD7-4370-86A4-490A44136013.01aaec544e.png',
'D82E5828-0612-4B4D-95E1-50668553442F':'//webeditor-static.cdn-one.com/D82E5828-0612-4B4D-95E1-50668553442F.c4ff20fb56.png',
'DA2CFBCD-2C75-4948-8B4E-1598383D5113':'//webeditor-static.cdn-one.com/DA2CFBCD-2C75-4948-8B4E-1598383D5113.4f9e5e4fe4.png',
'DAB59EC3-648B-4095-B233-1D935C33E2F6':'//webeditor-static.cdn-one.com/DAB59EC3-648B-4095-B233-1D935C33E2F6.f3e4ee7f65.png',
'DB127167-B1F2-414B-9314-1D0F59FB1EB5':'//webeditor-static.cdn-one.com/DB127167-B1F2-414B-9314-1D0F59FB1EB5.0449a809e0.png',
'DDDF9E1C-E288-454B-B20D-2E5CA55E22B6':'//webeditor-static.cdn-one.com/DDDF9E1C-E288-454B-B20D-2E5CA55E22B6.ed65b070c4.png',
'DFF82427-AC15-4AA4-96A8-C9D137E851CA':'//webeditor-static.cdn-one.com/DFF82427-AC15-4AA4-96A8-C9D137E851CA.c5a81aa988.png',
'E1FAD3A0-50DA-4B5F-99A7-B59BC46568BF':'//webeditor-static.cdn-one.com/E1FAD3A0-50DA-4B5F-99A7-B59BC46568BF.9333fe476e.png',
'EBD0C7E9-CDC5-4192-AFB9-3CD3D1116E8A':'//webeditor-static.cdn-one.com/EBD0C7E9-CDC5-4192-AFB9-3CD3D1116E8A.32da1ea64d.png',
'EF6525A1-4EDE-4DF0-832B-86501AD62D4F':'//webeditor-static.cdn-one.com/EF6525A1-4EDE-4DF0-832B-86501AD62D4F.7876fff919.png',
'EF8636B4-D274-4B36-A3B9-3CF1A576C565':'//webeditor-static.cdn-one.com/EF8636B4-D274-4B36-A3B9-3CF1A576C565.18c9b3a65b.png',
'F461723F-15FB-4AC9-A6DB-A67C3F29003A':'//webeditor-static.cdn-one.com/F461723F-15FB-4AC9-A6DB-A67C3F29003A.901966530e.png',
'F81C2E32-22AE-48BC-AF06-2DE61B0EF699':'//webeditor-static.cdn-one.com/F81C2E32-22AE-48BC-AF06-2DE61B0EF699.539a370c87.png',
'F8B2BD28-2441-4B95-BC9C-9F439796C17F':'//webeditor-static.cdn-one.com/F8B2BD28-2441-4B95-BC9C-9F439796C17F.03cef321fa.png',
'FBD16911-F3B2-492E-99A9-F5820E013F1A':'//webeditor-static.cdn-one.com/FBD16911-F3B2-492E-99A9-F5820E013F1A.2f97bbf096.png'
}
},
'760':{
'490':{
'001731EA-BAF4-426D-ABBB-89356CC12BF2':'//webeditor-static.cdn-one.com/001731EA-BAF4-426D-ABBB-89356CC12BF2.413f6ba4c1.png',
'0224F05C-E435-4733-A672-FE547D9FB33F':'//webeditor-static.cdn-one.com/0224F05C-E435-4733-A672-FE547D9FB33F.162d5f8bd8.png',
'03782AF4-B732-44D4-9B17-2B352438A8F7':'//webeditor-static.cdn-one.com/03782AF4-B732-44D4-9B17-2B352438A8F7.78b440f37f.png',
'0539D130-3B66-4115-B6B7-BEF0843229FC':'//webeditor-static.cdn-one.com/0539D130-3B66-4115-B6B7-BEF0843229FC.6a2b9d622f.png',
'060E9FC1-C3F1-47EF-A339-26B813F95FE2':'//webeditor-static.cdn-one.com/060E9FC1-C3F1-47EF-A339-26B813F95FE2.c9bfd9c85c.png',
'07C057DE-6B9F-4054-AC3B-8A18D5576458':'//webeditor-static.cdn-one.com/07C057DE-6B9F-4054-AC3B-8A18D5576458.3b4b6d1f1a.png',
'084AA085-3E96-4BB7-AF97-52B6841485F2':'//webeditor-static.cdn-one.com/084AA085-3E96-4BB7-AF97-52B6841485F2.12fff9b789.png',
'0D05EBAB-5B57-4AFC-B37F-D74C184DC330':'//webeditor-static.cdn-one.com/0D05EBAB-5B57-4AFC-B37F-D74C184DC330.0353eddbf5.png',
'125D220F-8FDC-4213-B966-E2F5FC03FDF5':'//webeditor-static.cdn-one.com/125D220F-8FDC-4213-B966-E2F5FC03FDF5.c75ad8599b.png',
'176BC94D-2465-40B9-B85B-C252B145777D':'//webeditor-static.cdn-one.com/176BC94D-2465-40B9-B85B-C252B145777D.30b6ef8bc0.png',
'1921575B-E4B7-40D9-A71D-F831DD78465E':'//webeditor-static.cdn-one.com/1921575B-E4B7-40D9-A71D-F831DD78465E.6f9dd02b98.png',
'19C01FE6-985B-4FAA-A702-1EB4A9AEFBBA':'//webeditor-static.cdn-one.com/19C01FE6-985B-4FAA-A702-1EB4A9AEFBBA.8fbade26ff.png',
'1A508E91-3007-4FD8-8BAA-24ACA61AAA68':'//webeditor-static.cdn-one.com/1A508E91-3007-4FD8-8BAA-24ACA61AAA68.95249260c8.png',
'1BBC770F-EDEA-478C-844B-49EE79B11AC3':'//webeditor-static.cdn-one.com/1BBC770F-EDEA-478C-844B-49EE79B11AC3.d81302869a.png',
'1C4669D4-606A-43B8-B5EA-6C3BFCC9171A':'//webeditor-static.cdn-one.com/1C4669D4-606A-43B8-B5EA-6C3BFCC9171A.f561a28c9c.png',
'1CF91525-45D5-45DD-8356-01676A31DE36':'//webeditor-static.cdn-one.com/1CF91525-45D5-45DD-8356-01676A31DE36.e14337b0e5.png',
'1D37228D-FD7B-4EB5-A860-749D5BE194C3':'//webeditor-static.cdn-one.com/1D37228D-FD7B-4EB5-A860-749D5BE194C3.cdb8be5074.png',
'1EAEF3EB-411E-4EAA-9FDE-5468F5B5754C':'//webeditor-static.cdn-one.com/1EAEF3EB-411E-4EAA-9FDE-5468F5B5754C.345a6844df.png',
'22C2E58D-C04B-49C7-A5AA-CF94087F2772':'//webeditor-static.cdn-one.com/22C2E58D-C04B-49C7-A5AA-CF94087F2772.d8112ae9e3.png',
'23583321-A2F2-4478-A996-7A99EA6541C2':'//webeditor-static.cdn-one.com/23583321-A2F2-4478-A996-7A99EA6541C2.55629d6f25.png',
'23E5F695-A336-415F-8EDE-86F727E54ACE':'//webeditor-static.cdn-one.com/23E5F695-A336-415F-8EDE-86F727E54ACE.9e4cf4d083.png',
'25A9B706-70F2-4C76-9CAE-284251B469B6':'//webeditor-static.cdn-one.com/25A9B706-70F2-4C76-9CAE-284251B469B6.7a264b1249.png',
'2685289B-22DA-4B34-A683-55E9AFC22105':'//webeditor-static.cdn-one.com/2685289B-22DA-4B34-A683-55E9AFC22105.ee5262e4ce.png',
'2E30034F-1AF6-4230-997D-6F48AF1B0011':'//webeditor-static.cdn-one.com/2E30034F-1AF6-4230-997D-6F48AF1B0011.322921ff1c.png',
'2FA166B9-4BE6-4BA0-98B6-DE96BAD3F2BA':'//webeditor-static.cdn-one.com/2FA166B9-4BE6-4BA0-98B6-DE96BAD3F2BA.629ba2cd29.png',
'3043CD74-B431-4AAE-8C0F-A4D93A82AE72':'//webeditor-static.cdn-one.com/3043CD74-B431-4AAE-8C0F-A4D93A82AE72.f087d4fc10.png',
'311EB8FA-A458-478B-AB21-FD2F7F4FD396':'//webeditor-static.cdn-one.com/311EB8FA-A458-478B-AB21-FD2F7F4FD396.e16fb4790a.png',
'334BBBC7-4FA8-446C-B74D-05735EAA1097':'//webeditor-static.cdn-one.com/334BBBC7-4FA8-446C-B74D-05735EAA1097.ec9f86004f.png',
'34061178-2E48-4F01-AF05-799E56AC9835':'//webeditor-static.cdn-one.com/34061178-2E48-4F01-AF05-799E56AC9835.f2bcb64457.png',
'34AA3CB7-85D6-4EEB-BA1C-59BE944196FF':'//webeditor-static.cdn-one.com/34AA3CB7-85D6-4EEB-BA1C-59BE944196FF.445240a1a9.png',
'3D50B879-D6BA-4E9C-8AD1-D1BE07EB8BDC':'//webeditor-static.cdn-one.com/3D50B879-D6BA-4E9C-8AD1-D1BE07EB8BDC.9399038b6a.png',
'3DB6416A-DF5F-47E5-8026-CDDA622DAC83':'//webeditor-static.cdn-one.com/3DB6416A-DF5F-47E5-8026-CDDA622DAC83.df9c5a1676.png',
'42CD1A9F-F9A5-499C-96FA-4B2AF07596A3':'//webeditor-static.cdn-one.com/42CD1A9F-F9A5-499C-96FA-4B2AF07596A3.48b13a3ae2.png',
'43832C0D-2A58-4B22-9C37-6DA817CD2EA5':'//webeditor-static.cdn-one.com/43832C0D-2A58-4B22-9C37-6DA817CD2EA5.835d98cb82.png',
'43B86FE4-41B7-474A-AFC1-508261E6504A':'//webeditor-static.cdn-one.com/43B86FE4-41B7-474A-AFC1-508261E6504A.7f41660624.png',
'4B88778E-0844-4F29-8C48-25ADD979BE07':'//webeditor-static.cdn-one.com/4B88778E-0844-4F29-8C48-25ADD979BE07.fe91e56c31.png',
'4F069106-1AFB-44A0-932C-23AC4E48D717':'//webeditor-static.cdn-one.com/4F069106-1AFB-44A0-932C-23AC4E48D717.362514e52c.png',
'54800989-B457-4B9C-83F1-65F53E137C6E':'//webeditor-static.cdn-one.com/54800989-B457-4B9C-83F1-65F53E137C6E.d7d9d6649a.png',
'54D6A027-D2A9-43D5-843C-B9FA7DA27AAC':'//webeditor-static.cdn-one.com/54D6A027-D2A9-43D5-843C-B9FA7DA27AAC.6260808914.png',
'58896882-CB5A-4CC1-992E-31E2B90BF944':'//webeditor-static.cdn-one.com/58896882-CB5A-4CC1-992E-31E2B90BF944.13189f9f37.png',
'5973DB30-E0E9-4B79-9B01-A6A4803A5B06':'//webeditor-static.cdn-one.com/5973DB30-E0E9-4B79-9B01-A6A4803A5B06.37380d4212.png',
'5B0B340F-9400-4984-9F75-313A054FCD1E':'//webeditor-static.cdn-one.com/5B0B340F-9400-4984-9F75-313A054FCD1E.b05f8a8f0f.png',
'5C5852E3-3BB3-46C1-9D1E-F7C7EDD008E5':'//webeditor-static.cdn-one.com/5C5852E3-3BB3-46C1-9D1E-F7C7EDD008E5.32890b1a01.png',
'5D06CBB0-1BB5-4C58-82E3-BC46594BB9EF':'//webeditor-static.cdn-one.com/5D06CBB0-1BB5-4C58-82E3-BC46594BB9EF.5a2beb5928.png',
'5E510A6D-585F-4578-89B5-F62FCCB3F9B7':'//webeditor-static.cdn-one.com/5E510A6D-585F-4578-89B5-F62FCCB3F9B7.544a986712.png',
'607B35C9-EF6E-4608-B895-2C48E5604BED':'//webeditor-static.cdn-one.com/607B35C9-EF6E-4608-B895-2C48E5604BED.e3eb79f786.png',
'6462FADC-98D5-4B29-A7DA-2103F9DE5E9B':'//webeditor-static.cdn-one.com/6462FADC-98D5-4B29-A7DA-2103F9DE5E9B.950c2e3fab.png',
'6483B0E7-059E-4314-8363-C7FB1F3A6CB6':'//webeditor-static.cdn-one.com/6483B0E7-059E-4314-8363-C7FB1F3A6CB6.fda208302e.png',
'667E3A08-C999-447A-9618-1F30C71B580C':'//webeditor-static.cdn-one.com/667E3A08-C999-447A-9618-1F30C71B580C.bf9dd1bb25.png',
'672EAAD3-66D9-41DB-AA81-1C0EFA461195':'//webeditor-static.cdn-one.com/672EAAD3-66D9-41DB-AA81-1C0EFA461195.7ea545a9d4.png',
'68A1CEC5-8443-49DA-A69E-10FD4EC1158A':'//webeditor-static.cdn-one.com/68A1CEC5-8443-49DA-A69E-10FD4EC1158A.8b2f0e4c69.png',
'68C76818-E65B-47A3-9596-6E17D6F12AD3':'//webeditor-static.cdn-one.com/68C76818-E65B-47A3-9596-6E17D6F12AD3.44cb9b7fb4.png',
'6945C55A-DB8F-4511-93EA-0AA6330D841C':'//webeditor-static.cdn-one.com/6945C55A-DB8F-4511-93EA-0AA6330D841C.66a797ee90.png',
'6A89F07A-DA86-4645-8D7C-C569598B0570':'//webeditor-static.cdn-one.com/6A89F07A-DA86-4645-8D7C-C569598B0570.6b177b4547.png',
'7058BCCD-D968-41AC-8347-BA25E75A346B':'//webeditor-static.cdn-one.com/7058BCCD-D968-41AC-8347-BA25E75A346B.297bab538e.png',
'724DC003-F351-4D99-B050-CA77A7F813AF':'//webeditor-static.cdn-one.com/724DC003-F351-4D99-B050-CA77A7F813AF.2105c2fdea.png',
'7434549F-3501-4637-B58C-028A7282733E':'//webeditor-static.cdn-one.com/7434549F-3501-4637-B58C-028A7282733E.c028aa1517.png',
'788775F0-0568-458E-AA05-1FF98F9D16AC':'//webeditor-static.cdn-one.com/788775F0-0568-458E-AA05-1FF98F9D16AC.4f975cd887.png',
'7DC3462C-86E8-43D1-AC14-95B9F3CAB7F5':'//webeditor-static.cdn-one.com/7DC3462C-86E8-43D1-AC14-95B9F3CAB7F5.300bceaef1.png',
'89267991-7599-4403-973C-5EAA3783B1E7':'//webeditor-static.cdn-one.com/89267991-7599-4403-973C-5EAA3783B1E7.c592d3621f.png',
'90E6AE18-E966-411E-A206-A39CC4249640':'//webeditor-static.cdn-one.com/90E6AE18-E966-411E-A206-A39CC4249640.a0354b49c6.png',
'917F5067-7446-4224-A3CA-A36F33793407':'//webeditor-static.cdn-one.com/917F5067-7446-4224-A3CA-A36F33793407.bac28592fb.png',
'92D17A27-C501-4C1A-9B74-7F2126D476AA':'//webeditor-static.cdn-one.com/92D17A27-C501-4C1A-9B74-7F2126D476AA.ea2d6ff59b.png',
'93C20709-9258-4424-8FED-00C0E4F182FE':'//webeditor-static.cdn-one.com/93C20709-9258-4424-8FED-00C0E4F182FE.d5d952c38c.png',
'9773A4DE-7F3D-480D-806C-47F2072A09F3':'//webeditor-static.cdn-one.com/9773A4DE-7F3D-480D-806C-47F2072A09F3.5bc3d3bb3b.png',
'98709062-2541-49E5-B719-2BD8EDCEAE34':'//webeditor-static.cdn-one.com/98709062-2541-49E5-B719-2BD8EDCEAE34.4769ece186.png',
'98B05EE6-3FF7-4225-8E6C-B364A4D5A4E7':'//webeditor-static.cdn-one.com/98B05EE6-3FF7-4225-8E6C-B364A4D5A4E7.fac00c26ae.png',
'998163D4-6628-4431-9649-39330FF7B1DD':'//webeditor-static.cdn-one.com/998163D4-6628-4431-9649-39330FF7B1DD.b7a14eda26.png',
'A0392AC0-A1A4-440C-9D8B-B31EF1AEF6DE':'//webeditor-static.cdn-one.com/A0392AC0-A1A4-440C-9D8B-B31EF1AEF6DE.ff0d2c8a80.png',
'A1405D9D-9BE1-4AC5-8604-BE6E20F61A7E':'//webeditor-static.cdn-one.com/A1405D9D-9BE1-4AC5-8604-BE6E20F61A7E.f62d91227f.png',
'A33A597A-F6E4-45A6-9AED-FE31C04904FA':'//webeditor-static.cdn-one.com/A33A597A-F6E4-45A6-9AED-FE31C04904FA.506e51b22d.png',
'A4642118-4EC6-40C1-8426-C2FC9844AF65':'//webeditor-static.cdn-one.com/A4642118-4EC6-40C1-8426-C2FC9844AF65.d24925efe4.png',
'A4F8FDA5-2AA3-437E-BF0A-904A71B79BD3':'//webeditor-static.cdn-one.com/A4F8FDA5-2AA3-437E-BF0A-904A71B79BD3.e719564188.png',
'A54D51AD-CC01-4463-B3B7-2DBD9A6FEF37':'//webeditor-static.cdn-one.com/A54D51AD-CC01-4463-B3B7-2DBD9A6FEF37.5da50e1cc9.png',
'A6B6C9A1-12E6-4B64-8100-460D635BF984':'//webeditor-static.cdn-one.com/A6B6C9A1-12E6-4B64-8100-460D635BF984.ffc3e8e846.png',
'A6D6D8E6-7CCD-48E3-98B8-225B15169B7C':'//webeditor-static.cdn-one.com/A6D6D8E6-7CCD-48E3-98B8-225B15169B7C.cf8e05c5d9.png',
'ABDE7B7D-C2D2-4B0F-8A05-CD93FF231B43':'//webeditor-static.cdn-one.com/ABDE7B7D-C2D2-4B0F-8A05-CD93FF231B43.f88e52b5cf.png',
'AFE0D697-B31D-4D3C-8BAE-F6E030894CF0':'//webeditor-static.cdn-one.com/AFE0D697-B31D-4D3C-8BAE-F6E030894CF0.7cc492a7ff.png',
'B12D4879-CD6B-430C-BB6C-992E925FD88B':'//webeditor-static.cdn-one.com/B12D4879-CD6B-430C-BB6C-992E925FD88B.237e532127.png',
'B35C53DD-5C8C-470F-8DA8-2153976EECE9':'//webeditor-static.cdn-one.com/B35C53DD-5C8C-470F-8DA8-2153976EECE9.f4b91e30e4.png',
'B4F12329-05EB-40E2-BE7E-BD36C0491D8D':'//webeditor-static.cdn-one.com/B4F12329-05EB-40E2-BE7E-BD36C0491D8D.412aa9df9c.png',
'B672CFDA-B43F-4B45-992C-B38A6320EC3A':'//webeditor-static.cdn-one.com/B672CFDA-B43F-4B45-992C-B38A6320EC3A.961c37788e.png',
'B6F2ED9D-A152-4959-A8F8-58F0C6E22FD1':'//webeditor-static.cdn-one.com/B6F2ED9D-A152-4959-A8F8-58F0C6E22FD1.4ee349ebcd.png',
'BCA2C9D5-7C5A-49D0-86D1-3A7E5961B2B5':'//webeditor-static.cdn-one.com/BCA2C9D5-7C5A-49D0-86D1-3A7E5961B2B5.ee9915771f.png',
'C14552AC-8DB7-4150-AB51-9B73B9401FC4':'//webeditor-static.cdn-one.com/C14552AC-8DB7-4150-AB51-9B73B9401FC4.e5eabf5ad2.png',
'C14C7795-A390-4B21-860A-C02A36B0DB0D':'//webeditor-static.cdn-one.com/C14C7795-A390-4B21-860A-C02A36B0DB0D.81ada818b0.png',
'C179F788-A044-49E3-AF4D-2D27CBD60E5A':'//webeditor-static.cdn-one.com/C179F788-A044-49E3-AF4D-2D27CBD60E5A.01ea7e46f5.png',
'C337552B-49CB-400F-8A27-0F7E739A9C96':'//webeditor-static.cdn-one.com/C337552B-49CB-400F-8A27-0F7E739A9C96.db7175741b.png',
'C3566464-F522-4956-BAFE-DC1EC8346905':'//webeditor-static.cdn-one.com/C3566464-F522-4956-BAFE-DC1EC8346905.27d0669714.png',
'C3F11272-1DAB-4E12-893C-DE32C78E2AFE':'//webeditor-static.cdn-one.com/C3F11272-1DAB-4E12-893C-DE32C78E2AFE.eaeba81c9c.png',
'C90CB248-F914-4E98-ADAF-F68C880B4057':'//webeditor-static.cdn-one.com/C90CB248-F914-4E98-ADAF-F68C880B4057.13c3eb587f.png',
'CB414496-EBCA-444A-9637-2F84BBF342E1':'//webeditor-static.cdn-one.com/CB414496-EBCA-444A-9637-2F84BBF342E1.7258ca215d.png',
'CE38524B-4C39-40DD-835C-BCCC910C6C70':'//webeditor-static.cdn-one.com/CE38524B-4C39-40DD-835C-BCCC910C6C70.9dab31a022.png',
'CE626112-0612-4A55-805E-0E91AB00BDBA':'//webeditor-static.cdn-one.com/CE626112-0612-4A55-805E-0E91AB00BDBA.1a5f83a723.png',
'D16D963A-BF9C-4463-9937-2E2CE154F6DD':'//webeditor-static.cdn-one.com/D16D963A-BF9C-4463-9937-2E2CE154F6DD.109dd59afe.png',
'D3FB1D53-3D5B-4014-BFF6-C03B22371004':'//webeditor-static.cdn-one.com/D3FB1D53-3D5B-4014-BFF6-C03B22371004.9a332aac1c.png',
'D73C7D3F-DCD7-4370-86A4-490A44136013':'//webeditor-static.cdn-one.com/D73C7D3F-DCD7-4370-86A4-490A44136013.6818d31767.png',
'D85CFDB4-466E-43BE-BDBD-F8D92BB37B60':'//webeditor-static.cdn-one.com/D85CFDB4-466E-43BE-BDBD-F8D92BB37B60.e02414538e.png',
'DA2CFBCD-2C75-4948-8B4E-1598383D5113':'//webeditor-static.cdn-one.com/DA2CFBCD-2C75-4948-8B4E-1598383D5113.5ee26d4eda.png',
'DAB59EC3-648B-4095-B233-1D935C33E2F6':'//webeditor-static.cdn-one.com/DAB59EC3-648B-4095-B233-1D935C33E2F6.08a9ccd30d.png',
'DB127167-B1F2-414B-9314-1D0F59FB1EB5':'//webeditor-static.cdn-one.com/DB127167-B1F2-414B-9314-1D0F59FB1EB5.f8d73f1a51.png',
'DD6F2D53-BECB-4B32-ACCD-B3CB7D584B6D':'//webeditor-static.cdn-one.com/DD6F2D53-BECB-4B32-ACCD-B3CB7D584B6D.f9e380bd73.png',
'DDDF9E1C-E288-454B-B20D-2E5CA55E22B6':'//webeditor-static.cdn-one.com/DDDF9E1C-E288-454B-B20D-2E5CA55E22B6.4f1583f431.png',
'DFF82427-AC15-4AA4-96A8-C9D137E851CA':'//webeditor-static.cdn-one.com/DFF82427-AC15-4AA4-96A8-C9D137E851CA.22ce62597a.png',
'E1FAD3A0-50DA-4B5F-99A7-B59BC46568BF':'//webeditor-static.cdn-one.com/E1FAD3A0-50DA-4B5F-99A7-B59BC46568BF.a2e1d060be.png',
'E6BECFFE-E8AE-4347-8231-4F952EF49393':'//webeditor-static.cdn-one.com/E6BECFFE-E8AE-4347-8231-4F952EF49393.90667ba3dc.png',
'EAE09073-6A96-4868-A79E-BB4180616034':'//webeditor-static.cdn-one.com/EAE09073-6A96-4868-A79E-BB4180616034.87fca8d129.png',
'EBD0C7E9-CDC5-4192-AFB9-3CD3D1116E8A':'//webeditor-static.cdn-one.com/EBD0C7E9-CDC5-4192-AFB9-3CD3D1116E8A.294b6d46cd.png',
'EBDC86F6-7098-417F-BEB7-02AADF6AA0EF':'//webeditor-static.cdn-one.com/EBDC86F6-7098-417F-BEB7-02AADF6AA0EF.9f1c2e1e07.png',
'EE6B32F3-69A1-4CB1-8484-739959A262B3':'//webeditor-static.cdn-one.com/EE6B32F3-69A1-4CB1-8484-739959A262B3.4ac3cf6ef3.png',
'EF6525A1-4EDE-4DF0-832B-86501AD62D4F':'//webeditor-static.cdn-one.com/EF6525A1-4EDE-4DF0-832B-86501AD62D4F.18d2ab4314.png',
'EFE438DC-B311-40A0-8FEF-F171024B9534':'//webeditor-static.cdn-one.com/EFE438DC-B311-40A0-8FEF-F171024B9534.6a5b59128f.png',
'F461723F-15FB-4AC9-A6DB-A67C3F29003A':'//webeditor-static.cdn-one.com/F461723F-15FB-4AC9-A6DB-A67C3F29003A.a427697908.png',
'F5764FBD-7435-458C-A387-5AA294513931':'//webeditor-static.cdn-one.com/F5764FBD-7435-458C-A387-5AA294513931.8209347f93.png',
'F8B2BD28-2441-4B95-BC9C-9F439796C17F':'//webeditor-static.cdn-one.com/F8B2BD28-2441-4B95-BC9C-9F439796C17F.8835eacf34.png',
'F8E77251-68FB-48FE-A095-57707A18912B':'//webeditor-static.cdn-one.com/F8E77251-68FB-48FE-A095-57707A18912B.2568a0bbc9.png',
'FBD16911-F3B2-492E-99A9-F5820E013F1A':'//webeditor-static.cdn-one.com/FBD16911-F3B2-492E-99A9-F5820E013F1A.019858fb8a.png',
'FEC7673E-9967-406E-99BC-62CE1D0A6936':'//webeditor-static.cdn-one.com/FEC7673E-9967-406E-99BC-62CE1D0A6936.477befda71.png'
}
}
}[width][height][id]
},
fixTemplateName:function(template,callback){
var templates=[];
function generateNewName(templates){
var templateNameRegex=new RegExp('^'+template.name+'\\-'),matchFound=false,max=1,num;
templates.forEach(function(other){
if(other.id!==template.id&&templateNameRegex.test(other.name)){
num=other.name.replace(templateNameRegex,'');
max=Math.max(max,num);
matchFound=true
}else if(other.name===template.name){
matchFound=true
}
});
return matchFound?template.name+'-'+(max+1):template.name
}
if(this.rep===this.app.dal){
this.store.each(function(record){
templates.push({
id:record.data.templateId,
name:record.data.name
})
},this);
callback.call(this,generateNewName(templates))
}else{
this.app.dal.getList('web.data.components.Template',true,function(opts,success,response){
if(success){
var templates=this.filterRecordsByType(Ext.decode(response.responseText),'web.data.components.Template');
callback.call(this,generateNewName(templates))
}else{
one.error('<b>'+'Unable to get templates.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.')
}
},this)
}
},
duplicate:function(record){
var dal=this.app.dal,dm=this.dm,templateId=record.data.templateId,waitDuplicating;
waitDuplicating=Ext.Msg.wait('Duplicating template... Please wait.','Duplicating Template');
dal.getWithDependents(templateId,'web.data.components.Template',function(opts,success,response){
if(success&&response.responseText){
var data=Ext.decode(response.responseText),copier=new web.utils.Copier,template=copier.copy(data.template),stylesheet=copier.copy(data.stylesheet);
this.fixTemplateName(template,function(name){
template.name=name;
dal.set(dm.create(template),function(opts,success,response){
if(success){
var data=Ext.decode(response.responseText);
template.rev=data.rev;
template.etag=data.etag;
dal.set(dm.create(stylesheet),function(opts,success,response){
if(success){
var data=Ext.decode(response.responseText),pageTreeConfig={
page:null,
name:'',
title:'',
subPageIds:null
};
stylesheet.rev=data.rev;
stylesheet.etag=data.etag;
waitDuplicating.hide();
this.fireEvent('templateduplicated',template,stylesheet,pageTreeConfig)
}else{
one.error('<b>'+'Could not save template.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.')
}
},this)
}else{
one.error('<b>'+'Could not save template.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.')
}
},this)
})
}else{
waitDuplicating.hide();
one.error('<b>'+'Unable to get templates.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.')
}
},this)
}
});
Ext.ComponentMgr.registerType('web-ui-templateselectorlist',web.ui.TemplateSelectorList);
web.pageImport.ui.SelectSingleTemplate=Ext.extend(web.pageImport.ui.Panel,{
initComponent:function(){
var width=527;
var noneSelected='<div style="display: table; width: 100%; height: 100%;">'+'<div style="display: table-cell; vertical-align: middle;">'+'Select the template that you wish to import your WebCreator content into.'+'</div>'+'</div>';
this.bodyMargin=false;
this.bodyItems=[{
ref:'tabs',
xtype:'tabpanel',
cls:'rectangle-tabs',
flex:1,
activeTab:0,
items:[
{
ref:'modified',
title:'My Templates',
layout:'hbox',
layoutConfig:{align:'stretch'},
items:[
{
ref:'templateSelector',
xtype:'web-ui-templateselectorlist',
app:this.app,
width:width,
category:'modified',
repository:this.app.dal,
dal:this.app.dal,
enableDelete:false,
listeners:{
selectionchange:this.handleSelectionChange,
scope:this
}
},
{
ref:'preview',
xtype:'box',
cls:'pageImport-templatePreview',
html:noneSelected,
flex:1,
height:479
}
]
},
{
ref:'standard',
title:'One.com Templates',
layout:'hbox',
layoutConfig:{align:'stretch'},
items:[
{
ref:'templateSelector',
xtype:'web-ui-templateselectorlist',
app:this.app,
width:width,
category:'standard',
repository:this.app.rep,
dal:this.app.dal,
listeners:{
selectionchange:this.handleSelectionChange,
scope:this
}
},
{
ref:'preview',
xtype:'box',
cls:'pageImport-templatePreview',
html:noneSelected,
flex:1,
height:479
}
]
},
{
ref:'blank',
title:'Blank Templates',
layout:'hbox',
layoutConfig:{align:'stretch'},
items:[
{
ref:'templateSelector',
xtype:'web-ui-templateselectorlist',
app:this.app,
width:width,
category:'blank',
repository:this.app.rep,
dal:this.app.dal,
listeners:{
selectionchange:this.handleSelectionChange,
scope:this
}
},
{
ref:'preview',
xtype:'box',
cls:'pageImport-templatePreview',
html:noneSelected,
flex:1,
height:479
}
]
}
],
listeners:{
tabchange:function(panel,tab){
tab.templateSelector.fetchData();
this.disableNextButton()
},
scope:this
}
}];
this.listeners={
show:function(){
var lastActiveTab=this.tabs.getActiveTab();
this.tabs.setActiveTab(0);
if(lastActiveTab===this.tabs.getActiveTab()){
lastActiveTab.templateSelector.fetchData()
}
this.disableNextButton()
},
scope:this
};
web.pageImport.ui.SelectSingleTemplate.superclass.initComponent.call(this)
},
getSelected:function(){
var currentTab=this.tabs.getActiveTab(),result={templateId:currentTab.templateSelector.getSelectedTemplateId()};
if(currentTab===this.tabs.modified){
result.templateType='modified'
}else{
result.templateType='standard'
}
return result
},
handleSelectionChange:function(selector,nodes){
var node;
if(nodes.length){
node=selector.getRecord(nodes[0]);
this.enableNextButton()
}else{
this.disableNextButton()
}
this.displayPreview(selector.repository,node)
},
displayPreview:function(rep,record){
var preview=this.getPreview();
if(record){
var previewUrl,that=this;
var width=660,height=620;
if(rep===this.app.dal){
previewUrl=rep.getPreviewUrl(record.data.templateId)
}else{
previewUrl=this.app.rep.defaultUrl+'/preview/'+record.data.pageId+'.html?templateselectorpreview=desktop'
}
preview.update('<div class="mobile-scroller flex"><div class="iframe-wrapper" style="border: 1px solid #c5d1ae;"></div></div><div></div>');
var $el=oneJQuery('.iframe-wrapper',preview.el.dom),scale=width/1280;
$el.height(height);
$el.append('<iframe class="iframe-preview" style="transform: scale('+scale+','+scale+');'+'-webkit-transform: scale('+scale+','+scale+');'+'left:'+-(1280-width)/2+'px;top:'+-(960-height)/2+'px;" src="'+previewUrl+'"></iframe>'+'<div class="iframe-click-blocker"></div>');
var iframe=$el[0].firstChild,repositionIframe=function(text){
if(text!=='onload'){
this.previewAdjustTimer=setTimeout(repositionIframe,200)
}else{
clearTimeout(this.previewAdjustTimer)
}
var body=iframe.contentWindow&&iframe.contentWindow.document.body;
if(!body||!body.innerHTML){
return
}
var height=body.scrollHeight;
var scrollWidth=body.scrollWidth;
if(scrollWidth>body.clientWidth){
while(scrollWidth>body.clientWidth){
scale=width/scrollWidth;
iframe.style.width=scrollWidth+'px';
iframe.style.transform='scale('+scale+','+scale+')';
if(body.scrollWidth>body.clientWidth){
scrollWidth+=100
}else{
break
}
}
iframe.style.left=-(body.scrollWidth-width)/2+'px'
}
iframe.style.height=height+'px';
iframe.parentNode.style.height=height*scale+'px';
iframe.style.top=-((height-height*scale)/2)+'px';
that.verticallyMiddleAlign()
}.bind(this);
clearTimeout(this.previewAdjustTimer);
this.previewAdjustTimer=setTimeout(repositionIframe,200);
iframe.onload=repositionIframe.bind(this,'onload');
Ext.EventManager.removeAll(preview.getContentTarget().dom);
preview.getContentTarget().on('dblclick',that.selectBtn.handler);
that.verticallyMiddleAlign()
}else{
preview.update('')
}
},
verticallyMiddleAlign:function(){
var previewCompEl=this.getPreview().el;
previewCompEl.setStyle('margin-top','');
var requiredHeight=previewCompEl.dom.scrollHeight,availableHeight=previewCompEl.parent().getHeight(),marginTop=(availableHeight-requiredHeight)/2||0,minMarginTop=15;
if(marginTop>minMarginTop){
previewCompEl.setStyle('margin-top',marginTop+'px')
}
},
getPreview:function(){
return this.tabs.getActiveTab().preview
},
getStaticPreviewUrl:function(id,width,height){
return{
'193':{
'193':{
'0002F0CF-FFCC-48D2-A9E4-1914AB4DC1CF':'//webeditor-static.cdn-one.com/0002F0CF-FFCC-48D2-A9E4-1914AB4DC1CF.7cebfb68cd.png',
'00030EC2-BA43-431D-AA22-D0039A2A089A':'//webeditor-static.cdn-one.com/00030EC2-BA43-431D-AA22-D0039A2A089A.cd946d4c56.png',
'0003EA23-32AC-4F79-B1F4-C3E35A37763F':'//webeditor-static.cdn-one.com/0003EA23-32AC-4F79-B1F4-C3E35A37763F.b4178f98b7.png',
'00047E4B-4FBE-4D84-AD0E-6E90C3F5AF0E':'//webeditor-static.cdn-one.com/00047E4B-4FBE-4D84-AD0E-6E90C3F5AF0E.0e0c86c307.png',
'000485CB-BCA8-4131-8E2F-86F91C88DC55':'//webeditor-static.cdn-one.com/000485CB-BCA8-4131-8E2F-86F91C88DC55.ba116bc8c5.png',
'00049ABB-2008-44A4-BC15-157FE89BA34F':'//webeditor-static.cdn-one.com/00049ABB-2008-44A4-BC15-157FE89BA34F.83a8ae8bf1.png',
'00050173-F15F-4682-A552-6AA0ED9F192F':'//webeditor-static.cdn-one.com/00050173-F15F-4682-A552-6AA0ED9F192F.be89a7359d.png',
'00051CAB-9B31-4F73-A089-8A585C5E4B62':'//webeditor-static.cdn-one.com/00051CAB-9B31-4F73-A089-8A585C5E4B62.8d9f757737.png',
'000589E2-CE21-499A-8DC4-71964CC9F4A0':'//webeditor-static.cdn-one.com/000589E2-CE21-499A-8DC4-71964CC9F4A0.64c31e7cc8.png',
'0006F00F-CCE8-4D55-8A97-7B421ED8CDCA':'//webeditor-static.cdn-one.com/0006F00F-CCE8-4D55-8A97-7B421ED8CDCA.7769bdafa4.png',
'0007008A-7BD8-403D-A7AA-F6456781A38E':'//webeditor-static.cdn-one.com/0007008A-7BD8-403D-A7AA-F6456781A38E.9868c87b6e.png',
'00070730-9978-479E-9FBA-92FC6749B783':'//webeditor-static.cdn-one.com/00070730-9978-479E-9FBA-92FC6749B783.d3ea9311f8.png',
'00070748-CD5C-46BB-91C1-D070B317D79C':'//webeditor-static.cdn-one.com/00070748-CD5C-46BB-91C1-D070B317D79C.d4b4968860.png',
'00070754-94C2-46F1-B465-9C47870B71FE':'//webeditor-static.cdn-one.com/00070754-94C2-46F1-B465-9C47870B71FE.7168f88752.png',
'00070766-F60B-457F-B397-A3673344B990':'//webeditor-static.cdn-one.com/00070766-F60B-457F-B397-A3673344B990.058f5a8978.png',
'00070777-F6E6-4017-B303-5B9292C5B193':'//webeditor-static.cdn-one.com/00070777-F6E6-4017-B303-5B9292C5B193.8fce0c0f8e.png',
'00070834-62D1-461B-BF85-CFC4F85DE88A':'//webeditor-static.cdn-one.com/00070834-62D1-461B-BF85-CFC4F85DE88A.76b10f8f95.png',
'00080021-E0DB-4216-B08F-EC7F81E56703':'//webeditor-static.cdn-one.com/00080021-E0DB-4216-B08F-EC7F81E56703.2f9452bd03.png',
'00080101-2DBA-4BD7-93C2-200ACB39A363':'//webeditor-static.cdn-one.com/00080101-2DBA-4BD7-93C2-200ACB39A363.ba2ff4198f.png',
'00081BC7-E018-4D15-B747-6D52FDA7AB8C':'//webeditor-static.cdn-one.com/00081BC7-E018-4D15-B747-6D52FDA7AB8C.39d0d52b85.png',
'000823A3-063F-4E5C-9676-F209B360BC51':'//webeditor-static.cdn-one.com/000823A3-063F-4E5C-9676-F209B360BC51.bf694fdd65.png',
'001731EA-BAF4-426D-ABBB-89356CC12BF2':'//webeditor-static.cdn-one.com/001731EA-BAF4-426D-ABBB-89356CC12BF2.5f3567a7dd.png',
'001C63DB-8AFA-4381-B313-9264DDF02508':'//webeditor-static.cdn-one.com/001C63DB-8AFA-4381-B313-9264DDF02508.4be23b8ae9.png',
'013DB8BA-39E8-486B-AF3A-A48D903DCDBD':'//webeditor-static.cdn-one.com/013DB8BA-39E8-486B-AF3A-A48D903DCDBD.5bb637a396.png',
'0224F05C-E435-4733-A672-FE547D9FB33F':'//webeditor-static.cdn-one.com/0224F05C-E435-4733-A672-FE547D9FB33F.518dfabd63.png',
'03782AF4-B732-44D4-9B17-2B352438A8F7':'//webeditor-static.cdn-one.com/03782AF4-B732-44D4-9B17-2B352438A8F7.5e862cb176.png',
'0539D130-3B66-4115-B6B7-BEF0843229FC':'//webeditor-static.cdn-one.com/0539D130-3B66-4115-B6B7-BEF0843229FC.f98dba8c00.png',
'084AA085-3E96-4BB7-AF97-52B6841485F2':'//webeditor-static.cdn-one.com/084AA085-3E96-4BB7-AF97-52B6841485F2.783442d79b.png',
'1A508E91-3007-4FD8-8BAA-24ACA61AAA68':'//webeditor-static.cdn-one.com/1A508E91-3007-4FD8-8BAA-24ACA61AAA68.5bc17b8ecb.png',
'1C4669D4-606A-43B8-B5EA-6C3BFCC9171A':'//webeditor-static.cdn-one.com/1C4669D4-606A-43B8-B5EA-6C3BFCC9171A.6b37b94844.png',
'1D5A5942-512F-4899-ABD3-4CCDD4D2EEA6':'//webeditor-static.cdn-one.com/1D5A5942-512F-4899-ABD3-4CCDD4D2EEA6.3bdd3fc892.png',
'1EAEF3EB-411E-4EAA-9FDE-5468F5B5754C':'//webeditor-static.cdn-one.com/1EAEF3EB-411E-4EAA-9FDE-5468F5B5754C.1140fb88f4.png',
'204B64BE-2F2D-444D-879E-FC46D800B95A':'//webeditor-static.cdn-one.com/204B64BE-2F2D-444D-879E-FC46D800B95A.f27537e71d.png',
'23E5F695-A336-415F-8EDE-86F727E54ACE':'//webeditor-static.cdn-one.com/23E5F695-A336-415F-8EDE-86F727E54ACE.b798b75109.png',
'25F00AC7-18E9-4525-A670-4351CEF8FDA8':'//webeditor-static.cdn-one.com/25F00AC7-18E9-4525-A670-4351CEF8FDA8.9cd7070270.png',
'2685289B-22DA-4B34-A683-55E9AFC22105':'//webeditor-static.cdn-one.com/2685289B-22DA-4B34-A683-55E9AFC22105.4e9344c09e.png',
'2AEAE987-A2B8-4EAA-A47A-819314099BF2':'//webeditor-static.cdn-one.com/2AEAE987-A2B8-4EAA-A47A-819314099BF2.bf0a2372c0.png',
'2C44F84E-A6E1-413F-A3F3-5644138137A3':'//webeditor-static.cdn-one.com/2C44F84E-A6E1-413F-A3F3-5644138137A3.0a4d892308.png',
'2E30034F-1AF6-4230-997D-6F48AF1B0011':'//webeditor-static.cdn-one.com/2E30034F-1AF6-4230-997D-6F48AF1B0011.116103fd30.png',
'3043CD74-B431-4AAE-8C0F-A4D93A82AE72':'//webeditor-static.cdn-one.com/3043CD74-B431-4AAE-8C0F-A4D93A82AE72.114564aba7.png',
'311EB8FA-A458-478B-AB21-FD2F7F4FD396':'//webeditor-static.cdn-one.com/311EB8FA-A458-478B-AB21-FD2F7F4FD396.50b1492ec5.png',
'334BBBC7-4FA8-446C-B74D-05735EAA1097':'//webeditor-static.cdn-one.com/334BBBC7-4FA8-446C-B74D-05735EAA1097.972794d94f.png',
'34061178-2E48-4F01-AF05-799E56AC9835':'//webeditor-static.cdn-one.com/34061178-2E48-4F01-AF05-799E56AC9835.06a60fd05f.png',
'34AA3CB7-85D6-4EEB-BA1C-59BE944196FF':'//webeditor-static.cdn-one.com/34AA3CB7-85D6-4EEB-BA1C-59BE944196FF.cdd2787a0c.png',
'3DA86168-AE0B-4931-A922-505298DBD838':'//webeditor-static.cdn-one.com/3DA86168-AE0B-4931-A922-505298DBD838.37fec071e7.png',
'3FD90757-BE66-472E-8101-39727602F40A':'//webeditor-static.cdn-one.com/3FD90757-BE66-472E-8101-39727602F40A.c6046359bc.png',
'42AD43FA-86AC-40EC-817A-D902EB5A2646':'//webeditor-static.cdn-one.com/42AD43FA-86AC-40EC-817A-D902EB5A2646.ae4ab07e8c.png',
'4B88778E-0844-4F29-8C48-25ADD979BE07':'//webeditor-static.cdn-one.com/4B88778E-0844-4F29-8C48-25ADD979BE07.2da4d74817.png',
'4F069106-1AFB-44A0-932C-23AC4E48D717':'//webeditor-static.cdn-one.com/4F069106-1AFB-44A0-932C-23AC4E48D717.1e0fe05891.png',
'54800989-B457-4B9C-83F1-65F53E137C6E':'//webeditor-static.cdn-one.com/54800989-B457-4B9C-83F1-65F53E137C6E.4a7940d1c5.png',
'5658EEBA-488C-463E-A7FE-668EF0C19874':'//webeditor-static.cdn-one.com/5658EEBA-488C-463E-A7FE-668EF0C19874.de8a68c5bd.png',
'56F81F12-2D3C-40E2-9663-C737ED560687':'//webeditor-static.cdn-one.com/56F81F12-2D3C-40E2-9663-C737ED560687.f01a150d6e.png',
'58896882-CB5A-4CC1-992E-31E2B90BF944':'//webeditor-static.cdn-one.com/58896882-CB5A-4CC1-992E-31E2B90BF944.b24416c7e5.png',
'5973DB30-E0E9-4B79-9B01-A6A4803A5B06':'//webeditor-static.cdn-one.com/5973DB30-E0E9-4B79-9B01-A6A4803A5B06.c632cfc816.png',
'5B0B340F-9400-4984-9F75-313A054FCD1E':'//webeditor-static.cdn-one.com/5B0B340F-9400-4984-9F75-313A054FCD1E.aba3cf9a2a.png',
'5E510A6D-585F-4578-89B5-F62FCCB3F9B7':'//webeditor-static.cdn-one.com/5E510A6D-585F-4578-89B5-F62FCCB3F9B7.9a3d456c40.png',
'607B35C9-EF6E-4608-B895-2C48E5604BED':'//webeditor-static.cdn-one.com/607B35C9-EF6E-4608-B895-2C48E5604BED.943fb71ca2.png',
'61B045BC-A215-4DAF-B009-CABD03BB162E':'//webeditor-static.cdn-one.com/61B045BC-A215-4DAF-B009-CABD03BB162E.8f3e03877f.png',
'6462FADC-98D5-4B29-A7DA-2103F9DE5E9B':'//webeditor-static.cdn-one.com/6462FADC-98D5-4B29-A7DA-2103F9DE5E9B.f58e602280.png',
'6483B0E7-059E-4314-8363-C7FB1F3A6CB6':'//webeditor-static.cdn-one.com/6483B0E7-059E-4314-8363-C7FB1F3A6CB6.2a57d7c497.png',
'672EAAD3-66D9-41DB-AA81-1C0EFA461195':'//webeditor-static.cdn-one.com/672EAAD3-66D9-41DB-AA81-1C0EFA461195.6a6e2f4425.png',
'68A1CEC5-8443-49DA-A69E-10FD4EC1158A':'//webeditor-static.cdn-one.com/68A1CEC5-8443-49DA-A69E-10FD4EC1158A.9abad7631a.png',
'6945C55A-DB8F-4511-93EA-0AA6330D841C':'//webeditor-static.cdn-one.com/6945C55A-DB8F-4511-93EA-0AA6330D841C.069d8bd1de.png',
'6A590330-67C5-4CEC-A873-5AFB5D6A5B03':'//webeditor-static.cdn-one.com/6A590330-67C5-4CEC-A873-5AFB5D6A5B03.4b383cf1ad.png',
'6A89F07A-DA86-4645-8D7C-C569598B0570':'//webeditor-static.cdn-one.com/6A89F07A-DA86-4645-8D7C-C569598B0570.aee01dd996.png',
'6FBD0F95-644B-4366-9EA7-9A2D230AFEB7':'//webeditor-static.cdn-one.com/6FBD0F95-644B-4366-9EA7-9A2D230AFEB7.ba0a1afad4.png',
'724DC003-F351-4D99-B050-CA77A7F813AF':'//webeditor-static.cdn-one.com/724DC003-F351-4D99-B050-CA77A7F813AF.9a49ec590c.png',
'73F9B328-08DC-46B8-A2B8-00A9EDFD23F1':'//webeditor-static.cdn-one.com/73F9B328-08DC-46B8-A2B8-00A9EDFD23F1.ce587262c0.png',
'7434549F-3501-4637-B58C-028A7282733E':'//webeditor-static.cdn-one.com/7434549F-3501-4637-B58C-028A7282733E.82708e3c96.png',
'788775F0-0568-458E-AA05-1FF98F9D16AC':'//webeditor-static.cdn-one.com/788775F0-0568-458E-AA05-1FF98F9D16AC.03bd0c8ba9.png',
'7DC3462C-86E8-43D1-AC14-95B9F3CAB7F5':'//webeditor-static.cdn-one.com/7DC3462C-86E8-43D1-AC14-95B9F3CAB7F5.bf0dd3c65d.png',
'7EBF7B3F-AB9C-4BE3-8AA3-F2BCABA29308':'//webeditor-static.cdn-one.com/7EBF7B3F-AB9C-4BE3-8AA3-F2BCABA29308.e16e15e5a2.png',
'86E66F0E-B615-491E-AB93-02EA26E739DF':'//webeditor-static.cdn-one.com/86E66F0E-B615-491E-AB93-02EA26E739DF.395f1f1abf.png',
'8BE71EDA-8B36-4308-8F93-0BFF9D48011F':'//webeditor-static.cdn-one.com/8BE71EDA-8B36-4308-8F93-0BFF9D48011F.fc1177a373.png',
'8E6DAEEB-2149-4D7B-B0B7-48833D6674F9':'//webeditor-static.cdn-one.com/8E6DAEEB-2149-4D7B-B0B7-48833D6674F9.2ee304d391.png',
'90E6AE18-E966-411E-A206-A39CC4249640':'//webeditor-static.cdn-one.com/90E6AE18-E966-411E-A206-A39CC4249640.a3671b4707.png',
'92D17A27-C501-4C1A-9B74-7F2126D476AA':'//webeditor-static.cdn-one.com/92D17A27-C501-4C1A-9B74-7F2126D476AA.98484a2549.png',
'9372BB7F-C33D-4490-8FC1-D9C1748F1B00':'//webeditor-static.cdn-one.com/9372BB7F-C33D-4490-8FC1-D9C1748F1B00.c61c30fa04.png',
'93C20709-9258-4424-8FED-00C0E4F182FE':'//webeditor-static.cdn-one.com/93C20709-9258-4424-8FED-00C0E4F182FE.52ec4a48c2.png',
'9773A4DE-7F3D-480D-806C-47F2072A09F3':'//webeditor-static.cdn-one.com/9773A4DE-7F3D-480D-806C-47F2072A09F3.5af75d8746.png',
'97E75564-601B-4E2D-ADE4-C404293BCEB0':'//webeditor-static.cdn-one.com/97E75564-601B-4E2D-ADE4-C404293BCEB0.8550e2aac6.png',
'98709062-2541-49E5-B719-2BD8EDCEAE34':'//webeditor-static.cdn-one.com/98709062-2541-49E5-B719-2BD8EDCEAE34.5c02eba02f.png',
'98B05EE6-3FF7-4225-8E6C-B364A4D5A4E7':'//webeditor-static.cdn-one.com/98B05EE6-3FF7-4225-8E6C-B364A4D5A4E7.77e2f1941d.png',
'998163D4-6628-4431-9649-39330FF7B1DD':'//webeditor-static.cdn-one.com/998163D4-6628-4431-9649-39330FF7B1DD.424a21094d.png',
'99C5C747-AEE0-4A65-B67F-0D21D4BC7DD8':'//webeditor-static.cdn-one.com/99C5C747-AEE0-4A65-B67F-0D21D4BC7DD8.c14fbae6b1.png',
'9C098D93-215C-4FEC-9920-AF5F689477B7':'//webeditor-static.cdn-one.com/9C098D93-215C-4FEC-9920-AF5F689477B7.035e1a859d.png',
'9C51F5A7-A55E-480E-873C-866C6D9CED96':'//webeditor-static.cdn-one.com/9C51F5A7-A55E-480E-873C-866C6D9CED96.2824e706c0.png',
'A1405D9D-9BE1-4AC5-8604-BE6E20F61A7E':'//webeditor-static.cdn-one.com/A1405D9D-9BE1-4AC5-8604-BE6E20F61A7E.cb4749dac1.png',
'A4227214-40D6-4018-8FED-EFA5B616A7CA':'//webeditor-static.cdn-one.com/A4227214-40D6-4018-8FED-EFA5B616A7CA.77a65ab010.png',
'A4F8FDA5-2AA3-437E-BF0A-904A71B79BD3':'//webeditor-static.cdn-one.com/A4F8FDA5-2AA3-437E-BF0A-904A71B79BD3.a2c2560742.png',
'A51F9476-AC94-41E2-B494-4A42397348F9':'//webeditor-static.cdn-one.com/A51F9476-AC94-41E2-B494-4A42397348F9.5184861de2.png',
'A6B6C9A1-12E6-4B64-8100-460D635BF984':'//webeditor-static.cdn-one.com/A6B6C9A1-12E6-4B64-8100-460D635BF984.07460154d4.png',
'AA325A34-B75F-4838-B136-33296A0F63D2':'//webeditor-static.cdn-one.com/AA325A34-B75F-4838-B136-33296A0F63D2.a77182463d.png',
'AB52975E-0967-4B51-8DA9-785D6F9A3C79':'//webeditor-static.cdn-one.com/AB52975E-0967-4B51-8DA9-785D6F9A3C79.4edc27aa7b.png',
'ABDE7B7D-C2D2-4B0F-8A05-CD93FF231B43':'//webeditor-static.cdn-one.com/ABDE7B7D-C2D2-4B0F-8A05-CD93FF231B43.77a6ff375a.png',
'AD9F5937-B233-4AE6-9EB5-F2B5B8085661':'//webeditor-static.cdn-one.com/AD9F5937-B233-4AE6-9EB5-F2B5B8085661.15740aea05.png',
'B25A8465-F523-41D7-B049-FB3ED84917E0':'//webeditor-static.cdn-one.com/B25A8465-F523-41D7-B049-FB3ED84917E0.88d94f3857.png',
'B4B2FAB4-51EE-4724-870A-74FDD98B307B':'//webeditor-static.cdn-one.com/B4B2FAB4-51EE-4724-870A-74FDD98B307B.962a6fee52.png',
'B4F12329-05EB-40E2-BE7E-BD36C0491D8D':'//webeditor-static.cdn-one.com/B4F12329-05EB-40E2-BE7E-BD36C0491D8D.9d7735003b.png',
'B672CFDA-B43F-4B45-992C-B38A6320EC3A':'//webeditor-static.cdn-one.com/B672CFDA-B43F-4B45-992C-B38A6320EC3A.cc826580bb.png',
'B9E93092-C3DA-445A-A81B-8B1A027F1EE6':'//webeditor-static.cdn-one.com/B9E93092-C3DA-445A-A81B-8B1A027F1EE6.615867eb78.png',
'C14C7795-A390-4B21-860A-C02A36B0DB0D':'//webeditor-static.cdn-one.com/C14C7795-A390-4B21-860A-C02A36B0DB0D.79b621ed81.png',
'C179F788-A044-49E3-AF4D-2D27CBD60E5A':'//webeditor-static.cdn-one.com/C179F788-A044-49E3-AF4D-2D27CBD60E5A.faf89b9b3e.png',
'C685C25D-636C-402B-9F93-26B3D4460920':'//webeditor-static.cdn-one.com/C685C25D-636C-402B-9F93-26B3D4460920.2eae026688.png',
'CFB7058C-1454-4C1B-8E83-7BFF8EF61823':'//webeditor-static.cdn-one.com/CFB7058C-1454-4C1B-8E83-7BFF8EF61823.36be2c0af2.png',
'D16D963A-BF9C-4463-9937-2E2CE154F6DD':'//webeditor-static.cdn-one.com/D16D963A-BF9C-4463-9937-2E2CE154F6DD.a5de307650.png',
'D3FAB447-C620-4ECC-9582-25B60ED8D942':'//webeditor-static.cdn-one.com/D3FAB447-C620-4ECC-9582-25B60ED8D942.6e2dc13097.png',
'D73C7D3F-DCD7-4370-86A4-490A44136013':'//webeditor-static.cdn-one.com/D73C7D3F-DCD7-4370-86A4-490A44136013.01aaec544e.png',
'D82E5828-0612-4B4D-95E1-50668553442F':'//webeditor-static.cdn-one.com/D82E5828-0612-4B4D-95E1-50668553442F.c4ff20fb56.png',
'DA2CFBCD-2C75-4948-8B4E-1598383D5113':'//webeditor-static.cdn-one.com/DA2CFBCD-2C75-4948-8B4E-1598383D5113.4f9e5e4fe4.png',
'DAB59EC3-648B-4095-B233-1D935C33E2F6':'//webeditor-static.cdn-one.com/DAB59EC3-648B-4095-B233-1D935C33E2F6.f3e4ee7f65.png',
'DB127167-B1F2-414B-9314-1D0F59FB1EB5':'//webeditor-static.cdn-one.com/DB127167-B1F2-414B-9314-1D0F59FB1EB5.0449a809e0.png',
'DDDF9E1C-E288-454B-B20D-2E5CA55E22B6':'//webeditor-static.cdn-one.com/DDDF9E1C-E288-454B-B20D-2E5CA55E22B6.ed65b070c4.png',
'DFF82427-AC15-4AA4-96A8-C9D137E851CA':'//webeditor-static.cdn-one.com/DFF82427-AC15-4AA4-96A8-C9D137E851CA.c5a81aa988.png',
'E1FAD3A0-50DA-4B5F-99A7-B59BC46568BF':'//webeditor-static.cdn-one.com/E1FAD3A0-50DA-4B5F-99A7-B59BC46568BF.9333fe476e.png',
'EBD0C7E9-CDC5-4192-AFB9-3CD3D1116E8A':'//webeditor-static.cdn-one.com/EBD0C7E9-CDC5-4192-AFB9-3CD3D1116E8A.32da1ea64d.png',
'EF6525A1-4EDE-4DF0-832B-86501AD62D4F':'//webeditor-static.cdn-one.com/EF6525A1-4EDE-4DF0-832B-86501AD62D4F.7876fff919.png',
'EF8636B4-D274-4B36-A3B9-3CF1A576C565':'//webeditor-static.cdn-one.com/EF8636B4-D274-4B36-A3B9-3CF1A576C565.18c9b3a65b.png',
'F461723F-15FB-4AC9-A6DB-A67C3F29003A':'//webeditor-static.cdn-one.com/F461723F-15FB-4AC9-A6DB-A67C3F29003A.901966530e.png',
'F81C2E32-22AE-48BC-AF06-2DE61B0EF699':'//webeditor-static.cdn-one.com/F81C2E32-22AE-48BC-AF06-2DE61B0EF699.539a370c87.png',
'F8B2BD28-2441-4B95-BC9C-9F439796C17F':'//webeditor-static.cdn-one.com/F8B2BD28-2441-4B95-BC9C-9F439796C17F.03cef321fa.png',
'FBD16911-F3B2-492E-99A9-F5820E013F1A':'//webeditor-static.cdn-one.com/FBD16911-F3B2-492E-99A9-F5820E013F1A.2f97bbf096.png'
}
},
'760':{
'490':{
'001731EA-BAF4-426D-ABBB-89356CC12BF2':'//webeditor-static.cdn-one.com/001731EA-BAF4-426D-ABBB-89356CC12BF2.413f6ba4c1.png',
'0224F05C-E435-4733-A672-FE547D9FB33F':'//webeditor-static.cdn-one.com/0224F05C-E435-4733-A672-FE547D9FB33F.162d5f8bd8.png',
'03782AF4-B732-44D4-9B17-2B352438A8F7':'//webeditor-static.cdn-one.com/03782AF4-B732-44D4-9B17-2B352438A8F7.78b440f37f.png',
'0539D130-3B66-4115-B6B7-BEF0843229FC':'//webeditor-static.cdn-one.com/0539D130-3B66-4115-B6B7-BEF0843229FC.6a2b9d622f.png',
'060E9FC1-C3F1-47EF-A339-26B813F95FE2':'//webeditor-static.cdn-one.com/060E9FC1-C3F1-47EF-A339-26B813F95FE2.c9bfd9c85c.png',
'07C057DE-6B9F-4054-AC3B-8A18D5576458':'//webeditor-static.cdn-one.com/07C057DE-6B9F-4054-AC3B-8A18D5576458.3b4b6d1f1a.png',
'084AA085-3E96-4BB7-AF97-52B6841485F2':'//webeditor-static.cdn-one.com/084AA085-3E96-4BB7-AF97-52B6841485F2.12fff9b789.png',
'0D05EBAB-5B57-4AFC-B37F-D74C184DC330':'//webeditor-static.cdn-one.com/0D05EBAB-5B57-4AFC-B37F-D74C184DC330.0353eddbf5.png',
'125D220F-8FDC-4213-B966-E2F5FC03FDF5':'//webeditor-static.cdn-one.com/125D220F-8FDC-4213-B966-E2F5FC03FDF5.c75ad8599b.png',
'176BC94D-2465-40B9-B85B-C252B145777D':'//webeditor-static.cdn-one.com/176BC94D-2465-40B9-B85B-C252B145777D.30b6ef8bc0.png',
'1921575B-E4B7-40D9-A71D-F831DD78465E':'//webeditor-static.cdn-one.com/1921575B-E4B7-40D9-A71D-F831DD78465E.6f9dd02b98.png',
'19C01FE6-985B-4FAA-A702-1EB4A9AEFBBA':'//webeditor-static.cdn-one.com/19C01FE6-985B-4FAA-A702-1EB4A9AEFBBA.8fbade26ff.png',
'1A508E91-3007-4FD8-8BAA-24ACA61AAA68':'//webeditor-static.cdn-one.com/1A508E91-3007-4FD8-8BAA-24ACA61AAA68.95249260c8.png',
'1BBC770F-EDEA-478C-844B-49EE79B11AC3':'//webeditor-static.cdn-one.com/1BBC770F-EDEA-478C-844B-49EE79B11AC3.d81302869a.png',
'1C4669D4-606A-43B8-B5EA-6C3BFCC9171A':'//webeditor-static.cdn-one.com/1C4669D4-606A-43B8-B5EA-6C3BFCC9171A.f561a28c9c.png',
'1CF91525-45D5-45DD-8356-01676A31DE36':'//webeditor-static.cdn-one.com/1CF91525-45D5-45DD-8356-01676A31DE36.e14337b0e5.png',
'1D37228D-FD7B-4EB5-A860-749D5BE194C3':'//webeditor-static.cdn-one.com/1D37228D-FD7B-4EB5-A860-749D5BE194C3.cdb8be5074.png',
'1EAEF3EB-411E-4EAA-9FDE-5468F5B5754C':'//webeditor-static.cdn-one.com/1EAEF3EB-411E-4EAA-9FDE-5468F5B5754C.345a6844df.png',
'22C2E58D-C04B-49C7-A5AA-CF94087F2772':'//webeditor-static.cdn-one.com/22C2E58D-C04B-49C7-A5AA-CF94087F2772.d8112ae9e3.png',
'23583321-A2F2-4478-A996-7A99EA6541C2':'//webeditor-static.cdn-one.com/23583321-A2F2-4478-A996-7A99EA6541C2.55629d6f25.png',
'23E5F695-A336-415F-8EDE-86F727E54ACE':'//webeditor-static.cdn-one.com/23E5F695-A336-415F-8EDE-86F727E54ACE.9e4cf4d083.png',
'25A9B706-70F2-4C76-9CAE-284251B469B6':'//webeditor-static.cdn-one.com/25A9B706-70F2-4C76-9CAE-284251B469B6.7a264b1249.png',
'2685289B-22DA-4B34-A683-55E9AFC22105':'//webeditor-static.cdn-one.com/2685289B-22DA-4B34-A683-55E9AFC22105.ee5262e4ce.png',
'2E30034F-1AF6-4230-997D-6F48AF1B0011':'//webeditor-static.cdn-one.com/2E30034F-1AF6-4230-997D-6F48AF1B0011.322921ff1c.png',
'2FA166B9-4BE6-4BA0-98B6-DE96BAD3F2BA':'//webeditor-static.cdn-one.com/2FA166B9-4BE6-4BA0-98B6-DE96BAD3F2BA.629ba2cd29.png',
'3043CD74-B431-4AAE-8C0F-A4D93A82AE72':'//webeditor-static.cdn-one.com/3043CD74-B431-4AAE-8C0F-A4D93A82AE72.f087d4fc10.png',
'311EB8FA-A458-478B-AB21-FD2F7F4FD396':'//webeditor-static.cdn-one.com/311EB8FA-A458-478B-AB21-FD2F7F4FD396.e16fb4790a.png',
'334BBBC7-4FA8-446C-B74D-05735EAA1097':'//webeditor-static.cdn-one.com/334BBBC7-4FA8-446C-B74D-05735EAA1097.ec9f86004f.png',
'34061178-2E48-4F01-AF05-799E56AC9835':'//webeditor-static.cdn-one.com/34061178-2E48-4F01-AF05-799E56AC9835.f2bcb64457.png',
'34AA3CB7-85D6-4EEB-BA1C-59BE944196FF':'//webeditor-static.cdn-one.com/34AA3CB7-85D6-4EEB-BA1C-59BE944196FF.445240a1a9.png',
'3D50B879-D6BA-4E9C-8AD1-D1BE07EB8BDC':'//webeditor-static.cdn-one.com/3D50B879-D6BA-4E9C-8AD1-D1BE07EB8BDC.9399038b6a.png',
'3DB6416A-DF5F-47E5-8026-CDDA622DAC83':'//webeditor-static.cdn-one.com/3DB6416A-DF5F-47E5-8026-CDDA622DAC83.df9c5a1676.png',
'42CD1A9F-F9A5-499C-96FA-4B2AF07596A3':'//webeditor-static.cdn-one.com/42CD1A9F-F9A5-499C-96FA-4B2AF07596A3.48b13a3ae2.png',
'43832C0D-2A58-4B22-9C37-6DA817CD2EA5':'//webeditor-static.cdn-one.com/43832C0D-2A58-4B22-9C37-6DA817CD2EA5.835d98cb82.png',
'43B86FE4-41B7-474A-AFC1-508261E6504A':'//webeditor-static.cdn-one.com/43B86FE4-41B7-474A-AFC1-508261E6504A.7f41660624.png',
'4B88778E-0844-4F29-8C48-25ADD979BE07':'//webeditor-static.cdn-one.com/4B88778E-0844-4F29-8C48-25ADD979BE07.fe91e56c31.png',
'4F069106-1AFB-44A0-932C-23AC4E48D717':'//webeditor-static.cdn-one.com/4F069106-1AFB-44A0-932C-23AC4E48D717.362514e52c.png',
'54800989-B457-4B9C-83F1-65F53E137C6E':'//webeditor-static.cdn-one.com/54800989-B457-4B9C-83F1-65F53E137C6E.d7d9d6649a.png',
'54D6A027-D2A9-43D5-843C-B9FA7DA27AAC':'//webeditor-static.cdn-one.com/54D6A027-D2A9-43D5-843C-B9FA7DA27AAC.6260808914.png',
'58896882-CB5A-4CC1-992E-31E2B90BF944':'//webeditor-static.cdn-one.com/58896882-CB5A-4CC1-992E-31E2B90BF944.13189f9f37.png',
'5973DB30-E0E9-4B79-9B01-A6A4803A5B06':'//webeditor-static.cdn-one.com/5973DB30-E0E9-4B79-9B01-A6A4803A5B06.37380d4212.png',
'5B0B340F-9400-4984-9F75-313A054FCD1E':'//webeditor-static.cdn-one.com/5B0B340F-9400-4984-9F75-313A054FCD1E.b05f8a8f0f.png',
'5C5852E3-3BB3-46C1-9D1E-F7C7EDD008E5':'//webeditor-static.cdn-one.com/5C5852E3-3BB3-46C1-9D1E-F7C7EDD008E5.32890b1a01.png',
'5D06CBB0-1BB5-4C58-82E3-BC46594BB9EF':'//webeditor-static.cdn-one.com/5D06CBB0-1BB5-4C58-82E3-BC46594BB9EF.5a2beb5928.png',
'5E510A6D-585F-4578-89B5-F62FCCB3F9B7':'//webeditor-static.cdn-one.com/5E510A6D-585F-4578-89B5-F62FCCB3F9B7.544a986712.png',
'607B35C9-EF6E-4608-B895-2C48E5604BED':'//webeditor-static.cdn-one.com/607B35C9-EF6E-4608-B895-2C48E5604BED.e3eb79f786.png',
'6462FADC-98D5-4B29-A7DA-2103F9DE5E9B':'//webeditor-static.cdn-one.com/6462FADC-98D5-4B29-A7DA-2103F9DE5E9B.950c2e3fab.png',
'6483B0E7-059E-4314-8363-C7FB1F3A6CB6':'//webeditor-static.cdn-one.com/6483B0E7-059E-4314-8363-C7FB1F3A6CB6.fda208302e.png',
'667E3A08-C999-447A-9618-1F30C71B580C':'//webeditor-static.cdn-one.com/667E3A08-C999-447A-9618-1F30C71B580C.bf9dd1bb25.png',
'672EAAD3-66D9-41DB-AA81-1C0EFA461195':'//webeditor-static.cdn-one.com/672EAAD3-66D9-41DB-AA81-1C0EFA461195.7ea545a9d4.png',
'68A1CEC5-8443-49DA-A69E-10FD4EC1158A':'//webeditor-static.cdn-one.com/68A1CEC5-8443-49DA-A69E-10FD4EC1158A.8b2f0e4c69.png',
'68C76818-E65B-47A3-9596-6E17D6F12AD3':'//webeditor-static.cdn-one.com/68C76818-E65B-47A3-9596-6E17D6F12AD3.44cb9b7fb4.png',
'6945C55A-DB8F-4511-93EA-0AA6330D841C':'//webeditor-static.cdn-one.com/6945C55A-DB8F-4511-93EA-0AA6330D841C.66a797ee90.png',
'6A89F07A-DA86-4645-8D7C-C569598B0570':'//webeditor-static.cdn-one.com/6A89F07A-DA86-4645-8D7C-C569598B0570.6b177b4547.png',
'7058BCCD-D968-41AC-8347-BA25E75A346B':'//webeditor-static.cdn-one.com/7058BCCD-D968-41AC-8347-BA25E75A346B.297bab538e.png',
'724DC003-F351-4D99-B050-CA77A7F813AF':'//webeditor-static.cdn-one.com/724DC003-F351-4D99-B050-CA77A7F813AF.2105c2fdea.png',
'7434549F-3501-4637-B58C-028A7282733E':'//webeditor-static.cdn-one.com/7434549F-3501-4637-B58C-028A7282733E.c028aa1517.png',
'788775F0-0568-458E-AA05-1FF98F9D16AC':'//webeditor-static.cdn-one.com/788775F0-0568-458E-AA05-1FF98F9D16AC.4f975cd887.png',
'7DC3462C-86E8-43D1-AC14-95B9F3CAB7F5':'//webeditor-static.cdn-one.com/7DC3462C-86E8-43D1-AC14-95B9F3CAB7F5.300bceaef1.png',
'89267991-7599-4403-973C-5EAA3783B1E7':'//webeditor-static.cdn-one.com/89267991-7599-4403-973C-5EAA3783B1E7.c592d3621f.png',
'90E6AE18-E966-411E-A206-A39CC4249640':'//webeditor-static.cdn-one.com/90E6AE18-E966-411E-A206-A39CC4249640.a0354b49c6.png',
'917F5067-7446-4224-A3CA-A36F33793407':'//webeditor-static.cdn-one.com/917F5067-7446-4224-A3CA-A36F33793407.bac28592fb.png',
'92D17A27-C501-4C1A-9B74-7F2126D476AA':'//webeditor-static.cdn-one.com/92D17A27-C501-4C1A-9B74-7F2126D476AA.ea2d6ff59b.png',
'93C20709-9258-4424-8FED-00C0E4F182FE':'//webeditor-static.cdn-one.com/93C20709-9258-4424-8FED-00C0E4F182FE.d5d952c38c.png',
'9773A4DE-7F3D-480D-806C-47F2072A09F3':'//webeditor-static.cdn-one.com/9773A4DE-7F3D-480D-806C-47F2072A09F3.5bc3d3bb3b.png',
'98709062-2541-49E5-B719-2BD8EDCEAE34':'//webeditor-static.cdn-one.com/98709062-2541-49E5-B719-2BD8EDCEAE34.4769ece186.png',
'98B05EE6-3FF7-4225-8E6C-B364A4D5A4E7':'//webeditor-static.cdn-one.com/98B05EE6-3FF7-4225-8E6C-B364A4D5A4E7.fac00c26ae.png',
'998163D4-6628-4431-9649-39330FF7B1DD':'//webeditor-static.cdn-one.com/998163D4-6628-4431-9649-39330FF7B1DD.b7a14eda26.png',
'A0392AC0-A1A4-440C-9D8B-B31EF1AEF6DE':'//webeditor-static.cdn-one.com/A0392AC0-A1A4-440C-9D8B-B31EF1AEF6DE.ff0d2c8a80.png',
'A1405D9D-9BE1-4AC5-8604-BE6E20F61A7E':'//webeditor-static.cdn-one.com/A1405D9D-9BE1-4AC5-8604-BE6E20F61A7E.f62d91227f.png',
'A33A597A-F6E4-45A6-9AED-FE31C04904FA':'//webeditor-static.cdn-one.com/A33A597A-F6E4-45A6-9AED-FE31C04904FA.506e51b22d.png',
'A4642118-4EC6-40C1-8426-C2FC9844AF65':'//webeditor-static.cdn-one.com/A4642118-4EC6-40C1-8426-C2FC9844AF65.d24925efe4.png',
'A4F8FDA5-2AA3-437E-BF0A-904A71B79BD3':'//webeditor-static.cdn-one.com/A4F8FDA5-2AA3-437E-BF0A-904A71B79BD3.e719564188.png',
'A54D51AD-CC01-4463-B3B7-2DBD9A6FEF37':'//webeditor-static.cdn-one.com/A54D51AD-CC01-4463-B3B7-2DBD9A6FEF37.5da50e1cc9.png',
'A6B6C9A1-12E6-4B64-8100-460D635BF984':'//webeditor-static.cdn-one.com/A6B6C9A1-12E6-4B64-8100-460D635BF984.ffc3e8e846.png',
'A6D6D8E6-7CCD-48E3-98B8-225B15169B7C':'//webeditor-static.cdn-one.com/A6D6D8E6-7CCD-48E3-98B8-225B15169B7C.cf8e05c5d9.png',
'ABDE7B7D-C2D2-4B0F-8A05-CD93FF231B43':'//webeditor-static.cdn-one.com/ABDE7B7D-C2D2-4B0F-8A05-CD93FF231B43.f88e52b5cf.png',
'AFE0D697-B31D-4D3C-8BAE-F6E030894CF0':'//webeditor-static.cdn-one.com/AFE0D697-B31D-4D3C-8BAE-F6E030894CF0.7cc492a7ff.png',
'B12D4879-CD6B-430C-BB6C-992E925FD88B':'//webeditor-static.cdn-one.com/B12D4879-CD6B-430C-BB6C-992E925FD88B.237e532127.png',
'B35C53DD-5C8C-470F-8DA8-2153976EECE9':'//webeditor-static.cdn-one.com/B35C53DD-5C8C-470F-8DA8-2153976EECE9.f4b91e30e4.png',
'B4F12329-05EB-40E2-BE7E-BD36C0491D8D':'//webeditor-static.cdn-one.com/B4F12329-05EB-40E2-BE7E-BD36C0491D8D.412aa9df9c.png',
'B672CFDA-B43F-4B45-992C-B38A6320EC3A':'//webeditor-static.cdn-one.com/B672CFDA-B43F-4B45-992C-B38A6320EC3A.961c37788e.png',
'B6F2ED9D-A152-4959-A8F8-58F0C6E22FD1':'//webeditor-static.cdn-one.com/B6F2ED9D-A152-4959-A8F8-58F0C6E22FD1.4ee349ebcd.png',
'BCA2C9D5-7C5A-49D0-86D1-3A7E5961B2B5':'//webeditor-static.cdn-one.com/BCA2C9D5-7C5A-49D0-86D1-3A7E5961B2B5.ee9915771f.png',
'C14552AC-8DB7-4150-AB51-9B73B9401FC4':'//webeditor-static.cdn-one.com/C14552AC-8DB7-4150-AB51-9B73B9401FC4.e5eabf5ad2.png',
'C14C7795-A390-4B21-860A-C02A36B0DB0D':'//webeditor-static.cdn-one.com/C14C7795-A390-4B21-860A-C02A36B0DB0D.81ada818b0.png',
'C179F788-A044-49E3-AF4D-2D27CBD60E5A':'//webeditor-static.cdn-one.com/C179F788-A044-49E3-AF4D-2D27CBD60E5A.01ea7e46f5.png',
'C337552B-49CB-400F-8A27-0F7E739A9C96':'//webeditor-static.cdn-one.com/C337552B-49CB-400F-8A27-0F7E739A9C96.db7175741b.png',
'C3566464-F522-4956-BAFE-DC1EC8346905':'//webeditor-static.cdn-one.com/C3566464-F522-4956-BAFE-DC1EC8346905.27d0669714.png',
'C3F11272-1DAB-4E12-893C-DE32C78E2AFE':'//webeditor-static.cdn-one.com/C3F11272-1DAB-4E12-893C-DE32C78E2AFE.eaeba81c9c.png',
'C90CB248-F914-4E98-ADAF-F68C880B4057':'//webeditor-static.cdn-one.com/C90CB248-F914-4E98-ADAF-F68C880B4057.13c3eb587f.png',
'CB414496-EBCA-444A-9637-2F84BBF342E1':'//webeditor-static.cdn-one.com/CB414496-EBCA-444A-9637-2F84BBF342E1.7258ca215d.png',
'CE38524B-4C39-40DD-835C-BCCC910C6C70':'//webeditor-static.cdn-one.com/CE38524B-4C39-40DD-835C-BCCC910C6C70.9dab31a022.png',
'CE626112-0612-4A55-805E-0E91AB00BDBA':'//webeditor-static.cdn-one.com/CE626112-0612-4A55-805E-0E91AB00BDBA.1a5f83a723.png',
'D16D963A-BF9C-4463-9937-2E2CE154F6DD':'//webeditor-static.cdn-one.com/D16D963A-BF9C-4463-9937-2E2CE154F6DD.109dd59afe.png',
'D3FB1D53-3D5B-4014-BFF6-C03B22371004':'//webeditor-static.cdn-one.com/D3FB1D53-3D5B-4014-BFF6-C03B22371004.9a332aac1c.png',
'D73C7D3F-DCD7-4370-86A4-490A44136013':'//webeditor-static.cdn-one.com/D73C7D3F-DCD7-4370-86A4-490A44136013.6818d31767.png',
'D85CFDB4-466E-43BE-BDBD-F8D92BB37B60':'//webeditor-static.cdn-one.com/D85CFDB4-466E-43BE-BDBD-F8D92BB37B60.e02414538e.png',
'DA2CFBCD-2C75-4948-8B4E-1598383D5113':'//webeditor-static.cdn-one.com/DA2CFBCD-2C75-4948-8B4E-1598383D5113.5ee26d4eda.png',
'DAB59EC3-648B-4095-B233-1D935C33E2F6':'//webeditor-static.cdn-one.com/DAB59EC3-648B-4095-B233-1D935C33E2F6.08a9ccd30d.png',
'DB127167-B1F2-414B-9314-1D0F59FB1EB5':'//webeditor-static.cdn-one.com/DB127167-B1F2-414B-9314-1D0F59FB1EB5.f8d73f1a51.png',
'DD6F2D53-BECB-4B32-ACCD-B3CB7D584B6D':'//webeditor-static.cdn-one.com/DD6F2D53-BECB-4B32-ACCD-B3CB7D584B6D.f9e380bd73.png',
'DDDF9E1C-E288-454B-B20D-2E5CA55E22B6':'//webeditor-static.cdn-one.com/DDDF9E1C-E288-454B-B20D-2E5CA55E22B6.4f1583f431.png',
'DFF82427-AC15-4AA4-96A8-C9D137E851CA':'//webeditor-static.cdn-one.com/DFF82427-AC15-4AA4-96A8-C9D137E851CA.22ce62597a.png',
'E1FAD3A0-50DA-4B5F-99A7-B59BC46568BF':'//webeditor-static.cdn-one.com/E1FAD3A0-50DA-4B5F-99A7-B59BC46568BF.a2e1d060be.png',
'E6BECFFE-E8AE-4347-8231-4F952EF49393':'//webeditor-static.cdn-one.com/E6BECFFE-E8AE-4347-8231-4F952EF49393.90667ba3dc.png',
'EAE09073-6A96-4868-A79E-BB4180616034':'//webeditor-static.cdn-one.com/EAE09073-6A96-4868-A79E-BB4180616034.87fca8d129.png',
'EBD0C7E9-CDC5-4192-AFB9-3CD3D1116E8A':'//webeditor-static.cdn-one.com/EBD0C7E9-CDC5-4192-AFB9-3CD3D1116E8A.294b6d46cd.png',
'EBDC86F6-7098-417F-BEB7-02AADF6AA0EF':'//webeditor-static.cdn-one.com/EBDC86F6-7098-417F-BEB7-02AADF6AA0EF.9f1c2e1e07.png',
'EE6B32F3-69A1-4CB1-8484-739959A262B3':'//webeditor-static.cdn-one.com/EE6B32F3-69A1-4CB1-8484-739959A262B3.4ac3cf6ef3.png',
'EF6525A1-4EDE-4DF0-832B-86501AD62D4F':'//webeditor-static.cdn-one.com/EF6525A1-4EDE-4DF0-832B-86501AD62D4F.18d2ab4314.png',
'EFE438DC-B311-40A0-8FEF-F171024B9534':'//webeditor-static.cdn-one.com/EFE438DC-B311-40A0-8FEF-F171024B9534.6a5b59128f.png',
'F461723F-15FB-4AC9-A6DB-A67C3F29003A':'//webeditor-static.cdn-one.com/F461723F-15FB-4AC9-A6DB-A67C3F29003A.a427697908.png',
'F5764FBD-7435-458C-A387-5AA294513931':'//webeditor-static.cdn-one.com/F5764FBD-7435-458C-A387-5AA294513931.8209347f93.png',
'F8B2BD28-2441-4B95-BC9C-9F439796C17F':'//webeditor-static.cdn-one.com/F8B2BD28-2441-4B95-BC9C-9F439796C17F.8835eacf34.png',
'F8E77251-68FB-48FE-A095-57707A18912B':'//webeditor-static.cdn-one.com/F8E77251-68FB-48FE-A095-57707A18912B.2568a0bbc9.png',
'FBD16911-F3B2-492E-99A9-F5820E013F1A':'//webeditor-static.cdn-one.com/FBD16911-F3B2-492E-99A9-F5820E013F1A.019858fb8a.png',
'FEC7673E-9967-406E-99BC-62CE1D0A6936':'//webeditor-static.cdn-one.com/FEC7673E-9967-406E-99BC-62CE1D0A6936.477befda71.png'
}
}
}[width][height][id]
}
});
Ext.reg('web-pageimport-ui-selectsingletemplate',web.pageImport.ui.SelectSingleTemplate);
web.pageImport.ui.SelectTemplateContent=Ext.extend(web.pageImport.ui.Panel,{
xtype:'web-pageimport-ui-selecttemplatecontent',
initComponent:function(){
this.template=null;
this.bodyItems=[
{
xtype:'container',
layout:'hflex',
items:[{
xtype:'label',
flex:1,
text:'Draw a rectangle around the area that contains your page content. Your page content is the part that changes from page to page.'
}]
},
{
xtype:'spacer',
height:23
},
{
ref:'panel',
xtype:'web-pageImport-ui-pageContentSelector',
flex:1,
listeners:{
select:function(){
this.enableNextButton()
},
deselect:function(){
this.disableNextButton()
},
scope:this
}
}
];
this.buttons=[];
this.nextButtonDefaultText='Next Page';
this.fbar={
layout:'hflex',
cls:'footer-extra-padding',
items:[
{
xtype:'container',
style:{verticalAlign:'middle'},
items:[{
xtype:'button',
ref:'../../backButton',
cls:'import-back-btn',
text:'Back',
width:'auto',
autoWidth:true,
handler:function(){
this.fireEvent('previous')
},
scope:this
}]
},
{
ref:'../counter',
xtype:'container',
flex:1,
style:{
textAlign:'center',
padding:'0 0 0 150px'
},
html:'Number of pages'
},
{
ref:'../nextButton',
margins:'0',
text:this.nextButtonDefaultText,
cls:'x-btn-primary large wide',
handler:function(){
this.fireEvent('next',true);
this.clear()
},
scope:this
}
]
};
this.listeners={
show:function(){
this.panel.clearSelection()
}
};
web.pageImport.ui.SelectTemplateContent.superclass.initComponent.call(this)
},
initLoad:function(cfg){
var text=cfg.total>1?this.nextButtonDefaultText:'Finish';
this.nextButton.setText(text);
this.el.mask('Loading page...');
if(cfg.total&&cfg.filename){
this.counter.update('<span style="font-weight:bold;">'+('Page 1 of '+cfg.total+':')+'</span> <span style="color: #999;">'+cfg.filename+'</span>')
}else{
this.counter.update('&nbsp;',false)
}
this.disableNextButton()
},
update:function(page){
var doc=new web.Document({
dm:new web.DM,
domain:this.app.dal.domain,
editMode:true,
classPrefix:'web-pageImport'
});
page.render(doc);
page.getTemplate().renderBody(doc);
var styles='<style type="text/css">'+doc.getStylesCSS()+'</style>',html='<div class="body blockbody" style="padding: 10px">'+'<div style="width:'+(page.getTemplate().bbox.right-page.getTemplate().bbox.left)+'px;margin:auto;position:relative;">'+doc.toBodyHTML()+'</div>'+'</div>';
this.panel.update(styles+html);
this.panel.getEl().dom.scrollTop=0
},
clear:function(){
this.panel.update('')
},
hideLoading:function(){
this.el.unmask()
},
showWarning:function(){
var ref=this.messages.guestbook;
Ext.Msg.alert(ref.title,ref.text)
},
getSelected:function(){
return this.panel.getSelectedComponentIds()
}
});
Ext.reg('web-pageimport-ui-selecttemplatecontent',web.pageImport.ui.SelectTemplateContent);
web.pageImport.ui.SelectTemplateContentCover=Ext.extend(web.pageImport.ui.Panel,{
initComponent:function(){
this.bodyItems=[
{
xtype:'container',
flex:1,
html:'<div class="import-ui-column import-ui-green-messagebox"><div><div class=info-green></div></div><div><p style=font-size:16px>For each of your pages you now need to choose the area on each page that contains your page content. That is the area that changes from page to page.</p></div></div><div class="coverPanel import-ui-column" style=margin-top:30px><div style=width:50%;padding-right:30px><p class=import-ui-blue-text>What is page content?</p><p style=margin-top:15px>The red area is your page content and the rest represent your template.</p><div class="page-content-image pagecontent-example-1"></div><div class=pagecontent-example-links><span class=active>Example 1</span> | |</div></div><div style="width:1px;border-left:1px solid #d6d6d6"></div><div style=width:50%;padding-left:30px><p class=import-ui-blue-text>Video guide</p><p style=margin-top:15px;margin-bottom:36px>This video shows you how to determine the page content.</p><iframe id=video-guide width=415 height=367 src="" allowtransparency=true frameborder=0 scrolling=no allowfullscreen></iframe><div id=selecttemplatecontentcover-text-guide-btn style=margin-top:10px></div></div></div>',
style:{overflow:'auto'},
listeners:{
afterrender:function(){
var links=Ext.select('.web-pageImport .pagecontent-example-links span');
links.on('click',function(e){
var active=Ext.select('.web-pageImport .pagecontent-example-links .active'),activeIndex=links.elements.indexOf(active.elements[0])+1,target=e.getTarget(),index=links.elements.indexOf(target)+1,imageDiv=Ext.select('.web-pageImport .page-content-image');
active.removeClass('active');
Ext.get(target).addClass('active');
imageDiv.replaceClass('pagecontent-example-'+activeIndex,'pagecontent-example-'+index)
},this);
var iframe=document.querySelector('.web-pageImport .coverPanel #video-guide'),englishVideoUrl='//fast.wistia.net/embed/iframe/tbzuzaclmg',videoForLang={
da:'//fast.wistia.net/embed/iframe/jvs9ld8cmi',
de:'//fast.wistia.net/embed/iframe/jbvajzkth4',
en_gb:englishVideoUrl,
en_us:englishVideoUrl,
es:'//fast.wistia.net/embed/iframe/u0d5r5hl0w',
fr:'//fast.wistia.net/embed/iframe/c30fzh1trh',
it:'//fast.wistia.net/embed/iframe/1n5y3h5ixp',
nb:'//fast.wistia.net/embed/iframe/oonuw2zjcb',
nl:'//fast.wistia.net/embed/iframe/f8iuhu0w7d',
sv:'//fast.wistia.net/embed/iframe/kb54a7zfk3'
};
iframe.src=videoForLang[one.locale.id]||englishVideoUrl;
Ext.create({
xtype:'button',
renderTo:iframe.parentNode,
hidden:true,
cls:'x-btn-primary large wide',
text:'See text guide',
listeners:{
click:function(){
}
}
})
},
afterlayout:function(){
var iframe=Ext.get(document.querySelector('.web-pageImport .coverPanel #video-guide'));
iframe.setStyle('display','none');
iframe.dom.width=window.getComputedStyle(iframe.dom.parentNode).width;
iframe.setStyle('display','')
},
scope:this
}
},
{
xtype:'container',
ref:'progress',
items:{
xtype:'progress',
width:335,
height:52,
value:1
}
}
];
this.on('afterlayout',function(){
Ext.create({
xtype:'container',
style:{
position:'absolute',
right:'22px',
bottom:'5px'
},
html:'Please read before continuing',
renderTo:this.body.dom
})
},this,{single:true});
web.pageImport.ui.SelectTemplateContentCover.superclass.initComponent.call(this);
this.nextButton.setText('Ok, I understand')
},
showProgress:function(){
this.progress.show();
this.previousButton.disable();
this.nextButton.disable()
},
hideProgress:function(){
this.progress.hide();
this.previousButton.enable();
this.nextButton.enable()
}
});
Ext.reg('web-pageimport-ui-selecttemplatecontentcover',web.pageImport.ui.SelectTemplateContentCover);
web.pageImport.ui.Success=Ext.extend(Ext.Panel,{
initComponent:function(){
this.title='Recreate WebCreator pages';
this.items=[
{
xtype:'box',
cls:'import-ui-column import-ui-green-messagebox',
html:'<div><div class="info-green"></div></div>'+'<div>'+'<p style="font-size: 16px;">'+'Almost done...'+'</p>'+'<p style="margin-top: 22px;">'+'Close this tool and go through each of your pages and adjust the look and correct any mistakes.'+'</p>'+'<p style="margin-top:22px">When you are done, click <span style="font-weight:700">Publish</span> to make your changes visible on the internet. Until you click <span style="font-weight:700">Publish</span>, no WebCreator pages will be deleted.</p>'+'</div>'
},
{
xtype:'box',
html:'<p style="margin:30px 0 0 10px">Check out <a href="https://www.one.com/en/support/guides-faq#webeditor" target="_blank">these guides</a> to get more tips on how to use Website Builder.</p>'
}
];
this.bodyCfg={cls:'x-panel-body web-pageImport-ui-success import-ui-inner'};
web.pageImport.ui.Success.superclass.initComponent.call(this)
}
});
Ext.reg('web-pageimport-ui-success',web.pageImport.ui.Success);
web.pageImport.ui.Preface=Ext.extend(web.pageImport.ui.Panel,{
initComponent:function(){
this.bodyItems=[{
flex:1,
xtype:'container',
layout:'hbox',
layoutConfig:{align:'middle'},
items:[{
xtype:'container',
flex:1,
html:'<div class="import-ui-column import-ui-green-messagebox" style="margin: 0 auto; width: 500px;">'+'<div><div class="info-green"></div></div>'+'<div>'+'<p style="font-size: 16px;">'+'Recreate all your WebCreator pages in Website Builder'+'</p>'+'<br/>'+'<p>'+'This tool helps you select the content you want to recreate in Website Builder, and goes through all your pages.'+'</p>'+'<br/>'+'<p>Your WebCreator pages will not be deleted while using this tool. To make the recreated pages visible, click <span style="font-weight:700">Publish</span> in Website Builder.</p>'+'<br/>'+'<p>'+'So you can use this tool without worry.'+'</p>'+'<br/>'+'<p style="font-weight: bold;">'+'Note:'+'</p>'+'<p>'+'Your pages will look a little different after recreating them, and you might need to make some manual adjustments to each page afterwards.'+'</p>'+'</div>'+'</div>'
}]
}];
this.buttons=[
'->',
{
ref:'../nextButton',
text:'Ok, I understand',
cls:'x-btn-primary large wide',
autoWidth:true,
handler:function(){
this.fireEvent('nextpage')
},
scope:this
}
];
web.pageImport.ui.Preface.superclass.initComponent.call(this);
this.on('afterlayout',function(){
Ext.create({
xtype:'container',
style:{
position:'absolute',
right:'22px',
bottom:'5px'
},
html:'Please read before continuing',
renderTo:this.body.dom
})
},this,{single:true})
}
});
Ext.reg('web-pageimport-ui-preface',web.pageImport.ui.Preface);
Ext.ns('web.ui.plugins');
web.ui.plugins.DomObserver=Ext.extend(Object,{
constructor:function(config){
this.listeners=config
},
init:function(component){
var x,listeners=this.listeners;
for(x in listeners){
if(listeners.hasOwnProperty(x)&&Ext.isFunction(listeners[x])){
listeners[x]=this.bind(listeners[x],component,listeners.scope)
}
}
component.render=component.render.createSequence(function(){
var el=component.getEl();
if(el){
el.on(listeners)
}
})
},
bind:function(fn,component,scope){
return function(event){
fn.call(scope||this,event,component)
}
}
});
web.pageImport.ui.TypeChooser=Ext.extend(web.pageImport.ui.Panel,{
initComponent:function(){
this.bodyItems=[{
xtype:'container',
flex:1,
layout:'vbox',
layoutConfig:{
align:'center',
pack:'center'
},
items:[
{
xtype:'container',
height:80,
html:'<h2 style="padding-top: 20px; text-align: center;" class="import-ui-blue-text">'+'What do you want to recreate from WebCreator?'+'</h2>'
},
{
xtype:'container',
layout:'hbox',
layoutConfig:{
align:'stretch',
pack:'center'
},
ref:'../coverPanel',
cls:'coverPanel',
width:654,
height:270,
style:{
margin:'auto',
textAlign:'center'
},
items:[
{
xtype:'container',
style:{textAlign:'center'},
width:297,
items:[{
xtype:'container',
width:297,
height:244,
cls:'typechooser-button',
items:[
{
xtype:'container',
html:'<div class="full-page-image" style="height: 148px;"></div>'+'<p style="color: #888; padding: 0 20px 18px 20px;">'+'Your complete WebCreator pages are recreated in Website Builder.'+'</p>'
},
{
xtype:'button',
cls:'x-btn-primary large wide',
text:'Recreate entire pages'
}
],
plugins:[new web.ui.plugins.DomObserver({
click:function(){
this.fireEvent('click','webc')
},
scope:this
})]
}]
},
{
xtype:'container',
width:60,
height:20
},
{
xtype:'container',
style:{textAlign:'center'},
width:297,
items:[{
xtype:'container',
ref:'../../../recreateIntoTemplateButton',
width:297,
height:244,
cls:'typechooser-button',
items:[
{
xtype:'container',
html:'<div class="copy-page-image" style="height: 148px;"></div>'+'<p style="color: #888; padding: 0 20px 18px 20px;">'+'WebCreator content is inserted into a Website Builder template.'+'</p>'
},
{
xtype:'button',
cls:'x-btn-primary large wide',
text:'Recreate into template'
}
],
plugins:[new web.ui.plugins.DomObserver({
click:function(){
this.fireEvent('click','webeditor')
},
scope:this
})]
}]
}
]
}
]
}];
this.buttons=[{
ref:'../previousButton',
xtype:'button',
text:'Back',
cls:'import-back-btn',
width:'auto',
autoWidth:true,
handler:function(){
this.fireEvent('prevpage')
},
scope:this
}];
this.newDesignBanner=Ext.create({
xtype:'container',
cls:'newdesignbanner',
html:'Get a new design for your WebCreator pages',
style:{position:'absolute'}
});
this.addEvents('click');
web.pageImport.ui.TypeChooser.superclass.initComponent.call(this);
this.coverPanel.on('afterlayout',this.placeBanner,this);
this.on('resize',this.placeBanner,this)
},
placeBanner:function(){
var banner=this.newDesignBanner;
if(!banner.rendered){
banner.render(this.getEl().dom)
}
var bannerParentOffset=Ext.get(banner.getEl().dom.offsetParent).getXY(),ref=this.recreateIntoTemplateButton.getEl(),xy=ref.getXY();
banner.setPosition(xy[0]+ref.getWidth()-banner.getWidth()/2,xy[1]-bannerParentOffset[1]-banner.getHeight()/2)
}
});
Ext.reg('web-pageimport-ui-typechooser',web.pageImport.ui.TypeChooser);
web.pageImport.ui.Wait=Ext.extend(Ext.BoxComponent,{html:'WAIT'});
Ext.reg('web-pageimport-ui-wait',web.pageImport.ui.Wait);
Ext.ns('web.pageImport.ui.steps');
web.pageImport.ui.steps.Controller=function(context,app){
var importer,toExecute,executed,destroyed=true;
var addLinks=function(links){
var linkPage=context.getSelectedLinkPage();
links.forEach(function(link){
linkPage.addItem(app.dm.create({
type:'web.data.links.LinkExternal',
name:link.name,
url:link.url,
target:link.target,
hidden:!!link.hidden
}))
})
};
this.init=function(){
if(!destroyed){
this.destroy()
}
importer=new web.pageImport.Importer(app.dal);
toExecute=[];
executed=[];
importer.setSite(app.site);
importer.on('pagesaved',function(page,info){
var linkPage=context.getSelectedLinkPage(),cfg={
type:'web.data.links.LinkPage',
pageId:page.id,
name:info.name,
title:info.name,
hidden:!!info.hidden
};
if(info.homePage&&!app.site.homePageId){
app.site.homePageId=page.id
}
if(info.links){
addLinks(info.links)
}
linkPage.addItem(app.dm.create(cfg));
if(info.rearLinks){
addLinks(info.rearLinks)
}
app.fireEvent('update',linkPage)
});
importer.on('addlinks',addLinks);
destroyed=false
};
this.queue=function(command,clear){
if(Ext.isArray(command)){
if(clear){
toExecute=command
}else{
toExecute=toExecute.concat(command)
}
}else{
if(clear){
toExecute=[command]
}else{
toExecute.push(command)
}
}
};
this.execute=function(command){
if(command){
toExecute=[]
}else{
command=toExecute.shift()
}
command.importer=importer;
if(command instanceof web.pageImport.ui.steps.Command){
executed.push(command);
command.execute()
}
};
var executeBinded=this.execute.createDelegate(this);
this.complete=function(){
var lastCommand=executed[executed.length-1];
if(lastCommand.complete){
lastCommand.complete(executeBinded)
}else{
this.execute()
}
};
this.undo=function(){
var command=executed.pop();
if(Ext.isFunction(command.undo)){
toExecute.unshift(command);
command.undo()
}else{
executed.push(command)
}
};
this.destroy=function(){
toExecute=null;
executed=null;
importer.purgeListeners();
destroyed=true
}
};
Ext.ns('web.pageImport.ui.steps.webc');
web.pageImport.ui.steps.Command=function(context,opts){
this.context=context;
this.opts=opts;
this.prevState=null
};
web.pageImport.ui.steps.Command.prototype={
constructor:web.pageImport.ui.steps.Command,
execute:Ext.emptyFn,
complete:null,
undo:Ext.emptyFn,
set:function(opts){
Ext.apply(this.opts,opts)
}
};
web.pageImport.ui.steps.webc.Complete=Ext.extend(web.pageImport.ui.steps.Command,{
execute:function(){
this.context.showPage('success')
}
});
web.pageImport.ui.steps.webc.SelectPageContent=Ext.extend(web.pageImport.ui.steps.Command,{
execute:function(){
var panel=this.context.showPage('selectPageContent');
panel.initLoad({
index:this.opts.index,
total:this.opts.total,
filename:this.opts.pageUrl.replace(/.*\//,'')
});
this.importer.doesPageExist({
url:this.opts.pageUrl,
name:this.opts.name
},function(success,status){
if(success){
this.importer.importPage({
url:this.opts.pageUrl,
name:this.opts.name,
hidden:this.opts.hidden
},function(success,data){
this.opts.name=this.opts.name||data.page.name;
panel.hideLoading();
if(success){
panel.update(data.page);
if(this.importer.wasGuestbookFound()){
panel.showWarning('guestbook')
}
}
},this)
}else{
panel.hideLoading();
panel.fireEvent('next',false)
}
},this)
},
complete:function(next){
var currentPanel=this.context.getCurrentPage(),importer=this.importer;
importer.makePageFromComponentIds(currentPanel.getSelected(),function(template,page){
importer.createPage(page,{
name:this.opts.name,
hidden:this.opts.hidden,
links:this.opts.links,
rearLinks:this.opts.rearLinks
},function(){
next()
},this)
},this)
}
});
web.pageImport.ui.steps.webc.SelectTemplateContent=Ext.extend(web.pageImport.ui.steps.Command,{
execute:function(){
var panel=this.context.showPage('selectTemplateContent');
panel.initLoad({
total:this.opts.total,
filename:this.opts.filename.replace(/.*\//,'')
});
setTimeout(function(){
panel.update(this.opts.page);
if(this.importer.wasGuestbookFound()){
this.context.getCurrentPage().showWarning('guestbook')
}
panel.hideLoading()
}.bind(this),50)
},
complete:function(next){
var currentPanel=this.context.getCurrentPage(),cfg={
homePage:true,
name:this.opts.frontPage.name,
hidden:this.opts.frontPage.hidden,
rearLinks:this.opts.rearLinks
};
this.importer.extractFirstPage(currentPanel.getSelected(),true,cfg,function(success,pageId){
if(success){
next()
}else{
Ext.Msg.show({
cls:'web-modal-warning',
iconCls:'web-warning-icon',
buttons:Ext.MessageBox.OK,
title:'An error occurred',
msg:'An error occurred while saving the page.'+' '+'Please try again later or contact our support for further assistance.'
})
}
},this)
},
undo:function(){
this.context.showPage('selectTemplateContentCover')
}
});
web.pageImport.ui.steps.webc.DescribeTemplateContent=Ext.extend(web.pageImport.ui.steps.Command,{
execute:function(){
var frontPageUrl=this.opts.frontPageChooser.getSelected(),selectTemplateContentCoverPanel=this.context.showPage('selectTemplateContentCover');
var found=this.opts.menuItems.filter(function(o){
return o.url===frontPageUrl&&o.type==='page'
}).pop();
selectTemplateContentCoverPanel.showProgress();
this.queueCommands({
url:frontPageUrl,
name:found&&found.name||'',
hidden:found&&found.hidden
},function(){
selectTemplateContentCoverPanel.hideProgress()
})
},
undo:function(){
this.context.showPage('projectPageChooser')
},
queueCommands:function(frontPage,callback){
this.importer.doesPageExist({
url:frontPage.url,
name:frontPage.name,
isFrontPage:true
},function(success,status){
if(success){
this.importer.importTemplate(frontPage,function(success,data){
if(success){
frontPage.name=frontPage.name||data.page.name;
var totalPages=this.opts.menuItems.reduce(function(count,o){
return count+(o.type==='page'?1:0)
},0),commands=[new web.pageImport.ui.steps.webc.SelectTemplateContent(this.context,{
frontPage:frontPage,
page:data.page,
total:totalPages,
filename:frontPage.url
})],pageIndex=1;
var links=[];
this.opts.menuItems.forEach(function(page){
if(page.type==='link'){
links.push(Ext.apply({},page))
}else if(page.url!==frontPage.url){
pageIndex+=1;
commands.push(new web.pageImport.ui.steps.webc.SelectPageContent(this.context,{
frontPage:frontPage,
name:page.name,
pageUrl:page.url,
hidden:page.hidden,
links:links,
index:pageIndex,
total:totalPages
}));
links=[]
}
},this);
if(links.length){
commands[commands.length-1].set({rearLinks:links})
}
commands.push(new web.pageImport.ui.steps.webc.Complete(this.context));
this.context.queue(commands,true);
callback.call(this)
}else{
Ext.Msg.show({
cls:'web-modal-warning x-window-dlg',
iconCls:'web-warning-icon',
title:'Import error',
msg:'<b>'+'An error occurred while importing the selected page.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.'
})
}
},this)
}else{
this.context.getCurrentPage().fireEvent('previous')
}
},this)
}
});
web.pageImport.ui.steps.webc.ChooseProjectFiles=Ext.extend(web.pageImport.ui.steps.Command,{
execute:function(){
var selected=this.opts.getSelected(),next=function(scope){
var pageChooser=scope.context.showPage('projectPageChooser'),menuItems;
if(scope.opts instanceof web.pageImport.ui.ProjectChooser){
menuItems=selected.menuItems;
scope.importer.setSourceTemplateId(selected.templateId);
pageChooser.update(selected.menuItems.filter(function(o){
return o.type==='page'
}))
}else{
menuItems=selected;
scope.importer.setSourceTemplateId(null);
pageChooser.update(selected)
}
scope.context.queue(new web.pageImport.ui.steps.webc.DescribeTemplateContent(scope.context,{
menuItems:menuItems,
frontPageChooser:pageChooser
}),true)
};
if(this.opts instanceof web.pageImport.ui.PageChooser){
next(this)
}else{
this.context.app.rep.getList('web.data.styles.Stylesheet',true,function(opts,success,response){
if(!success){
next(this);
return
}
var menuStylesheet,stylesheets=Ext.decode(response.responseText),length=stylesheets.length,i;
for(i=0;i<length;i+=1){
if(stylesheets[i].name==='webcreator menus'){
menuStylesheet=stylesheets[i];
break
}
}
if(menuStylesheet){
this.context.app.rep.get('web.data.styles.Stylesheet',menuStylesheet.id,function(opts,success,response){
if(success){
var stylesheet=this.importer.dm.create(Ext.decode(response.responseText)),menu=stylesheet.getStyleByRef(this.importer.getMenuStyleRef(selected.templateId));
if(menu){
this.importer.setDefaultStyle({
menu:Ext.applyIf({
name:'[menu.1]',
ref:'menu.1'
},menu)
});
next(this)
}
}else{
next(this)
}
},this)
}else{
next(this)
}
},this)
}
},
undo:function(){
var panel=this.context.showPage(this.opts.ref);
if(panel.hideLoading){
panel.hideLoading()
}
}
});
web.pageImport.ui.steps.webc.ChooseProject=Ext.extend(web.pageImport.ui.steps.Command,{
execute:function(){
var projectChooser=this.context.showPage('projectChooser');
projectChooser.setFrom('webc');
projectChooser.refresh();
projectChooser.on('next',function(){
projectChooser.showLoading()
},this,{single:true});
this.context.queue(new web.pageImport.ui.steps.webc.ChooseProjectFiles(this.context,projectChooser),true)
},
undo:function(){
this.context.showPage('typeChooser')
}
});
web.pageImport.ui.steps.webc.ChooseFiles=Ext.extend(web.pageImport.ui.steps.Command,{
execute:function(){
this.context.showPage('pageChooser')
},
complete:function(callback){
var panel=this.context.getCurrentPage();
this.context.queue(new web.pageImport.ui.steps.webc.ChooseProjectFiles(this.context,panel));
callback()
},
undo:function(){
this.context.showPage('projectChooser')
}
});
Ext.ns('web.pageImport.ui.steps.webeditor');
web.pageImport.ui.steps.webeditor.CompleteSinglePage=Ext.extend(web.pageImport.ui.steps.Command,{
execute:function(){
this.context.showPage('success')
},
undo:function(){
}
});
web.pageImport.ui.steps.webeditor.SelectSinglePageContent=Ext.extend(web.pageImport.ui.steps.Command,{
execute:function(){
var importer=this.importer,panel=this.context.showPage('selectPageContent');
panel.initLoad({
index:this.opts.index,
total:this.opts.totalPages,
filename:this.opts.item.url.replace(/.*\//,'')
});
panel.updateLabel('Draw a rectangle around the area that contains your page content. Your page content is the part that changes from page to page.');
panel.hideGuide();
importer.importPage({url:this.opts.item.url},function(success,data){
if(success){
panel.update(data.page);
panel.hideLoading();
if(importer.wasGuestbookFound()){
panel.showWarning('guestbook')
}
}else{
panel.hideLoading();
one.error('<b>'+'Error while importing page'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.','An error occurred');
this.importer.addExternalLinks(this.opts.links);
this.importer.addExternalLinks(this.opts.rearLinks||[]);
panel.fireEvent('next',false)
}
},this)
},
complete:function(next){
var panel=this.context.getCurrentPage(),importer=this.importer;
if(this.opts.item.type==='page'){
importer.setTemplate(importer.dm.get(this.opts.templateId));
importer.makePageFromComponentIds(panel.getSelected(),function(template,page){
importer.createPage(page,{
name:this.opts.item.name||panel.getPageName(),
hidden:this.opts.item.hidden,
links:this.opts.links,
rearLinks:this.opts.rearLinks
},function(){
next()
},this)
},this)
}else{
next()
}
}
});
web.pageImport.ui.steps.webeditor.SelectSingleTemplate=Ext.extend(web.pageImport.ui.steps.Command,{
execute:function(){
this.context.showPage('selectSingleTemplate')
},
complete:function(callback){
var templateInfo=this.context.getCurrentPage().getSelected(),templateType=templateInfo.templateType,selectedItems=this.opts.selectedItems,importer=this.importer;
if(templateType==='modified'){
this.context.app.dal.getWithDependents(templateInfo.templateId,'web.data.components.Template',function(opts,success,response){
if(success){
var data=Ext.decode(response.responseText);
importer.dm.create(data.stylesheet);
this.queueCommands(callback,selectedItems,importer.dm.create(data.template))
}
},this)
}else{
this.context.app.rep.getCopyWithDependents(templateInfo.templateId,'web.data.components.Template',function(opts,success,response){
if(success){
var data=Ext.decode(response.responseText),template=importer.dm.create(data.template);
importer.setTemplate(template);
importer.dm.create(data.stylesheet);
importer.saveTemplateAndStylesheet(function(success){
if(success){
this.queueCommands(callback,selectedItems,template)
}
},this)
}
},this)
}
},
undo:function(){
this.context.showPage('selectSinglePageContentCover')
},
queueCommands:function(callback,selectedItems,template){
var totalPages=0,templateId=template.id,firstUrl,importer=this.importer;
selectedItems.forEach(function(o){
if(o.type==='page'){
if(!firstUrl){
firstUrl=o.url
}
totalPages+=1
}
});
importer.doesPageExist({url:firstUrl},function(success){
if(success){
importer.setTemplate(template);
var pageNumber=0,links=[],commands=[];
selectedItems.forEach(function(o,index){
if(o.type==='link'){
links.push(o)
}else{
pageNumber+=1;
var cmd=new web.pageImport.ui.steps.webeditor.SelectSinglePageContent(this.context,{
item:o,
links:links,
templateId:templateId,
index:pageNumber,
totalPages:totalPages
});
links=[];
commands.push(cmd)
}
},this);
if(links.length){
commands[commands.length-1].set({rearLinks:links})
}
commands.push(new web.pageImport.ui.steps.webeditor.CompleteSinglePage(this.context,{templateId:templateId}));
this.context.queue(commands);
callback()
}else{
this.context.getCurrentPage().fireEvent('next',false)
}
},this)
}
});
web.pageImport.ui.steps.webeditor.ImportIndividualPagesCover=Ext.extend(web.pageImport.ui.steps.Command,{
execute:function(){
this.context.showPage('selectSinglePageContentCover');
this.context.queue(new web.pageImport.ui.steps.webeditor.SelectSingleTemplate(this.context,{selectedItems:this.opts.items}))
},
undo:function(){
this.context.showPage('pageChooser')
}
});
web.pageImport.ui.steps.webeditor.ChooseFiles=Ext.extend(web.pageImport.ui.steps.Command,{
execute:function(){
this.context.showPage('pageChooser')
},
complete:function(callback){
var panel=this.context.getCurrentPage();
this.context.queue(new web.pageImport.ui.steps.webeditor.ImportIndividualPagesCover(this.context,{items:panel.getSelected()}));
callback()
},
undo:function(){
this.context.showPage('projectChooser')
}
});
web.pageImport.ui.steps.webeditor.ChooseProject=Ext.extend(web.pageImport.ui.steps.Command,{
execute:function(){
var projectChooser=this.context.showPage('projectChooser');
projectChooser.setFrom('webeditor');
projectChooser.refresh();
projectChooser.on('next',function(){
projectChooser.showLoading()
},this,{single:true})
},
complete:function(callback){
var projectChooser=this.context.getCurrentPage();
this.context.queue(new web.pageImport.ui.steps.webeditor.ImportIndividualPagesCover(this.context,{items:projectChooser.getSelected().menuItems}));
callback()
},
undo:function(){
this.context.showPage('typeChooser')
}
});
web.pageImport.ui.Window=Ext.extend(Ext.Container,{
xtype:'page-import-main',
initComponent:function(){
this.controller=new web.pageImport.ui.steps.Controller(this,this.app);
this.cls='web-pageImport';
this.title='Recreate WebCreator pages';
this.minWidth=600;
this.minHeight=400;
this.closeAction='close';
this.modal=true;
this.layout='card';
this.layoutConfig={deferredRender:true};
this.defaults={
buttonAlign:'left',
listeners:{
next:function(success){
this.next(success)
},
previous:function(){
this.previous()
},
closepanel:function(){
if(this.selectTemplateContent.isVisible()){
this.selectTemplateContent.clear()
}
if(this.selectPageContent.isVisible()){
this.selectPageContent.clear()
}
this.closePanel()
},
scope:this
}
};
this.activeItem=0;
this.items=[
{
ref:'preface',
xtype:'web-pageimport-ui-preface',
listeners:{
nextpage:function(){
this.showPage('typeChooser')
},
closepanel:this.defaults.listeners.closepanel,
scope:this
}
},
{
ref:'typeChooser',
xtype:'web-pageimport-ui-typechooser',
listeners:Ext.apply({
prevpage:function(){
this.showPage('preface')
},
click:function(id){
var ns=web.pageImport.ui.steps,cmd=id==='webc'?new ns.webc.ChooseProject(this):new ns.webeditor.ChooseProject(this);
this.controller.queue(cmd,true);
this.controller.execute()
}
},this.defaults.listeners)
},
{
ref:'projectChooser',
xtype:'web-pageimport-ui-projectchooser',
app:this.app,
listeners:Ext.apply({
selectindividualpages:function(from){
var ns=web.pageImport.ui.steps,cmd=from==='webc'?new ns.webc.ChooseFiles(this):new ns.webeditor.ChooseFiles(this);
this.controller.queue(cmd,true);
this.controller.execute()
}
},this.defaults.listeners)
},
{
ref:'projectPageChooser',
xtype:'web-pageimport-ui-projectpagechooser',
app:this.app
},
{
ref:'pageChooser',
xtype:'web-pageimport-ui-pagechooser',
app:this.app
},
{
ref:'selectTemplateContentCover',
xtype:'web-pageimport-ui-selecttemplatecontentcover'
},
{
ref:'selectTemplateContent',
xtype:'web-pageimport-ui-selecttemplatecontent',
app:this.app
},
{
ref:'selectSinglePageContentCover',
xtype:'web-pageimport-ui-selectsinglepagecontentcover'
},
{
ref:'selectPageContent',
xtype:'web-pageimport-ui-selectpagecontent',
app:this.app,
listeners:Ext.apply({
startover:function(){
this.showPage('typeChooser')
}
},this.defaults.listeners)
},
{
ref:'selectSingleTemplate',
xtype:'web-pageimport-ui-selectsingletemplate',
app:this.app
},
{
ref:'success',
xtype:'web-pageimport-ui-success',
buttonAlign:'left',
buttons:[
'->',
{
text:'Close',
cls:'x-btn-primary large wide',
handler:function(){
this.closePanel('redraw')
},
scope:this
}
],
listeners:Ext.apply({
show:function(){
this.app.track([
'Import Tool',
'Success'
])
}
},this.defaults.listeners)
}
];
web.pageImport.ui.Window.superclass.initComponent.call(this)
},
init:function(config){
this.controller.init();
this.linkPage=this.linkPage||config.linkPage
},
getSelectedLinkPage:function(){
return this.linkPage
},
showPage:function(ref){
this.layout.setActiveItem(this[ref]);
return this[ref]
},
getCurrentPage:function(){
return this.layout.activeItem
},
queue:function(command,clear){
this.controller.queue(command,clear)
},
next:function(success){
if(success){
this.controller.complete()
}else{
this.controller.execute()
}
},
previous:function(){
this.controller.undo()
},
closePanel:function(redraw){
this.app.fireEvent('activate','workspace');
if(redraw==='redraw'){
this.app.workspace.fireEvent('redraw')
}
},
initListeners:function(){
this.on('beforeshow',function(win){
var bodyBox=Ext.getBody().getSize(true),width=bodyBox.width*0.9,height=bodyBox.height*0.9;
win.setSize(width,height);
win.alignTo(Ext.getBody(),'c-c')
});
this.on('destroy',function(){
this.controller.destroy()
},this)
}
});
web.windows.PageImport=web.pageImport.ui.Window;
Ext.ns('web');
web.redirectToLoginPage=function(options){
var hashParams={};
if(options.specifySelfAsSuccessUrl){
var arrLocation=window.location.href.split('#');
hashParams.successUrl=arrLocation[0].replace(/^(https?:\/\/)webeditornew\./,'$1webeditor.')+(arrLocation.length>1?'#'+arrLocation[1]:'')
}
var authHandlerUrl=window.location.protocol+'//'+window.location.host+'/api/v1/auth/login';
if(true){
hashParams.loginTarget=window.location.host
}else{
hashParams.loginUrl=authHandlerUrl
}
var afterHash=web.utils.Url.getParams().afterHash;
var targetDomainInHash=afterHash.targetDomain;
if(targetDomainInHash){
hashParams.targetDomain=targetDomainInHash
}else if(options.domainName&&one.validation.domain.test(options.domainName)){
hashParams.targetDomain=options.domainName
}
var mailIdInHash=afterHash.username;
if(mailIdInHash){
try{
hashParams.username=decodeURIComponent(mailIdInHash)
}catch(e){
}
}else if(one.validation.email.test(options.originallyAuthenticatedEmailAddress)){
hashParams.username=options.originallyAuthenticatedEmailAddress
}
var targetLocation='https://login.one.com/cp/webeditor'+'#'+Ext.urlEncode(hashParams);
try{
window.location.replace(targetLocation)
}catch(e){
}
};
web.DocumentLoader=function(){
var changedDocs={},saveState;
return{
init:function(app){
saveState=app.invoker.getNextUndoId();
this.app=app;
Ext.apply(app,{
hasUnsavedChanges:this.hasUnsavedChanges.createDelegate(this),
hasUnpublishedPages:this.hasUnpublishedPages.createDelegate(this),
getChangedDocs:this.getChangedDocs,
request:this.request.createDelegate(this),
loadPage:this.loadPage.createDelegate(this),
save:this.save.createDelegate(this)
});
app.addEvents(['save']);
app.on('update',function(part){
var doc=part.getDocument()||part.getOldDocument();
if(doc&&!(doc instanceof web.data.Site)){
changedDocs[doc.getId()]=doc
}
},this);
app.on('load',function(){
app.clearUndoRedo();
changedDocs={};
saveState=app.invoker.getNextUndoId();
if(app.workspace&&app.workspace.getEl&&app.workspace.getEl().scrollTo){
app.workspace.getEl().scrollTo('top',0)
}
},this);
var that=this;
window.onbeforeunload=function(){
if(that.hasUnsavedChanges()&&Ext.util.Cookies.get('BoneAuth')){
var msg='Unsaved changes'+' '+('Please save the changes to "'+that.app.getSite().getLink(that.app.getSelected('page').getId()).getName()+'", otherwise these changes will be lost.');
return msg
}
}
},
hasUnsavedChanges:function(){
return saveState!==this.app.invoker.getNextUndoId()
},
hasUnpublishedPages:function(){
return!this.app.panels.publishing.isPublished()
},
getChangedDocs:function(){
var docs=[],docId;
for(docId in changedDocs){
if(changedDocs.hasOwnProperty(docId)){
docs.push(changedDocs[docId])
}
}
return docs
},
request:function(opts){
var next=this.requestStrategies[opts.type];
if(this.hasUnsavedChanges()){
this.saveOrDiscard(next,opts)
}else{
next.call(this,opts)
}
},
requestStrategies:{
page:function(opts){
if(opts.discard){
this.resetSaveState()
}
this.loadPage(opts.id,function(success,page){
if(success){
this.app.fireEvent('load',page);
this.app.fireEvent('select',page);
this.app.fireEvent('flush')
}
},this)
},
template:function(opts){
if(opts.discard){
this.resetSaveState()
}
this.loadTemplate(opts.id,opts.pageId)
},
newpage:function(opts){
this.showPageNamePrompt(function(buttonId,name){
var page,template;
if(buttonId==='ok'){
page=this.duplicatePage(this.app.getSelected('page'),name);
if(opts.discard){
this.app.dal.getWithDependents(this.app.getSelected('template').getId(),'web.data.components.Template',function(reqOpts,success,response){
if(success){
var data=Ext.decode(response.responseText),dm=this.app.dm;
this.resetSaveState();
if(data.assets){
data.assets.forEach(function(asset){
dm.create(asset)
})
}
dm.create(data.stylesheet);
template=dm.create(data.template);
this.createPage(page,template,opts.parent)
}else{
one.error('<b>'+'Unable to fetch template'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.')
}
},this)
}else{
this.createPage(page,this.app.getSelected('template'),opts.parent)
}
}
})
},
newlayout:function(opts){
var callback=function(success,page){
this.showPageNamePrompt(function(buttonId,name){
if(buttonId==='ok'){
var layoutName=(page.name||'').replace(/^Layout -/,'').trim();
this.app.trackEvent({
eventCategory:'Layout',
eventAction:'select',
eventLabel:layoutName
});
var pageConfig=this.duplicatePage(page,name);
page=this.app.dm.create(pageConfig);
if(success){
this.app.dal.getWithDependents(opts.selectedTemplate.id,'web.data.components.Template',function(op,success,response){
if(success){
var dm=this.app.dm;
dm.unregister(opts.selectedTemplate.id);
var template=dm.create(Ext.decode(response.responseText).template);
dm.create(Ext.decode(response.responseText).stylesheet);
page.setTemplate(template);
this.createPage(page,template,opts.parent,{activateWorkspace:true})
}else{
one.error('<b>'+'Unable to fetch template'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.')
}
},this)
}else{
one.error('<b>'+'Unable to fetch template'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.')
}
}
})
};
var page=this.app.dm.get(opts.id);
if(page){
callback.call(this,true,page)
}else{
this.loadPage(opts.id,callback,this,true)
}
},
newpageandtemplate:function(opts){
this.app.fireEvent('activate','templates',{
values:{
title:'Select a Template',
withModified:!opts.nomodified,
closable:!opts.nocancel
},
listeners:{
beforeok:function(){
if(opts.discard){
this.resetSaveState()
}
},
ok:function(c,template,pageTreeConfigs){
if(!Ext.isArray(pageTreeConfigs)){
pageTreeConfigs=[pageTreeConfigs]
}
this.createPage(pageTreeConfigs,template,opts.parent,{
usesExternalSource:true,
activateWorkspace:true
})
},
cancel:function(){
opts.window.show()
},
scope:this
}
})
},
'delete':function(opts){
var currentPageId=opts.deleteLink.pageId?opts.deleteLink.pageId:null,pageName=currentPageId?this.app.getSite().getLink(currentPageId).getName():'',docsToSave=[],messageOpts;
function confirmPageDelete(msg,callback,args,scope){
Ext.Msg.show(Ext.apply(msg,{
fn:function(buttonId){
if('yes'===buttonId){
callback.call(scope,args)
}
},
scope:this
}))
}
opts.pagesToDelete=this.getPages(opts.deleteLink);
var matched=false;
Ext.each(opts.pagesToDelete,function(page,index){
if(page.pageId===currentPageId){
matched=true;
return false
}
});
if(this.hasUnsavedChanges()&&matched){
docsToSave=this.getChangedDocs().filter(function(doc){
if(doc instanceof web.data.components.Template||doc instanceof web.data.styles.Stylesheet){
return true
}
})
}
var deleteUnsavedPage={
buttons:{
cancel:'Cancel',
yes:'Save',
no:'Don\'t Save'
},
title:'Unsaved changes to template',
msg:'Please save the changes to the template, otherwise they will be lost.',
cls:'web-modal-warning',
iconCls:'web-warning-icon',
width:510
},deleteHomePage={
buttons:{
no:'Cancel',
yes:'Delete'
},
title:'Delete start page and subpages',
cls:'web-modal-warning',
iconCls:'web-warning-icon',
msg:'Are you sure you want to delete "'+pageName+'" and subpages?'+' '+'Your website will not display a One.com Website Builder page after your next publication.'+' '+'To assign another as start page, click the gear next to a page and open Page info.'
},deleteRegularPage={
buttons:{
no:'Cancel',
yes:'Delete'
},
cls:'web-modal-warning',
iconCls:'web-warning-icon',
title:'Delete page and subpages',
msg:'Are you sure you want to delete "'+pageName+'"?'
};
if(docsToSave.length){
messageOpts=deleteUnsavedPage
}else{
messageOpts=this.app.site.homePageId===opts.deleteLink.pageId?deleteHomePage:deleteRegularPage
}
Ext.Msg.show(Ext.apply(messageOpts,{
fn:function(buttonId){
if(buttonId==='yes'){
if(docsToSave.length){
this.save(null,Ext.applyIf({
ignoreChanges:[currentPageId],
scope:this
},opts));
messageOpts=this.app.site.homePageId===opts.deleteLink.pageId?deleteHomePage:deleteRegularPage;
confirmPageDelete(messageOpts,this.deletePageAndChildren,opts,this)
}else{
this.deletePageAndChildren(opts)
}
if(this.app.windows.get('web.windows.PageProps')){
this.app.windows.get('web.windows.PageProps').win.hide()
}
}else if(buttonId==='no'){
if(docsToSave.length){
while(this.app.invoker.getNextUndoId()){
this.app.invoker.undo()
}
messageOpts=this.app.site.homePageId===opts.deleteLink.pageId?deleteHomePage:deleteRegularPage;
confirmPageDelete(messageOpts,this.deletePageAndChildren,opts,this)
}
}
},
scope:this
}))
},
'import':function(opts){
if(!this.app.pageImport.hasListener('ok')){
this.app.pageImport.on('ok',function(page,template,stylesheet){
if(opts.discard){
this.resetSaveState()
}
page.templateId=template.id;
this.createPage(page,template,opts.parent)
},this)
}
this.app.fireEvent('activate','pageimport',{values:{linkPage:opts.parent}})
},
language:function(opts){
var cookieDomain='.'+location.hostname.split('.').splice(-2,2).join('.');
Ext.util.Cookies.set('OneLang',opts.lang,opts.expires,'/',cookieDomain);
this.app.hide();
this.app.showHideShadow('vertical','hide');
this.app.showHideShadow('horizontal','hide');
one.viewport.showLoading();
one.viewport.updateApplicationCache(function(){
document.location.reload()
})
},
logout:function(){
var authenticationData=one.boneAuth.parseCookieValue()||{};
Ext.util.Cookies.clear('BoneAuth');
web.redirectToLoginPage({
specifySelfAsSuccessUrl:true,
domainName:authenticationData.realm,
originallyAuthenticatedEmailAddress:authenticationData.originallyAuthenticatedEmailAddress
})
}
},
getPages:function(link){
var pages=[],id,pageId;
if(link instanceof web.data.links.LinkPage){
id=link.getId();
pageId=link.getPageId();
pages.push({
id:id,
pageId:pageId
});
link.getItems().forEach(function(child){
if(child instanceof web.data.links.LinkPage){
pages=pages.concat(this.getPages(child))
}
},this)
}
return pages
},
duplicatePage:function(page,name){
var copier=new web.utils.Copier,template=page.getTemplate(),pageId=Math.uuid();
template.items.forEach(function(item){
if(item.relPage&&item.relPage[page.id]!==undefined){
item.relPage[pageId]=item.relPage[page.id]
}
copier.uidDict.oldToNew[item.id]=item.id
});
return{
id:pageId,
type:'web.data.components.Page',
name:name,
title:name,
templateId:page.getTemplateId(),
items:function(items){
var newItems=[];
items.forEach(function(item){
var newItem=copier.copy(item.toJSON(),/^globalId|linkId$/);
newItems.push(newItem)
});
return newItems
}(page.getItems())
}
},
showPageNamePrompt:function(callback,noCancel){
var that=this;
var fnRemoveFocus=function(){
if(!textField.getValue()){
textField.clearInvalid();
textField.addClass('x-form-focus')
}else{
textField.removeClass('x-form-focus')
}
};
var fnSetFocus=function(){
textField.addClass('x-form-focus')
};
var fnEnableDisableOKButton=function(evt,input){
if(textField.isValid()){
OKButton.enable()
}else{
OKButton.disable()
}
};
var textField=new Ext.form.TextField({
xtype:'textfield',
value:noCancel?'Home':'',
style:{
display:'block',
width:'88%',
marginLeft:'30px',
marginTop:'5px'
},
validator:function(value){
if(value){
return!/[\/\\\?\*\:\|"<>]/.test(value)
}else{
return false
}
},
enableKeyEvents:true,
listeners:{
specialkey:function(f,e){
if(e.getKey()===e.ENTER){
if(textField.isValid()){
callback.apply(that,[
'ok',
textField.getValue()
]);
win.close()
}
}
},
keyup:fnEnableDisableOKButton,
blur:fnEnableDisableOKButton,
invalid:fnRemoveFocus,
valid:fnSetFocus
}
});
var OKButton=new Ext.Button({
xtype:'button',
cls:'x-btn-primary large wide',
disabled:!textField.isValid()?true:false,
text:'OK',
listeners:{
click:function(btn,e){
callback.apply(that,[
'ok',
textField.getValue()
]);
win.close()
}
}
});
var cancelButton={
xtype:'button',
cls:'x-btn-secondary large wide',
text:'Cancel',
listeners:{
click:function(btn,e){
win.close()
}
}
};
var win=new Ext.Window({
modal:true,
layout:'form',
cls:'web-window-addnewpage',
title:'New Page',
items:[
{
xtype:'container',
items:[
{
xtype:'container',
style:'padding-left: 30px;',
html:'Enter a name for the new page:'
},
textField,
{
xtype:'spacer',
height:100
}
]
},
{
xtype:'container',
cls:'web-window-footer hbox cross-center',
items:function(){
var items=[{
xtype:'spacer',
cls:'flex'
}];
if(!noCancel){
items.push(cancelButton);
items.push({
xtype:'spacer',
width:20
})
}
items.push(OKButton);
return items
}()
}
],
closable:!noCancel
});
win.show();
textField.focus()
},
saveOrDiscard:function(callback,opts){
if('deleteLink'in opts){
callback.call(this,opts)
}else{
Ext.Msg.show({
buttons:{
yes:'Save',
no:'Don\'t Save',
cancel:'Cancel'
},
title:'Unsaved changes',
msg:'Please save the changes to "'+this.app.getSite().getLink(this.app.getSelected('page').getId()).getName()+'", otherwise these changes will be lost.',
cls:'web-modal-warning',
iconCls:'web-warning-icon',
fn:function(buttonId){
if(buttonId==='yes'){
this.save(callback,Ext.applyIf({scope:this},opts))
}else if(buttonId==='no'){
callback.call(this,Ext.apply({discard:true},opts))
}else if(buttonId==='cancel'){
if(opts.incomplete){
opts.incomplete.call(opts.scope||window,opts)
}
}
},
scope:this
})
}
},
save:function(callback,opts){
if(this.saving){
return
}
var numDocs=0,ignoreDocIds=opts?opts.ignoreChanges||[]:[],progress=function(reqOpts,success,response,id){
numDocs-=1;
if(success){
this.app.fireEvent('save',changedDocs[id]);
if(numDocs===0){
this.saving=false;
this.app.sidebar.enable();
changedDocs={};
saveState=this.app.invoker.getNextUndoId();
if(callback){
callback.call(opts.scope||this,opts)
}
}
}else{
this.app.fireEvent('savefailed');
if(numDocs===0){
this.saving=false;
this.app.sidebar.enable()
}
if(opts&&opts.failure){
opts.failure()
}
one.fatal('Custom - Page save failed with status : '+response.status);
one.error('<b>'+'Page not saved.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.')
}
},docId;
for(docId in changedDocs){
if(changedDocs.hasOwnProperty(docId)&&ignoreDocIds.indexOf(docId)===-1){
this.saving=true;
this.app.dal.set(changedDocs[docId],progress.createDelegate(this,[docId],true),this);
numDocs+=1
}
}
if(numDocs){
this.app.fireEvent('saving');
this.app.sidebar.disable()
}
},
resetSaveState:function(){
var docId,doc;
for(docId in changedDocs){
if(changedDocs.hasOwnProperty(docId)){
doc=changedDocs[docId];
this.app.dm.unregister(doc)
}
}
this.app.clearUndoRedo();
changedDocs={};
saveState=this.app.invoker.getNextUndoId()
},
createPage:function(cfg,template,parent,config){
var app=this.app,dm=app.dm,pageConfigs,pages=[],loaded=0,firstPage,foundPage;
if(Ext.isString(cfg)){
var pageCfg={
id:Math.uuid(),
type:'web.data.components.Page',
name:cfg,
templateId:template.getId(),
items:[]
};
var page=dm.create(pageCfg);
pageCfg.page=page;
pages=[page];
pageConfigs=[pageCfg]
}else{
pageConfigs=Ext.isArray(cfg)?cfg:[cfg];
if(!pageConfigs[0].type){
(function add(pageConfigs){
pageConfigs.forEach(function(item){
pages.push(item.page);
add(item.subTreeConfig||[])
})
}(pageConfigs))
}else{
pageConfigs.forEach(function(page,index){
pages.push(page);
pageConfigs[index]={page:page}
},this)
}
pages.forEach(function(pageConfig,index){
pages[index]=dm.create(pageConfig);
this.setComponentDefaults(pages[index])
},this)
}
firstPage=pages[0];
foundPage=app.site.getFolder().getItems().some(function(item){
return item instanceof web.data.links.LinkPage
},this);
var activeCard,activateWorkspace=config&&config.activateWorkspace;
if(activateWorkspace){
activeCard=this.app.cards.layout.activeItem;
activeCard.el.mask('','animated-loading-dots',true,true)
}
pages.forEach(function(page){
app.dal.set(page,function(opts,success,response){
loaded+=1;
if(success){
if(loaded===pages.length){
if(!foundPage){
app.site.homePageId=firstPage.id
}
(function add(pageConfigs,parent){
pageConfigs.forEach(function(pageConfig){
var linkPage=app.dm.create(pageConfig.linkPage||{
id:Math.uuid(),
type:'web.data.links.LinkPage',
name:pageConfig.page.name,
title:pageConfig.page.name,
pageId:pageConfig.page.id,
hidden:pageConfig.hidden,
'public':true
});
parent.addItem(linkPage);
add(pageConfig.subTreeConfig||[],linkPage)
})
}(pageConfigs,parent));
if(!firstPage.getTemplate()){
app.dm.register(template)
}
app.fireEvent('update',parent,{operation:'create-page'});
app.fireEvent('select',firstPage);
if(activateWorkspace){
app.on('fonts-status',function(){
activeCard.el.unmask();
app.workspace.autoAdjust.off=true;
this.app.fireEvent('activate','workspace');
app.workspace.autoAdjust.off=false;
if(app.workspace&&app.workspace.getEl&&app.workspace.getEl().scrollTo){
app.workspace.getEl().scrollTo('top',0)
}
},this,{single:true})
}
if(config&&config.usesExternalSource){
app.fireEvent('import',firstPage)
}
app.fireEvent('update',template);
pages.forEach(function(loadedPage){
app.fireEvent('load',loadedPage)
});
changedDocs={};
this.app.clearUndoRedo();
saveState=this.app.invoker.getNextUndoId();
this.app.fireEvent('flush')
}
}else{
if(activateWorkspace){
activeCard.el.unmask()
}
one.error('<b>'+'Unable to create a new page.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.')
}
},this)
},this)
},
deletePageAndChildren:function(opts){
Ext.getBody().mask('','full-webeditor-mask',true,true);
var pageId=this.app.getSelected('page')?this.app.getSelected('page').getId():null,uiPageId=this.app.dal.uiState.get('lastPageId'),pagesToDelete=opts.pagesToDelete,deleteLink=opts.deleteLink,parent=deleteLink.getParent(),site=this.app.getSite(),linkToSelect;
var deleteLinkIdx=parent.indexOf(deleteLink);
parent.removeItem(deleteLink);
this.app.fireEvent('update',parent);
this.app.on('save',function(part,options){
var dal=this.app.dal;
if(part instanceof web.data.Site){
Ext.getBody().unmask();
if(options&&options.saveFailed){
parent.addItem(deleteLink,deleteLinkIdx)
}else{
Ext.each(pagesToDelete,function(page,index){
if(page.pageId===pageId){
linkToSelect=this.getSiblingOrParent(deleteLink);
return false
}
},this);
if(uiPageId){
Ext.each(pagesToDelete,function(page,index){
if(page.pageId===uiPageId){
dal.uiState['delete']('lastPageId');
return false
}
},this)
}
if(deleteLink.pageId===site.getHomePageId()){
site.set({homePageId:''})
}
pagesToDelete.forEach(function(page){
var pageId=page.pageId,id=page.id;
var app=this.app;
dal.deletePart('web.data.components.Page',pageId,function(){
app.dm.unregister(id)
});
app.fireEvent('delete',pageId)
},this);
if(linkToSelect){
this.loadPage(linkToSelect.getPageId(),function(success,page){
if(success){
this.app.fireEvent('load',page);
this.app.fireEvent('select',page);
this.app.fireEvent('flush')
}
},this)
}
}
}
},this,{single:true})
},
getSiblingOrParent:function(deleteLink){
var parent=deleteLink.getParent(),siblings=parent.getItems(),index=siblings.indexOf(deleteLink),found=false,select=null,i;
for(i=index+1;!found&&siblings[i];i+=1){
if(siblings[i]instanceof web.data.links.LinkPage){
select=siblings[i];
found=true
}
}
for(i=index-1;!found&&siblings[i];i-=1){
if(siblings[i]instanceof web.data.links.LinkPage){
select=siblings[i];
found=true
}
}
if(!found&&parent.getParent()!==this.app.site){
select=parent
}
return select
},
loadPage:function(pageId,cb,scope,useRepository){
var page=this.app.dm.get(pageId),template,stylesheet,callback=function(opts,success,response){
var dm=this.app.dm,page,data;
if(success&&response.responseText){
data=Ext.decode(response.responseText);
if(data.assets){
data.assets.forEach(function(asset){
dm.create(asset)
},this)
}
page=dm.create(data.page);
dm.create(data.template);
dm.create(data.stylesheet);
cb.call(scope,true,page)
}else{
one.error('<b>'+'Unable to fetch the page.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.');
if(success){
one.fatal('The AJAX request was successful but response was blank. (in loadPage()) (response.responseText = "'+response.responseText+'")',{requestedUrl:opts&&opts.url})
}
cb.call(scope,false)
}
};
if(!page){
if(useRepository){
this.app.rep.getAllPageData(pageId,callback,this)
}else{
this.app.dal.getAllPageData(pageId,callback,this)
}
}else{
template=page.getTemplate();
stylesheet=template?template.getStylesheet():null;
if(!template||!stylesheet){
this.app.dal.getAllPageData(pageId,callback,this)
}else{
cb.call(scope,true,page)
}
}
},
loadTemplate:function(templateId,pageId){
var page=this.app.dm.get(pageId),template,stylesheet,callback=function(opts,success,response){
if(success){
var data=Ext.decode(response.responseText),dm=this.app.dm,template;
if(data.assets){
data.assets.forEach(function(asset){
dm.create(asset)
},this)
}
dm.create(data.stylesheet);
page=dm.create(data.page);
template=dm.create(data.template);
this.app.fireEvent('load',template);
this.app.fireEvent('select',page);
this.app.fireEvent('import',page);
this.app.fireEvent('select',template);
this.app.fireEvent('import',template)
}
};
if(!page){
this.app.dal.getAllPageData(pageId,callback,this)
}else{
template=this.app.dm.get(page.getTemplateId());
stylesheet=template?this.app.dm.get(template.getStylesheetId()):null;
if(!template||!stylesheet){
this.app.dal.getAllPageData(pageId,callback,this)
}else{
this.app.fireEvent('load',template);
this.app.fireEvent('select',page);
this.app.fireEvent('import',page);
this.app.fireEvent('select',template);
this.app.fireEvent('import',template)
}
}
},
setComponentDefaults:function(page){
page.getAllItems().forEach(function(cmp){
if(Ext.isFunction(cmp.setDefaultProperties)){
cmp.setDefaultProperties()
}
})
}
}
};
web.Repository=Ext.extend(web.DAL,{
defaultUrl:'',
constructor:function(config){
this.version='v1';
web.Repository.superclass.constructor.call(this,{domain:'repository'})
},
getPreviewImageUrl:function(id,width,height,screenWidth){
var zoom=width/(screenWidth?screenWidth:1024);
return this.defaultUrl+'/preview/'+id+'.png?zoom='+zoom+'&width='+width+'&height='+height+'&cropw='+width+'&croph='+height
}
});
Ext.ns('web.data');
web.utils.Iterator=Ext.extend(Object,{
map:null,
constructor:function(part,arrSkipProperties){
this.part=part;
this.arrSkipProperties=arrSkipProperties||[]
},
forEach:function(fn,context){
this.map={};
this.recursive(fn,context,this.part);
this.cleanup()
},
recursive:function(fn,context,part){
var c=context||window,prop,id;
part=part||this.part;
if(part&&typeof part==='object'){
if(Array.isArray(part)){
part.forEach(function(item){
if(item){
this.recursive(fn,context,item)
}
},this)
}else{
id=part.id||part.autoId;
if(!id){
id='auto'+Math.uuid();
part.autoId=id
}
if(this.map[id]){
return
}
this.map[id]=part;
if(part instanceof web.data.Part||part.id&&part.type){
fn.call(c,part)
}
for(prop in part){
if(part.hasOwnProperty(prop)){
if(part[prop]){
for(var i=0;i<this.arrSkipProperties.length;i++){
if(prop===this.arrSkipProperties[i]){
break
}
}
if(i===this.arrSkipProperties.length){
this.recursive(fn,context,part[prop])
}
}
}
}
}
}
},
cleanup:function(){
var i;
for(i in this.map){
if(this.map.hasOwnProperty(i)){
if(this.map[i].autoId){
delete this.map[i].autoId
}
}
}
}
});
/*!
Math.uuid.js (v1.4)
http://www.broofa.com
mailto:robert@broofa.com

Copyright (c) 2010 Robert Kieffer
Dual licensed under the MIT and GPL licenses.
*/
(function(){
var CHARS='0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'.split('');
Math.uuid=function(len,radix){
var chars=CHARS,uuid=[],i,r;
radix=radix||chars.length;
if(len){
for(i=0;i<len;i+=1){
uuid[i]=chars[0|Math.random()*radix]
}
}else{
uuid[8]=uuid[13]=uuid[18]=uuid[23]='-';
uuid[14]='4';
for(i=0;i<36;i+=1){
if(!uuid[i]){
r=0|Math.random()*16;
uuid[i]=chars[i==19?r&3|8:r]
}
}
}
return uuid.join('')
};
Math.uuidFast=function(){
var chars=CHARS,uuid=new Array(36),rnd=0,r,i;
for(i=0;i<36;i+=1){
if(i==8||i==13||i==18||i==23){
uuid[i]='-'
}else if(i==14){
uuid[i]='4'
}else{
if(rnd<=2){
rnd=33554432+Math.random()*16777216|0
}
r=rnd&15;
rnd=rnd>>4;
uuid[i]=chars[i==19?r&3|8:r]
}
}
return uuid.join('')
};
Math.uuidCompact=function(){
return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){
var r=Math.random()*16|0,v=c=='x'?r:r&3|8;
return v.toString(16)
}).toUpperCase()
}
}());
web.data.Part=Ext.extend(Object,{
id:null,
rev:null,
etag:null,
parent:null,
dm:null,
constructor:function(config){
this.id=Math.uuid();
this.rev=null;
this.parent=null;
this.dm=null;
if(arguments.length){
this.set(config)
}
},
destroy:function(){
if(this.dm){
this.dm.unregister(this.id)
}
},
set:function(opts){
var options,property;
options=Ext.apply({},opts);
if(options.id&&options.rev){
this.id=options.id;
this.rev=options.rev
}
if(options.etag){
this.etag=options.etag
}
for(property in options){
if(options.hasOwnProperty(property)){
this[property]=options[property]
}
}
if(this.parent&&!this.dm){
this.dm=this.parent.dm
}
return this.check()
},
check:function(){
return this.id!==null
},
getType:function(){
return this.type
},
getId:function(){
return this.id
},
getRev:function(){
return this.rev
},
getEtag:function(){
return this.etag
},
getParent:function(){
return this.parent
},
getRoot:function(){
var root=this.parent?this.parent.getRoot():this;
return root?root:this
},
isDocument:function(){
return false
},
getDocument:function(){
var root=this.getRoot();
return root.isDocument()?root:null
},
getOldDocument:function(){
var root=this.oldParent;
return root.isDocument()?root:null
},
inPage:function(){
return this.getRoot()instanceof web.data.components.Page
},
isDynamic:function(){
return false
},
setIndex:function(index){
this.orderIndex=index
},
toJSON:function(){
var json={
id:this.getId(),
type:this.getType()
};
if(this.rev!==null){
json.rev=this.getRev()
}
if(this.etag!==null){
json.etag=this.getEtag()
}
return json
},
compare:function(a,b){
var i,len;
if(Ext.isObject(a)&&Ext.isObject(b)){
a=a.toJSON?a.toJSON():a;
b=b.toJSON?b.toJSON():b;
for(i in a){
if(a.hasOwnProperty(i)&&i!=='id'&&i!=='rev'&&(b[i]===undefined||!this.compare(a[i],b[i]))){
return false
}
}
for(i in b){
if(b.hasOwnProperty(i)&&i!=='id'&&i!=='rev'&&a[i]===undefined){
return false
}
}
}else if(Ext.isArray(a)&&Ext.isArray(b)){
len=a.length;
if(len!==b.length){
return
}
for(i=0;i<len;i+=1){
if(!this.compare(a[i],b[i])){
return false
}
}
}else if(a!==b){
return false
}
return true
},
equals:function(part){
return this.compare(this,part)
},
getAssets:function(){
var assets=[],items=this.getItems?this.getItems():[];
items.forEach(function(item){
var itemAssets=item.getAssets();
itemAssets.forEach(function(asset){
if(assets.indexOf(asset)===-1){
assets.push(asset)
}
},this)
},this);
return assets
},
getIterator:function(arrSkipProperties){
return new web.utils.Iterator(this,arrSkipProperties||[])
},
setDefaultProperties:null
});
Ext.ns('web');
web.UserSubscriptionStatus={
PREMIUM:'PREMIUM',
NORMAL:'NORMAL',
UNKNOWN:'UNKNOWN'
};
Ext.ns('web');
web.UserSubscriptionStatusBackupRestore={
SUBSCRIBED:'SUBSCRIBED',
NOTSUBSCRIBED:'NOTSUBSCRIBED',
UNKNOWN:'UNKNOWN'
};
web.User=Ext.extend(web.data.Part,{
type:'web.User',
firstVisit:null,
borderToCode:null,
constructor:function(config){
this.firstVisit=null;
this.visitedVersion=null;
this.version=null;
this.subscriptionStatus=web.UserSubscriptionStatus.UNKNOWN;
this.subscriptionStatusBackupRestore=web.UserSubscriptionStatusBackupRestore.UNKNOWN;
web.User.superclass.constructor.call(this,config);
this.oldVersion=this.version
},
isFirstVisit:function(){
return this.firstVisit
},
isBorderToCode:function(){
return this.borderToCode
},
isUpgrade:function(version){
return this.toVersionScore(version)>this.toVersionScore(this.version)
},
getVersion:function(){
return this.version
},
getOldVersion:function(){
return this.oldVersion
},
toVersionScore:function(version){
if(!version){
return 0
}
var versions=version.match(/([0-9]+\.[0-9]+\.[0-9]+)/)[1].split('.'),score=0;
versions.forEach(function(part){
score*=1000;
score+=part-0
},this);
return score
},
getSubscriptionStatus:function(){
return this.subscriptionStatus||web.UserSubscriptionStatus.UNKNOWN
},
setSubscriptionStatus:function(subscriptionStatus){
if([
web.UserSubscriptionStatus.PREMIUM,
web.UserSubscriptionStatus.NORMAL
].indexOf(subscriptionStatus)>=0){
this.subscriptionStatus=subscriptionStatus
}else{
this.subscriptionStatus=web.UserSubscriptionStatus.UNKNOWN
}
},
getPackage:function(){
var packages={};
packages[web.UserSubscriptionStatus.NORMAL]={
pageLimit:5,
hdImages:false
};
packages[web.UserSubscriptionStatus.PREMIUM]={hdImages:true};
packages[web.UserSubscriptionStatus.UNKNOWN]={hdImages:false};
return packages[this.getSubscriptionStatus()]||packages[web.UserSubscriptionStatus.UNKNOWN]
},
toJSON:function(){
var ob={
id:this.id,
_rev:this._rev,
type:'web.User',
firstVisit:this.isFirstVisit(),
borderToCode:this.isBorderToCode(),
visitedVersion:this.visitedVersion,
version:this.version
};
return ob
}
});
Ext.ns('web.commands');
web.commands.Memento=function(){
this.stack=[]
};
web.commands.Memento.prototype={
set:function(obj){
this.stack.push(obj)
},
get:function(){
return this.stack.pop()
},
getTop:function(){
return this.stack[this.stack.length-1]
},
getCount:function(){
return this.stack.length
},
cleanup:function(){
this.stack.length=0
}
};
web.commands.Invoker=Ext.extend(Ext.util.Observable,{
constructor:function(app){
this.app=app;
this.undoMemento=new web.commands.Memento;
this.redoMemento=new web.commands.Memento;
this.addEvents.apply(this,app.coreEvents);
web.commands.Invoker.superclass.constructor.call(this);
app.relayEvents(this,app.coreEvents)
},
destroy:function(){
},
checkRelay:function(eve,part,config){
if(!part){
return
}
this.fireEvent(eve,part,config)
},
execute:function(command){
var i,eve,eves;
command.app=this.app;
this.affected={};
eves=[
'update',
'adjust',
'select',
'deselect'
];
for(i=0;eve=eves[i];i+=1){
command.on(eve,function(scope,eve){
return function(part,config){
scope.checkRelay(eve,part,config)
}
}(this,eve))
}
this.lastUndoId=Math.uuid();
command.execute();
this.undoMemento.set({
id:this.lastUndoId,
command:command
});
this.redoMemento.cleanup();
this.app.fireEvent('flush')
},
undo:function(){
var tmp=this.undoMemento.get();
if(tmp){
tmp.command.undo();
this.redoMemento.set(tmp)
}
this.app.fireEvent('flush')
},
redo:function(){
var tmp=this.redoMemento.get();
if(tmp){
tmp.command.undo();
this.undoMemento.set(tmp)
}
this.app.fireEvent('flush')
},
getNextUndoId:function(){
return this.undoMemento.getTop()?this.undoMemento.getTop().id:null
},
hasUndoActions:function(){
return this.undoMemento.getCount()>0
},
hasRedoActions:function(){
return this.redoMemento.getCount()>0
}
});
Ext.ns('web.data.links');
web.data.links.Link=Ext.extend(web.data.Part,{
type:'web.data.links.Link',
isLink:true,
name:null,
constructor:function(config){
this.name='';
this.hidden=false;
web.data.links.Link.superclass.constructor.call(this,config)
},
destroy:function(){
web.data.links.Link.superclass.destroy.call(this);
delete this.name
},
toJSON:function(){
return{
id:this.getId(),
type:this.getType(),
name:this.name,
hidden:this.hidden
}
},
check:function(){
if(!web.data.links.Link.superclass.check.call(this)){
return false
}
if(this.name===null||!this.name.trim().length){
return false
}
return true
},
getName:function(){
return this.name
},
isHidden:function(hidden){
if(hidden!==undefined){
this.hidden=!!hidden
}
if(!this.hidden){
this.hidden=false
}
return this.hidden
},
getItems:function(){
return[]
},
getAllItems:function(){
var result=[],items=this.getItems();
items.forEach(function(item){
result.push(item);
result=result.concat(item.getAllItems())
},this);
return result
},
getAllPages:function(){
var result=[],items=this.getAllItems();
items.forEach(function(item){
if(item instanceof web.data.links.LinkPage){
result.push(item)
}
},this);
return result
},
getPageCount:function(){
return this.getAllPages().length
},
getLevel:function(){
var link=this,level=1;
while(link=link.getParent()){
level+=1
}
return level-2
},
isPublished:function(){
return true
},
isPublic:function(){
return!this.hidden
},
indexOf:function(item){
return this.getAllItems().indexOf(item)
}
});
web.data.links.LinkExternal=Ext.extend(web.data.links.Link,{
type:'web.data.links.LinkExternal',
url:null,
target:null,
linkId:null,
constructor:function(config){
this.url='';
this.target='_self';
this.linkId=null;
web.data.links.LinkExternal.superclass.constructor.call(this,config)
},
destroy:function(){
web.data.links.LinkExternal.superclass.destroy.call(this);
delete this.url;
delete this.linkId
},
toJSON:function(){
var that=this,obj=web.data.links.LinkExternal.superclass.toJSON.call(that);
obj.url=that.url;
obj.linkId=that.linkId;
obj.target=that.target;
return obj
},
isEqual:function(linkExternal){
return linkExternal&&this.url===linkExternal.url&&this.target===linkExternal.target
},
check:function(){
if(!web.data.links.LinkExternal.superclass.check.call(this)){
return false
}
if(this.url===null||!this.url.trim().length){
return false
}
if(this.target!=='_self'&&this.target!=='_blank'){
return false
}
if(!web.data.links.LinkExternal.isValidRegExp.test(this.url)){
return false
}
return true
},
getURL:function(doc){
if(doc&&/^webspace:/.test(this.url)){
return doc.getAssetURL()+this.url.replace(/^webspace:/,'/webspace')
}else{
return this.url
}
},
getTarget:function(){
return this.target
},
getLinkId:function(){
return this.linkId
},
findLinkPage:function(linkId){
return null
}
});
web.data.links.LinkExternal.isValidRegExp=new RegExp('^('+'?:mailto:.*|javascript:.*|'+'sms:.*|tel:.*|'+one.validation.fragments.httpUrlIdn.source+'|'+one.validation.fragments.ftpUrlIdn.source+')$');
web.data.links.LinkExternal.validate=function(value){
var urlWithoutParams=value.replace(/\?.*/,'').replace(/#.*/,'');
return web.data.links.LinkExternal.isValidRegExp.test(urlWithoutParams)
};
web.data.links.LinkExternal.clean=function(url){
url=url.trim();
var matches=url.match(/^(https?:\/\/[^\/]+)(.*)$/);
if(matches){
url=matches[1]+matches[2].replace(/[\x80-\uffff\[\]]/g,encodeURIComponent).replace(/\|/g,encodeURIComponent)
}
return url
};
web.data.links.LinkExternal.compatibleEncodeURL=function(url){
url=web.data.links.LinkExternal.clean(url);
url=url.replace(/^http:\/\//,'').replace(/^http:\/\//,'');
url=url.match(/^https:\/\//)?url:'http://'+url;
return url
};
web.data.links.LinkPage=Ext.extend(web.data.links.Link,{
type:'web.data.links.LinkPage',
pageId:null,
items:null,
title:null,
description:null,
categories:null,
robots:null,
constructor:function(config){
this.pageId='';
this.items=[];
this.title='';
this.description='';
this.categories=[];
this.robots='all';
this['public']=true;
web.data.links.LinkPage.superclass.constructor.call(this,config)
},
destroy:function(){
web.data.links.LinkPage.superclass.destroy.call(this);
delete this.pageId
},
toJSON:function(){
var obj=web.data.links.LinkPage.superclass.toJSON.call(this);
obj.pageId=this.pageId;
obj.url=this.url;
obj['public']=this['public'];
obj.title=this.title;
obj.description=this.description;
obj.categories=this.categories;
obj.robots=this.robots;
obj.items=[];
this.getItems().forEach(function(item){
obj.items.push(item.toJSON())
});
return obj
},
check:function(){
if(!web.data.links.LinkPage.superclass.check.call(this)){
return false
}
if(!this.pageId||!this.pageId.trim().length){
return false
}
return true
},
set:function(opts){
var items;
if(opts.items){
items=opts.items
}
delete opts.items;
this.title=opts.title!==undefined?opts.title:this.title;
this.description=opts.description!==undefined?opts.description:this.description;
this.categories=opts.categories!==undefined?opts.categories:this.categories;
this.robots=opts.robots!==undefined?opts.robots:this.robots;
web.data.links.Link.superclass.set.call(this,opts);
if(items){
this.removeItems();
if(!Ext.isArray(this.items)){
this.items=[]
}
items.forEach(function(item){
var itemOpts;
if(item.id&&item.type){
itemOpts=Ext.apply({
dm:this.dm,
parent:this
},item);
this.items.push(this.dm.create(itemOpts))
}
},this)
}
if(!this.url&&!opts.url&&!(this.parent instanceof web.data.Site)){
this.url=encodeURIComponent(this.name.trim().replace(/[\/\\\?\*\:\|"<>]+/g,'-').toLowerCase());
if(this.url===''){
this.url='page'
}
}
},
findLinkPage:function(pageId){
var link,links=this.getItems();
while(links.length){
link=links.shift();
if(link instanceof web.data.links.LinkPage){
if(link.getPageId()===pageId){
return link
}
}
links=links.concat(link.getItems())
}
return null
},
getItem:function(id){
var i,item;
for(i=0;!!(item=this.items[i]);i+=1){
if(item.getId()===id){
return item
}
}
return null
},
getItems:function(){
if(this.items===null){
return null
}
return this.items.concat()
},
addItem:function(item,index){
var lookForMatch=function(links,url){
if(url==='index'){
return true
}
return links.some(function(link){
if(link instanceof web.data.links.LinkPage){
return link.getUrlFragment()===url
}else{
return false
}
})
},suffix=2,originalUrl;
item.set({parent:this});
if(item instanceof web.data.links.LinkPage){
originalUrl=item.getUrlFragment();
while(lookForMatch(this.items,item.getUrlFragment())){
item.set({url:originalUrl+'-'+suffix});
suffix+=1
}
}
if(arguments.length>1){
this.items.splice(index,0,item)
}else{
if(this.items.indexOf(item)<0){
this.items.push(item)
}
}
},
removeItem:function(item){
var index,items=this.items,numItems=items.length,found=false;
for(index=0;index<numItems;index+=1){
if(item.id===items[index].getId()){
found=true;
break
}
}
if(found){
this.items.splice(index,1)
}
return found?index:-1
},
removeItems:function(){
var i,item,items=this.items,numItems,dm=this.dm;
if(!Ext.isArray(items)){
return
}else if(items.length){
numItems=items.length;
for(i=0;!!(item=items[i]);i+=1){
dm.unregister(item.getId());
item.destroy()
}
this.items=[]
}
},
getPageId:function(){
return this.pageId
},
getTitle:function(){
return this.title
},
getDescription:function(){
return this.description
},
getCatgories:function(){
return this.categories
},
getRobots:function(){
return this.robots
},
getUrlFragment:function(){
return this.url
},
getUrlPath:function(){
var that,fragment,path='';
if(this.getPageId()!==this.getDocument().homePageId){
for(that=this;that.parent;that=that.parent){
if(!(that.parent instanceof web.data.Site)){
fragment=that.getUrlFragment();
path='/'+fragment+path
}
}
}
return path
},
getURL:function(doc){
if(this.isPublic()){
var url=doc?doc.getAssetURL():'';
url+='/preview/'+this.pageId+'.html';
if(doc&&doc.previewBackup){
url+=doc&&doc.time?'?time='+doc.time:'';
url+='&previewbackup=true'
}
return url
}else{
return''
}
},
isPublic:function(){
return this['public']
},
getLinkPages:function(options){
var linkPages=[];
options=options||{};
this.items.forEach(function(link){
if(link.getLinkPages&&(!options.publicOnly||link.isPublic())){
linkPages.push(link);
Array.prototype.push.apply(linkPages,link.getLinkPages(options))
}
});
return linkPages
}
});
web.data.Site=Ext.extend(web.data.Part,{
type:'web.data.Site',
name:null,
homePageId:null,
folder:null,
fonts:null,
dataVersionNumber:null,
memory:null,
constructor:function(config){
this.name=null;
this.folder=null;
this.homePageId=null;
this.dataVersionNumber=null;
this.prefersNewWSB=null;
this.betaWsbCode=null;
web.data.Site.superclass.constructor.call(this,config)
},
set:function(opts){
var optsFolder;
if(opts.folder){
optsFolder=opts.folder
}
delete opts.folder;
web.data.Site.superclass.set.call(this,opts);
if(optsFolder){
Ext.apply(optsFolder,{parent:this});
this.folder=this.dm.create(optsFolder)
}
},
getName:function(){
return this.name
},
getHomePageId:function(){
return this.homePageId
},
getFolder:function(){
return this.folder
},
getDataVersionNumber:function(){
return this.dataVersionNumber
},
getLink:function(id,folder){
var result=null;
folder=folder||this.folder;
if(folder.items){
folder.items.forEach(function(item){
if(!result){
if(item.id===id||item.pageId===id){
result=item
}else{
result=this.getLink(id,item)
}
}
},this)
}
return result
},
getURLPath:function(){
function getURLPath(pageId,pageList,path){
var i,len,page,url=null;
for(i=0,len=pageList.length;i<len;i+=1){
page=pageList[i];
if(page.pageId===pageId){
url=path+'/';
if(pageId!==this.homePageId){
url+=page.url;
if(page.items.length){
url+='/index'
}
url+='.html'
}else{
url+='index.html'
}
}else if(page.items&&page.items.length){
url=getURLPath.call(this,pageId,page.items,path+'/'+page.url)
}
if(url!==null){
return url
}
}
return null
}
return function(pageId){
return getURLPath.call(this,pageId,this.folder.items,'')||''
}
}(),
findNumberOfPages:function(node){
var count=0,that=this;
if(!node){
node=this.getFolder()
}else{
count+=1
}
if(node.items){
node.items.forEach(function(item){
count+=that.findNumberOfPages(item)
})
}
return count
},
isDocument:function(){
return true
},
toJSON:function(){
var obj=Ext.apply({
name:this.getName(),
homePageId:this.getHomePageId(),
dataVersionNumber:this.getDataVersionNumber(),
fonts:this.fonts
},web.data.Site.superclass.toJSON.call(this));
if(this.getFolder()){
obj.folder=this.getFolder().toJSON()
}
obj.prefersNewWSB=this.prefersNewWSB;
obj.betaWsbCode=this.betaWsbCode;
return obj
}
});
Ext.ns('web.data.components');
web.data.components.Component=Ext.extend(web.data.Part,{
type:'web.data.components.Component',
isComponent:true,
constructor:function(config){
this.width=config.width!==undefined?config.width:web.data.components.Component.DEFAULT_WIDTH;
this.height=config.height!==undefined?config.height:web.data.components.Component.DEFAULT_HEIGHT;
this.depth=0;
this.wrap=false;
this.stretch=false;
web.data.components.Component.superclass.constructor.call(this,config)
},
destroy:function(){
web.data.components.Component.superclass.destroy.call(this)
},
set:function(json){
var nj=Ext.apply({},json);
if(nj.parent){
this.id=nj.id?nj.id:this.id;
this.setParent(nj.parent);
delete nj.parent
}
if(!isNaN(nj.width)){
nj.width=Math.max(nj.width,1)
}
if(!isNaN(nj.height)){
nj.height=Math.max(nj.height,1)
}
if(nj.bbox||nj.relTo||nj.relIn||nj.relPara){
this.autoTop=this.autoHeight=null
}
web.data.components.Component.superclass.set.call(this,nj)
},
check:function(){
if(!web.data.components.Component.superclass.check.call(this)){
return false
}
return true
},
toJSON:function(){
var obj=web.data.components.Component.superclass.toJSON.call(this),mobileDown=this.getMobileDown(),mobileHide=this.isMobileHide(),bbox=this.getBBox(),relIn=this.getRelIn(true),relTo=this.getRelTo(),relPage=this.getRelPage(),relPara=this.getRelPara();
obj.width=this.getWidth();
obj.height=this.getHeight();
if(mobileDown!==undefined){
obj.mobileDown=mobileDown
}
if(mobileHide!==undefined){
obj.mobileHide=mobileHide
}
obj.bbox=bbox;
obj.relIn=relIn;
obj.relTo=relTo;
obj.relPage=relPage;
obj.relPara=relPara;
obj.wrap=this.isWrap();
obj.stretch=this.isStretch();
obj.orderIndex=this.getIndex();
obj.relBody=this.relBody;
return obj
},
setParent:function(parent){
this.dm=parent.dm;
this.parent=parent;
this.depth=parent?(parent.depth||0)+1:0
},
isSingle:function(){
return false
},
isText:function(){
return this instanceof web.data.components.Text
},
isCode:function(){
return this instanceof web.data.components.Code
}
});
web.data.components.Component.DEFAULT_WIDTH=100;
web.data.components.Component.DEFAULT_HEIGHT=100;
Ext.override(web.data.components.Component,{
render:function(doc){
if(this.isRenderable()){
if(doc.editMode){
var inPage=this.inPage(),bbox=this.getBBox();
doc.openTag({
id:this.id,
style:'position: absolute;'+'left:'+bbox.left+'px;'+'top:'+bbox.top+'px;'+'z-index:'+this.getZIndex()
});
var relIn=this.getRelIn(),relInParent=relIn?this.getRelInParent():null,fullyContained=relInParent&&relInParent.inPage()===inPage&&relInParent.getParent()&&relIn.top>=0&&relIn.left>=0&&relIn.bottom<=0&&relIn.right<=0;
if(!fullyContained||!(this.type==='web.data.components.Text'||this.type==='web.data.components.Block'&&!(this.style&&this.style.background&&(this.style.background.color||this.style.background.gradient||this.style.background.asset)))){
doc.openTag({cls:'web-modemask '+(inPage?'web-modemask-page':'web-modemask-template')});
doc.closeTag()
}
}
this.renderOuterStart(doc);
this.renderSelf(doc);
this.renderOuterEnd(doc);
if(doc.editMode){
doc.closeTag()
}
}
},
renderOuterStart:function(doc){
this.renderBlockStart(doc)
},
renderOuterEnd:function(doc){
this.renderBlockEnd(doc)
},
renderSelf:function(doc){
this.renderSelfStart(doc);
this.renderSelfEnd(doc)
},
renderSelfStart:function(doc){
doc.openTag({
cls:this.getRenderClass(doc),
style:this.getRenderStyle(doc),
listeners:this.getRenderListeners(doc),
weight:doc.isMobile()&&this.isMobileLeaf()&&!this.inPage()?this.getMobileSortWeight():null
})
},
renderSelfEnd:function(doc){
doc.closeTag()
},
getRenderListeners:function(doc){
return null
},
renderBlockStart:function(doc){
var cls=this.getBlockRenderClass(doc),style=this.getBlockRenderStyle(doc);
doc.openTag({
cls:cls,
style:style
})
},
renderBlockEnd:function(doc){
doc.closeTag()
},
getBlockRenderStyle:function(doc){
var style='';
style+=!this.isStretch()?'width:'+this.getWidth()+'px;':'';
return style
},
getBlockRenderClass:function(doc){
var cls='component ';
cls+=this.isStretch()?' stretch':'';
cls+=doc.isMobile()&&this.isMobileBase()?' mobile-base':'';
cls+=doc.editMode?this.inPage()?' page':' template':'';
return cls
},
renderSpecificItems:function(doc,items){
if(items&&items.length){
items.forEach(function(item){
item.lastRenderParent=this;
item.render(doc)
},this)
}
},
renderAllSpecificGhosts:function(doc,items){
},
renderEmpty:function(doc,label){
var height=this.getInnerHeight(),width=this.getInnerWidth(),emptyWidth,emptyHeight,padH=4,padV=3,showLabel=true,style='';
if(doc.editMode){
emptyWidth=width-padH*2-2;
emptyHeight=height-padV*2-2;
if(emptyHeight<12){
showLabel=false
}
if(emptyWidth<0){
emptyWidth+=padH*2;
padH=0
}
if(emptyHeight<0){
emptyHeight+=padV*2;
padV=0
}
if(emptyWidth<0){
emptyWidth=0;
style+='border-right-width:0px;'
}
if(emptyHeight<0){
emptyHeight=0;
style+='border-bottom-width:0px;'
}
style+='width:'+emptyWidth+'px;height:'+emptyHeight+'px;';
style+=!padH||!padV?'padding:'+padV+'px '+padH+'px;':'';
doc.openTag({
cls:'empty',
style:style,
newLine:false
});
if(showLabel){
doc.appendLabel(label)
}
doc.closeTag({newLine:false})
}
},
getRenderClass:function(doc){
return'self'+(doc.isMobile()&&this.isMobileLeaf()?' mobile-leaf'+(this.isMobileHide()?' mobile-forcehide':''):'')
},
getRenderStyle:function(doc){
var style='width:'+this.getInnerWidth()+'px;';
var align=doc.page.getTemplate().getAlign();
if(align==='left'||align==='right'){
style+=' float:'+align+';'
}
return style+(this.isFixedHeight()?'height:':'min-height:')+this.getInnerHeight(doc)+'px;'
},
getZIndex:function(doc){
return(!this.isStretch()?200:0)+(this.inPage()&&!this.isStretch()?100:0)+this.getIndex()+1
}
});
Ext.override(web.data.components.Component,{
getComponentByName:function(name,deep){
var children=[],i,result,component;
if(this.getItems){
children=this.getItems()
}
for(i=0;i<children.length;i+=1){
component=children[i];
if(component.getName&&component.getName()===name){
return component
}else if(deep){
result=component.getComponentByName(name,true);
if(result!==null){
return result
}
}
}
return null
},
canRender:function(){
var parent=this.getParent();
return parent&&parent.canRender()
},
canAddTo:function(part){
var isAdded=false,components;
if(this.isSingle()){
if(part.getType()==='web.data.components.Template'){
return false
}
components=part.getItems();
isAdded=components.some(function(component){
return this.type===component.type
}.bind(this))
}
return!isAdded
},
getRegion:function(el){
return el.getRegion()
},
getRenderParent:function(){
var parent=(this.relIn&&this.relIn.id?this.dm.get(this.relIn.id):null)||this.parent;
return parent instanceof web.data.components.Page?parent.getTemplate():parent
},
getRenderRoot:function(){
var parent=this.getRenderParent(),root=parent?parent.getRoot():this;
return root?root:this
},
hasRenderAncestor:function(component){
var parent=this.getRenderParent();
if(this.type==='web.data.components.Template'){
delete this.relIn;
parent=null
}
return parent&&(parent===component||parent.hasRenderAncestor(component))
},
isEmpty:function(){
return false
},
isRenderEmpty:function(){
return false
},
isRenderable:function(){
return true
},
isGhost:function(){
return false
},
isStretchy:function(){
return false
},
isStretch:function(){
return this.isStretchy()&&this.stretch
},
isContainer:function(){
return this.type==='web.data.components.Block'||this.type==='web.data.components.Template'
},
isActive:function(){
return false
},
isContainerFor:function(part){
return this.isContainer()||part.getRelPara()&&this instanceof web.data.components.Text||!this.isActive()&&this instanceof web.data.components.resources.Image
},
inText:function(){
var parent=this.getParent();
return parent instanceof web.data.components.Text
},
inClamp:function(){
var parent=this.getRenderParent();
return parent&&parent instanceof web.data.components.Clamp
},
isFixedHeight:function(){
return this.getRenderParent()instanceof web.data.components.Text
},
isContentHeight:function(){
return true
},
getSpacing:function(){
return new web.data.styles.FrameWidth([
0,
0,
0,
0
])
},
getTemplate:function(){
var parent=this.getParent();
return!parent||parent instanceof web.data.components.Template?parent:parent.getTemplate()
},
getPage:function(){
var root=this.getRoot();
return root&&root!==this&&root instanceof web.data.components.Page?root:null
},
getStylesheet:function(){
var template=this.getTemplate();
return template?template.getStylesheet():null
},
has:function(component){
return this.indexOf?this.indexOf(component)>=0:false
},
getIndex:function(){
var parent=this.getParent(),index=this.orderIndex!==undefined?this.orderIndex:parent&&parent.indexOf?parent.indexOf(this):0;
if(this.orderIndex===undefined){
this.setIndex(index)
}
return index
},
getMode:function(){
return this.inText()?'align':'root'
},
getAllStyles:function(){
return[]
},
getAssets:function(){
return[]
},
getAspectRatio:function(){
return null
},
getSnapSize:function(){
return null
},
isRatioLock:function(){
return false
},
onBeforeBboxChanged:Ext.emptyFn,
removeRelToDependant:function(components){
var newComponents=[],componentsWithThis=components.indexOf(this)>-1?components:components.concat(this);
components.forEach(function(component){
var relTo=component;
while(relTo){
relTo=relTo.getRelToItem();
if(relTo&&componentsWithThis.indexOf(relTo)>-1){
return
}
}
newComponents.push(component)
},this);
return newComponents
},
calcBelow:function(components,edge){
components=components||[this];
if(!components.length){
return[]
}
var newComponents=[],top=Infinity,bottom=-Infinity,left=Infinity,right=-Infinity,y;
components.forEach(function(component){
var bbox=component.getBBox();
top=Math.min(top,bbox.top);
bottom=Math.max(bottom,bbox.bottom);
left=Math.min(left,bbox.left);
right=Math.max(right,bbox.right)
});
y=edge==='top'?top:bottom;
this.getRoot().getAllItems().forEach(function(component){
if(components.indexOf(component)<0){
var bbox=component.getBBox();
if(bbox.top>=y&&bbox.left<right&&bbox.right>left){
newComponents.push(component)
}
}
},this);
return newComponents
},
toSingleParent:function(components){
if(!components.length){
return[]
}
var relInParentId=this.getRelIn()&&this.getRelIn().id,parent=this.getRelInParent();
if(!relInParentId&&parent){
relInParentId=parent.id;
return components.filter(function(component){
return component.getRelInParent()&&component.getRelInParent().id===relInParentId
})
}
if(!relInParentId&&!parent){
return components
}
return components.filter(function(component){
return component.getRelIn()&&component.getRelIn().id===relInParentId
})
},
getTopShiftMin:function(components){
components=components?this.removeRelToDependant(this.removeChildren(components)):[this];
var page=this.getPage()||(this.getParent()?this.getParent().getCurrentPage():this.getCurrentPage());
return components.reduce(function(amount,component){
var relIn=component.getRelIn(),relTo=component.getRelTo(),relPara=component.getRelPara(),relPage=component.getRelPage(),rel=Math.min(relIn&&relIn.top!==undefined?relIn.top:Infinity,relPara&&relPara.offset!==undefined?relPara.offset:Infinity,relTo&&relTo.below!==undefined?relTo.below:Infinity,relPage&&relPage[page.id]&&!relTo&&!relIn&&!relPara&&relPage[page.id]!==undefined?relPage[page.id]:Infinity);
return Math.min(amount,rel)
},Infinity)
},
removeChildren:function(components){
return components.filter(function(component){
var parent=component.getRelInParent();
while(parent&&!parent.isDocument()){
if(components.indexOf(parent)>-1){
return false
}
parent=parent.getRelInParent()
}
return true
})
},
getBottomShiftMin:function(components){
var minDY=-Infinity,minTop=Infinity,maxBottom=0;
components.forEach(function(item){
minTop=Math.min(minTop,item.bbox.top);
maxBottom=Math.max(maxBottom,item.bbox.bottom)
});
var totalHeight=maxBottom-minTop;
components.forEach(function(item){
var minHeight=item.getMinHeight(),height=item.getHeight();
minDY=Math.max(minDY,-(height-minHeight)/height*totalHeight)
});
return minDY
},
inImageWithLink:function(){
var parent=this.getRelInParent();
while(parent){
if(parent instanceof web.data.components.resources.Image&&parent.getAction()){
return true
}
parent=parent.getRelInParent()
}
}
});
Ext.override(web.data.components.Component,{
getWidth:function(){
var width=this.bbox?this.bbox.right-this.bbox.left:100,minWidth=this.getMinWidth(),maxWidth=this.getMaxWidth();
return width<minWidth?minWidth:width>maxWidth?maxWidth:width
},
setWidth:function(width){
width=Math.max(this.getMinWidth(),width);
this.width=width;
if(!this.inText()){
this.bbox=this.bbox||{
top:0,
bottom:this.height,
left:0
};
this.bbox.right=this.bbox.left+this.width
}
},
getInnerWidth:function(){
var width=this.getWidth(),spacing=this.getSpacing();
return Math.max(0,width-spacing.left-spacing.right)
},
getMinWidth:function(){
var spacing=this.getSpacing();
return Math.max(1,spacing.left+spacing.right)
},
getMaxWidth:function(){
return 3000
}
});
Ext.override(web.data.components.Component,{
getHeight:function(){
var height=!this.inText()&&this.bbox?this.bbox.bottom-this.bbox.top:this.height;
return Math.max(this.getMinHeight(),height)
},
setHeight:function(height){
height=Math.max(this.getMinHeight(),height);
this.height=height;
if(!this.inText()){
this.bbox=this.bbox||{
top:0,
right:this.width,
left:0
};
this.bbox.bottom=this.bbox.top+this.height
}
},
getInnerHeight:function(){
var height=this.autoHeight||this.getHeight(),spacing=this.getSpacing();
return Math.max(0,height-spacing.top-spacing.bottom)
},
getMinHeight:function(){
var spacing=this.getSpacing();
return Math.max(1,spacing.top+spacing.bottom)
},
getMaxHeight:function(){
return 30000
}
});
Ext.override(web.data.components.Component,{
isMobileLeaf:function(){
return!this.isContainer()||this instanceof web.data.components.Text
},
isMobileBase:function(){
return false
},
isMobileHide:function(){
return this.mobileHide
},
isMobileSortable:function(){
return true
},
isMobileAutoSort:function(){
return this.isMobileSortable()&&!this.inPage()
},
getMobileDown:function(){
var mobileDown=this.mobileDown;
return mobileDown===undefined?this.isMobileAutoSort():mobileDown
},
getMobileSortWeight:function(){
return this.getMobileDown()?1000:0
},
getMobileLeaves:function(){
return this.isMobileLeaf()?[this]:[]
},
getMobileIndex:function(){
var template=this.getTemplate()||this,leaves=template.getMobileLeaves(true);
return leaves.indexOf(this)
}
});
Ext.override(web.data.components.Component,{
MAX_X:10000,
MAX_Y:100000,
getBBox:function(){
var bbox=this.bbox,top=bbox?this.finalAutoTop||bbox.top:0;
if(window.ONEWEB6113Test){
top=bbox?bbox.top||this.finalAutoTop:0
}
var left=bbox?bbox.left:0,right=bbox?bbox.right:this.getWidth();
if(this.isStretch()){
left=0;
var template=this.getTemplate();
right=template?template.getWidth():right
}
var cbbox=bbox?{
top:top,
right:Math.max(left+1,right),
bottom:top+Math.max(this.autoHeight||bbox.bottom-bbox.top,1),
left:left
}:{
top:0,
right:this.getWidth(),
bottom:this.getHeight(),
left:0
};
cbbox={
top:Math.min(cbbox.top,this.MAX_Y-1),
right:Math.min(cbbox.right,this.MAX_X),
bottom:Math.min(cbbox.bottom,this.MAX_Y),
left:Math.min(cbbox.left,this.MAX_X-1)
};
this.bbox=cbbox;
return cbbox
},
getRelIn:function(original){
var relIn=this.relIn,parent,bbox,pbbox;
if(relIn&&relIn.id!==this.id){
parent=this.getRelInParent();
if(!parent){
return
}
if(original){
return{
id:relIn.id,
top:relIn.top,
right:relIn.right,
bottom:relIn.bottom,
left:relIn.left
}
}
bbox=this.getBBox();
pbbox=parent.getBBox();
return{
id:relIn.id,
top:bbox.top-pbbox.top,
right:bbox.right-pbbox.right,
bottom:bbox.bottom-pbbox.bottom,
left:bbox.left-pbbox.left
}
}
},
isWrap:function(){
return this.wrap
},
getRelPara:function(){
var relPara=this.relPara,parent;
if(relPara&&this.wrap){
parent=this.getRelInParent();
if(parent instanceof web.data.components.Table){
var relCol=this.getRelParaCol(),rows=parent.richtext.cells.getRows(),rowIndex=Math.min(relPara.row,rows.length-1),cell=relCol?rows[rowIndex][relCol.col]:null,str=parent.richtext.text,paraIndex,paraMax,cellIndex;
if(cell){
paraIndex=str.substr(0,cell.getStart()).split(/[\t\n]/).length-1;
paraMax=Math.max(paraIndex,str.substr(0,cell.getEnd()).split(/[\t\n]/).length-2);
cellIndex=Math.min(relPara.cellIndex,paraMax-paraIndex)
}
return{
row:rowIndex,
cellIndex:cellIndex,
index:paraIndex+cellIndex,
offset:relPara.offset
}
}else if(parent instanceof web.data.components.Text){
return{
index:Math.min(parent.getParagraphCount(),relPara.index),
offset:relPara.offset
}
}
}
},
getRelParaCell:function(){
var parent=this.getRelInParent();
if(parent instanceof web.data.components.Table){
var relPara=this.getRelPara(),relCol=this.getRelParaCol(),rows=parent.richtext.cells.getRows();
return rows[relPara.row][relCol.col]
}
},
getRelParaCol:function(){
var para=this.relPara;
if(para&&para.row!==undefined){
var bbox=this.getRelInBBox(),cx=Math.round((bbox.left+bbox.right)/2),table=this.getRelInParent(),rows=table.richtext.cells.getTableRows(),row=rows[0],left=0,colIndex;
row.forEach(function(cell,index){
if(colIndex===undefined){
var width=cell.getWidth();
left+=width;
if(left>cx){
colIndex=index;
left-=width
}
}
},this);
return{
col:colIndex===undefined?row.length-1:colIndex,
left:bbox.left-left
}
}
},
getRelTo:function(){
var relTo=this.relTo;
if(relTo&&relTo.id!==this.id){
if(!this.getRelToItem()){
return
}
return{
id:relTo.id,
below:Math.min(relTo.below,this.MAX_Y)
}
}
},
getRelToItem:function(){
var item=this.relTo&&this.relTo.id?this.dm.get(this.relTo.id):null;
return item&&item.isGhost()?null:item
},
getRelToTemplate:function(){
var next=this.getRelToItem();
for(var i=0;next&&next.inPage()&&i<1000;i+=1){
next=next.getRelToItem()
}
return next&&!next.inPage()?next:null
},
getRelToGroupId:function(){
var groupId=0,that=this;
if(this.inPage()){
that=this.getRelToTemplate()
}
var hasPageItemMap={};
this.getAllItems().forEach(function(item){
if(item.inPage()&&item.relTo&&item.relTo.id&&!item.isGhost()){
hasPageItemMap[item.relTo.id]=true
}
},this);
var prev=that;
that=that?that.getRelToItem():null;
for(var i=0;that&&that.inPage()&&i<1000;i+=1){
if(hasPageItemMap[that.id]){
groupId=prev.id
}
prev=that;
that=that.getRelToItem()
}
return groupId
},
getRelPage:function(){
return this.relPage
},
getAllItems:function(){
var root=this.getTemplate()||this.getParent();
return root?root.getAllItems():[]
},
getRelInParent:function(){
var parent=(this.relIn&&!this.isStretch()?this.dm.get(this.relIn.id):null)||this.getTemplate();
return parent&&parent.isGhost()?null:parent
},
getRelInSiblings:function(){
var relIn=this.getRelInParent(),sibs=[];
this.getAllItems().forEach(function(item){
var itemRelIn=item.getRelInParent();
if(relIn===itemRelIn&&!item.isGhost()){
sibs.push(item)
}
},this);
return sibs
},
getRelInItems:function(){
var items=[];
this.getAllItems().forEach(function(item){
if(this===item.getRelInParent()&&!item.isGhost()){
items.push(item)
}
},this);
return items
},
getRelParaItems:function(){
var items=[];
this.getRelInItems().forEach(function(item){
if(this.getRelPara()){
items.push(item)
}
},this);
return items
},
getRelToItems:function(){
var items=[];
this.getAllItems().forEach(function(item){
if(item.relTo&&item.relTo.id===this.id&&!item.isGhost()){
items.push(item)
}
},this);
return items
},
getRelInBBox:function(rInMap){
var dm=this.dm,rIn=this.getRelIn(),oldBbox=this.getBBox(),width=oldBbox.right-oldBbox.left,height=oldBbox.bottom-oldBbox.top,bbox=rIn&&dm.get(rIn.id)?rIn:oldBbox,rTo=this.getRelTo(),rItem=rTo?dm.get(rTo.id):null,pageBtm=0,itemBtm=0,top=bbox.top,left=bbox.left;
rInMap=rInMap||{};
if(rTo&&rIn&&!rInMap[rIn.id]){
rInMap[rIn.id]=true;
if(rTo.page){
this.getRelInSiblings().forEach(function(sib){
if(sib.inPage()){
var sibRelIn=sib.getRelIn();
pageBtm=Math.max(pageBtm,(sibRelIn?sibRelIn.top:sib.getBBox().top)+sib.height)
}
})
}
if(rItem){
var rB=rItem.getRelInBBox(rInMap);
itemBtm=rB.top+rItem.getHeight()
}
top=pageBtm||itemBtm?(pageBtm&&itemBtm?Math.min(pageBtm,itemBtm):Math.max(pageBtm,itemBtm))+rTo.below:top
}
return{
top:top,
right:left+width,
bottom:top+height,
left:left
}
}
});
web.data.components.Layer=Ext.extend(web.data.components.Component,{
type:'web.data.components.Layer',
name:null,
constructor:function(config){
this.name='';
this.items=[];
web.data.components.Layer.superclass.constructor.call(this,config)
},
set:function(json){
var nj=Ext.apply({},json),dm;
delete json.items;
web.data.components.Layer.superclass.set.call(this,json);
dm=this.dm;
if(nj.items){
this.items=[];
var itemMap={};
nj.items.forEach(function(item){
if(!itemMap[item.id]){
item.parent=this;
this.items.push(dm.create(item));
itemMap[item.id]=item
}
},this);
delete nj.items
}
},
getName:function(){
return this.name
},
renderItems:function(doc){
this.items.forEach(function(item){
item.render(doc)
})
},
toJSON:function(){
var obj=web.data.components.Layer.superclass.toJSON.call(this);
obj.name=this.name;
obj.items=[];
this.getItems().forEach(function(item){
obj.items.push(item.toJSON())
});
return obj
},
getAssets:function(doc){
var assets=web.data.components.Layer.superclass.getAssets.call(this);
this.items.forEach(function(item){
assets=assets.concat(item.getAssets())
});
return assets
},
getItems:function(){
var items=[];
(this.items||[]).forEach(function(item){
items.push(item)
});
return[].concat(this.items)
},
getAllItems:function(){
var template=this.getTemplate()||this,page=this.getCurrentPage?this.getCurrentPage():this,items=[].concat(template.getItems(),page?page.getItems():[]);
items=items.sort(function(a,b){
return a.getZIndex()-b.getZIndex()
});
return items
},
addItem:function(item,index){
if(this.items.length>=web.data.components.Layer.MAX_ITEMS){
return
}
var itemId=item.id,found;
found=this.items.some(function(other){
return other.id===itemId
});
if(found){
return
}
if(index||index===0){
this.items.splice(index,0,item)
}else{
this.items.push(item)
}
item.parent=this
},
removeItem:function(item){
var index=this.items.indexOf(item);
if(index>=0){
this.items.splice(index,1);
item.oldParent=item.parent;
item.parent=null
}
return index
},
indexOf:function(item){
var template=this.getTemplate()||this,page=this.getCurrentPage?this.getCurrentPage():this,items=[].concat(template.getItems(),page?page.getItems():[]);
return items.indexOf(item)
}
});
web.data.components.Layer.MAX_ITEMS=1000;
Ext.override(web.data.components.Layer,{
renderItems:function(doc){
this.items.forEach(function(item){
item.render(doc)
})
},
renderAllItems:function(doc){
if(doc.editMode){
this.renderFlat(doc)
}else{
this.renderNested(doc)
}
},
renderFlat:function(doc){
var template=this.getTemplate()||this,page=this.getCurrentPage?this.getCurrentPage():this;
doc.appendToCSS('.innerBody{position:relative;}\n');
if(!template.isRenderEmpty()){
template.renderItems(doc)
}else{
template.renderEmpty(doc,'emptyTemplate')
}
if(page&&!doc.editMode){
page.renderItems(doc)
}
},
getLayers:function(){
var dm=this.dm,template=this.getTemplate(),items=this.getAllItems(),groupMap={},groups=[],layers=[];
if(!template){
return layers
}
items.forEach(function(item){
if(item.isGhost()){
return
}
var id=(item.getRelInParent()||{}).id||template.id,index=groupMap[id],group=groups[index];
if(!group){
index=groupMap[id]=groups.length;
group={
block:dm.get(id),
items:[]
};
groups.push(group);
var tmp=item,level=0;
for(var i=0;tmp&&tmp.relIn&&i<1000;i+=1){
tmp=dm.get(tmp.relIn.id);
level=tmp?level+1:level
}
layers[level]=layers[level]||[];
layers[level].push(group);
group.level=level
}
groups[index].items.push(item)
});
var page=this.getCurrentPage?this.getCurrentPage():this;
layers.forEach(function(groups){
groups.forEach(function(group,groupId){
var items=group.items,relToDepth={};
items.forEach(function(item,index){
var id=item.id,rItem=item,idMap={};
idMap[rItem.id]=true;
relToDepth[id]=0;
for(var i=0;rItem&&i<1000;i+=1){
relToDepth[id]+=rItem.inPage()?1:1000;
if(rItem.getRelPage()&&rItem.getRelPage()[page.id]!==undefined){
relToDepth[id]+=100000
}
rItem=rItem.getRelToItem();
if(rItem&&idMap[rItem.id]){
one.fatal('Circular relTo reference- This should never happen');
break
}
idMap[rItem?rItem.id:null]=true
}
});
items=items.sort(function(a,b){
return relToDepth[a.id]-relToDepth[b.id]
},this)
})
});
return layers
},
getGhosts:function(){
var items=this.getAllItems(),ghosts=[];
items.forEach(function(item){
if(item.isGhost()){
ghosts.push(item)
}
});
return ghosts
}
});
web.data.components.LayerBox=Ext.extend(Object,{
constructor:function(box,block){
Ext.apply(this,box);
this.block=block
},
hasStretch:function(){
var hasStretch,nodes=[].concat(this.nodes||[],this.floats||[]);
nodes.forEach(function(node){
hasStretch=hasStretch||(node.component?node.component.isStretch():false)
});
return hasStretch
},
recalcMinHeight:function(ibox,height){
var nodes=ibox.nodes||[];
var hasWebShopComponent=function(){
var flag=false;
nodes.forEach(function(node){
if(node.component&&node.component.type==='web.data.components.WebShop'){
flag=true
}
});
return flag
}();
if(hasWebShopComponent){
var tallestWebshop=0,tallestOther=0;
nodes.forEach(function(node){
var newHeight;
if(node.component&&node.component.type==='web.data.components.WebShop'){
newHeight=node.component.bbox.top+web.data.components.WebShop.prototype.getMinHeight();
if(!tallestWebshop||newHeight>tallestWebshop){
tallestWebshop=newHeight
}
}else{
newHeight=node.component.bbox.bottom;
if(!tallestOther||newHeight>tallestOther){
tallestOther=newHeight
}
}
});
var heightToUse=Math.max(tallestOther,tallestWebshop);
if(heightToUse<=height){
return heightToUse
}else{
return height
}
}else{
return height
}
},
isText:function(){
return this.block instanceof web.data.components.Text
},
isContainer:function(){
var block=this.block;
return!block||block.isContainer()&&!this.isText()
},
isStretch:function(){
var block=this.block;
return block?block.isStretch():false
},
getSpacing:function(){
var block=this.block;
return block?block.getSpacing():null
},
getFloats:function(){
var floats=this.floats||[],isContainer=this.isContainer();
if(!(isContainer&&this.rows)&&!(isContainer&&this.cols)){
floats=floats.concat(this.nodes||[]);
if(this.isText()){
var newFloats=[];
floats.forEach(function(float){
if(!float.component.getRelPara()){
newFloats.push(float)
}
});
floats=newFloats
}
}
return floats
},
needFloatWrap:function(){
return this.getFloats().length&&(this.isStretch()||this.hasStretch())
},
createBox:function(box,block){
return box instanceof web.data.components.LayerBox?box:new web.data.components.LayerBox(box,block)
},
render:function(renderEngine){
var that=this,box=that,block=this.block;
var doc=renderEngine.doc,tStyle=renderEngine.tStyle;
var left,isText=box.isText(),isContainer=box.isContainer(),spacing=box.getSpacing();
var isStretch=box.isStretch();
if(block){
block.renderOuterStart(doc);
if(isContainer){
block.renderSelfStart(doc)
}else if(isText){
block.renderSelf(doc,function(indent){
var tbox=box.createBox(web.data.components.Layer.toBoxNodes(indent));
tbox.render(renderEngine)
})
}else{
block.renderSelf(doc)
}
}
var floatWrap=box.needFloatWrap();
if(floatWrap){
box.renderFloats(renderEngine)
}
if(isContainer&&box.rows){
var isTemplate=block instanceof web.data.components.Template,minBottom=Math.max((block?block.autoMinBottom:0)-(spacing?spacing.bottom:0),0);
box.rows.forEach(function(ibox,index){
ibox=box.createBox(ibox);
var iHasStretch=ibox.hasStretch(),isLast=index===box.rows.length-1,rowBottom=isLast&&!isTemplate?Math.round(minBottom):0,height=ibox.region.bottom-ibox.region.top,width=ibox.region.right-ibox.region.left;
height=that.recalcMinHeight(ibox,height);
doc.openTag({
cls:'row',
style:'min-height:'+Math.round(height)+'px;'+(iHasStretch?'min-width:100%;':isStretch?tStyle:'width:'+width+'px;')+(rowBottom?'padding-bottom:'+rowBottom+'px;':'')
});
ibox.render(renderEngine);
doc.closeTag()
},this)
}else if(isContainer&&box.cols){
left=box.region.left;
box.cols.forEach(function(ibox){
ibox=box.createBox(ibox);
var ileft=ibox.region.left-left,itop=ibox.region.top-box.region.top,iwidth=ibox.region.right-ibox.region.left;
doc.openTag({
cls:'col',
style:'width:'+iwidth+'px;'+(itop>0?'margin-top:'+itop+'px;':'')+(ileft>0?'margin-left:'+ileft+'px;':'')
});
ibox.render(renderEngine);
doc.closeTag();
left=ibox.region.right
},this)
}
if(block){
doc.append('<div style="clear:both"></div>\n');
if(isContainer){
block.renderSelfEnd(doc);
doc.append('<div style="clear:both"></div>\n')
}
block.renderOuterEnd(doc)
}
if(!floatWrap){
box.renderFloats(renderEngine)
}
},
renderFloats:function(renderEngine){
var doc=renderEngine.doc,tStyle=renderEngine.tStyle,structure=renderEngine.structure;
var region=this.region,floats=this.getFloats(),spacing=this.getSpacing(),isContainer=this.isContainer(),hasFlat=floats.length&&isContainer&&!floats[0].floating,floatWrap=this.needFloatWrap(),floatWrapRendered;
floats.sort(function(a,b){
return a.component.getZIndex()-b.component.getZIndex()
});
if(hasFlat){
floats[0].isFlat=true;
floats.push(floats.shift())
}
floats.forEach(function(node,index){
var cmp=node.component,box=structure[cmp.id],iregion=node.region,top=iregion.top-region.top,right=region.right-iregion.right,left=iregion.left-region.left,isPadding=top+right+left,isFlat=node.isFlat;
if(!isFlat&&floatWrap&&!floatWrapRendered&&!cmp.isStretch()){
doc.openTag({
cls:'row',
style:tStyle
});
floatWrapRendered=true
}
if(isFlat&&floatWrapRendered){
doc.closeTag()
}
if(isPadding||!isFlat){
if(this.block&&spacing&&!isFlat&&!floatWrap){
top+=spacing.top;
left+=spacing.left
}
doc.openTag({
cls:'extra'+(isFlat?'':' float'),
style:(isFlat?'margin:'+top+'px '+right+'px 0px '+left+'px;':'top:'+top+'px;left:'+left+'px;'+'z-index:'+cmp.getZIndex()+';')+(!left&&!right?'min-width:100%;':'')
})
}
if(box){
box=this.createBox(box,cmp);
box.render(renderEngine)
}else{
cmp.render(doc)
}
if(isPadding||!isFlat){
doc.closeTag()
}
},this);
if(!hasFlat&&floatWrapRendered){
doc.closeTag()
}
}
});
Ext.override(web.data.components.Layer,{
renderNested:function(doc){
var page=this.getCurrentPage?this.getCurrentPage():this,template=page.getTemplate(),tStyle=template.getTemplateRenderStyle(doc);
doc.appendToCSS('.innerBody,.self,.component{position:relative;}\n'+'.extra,.row,.col{-moz-box-sizing:border-box;box-sizing:border-box;position:relative;}\n'+'.extra,.col{float:left;}\n'+'.row{width:100%;clear:both;}\n'+'.extra{width:auto;}\n'+'.float-wrap{position:absolute;top:0;left:0;}\n'+'.float{border-color:#B6B;position:absolute;}\n'+'.col{min-height:1px}\n');
var ghosts=page.getGhosts();
ghosts.forEach(function(ghost){
ghost.render(doc)
});
var structure=page.getStructure(),box=new web.data.components.LayerBox(structure[this.id],this),renderEngine={
doc:doc,
page:page,
template:template,
tStyle:tStyle,
structure:structure
};
box.render(renderEngine)
},
getStructure:function(){
var layers=this.getLayers();
var pageId=this.id;
this.getAllItems().forEach(function(item){
item.autoTop=0;
item.autoHeight=item.getHeight()
});
function fixDown(group){
var items=group.items,block=group.block,autoHeight=block.autoHeight||block.getHeight(),innerHeight=0,bottomSpacing=block.getSpacing().bottom;
var minBottom=Infinity,maxMinBottom=Math.max(1000,Math.min(autoHeight,block.getMaxHeight()));
items.forEach(function(item){
if(item.relIn&&!item.relPara){
minBottom=Math.min(minBottom,-item.relIn.bottom,maxMinBottom)
}
});
minBottom=minBottom===Infinity?bottomSpacing:minBottom;
var pageItemsMap={},maxAutoBottom=0;
items.forEach(function(item){
var top=group.level&&item.relIn?item.relIn.top:item.bbox.top,relItem,relTo=item.getRelTo(),relPage=item.getRelPage(),groupId=item.getRelToGroupId(),pageItems=pageItemsMap[groupId]||[],pageMax=0,autoBottom=0;
item.autoTop=top;
if(relTo||relPage){
var newTop=0;
relItem=item.getRelToItem();
if(relTo&&relItem){
newTop=relItem.autoTop+relItem.autoHeight+relTo.below
}
if(relPage&&relPage[pageId]!==undefined){
pageItems.forEach(function(pageItem){
if(item.bbox.left<pageItem.bbox.right&&pageItem.bbox.left<item.bbox.right){
pageMax=Math.max(pageMax,pageItem.autoTop+pageItem.autoHeight)
}
});
if(pageMax){
newTop=pageMax+relPage[pageId];
if(relItem){
newTop=Math.max(newTop,relItem.autoTop+relItem.autoHeight)
}
}
}
if(newTop){
item.autoTop=newTop
}
}
autoBottom=item.autoTop+item.autoHeight;
if(item.inPage()){
pageItemsMap[groupId]=pageItemsMap[groupId]||[];
pageItemsMap[groupId].push(item)
}
if(autoBottom>maxAutoBottom){
innerHeight=Math.max(innerHeight,autoBottom+minBottom);
maxAutoBottom=autoBottom
}
},this);
if(innerHeight&&block instanceof web.data.components.Block){
autoHeight=innerHeight
}else{
autoHeight=Math.max(autoHeight,innerHeight)
}
block.autoHeight=autoHeight;
block.autoMinBottom=minBottom
}
[].concat(layers).reverse().forEach(function(groups){
groups.forEach(function(group){
fixDown(group)
})
});
var structure={};
layers.forEach(function(groups){
groups.forEach(function(group){
structure[group.block.id]=web.data.components.Layer.toBox(group)
})
});
return structure
}
});
(function(){
function get(item){
var bb=item.getRelInBBox();
return new Ext.lib.Region(bb.top,bb.right,bb.bottom,bb.left)
}
function cp(region,t,r,b,l){
return new Ext.lib.Region(region.top+(t||0),region.right+(r||0),region.bottom+(b||0),region.left+(l||0))
}
web.data.components.Layer=Ext.apply(web.data.components.Layer,{
MAX_DEPTH:100,
toBox:function(group){
var block=group.block,spacing=block.getSpacing?block.getSpacing():{
top:0,
right:0,
bottom:0,
left:0
},isStretch=block.isStretch(),x=!isStretch?spacing.left:0,y=spacing.top,bbox=block.getBBox(),width=bbox.right-bbox.left,height=block.autoHeight||block.getHeight(),items=group.items,nodes=[];
items.forEach(function(item){
var region=get(item);
region.top=item.autoTop;
region.bottom=region.top+item.autoHeight;
nodes.push({
component:item,
region:region
})
},this);
nodes.forEach(function(node){
var region=node.region;
region.top-=y;
region.right-=x;
region.bottom-=y;
region.left-=x
});
width-=!isStretch?x+spacing.right:0;
height-=y+spacing.bottom;
var box={
nodes:nodes,
region:new Ext.lib.Region(0,width,height,0)
};
if(!(block instanceof web.data.components.Block||block instanceof web.data.components.Template)){
return box
}
return this.toBoxNodes(box)
},
toBoxNodes:function(box){
var nodes=box.nodes,container=box.region;
var newNodes=[];
nodes.forEach(function(node){
if(container.contains(node.region)){
newNodes.push(node)
}else{
box.floats=box.floats||[];
box.floats.push(node);
node.floating=true
}
},this);
box.nodes=newNodes;
box=this.toRowBox(box);
return box
},
toRowBox:function(box,level){
level=level||1;
if(level>web.data.components.Layer.MAX_DEPTH){
return box
}
var nodes=box.nodes,row={
nodes:[],
region:cp(box.region,0,0,box.region.top-box.region.bottom+1,0)
};
box.rows=[];
nodes.sort(function(a,b){
return a.region.top-b.region.top
});
var hasColRow,prevColCount=0,prevNode,nextCols=[];
function colAdd(cols,node){
if(!colValid(cols)){
return
}
var added=[],region=node.region,width=region.right-region.left,mainCol;
cols.forEach(function(col){
if(col.region.left<region.right&&region.left<col.region.right){
col.nodes.push(node);
col.oldRegion=cp(col.region);
col.region=col.region.union(region);
added.push(col)
}
});
if(!added.length){
cols.push({
region:cp(region),
nodes:[node]
});
cols.sort(function(a,b){
return a.region.left-b.region.left
})
}
if(added.length>1){
var significantCols=[];
added.forEach(function(col,index){
var or=col.oldRegion,colWidth=or.right-or.left,overlap=Math.min(region.right,or.right)-Math.max(region.left,or.left);
if(overlap>colWidth){
significantCols.push(col)
}
if(overlap>width){
mainCol=col
}
});
mainCol=significantCols.length<=1&&mainCol?mainCol:null;
if(mainCol){
node.floating=true;
added.forEach(function(col,index){
if(mainCol!==col){
col.nodes.pop()
}
col.region=col.oldRegion
})
}
}
cols.forEach(function(col){
delete col.oldRegion
})
}
function colValid(cols){
for(var i=0,len=cols.length;i<len-1;i+=1){
var intersect=cols[i].region.intersect(cols[i+1].region);
if(intersect&&intersect.getArea()){
return false
}
}
return true
}
var len=nodes.length,node,lastRow=row,prevCol,prevRow,rr,rlen,apply,intersect;
for(var index=0,i=0;row&&index<=len+1&&i<10000;index+=1,i+=1){
node=nodes[index];
rr=row.region;
rlen=row.nodes.length;
apply=false;
intersect=node&&rlen?rr.intersect(node.region):null;
if(rlen&&(!intersect||!intersect.getArea())){
if(nextCols.length>1){
if(colValid(nextCols)&&nextCols.length>=prevColCount){
hasColRow=true;
prevColCount=nextCols.length;
prevNode=node;
prevRow={
nodes:[],
region:cp(row.region),
cols:[]
};
row.nodes.forEach(function(node){
prevRow.nodes.push(node)
});
prevCol=null;
nextCols.forEach(function(col){
var region=cp(col.region);
region.left=prevCol?prevCol.region.right:region.left;
prevCol={
nodes:[],
region:region
};
col.nodes.forEach(function(node){
prevCol.nodes.push(node)
});
prevRow.cols.push(prevCol)
})
}else if(prevNode){
row=prevRow;
node=prevNode;
rr=prevRow.region;
index=nodes.indexOf(node);
prevColCount=0;
prevNode=null;
prevRow=null;
apply=true
}else{
apply=true
}
}else{
apply=true
}
if(apply){
box.rows.push(row);
nextCols=[];
lastRow=row;
row=node?{
nodes:[],
region:cp(rr,rr.bottom-rr.top,0,1,0)
}:null
}
}
if(node){
colAdd(nextCols,node);
if(row){
row.nodes.push(node);
row.region=row.region.union(node.region)
}
}
}
if(prevRow){
box.rows.push(prevRow);
lastRow=prevRow
}
if(level===1||box.rows.length>1||box.rows.length>0&&hasColRow){
box.rows.forEach(function(row,index){
if(row.nodes.length>1){
if(row.cols){
row.cols.forEach(function(col){
if(col.nodes.length>1){
this.toRowBox(col,level+2)
}
},this)
}else{
this.toColBox(row,level+1)
}
}
},this)
}else{
delete box.rows
}
return box
},
toColBox:function(box,level){
level=level||1;
if(level>web.data.components.Layer.MAX_DEPTH){
return box
}
var nodes=box.nodes,col={
nodes:[],
region:cp(box.region,0,box.region.left-box.region.right+1,0,0)
};
box.cols=[];
nodes.sort(function(a,b){
return a.region.left-b.region.left
});
nodes.forEach(function(node){
var cr=col.region,len=col.nodes.length,intersect=len?cr.intersect(node.region):null;
if(len&&(!intersect||!intersect.getArea())){
box.cols.push(col);
col={
nodes:[],
region:cp(cr,0,1,0,cr.right-cr.left)
}
}
col.nodes.push(node);
col.region=col.region.union(node.region)
},this);
box.cols.push(col);
col.region.right=box.region.right;
if(level===1||box.cols.length>1){
box.cols.forEach(function(col,index){
if(col.nodes.length>1){
this.toRowBox(col,level+1)
}
},this)
}else{
delete box.cols
}
return box
}
})
}());
web.data.components.Page=Ext.extend(web.data.components.Layer,{
type:'web.data.components.Page',
constructor:function(config){
web.data.components.Page.superclass.constructor.call(this,config)
},
toJSON:function(){
var obj=web.data.components.Page.superclass.toJSON.call(this);
obj.name=this.name;
obj.templateId=this.templateId;
return obj
},
getTemplateId:function(){
return this.templateId
},
getTitle:function(){
var site=this.dm.getSite(),link=site?site.getLink(this.id):null;
return link?link.getTitle():''
},
getDescription:function(){
var site=this.dm.getSite(),link=site?site.getLink(this.id):null;
return link?link.getDescription():''
},
getRobots:function(){
var site=this.dm.getSite(),link=site?site.getLink(this.id):null;
return link?link.getRobots():''
},
isDocument:function(){
return true
},
render:function(doc){
var title=this.getTitle(),name=this.getName(),htmlEncode=Ext.util.Format.htmlEncode;
if(title===''){
title=name
}
doc.reset();
doc.setPage(this);
doc.setSeoHead('<title>'+htmlEncode(title)+'</title>\n'+'<meta name="description" content="'+htmlEncode(this.getDescription())+'"/>\n');
doc.appendToHead('<meta name="robots" content="'+htmlEncode(this.getRobots())+'"/>\n'+'<meta name="generator" content="One.com Web Editor">\n'+'<meta http-equiv="Cache-Control" content="must-revalidate, max-age=0, public">\n'+'<meta http-equiv="Expires" content="-1">\n');
var template=this.getTemplate();
if(template){
template.render(doc)
}
},
isCommitted:function(){
return this.rev!==null
},
canRender:function(){
var template=this.getTemplate();
return template&&template.canRender()
},
getTemplate:function(){
return this.dm.get(this.templateId)
},
setTemplate:function(newTemplate){
this.resetStylesheet(newTemplate.getStylesheet());
this.set({templateId:newTemplate.getId()});
if(!this.dm.get(this.templateId)){
this.dm.register(newTemplate)
}
this.adjust()
},
resetStylesheet:function(stylesheet){
var dm=this.dm;
this.getItems().forEach(function(item){
item.getAllStyles().forEach(function(style){
if(style.globalId){
var oldGlobal=dm.get(style.globalId)||dm.create(style),newGlobal=stylesheet.getClosestStyle(oldGlobal);
if(newGlobal){
style.set({globalId:newGlobal.getId()})
}
}
})
})
},
adjust:function(){
var template=this.getTemplate(),dm=this.dm,items=this.getItems(),pageRegion,area=template.getPageArea(this.id),aRelIn=area.relIn,aRelTo=area.relTo;
if(!items.length){
return
}
items.forEach(function(item){
var bbox=item.getBBox(),region=new Ext.lib.Region(bbox.top,bbox.right,bbox.bottom,bbox.left);
if(!pageRegion){
pageRegion=region
}else{
pageRegion=pageRegion.union(region)
}
});
var aRegion=area.bbox,dt=aRegion.top-pageRegion.top,ow=pageRegion.right-pageRegion.left,nw=aRegion.right-aRegion.left,rw=nw/ow,ox=pageRegion.left,nx=aRegion.left;
items.forEach(function(item){
var relInItem=item.relIn?dm.get(item.relIn.id):null,relToItem=item.relTo?dm.get(item.relTo.id):null,noRelIn=!relInItem||relInItem&&!relInItem.inPage();
item.bbox.top+=dt;
item.bbox.bottom+=dt;
item.bbox.left-=ox;
item.bbox.right-=ox;
item.bbox.left=Math.round(item.bbox.left*rw);
item.bbox.right=Math.round(item.bbox.right*rw);
item.width=item.bbox.right-item.bbox.left;
item.bbox.left+=nx;
item.bbox.right+=nx;
if(relInItem){
item.relIn={
id:item.relIn.id,
top:item.bbox.top-relInItem.bbox.top,
right:item.bbox.right-relInItem.bbox.right,
bottom:item.bbox.bottom-relInItem.bbox.bottom,
left:item.bbox.left-relInItem.bbox.left
}
}
if(noRelIn){
if(aRelIn){
var aRelInItem=dm.get(aRelIn.id);
item.relIn={
id:aRelIn.id,
top:item.bbox.top-aRelInItem.bbox.top,
right:item.bbox.right-aRelInItem.bbox.right,
bottom:item.bbox.bottom-aRelInItem.bbox.bottom,
left:item.bbox.left-aRelInItem.bbox.left
}
}else{
delete item.relIn
}
}
if(!item.relTo||!item.relTo.id||relToItem&&!relToItem.inPage()){
if(aRelTo&&(relToItem||noRelIn)){
item.relTo={
id:aRelTo.id,
below:Math.max(aRelTo.below,item.relTo?item.relTo.below:0)
}
}else if(item.relTo){
delete item.relTo.id
}
}
})
},
getPage:function(){
return this
},
hasWebShopComponent:function(){
var i=0,webshop=false;
for(i=0;i<this.items.length;i++){
if(this.items[i].type==='web.data.components.WebShop'){
webshop=true;
break
}
}
return webshop
}
});
web.data.components.Page.NAME='Page';
Ext.ns('web.data.styles');
web.data.styles.Style=Ext.extend(web.data.Part,{
type:'web.data.styles.Style',
isStyle:true,
constructor:function(config){
if(!config){
throw'Too few arguments'
}
this.globalId=null;
this.globalName=null;
this.name='';
this.ref=null;
this.cssProperty=null;
this.filter=null;
this.groupId=null;
this.clsPfx='';
this.global=null;
web.data.styles.Style.superclass.constructor.call(this,config)
},
destroy:function(){
this.globalId=null;
this.globalName=null;
this.name=null;
this.ref=null;
this.cssProperty=null;
this.filter=null;
this.groupId=null;
this.clsPfx=null;
web.data.styles.Style.superclass.destroy.call(this)
},
getCSSClass:function(doc){
var cls='',global,pfx=this.clsPfx;
if(this.inStylesheet()){
cls=this.getRef().toLowerCase();
cls=(pfx&&pfx!==cls.substr(0,pfx.length)?pfx:'')+cls
}else if(this.parent&&!this.parent.isStyle){
if(this.globalId){
global=this.dm.get(this.globalId);
if(global){
cls+=global.getCSSClass(doc)
}
}
if(doc&&doc.editMode||this.getCSSSelector()&&this.getCSSDeclarations(doc)){
cls+=(cls?' ':'')+'id'+this.id
}
}else{
cls=pfx?pfx:''
}
return cls.replace(/[^a-z0-9 ]+/gi,'')
},
getCSSSelector:function(doc){
var cls='';
if(this.inStylesheet()){
cls=(this.clsPfx?this.clsPfx:'')+this.ref.toLowerCase()
}else if(this.parent&&!this.parent.isStyle){
cls+='id'+this.id
}
return cls?(doc&&doc.classPrefix?'.'+doc.classPrefix+' .':'.')+cls.replace(/[^a-z0-9]+/gi,''):''
},
getCSSValue:function(){
return''
},
getCSSDeclarations:function(doc){
var property=this.cssProperty,value=this.getCSSValue(doc);
return property&&value!==''?property+':'+value+';\n':''
},
toCSS:function(doc){
var sel=this.getCSSSelector(doc),decs=this.getCSSDeclarations(doc),hdRules=doc.hdImages&&this.getCSSRulesForHD&&this.getCSSRulesForHD(doc,sel),css;
css=sel&&(decs||!doc||doc.editMode)?sel+'{\n'+(decs?decs:'')+'}\n':null;
if(sel&&hdRules){
css+=hdRules
}
return css
},
inStylesheet:function(){
return this.parent&&this.parent instanceof web.data.styles.Stylesheet
},
getRootStyle:function(){
var that=this,parent=this.getParent();
while(parent instanceof web.data.styles.Style){
that=parent;
parent=that.getParent()
}
return that
},
toJSON:function(){
var obj={type:this.type};
if(this.inStylesheet()){
obj.id=this.id;
obj.name=this.name;
if(this.filter){
obj.filter=this.filter
}
if(this.groupId){
obj.groupId=this.groupId
}
}else if(!this.parent||!this.parent.isStyle){
if(this.globalId){
obj.globalId=this.globalId;
obj.globalName=this.getGlobalName()
}
}else{
obj={}
}
if(this.ref){
obj.ref=this.ref
}
return Ext.apply(obj,this.getSpecificJSON())
},
getSpecificJSON:function(){
return{}
},
isEqual:function(){
},
check:function(){
if(this.type===null){
return false
}
if(this.parent===null){
return true
}
if(this.parent instanceof web.data.styles.Stylesheet){
if(!Ext.isString(this.ref)||!this.ref.trim().length){
return false
}
if(!this.checkReservedName()){
return false
}
}else if(!this.parent.isStyle){
if(!this.id){
return false
}
}
return true
},
checkReservedName:function(){
var ref,names,found=false;
ref=this.ref.toLowerCase().trim();
names=web.data.styles[this.getStyleType()].names;
if(!names){
return false
}
ref=ref.split('.')[0];
names.forEach(function(iname){
if(iname.indexOf(ref)===0){
found=true
}
});
return found
},
getGlobalId:function(){
return this.globalId
},
getGlobalName:function(){
var global;
if(!this.globalName){
global=this.getGlobal();
if(global){
this.globalName=global.getName()
}
}
return this.globalName
},
getGlobal:function(){
if(this.globalId){
return this.dm.get(this.globalId)
}else{
return null
}
},
getApplied:function(prop){
var applied=this[prop],override,global;
if(applied===undefined||!applied.getCSSValue){
one.error('Unknown style property requested');
return null
}
if(this.globalId===null){
return applied.toJSON()
}else{
override=applied;
global=this.getGlobal();
applied=global?global[prop]:null;
if(!applied){
return override.toJSON?override.toJSON():override
}
return applied.append(override)
}
},
getName:function(){
return this.name
},
getRef:function(){
return this.ref||this.getStyleType()
},
getAliases:function(){
var ref=this.getRef(),aliases=ref?[ref]:[];
if(this.inStylesheet()){
return aliases.concat(this.parent.getAliases(this.getName()))
}else{
return null
}
},
getFilter:function(){
return this.filter
},
getGroupId:function(){
return this.groupId
},
getStyleType:function(){
return this.getType().replace('web.data.styles.','')
},
append:function(cfg){
return Ext.applyIf({
id:this.id,
cssProperty:this.cssProperty
},cfg)
},
getItems:function(){
return[]
}
});
web.data.styles.Frame=Ext.extend(web.data.styles.Style,{
type:'web.data.styles.Frame',
constructor:function(config){
if(!config){
throw'Config is missing.'
}
this.edgeCSSProps={
top:'',
right:'',
bottom:'',
left:''
};
this.top=null;
this.right=null;
this.bottom=null;
this.left=null;
web.data.styles.Frame.superclass.constructor.call(this,config)
},
destroy:function(){
this.top=null;
this.right=null;
this.bottom=null;
this.left=null
},
set:function(opts){
if(Ext.isArray(opts)){
this.top=opts[0];
this.right=opts[1];
this.bottom=opts[2];
this.left=opts[3]
}else if(opts===null){
this.top=null;
this.right=null;
this.bottom=null;
this.left=null
}else{
Ext.apply(this,opts)
}
},
getEdgeCSSDeclaration:function(edge){
if(edge!=='top'&&edge!=='right'&&edge!=='bottom'&&edge!=='left'){
one.error(edge+' is not a valid side')
}
var prop=this[edge],name=this.edgeCSSProps[edge];
if(prop===null||!name){
return''
}else{
return name+':'+prop+';\n'
}
},
getCSSDeclarations:function(){
return this.getEdgeCSSDeclaration('top')+this.getEdgeCSSDeclaration('right')+this.getEdgeCSSDeclaration('bottom')+this.getEdgeCSSDeclaration('left')
},
toJSON:function(){
var obj=[],i,edge,edges;
if(this.top===null&&this.right===null&&this.bottom===null&&this.left===null){
return null
}
edges=[
this.top,
this.right,
this.bottom,
this.left
];
for(i=0;i<4;i+=1){
edge=edges[i];
if(edge===null||edge===undefined){
obj.push(null)
}else{
if(edge.isColor){
edge=edge.rgb()
}
obj.push(edge.toJSON?edge.toJSON():edge)
}
}
return obj
},
checkEdge:function(edge){
return false
},
check:function(){
var i,edge,edges=[
this.top,
this.right,
this.bottom,
this.left
];
for(i=0;i<4;i+=1){
edge=edges[i];
if(edge!==null&&!this.checkEdge(edge)){
return false
}
}
return true
},
getTop:function(){
return this.top
},
getRight:function(){
return this.right
},
getBottom:function(){
return this.bottom
},
getLeft:function(){
return this.left
},
append:function(cfg){
if(!cfg){
return this
}
var top=cfg.getTop()!==null?cfg.getTop():this.top,right=cfg.getRight()!==null?cfg.getRight():this.right,bottom=cfg.getBottom()!==null?cfg.getBottom():this.bottom,left=cfg.getLeft()!==null?cfg.getLeft():this.left;
return[
top,
right,
bottom,
left
]
}
});
web.data.styles.FrameStyle=Ext.extend(web.data.styles.Frame,{
type:'web.data.styles.FrameStyle',
cssProperty:'border-style',
constructor:function(config){
this.top=null;
this.right=null;
this.bottom=null;
this.left=null;
web.data.styles.FrameStyle.superclass.constructor.call(this,config);
this.edgeCSSProps={
top:'border-top-style',
right:'border-right-style',
bottom:'border-bottom-style',
left:'border-left-style'
}
},
checkEdge:function(edge){
return web.data.styles.FrameStyle.types.indexOf(edge)!==-1
}
});
web.data.styles.FrameStyle.types=[
'dotted',
'dashed',
'solid'
];
web.data.styles.FrameWidth=Ext.extend(web.data.styles.Frame,{
type:'web.data.styles.FrameWidth',
constructor:function(config){
this.edgeCSSProps=null;
web.data.styles.FrameWidth.superclass.constructor.call(this,config)
},
toJSON:function(){
var obj=[],i,edge,edges;
if(!this.isSet()){
return null
}
edges=[
this.top,
this.right,
this.bottom,
this.left
];
for(i=0;i<4;i+=1){
edge=edges[i];
if(edge===null){
obj.push(null)
}else{
obj.push(Number(edge))
}
}
return obj
},
isSet:function(){
return this.top!==null||this.right!==null||this.bottom!==null||this.left!==null
},
isEqual:function(o){
return this.top===o.top&&this.right===o.right&&this.bottom===o.bottom&&this.right===o.right
},
getEdgeCSSDeclaration:function(edge){
if(edge!=='top'&&edge!=='right'&&edge!=='bottom'&&edge!=='left'){
one.error(edge+' is not a valid side')
}
var prop=this[edge];
if(prop===null){
return''
}else{
return this.edgeCSSProps[edge]+':'+prop+'px;\n'
}
},
checkEdge:function(edge){
return!isNaN(edge)&&edge>=0
},
getWidth:function(){
return this
}
});
(function(e,t,n,r,i,s){
function h(n){
if(Object.prototype.toString.apply(n)==='[object Array]'){
if(typeof n[0]=='string'&&typeof h[n[0]]=='function')
return new h[n[0]](n.slice(1,n.length));
if(n.length===4)
return new h.RGB(n[0]/255,n[1]/255,n[2]/255,n[3]/255)
}else if(typeof n=='string'){
var r=n.toLowerCase();
u[r]&&(n='#'+u[r]);
var i=n.match(c);
if(i){
var s=i[1].toUpperCase(),o=a(i[8])?i[8]:e(i[8]),f=s[0]==='H',l=i[3]?100:f?360:255,p=i[5]||f?100:255,d=i[7]||f?100:255;
if(a(h[s]))
throw new Error('one.color.'+s+' is not installed.');
return new h[s](e(i[2])/l,e(i[4])/p,e(i[6])/d,o)
}
n.length<6&&(n=n.replace(/^#?([0-9a-f])([0-9a-f])([0-9a-f])$/i,'$1$1$2$2$3$3'));
var v=n.match(/^#?([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])$/i);
if(v)
return new h.RGB(t(v[1],16)/255,t(v[2],16)/255,t(v[3],16)/255)
}else{
if(typeof n=='object'&&n.isColor)
return n;
if(!isNaN(n))
return new h.RGB((n&255)/255,((n&65280)>>8)/255,((n&16711680)>>16)/255)
}
return!1
}
function p(e,t,i){
function l(e,t){
var r={};
r[t.toLowerCase()]=new n('return this.rgb().'+t.toLowerCase()+'();'),h[t].propertyNames.forEach(function(e,i){
r[e]=r[e==='black'?'k':e[0]]=new n('value','isDelta','return this.'+t.toLowerCase()+'().'+e+'(value, isDelta);')
});
for(var i in r)
r.hasOwnProperty(i)&&h[e].prototype[i]===undefined&&(h[e].prototype[i]=r[i])
}
h[e]=new n(t.join(','),'if (Object.prototype.toString.apply('+t[0]+') === \'[object Array]\') {'+t.map(function(e,n){
return e+'='+t[0]+'['+n+'];'
}).reverse().join('')+'}'+'if ('+t.filter(function(e){
return e!=='alpha'
}).map(function(e){
return'isNaN('+e+')'
}).join('||')+'){'+'throw new Error("['+e+']: Invalid color: ("+'+t.join('+","+')+'+")");}'+t.map(function(e){
return e==='hue'?'this._hue=hue<0?hue-Math.floor(hue):hue%1':e==='alpha'?'this._alpha=(isNaN(alpha)||alpha>1)?1:(alpha<0?0:alpha);':'this._'+e+'='+e+'<0?0:('+e+'>1?1:'+e+')'
}).join(';')+';'),h[e].propertyNames=t;
var s=h[e].prototype;
[
'valueOf',
'hex',
'hexa',
'css',
'cssa'
].forEach(function(t){
s[t]=s[t]||(e==='RGB'?s.hex:new n('return this.rgb().'+t+'();'))
}),s.isColor=!0,s.equals=function(n,i){
a(i)&&(i=1e-10),n=n[e.toLowerCase()]();
for(var s=0;s<t.length;s+=1)
if(r.abs(this['_'+t[s]]-n['_'+t[s]])>i)
return!1;
return!0
},s.toJSON=new n('return [\''+e+'\', '+t.map(function(e){
return'this._'+e
},this).join(', ')+'];');
for(var u in i)
if(i.hasOwnProperty(u)){
var f=u.match(/^from(.*)$/);
f?h[f[1].toUpperCase()].prototype[e.toLowerCase()]=i[u]:s[u]=i[u]
}
s[e.toLowerCase()]=function(){
return this
},s.toString=new n('return "[one.color.'+e+':"+'+t.map(function(e,n){
return'" '+t[n]+'="+this._'+e
}).join('+')+'+"]";'),t.forEach(function(e,r){
s[e]=s[e==='black'?'k':e[0]]=new n('value','isDelta','if (typeof value === \'undefined\') {return this._'+e+';'+'}'+'if (isDelta) {'+'return new this.constructor('+t.map(function(t,n){
return'this._'+t+(e===t?'+value':'')
}).join(', ')+');'+'}'+'return new this.constructor('+t.map(function(t,n){
return e===t?'value':'this._'+t
}).join(', ')+');')
}),o.forEach(function(t){
l(e,t),l(t,e)
}),o.push(e)
}
var o=[],u={},a=function(e){
return typeof e=='undefined'
},f=/\s*(\.\d+|\d+(?:\.\d+)?)(%)?\s*/,l=/\s*(\.\d+|\d+(?:\.\d+)?)\s*/,c=new RegExp('^(rgb|hsl|hsv)a?\\('+f.source+','+f.source+','+f.source+'(?:,'+l.source+')?'+'\\)$','i');
h.installMethod=function(e,t){
o.forEach(function(n){
h[n].prototype[e]=t
})
},p('RGB',[
'red',
'green',
'blue',
'alpha'
],{
hex:function(){
var e=(i(255*this._red)*65536+i(255*this._green)*256+i(255*this._blue)).toString(16);
return'#'+'00000'.substr(0,6-e.length)+e
},
hexa:function(){
var e=i(this._alpha*255).toString(16);
return'#'+'00'.substr(0,2-e.length)+e+this.hex().substr(1,6)
},
css:function(){
return'rgb('+i(255*this._red)+','+i(255*this._green)+','+i(255*this._blue)+')'
},
cssa:function(){
return'rgba('+i(255*this._red)+','+i(255*this._green)+','+i(255*this._blue)+','+this._alpha+')'
}
}),typeof module!='undefined'?module.exports=h:typeof define=='function'&&!a(define.amd)?define([],function(){
return h
}):typeof jQuery!='undefined'&&a(jQuery.color)?jQuery.color=h:(one=window.one||{},one.color=h),p('HSV',[
'hue',
'saturation',
'value',
'alpha'
],{
rgb:function(){
var e=this._hue,t=this._saturation,n=this._value,i=s(5,r.floor(e*6)),o=e*6-i,u=n*(1-t),a=n*(1-o*t),f=n*(1-(1-o)*t),l,c,p;
switch(i){
case 0:
l=n,c=f,p=u;
break;
case 1:
l=a,c=n,p=u;
break;
case 2:
l=u,c=n,p=f;
break;
case 3:
l=u,c=a,p=n;
break;
case 4:
l=f,c=u,p=n;
break;
case 5:
l=n,c=u,p=a
}
return new h.RGB(l,c,p,this._alpha)
},
hsl:function(){
var e=(2-this._saturation)*this._value,t=this._saturation*this._value,n=e<=1?e:2-e,r;
return n<1e-9?r=0:r=t/n,new h.HSL(this._hue,r,e/2,this._alpha)
},
fromRgb:function(){
var e=this._red,t=this._green,n=this._blue,i=r.max(e,t,n),o=s(e,t,n),u=i-o,a,f=i===0?0:u/ i,l=i;
if(u===0)
a=0;
else
switch(i){
case e:
a=(t-n)/u/6+(t<n?1:0);
break;
case t:
a=(n-e)/u/6+1/3;
break;
case n:
a=(e-t)/u/6+2/3
}
return new h.HSV(a,f,l,this._alpha)
}
}),p('HSL',[
'hue',
'saturation',
'lightness',
'alpha'
],{
hsv:function(){
var e=this._lightness*2,t=this._saturation*(e<=1?e:2-e),n;
return e+t<1e-9?n=0:n=2*t/(e+t),new h.HSV(this._hue,n,(e+t)/2,this._alpha)
},
rgb:function(){
return this.hsv().rgb()
},
fromRgb:function(){
return this.hsv().hsl()
}
})
}(parseFloat,parseInt,Function,Math,Math.round,Math.min));
web.data.styles.FrameColor=Ext.extend(web.data.styles.Frame,{
type:'web.data.styles.FrameColor',
cssProperty:'border-color',
constructor:function(cfg){
web.data.styles.FrameColor.superclass.constructor.call(this,cfg);
this.edgeCSSProps={
top:'border-top-color',
right:'border-right-color',
bottom:'border-bottom-color',
left:'border-left-color'
}
},
set:function(opts){
if(Ext.isArray(opts)){
opts={
top:opts[0],
right:opts[1],
bottom:opts[2],
left:opts[3]
}
}
if(opts===null){
this.top=null;
this.right=null;
this.bottom=null;
this.left=null
}else if(Ext.isObject(opts)){
if(opts.top){
this.top=one.color(opts.top)
}else{
this.top=opts.top===null?null:this.top
}
if(opts.right){
this.right=one.color(opts.right)
}else{
this.right=opts.right===null?null:this.right
}
if(opts.bottom){
this.bottom=one.color(opts.bottom)
}else{
this.bottom=opts.bottom===null?null:this.bottom
}
if(opts.left){
this.left=one.color(opts.left)
}else{
this.left=opts.left===null?null:this.left
}
}
},
getEdgeCSSDeclaration:function(edge){
if(edge!=='top'&&edge!=='right'&&edge!=='bottom'&&edge!=='left'){
one.error(edge+' is not a valid side')
}
var prop=this[edge],css=this.edgeCSSProps[edge]+':',alpha;
if(prop===null||typeof prop==='undefined'){
return''
}else{
alpha=prop.isColor?prop.alpha():0;
if(alpha===0){
return css+'transparent;\n'
}else if(alpha===1){
return css+prop.css()+';\n'
}else{
return css+prop.cssa()+';\n'
}
}
},
checkEdge:function(edge){
return edge!==null
}
});
web.data.styles.FrameCorners=Ext.extend(web.data.styles.Style,{
constructor:function(config){
this.topLeft=null;
this.topRight=null;
this.bottomRight=null;
this.bottomLeft=null;
web.data.styles.FrameCorners.superclass.constructor.call(this,config)
},
set:function(opts){
var styleOpts=Ext.apply({},opts),props=[
'topLeft',
'topRight',
'bottomRight',
'bottomLeft'
],prop,value;
if(opts===null){
this.topLeft=null;
this.topRight=null;
this.bottomRight=null;
this.bottomLeft=null;
return
}
for(prop in props){
if(props.hasOwnProperty(prop)){
value=styleOpts[prop];
if(Ext.isArray()){
this[prop]=value
}else{
this[prop]=[
value,
value
]
}
delete styleOpts[prop]
}
}
web.data.styles.FrameCorners.superclass.set.call(this,styleOpts)
},
check:function(){
return true
},
toJSON:function(){
if(this.isSet()){
return{
topLeft:this.topLeft,
topRight:this.topRight,
bottomRight:this.bottomRight,
bottomLeft:this.bottomLeft
}
}else{
return null
}
},
isSet:function(){
return this.topLeft!==null||this.topRight!==null||this.bottomRight!==null||this.bottomLeft!==null
},
getCSSDeclarations:function(){
var css='',cssSection;
if(this.topLeft!==null){
cssSection='';
if(Ext.isArray(this.topLeft)){
cssSection+=this.topLeft[0]+'px '+this.topLeft[1]+'px;\n'
}else{
cssSection+=this.topLeft+'px;\n'
}
css+='border-top-left-radius:'+cssSection;
css+='-moz-border-radius-topleft:'+cssSection
}
if(this.topRight!==null){
cssSection='';
if(Ext.isArray(this.topRight)){
cssSection+=this.topRight[0]+'px '+this.topRight[1]+'px;\n'
}else{
cssSection+=this.topRight+'px;\n'
}
css+='border-top-right-radius:'+cssSection;
css+='-moz-border-radius-topright:'+cssSection
}
if(this.bottomRight!==null){
cssSection='';
if(Ext.isArray(this.bottomRight)){
cssSection+=this.bottomRight[0]+'px '+this.bottomRight[1]+'px;\n'
}else{
cssSection+=this.bottomRight+'px;\n'
}
css+='border-bottom-right-radius:'+cssSection;
css+='-moz-border-radius-bottomright:'+cssSection
}
if(this.bottomLeft!==null){
cssSection='';
if(Ext.isArray(this.bottomLeft)){
cssSection+=this.bottomLeft[0]+'px '+this.bottomLeft[1]+'px;\n'
}else{
cssSection+=this.bottomLeft+'px;\n'
}
css+='border-bottom-left-radius:'+cssSection;
css+='-moz-border-radius-bottomleft:'+cssSection
}
return css
},
append:function(cfg){
if(!cfg){
return this
}
var topLeft=cfg.topLeft!==null?cfg.topLeft:this.topLeft,topRight=cfg.topRight!==null?cfg.topRight:this.topRight,bottomRight=cfg.bottomRight!==null?cfg.bottomRight:this.bottomRight,bottomLeft=cfg.bottomLeft!==null?cfg.bottomLeft:this.bottomLeft;
return{
topLeft:topLeft,
topRight:topRight,
bottomRight:bottomRight,
bottomLeft:bottomLeft
}
}
});
web.data.styles.Border=Ext.extend(web.data.styles.Style,{
type:'web.data.styles.Border',
constructor:function(config){
this.style=new web.data.styles.FrameStyle({});
this.width=new web.data.styles.FrameWidth({});
this.color=new web.data.styles.FrameColor({});
this.corners=new web.data.styles.FrameCorners({});
web.data.styles.Border.superclass.constructor.call(this,config);
this.reset()
},
destroy:function(){
if(this.style!==null){
this.style.destroy();
delete this.style
}
if(this.width!==null){
this.width.destroy();
delete this.width
}
if(this.color!==null){
this.color.destroy();
delete this.color
}
if(this.corners!==null){
this.corners.destroy();
delete this.corners
}
web.data.styles.Border.superclass.destroy.call(this)
},
set:function(opts){
var borderOpts=Ext.apply({},opts);
if(opts===null){
this.reset();
return
}
if(borderOpts.style!==undefined){
this.style.set(borderOpts.style);
delete borderOpts.style
}
if(borderOpts.width!==undefined){
this.width.set(borderOpts.width);
delete borderOpts.width
}
if(borderOpts.color!==undefined){
this.color.set(borderOpts.color);
delete borderOpts.color
}
if(borderOpts.corners!==undefined){
this.corners.set(borderOpts.corners);
delete borderOpts.corners
}
web.data.styles.Border.superclass.set.call(this,borderOpts)
},
getCSSDeclarations:function(doc){
return this.width.getCSSDeclarations()+this.style.getCSSDeclarations()+this.color.getCSSDeclarations()+this.corners.getCSSDeclarations()
},
toJSON:function(){
var obj=null,objStyle=this.style.toJSON(),objWidth=this.width.toJSON(),objColor=this.color.toJSON(),objCorners=this.corners.toJSON();
if(objStyle||objWidth||objColor||objCorners){
obj={
style:null,
width:null,
color:null,
corners:null
};
if(objStyle){
obj.style=objStyle
}
if(objWidth){
obj.width=objWidth
}
if(objColor){
obj.color=objColor
}
if(objCorners){
obj.corners=objCorners
}
}
return obj
},
check:function(){
if(!web.data.styles.Border.superclass.check.call(this)){
return false
}
if(!(this.style instanceof web.data.styles.FrameStyle)){
return false
}
if(!this.style.check()){
return false
}
if(!(this.width instanceof web.data.styles.FrameWidth)){
return false
}
if(!this.width.check()){
return false
}
if(!(this.color instanceof web.data.styles.FrameColor)){
return false
}
if(!this.color.check()){
return false
}
if(!this.corners.check()){
return false
}
return true
},
reset:function(){
this.color=new web.data.styles.FrameColor({});
this.style=new web.data.styles.FrameStyle({});
this.corners=new web.data.styles.FrameCorners({});
this.width=new web.data.styles.FrameWidth({
edgeCSSProps:{
top:'border-top-width',
right:'border-right-width',
bottom:'border-bottom-width',
left:'border-left-width'
}
})
},
getStyle:function(){
return this.style
},
getWidth:function(){
return this.width
},
getColor:function(){
return this.color
},
getCorners:function(){
return this.corners
},
append:function(cfg){
if(!cfg){
return this
}
var color=this.color.append(cfg.getColor()),style=this.style.append(cfg.getStyle()),width=this.width.append(cfg.getWidth()),corners=this.corners.append(cfg.getCorners());
return{
id:this.id,
cssProperty:this.cssProperty,
color:color,
style:style,
width:width,
corners:corners
}
}
});
web.data.styles.Gradient=Ext.extend(web.data.styles.Style,{
constructor:function(config){
this.gradType=null;
this.origin=null;
this.ellipse=true;
this.size='farthest-corner';
this.stops=[];
web.data.styles.Gradient.superclass.constructor.call(this,config)
},
set:function(opts){
var newOpts=Ext.apply({},opts);
if(opts.stops){
this.stops=[];
opts.stops.forEach(function(stop){
this.stops.push([
one.color(stop[0]).toJSON(),
stop[1]
])
},this);
delete newOpts.stops
}
web.data.styles.Gradient.superclass.set.call(this,newOpts)
},
toCSS:function(){
var gradCss='',radialCss='',css='',i,colorStop,color,colorFirstCss,colorLastCss,origin=this.origin;
if(this.gradType==='linear'){
gradCss+='linear-gradient('
}else if(this.gradType==='radial'){
gradCss+='radial-gradient(';
radialCss+=this.ellipse?'ellipse ':'circle ';
radialCss+=this.size+','
}else{
return''
}
gradCss+=origin+',';
gradCss+=radialCss;
for(i=0;colorStop=this.stops[i];i+=1){
color=one.color(colorStop[0]);
if(!i){
colorFirstCss=color.hex()
}
gradCss+=color.cssa()+' '+colorStop[1]+','
}
colorLastCss=color.hex();
gradCss=gradCss.slice(0,gradCss.length-1);
css+='filter:progid:DXImageTransform.Microsoft.gradient(startColorstr=\''+colorFirstCss+'\', endColorstr=\''+colorLastCss+'\',GradientType='+(origin==='left'?1:0)+');';
css+='background-image:-moz-'+gradCss+');\n'+'background-image:-webkit-'+gradCss+');\n'+'background-image:-ms-'+gradCss+');\n'+'background-image:-o-'+gradCss+');\n'+'background-image:'+gradCss+');\n';
if(this.size==='farthest-corner'&&this.origin==='left'){
css+='background-size:cover;\n'
}
return css
},
toJSON:function(){
if(this.gradType!=='linear'&&this.gradType!=='radial'){
return null
}else{
return{
type:'web.data.styles.Gradient',
gradType:this.gradType,
origin:this.origin,
ellipse:this.ellipse,
size:this.size,
stops:this.getStops()
}
}
},
getStops:function(){
var stops=[];
this.stops.forEach(function(stop){
stops.push([
one.color(stop[0]).toJSON(),
stop[1]
])
},this);
return stops
}
});
Ext.ns('web.data.assets');
web.data.assets.Asset=Ext.extend(web.data.Part,{
constructor:function(cfg){
this.url='';
this.contentType='';
this.etag=null;
this.filesize=0;
web.data.assets.Asset.superclass.constructor.call(this,cfg)
},
getURL:function(){
return this.url
},
getRelativeUrl:function(baseUrl){
var origin=this.url.match(/^(webspace|repository)\:\/(.*)$/);
if(origin){
if(origin[1]==='webspace'){
return baseUrl+'/webspace/'+origin[2]
}
return'/api/v1/repository/webspace/'+origin[2]
}
return''
},
getFilename:function(){
var filename=this.url.match(/\/([^\/]+$)/);
if(filename){
return filename[1]
}
return this.url
},
getContentType:function(){
return this.contentType
},
getOriginalUrl:function(){
return this.originalUrl
},
getETag:function(){
return this.etag
},
isDocument:function(){
return false
},
toJSON:function(){
var obj=web.data.assets.Asset.superclass.toJSON.call(this);
obj.url=this.url;
obj.contentType=this.contentType;
obj.filesize=this.filesize;
return obj
}
});
web.data.assets.Image=Ext.extend(web.data.assets.Asset,{
type:'web.data.assets.Image',
constructor:function(json){
this.width=0;
this.height=0;
this.alpha=null;
this.bpp=null;
this.animated=false;
this.recommendedFormat=null;
web.data.assets.Image.superclass.constructor.call(this,json)
},
getWidth:function(){
return this.width
},
getHeight:function(){
return this.height
},
isAnimated:function(){
return this.animated
},
toJSON:function(){
var obj=web.data.assets.Image.superclass.toJSON.call(this);
obj.alpha=this.alpha;
obj.bpp=this.bpp;
obj.width=this.width;
obj.height=this.height;
obj.animated=this.animated;
obj.recommendedFormat=this.recommendedFormat;
return obj
}
});
web.Constants={
imageMaxDimension:16384,
imageScaleMaxPixels:64039360,
imagePixelRatios:[
1,
2,
3,
4
]
};
web.utils.ImageSize={
applyRange:function(w,h){
var maxPixels=web.Constants.imageScaleMaxPixels,newScale;
if(w*h>maxPixels){
newScale=maxPixels/(w*h);
w=w*newScale;
h=h*newScale
}
var maxSide=web.Constants.imageMaxDimension;
w=Math.min(maxSide-1,Math.max(1,w));
h=Math.min(maxSide-1,Math.max(1,h));
return{
w:Math.floor(w),
h:Math.floor(h)
}
},
getReduceFactor:function(w,h,maxW,maxH){
var maxPixels=web.Constants.imageScaleMaxPixels,maxSide=web.Constants.imageMaxDimension-1,newScale=1;
if(w*h>maxPixels){
newScale=maxPixels/(w*h)
}
if(maxW&&w>maxW){
newScale=Math.min(newScale,maxW/w)
}
if(maxH&&h>maxH){
newScale=Math.min(newScale,maxH/h)
}
if(w>maxSide){
newScale=Math.min(newScale,maxSide/w)
}
if(h>maxSide){
newScale=Math.min(newScale,maxSide/h)
}
return newScale
}
};
web.data.styles.Background=Ext.extend(web.data.styles.Style,{
type:'web.data.styles.Background',
constructor:function(config){
this.color=null;
this.gradient=null;
this.asset=null;
this.repeat=null;
this.position=null;
this.size=null;
this.fixed=false;
web.data.styles.Background.superclass.constructor.call(this,config)
},
destroy:function(){
this.color=null;
this.gradient=null;
if(this.asset){
this.asset.destroy()
}
this.asset=null;
this.repeat=null;
this.position=null;
this.fixed=null;
web.data.styles.Background.superclass.destroy.call(this)
},
set:function(opts){
var nj=Ext.apply({},opts),assetCfg;
if(opts===null){
this.color=null;
this.gradient=null;
this.asset=null;
this.repeat=null;
this.position=null;
this.size=null;
this.fixed=null;
return
}
if(nj.color){
this.color=one.color(opts.color);
delete nj.color
}
if(nj.gradient){
this.gradient=new web.data.styles.Gradient(nj.gradient);
delete nj.gradient
}
if(nj.asset){
assetCfg=nj.asset;
delete nj.asset
}
if(nj.repeat){
this.repeat=[
opts.repeat[0],
opts.repeat[1]
];
delete nj.repeat
}
if(nj.position){
this.position=[
opts.position[0],
opts.position[1]
];
delete nj.position
}
if(nj.size){
this.size=opts.size;
delete nj.size
}
if('fixed'in nj){
this.fixed=nj.fixed;
delete nj.fixed
}
web.data.styles.Background.superclass.set.call(this,nj);
if(assetCfg){
if(assetCfg instanceof web.data.assets.Image){
assetCfg=assetCfg.toJSON();
assetCfg.id=Math.uuid()
}
if(this.dm){
this.asset=this.dm.create(Ext.applyIf({
parent:this,
type:'web.data.assets.Image'
},assetCfg))
}else{
this.asset=new web.data.assets.Image(Ext.applyIf({parent:this},assetCfg))
}
}
},
getURL:function(doc){
var asset=this.asset,url=asset.getRelativeUrl(doc.getAssetURL()),etag=asset.getETag();
if(etag){
url+='?etag='+encodeURIComponent(etag)
}else{
url+='?'
}
url=url.replace(/'/g,'%27').replace(/\(/g,'%28').replace(/\)/g,'%29');
return url
},
getCSSRulesForHD:function(doc,selector){
var css='',url,w,h,reduceFactor;
web.Constants.imagePixelRatios.forEach(function(pixelRatio){
if(this.asset&&doc){
if(Ext.isNumber(this.size)&&this.size!==100){
w=this.asset.getWidth()*pixelRatio*this.size/100;
h=this.asset.getHeight()*pixelRatio*this.size/100;
reduceFactor=web.utils.ImageSize.getReduceFactor(w,h,this.asset.getWidth(),this.asset.getHeight());
w=Math.round(w*reduceFactor);
h=Math.round(h*reduceFactor);
url=this.getURL(doc)+'&ignoreAspectRatio&resize='+w+','+h;
if(pixelRatio>1){
css+='@media (-webkit-min-device-pixel-ratio:'+pixelRatio+'),(min-resolution:'+pixelRatio+'dppx),(min-resolution:'+pixelRatio*96+'dpi) {\n'
}
css+=selector+' {\n'+'background-image:url("'+url+'");\n'+'}\n';
if(pixelRatio>1){
css+='}\n'
}
}
}
},this);
return css
},
getCSSDeclarations:function(doc){
var css='',r,rx,ry,px,py,alpha,bgOps='',reduceFactor,w,h,that=this;
if(this.color){
alpha=this.color.alpha();
if(alpha===0){
css+='background-color:transparent'
}else if(alpha===1){
css+='background-color:'+this.color.css()
}else{
css+='background-color:'+this.color.css()+';background-color:'+this.color.cssa()
}
css+=';\n'
}
if(this.asset&&doc){
w=this.asset.getWidth();
h=this.asset.getHeight();
if(this.size==='fit'){
css+='background-size:contain;\n'
}else if(this.size==='fill'){
css+='background-size:cover;\n'
}else if(Ext.isNumber(this.size)){
if(this.size!==100){
w=w*this.size/100;
h=h*this.size/100;
reduceFactor=web.utils.ImageSize.getReduceFactor(w,h);
w=Math.round(w*reduceFactor);
h=Math.round(h*reduceFactor);
css+='background-size:'+w+'px '+h+'px;\n';
bgOps='&ignoreAspectRatio&resize='+w+','+h
}
}
css+='background-image:url("'+this.getURL(doc)+bgOps+'");\n';
if(Ext.isArray(this.repeat)){
r='repeat';
rx=this.repeat[0];
ry=this.repeat[1];
css+='background-repeat:'+(rx?ry?r:r+'-x':ry?r+'-y':'no-'+r)+';\n'
}
if(Ext.isArray(this.position)){
px=this.position[0];
py=this.position[1];
(function(){
var off={
x:315,
y:108
};
if(doc.editMode&&that.parent.name==='[body]'&&that.fixed){
if(px==='0%'){
px=off.x+'px'
}
if(px==='50%'){
px='calc(50% + '+(off.x/2-(Ext.getScrollBarWidth()-2)/2)+'px)'
}
if(py==='0%'){
py=off.y+'px'
}
if(py==='50%'){
if(Ext.isNumber(that.size)){
py='calc(50% + '+off.y/2+'px)'
}else{
if(window.outerHeight/window.outerWidth>that.asset.height/that.asset.width){
if(that.size==='fill'){
py='calc(50% + '+off.y+'px)'
}else{
py='calc(50% + '+off.y/2+'px)'
}
}else{
if(that.size==='fill'){
py='calc(50% + '+off.y/2+'px)'
}else{
py='calc(50% + '+off.y+'px)'
}
}
}
}
}
}());
css+='background-position:';
css+=px+(isNaN(px)?'':'px')+' ';
css+=py+(isNaN(py)?'':'px')+';\n'
}
if(this.fixed){
css+='background-attachment: fixed;\n'
}else{
css+='background-attachment: scroll;\n'
}
}else if(this.gradient){
css+=this.gradient.toCSS()
}else if(this.color){
css+='background-image:none;'
}
if(!this.gradient&&(this.color||this.asset&&doc)){
css+='filter:progid:DXImageTransform.Microsoft.gradient(enabled=false);'
}
css+='background-clip: padding-box;\n';
return css
},
toJSON:function(){
var obj=null;
if(this.color||this.asset||this.gradient){
obj={
color:null,
asset:null,
gradient:null
}
}
if(this.color){
obj.color=this.color.rgb().toJSON()
}
if(this.gradient){
obj.gradient=this.gradient.toJSON()
}
if(this.asset){
obj.asset=this.asset.toJSON();
if(this.repeat){
obj.repeat=this.repeat
}
if(this.position){
obj.position=this.position
}
if(this.size){
obj.size=this.size
}
if(typeof this.fixed==='boolean'){
obj.fixed=this.fixed
}
}
return obj
},
check:function(){
if(!web.data.styles.Background.superclass.check.call(this)){
return false
}
if(this.color&&!this.color.isColor){
return false
}
if(this.gradient&&!this.gradient.check()){
return false
}
if(this.imageId!==null&&!Ext.isString(this.imageId)){
return true
}
if(this.repeat!==null){
if(!Ext.isArray(this.repeat)||this.repeat.length!==2){
return false
}
if(this.repeat[0]!==null&&!Ext.isBoolean(this.repeat[0])||this.repeat[1]!==null&&!Ext.isBoolean(this.repeat[1])){
return false
}
}
if(!this.checkPosition()){
return false
}
if(this.size){
if(!(this.size===null||this.size==='fit'||this.size==='fill'||Ext.isNumber(this.size))){
return false
}
}
return true
},
checkPosition:function(){
var i,position,lastIndex;
if(this.position===null){
return true
}
if(!Ext.isArray(this.position)||this.position.length!==2){
return false
}
for(i=0;i<2;i+=1){
position=this.position[i];
lastIndex=position.length-1;
if(position!==null&&isNaN(position)&&(typeof position!=='string'||position.substr(lastIndex)!=='%'||isNaN(parseInt(position.substr(0,lastIndex),10)))){
return false
}
}
return true
},
getColor:function(){
return this.color
},
getGradient:function(){
return this.gradient
},
getAsset:function(){
return this.asset
},
getRepeat:function(){
return this.repeat
},
getPosition:function(){
return this.position
},
getFixed:function(){
return this.fixed
},
append:function(cfg){
if(!cfg){
return this
}
var color=cfg.getColor()?cfg.getColor():this.color,gradient=cfg.getGradient()?cfg.getGradient():this.gradient,imageId=cfg.getImageId()?cfg.getImageId():this.imageId,repeat=cfg.getRepeat()?cfg.getRepeat():this.repeat,position=cfg.getPosition()?cfg.getPosition():this.position,fixed=cfg.getFixed()!==null?cfg.getFixed():this.fixed;
return{
cssProperty:this.cssProperty,
color:color,
gradient:gradient,
imageId:imageId,
position:position,
repeat:repeat,
fixed:fixed
}
},
getAssets:function(){
var asset=this.getAsset();
return asset?[asset]:[]
}
});
web.data.styles.Shadow=Ext.extend(web.data.styles.Style,{
property:'shadow',
constructor:function(config){
this.left=1;
this.top=1;
this.blur=1;
this.color=null;
web.data.styles.Shadow.superclass.constructor.call(this,config)
},
set:function(options){
var opts=Ext.apply({},options);
if(opts.blur!==undefined){
this.blur=Math.min(opts.blur,web.data.styles.Shadow.MAXBLUR);
delete opts.blur
}
if(opts.color===null){
this.color=null;
delete opts.color
}else if(opts.color!==undefined){
this.color=one.color(opts.color);
delete opts.color
}
web.data.styles.Shadow.superclass.set.call(this,opts)
},
getCSSDeclarations:function(doc){
if(this.left===null||this.top===null||this.radius===null||this.color===null){
return''
}else{
var css;
if(!this.isVisible()){
css=this.property+':none;\n';
if(this.property==='box-shadow'){
css+='-moz-'+this.property+':none;\n'
}
return css
}
css=this.property+':'+this.left+'px '+this.top+'px '+this.blur+'px '+this.color.cssa()+';\n';
if(this.property==='text-shadow'){
css+=this.property+':'+this.left+'px '+this.top+'px '+this.blur+'px 0.01px '+this.color.cssa()+';\n'
}
if(this.property==='box-shadow'){
css+='-moz-'+this.property+':'+this.left+'px '+this.top+'px '+this.blur+'px '+this.color.cssa()+';\n'
}
return css
}
},
getSpecificJSON:function(){
var obj={};
if(this.left!==null){
obj.left=this.left
}
if(this.top!==null){
obj.top=this.top
}
if(this.blur!==null){
obj.blur=this.blur
}
if(this.color){
obj.color=this.color.toJSON()
}
return obj
},
getLeft:function(){
return this.left
},
getTop:function(){
return this.top
},
getBlurRadius:function(){
return this.blur
},
getSpreadRadius:function(){
return this.spread
},
getColor:function(){
return this.color
},
isVisible:function(){
return this.color&&this.color.isColor?!!this.color.alpha():false
},
isSet:function(){
return this.left!==null&&this.top!==null&&this.radius!==null&&this.color!==null
},
isEqual:function(shadow){
if(shadow===undefined){
return false
}
if(shadow===null||!shadow.isSet()){
return!this.isSet()
}
return this.left===shadow.left&&this.top===shadow.top&&this.radius===shadow.radius&&this.color.hexa()===shadow.color.hexa()
}
});
web.data.styles.Shadow.MAXBLUR=50;
web.data.styles.BoxShadow=Ext.extend(web.data.styles.Shadow,{
type:'web.data.styles.BoxShadow',
property:'box-shadow',
constructor:function(cfg){
this.spread=null;
web.data.styles.BoxShadow.superclass.constructor.call(this,cfg)
}
});
web.data.styles.StyleBlock=Ext.extend(web.data.styles.Style,{
type:'web.data.styles.StyleBlock',
constructor:function(config){
this.background=new web.data.styles.Background({parent:this});
this.border=new web.data.styles.Border({parent:this});
this.padding=new web.data.styles.FrameWidth({
edgeCSSProps:{
top:'padding-top',
right:'padding-right',
bottom:'padding-bottom',
left:'padding-left'
},
parent:this
});
this.shadow=new web.data.styles.BoxShadow({parent:this});
web.data.styles.StyleBlock.superclass.constructor.call(this,config);
this.clsPfx='block'
},
destroy:function(){
web.data.styles.StyleBlock.superclass.destroy.call(this);
if(this.border&&this.border.destroy){
this.border.destroy();
this.border=null
}
if(this.background&&this.background.destroy){
this.background.destroy();
this.background=null
}
if(this.padding&&this.padding.destroy){
this.padding.destroy();
this.padding=null
}
if(this.shadow&&this.shadow.destroy){
this.shadow.destroy();
this.shadow=null
}
},
set:function(options){
if(!options){
return
}
var opts=Ext.apply({},options),bgOpts;
if(opts.background!==undefined){
bgOpts=opts.background;
delete opts.background
}
if(opts.border!==undefined){
this.border.set(opts.border);
delete opts.border
}
if(opts.padding!==undefined){
this.padding.set(opts.padding);
delete opts.padding
}
if(opts.shadow!==undefined){
this.shadow.set(opts.shadow);
delete opts.shadow
}
web.data.styles.StyleBlock.superclass.set.call(this,opts);
if(bgOpts!==undefined){
if(!this.background.dm){
this.dm.create(Ext.applyIf({dm:this.dm},this.background))
}
this.background.set(bgOpts)
}
},
getCSSRulesForHD:function(doc,selector){
var css=this.background.getCSSRulesForHD(doc,selector);
return css
},
getCSSDeclarations:function(doc){
var css=this.border.getCSSDeclarations(doc)+this.background.getCSSDeclarations(doc)+this.padding.getCSSDeclarations(doc)+this.shadow.getCSSDeclarations(doc);
return css
},
toJSON:function(){
var obj=web.data.styles.StyleBlock.superclass.toJSON.call(this),objBorder=this.border.toJSON(),objBackground=this.background.toJSON(),objPadding=this.padding.toJSON();
obj.border=objBorder;
obj.background=objBackground;
obj.padding=objPadding;
return obj
},
check:function(){
if(!web.data.styles.StyleBlock.superclass.check.call(this)){
return false
}
if(!(this.border instanceof web.data.styles.Border)){
return false
}
if(!this.border.check()){
return false
}
if(!(this.background instanceof web.data.styles.Background)){
return false
}
if(!this.background.check()){
return false
}
if(!(this.padding instanceof web.data.styles.FrameWidth)){
return false
}
if(!this.padding.check()){
return false
}
if(!(this.shadow instanceof web.data.styles.BoxShadow)||!this.padding.check()){
return false
}
return true
},
initDefaultStyles:function(){
this.set({
padding:[
0,
0,
0,
0
],
background:{
color:null,
imageId:null,
repeat:[
true,
true
],
position:[
0,
0
]
},
border:{
color:[
new one.color.RGB(0,0,0,1),
new one.color.RGB(0,0,0,1),
new one.color.RGB(0,0,0,1),
new one.color.RGB(0,0,0,1)
],
width:[
0,
0,
0,
0
],
style:[
'solid',
'solid',
'solid',
'solid'
]
}
})
},
getBorder:function(){
return this.border
},
getBackground:function(){
return this.background
},
getPadding:function(){
return this.padding
},
getShadow:function(){
return this.shadow
},
getFrameWidth:function(sides){
var width=0,padding=this.padding,border=this.border.width;
if(sides.indexOf('t')!==-1){
width+=padding.getTop()+(border?border.getTop():0)
}
if(sides.indexOf('r')!==-1){
width+=padding.getRight()+(border?border.getRight():0)
}
if(sides.indexOf('b')!==-1){
width+=padding.getBottom()+(border?border.getBottom():0)
}
if(sides.indexOf('l')!==-1){
width+=padding.getLeft()+(border?border.getLeft():0)
}
return width
},
append:function(cfg){
if(!cfg){
return this
}
var background=this.background.append(cfg.getBackground()),border=this.border.append(cfg.getBorder()),padding=this.padding.append(cfg.getPadding());
return{
id:this.id,
cssProperty:this.cssProperty,
background:background,
border:border,
padding:padding
}
},
getAssets:function(){
var background=this.getBackground();
return background?background.getAssets():[]
}
});
web.data.styles.StyleBlock.names=[
'body',
'main',
'content',
'decorator',
'special',
'horizontal',
'vertical',
'heading',
'divider'
];
web.data.styles.Font=Ext.extend(web.data.styles.Style,{
type:'web.data.styles.Font',
cssProperty:'font-family',
constructor:function(config){
config=Ext.apply({},config);
this.fontType=null;
if(!web.data.styles.Font.extData){
web.data.styles.Font.extData=function(){
var fonts=[],fontTypes=web.data.styles.Font.types,fontCssValues=web.data.styles.Font.cssValues,font,id,css;
for(font in fontTypes){
if(fontTypes.hasOwnProperty(font)){
id=fontTypes[font];
css=fontCssValues[id];
fonts.push([
id,
css.replace(/"/g,'\''),
web.data.styles.Font.displayNameByType[font]
])
}
}
return fonts
}()
}
if(config.fontType===undefined){
config.fontType=web.data.styles.Font.types.helvetica
}
web.data.styles.Font.superclass.constructor.call(this,config)
},
destroy:function(){
delete this.fontType
},
set:function(opts){
if(Ext.isNumber(opts)){
this.fontType=opts
}else if(Ext.isObject(opts)){
Ext.apply(this,opts)
}else{
throw'Unrecognized font setting ('+opts+').'
}
},
isEqual:function(o){
return Ext.isObject(o)&&this.fontType===o.fontType
},
check:function(){
return web.data.styles.Font.isType(this.fontType)||this.fontType===null||/^google:\/\//.test(this.fontType)
},
getCSSValue:function(doc){
var values=web.data.styles.Font.cssValues,html,family,variantsCheat='100,100italic,200,200italic,300,300italic,500,500italic,600,600italic,700,700italic,800,800italic,900,900italic,italic,regular';
if(this.fontType!==null&&values[this.fontType]){
return values[this.fontType]
}else if(this.fontType!==null&&/^google:\/\//.test(this.fontType)){
if(doc){
family=this.fontType.replace(/^google:\/\//,'')+':'+variantsCheat;
html='<link href=\''+Ext.util.Format.htmlEncode('//fonts.googleapis.com/css?family='+encodeURIComponent(family))+'&subset=all\' rel=\'stylesheet\' type=\'text/css\'>\n';
doc.appendToHead(html,true)
}
return'"'+this.fontType.replace(/^google:\/\//,'')+'"'
}else{
if(this.fontType){
one.fatal('Custom - Unable to get CSS value for font (family) due to invalid fontType value.')
}
return''
}
},
toJSON:function(){
if(this.fontType===null){
return{}
}else{
return this.fontType
}
},
getFontType:function(){
return this.fontType
}
});
web.data.styles.Font.types={
arial:0,
arialBlack:1,
comicSansMS:2,
courier:3,
courierNew:4,
georgia:5,
helvetica:6,
impact:7,
lucidaConsole:8,
lucidaSansConsole:9,
palatinoLinotype:10,
tahoma:11,
timesNewRoman:12,
trebuchetMS:13,
verdana:14,
msSansSerif:15,
msSerif:16
};
web.data.styles.Font.cssValues=[
'Arial,Helvetica,sans-serif',
'"Arial Black",Gadget,sans-serif',
'"Comic Sans MS",cursive',
'Courier,monospace',
'"Courier New",Courier,monospace',
'Georgia,Georgia,serif',
'Helvetica,sans-serif',
'Impact,Charcoal,sans-serif',
'"Lucida Console",Monaco,monospace',
'"Lucida Sans Unicode","Lucida Grande",sans-serif',
'"Palatino Linotype","Book Antiqua",Palatino,serif',
'Tahoma,Geneva,sans-serif',
'"Times New Roman",Times,serif',
'"Trebuchet MS",Helvetica,sans-serif',
'Verdana,Geneva,sans-serif',
'"MS Sans Serif",Geneva,sans-serif',
'"MS Serif","New York",serif'
];
web.data.styles.Font.displayNameByType={
arial:'Arial',
arialBlack:'Arial Black',
comicSansMS:'Comic Sans MS',
courier:'Courier',
courierNew:'Courier New',
georgia:'Georgia',
helvetica:'Helvetica',
impact:'Impact',
lucidaConsole:'Lucida Console',
lucidaSansConsole:'Lucida Sans Console',
palatinoLinotype:'Palatino Linotype',
tahoma:'Tahoma',
timesNewRoman:'Times New Roman',
trebuchetMS:'Trebuchet MS',
verdana:'Verdana',
msSansSerif:'Sans Serif MS',
msSerif:'Serif MS'
};
web.data.styles.Font.isType=function(n){
if(isNaN(n)){
return false
}
for(var nm in web.data.styles.Font.types){
if(web.data.styles.Font.types[nm]===n){
return true
}
}
return false
};
web.data.styles.TextShadow=Ext.extend(web.data.styles.Shadow,{
type:'web.data.styles.TextShadow',
property:'text-shadow',
constructor:function(config){
if(!config.color){
config.color=new one.color.RGB(0.5,0.5,0.5)
}
web.data.styles.TextShadow.superclass.constructor.call(this,config)
}
});
web.data.styles.StyleText=Ext.extend(web.data.styles.Style,{
type:'web.data.styles.StyleText',
font:null,
size:null,
bold:null,
italic:null,
underline:null,
color:null,
highlight:null,
shadow:null,
subscript:null,
superscript:null,
transform:null,
letterspacing:null,
constructor:function(config){
this.font=null;
this.size=null;
this.bold=null;
this.italic=null;
this.underline=null;
this.color=null;
this.highlight=null;
this.shadow=null;
this.subscript=null;
this.superscript=null;
this.transform=null;
web.data.styles.StyleText.superclass.constructor.call(this,config);
if(this.inStylesheet()){
if(!this.color){
this.color=one.color.RGB(0,0,0)
}
}
this.clsPfx='text';
this.commonCls='textnormal'
},
destroy:function(){
web.data.styles.StyleText.superclass.destroy.call(this);
if(this.font!==null){
this.font.destroy()
}
if(this.shadow){
this.shadow.destroy()
}
delete this.font;
delete this.size;
delete this.bold;
delete this.italic;
delete this.underline;
delete this.color;
delete this.highlight;
delete this.shadow;
delete this.subscript;
delete this.superscript;
delete this.transform
},
set:function(opts){
var styleOpts=Ext.apply({},opts);
if(opts===null){
this.font=null;
this.color=null;
this.highlight=null;
this.size=null;
this.shadow=null;
return
}
if(!isNaN(styleOpts.font)){
if(styleOpts.font!==null){
this.font=new web.data.styles.Font({fontType:styleOpts.font})
}else{
this.font=null
}
delete styleOpts.font
}else if(typeof styleOpts.font==='string'){
if(styleOpts.font!==null){
this.font=new web.data.styles.Font({fontType:styleOpts.font})
}else{
this.font=null
}
delete styleOpts.font
}
if(styleOpts.subscript&&this.superscript){
this.superscript=false
}
if(styleOpts.superscript&&this.subscript){
this.subscript=false
}
if(styleOpts.color){
this.color=one.color(styleOpts.color);
delete styleOpts.color
}
if(styleOpts.highlight){
this.highlight=one.color(styleOpts.highlight);
delete styleOpts.highlight
}
if(Ext.isDefined(styleOpts.shadow)){
if(styleOpts.shadow){
if(this.shadow){
this.shadow.set(styleOpts.shadow)
}else{
this.shadow=new web.data.styles.TextShadow(styleOpts.shadow)
}
}else if(styleOpts.shadow===null||styleOpts.shadow===false){
this.shadow=styleOpts.shadow
}
delete styleOpts.shadow
}
web.data.styles.StyleText.superclass.set.call(this,styleOpts)
},
toCSS:function(doc){
var css=web.data.styles.StyleText.superclass.toCSS.apply(this,Array.prototype.slice.call(arguments,0)),cls=web.data.styles.StyleText.superclass.getCSSSelector.call(this,doc);
if(cls&&this.ref==='normal'){
var tags=[
'p',
'h1',
'h2',
'h3',
'h4',
'h5',
'h6'
];
tags.forEach(function(tag){
css+=cls+' '+tag+', '
});
css=css.slice(0,-2)+' {\n'+'font-size: 1px;\n'+'}\n'
}
return css
},
getCSSSelector:function(doc){
var cls=web.data.styles.StyleText.superclass.getCSSSelector.call(this);
if(!cls||!this.inStylesheet()){
return''
}
var docPrefix=doc&&doc.classPrefix?'.'+doc.classPrefix+' ':'';
if(cls&&this.ref==='normal'){
cls=docPrefix+cls;
cls=cls+' p > *, '+cls+' ol, '+cls+' ul, '+cls+' li > *'
}else{
cls=docPrefix+'.'+this.commonCls+' '+cls
}
return cls
},
getCSSDeclarations:function(doc){
var css='',alpha,isGlobal=this.inStylesheet(),italic=this.italic,bold=this.bold,size=this.size,font=this.font,shadow=this.shadow,underline=this.underline,color=this.color,highlight=this.highlight,subscript=this.subscript,superscript=this.superscript,transform=this.transform,letterspacing=this.letterspacing;
if(subscript||superscript){
size=size?Math.round(size*0.6):null;
bold=true;
css+=size===null?'font-size:0.6em;\n':'';
css+='font-weight:bold;\n';
css+='vertical-align:'+(subscript?'sub;\n':'super;\n')
}
css+=font?'font-family:'+font.getCSSValue(doc)+',"One Open Sans", "Helvetica Neue", Helvetica, sans-serif;\n':'';
css+=size===null?'':'font-size:'+size+'px;\n';
css+=bold===null&&!isGlobal?'':'font-weight:'+(bold?'bold;\n':'normal;\n');
css+=italic===null&&!isGlobal?'':'font-style:'+(italic?'italic;\n':'normal;\n');
css+=underline===null&&!isGlobal?'':'text-decoration:'+(underline?'underline;\n':'none;\n');
css+=shadow?shadow.getCSSDeclarations():isGlobal||shadow===false?'text-shadow:none;\n':'';
css+=transform?'text-transform:'+transform+';\n':'';
if(letterspacing!==null){
css+='letter-spacing:'+(letterspacing===0?'normal':letterspacing/10+'em')+';\n'
}
if(color){
alpha=color.alpha();
if(alpha===0){
css+='color:transparent;\n'
}else if(alpha===1){
css+='color:'+color.css()+';\n'
}else{
css+='color:'+color.cssa()+'!important;\n';
css+='color:'+color.css()+';\n'
}
}
if(highlight){
alpha=highlight.alpha;
if(alpha===0){
css+='background-color:transparent;\n'
}else if(alpha===1){
css+='background-color:'+highlight.css()+';\n'
}else{
css+='background-color:'+highlight.cssa()+'!important;\n';
css+='background-color:'+highlight.css()+';\n'
}
}
return css
},
toJSON:function(){
var json=web.data.styles.StyleText.superclass.toJSON.call(this);
return Ext.apply(json,this.getSpecificJSON())
},
initDefaultStyles:function(){
this.set({
font:new web.data.styles.Font,
size:12,
color:new one.color.RGB(0,0,0)
})
},
getSpecificJSON:function(){
var json={};
if(this.font){
json.font=this.font.toJSON()
}
json.size=this.size;
if(this.bold!==null){
json.bold=this.bold
}
if(this.italic!==null){
json.italic=this.italic
}
if(this.underline!==null){
json.underline=this.underline
}
if(this.color){
json.color=this.color.toJSON()
}
if(this.highlight){
json.highlight=this.highlight.toJSON()
}
if(this.shadow){
json.shadow=this.shadow.toJSON()
}else if(this.shadow===false){
json.shadow=false
}
if(this.subscript!==null){
json.subscript=this.subscript
}
if(this.superscript!==null){
json.superscript=this.superscript
}
if(this.transform!==null){
json.transform=this.transform
}
if(this.letterspacing!==null){
json.letterspacing=this.letterspacing
}
return json
},
isEqual:function(o){
return(this.font===o.font||Ext.isObject(this.font)&&Ext.isObject(o.font)&&this.font.isEqual(o.font))&&this.size===o.size&&this.bold===o.bold&&this.italic===o.italic&&this.underline===o.underline&&(this.color===o.color||this.color&&o.color&&this.color.hexa()===o.color.hexa())&&(this.highlight===o.highlight||this.highlight&&o.highlight&&this.highlight.hexa()===o.highlight.hexa())&&(this.shadow===o.shadow||this.shadow&&o.shadow&&this.shadow.isEqual(o.shadow))&&this.subscript===o.subscript&&this.superscript===o.superscript&&this.transform===o.transform&&this.letterspacing===o.letterspacing
},
check:function(){
if(!web.data.styles.StyleText.superclass.check.call(this)){
one.debug('StyleText superclass not ok');
return false
}
if(this.font&&!this.font.check()){
one.debug('StyleText font not ok');
return false
}
if(this.size!==null&&(isNaN(this.size)||this.size<=0)){
one.debug('StyleText size not ok');
return false
}
if(this.bold!==null&&!Ext.isBoolean(this.bold)){
one.debug('StyleText bold not ok');
return false
}
if(this.italic!==null&&!Ext.isBoolean(this.italic)){
one.debug('StyleText italic not ok');
return false
}
if(this.underline!==null&&!Ext.isBoolean(this.underline)){
one.debug('StyleText underline not ok');
return false
}
if(this.subscript!==null&&!Ext.isBoolean(this.subscript)){
one.debug('StyleText subscript not ok');
return false
}
if(this.superscript!==null&&!Ext.isBoolean(this.superscript)){
one.debug('StyleText superscript not ok');
return false
}
if(this.subscript&&this.superscript){
one.debug('StyleText subscript and superscript not ok');
return false
}
if(this.letterspacing!==null&&!Ext.isNumber(this.letterspacing)){
one.debug('StyleText letterspacing not ok');
return false
}
return true
},
getFont:function(){
return this.font
},
getSize:function(){
return this.size
},
isBold:function(){
return this.bold
},
isItalic:function(){
return this.italic
},
isUnderline:function(){
return this.underline
},
getColor:function(){
return this.color
},
getHighlight:function(){
return this.highlight
},
getShadow:function(){
return this.shadow
},
isSubscript:function(){
return this.subscript
},
isSuperscript:function(){
return this.superscript
},
getTransform:function(){
return this.transform
},
getLetterSpacing:function(){
return this.letterspacing
}
});
web.data.styles.StyleText.names=[
'normal',
'heading.1',
'heading.2',
'heading.3'
];
web.data.styles.StyleText.types={
'normal':{NAME:'Normal'},
'heading.1':{NAME:'Heading 1'},
'heading.2':{NAME:'Heading 2'},
'heading.3':{NAME:'Heading 3'}
};
web.data.styles.TextState=Ext.extend(web.data.styles.Style,{
type:'web.data.styles.TextState',
underline:null,
color:null,
highlight:null,
shadow:null,
constructor:function(config){
this.underline=null;
this.color=null;
this.highlight=null;
this.shadow=null;
web.data.styles.TextState.superclass.constructor.call(this,config);
if(this.inStylesheet()){
if(!this.color){
this.color=one.color.RGB(0,0,0)
}
}
this.clsPfx='text'
},
destroy:function(){
web.data.styles.TextState.superclass.destroy.call(this);
if(this.shadow){
this.shadow.destroy()
}
delete this.underline;
delete this.color;
delete this.highlight;
delete this.shadow
},
set:function(opts){
var styleOpts=Ext.apply({},opts);
if(opts===null){
this.color=null;
this.highlight=null;
this.shadow=null;
return
}
if(styleOpts.color){
this.color=one.color(styleOpts.color);
delete styleOpts.color
}
if(styleOpts.highlight){
this.highlight=one.color(styleOpts.highlight);
delete styleOpts.highlight
}
if(styleOpts.shadow){
if(this.shadow){
this.shadow.set(styleOpts.shadow)
}else{
this.shadow=new web.data.styles.TextShadow(Ext.apply({parent:this},styleOpts.shadow))
}
}else if(styleOpts.shadow===null||styleOpts.shadow===false){
this.shadow=styleOpts.shadow
}
delete styleOpts.shadow;
web.data.styles.TextState.superclass.set.call(this,styleOpts)
},
getCSSDeclarations:function(){
var css='',alpha,shadow=this.shadow,underline=this.underline,color=this.color,highlight=this.highlight;
css+=underline===null?'':'text-decoration:'+(underline?'underline;\n':'none;\n');
css+=shadow?shadow.getCSSDeclarations():shadow===false?'text-shadow:none;\n':'';
if(color){
alpha=color.alpha();
if(alpha===0){
css+='color:transparent;\n'
}else if(alpha===1){
css+='color:'+color.css()+';\n'
}else{
css+='color:'+color.cssa()+'!important;\n';
css+='color:'+color.css()+';\n'
}
}
if(highlight){
alpha=highlight.alpha();
if(alpha===0){
css+='background-color:transparent;\n'
}else if(alpha===1){
css+='background-color:'+highlight.css()+';\n'
}else{
css+='background-color:'+highlight.cssa()+'!important;\n';
css+='background-color:'+highlight.css()+';\n'
}
}
return css
},
initDefaultStyles:function(){
this.set({color:one.color('#000000')})
},
getSpecificJSON:function(){
var json={};
if(this.underline!==null){
json.underline=this.underline
}
if(this.color){
json.color=this.color.toJSON()
}
if(this.highlight){
json.highlight=this.highlight.toJSON()
}
if(this.shadow){
json.shadow=this.shadow.toJSON()
}else if(this.shadow===false){
json.shadow=this.shadow
}
return json
},
check:function(){
if(!web.data.styles.TextState.superclass.check.call(this)){
one.debug('TextState superclass not ok');
return false
}
if(this.underline!==null&&!Ext.isBoolean(this.underline)){
one.debug('TextState underline not ok');
return false
}
return true
},
isUnderline:function(){
return this.underline
},
getColor:function(){
return this.color
},
getHighlight:function(){
return this.highlight
},
getShadow:function(){
return this.shadow
}
});
web.data.styles.StyleLink=Ext.extend(web.data.styles.Style,{
type:'web.data.styles.StyleLink',
clsPfx:'link',
constructor:function(config){
this.inactive=new web.data.styles.TextState({parent:this});
this.visited=new web.data.styles.TextState({parent:this});
this.hover=new web.data.styles.TextState({parent:this});
this.press=new web.data.styles.TextState({parent:this});
web.data.styles.StyleLink.superclass.constructor.call(this,config);
this.clsPfx='link';
this.commonCls='textnormal'
},
destroy:function(){
if(this.inactive!==null){
this.inactive.destroy();
delete this.inactive
}
if(this.visited!==null){
this.visited.destroy();
delete this.visited
}
if(this.hover!==null){
this.hover.destroy();
delete this.hover
}
if(this.press!==null){
this.press.destroy();
delete this.press
}
web.data.styles.StyleLink.superclass.destroy.call(this)
},
set:function(opts){
var btnOpts=Ext.apply({},opts),inactiveOpts,visitedOpts,hoverOpts,pressOpts;
if(btnOpts.inactive){
inactiveOpts=btnOpts.inactive;
delete btnOpts.inactive
}
if(btnOpts.visited){
visitedOpts=btnOpts.visited;
delete btnOpts.visited
}
if(btnOpts.hover){
hoverOpts=btnOpts.hover;
delete btnOpts.hover
}
if(btnOpts.press){
pressOpts=btnOpts.press;
delete btnOpts.press
}
web.data.styles.StyleLink.superclass.set.call(this,btnOpts);
if(inactiveOpts){
this.inactive.set(Ext.apply({
id:this.getId()+'.inactive',
dm:this.dm
},inactiveOpts))
}
if(visitedOpts){
this.visited.set(Ext.apply({
id:this.getId()+'.visited',
dm:this.dm
},visitedOpts))
}
if(hoverOpts){
this.hover.set(Ext.apply({
id:this.getId()+'.hover',
dm:this.dm
},hoverOpts))
}
if(pressOpts){
this.press.set(Ext.apply({
id:this.getId()+'.press',
dm:this.dm
},pressOpts))
}
},
toCSS:function(doc){
var cls=this.getCSSClass(),css='',inactiveCSS,visitedCSS,hoverCSS,pressCSS;
if(!cls){
return css
}
var docPrefix=doc&&doc.classPrefix?'.'+doc.classPrefix+' ':'';
cls=docPrefix+'.'+this.commonCls+' .'+cls;
inactiveCSS=this.inactive.getCSSDeclarations(doc);
if(inactiveCSS){
css+=cls+'{\n'+inactiveCSS+'}\n'
}
visitedCSS=this.visited.getCSSDeclarations(doc);
if(visitedCSS){
css+=cls+':visited{\n'+visitedCSS+'}\n'
}
hoverCSS=this.hover.getCSSDeclarations(doc);
if(hoverCSS){
css+=cls+':hover{\n'+hoverCSS+'}\n'
}
pressCSS=this.press.getCSSDeclarations(doc);
if(pressCSS){
css+=cls+':active{\n'+pressCSS+'}\n'
}
return css
},
getCSSDeclarations:function(doc){
return this.inactive.getCSSDeclarations(doc)+this.visited.getCSSDeclarations(doc)+this.hover.getCSSDeclarations(doc)+this.press.getCSSDeclarations(doc)
},
toJSON:function(){
var that=this,obj=web.data.styles.StyleLink.superclass.toJSON.call(that);
return Ext.apply(obj,{
inactive:that.inactive.toJSON(),
visited:that.visited.toJSON(),
hover:that.hover.toJSON(),
press:that.press.toJSON()
})
},
initDefaultStyles:function(){
var defaultStyle={
color:null,
underline:null
};
this.inactive.initDefaultStyles();
this.visited.set(defaultStyle);
this.hover.set(defaultStyle);
this.press.set(defaultStyle)
},
checkState:function(state){
return state instanceof web.data.styles.TextState&&state.check()
},
check:function(){
if(!web.data.styles.StyleLink.superclass.check.call(this)){
return false
}
if(!this.checkState(this.inactive)){
return false
}
if(!this.checkState(this.visited)){
return false
}
if(!this.checkState(this.hover)){
return false
}
if(!this.checkState(this.press)){
return false
}
return true
},
getInactive:function(){
return this.inactive
},
getVisited:function(){
return this.visited
},
getHover:function(){
return this.hover
},
getPress:function(){
return this.press
}
});
web.data.styles.StyleLink.names=['link.1'];
web.data.styles.StyleLink.types={'link.1':{NAME:'Link 1'}};
web.data.styles.ButtonView=Ext.extend(web.data.styles.Style,{
type:'web.data.styles.ButtonView',
constructor:function(config){
this.block=new web.data.styles.StyleBlock({parent:this});
this.text=new web.data.styles.StyleText({parent:this});
web.data.styles.ButtonView.superclass.constructor.call(this,config)
},
destroy:function(){
if(this.block!==null){
this.block.destroy();
delete this.block
}
if(this.text!==null){
this.text.destroy();
delete this.text
}
web.data.styles.ButtonView.superclass.destroy.call(this)
},
set:function(opts){
var btnOpts=Ext.apply({},opts),blockOpts,textOpts;
if(btnOpts.block!==undefined){
blockOpts=btnOpts.block;
delete btnOpts.block
}
if(btnOpts.text!==undefined){
textOpts=btnOpts.text;
delete btnOpts.text
}
web.data.styles.ButtonView.superclass.set.call(this,btnOpts);
if(blockOpts===null){
this.block.set(null)
}else if(blockOpts!==undefined){
this.block.set(Ext.apply({
dm:this.dm,
parent:this
},blockOpts))
}
if(textOpts!==undefined){
this.text.set(Ext.apply({
dm:this.dm,
parent:this
},textOpts))
}
},
getCSSDeclarations:function(doc){
var css='';
css+=this.block.getCSSDeclarations(doc);
css+=this.text.getCSSDeclarations(doc);
if(this.text.color){
css+='fill:'+this.text.color.css()+';\n'
}
return css
},
getCellCSSDeclarations:function(doc){
var css=this.block.getCSSDeclarations(doc);
if(this.text.color){
css+='fill:'+this.text.color.css()+';\n'
}
return css
},
getCellTextCSSDeclarations:function(doc){
return this.text.getCSSDeclarations(doc)
},
toCSS:function(doc){
var css='';
css+=this.getCSSSelector(doc)+'{';
css+=this.getCSSDeclarations(doc);
css+='}';
return css
},
toJSON:function(){
var json=web.data.styles.ButtonView.superclass.toJSON.call(this);
return Ext.apply(json,{
block:this.block.toJSON(),
text:this.text.toJSON()
})
},
check:function(){
if(!web.data.styles.ButtonView.superclass.check.call(this)){
return false
}
if(!(this.block instanceof web.data.styles.StyleBlock)){
return false
}
if(!this.block.check()){
return false
}
if(!(this.text instanceof web.data.styles.StyleText)){
return false
}
if(!this.text.check()){
return false
}
return true
},
initDefaultStyles:function(){
this.block.initDefaultStyles();
this.text.initDefaultStyles()
},
getBlock:function(){
return this.block
},
getText:function(){
return this.text
},
getAssets:function(){
return this.block.getAssets().concat(this.text.getAssets())
}
});
web.data.styles.StyleCell=Ext.extend(web.data.styles.ButtonView,{
type:'web.data.styles.StyleCell',
constructor:function(config){
this.verticalAlign=null;
this.horizontalAlign=null;
web.data.styles.StyleCell.superclass.constructor.call(this,config);
this.clsPfx='cell';
this.commonCls='textnormal'
},
getCSSSelector:function(){
var cls=web.data.styles.StyleCell.superclass.getCSSSelector.call(this);
if(!cls||!this.inStylesheet()){
return''
}
return cls
},
getCSSDeclarations:function(doc){
var css=web.data.styles.StyleCell.superclass.getCSSDeclarations.call(this,doc);
if(this.verticalAlign){
css+='vertical-align:'+this.getVerticalAlign()+';\n'
}
if(this.horizontalAlign){
css+='text-align:'+this.getHorizontalAlign()+';\n'
}
return css
},
getCellCSSDeclarations:function(doc){
var css=web.data.styles.StyleCell.superclass.getCellCSSDeclarations.call(this,doc);
if(this.verticalAlign){
css+='vertical-align:'+this.getVerticalAlign()+';\n'
}
if(this.horizontalAlign){
css+='text-align:'+this.getHorizontalAlign()+';\n'
}
return css
},
getCellTextCSSDeclarations:function(doc){
return web.data.styles.StyleCell.superclass.getCellTextCSSDeclarations.call(this,doc)
},
toCSS:function(doc){
var cls=this.getCSSSelector(),docPrefix=doc&&doc.classPrefix?'.'+doc.classPrefix+' ':'',cssBody='',css='';
if(!cls){
return''
}
cssBody+=this.block.getCSSDeclarations(doc);
if(this.verticalAlign){
cssBody+='vertical-align:'+this.getVerticalAlign()+';\n'
}
if(this.horizontalAlign){
cssBody+='text-align:'+this.getHorizontalAlign()+';\n'+(this.getHorizontalAlign()==='justify'?'white-space: normal;':'')
}
if(cssBody){
css=docPrefix+'.'+this.commonCls+' '+cls+'{\n';
css+=cssBody;
css+='}\n'
}
cssBody=this.text.getCSSDeclarations(doc);
if(cssBody){
css+=docPrefix+'.'+this.commonCls+' '+cls+' p > * {\n';
css+=cssBody;
css+='}\n'
}
return css
},
toJSON:function(){
var json=web.data.styles.StyleCell.superclass.toJSON.call(this);
return Ext.apply(json,{
verticalAlign:this.getVerticalAlign(),
horizontalAlign:this.getHorizontalAlign()
})
},
getVerticalAlign:function(){
return this.verticalAlign
},
getHorizontalAlign:function(){
return this.horizontalAlign
},
initDefaultStyles:function(){
web.data.styles.StyleCell.superclass.initDefaultStyles.call(this);
var block=this.getBlock();
block.getBorder().set({
color:[
new one.color.RGB(0.8,0.8,0.8,1),
new one.color.RGB(0.8,0.8,0.8,1),
new one.color.RGB(0.8,0.8,0.8,1),
new one.color.RGB(0.8,0.8,0.8,1)
],
width:[
1,
1,
1,
1
]
});
block.set({
padding:[
3,
3,
3,
3
]
});
this.verticalAlign='top';
this.horizontalAlign='left'
}
});
web.data.styles.StyleCell.names=[
'normal',
'heading.1',
'heading.2',
'alternate'
];
web.data.styles.StyleCell.types={
'normal':{NAME:'Normal'},
'heading.1':{NAME:'Heading 1'},
'heading.2':{NAME:'Heading 2'},
'alternate':{NAME:'Alternate'}
};
web.data.styles.StyleButton=Ext.extend(web.data.styles.Style,{
type:'web.data.styles.StyleButton',
clsPfx:'button',
extraHoverCls:false,
constructor:function(config){
this.inactive=new web.data.styles.StyleCell({parent:this});
this.visited=new web.data.styles.StyleCell({parent:this});
this.hover=new web.data.styles.StyleCell({parent:this});
this.press=new web.data.styles.StyleCell({parent:this});
this.disabled=new web.data.styles.StyleCell({parent:this});
web.data.styles.StyleButton.superclass.constructor.call(this,config);
this.clsPfx='button'
},
destroy:function(){
if(this.inactive!==null){
this.inactive.destroy();
delete this.inactive
}
if(this.hover!==null){
this.hover.destroy();
delete this.hover
}
if(this.press!==null){
this.press.destroy();
delete this.press
}
if(this.disabled!==null){
this.disabled.destroy();
delete this.disabled
}
delete this.width;
delete this.height;
web.data.styles.StyleButton.superclass.destroy.call(this)
},
set:function(opts){
var btnOpts=Ext.apply({},opts),inactiveOpts,visitedOpts,hoverOpts,pressOpts,disabledOpts;
if(btnOpts.inactive){
if(this.ref&&this.ref.indexOf('button')===0&&btnOpts.inactive.block){
btnOpts.inactive.block.padding=[
0,
0,
0,
0
]
}
inactiveOpts=btnOpts.inactive;
delete btnOpts.inactive
}
if(btnOpts.visited){
visitedOpts=btnOpts.visited;
delete btnOpts.visited
}
if(btnOpts.hover){
hoverOpts=btnOpts.hover;
delete btnOpts.hover
}
if(btnOpts.press){
pressOpts=btnOpts.press;
delete btnOpts.press
}
if(btnOpts.disabled){
disabledOpts=btnOpts.disabled;
delete btnOpts.disabled
}
web.data.styles.StyleButton.superclass.set.call(this,btnOpts);
if(btnOpts.dm){
[
'inactive',
'visited',
'hover',
'press',
'disabled'
].forEach(function(state){
this[state].set({dm:btnOpts.dm})
},this)
}
if(inactiveOpts){
this.inactive.set(inactiveOpts)
}
if(visitedOpts){
this.visited.set(visitedOpts)
}
if(hoverOpts){
this.hover.set(hoverOpts)
}
if(pressOpts){
this.press.set(pressOpts)
}
if(disabledOpts){
this.disabled.set(disabledOpts)
}
},
toCSS:function(doc){
var cls=this.getCSSClass(),css='',inactiveCSS,visitedCSS,hoverCSS,pressCSS,disabledCSS,align;
if(!cls){
return css
}
inactiveCSS=this.inactive.getCSSDeclarations(doc);
if(this.width||this.height||inactiveCSS){
css+='.'+cls+'{\n';
css+=this.width===null?'':'width:'+this.width+'px;';
css+=this.height===null?'':'height:'+this.height+'px;';
css+=inactiveCSS;
css+='}\n';
align=this.inactive.horizontalAlign;
css+='.'+cls+' .indent{\n';
css+='padding'+(align==='left'?'-right':align==='right'?'-left':'')+':0px;\n';
css+='}\n';
if(this.inactive.text&&this.inactive.text.color){
css+='.'+cls+' svg{\n';
css+='fill:'+this.inactive.text.color.css()+';';
css+='}\n'
}
}
visitedCSS=this.visited.getCSSDeclarations(doc);
if(visitedCSS){
css+='.'+cls+':visited{\n'+visitedCSS+'}\n'
}
hoverCSS=this.hover.getCSSDeclarations(doc);
if(hoverCSS){
css+='.'+cls+':hover,a.'+cls+':hover,li:hover>a.'+cls+',li:hover>div>a.'+cls;
if(this.extraHoverCls){
css+=',.hover .'+cls+',.hover a.'+cls+',li.hover>a.'+cls+',li.hover>div>a.'+cls
}
css+='{\n'+hoverCSS+'}\n';
if(this.hover.text&&this.hover.text.color){
css+='.'+cls+':hover svg{\n';
css+='fill:'+this.hover.text.color.css()+';';
css+='}\n'
}
}
pressCSS=this.press.getCSSDeclarations(doc);
if(pressCSS){
css+='.'+cls+':active{\n'+pressCSS+'}\n'
}
disabledCSS=this.disabled.getCSSDeclarations(doc);
if(disabledCSS){
css+='.'+cls+'disabled,\n';
css+='.'+cls+'disabled:visited,\n';
css+='.'+cls+'disabled:hover,\n';
css+='.'+cls+'disabled:active{\n'+disabledCSS+'}\n'
}
return css
},
getCSSDeclarations:function(doc,style){
var tempObj={},tempArray=[],css=this.inactive.getCSSDeclarations(doc)+this.visited.getCSSDeclarations(doc)+this.hover.getCSSDeclarations(doc)+this.press.getCSSDeclarations(doc)+this.disabled.getCSSDeclarations(doc);
if(style){
css=css.replace(/\r|\n/g,'');
tempArray=css.split(';');
tempArray.forEach(function(item){
if(item!==''){
tempObj[item]=1
}
});
css=Object.keys(tempObj).join(';')
}
return css
},
toJSON:function(){
var obj=web.data.styles.StyleButton.superclass.toJSON.call(this);
if(!isNaN(this.width)){
obj.width=this.width
}
if(!isNaN(this.height)){
obj.height=this.height
}
return Ext.apply(obj,{
inactive:this.inactive.toJSON(),
visited:this.visited.toJSON(),
hover:this.hover.toJSON(),
press:this.press.toJSON(),
disabled:this.disabled.toJSON()
})
},
initDefaultStyles:function(){
var defaultStyle={
block:null,
text:null
};
this.inactive.initDefaultStyles();
this.visited.set(defaultStyle);
this.hover.set(defaultStyle);
this.press.set(defaultStyle);
this.disabled.set(defaultStyle)
},
checkView:function(view){
return view instanceof web.data.styles.StyleCell&&view.check()
},
check:function(){
if(!web.data.styles.StyleButton.superclass.check.call(this)){
return false
}
if(this.width!==null&&(isNaN(this.width)||this.width<0)){
return false
}
if(this.height!==null&&(isNaN(this.height)||this.height<0)){
return false
}
if(!this.checkView(this.inactive)){
return false
}
if(!this.checkView(this.visited)){
return false
}
if(!this.checkView(this.hover)){
return false
}
if(!this.checkView(this.press)){
return false
}
if(!this.checkView(this.disabled)){
return false
}
return true
},
getWidth:function(){
return this.width
},
getHeight:function(){
return this.height
},
getInactive:function(){
return this.inactive
},
getVisited:function(){
return this.visited
},
getHover:function(){
return this.hover
},
getPress:function(){
return this.press
},
getDisabled:function(){
return this.disabled
},
getAssets:function(){
return this.inactive.getAssets().concat(this.visited.getAssets(),this.hover.getAssets(),this.press.getAssets(),this.disabled.getAssets())
}
});
web.data.styles.StyleButton.names=['button.1'];
web.data.styles.StyleMenu=Ext.extend(web.data.styles.Style,{
type:'web.data.styles.StyleMenu',
constructor:function(config){
this.block=new web.data.styles.StyleBlock({parent:this});
this.divider=new web.data.styles.StyleBlock({parent:this});
var btnCfg={
parent:this,
extraHoverCls:true
};
this.item=new web.data.styles.StyleButton(btnCfg);
this.selected=new web.data.styles.StyleButton(btnCfg);
this.expandable=new web.data.styles.StyleButton(btnCfg);
this.expanded=new web.data.styles.StyleButton(btnCfg);
this.accordionTextIndent=40;
this.cascadeWidth=200;
web.data.styles.StyleMenu.superclass.constructor.call(this,config);
[
'block',
'divider',
'item',
'selected',
'expandable',
'expanded'
].forEach(function(prop){
this[prop].set({dm:this.dm})
},this);
this.clsPfx='menu'
},
destroy:function(){
if(this.block!==null){
this.block.destroy();
delete this.block
}
if(this.divider!==null){
this.divider.destroy();
delete this.divider
}
if(this.item!==null){
this.item.destroy();
delete this.item
}
if(this.selected){
this.selected.destroy();
delete this.selected
}
if(this.expandable){
this.expandable.destroy();
delete this.expandable
}
if(this.expanded){
this.expanded.destroy();
delete this.expanded
}
web.data.styles.StyleMenu.superclass.destroy.call(this)
},
set:function(opts){
var styleOpts={},blockOpts,dividerOpts,itemOpts,selectedOpts,expandableOpts,expandedOpts;
if(!opts){
return
}
Ext.apply(styleOpts,opts);
if(styleOpts.block){
blockOpts=styleOpts.block;
delete styleOpts.block
}
if(styleOpts.divider){
dividerOpts=styleOpts.divider;
delete styleOpts.divider
}
if(styleOpts.item){
itemOpts=styleOpts.item;
delete styleOpts.item
}
if(styleOpts.selected){
selectedOpts=styleOpts.selected;
delete styleOpts.selected
}
if(styleOpts.expandable){
expandableOpts=styleOpts.expandable;
delete styleOpts.expandable
}
if(styleOpts.expanded){
expandedOpts=styleOpts.expanded;
delete styleOpts.expanded
}
web.data.styles.StyleMenu.superclass.set.call(this,styleOpts);
if(blockOpts){
this.block.set(blockOpts)
}
if(dividerOpts){
this.divider.set(dividerOpts)
}
if(itemOpts){
this.item.set(itemOpts);
if(!this.expandable&&!expandableOpts){
expandableOpts=itemOpts
}
}
if(selectedOpts){
if(this.selected){
this.selected.set(selectedOpts)
}else{
this.selected=this.dm.create(Ext.applyIf({
type:'web.data.styles.StyleButton',
parent:this
},selectedOpts))
}
if(!this.expanded&&!expandedOpts){
expandedOpts=selectedOpts;
expandableOpts.hover=selectedOpts.hover
}
}
if(expandableOpts){
if(this.expandable){
this.expandable.set(expandableOpts)
}else{
this.expandable=this.dm.create(Ext.applyIf({
type:'web.data.styles.StyleButton',
parent:this
},expandableOpts))
}
}
if(expandedOpts){
if(this.expanded){
this.expanded.set(expandedOpts)
}else{
this.expanded=this.dm.create(Ext.applyIf({
type:'web.data.styles.StyleButton',
parent:this
},expandedOpts))
}
}
},
toCSS:function(doc){
var css='',cls=this.getCSSClass(),clsPfx,itemCSS,selectedCSS,block=this.block,width=Math.max(this.cascadeWidth-block.getFrameWidth('lr'),0),i,indent=this.accordionTextIndent;
if(!cls){
return''
}
clsPfx=cls;
css+='ul.'+cls+'{\n'+block.getBorder().getCSSDeclarations(doc)+block.getBackground().getCSSDeclarations(doc)+block.getPadding().getCSSDeclarations(doc)+'}\n';
css+='.menucascadeanchor ul.'+cls+'{\n'+'width:'+width+'px;\n'+'}\n';
css+='.'+cls+'divider{\n'+this.divider.getBorder().getCSSDeclarations(doc)+this.divider.getBackground().getCSSDeclarations(doc)+this.divider.getPadding().getCSSDeclarations(doc)+'}\n';
for(i=1;i<=9;i+=1){
css+='.'+cls+'indent'+i+'{padding:0px '+indent*i+'px;}\n'
}
this.item.set({clsPfx:clsPfx+'item'});
itemCSS=this.item.toCSS(doc);
css+=itemCSS;
if(this.expandable){
this.expandable.set({clsPfx:clsPfx+'expandable'});
css+=this.expandable.toCSS(doc).replace(/;/g,' !important;')
}else{
css+=itemCSS.replace(clsPfx+'item',clsPfx+'expandable')
}
if(this.selected){
this.selected.set({clsPfx:clsPfx+'selected'});
selectedCSS=this.selected.toCSS(doc)
}else{
selectedCSS=itemCSS.replace(clsPfx+'item',clsPfx+'selected')
}
css+=selectedCSS;
if(this.expanded){
this.expanded.set({clsPfx:clsPfx+'expanded'});
css+=this.expanded.toCSS(doc).replace(/;/g,' !important;')
}else{
css+=selectedCSS.replace(clsPfx+'selected',clsPfx+'expanded')
}
return css
},
getCSSDeclarations:function(doc){
return this.block.getCSSDeclarations(doc)+this.divider.getCSSDeclarations(doc)+this.item.getCSSDeclarations(doc)+(this.selected?this.selected.getCSSDeclarations(doc):'')+(this.expandable?this.expandable.getCSSDeclarations(doc):'')+(this.expanded?this.expanded.getCSSDeclarations(doc):'')
},
toJSON:function(){
var obj=web.data.styles.StyleMenu.superclass.toJSON.call(this);
if(this.block&&this.item){
obj.block=this.block.toJSON();
obj.item=this.item.toJSON()
}
if(this.divider){
obj.divider=this.divider.toJSON()
}
if(this.selected){
obj.selected=this.selected.toJSON()
}
if(this.expandable){
obj.expandable=this.expandable.toJSON()
}
if(this.expanded){
obj.expanded=this.expanded.toJSON()
}
obj.accordionTextIndent=this.accordionTextIndent;
obj.cascadeWidth=this.cascadeWidth;
return obj
},
check:function(){
if(!web.data.styles.StyleMenu.superclass.check.call(this)){
return false
}
if(!(this.block instanceof web.data.styles.StyleBlock)){
return false
}
if(!this.block.check()){
return false
}
if(this.divider){
if(!(this.divider instanceof web.data.styles.StyleBlock)){
return false
}
if(!this.divider.check()){
return false
}
}
if(!(this.item instanceof web.data.styles.StyleButton)){
return false
}
if(!this.item.check()){
return false
}
if(this.selected instanceof web.data.styles.StyleButton&&!this.selected.check()){
return false
}
if(this.expandable instanceof web.data.styles.StyleButton&&!this.expandable.check()){
return false
}
if(this.expanded instanceof web.data.styles.StyleButton&&!this.expanded.check()){
return false
}
return true
},
initDefaultStyles:function(){
var button=new web.data.styles.StyleButton({
dm:this.dm,
parent:this
});
button.initDefaultStyles();
this.block.initDefaultStyles();
this.divider.initDefaultStyles();
this.item.initDefaultStyles();
this.selected.initDefaultStyles();
this.expandable.initDefaultStyles();
this.expanded.initDefaultStyles()
},
getBlock:function(){
return this.block
},
getDivider:function(){
return this.divider
},
getItem:function(){
return this.item
},
getSelected:function(){
return this.selected
},
getExpandable:function(){
return this.expandable
},
getExpanded:function(){
return this.expanded
},
getAccordionTextIndent:function(){
return this.accordionTextIndent
},
getCascadeWidth:function(){
return this.cascadeWidth
},
getAssets:function(){
var push=Array.prototype.push,assets=[];
push.apply(assets,this.block.getAssets());
push.apply(assets,this.divider.getAssets());
push.apply(assets,this.item.getAssets());
if(this.selected){
push.apply(assets,this.selected.getAssets())
}
if(this.expandable){
push.apply(assets,this.expandable.getAssets())
}
if(this.expanded){
push.apply(assets,this.expanded.getAssets())
}
return assets
}
});
web.data.styles.StyleMenu.names=[
'menu.1',
'menu.2'
];
web.data.styles.StyleMenu.types={
'menu.1':{NAME:'Menu 1'},
'menu.2':{NAME:'Menu 2'}
};
web.data.styles.Stylesheet=Ext.extend(web.data.Part,{
type:'web.data.styles.Stylesheet',
name:null,
styles:null,
constructor:function(config){
this.name='';
this.styles=[];
this.types=[
'StyleBlock',
'StyleText',
'StyleLink',
'StyleButton',
'StyleMenu',
'StyleCell',
'StyleForm'
];
this.typesMap={
'block':0,
'text':1,
'link':2,
'button':3,
'menu':4,
'cell':5
};
web.data.styles.Stylesheet.superclass.constructor.call(this,config);
this.initDefaultStyles()
},
set:function(opts){
var partOpts=Ext.apply({},opts),styleOpts;
if(Ext.isArray(partOpts.styles)){
styleOpts=partOpts.styles
}
delete partOpts.styles;
web.data.styles.Stylesheet.superclass.set.call(this,partOpts);
if(styleOpts){
if(!Ext.isArray(this.styles)){
this.styles=[]
}
styleOpts.forEach(function(opt){
if(opt){
var currentStyle=this.getStyleByRef(opt.ref,opt.type);
if(currentStyle){
currentStyle.set(opt)
}else{
this.styles.push(this.dm.create(Ext.apply({parent:this},opt)))
}
}
},this)
}
},
destroy:function(){
web.data.styles.Stylesheet.superclass.destroy.call(this);
this.removeStyles();
delete this.name;
delete this.styles
},
initDefaultStyles:function(){
var stylesNamespace=web.data.styles,types=this.types;
types.forEach(function(type){
stylesNamespace[type].names.forEach(function(name){
var style=this.getStyleByRef(name,type),styleCfg;
if(!style){
style=this.dm.create({
parent:this,
name:'['+name+']',
ref:name,
type:'web.data.styles.'+type
});
style.initDefaultStyles();
this.styles.push(style)
}else{
styleCfg=style.toJSON();
style.initDefaultStyles();
style.set(styleCfg)
}
},this)
},this)
},
toJSON:function(){
var obj=web.data.styles.Stylesheet.superclass.toJSON.call(this),styles=this.getStyles();
obj.name=this.name;
obj.styles=[];
styles.forEach(function(style){
obj.styles.push(style.toJSON())
});
return obj
},
check:function(){
var i,style;
if(!web.data.styles.Stylesheet.superclass.check.call(this)){
return false
}
if(this.name===null||!this.name.trim().length){
return false
}
if(this.styles===null||!Ext.isArray(this.styles)){
return false
}
for(i=0;i<this.styles.length;i+=1){
style=this.styles[i];
if(this.types.indexOf(style.type)>=0&&!style.check()){
return false
}
}
this.checkComplete();
return true
},
checkComplete:function(){
var i,style,type,types=this.types,list={},j,ref,typeNames;
for(i=0;i<this.styles.length;i+=1){
style=this.styles[i];
ref=style.getRef();
type=style.getStyleType();
ref=ref.split('.')[0];
list[type]=list[type]?list[type]:{};
list[type][ref]=true
}
for(i=0;i<types.length;i+=1){
type=types[i];
if(!list[type]){
return false
}
typeNames=web.data.styles[type].names;
for(j=0;j<typeNames.length;j+=1){
ref=typeNames[j];
if(!list[type][ref]){
return false
}
}
}
return true
},
getName:function(){
return this.name
},
isDocument:function(){
return true
},
getStyle:function(id){
var i,style;
for(i=0;i<this.styles.length;i+=1){
style=this.styles[i];
if(style.getId()===id){
return style
}
}
return null
},
getClosestStyle:function(style,type){
var global,ref,result,name,aliases=[],styles,i,others,options=[],option,map={},alias,index,pfx='web.data.styles.';
if(!style){
return
}
if(style instanceof web.data.styles.Style){
global=style.getGlobal();
ref=global?global.getRef():style.getRef();
name=style.getGlobalName();
type=style.getType();
aliases=[ref]
}else{
name=style;
type=pfx+this.types[this.typesMap[type]]
}
if(!(ref||name)||!type){
return
}
if(ref&&style){
result=this.getStyleByRef(ref,style.getStyleType());
if(result){
return result
}
}
aliases=aliases.concat(this.getAliases(ref||name));
styles=this.getStylesByType(type);
for(i=0;i<styles.length;i+=1){
others=styles[i].getAliases()||[];
while(others.length){
alias=others.pop();
options.push({
alias:alias,
rank:others.length,
index:i
})
}
}
options=options.sort(function(a,b){
return a.rank!==b.rank?a.rank>b.rank?-1:1:a.alias>b.alias?-1:1
});
for(i=0;i<options.length;i+=1){
option=options[i];
map[option.alias]=option.index
}
aliases.reverse();
while(aliases.length){
alias=aliases.pop();
index=map[alias];
if(!isNaN(index)){
return styles[index]
}
}
return
},
getAliases:function(name){
var aliases=[],segments,last,firsts,no;
name=name.replace(/[\[\]]/g,'');
aliases.push(name);
segments=name.split('.');
while(segments.length>1){
last=segments.pop();
firsts=segments.join('.');
no=parseInt(last,10);
if(!isNaN(no)&&no>1){
for(no-=1;no>0;no-=1){
aliases.push(firsts+'.'+no)
}
}
aliases.push(firsts)
}
return aliases
},
getStyles:function(){
var styles,i,style;
if(this.styles===null){
return null
}
styles=[];
for(i=0;i<this.styles.length;i+=1){
style=this.styles[i];
styles.push(style)
}
return styles
},
getStylesByType:function(type){
var styles,i,style;
if(this.styles===null){
return null
}
styles=[];
for(i=0;i<this.styles.length;i+=1){
style=this.styles[i];
if(style.getType()===type){
styles.push(style)
}
}
return styles
},
getStyleByRef:function(ref,type){
if(type){
type='web.data.styles.'+type.toLowerCase()
}
var foundStyle=null,style,numStyles,i;
if(this.styles===null){
return null
}
for(i=0,numStyles=this.styles.length;i<numStyles;i+=1){
style=this.styles[i];
if(style.ref===ref&&(!type||style.getType().toLowerCase()===type)){
foundStyle=style;
break
}
}
return foundStyle
},
addStyle:function(style){
style.parent=this;
style=this.dm.create(style);
if(this.styles.indexOf(style)<0){
this.styles.push(style)
}
return style
},
removeStyle:function(style){
var i,loopStyle,newStyles;
newStyles=[];
for(i=0;i<this.styles.length;i+=1){
loopStyle=this.styles[i];
if(loopStyle.getId()!==style.getId()){
newStyles.push(loopStyle)
}
}
this.styles=newStyles
},
removeStyles:function(){
var style;
if(!Ext.isArray(this.styles)){
return
}
while(this.styles.length){
style=this.styles.pop();
this.dm.unregister(style.getId());
style.destroy()
}
},
getAssets:function(){
var assets=[],items=this.getStyles();
items.forEach(function(item){
var itemAssets=item.getAssets();
itemAssets.forEach(function(asset){
if(assets.indexOf(asset)===-1){
assets.push(asset)
}
},this)
},this);
return assets
},
getItems:function(){
return this.getStyles()
}
});
web.data.components.Template=Ext.extend(web.data.components.Layer,{
type:'web.data.components.Template',
align:null,
constructor:function(config){
this.align='center';
this.verticalScroll='auto';
this.favicon=null;
this.mobile=null;
this.currentPage=null;
this.locale=config.locale?config.locale:this.getCurrentLocaleId();
this.categories=[];
web.data.components.Template.superclass.constructor.call(this,config)
},
getLocale:function(){
return this.locale
},
getAlign:function(){
return this.align
},
getVerticalScroll:function(){
return this.verticalScroll
},
getFavicon:function(){
return this.favicon
},
isMobile:function(){
return this.mobile
},
isStretch:function(){
return true
},
isDocument:function(){
return true
},
getMinWidth:function(){
return 300
},
getMaxWidth:function(){
return 2000
},
getMinHeight:function(){
return 500
},
getHeight:function(){
return this.getMinHeight()
},
getCategories:function(){
return this.categories
},
toJSON:function(){
var obj=web.data.components.Template.superclass.toJSON.call(this);
obj.name=this.name;
obj.stylesheetId=this.stylesheetId;
obj.align=this.align;
obj.verticalScroll=this.verticalScroll;
obj.mobile=this.mobile;
obj.locale=this.locale;
obj.categories=this.categories;
var favicon=this.favicon;
if(favicon){
if(favicon.toJSON){
obj.favicon=favicon.toJSON()
}else{
obj.favicon=favicon
}
}
return obj
},
getStylesheet:function(){
return this.dm.get(this.stylesheetId)
},
getAssets:function(){
var assets=web.data.components.Template.superclass.getAssets.call(this);
var favicon=this.getFavicon();
if(favicon){
assets=assets.concat([this.dm.create(Ext.apply({},{parent:this},favicon))])
}
return assets
},
getCurrentLocaleId:function(){
one=one||{locale:{id:'en_us'}};
one.locale=one.locale||{id:'en_us'};
return one.locale.id
}
});
web.data.components.Template.NAME='Template';
Ext.override(web.data.components.Template,{
getCurrentPage:function(){
return this.currentPage
},
getPageArea:function(pageId){
var area={},areas=[],items=this.getItems().concat(this),width=this.getWidth(),bottom=0;
items.forEach(function(item){
var bbox=item.bbox,relTo=item.relTo,relIn=item.relIn,relPage=item.relPage,sibs,option={};
if(relTo&&relPage&&relPage[pageId]){
sibs=item.getRelInSiblings();
option.bbox=new Ext.lib.Region(0,width,bbox.top-relPage[pageId],0);
if(relIn){
option.relIn={
id:relIn.id,
top:0,
right:0,
bottom:relIn.bottom-item.height-relTo.below,
left:0
};
option.bbox=option.bbox.intersect(item.getRelInParent().bbox)
}
if(!option.bbox){
return
}
var option1={
bbox:new Ext.lib.Region(option.bbox.top,option.bbox.right,option.bbox.bottom,option.bbox.left),
relIn:option.relIn?Ext.apply({},option.relIn):undefined
};
sibs.forEach(function(sib){
if(sib!==item&&!sib.inPage()&&option1.bbox.intersect(sib.bbox)){
option1.relTo={
id:sib.id,
below:0
};
if(option1.relIn){
option1.relIn.top+=sib.bbox.bottom-option1.bbox.top
}
option1.bbox.top=sib.bbox.bottom
}
});
areas.push(option1);
var midPoint=Math.round((bbox.left+bbox.right)/2),option2={
bbox:new Ext.lib.Region(option.bbox.top,midPoint,option.bbox.bottom,midPoint),
relIn:option.relIn?Ext.apply({},option.relIn):undefined
};
sibs.forEach(function(sib){
if(sib!==item&&!sib.inPage()&&option2.bbox.intersect(sib.bbox)){
option2.relTo={
id:sib.id,
below:0
};
if(option2.relIn){
option2.relIn.top+=sib.bbox.bottom-option2.bbox.top
}
option2.bbox.top=sib.bbox.bottom
}
});
option2.bbox.left=option.bbox.left;
option2.bbox.right=option.bbox.right;
sibs.forEach(function(sib){
if(sib!==item&&!sib.inPage()&&option2.bbox.intersect(sib.bbox)){
if(sib.bbox.right<=midPoint){
if(option2.relIn){
option2.relIn.left+=sib.bbox.right-option2.bbox.left
}
option2.bbox.left=sib.bbox.right
}
if(sib.bbox.left>=midPoint){
if(option2.relIn){
option2.relIn.right+=sib.bbox.left-option2.bbox.right
}
option2.bbox.right=sib.bbox.left
}
}
});
areas.push(option2)
}
var spacing=item.getSpacing(),ibbox=new Ext.lib.Region(bbox.top+spacing.top,bbox.right-spacing.right,bbox.bottom-spacing.bottom,bbox.left+spacing.left);
var itemCount=0;
sibs=[];
item.getRelInItems().forEach(function(item){
if(!item.inPage()){
sibs.push(item);
itemCount+=1
}
},this);
if(item.isContainer()&&!itemCount){
option={};
option.bbox=new Ext.lib.Region(ibbox.top,ibbox.right,ibbox.bottom,ibbox.left);
if(item.getParent()){
option.relIn={
id:item.id,
top:0,
right:0,
bottom:0,
left:0
}
}
areas.push(option)
}
if(item.isContainer()){
var btm=ibbox.bottom;
sibs.forEach(function(sib){
btm=Math.max(btm,sib.bbox.bottom)
});
var midX=Math.round((ibbox.left+ibbox.right)/2),midY=Math.round((ibbox.top+btm)/2),optV=new Ext.lib.Region(ibbox.top,midX,btm,midX),optH=new Ext.lib.Region(midY,ibbox.right,midY,ibbox.left),areaV={bbox:optV},areaH={bbox:optH};
sibs.forEach(function(sib){
var sb=sib.bbox;
if(optV.intersect(sb)){
if(sb.top<midY){
areaV.relTo={
id:sib.id,
below:0
};
optV.top=Math.max(optV.top,sb.bottom)
}
if(sb.bottom>midY){
optV.bottom=Math.min(optV.bottom,sb.top)
}
}
if(optH.intersect(sb)){
if(sb.left<midX){
optH.left=Math.max(optH.left,sb.right)
}
if(sb.right>midX){
optH.right=Math.min(optH.right,sb.left)
}
}
});
optV.left=ibbox.left;
optV.right=ibbox.right;
optH.top=ibbox.top;
optH.bottom=btm;
optV.top+=1;
optV.bottom-=1;
optH.left+=1;
optH.right-=1;
sibs.forEach(function(sib){
var sb=sib.bbox;
if(optV.intersect(sb)){
if(sb.left<midX){
optV.left=Math.max(optV.left,sb.right)
}
if(sb.right>midX){
optV.right=Math.min(optV.right,sb.left)
}
}
if(optH.intersect(sb)){
if(sb.top<midY){
areaH.relTo={
id:sib.id,
below:0
};
optH.top=Math.max(optH.top,sb.bottom)
}
if(sb.bottom>midY){
optH.bottom=Math.min(optH.bottom,sb.top)
}
}
});
optV.top-=1;
optV.bottom+=1;
optH.left-=1;
optH.right+=1;
if(item.getParent()){
areaV.relIn={
id:item.id,
top:optV.top-ibbox.top,
right:optV.right-ibbox.right,
bottom:optV.bottom-ibbox.bottom,
left:optV.left-ibbox.left
};
areaH.relIn={
id:item.id,
top:optH.top-ibbox.top,
right:optH.right-ibbox.right,
bottom:optH.bottom-ibbox.bottom,
left:optH.left-ibbox.left
}
}
areas.push(areaV);
areas.push(areaH)
}
bottom=Math.max(bottom,item.bbox.bottom)
},this);
areas.push({bbox:new Ext.lib.Region(bottom,width,bottom,0)});
var bestScore=-Infinity;
areas.forEach(function(option){
var oB=option.bbox,oWidth=oB.right-oB.left,oHeight=oB.bottom-oB.top,oScore=Math.min(oWidth-oB.top/10,700)*Math.min(oHeight,500)-oB.top;
if(bestScore<oScore){
area=option;
bestScore=oScore
}
});
var ri=area.relIn,riItem=ri?this.dm.get(ri.id):this,sibs=[];
if(riItem){
riItem.getRelInItems().forEach(function(item){
if(!item.inPage()){
sibs.push(item)
}
},this)
}
var abb=area.bbox,oldTop=abb.top,top,right,left,tmp,space;
sibs.forEach(function(item){
var ibb=item.bbox;
if(abb.top===ibb.top||abb.top===0){
top=false
}
if(top!==false&&ibb.top>abb.top&&ibb.top<abb.bottom){
top=top?Math.min(top,ibb.top):ibb.top
}
if(abb.left===ibb.left||abb.left===0){
left=false
}
if(left!==false&&ibb.left>abb.left&&ibb.left<abb.right){
left=left?Math.min(left,ibb.left):ibb.left
}
if(abb.right===ibb.right||abb.right===width){
right=false
}
if(right!==false&&ibb.right<abb.right&&ibb.right>abb.left){
right=right?Math.max(right,ibb.right):ibb.right
}
space=item.relTo&&item.relTo.id&&item.height>50?space?Math.max(space,item.relTo.below):item.relTo.below:space
},this);
if(top||top===0){
tmp=Math.min(top-abb.top,100);
top=tmp<=100?top:null;
if(top){
abb.top=top;
space=space?Math.min(space,tmp):tmp
}
}
if(left||left===0){
tmp=Math.min(left-abb.left,100);
left=tmp<=100?left:null;
if(left){
abb.left=left;
space=space?Math.min(space,tmp):tmp
}
}
if(right||right===0){
tmp=Math.min(abb.right-right,100);
right=tmp<=100?right:null;
if(right){
abb.right=right;
space=space?Math.min(space,tmp):tmp
}
}
space=space<=100?space:null;
if(space){
abb.top+=top===undefined?space:0;
abb.left+=left===undefined?space:0;
abb.right-=right===undefined?space:0
}
if(area.relTo){
area.relTo.below+=abb.top-oldTop
}
return area
}
});
Ext.override(web.data.components.Template,{
render:function(doc){
var stylesheet=this.getStylesheet(),faviconUrl,faviconTag;
var previousCurrentPage=this.currentPage;
this.currentPage=doc.getPage();
doc.addStyle(stylesheet.getStyleByRef('body','StyleBlock'));
doc.addStyle(stylesheet.getStyleByRef('normal','StyleText'));
if(this.verticalScroll==='scroll'&&!doc.editMode&&!doc.previewMode){
doc.appendToCSS('html{overflow-y:scroll!important;}\n')
}
if(this.favicon){
if(!this.favicon.getRelativeUrl){
this.favicon.type='web.data.assets.Image';
this.favicon=this.dm.create(this.favicon)
}
faviconUrl=this.favicon.getRelativeUrl(doc.getAssetURL());
if(this.favicon.contentType!=='image/x-icon'&&this.favicon.contentType!=='image/vnd.microsoft.icon'){
faviconUrl+='?resize=16,16&format=ico'
}
faviconTag='<link rel="shortcut icon" href="'+Ext.util.Format.htmlEncode(faviconUrl)+'" />\n';
doc.appendToHead(faviconTag,true)
}
if(!doc.editMode){
this.renderBody(doc)
}
if(doc.previewMode){
this.currentPage=previousCurrentPage
}
},
renderBody:function(doc){
this.renderAllItems(doc)
},
getBlockRenderClass:function(doc){
var cls=web.data.components.Template.superclass.getBlockRenderClass.call(this,doc);
cls+=' template';
return cls
},
getBlockRenderStyle:function(doc){
return'min-width:'+this.getInnerWidth()+'px;'
},
getRenderStyle:function(doc){
return doc.editMode?'min-height:500px;':''
},
getTemplateRenderStyle:function(doc){
var align;
switch(this.align){
case'left':
align='float:left;';
break;
case'right':
align='float:right;';
break;
case'center':
align='margin:auto;';
break;
default:
align='margin:auto;';
break
}
return'width:'+this.getInnerWidth()+'px;'+align
},
canRender:function(){
var stylesheet=this.dm.get(this.getStylesheetId());
return stylesheet
}
});
web.data.components.Block=Ext.extend(web.data.components.Component,{
type:'web.data.components.Block',
constructor:function(config){
this.style=null;
web.data.components.Block.superclass.constructor.call(this,config)
},
set:function(opts){
var obj=Ext.apply({},opts);
this.setCalled=true;
if(obj.dm){
this.dm=obj.dm;
delete obj.dm
}
if(!obj.style&&!this.style){
obj.style={type:'web.data.styles.StyleBlock'}
}
if(obj.style){
this.style=this.dm.create(Ext.apply({
dm:this.dm,
parent:this
},obj.style));
delete obj.style;
this.styleSet=true
}
if(obj.spacing){
this.setSpacingOpts(obj);
delete obj.spacing
}
web.data.components.Block.superclass.set.call(this,obj)
},
setSpacingOpts:function(opts){
var prop,border,bw,sopts={};
border=this.getBorderWidth();
for(prop in opts.spacing){
if(opts.spacing.hasOwnProperty(prop)){
bw=border['get'+prop.capitalize()]();
sopts[prop]=opts.spacing[prop]-bw;
sopts[prop]=sopts[prop]<0?0:sopts[prop]
}
}
this.style.getPadding().set(sopts)
},
getStyle:function(){
return this.style
},
getStyleId:function(){
return this.style?this.style.getId():null
},
toJSON:function(){
var obj=web.data.components.Block.superclass.toJSON.call(this);
if(this.style!==null){
obj.style=this.style.toJSON()
}
return obj
},
getBlockRenderClass:function(doc){
var cls=web.data.components.Block.superclass.getBlockRenderClass.call(this,doc),style,styleCls;
cls+=(cls?' ':'')+'block';
style=this.getStyle();
if(style){
if(this.isBlockStyle()){
doc.addStyle(style);
styleCls=style.getCSSClass(doc)
}
cls+=styleCls?' '+styleCls:''
}
return cls
},
getBlockRenderStyle:function(doc){
var style=web.data.components.Block.superclass.getBlockRenderStyle.call(this,doc);
if(this.isStretch()){
style=''
}
if(/^(left|right)$/i.test(doc.getPage().getTemplate().align)){
style+='min-height:'+this.getHeight()+'px;'
}
return style
},
getRenderClass:function(doc){
var cls=web.data.components.Block.superclass.getRenderClass.call(this,doc);
if(doc.editMode&&this.type==='web.data.components.Block'&&!this.isBlockStyle()){
cls+=' clear'
}
return cls
},
getRenderListeners:function(doc){
return!doc.editMode?{'onclick':'if(event.target ===  this) {event.stopPropagation();}'}:null
},
getRenderStyle:function(doc){
var style=web.data.components.Block.superclass.getRenderStyle.call(this,doc);
if(this.isStretch()){
style+=this.getAlignStyle(this.getTemplate())
}
return style
},
getAlignStyle:function(template){
var style='';
switch(template.align){
case'left':
break;
case'right':
break;
case'center':
style='margin:auto;width:'+template.getInnerWidth()+'px;';
break;
default:
style='margin:auto;width:'+template.getInnerWidth()+'px;';
break
}
return style
},
getSpacing:function(){
var border,padding,i,frame=[];
border=this.getBorderWidth().toJSON();
padding=this.getPadding().toJSON();
for(i=0;i<4;i+=1){
frame[i]=border[i]+padding[i]
}
return new web.data.styles.FrameWidth(frame)
},
getPadding:function(){
var i,frame=[
0,
0,
0,
0
],globalS,local,global,localS=this.getStyle();
if(localS){
globalS=localS.getGlobal();
local=localS.getPadding().toJSON();
local=local?local:[];
global=globalS?globalS.getPadding().toJSON():[];
global=global?global:frame;
for(i=0;i<4;i+=1){
frame[i]=Ext.isNumber(local[i])?local[i]:Ext.isNumber(global[i])?global[i]:frame[i]
}
}
return new web.data.styles.FrameWidth(frame)
},
getBorderWidth:function(){
var i,frame=[
0,
0,
0,
0
],globalS,local,global,localS=this.getStyle();
if(localS){
globalS=localS.getGlobal();
local=localS.getBorder().getWidth().toJSON();
local=local?local:[];
global=globalS?globalS.getBorder().getWidth().toJSON():[];
global=global?global:frame;
for(i=0;i<4;i+=1){
frame[i]=Ext.isNumber(local[i])?local[i]:Ext.isNumber(global[i])?global[i]:frame[i]
}
}
return new web.data.styles.FrameWidth(frame)
},
isCorners:function(){
var i,frame=[
0,
0,
0,
0
],globalS,local,global,localS=this.getStyle();
if(localS){
globalS=localS.getGlobal();
local=localS.getBorder().getCorners().toJSON();
local=local?local:[];
global=globalS?globalS.getCorners().getWidth().toJSON():[];
global=global?global:frame;
for(i=0;i<4;i+=1){
frame[i]=Ext.isNumber(local[i])?local[i]:Ext.isNumber(global[i])?global[i]:frame[i]
}
}
return new web.data.styles.FrameWidth(frame)
},
getAssets:function(){
return web.data.components.Block.superclass.getAssets.call(this).concat(this.style.getAssets())
},
getAllStyles:function(){
return web.data.components.Block.superclass.getAllStyles.call(this).concat([this.style])
},
isBackground:function(){
var globalS,local={},global={},localS=this.getStyle();
if(localS){
globalS=localS.getGlobal();
local=localS.getBackground();
local=local?local:{};
global=globalS?globalS.getBackground():{};
global=global?global:{}
}
return local.color||local.gradient||local.asset||global.color||global.gradient||global.asset
},
isMobileBase:function(){
return this.isBackground()
},
isBlockStyle:function(){
var spacing=this.getSpacing();
return spacing.top+spacing.right+spacing.bottom+spacing.left||this.isBackground()||this.isCorners()
},
isStretchy:function(){
return true
}
});
web.data.components.Block.NAME='Background';
Ext.ns('web.data.text');
web.data.text.Aspects=Ext.extend(Object,{
type:'web.data.text.Aspects',
constructor:function(cfg){
this.items=[];
web.data.text.Aspects.superclass.constructor.apply(this,arguments);
this.set(cfg)
},
endShift:true,
endShiftOff:false,
set:function(cfg){
if(Ext.isObject(cfg)){
Ext.apply(this,cfg);
if(cfg.data){
this.initMode=true;
this.clear();
this.suspendRepair();
cfg.data.forEach(function(datum){
this.add(datum)
},this);
this.resumeRepair();
this.initMode=false
}else{
this.repair()
}
}
},
getCount:function(){
return this.items.length
},
item:function(id){
var result=null;
this.forEach(function(aspect){
if(aspect.getId()===id){
result=aspect
}
},this);
return result
},
itemAt:function(index){
return this.items[index]
},
clear:function(){
this.items=[]
},
indexOf:function(o){
return this.items.indexOf(o)
},
initAspect:function(cfg){
return cfg instanceof web.data.text.Aspect?cfg:new web.data.text.Aspect(cfg)
},
newAspect:function(o){
if(o[2]){
o[2].richtext=this.richtext;
o[2].aspects=this;
o[2].start=o[0];
o[2].end=o[1]
}else{
o.richtext=this.richtext;
o.aspects=this
}
return this.initAspect(o)
},
disableEndShift:function(){
this.endShiftOff=true
},
enableEndShift:function(){
this.endShiftOff=false
},
suspendRepair:function(){
this.repairOff=true
},
resumeRepair:function(){
this.repairOff=false;
this.repair()
},
insert:function(index,o){
var items=this.items,len=items.length,newItems;
if(!o){
return
}
if(!(o instanceof web.data.text.Aspect)){
o=this.newAspect(o)
}
if(!o){
return
}
if(index>=len){
this.items.push(o)
}else{
newItems=index?items.slice(0,index):[];
newItems=newItems.concat([o],items.slice(index,items.length));
this.items=newItems
}
if(!this.repairOff){
this.repair()
}
return o
},
sort:function(){
var that=this;
this.items=this.items.sort(function(a,b){
return a.start!==b.start?a.start-b.start:a.end!==b.end?a.end-b.end:that.indexOf(a)-that.indexOf(b)
})
},
add:function(o){
return this.insert(this.items.length,o)
},
remove:function(o){
this.items.remove(o)
},
repair:function(){
this.repairClean();
this.repairJoin()
},
repairClean:function(){
this.sort();
var richtext=this.richtext,prev={};
for(var i=0,len=this.items.length;i<len;i+=1){
var aspect=this.itemAt(i),start=aspect.getStart(),end=aspect.getEnd(),invalid,text=richtext?richtext.getText():null,length;
invalid=start<prev.end;
if(richtext){
invalid=invalid||start===end&&(!richtext.isParaAt(start)||!richtext.isParaEndAt(end))
}
if(!invalid&&text!==null){
length=text.length;
if(end>length){
aspect.setEnd(end=length)
}
if(this.endShift){
if(richtext.isTable()&&end===length){
end-=1;
aspect.setEnd(end)
}
if(start===prev.end&&richtext.isParaEndAt(start)&&richtext.isParaAt(start)){
if(start===end){
invalid=true
}else{
start+=1;
aspect.setStart(start)
}
}
if(!invalid){
while(richtext.isParaEndAt(start)&&!richtext.isParaAt(start)&&start<length){
start+=1;
aspect.setStart(start)
}
while(richtext.isParaAt(end)&&!richtext.isParaEndAt(end)&&end>0){
end-=1;
aspect.setEnd(end)
}
}
}
}
invalid=invalid||aspect.getStart()>end;
if(invalid){
this.items.splice(i,1);
i-=1;
len-=1
}else{
prev=aspect
}
}
},
repairJoin:function(){
if(this.endShift){
var aspect1,aspect2,richtext=this.richtext,joinable=false;
for(var i=1,len=this.items.length;i<len;i+=1){
aspect1=this.itemAt(i-1);
aspect2=this.itemAt(i);
joinable=aspect1.getEnd()===aspect2.getStart();
joinable=joinable||richtext.isParaAt(aspect1.getEnd()+1)&&aspect1.getEnd()+1===aspect2.getStart();
joinable=joinable&&aspect1.canJoin(aspect2);
if(joinable){
aspect1.setEnd(aspect2.getEnd());
this.items.splice(i,1);
i-=1;
len-=1
}
}
}
},
getByIndex:function(index){
var len=this.getCount(),o,i;
for(i=0;i<len;i+=1){
o=this.itemAt(i);
if(o.start<=index&&o.end>index){
return o
}
}
return null
},
getByRange:function(start,end){
var len=this.getCount(),o,i,aspects=[];
for(i=0;i<len;i+=1){
o=this.itemAt(i);
if(o.start<end&&o.end>=start){
aspects.push(o)
}
}
return aspects
},
shift:function(i,amount){
this.sort();
var endShift=this.endShift&&amount>0,aspects=[],olde;
this.forEach(function(o){
var e=o.end;
if(!this.endShiftOff&&endShift&&e===i){
aspects=[o]
}else if(e>i){
aspects.push(o)
}
});
aspects.forEach(function(o){
var s=o.start,e=o.end,isCollapsed=s===e;
s+=s>i||endShift&&s===i&&olde===s?amount:0;
e+=e>i||endShift&&e===i?amount:0;
s=s<i&&o.start>i?i:s;
e=e<i&&o.end>i?i:e;
e=Math.max(s,e);
olde=o.end;
o.start=s;
o.end=e;
if(s>e||s===e&&!isCollapsed){
this.remove(o)
}
},this)
},
toJSON:function(){
var json=[];
this.forEach(function(aspect){
json.push(aspect.toJSON())
},this);
return json
},
refreshRichness:function(){
this.forEach(function(aspect){
this.richtext.refreshRichness(aspect)
},this)
},
getCurrent:function(inclusive){
var result=[];
this.forEach(function(aspect){
if(aspect.isCurrent(inclusive)){
result.push(aspect)
}
},this);
return result
},
forEach:function(fn,scope){
this.items.forEach(fn,scope||this)
},
applyAspects:function(aspects){
var richtext=this.richtext,s=richtext.start,e=richtext.end;
aspects.forEach(function(aspect){
var start=aspect.getStart()+s,end=aspect.getEnd()+s;
end=end>e?e:end;
richtext.position(start,end);
this.applyAspect(aspect)
},this);
richtext.position(s,e)
},
applyAspect:function(aspect){
var old,start,end,richtext=this.richtext,length=richtext.text.length,s=richtext.start,e=richtext.end,now=aspect.toJSON?aspect.toJSON():aspect,aspects=this.getCurrent(true),last=s;
if(now[2]){
now=now[2]
}
if(s!==e){
if(richtext.isParaEndAt(s)){
while(!richtext.isParaAt(s)&&s<length){
s+=1
}
}
if(richtext.isParaAt(e)){
while(!richtext.isParaEndAt(e)&&e>0){
e-=1
}
}
}
if(s>e||s===e&&!richtext.isParaAt(s)&&!richtext.isParaEndAt(e)){
return
}
this.suspendRepair();
while((old=aspects[0])&&old.getStart()<s&&old.getEnd()<=s&&s!==e){
aspects.shift()
}
while((old=aspects[aspects.length-1])&&old.getStart()>=e&&old.getEnd()>e&&s!==e){
old=aspects.pop()
}
if(s!==e){
aspects.forEach(function(old){
var start=old.getStart(),end=old.getEnd();
if(start<s&&s<end){
this.breed(old,{
start:start,
end:richtext.isParaAt(s)?s-1:s
});
old.setStart(s);
start=s
}
if(last<start){
if(richtext.isParaEndAt(last)){
if(last+1!==start){
this.breed(now,{
start:last+1,
end:start
})
}
}else{
this.breed(now,{
start:last,
end:start
})
}
}
if(start<e&&e<end){
old.setEnd(e);
this.breed(old,{
start:richtext.isParaEndAt(e)?e+1:e,
end:end
});
end=e
}
old.set(now);
last=end
},this);
if(last<e){
this.breed(now,{
start:richtext.isParaEndAt(last)?last+1:last,
end:e
})
}
}else{
if(old=aspects[0]){
start=old.getStart();
end=old.getEnd();
if(start<s&&s-1>=0){
this.breed(old,{
start:start,
end:s-1
})
}
if(e<end&&e+1<=length){
this.breed(old,{
start:e+1,
end:end
})
}
}
if(old){
old.set(now);
old.set({
start:s,
end:e
})
}else{
this.breed(now,{
start:s,
end:e
})
}
}
this.resumeRepair()
},
removeAspects:function(){
var richtext=this.richtext,s=richtext.start,e=richtext.end,aspects=this.getCurrent(true);
aspects.forEach(function(old){
var start=old.getStart(),end=old.getEnd();
if(start<e&&end>s){
if(start<s){
old.setEnd(s);
if(end>e){
this.breed(old,{
start:e,
end:end
})
}
}else if(end>e){
old.setStart(e)
}else{
this.remove(old)
}
}
},this);
this.repair()
},
breed:function(){
var offspring={},i,parent;
for(i=0;i<arguments.length;i+=1){
parent=arguments[i];
parent=parent.toJSON?parent.toJSON():parent;
parent=parent[2]?parent[2]:parent;
Ext.apply(offspring,parent)
}
return this.add(offspring)
}
});
web.data.text.Aspect=Ext.extend(Object,{
type:'web.data.text.Aspect',
atype:'aspect',
endShift:true,
constructor:function(cfg){
this.id=Math.uuid();
this.start=0;
this.end=null;
this.init();
if(Ext.isArray(cfg)){
this.start=cfg[0];
this.end=cfg[1];
cfg=cfg[2]
}
this.set(cfg);
this.repair()
},
init:function(){
},
set:function(cfg){
Ext.apply(this,cfg);
delete cfg.start;
delete cfg.end
},
repair:function(){
},
destroy:function(){
},
toJSON:function(){
return[
this.start,
this.end,
this.toJSONConfig()
]
},
toJSONConfig:function(){
},
toOpenTag:function(){
},
toCloseTag:function(){
},
toCSS:function(){
},
getClass:function(){
},
getId:function(){
return this.id
},
getStart:function(){
return this.start
},
getEnd:function(){
return this.end
},
getText:function(){
var start=this.getStart();
return this.richtext.getText().substr(start,this.getEnd()-start)
},
setStart:function(start){
this.start=start
},
setEnd:function(end){
this.end=end
},
isFixed:function(){
return false
},
isCurrent:function(inclusive){
var richtext=this.richtext,s=richtext.getStart(),e=richtext.getEnd(),start=this.start,end=this.end;
return start<e&&end>s||start===s||this.endShift&&end===s&&s===e||inclusive&&start<=e&&end>=s
},
isEqual:function(aspect){
},
canJoin:function(aspect){
return this.isEqual(aspect)
},
getIndex:function(){
return this.aspects.indexOf(this)
},
prev:function(){
return this.aspects.itemAt(this.getIndex()-1)
},
next:function(){
return this.aspects.itemAt(this.getIndex()+1)
}
});
web.data.text.Style=Ext.extend(web.data.text.Aspect,{
type:'web.data.text.Style',
atype:'style',
init:function(){
this.style=null
},
set:function(cfg){
web.data.text.Style.superclass.set.call(this,cfg);
if(this.style){
this.style.set(cfg)
}else{
this.style=new web.data.styles.StyleText(cfg)
}
},
isEqual:function(aspect){
return this.style.getGlobalId()===aspect.style.getGlobalId()&&this.style.isEqual(aspect.style)
},
toCSS:function(doc){
return this.style.getCSSDeclarations(doc).replace(/\n/g,'').replace(/"/g,'\'')
},
getId:function(){
return this.style.getId()
},
getClass:function(doc){
var style=this.style,global=style.getGlobal(),cls=global?global.getCSSClass():'',size=style.size?style.size:global?global.size:null,maxSize;
if(doc.isMobile()&&size){
maxSize=global?{
'heading.1':40,
'heading.2':28,
'heading.3':24
}[global.ref]:20;
if(size>maxSize){
cls+=' mobile-oversized'
}
if(size<12){
cls+=' mobile-undersized-lower'
}
if(size<16){
cls+=' mobile-undersized-upper'
}
}
return cls
},
getOtherCss:function(){
return this.otherCss
},
toJSONConfig:function(){
return this.style.toJSON()
},
getHeadingTagName:function(){
var name='p',global=this.style.getGlobal(),regex=/^heading./,ref=global?global.getRef():'';
if(ref.match(regex)){
name='h'+ref.replace(regex,'')
}
return name
},
toOpenTag:function(doc){
var cls=this.getClass(doc),css=this.toCSS(doc),style=this.style,html='<span'+(cls&&!style.subscript&&!style.superscript?' class="'+cls+'"':'')+(css?' style="'+css+'"':'')+'>';
if(style.subscript||style.superscript){
html='<span '+(cls?' class="'+cls+'"':'')+'>'+html
}
return html
},
toOpenListTag:function(doc,startIndex,length){
var cls=this.getClass(doc),css=this.toCSS(doc),limitCss='text-decoration:none;text-shadow:none;',html='<li'+(cls?' class="'+cls+'"':'')+(css?' style="'+css+limitCss+'"':'');
if(Ext.isDefined(startIndex)&&Ext.isDefined(length)){
html+=' data-index="'+startIndex+'" data-length="'+length+'"'
}
html+='>';
return html
},
toCloseTag:function(){
var html='</span>',style=this.style;
if(style.subscript||style.superscript){
html+='</span>'
}
return html
},
getPart:function(){
return this.style
}
});
web.data.text.Styles=Ext.extend(web.data.text.Aspects,{
type:'web.data.text.Styles',
initAspect:function(cfg){
var parent=this.richtext.parent,extraCfg={
id:Math.uuid(),
parent:parent,
dm:parent.dm
};
if(cfg[2]){
cfg[2]=Ext.applyIf(cfg[2],extraCfg)
}else{
cfg=Ext.applyIf(cfg,extraCfg)
}
return cfg instanceof web.data.text.Style?cfg:new web.data.text.Style(cfg)
}
});
web.data.styles.StylePara=Ext.extend(web.data.styles.Style,{
type:'web.data.styles.StylePara',
height:null,
padding:null,
align:null,
indent:null,
indentSize:40,
bullet:null,
order:null,
constructor:function(config){
this.height=null;
this.padding=null;
this.align=null;
this.indent=null;
this.bullet=null;
this.order=null;
web.data.styles.StylePara.superclass.constructor.call(this,config);
this.clsPfx='para'
},
destroy:function(){
web.data.styles.StylePara.superclass.destroy.call(this);
if(this.padding!==null){
this.padding.destroy()
}
delete this.height;
delete this.padding;
delete this.align;
delete this.indent;
delete this.bullet;
delete this.order
},
set:function(opts){
var styleOpts=Ext.apply({},opts);
if(opts===null){
this.height=null;
this.padding=null;
this.align=null;
this.indent=null;
this.bullet=null;
this.order=null;
return
}
if(Ext.isNumber(styleOpts.indent)&&styleOpts.indent<=0){
styleOpts.indent=null
}
if(styleOpts.padding){
if(this.padding===null){
this.padding=new web.data.styles.FrameWidth({
edgeCSSProps:{
top:'padding-top',
right:'padding-right',
bottom:'padding-bottom',
left:'padding-left'
}
})
}
this.padding.set(styleOpts.padding);
delete styleOpts.padding
}
web.data.styles.StylePara.superclass.set.call(this,styleOpts)
},
getCSSSelector:function(){
return''
},
getCSSDeclarations:function(){
var css='',height=this.height,padding=this.padding,indent=this.indent,indentPx=indent?indent*this.indentSize:0;
if(padding!==null){
if(indentPx){
padding=padding.toJSON();
padding[3]+=indentPx;
padding=new web.data.styles.FrameWidth(padding)
}
css+=padding.getCSSDeclarations()
}
css+=height===null?'':'line-height:'+height+';\n';
if(this.align!==null){
css+='text-align:'+this.align+';\n'+(this.align==='justify'?'white-space: normal;':'')
}
if(indentPx&&padding===null){
css+='padding-left:'+indentPx+'px;\n'
}
if(indentPx&&this.bullet!==null){
css+='list-style-type:'+this.bullet+';\n'
}
return css
},
toJSON:function(){
var json=web.data.styles.StylePara.superclass.toJSON.call(this);
return Ext.apply(json,this.getSpecificJSON())
},
initDefaultStyles:function(){
this.set({})
},
getSpecificJSON:function(){
var json={};
if(this.height!==null){
json.height=this.height
}
if(this.padding){
json.padding=this.padding.toJSON()
}
if(this.align!==null){
json.align=this.align
}
if(this.indent!==null){
json.indent=this.indent
}
if(this.bullet!==null){
json.bullet=this.bullet
}
if(this.order!==null){
json.order=this.order
}
return json
},
isEqual:function(o){
return this.height===o.height&&(!this.padding&&!o.padding||this.padding&&o.padding&&this.padding.isEqual(o.padding))&&this.align===o.align&&this.indent===o.indent&&this.bullet===o.bullet&&this.order===o.order
},
canJoin:function(o){
return this.height===o.height&&(!this.padding&&!o.padding||this.padding&&o.padding&&this.padding.isEqual(o.padding))&&this.align===o.align&&this.indent===o.indent&&this.bullet===o.bullet&&(o.order===null||Ext.isNumber(this.order)&&this.order+1===o.order)
},
check:function(){
var types;
if(!web.data.styles.StylePara.superclass.check.call(this)){
one.debug('StylePara superclass not ok');
return false
}
if(this.height!==null&&(isNaN(this.height)||this.height<=0)){
one.debug('StylePara height not ok');
return false
}
if(this.padding!==null){
if(!(this.padding instanceof web.data.styles.FrameWidth)){
one.debug('StylePara padding not instantiated');
return false
}
if(!this.padding.check()){
one.debug('StylePara padding not ok');
return false
}
}
if(this.align!==null){
types=web.data.styles.StylePara.alignTypes;
if(types.indexOf(this.align)===-1){
one.debug('StylePara align not ok');
return false
}
}
if(this.indent!==null&&(isNaN(this.indent)||this.indent<0)){
one.debug('StylePara indent not ok');
return false
}
if(this.bullet!==null){
types=web.data.styles.StylePara.bulletTypes;
if(types.indexOf(this.bullet)===-1){
one.debug('StylePara bullet not ok');
return false
}
}
if(!(this.order===null||Ext.isNumber(this.order)&&this.order>0)){
one.debug('StylePara order not ok');
return false
}
return true
},
getHeight:function(){
return this.height
},
getPadding:function(){
return this.padding
},
getAlign:function(){
return this.align
},
getIndent:function(){
return this.indent
},
getBullet:function(){
return this.bullet
},
getOrder:function(){
return this.order
}
});
web.data.styles.StylePara.names=[
'paragraph',
'ordered',
'unordered'
];
web.data.styles.StylePara.alignTypes=[
'left',
'right',
'center',
'justify'
];
web.data.styles.StylePara.bulletTypes=[
'circle',
'disc',
'square',
'decimal',
'lower-alpha',
'lower-roman',
'upper-alpha',
'upper-roman'
];
web.data.text.Para=Ext.extend(web.data.text.Aspect,{
type:'web.data.text.Para',
atype:'para',
init:function(){
this.style=null
},
set:function(cfg){
web.data.text.Para.superclass.set.call(this,cfg);
if(this.style){
this.style.set(cfg)
}else{
this.style=new web.data.styles.StylePara(cfg)
}
},
isEqual:function(aspect){
return this.style.getGlobalId()===aspect.style.getGlobalId()&&this.style.isEqual(aspect.style)
},
canJoin:function(aspect){
return this.style.getGlobalId()===aspect.style.getGlobalId()&&this.style.canJoin(aspect.style)
},
getId:function(){
return this.style.getId()
},
getAlign:function(){
return this.style.getAlign()
},
getPadding:function(){
var padding=this.style.getPadding();
return padding?padding.toJSON():[
0,
0,
0,
0
]
},
getIndent:function(){
var indent=this.style.getIndent();
return indent?indent:0
},
getBullet:function(){
return this.style.getBullet()
},
getHeight:function(){
return this.style.getHeight()
},
getOrder:function(){
return this.style.getOrder()
},
toJSONConfig:function(){
return this.style.toJSON()
},
isList:function(){
return this.getIndent()&&this.getBullet()
},
isOrdered:function(){
return this.isList()&&[
'circle',
'disc',
'square'
].indexOf(this.getBullet())===-1
},
getSpacing:function(){
var t,r,b,l,p=this.getPadding(),i=this.getIndent();
p=p?p:[
0,
0,
0,
0
];
t=p[0];
r=p[1];
b=p[2];
l=p[3]+(i?i*40:0);
return t+r+b+l?[
t,
r,
b,
l
]:null
},
getLeftSpacing:function(para){
var l,p=para.getPadding(),i=para.getIndent();
p=p?p:[
0,
0,
0,
0
];
l=p[3]+(i?i*40:0);
return l
},
getTagName:function(){
return this.isList()?this.isOrdered()?'ol':'ul':'div'
},
getInnerTagName:function(){
var name='p',richtext,styles;
if(this.isList()){
name='li'
}else{
richtext=this.richtext;
richtext.next(this.start,this.end);
styles=richtext.styles.getCurrent();
richtext.prev();
if(styles.length===1){
name=styles[0].getHeadingTagName()
}
}
return name
},
toCSS:function(line){
var css='',i,align=this.getAlign(),spacing=this.getSpacing(),bullet=this.getBullet(),height=this.getHeight();
if(align&&align!=='left'){
css+='text-align:'+align+';'+(align==='justify'?'white-space: normal;':'')
}
if(height){
css+='line-height:'+height+';'
}
if(spacing){
css+='padding:';
for(i=0;i<4;i+=1){
css+=(i?' ':'')+spacing[i]+'px'
}
css+=';'
}
if(bullet){
css+='list-style-type:'+bullet+';'
}
return css
},
toOuterCSS:function(doc,leftSpacing){
var css='',align=this.getAlign(),spacing=this.getSpacing(),right=spacing?spacing[1]:0,left=spacing?spacing[3]:0,bullet=this.getBullet(),height=this.getHeight();
if(align&&align!=='left'){
css+='text-align:'+align+';'+(align==='justify'?'white-space: normal;':'')
}
if(height){
css+='line-height:'+height+';'
}
if(right||left&&!this.isList()){
css+='padding:0px '+right+'px 0px '+left+'px;'
}
if(leftSpacing){
css+='padding-left:'+leftSpacing+'px;'
}
if(bullet){
css+='list-style-type:'+bullet+';'
}
return css
},
toInnerCSS:function(doc){
var css='',spacing=this.getSpacing(),top=spacing?spacing[0]:0,bottom=spacing?spacing[2]:0;
if(top||bottom){
css+='padding:'+top+'px 0px '+bottom+'px 0px;'
}
return css
},
hasSpacing:function(){
var spacing=this.getSpacing();
return spacing&&(spacing[1]||spacing[3])
},
toOuterOpenTag:function(doc,continuedIndex,leftSpacing){
var css=this.toOuterCSS(doc,leftSpacing),hasStartIndex=this.isList()&&this.isOrdered()&&this.listIndex>=0,className=this.getTagName()==='div'&&this.hasSpacing()?'mb-indent':'';
if(this.getTagName()==='div'&&!css){
return''
}else{
return'<'+this.getTagName()+(className?' class="'+className+'"':'')+(css?' style="'+css+'"':'')+(hasStartIndex?' start="'+((continuedIndex||this.listIndex)+1)+'"':'')+'>'
}
},
toOuterCloseTag:function(doc){
var css=this.toOuterCSS(doc);
if(this.getTagName()==='div'&&!css){
return''
}else{
return'</'+this.getTagName()+'>'
}
},
toInnerOpenTag:function(doc,startIndex,length){
var css=this.toInnerCSS(doc),html='<'+this.getInnerTagName()+(css?' style="'+css+'"':'');
if(Ext.isDefined(startIndex)&&Ext.isDefined(length)){
html+=' data-index="'+startIndex+'" data-length="'+length+'"'
}
html+='>';
return html
},
toInnerCloseTag:function(){
return'</'+this.getInnerTagName()+'>'
},
getPart:function(){
return this.style
}
});
web.data.text.Paras=Ext.extend(web.data.text.Aspects,{
type:'web.data.text.Paras',
initAspect:function(cfg){
var extraCfg={
id:Math.uuid(),
parent:this.richtext.parent
};
if(cfg[2]){
cfg[2]=Ext.applyIf(cfg[2],extraCfg)
}else{
cfg=Ext.applyIf(cfg,extraCfg)
}
return cfg instanceof web.data.text.Para?cfg:new web.data.text.Para(cfg)
},
repair:function(){
this.sort();
this.forEach(function(o){
if(!this.isEnd(o.end)){
o.end-=1;
if(o.start<=o.end&&!this.isEnd(o.end)){
o.end=this.nextEnd(o.end)
}
}
},this);
this.repairClean();
for(var i=0;i<this.getCount();i+=1){
var o=this.itemAt(i);
if(!this.isStart(o.start)){
this.items.splice(i,1);
i-=1
}
}
this.repairLists();
this.repairJoin()
},
repairLists:function(){
var newLevel,oldLevel,listLevels=[],listIndex=0,listStart,text=this.richtext.text;
this.forEach(function(para){
var paraText,paraLineNum;
if(para.isOrdered()){
newLevel=para.getIndent();
listIndex=listLevels[newLevel];
listIndex=listIndex?listIndex:0;
listStart=para.getOrder();
listIndex=listStart?listStart-1:listIndex;
para.listIndex=listIndex;
paraText=text.substr(para.start,para.end-para.start);
paraLineNum=(paraText.match(/\n/g)||[]).length+1;
listIndex+=paraLineNum;
listLevels[newLevel]=listIndex;
if(newLevel<oldLevel){
listLevels[oldLevel]=0
}
oldLevel=newLevel
}
},this)
},
isEnd:function(index){
return this.richtext.isParaEndAt(index)
},
isStart:function(index){
return this.richtext.isParaAt(index)
},
prevStart:function(index){
return this.richtext.getParaStart(index)
},
nextEnd:function(index){
return this.richtext.getParaEnd(index)
},
applyAspect:function(para){
var richtext=this.richtext,start=richtext.getStart(),end=richtext.getEnd();
richtext.position(this.prevStart(start),this.nextEnd(end));
web.data.text.Paras.superclass.applyAspect.call(this,para);
richtext.position(start,end)
}
});
web.data.Action=Ext.extend(web.data.Part,{
type:'web.data.Action',
linkId:null,
link:null,
actionType:null,
style:null,
constructor:function(config){
if(!config){
throw new Error('Too few arguments')
}
this.linkId=null;
this.link=null;
this.actionType=web.data.Action.types.navigate;
this.style=null;
web.data.Action.superclass.constructor.call(this,config)
},
destroy:function(){
delete this.linkId;
delete this.link;
delete this.actionType;
delete this.style;
delete this.styleId
},
set:function(opts){
var nj=Ext.apply({},opts),styleOpt,linkOpt;
if(nj.style){
styleOpt=nj.style;
delete nj.style
}
if(nj.link){
linkOpt=nj.link;
delete nj.link
}
web.data.Action.superclass.set.call(this,nj);
if(styleOpt){
this.style=this.dm.create(Ext.apply({
dm:this.dm,
parent:this
},styleOpt))
}
if(linkOpt){
this.link=this.dm.create(Ext.apply({
dm:this.dm,
parent:this
},linkOpt))
}
},
isSet:function(){
return this.linkId||this.link
},
isEqual:function(action){
var link1=this.link,link2=action.link;
return this.linkId===action.linkId&&this.actionType===action.actionType&&(link1===link2||link1&&link2&&link1.isEqual(link2))
},
check:function(){
if(!this.linkId||typeof this.linkId!=='string'){
if(!this.link||!(this.link instanceof web.data.links.LinkExternal)){
return false
}
}
if(isNaN(this.actionType)||!web.data.Action.isType(this.actionType)){
return false
}
if(!this.style&&!this.styleId){
return false
}
if(this.style&&this.styleId){
return false
}
if(this.style&&(!(this.style instanceof web.data.styles.StyleLink)||!this.style.check())){
return false
}else if(this.styleId&&!Ext.isString(this.styleId)){
return false
}
return web.data.Action.superclass.check.call(this)
},
toJSON:function(){
var json=web.data.Action.superclass.toJSON.call(this);
if(this.linkId){
json.linkId=this.linkId
}else{
json.link=this.link.toJSON()
}
if(this.actionType!==web.data.Action.types.navigate){
json.actionType=this.actionType
}
if(this.style){
json.style=this.style.toJSON()
}
return json
},
getURL:function(doc){
var link=this.getLink(),url;
if(doc&&link){
url=link.getURL(doc);
if(/^webspace:/.test(url)){
url=url.replace(/^webspace:/,'http://'+doc.domain)
}
}else{
url=''
}
return url
},
getTarget:function(){
var typeToTarget;
typeToTarget=[
null,
'_blank'
];
return typeToTarget[this.actionType]
},
getLinkId:function(){
return this.linkId?this.linkId:this.link.getId()
},
getLink:function(){
return this.link?this.link:this.dm.get(this.linkId)
},
getActionType:function(){
return this.actionType
},
getStyle:function(){
return this.style
},
getStyleId:function(){
return this.style?this.style.id:null
}
});
web.data.Action.types={
navigate:0,
open:1
};
web.data.Action.isType=function(n){
var nm;
if(isNaN(n)){
return false
}
for(nm in web.data.Action.types){
if(web.data.Action.types[nm]===n){
return true
}
}
return false
};
web.utils.String={
ellipsis:function(str,limit){
limit=limit||12;
return str.length<=limit?str:str.substring(0,limit-3)+'...'
},
endsWith:function(str,suffix){
return str.indexOf(suffix,str.length-suffix.length)!==-1
},
formatLink:function(linkName){
if(!/^(https?:\/\/[^\/]+)(.*)$/.test(linkName)){
linkName=linkName.split('/');
linkName=linkName[linkName.length-1]
}else{
linkName=linkName.replace(/^(https?:\/\/)(www\.)?/,'')
}
return this.ellipsis(linkName.replace('mailto:',''))
},
trimAllExtraWhitespaces:function(str,replaceWith){
return(str||'').trim().replace(/\s+/g,replaceWith||' ')
},
stripTags:function(str){
return str.replace(/(<([^>]+)>)/gi,'')
},
naturalCompare:function(a,b){
var ax=[],bx=[];
a.replace(/(\d+)|(\D+)/g,function(_,$1,$2){
ax.push([
$1||Infinity,
$2||''
])
});
b.replace(/(\d+)|(\D+)/g,function(_,$1,$2){
bx.push([
$1||Infinity,
$2||''
])
});
while(ax.length&&bx.length){
var an=ax.shift();
var bn=bx.shift();
var nn=an[0]-bn[0]||an[1].localeCompare(bn[1]);
if(nn){
return nn
}
}
return ax.length-bx.length
},
isExternal:function(href){
var external=false,hostname=href&&href.hostname?href.hostname:null,link=document.createElement('a');
if(!href){
return false
}
if(hostname===null){
link.href=href;
hostname=link.hostname
}
link.href=window.location.href;
if(href&&hostname!==link.hostname){
if(href.search(/^(?:mailto:.*|javascript:.*|sms:.*|tel:.*)|(api\/).*/)===-1){
external=true
}
}
return external
}
};
web.data.text.Link=Ext.extend(web.data.text.Aspect,{
type:'web.data.text.Link',
atype:'link',
init:function(){
this.action=null
},
set:function(cfg){
web.data.text.Link.superclass.set.call(this,cfg);
if(this.action){
this.action.set(cfg)
}else{
this.action=new web.data.Action(cfg)
}
},
isEqual:function(linkAspect){
return linkAspect&&this.action.isEqual(linkAspect.action)
},
toJSONConfig:function(){
return this.action.toJSON()
},
getId:function(){
return this.action.getId()
},
getClass:function(){
return this.action.getStyle().getCSSClass()
},
getHref:function(doc){
return this.action.getURL(doc)
},
getTarget:function(){
return this.action.getTarget()
},
toOpenTag:function(doc){
var baseCls=this.richtext.getBaseCls(),cls=baseCls+'link '+this.getClass(),href=this.getHref(doc),target=this.getTarget();
return doc.editMode?'<span class="'+cls+'">':function(){
var str='<a class="'+cls+'" href="'+(href||'javascript:void(0);')+'"';
str+=target?' target="'+target+'"':'';
var useStopPropagationInPreviewMode=true;
if(doc.previewMode){
if(href){
if(document.createElement&&web.utils.String.isExternal(href)){
useStopPropagationInPreviewMode=false;
str+=' title="'+'External links do not work when previewing. Please publish your site to test this link.'+'"'
}
}else{
str+=' title="'+'Broken link.'+'"'
}
}
if(useStopPropagationInPreviewMode){
str+=this.parent.inImageWithLink()?' onclick="event.stopPropagation();"':''
}
str+='>';
return str
}.call(this)
},
toCloseTag:function(doc){
return doc.editMode?'</span>':'</a>'
},
getPart:function(){
return this.action
}
});
web.data.text.Links=Ext.extend(web.data.text.Aspects,{
type:'web.data.text.Links',
initAspect:function(cfg){
var extraCfg={
id:Math.uuid(),
parent:this.richtext.parent
};
if(cfg[2]){
cfg[2]=Ext.applyIf(cfg[2],extraCfg)
}else{
cfg=Ext.applyIf(cfg,extraCfg)
}
return cfg instanceof web.data.text.Link?cfg:new web.data.text.Link(cfg)
},
repair:function(){
web.data.text.Links.superclass.repair.call(this);
var aspect1,aspect2;
for(var i=1,len=this.items.length;i<len;i+=1){
aspect1=this.items[i-1];
aspect2=this.items[i];
if(aspect1.getEnd()===aspect2.getStart()&&aspect1.isEqual(aspect2)){
aspect1.setEnd(aspect2.getEnd());
this.items.splice(i,1);
i-=1;
len-=1
}
}
}
});
web.data.text.Cell=Ext.extend(web.data.text.Aspect,{
type:'web.data.text.Cell',
atype:'cell',
endShift:false,
init:function(){
},
set:function(cfg){
var newCfg=Ext.apply({},cfg),styleCfg;
if(cfg.parent){
this.parent=cfg.parent
}
if(cfg.style){
styleCfg=cfg.style;
delete newCfg.style
}
web.data.text.Cell.superclass.set.call(this,newCfg);
if(styleCfg){
styleCfg.parent=this.richtext.parent;
if(this.style){
this.style.set(styleCfg)
}else{
styleCfg.id=Math.uuid();
this.style=this.richtext.parent.dm.create(styleCfg)
}
}
},
toJSONConfig:function(){
return{
colIndex:this.getColIndex(),
rowIndex:this.getRowIndex(),
flexWidth:this.getFlexWidth(),
minHeight:this.getMinHeight(),
style:this.style.toJSON()
}
},
toOpenTag:function(doc){
var cls=this.getClass(doc),style=this.getStyle(doc),attributes=this.getAttr(doc);
return'<td'+(cls?' class="'+cls+'"':'')+(style?' style="'+style+'"':'')+attributes+'>'
},
toCloseTag:function(){
return'</td>'
},
toTableOpenTag:function(){
var row=this.getTableRows()[0],flex,flexs=[],flexTotal=0,width,widthTotal=this.richtext.getWidth(),widthOther=0,result='<table class="'+this.richtext.getBaseCls()+'table" style="width:'+widthTotal+'px;">';
row.forEach(function(cell){
flex=cell.getFlexWidth();
flexs.push(flex);
flexTotal+=flex
},this);
if(flexTotal===0){
width=widthTotal/row.length;
row.forEach(function(row){
result+='<col width="'+width+'"/>'
})
}else{
flexs.forEach(function(flex,index){
if(index!==row.length-1){
width=Math.round(flex/flexTotal*widthTotal);
widthOther+=width
}else{
width=widthTotal-widthOther-1
}
result+='<col width="'+width+'"/>'
},this)
}
return result
},
toTableCloseTag:function(){
return'</table>'
},
toRowOpenTag:function(){
return'<tr>'
},
toRowCloseTag:function(){
return'</tr>'
},
getPercentWidth:function(){
var row=this.getTableRows()[0],total=0;
row.forEach(function(cell){
total+=cell.getFlexWidth()
},this);
return Math.round(this.flexWidth/total*10000)/100
},
getWidth:function(){
var row=this.getTableRows()[0],widthTotal=this.richtext.getWidth(),flexTotal=0,widthOther=0;
if(this.isRowEnd()){
row.forEach(function(cell){
if(cell.getColIndex()!==this.getColIndex()){
widthOther+=cell.getWidth()
}
},this);
return widthTotal-widthOther
}else{
row.forEach(function(cell){
flexTotal+=cell.getFlexWidth()
},this);
return Math.round(this.flexWidth/flexTotal*widthTotal)
}
},
getInnerWidth:function(){
var width=this.getWidth(),padding=this.getPadding();
return width-padding[1]-padding[3]-1-(this.getColIndex()?0:1)
},
getMinInnerHeight:function(){
var height=this.getMinHeight(),padding=this.getPadding();
return height-padding[0]-padding[2]-1
},
getPadding:function(){
var global=this.style.getGlobal(),globalPadding=global?global.getBlock().getPadding().toJSON():null,stylePadding=this.style.getBlock().getPadding().toJSON(),padding=stylePadding?stylePadding:globalPadding;
return padding?padding:[
0,
0,
0,
0
]
},
getBorderWidth:function(){
var global=this.style.getGlobal(),globalBorder=global?global.getBlock().getBorder():null,globalWidth=globalBorder?globalBorder.getWidth().toJSON():null,styleBorder=this.style.getBlock().getBorder(),styleWidth=styleBorder?styleBorder.getWidth().toJSON():null,width=styleWidth?styleWidth:globalWidth;
return width?width:[
0,
0,
0,
0
]
},
getSpacing:function(){
var p=this.getPadding(),b=this.getBorderWidth(),r=[];
p.forEach(function(pi,i){
r.push(pi+Math.round(b[i]/2))
});
return r
},
getStyle:function(doc){
return this.style?this.style.getCSSDeclarations(doc).replace(/\n/g,'').replace(/"/g,'\''):''
},
getAttr:function(){
var height=this.colIndex?null:this.getMinInnerHeight();
return height?' height="'+height+'px"':''
},
getClass:function(doc){
return this.style?this.style.getCSSClass(doc):''
},
getVerticalAlign:function(){
var style=this.style,global=style?style.getGlobal():null,valign=style?style.getVerticalAlign():null;
return valign?valign:global?global.getVerticalAlign():'top'
},
getHorizontalAlign:function(){
var style=this.style,global=style?style.getGlobal():null,halign=style?style.getHorizontalAlign():null;
return halign?halign:global?global.getHorizontalAlign():'left'
},
getMinHeight:function(){
return this.minHeight
},
getFlexWidth:function(){
return this.flexWidth
},
getRowIndex:function(){
return this.rowIndex
},
getColIndex:function(){
return this.colIndex
},
isTableStart:function(){
return this.getColIndex()===0&&this.getRowIndex()===0
},
isTableEnd:function(){
var next=this.next();
return!next||next.isTableStart()
},
isRowStart:function(){
return this.getColIndex()===0
},
isRowEnd:function(){
var next=this.next();
return!next||next.isRowStart()
},
getTableStart:function(){
var that=this;
while(!that.isTableStart()){
that=that.prev()
}
return that
},
getTableEnd:function(){
var that=this;
while(!that.isTableEnd()){
that=that.next()
}
return that
},
getTableCells:function(){
var start=this.getTableStart().getIndex(),end=this.getTableEnd().getIndex(),cells=[],i,items=this.aspects.items;
for(i=start;i<=end;i+=1){
cells.push(items[i])
}
return cells
},
getTableRows:function(){
var cells=this.getTableCells(),rows=[],row;
cells.forEach(function(cell){
row=rows[cell.rowIndex];
row=row?row:[];
row[cell.colIndex]=cell;
rows[cell.rowIndex]=row
},this);
return rows
},
getTableCols:function(){
var cells=this.getTableCells(),cols=[],col;
cells.forEach(function(cell){
col=cols[cell.colIndex];
col=col?col:[];
col[cell.rowIndex]=cell;
cols[cell.colIndex]=col
},this);
return cols
},
getStyleCell:function(){
return this.style
},
getPart:function(){
return this
}
});
web.data.text.Cells=Ext.extend(web.data.text.Aspects,{
type:'web.data.text.Cells',
endShift:false,
initAspect:function(cfg){
var extraCfg={
id:Math.uuid(),
parent:this.richtext.parent
};
if(cfg[2]){
cfg[2]=Ext.applyIf(cfg[2],extraCfg)
}else{
cfg=Ext.applyIf(cfg,extraCfg)
}
return cfg instanceof web.data.text.Cell?cfg:new web.data.text.Cell(cfg)
},
toJSON:function(){
var json=[];
this.forEach(function(cell){
json.push(cell.toJSON())
});
return json
},
removeInvalidCells:function(){
var items=this.items,i,item;
for(i=items.length-1;i>=0;i-=1){
item=items[i];
if(item.start===item.end){
items.splice(i,1);
one.fatal('Fixed during migration 0026 - This should never happen again')
}
}
},
repairRowColIndexes:function(){
var last,next=this.items[0];
while(next){
if(last&&last.end<next.start){
last=null
}
if(!last){
next.rowIndex=0;
next.colIndex=0
}else if(last&&last.end>=next.start){
next.rowIndex=last.rowIndex+(next.colIndex===0?1:0);
next.colIndex=next.rowIndex>last.rowIndex?0:last.colIndex+1
}
last=next;
next=next.next()
}
},
repair:function(){
this.removeInvalidCells();
this.repairRowColIndexes()
},
getCurrentRow:function(){
var i,end,cell,cells=this.getCurrent(),rows=[],firstCell=cells[0],lastCell=cells[cells.length-1];
if(!firstCell){
return[]
}
while(!firstCell.isRowStart()){
firstCell=this.items[firstCell.getIndex()-1]
}
while(!lastCell.isRowEnd()){
lastCell=this.items[lastCell.getIndex()+1]
}
cells=[];
for(i=firstCell.getIndex(),end=lastCell.getIndex();i<=end;i+=1){
cell=this.items[i];
cells.push(cell);
if(cell.isRowEnd()){
rows.push(cells);
cells=[]
}
}
return rows
},
getCurrentCol:function(){
var i,end,cell,index,cellColIndex,cells=this.getCurrent(),cols=[],firstColIndex=0,lastColIndex=null,firstCell=cells[0],lastCell=cells[cells.length-1];
if(!firstCell){
return[]
}
if(firstCell.getRowIndex()===lastCell.getRowIndex()){
firstColIndex=firstCell.getColIndex();
lastColIndex=lastCell.getColIndex()
}
for(i=0,end=this.getCount()-1;i<=end;i+=1){
cell=this.items[i];
cellColIndex=cell.getColIndex();
if(firstColIndex<=cellColIndex&&(lastColIndex===null||cellColIndex<=lastColIndex)){
index=cellColIndex-firstColIndex;
if(!cols[index]){
cols[index]=[]
}
cols[index].push(cell)
}
}
return cols
},
getTableRows:function(){
var result=[[]],cells=this.getCurrent(),firstCell=cells[0],lastCell=cells[cells.length-1];
if(firstCell&&lastCell){
this.richtext.next(firstCell.getTableStart().getStart(),lastCell.getTableEnd().getEnd());
result=this.getCurrentRow();
this.richtext.prev()
}
return result
},
getTableCols:function(){
var result,cells=this.getCurrent(),firstCell=cells[0],lastCell=cells[cells.length-1];
this.richtext.next(firstCell.getTableStart().getStart(),lastCell.getTableEnd().getEnd());
result=this.getCurrentCol();
this.richtext.prev();
return result
},
getRows:function(){
var result;
this.richtext.next(0,this.richtext.getText().length);
result=this.getCurrentRow();
this.richtext.prev();
return result
},
getCols:function(){
var result;
this.richtext.next(0,this.richtext.getText().length);
result=this.getCurrentCol();
this.richtext.prev();
return result
},
insertTable:function(cfg){
var richtext=this.richtext,text='',i,j,cellCfg=cfg.cellCfg,start,next;
start=next=0;
this.suspendRepair();
cellCfg=cellCfg?cellCfg:{};
for(i=0;i<cfg.rows;i+=1){
for(j=0;j<cfg.cols;j+=1){
text+=j!==cfg.cols-1?'	':'\n'
}
}
richtext.insertText(text,start);
for(i=0;i<cfg.rows;i+=1){
for(j=0;j<cfg.cols;j+=1){
cellCfg.rowIndex=i;
cellCfg.colIndex=j;
cellCfg.flexWidth=cellCfg.flexWidth?cellCfg.flexWidth:1;
cellCfg.minHeight=cellCfg.minHeight?cellCfg.minHeight:20;
cellCfg.padding=cellCfg.padding?cellCfg.padding:[
3,
3,
3,
3
];
this.add([
next,
next+1,
cellCfg
]);
next+=1
}
}
this.resumeRepair()
},
insertRow:function(){
var richtext=this.richtext,row=this.getCurrentRow()[0],cellIndex=row[0].getIndex()+row.length,start=row[row.length-1].getEnd(),cfg;
this.suspendRepair();
this.rows+=1;
row.forEach(function(cell,index){
cfg=cell.toJSONConfig();
cfg=cfg?cfg:{};
cfg.start=start;
cfg.end=start+1;
cfg.rowIndex+=1;
richtext.next(start-1);
richtext.disableEndShift();
richtext.insert(!index?'\n':'	',start-1);
richtext.enableEndShift();
richtext.prev();
this.items[cellIndex-1].end-=1;
this.insert(cellIndex,cfg);
start+=1;
cellIndex+=1
},this);
this.resumeRepair()
},
insertCol:function(){
var richtext=this.richtext,col=this.getCurrentCol()[0],start,cfg;
this.suspendRepair();
this.cols+=1;
col.forEach(function(cell){
start=cell.getEnd();
cfg=cell.toJSONConfig();
cfg=cfg?cfg:{};
cfg.start=start;
cfg.end=start+1;
cfg.colIndex+=1;
richtext.next(start-1);
richtext.disableEndShift();
richtext.insert('	',start-1);
richtext.enableEndShift();
richtext.prev();
cell.end-=1;
this.insert(cell.getIndex()+1,cfg)
},this);
this.resumeRepair()
},
deleteRow:function(){
var richtext=this.richtext,row=this.getCurrentRow()[0],start=row[0].getStart(),end=row[row.length-1].getEnd();
richtext.remove(start,end);
this.repair()
},
deleteCol:function(){
var richtext=this.richtext,col=this.getCurrentCol()[0],next,start,end;
col.forEach(function(cell){
if(cell.colIndex===0){
next=this.items[cell.getIndex()+1];
next.colIndex=0
}
start=cell.getStart();
end=cell.getEnd();
richtext.remove(start,end)
},this);
this.repair()
},
applyCell:function(cfg){
var newCfg=Ext.apply({},cfg),currentCells=this.getCurrent();
if(cfg.flexWidths){
this.getCols().forEach(function(col,index){
col.forEach(function(cell){
cell.set({flexWidth:cfg.flexWidths[index]})
},this)
},this)
}
if(cfg.minHeight){
this.getCurrentRow().forEach(function(row){
row.forEach(function(cell){
cell.set({minHeight:cfg.minHeight})
},this)
},this);
delete newCfg.minHeight
}
currentCells.forEach(function(cell){
cell.set(newCfg)
},this)
}
});
web.data.text.HtmlWriter=Ext.extend(Object,{
constructor:function(cfg){
this.richtext=null;
if(cfg){
this.set(cfg)
}
},
set:function(cfg){
Ext.apply(this,cfg)
},
startParaTagName:null,
getParaTagName:function(doc,startIndex,length,para,style){
var name='p';
if(style&&style.end>=startIndex+length-1){
name=style.getHeadingTagName()
}
this.startParaTagName=name;
return name
},
getParaOpenTag:function(doc,startIndex,length,para,style){
var innerCss=para?para.toInnerCSS():'',styleAttr=innerCss?' style="'+innerCss+'"':'',name=this.getParaTagName(doc,startIndex,length,para,style);
return'<'+name+styleAttr+(!doc||doc.editMode?' data-index="'+startIndex+'" data-length="'+length+'"':'')+'>'
},
getParaCloseTag:function(){
return'</'+(this.startParaTagName||'p')+'>'
},
getIndexToBlocksLookup:function(text){
var id=text.id,items=text.getAllItems(),blocks={};
items.forEach(function(item){
var relPara=item.getRelPara();
if(item.relIn&&item.relIn.id===id&&relPara&&!item.isGhost()){
blocks[relPara.index]=blocks[relPara.index]||[];
blocks[relPara.index].push(item)
}
},this);
return blocks
},
getBlockRegion:function(block,para){
var bbox=block.getRelInBBox(),region;
if(para&&para.isList()&&block.isWrap()){
bbox.left-=para.getSpacing()[3]
}
region=new Ext.lib.Region(bbox.top,bbox.right,bbox.bottom,bbox.left);
region.top=block.relPara.offset;
region.bottom=region.top+block.getHeight();
var relPara=block.getRelPara();
if(relPara.row!==undefined){
var width=region.right-region.left,relCol=block.getRelParaCol(),cell=block.getRelParaCell(),spacing=cell.getSpacing();
region.left=relCol.left-spacing[3];
region.right=region.left+width-spacing[3]
}
return region
},
getIndents:function(text,index,indexToBlocksLookup,para){
var blocks=indexToBlocksLookup[index]||[],indent,width=text.getWidth(),widthThird,centerRange,indents=[];
if(!blocks.length){
return indents
}
if(text instanceof web.data.components.Table){
var cell=blocks[0].getRelParaCell(),spacing=cell.getSpacing();
width=cell.getWidth()-spacing[3]-spacing[1]
}
widthThird=Math.floor(width/3);
centerRange=[
widthThird,
width-widthThird
];
blocks.sort(function(a,b){
return a.relPara.offset-b.relPara.offset
});
blocks.forEach(function(block){
var region=this.getBlockRegion(block,para),node={
component:block,
region:region
};
region=new Ext.lib.Region(region.top,region.right,region.bottom,region.left);
if(!indent||!(region.left<indent.region.right&&indent.region.left<region.right)){
indent={
nodes:[node],
region:region
};
indents.push(indent)
}else{
indent.nodes.push(node);
indent.region=indent.region.union(region)
}
},this);
var lastLeft,lastRight;
indents.forEach(function(indent){
var region=indent.region;
region.height=region.bottom-region.top;
region.cx=Math.round((region.left+region.right)/2);
region.cy=Math.round((region.top+region.bottom)/2);
if(region.cx<centerRange[0]){
region.left=0;
region.align='left';
region.top=lastLeft?lastLeft.bottom:0;
lastLeft=region
}else if(region.cx>centerRange[1]){
region.right=width;
region.align='right';
region.top=lastRight?lastRight.bottom:0;
lastRight=region
}else{
region.top=0;
region.left=0;
region.right=width;
region.align='center';
lastLeft=lastRight=region
}
},this);
indents.forEach(function(indent){
var region=indent.region;
region.width=region.right-region.left;
region.height=region.bottom-region.top
});
return indents
},
renderIndents:function(doc,indents,paraIndex,onIndent,para,block){
var noAlign;
if(indents.length){
if(para&&block&&block.length&&para.isList()&&block[0].isWrap()){
noAlign=true
}
indents.forEach(function(indent,index){
var region=indent.region;
doc.appendToBody('<div class="textblock textblock'+(noAlign?'':region.align)+'" style="'+'width:'+region.width+'px;'+'height:'+region.height+'px;'+'" '+(!index&&doc.editMode?'data-paraindex="'+paraIndex+'" ':'')+'>');
if(onIndent){
onIndent(indent)
}
doc.appendToBody('</div>')
})
}
},
write:function(doc,onIndent){
var para,style,link,selection,cell,table,isList,last,hasIndents,segments=this.segment(),richtext=this.richtext,html='',len=segments?segments.length:0,prevParaSeg=null,listStack=[];
var indexToBlocksLookup=this.getIndexToBlocksLookup(richtext.parent);
segments.forEach(function(seg,index){
var s=seg.start,e=seg.end,indents=[],empty,tmpArr,diff,leftSpacing=null;
if(s.cell){
cell=s.cell;
if(s.table){
table=s.table;
html+=cell.toTableOpenTag(doc)
}
if(s.row){
html+=cell.toRowOpenTag(doc)
}
html+=cell.toOpenTag(doc)
}
if(s.style){
style=s.style
}
if(s.link){
link=s.link
}
if(s.selection){
selection=s.selection
}
if(s.p){
indents=this.getIndents(richtext.parent,s.p.index,indexToBlocksLookup,para);
if(indents.length){
if(para&&para.getTagName()==='div'){
html+=para.toOuterCloseTag(doc)
}
hasIndents=true;
doc.appendToBody(html);
this.renderIndents(doc,indents,s.p.index,onIndent,para,indexToBlocksLookup[s.p.index]);
html='';
if(para&&para.getTagName()==='div'){
html+=para.toOuterOpenTag(doc)
}
}
}
if(s.para){
para=s.para;
isList=para.isList();
if(isList&&prevParaSeg){
if(seg.depth===1){
html+=listStack.length>0?listStack.join(''):'';
listStack.length=0
}else if(seg.depth<prevParaSeg.depth){
diff=(prevParaSeg.depth-seg.depth)*2+1;
if(listStack.length>diff){
tmpArr=listStack.splice(listStack.length-1-diff);
html+=tmpArr.join('');
tmpArr=null
}else{
html+=listStack.length>0?listStack.join(''):'';
listStack.length=0
}
}
}else{
html+=listStack.length>0?listStack.join(''):'';
listStack.length=0
}
if(isList&&seg.depth===1){
leftSpacing=para.getIndent()>1?para.getLeftSpacing(para):null
}
html+=para.toOuterOpenTag(doc,para.continuedIndex?para.continuedIndex.shift():undefined,leftSpacing);
prevParaSeg=seg
}else if(listStack.length){
html+=listStack.join('')
}
if(s.p){
if(isList){
if(style){
html+=style.toOpenListTag(doc,seg.startIndex,seg.length)
}else{
html+=para.toInnerOpenTag(doc,seg.startIndex,seg.length)
}
}else{
html+=this.getParaOpenTag(doc,seg.startIndex,seg.length,para,style)
}
}
empty=!(seg.text||s.p&&e.p&&!indents.length&&table!==null);
if(!empty){
html+=style?style.toOpenTag(doc):'<span>'
}
if(link&&!empty){
html+=link.toOpenTag(doc)
}
if(selection&&!empty){
html+='<span class="one-rte-selection">'
}
if(seg.text){
html+=seg.text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
}else if(s.p&&e.p&&!indents.length){
if(table!==null){
html+='&nbsp;'
}
}else if(cell&&empty){
html+='<span>&nbsp;</span>'
}
if(selection&&!empty){
html+='</span>'
}
if(link&&!empty){
html+=link.toCloseTag(doc)
}
if(!empty){
html+=style?style.toCloseTag():'</span>'
}
if(e.p){
if(para&&isList){
if(e.para){
listStack.push(para.toInnerCloseTag())
}else{
html+=para.toInnerCloseTag()
}
}else{
html+=this.getParaCloseTag()
}
}
if(e.para&&para){
if(listStack.length){
listStack.push(para.toOuterCloseTag(doc))
}else{
html+=para.toOuterCloseTag(doc)
}
para=null;
isList=false
}
if(e.selection){
selection=null
}
if(e.link){
link=null
}
if(e.style){
style=null
}
if(e.cell&&cell){
html+=cell.toCloseTag();
if(e.row){
html+=cell.toRowCloseTag()
}
if(e.table){
html+=cell.toTableCloseTag();
table=null
}
cell=null
}
last=seg;
if(listStack.length>0&&index===len-1){
html+=listStack.join('');
listStack.length=0
}
},this);
var paraIndex=richtext.parent.getParagraphCount(),indents=this.getIndents(richtext.parent,paraIndex,indexToBlocksLookup);
if(indents.length){
doc.appendToBody(html);
this.renderIndents(doc,indents,paraIndex,onIndent);
html=''
}
if(hasIndents||richtext.cells.getCount()){
html+='<div class="'+richtext.getBaseCls()+'end"></div>'
}
if(html){
doc.appendToBody(html);
html=''
}
},
isValidHtml:function(){
function unwrap(arr){
var val,o={};
while(val=arr.pop()){
o[val]=true
}
return o
}
return function(html){
var tagRegEx=new RegExp('[^<]*?<([!\\-\\[\\]/\\w]+)([^>]*?)>(.*)',''),closeableTags=[
'html',
'head',
'body',
'style',
'script',
'div',
'span',
'a',
'p',
'table',
'tbody',
'tr',
'td',
'iframe',
'footer',
'ul',
'ol',
'li',
'title',
'h1',
'h2',
'h3',
'h4',
'h5',
'h6',
'noscript',
'form',
'label',
'textarea',
'ifNotIE',
'ifIE'
],selfclosing=[
'img',
'meta',
'link',
'br',
'hr',
'input',
'col'
],level=0,trace='';
closeableTags=unwrap(closeableTags);
selfclosing=unwrap(selfclosing);
var tag,str=html.replace(/[\r\n]/g,''),matches,closeTag,stack=[],rawTag,lastTag,broken=false;
while(str&&!!(matches=str.match(tagRegEx))){
tag=rawTag=matches[1];
str=matches[3];
if(tag[0]==='/'){
closeTag=true;
tag=tag.substr(1)
}else{
closeTag=false
}
if(tag[0]==='!'){
continue
}else if(!(closeableTags[tag]||selfclosing[tag])){
one.debug('Unidentified tag: '+rawTag);
continue
}else if(selfclosing[tag]){
continue
}
if(closeTag){
level-=1
}
if(level<0){
trace+=(closeTag?'</':'<')+tag+matches[2]+'>\n';
one.debug('Extra end tag found: '+rawTag);
broken=true;
break
}
trace+=new Array(4*level+1).join(' ')+(closeTag?'</':'<')+tag+matches[2]+'>\n';
if(!closeTag){
level+=1
}
if(!closeTag){
stack.push(tag)
}else{
lastTag=stack[stack.length-1];
if(lastTag!==tag){
one.debug('End tag for '+lastTag+' not found, instead found '+rawTag);
broken=true;
break
}
stack.pop()
}
}
broken=broken||stack.length>0;
if(broken){
one.debug(trace);
one.debug('html is unbalanced')
}else{
one.debug('html is balanced')
}
return!broken
}
}(),
segment:function(){
var chr,point,isN,isSpecial,i,len,openPTag=false,richtext=this.richtext,text=richtext.text,points=this.getAspectPoints(),pIndex=0,segments=[],seg,prevSeg={},selection=this.selection,selStart,selEnd;
if(selection){
selStart=richtext.getStart();
selEnd=richtext.getEnd();
selection=selStart<selEnd
}
for(i=0,len=text.length;i<=len+1;i+=1){
chr=text.substr(i,1);
point=points[i];
if(!i||i===len+1||points[i]||isSpecial||selection&&(i===selStart||i===selEnd)){
if(i){
if(point){
seg.end=point.end
}
if(openPTag&&(i===len+1||isN||point&&point.end.p)){
seg.end.p=true;
openPTag.length=i-openPTag.startIndex;
if(i===len&&!isN&&!this.richtext.isTable()){
openPTag.length+=1
}
openPTag=false
}
if(selection&&i===selEnd){
seg.end.selection=true
}
seg.endIndex=i-seg.startIndex;
segments.push(seg);
prevSeg=seg
}
if(i<=len){
seg={
startIndex:i,
text:'',
start:{},
end:{}
};
if(point){
seg.start=point.start;
seg.depth=point.end.depth
}
seg.depth=seg.depth||prevSeg.depth;
if(!i||isN||point&&point.start.p){
seg.start.p={index:pIndex};
pIndex+=1;
openPTag=seg
}
if(selection&&i===selStart){
seg.start.selection=true
}
}
}
isN=chr==='\n';
isSpecial=isN||chr==='	';
seg.text+=isSpecial?'':chr
}
return segments
},
getAspectPoints:function(){
var points=this.getRawAspectPoints(),indices=[],open={};
Ext.iterate(points,function(key){
indices.push(parseInt(key,10))
});
indices.sort(function(a,b){
return a-b
});
indices.forEach(function(index){
var point=points[index];
for(var x in point.end){
if(point.end.hasOwnProperty(x)&&open[x]){
delete open[x]
}
}
Ext.apply(open,point.start);
this.cellSplitPoints(point,open);
this.paraSplitPoints(point,open)
},this);
return points
},
getRawAspectPoints:function(){
var richtext=this.richtext,atypes=richtext.atypes,points={};
atypes.forEach(function(type){
var aspects=richtext[type];
aspects.repair();
aspects.forEach(function(aspect){
var start=aspect.start,end=aspect.end,point,diff,depth=1;
if(aspect.endShift&&richtext.isParaEndAt(end)){
end+=1
}else if(aspect.start===aspect.end){
return
}
point=points[start]||{
start:{},
end:{}
};
point.start[aspect.atype]=aspect;
points[start]=point;
point=points[end]||{
start:{},
end:{}
};
point.end[aspect.atype]=aspect;
points[end]=point;
if(aspect.atype==='para'&&aspect.isList()){
if(points[start].end.para&&points[start].end.depth){
if(start-points[start].end.para.end===1){
depth=points[start].end.depth
}
if(aspect.indent<points[start].end.para.indent){
depth=points[start].end.depth-(points[start].end.para.indent-aspect.indent)
}else if(aspect.indent>points[start].end.para.indent){
diff=aspect.indent-points[start].end.para.indent;
depth=diff>1?1:points[start].end.depth+1
}
depth=depth<1?1:depth
}
points[start].end.depth=points[end].end.depth=depth
}
})
});
return points
},
cellSplitPoints:function(point,open){
if(point.end.cell){
if(point.end.cell.isTableEnd()){
point.end.table=true
}
if(point.end.cell.isRowEnd()){
point.end.row=true
}
if(open.para){
point.end.para=open.para
}
point.end.p=true
}
if(point.start.cell){
if(point.start.cell.isTableStart()){
point.start.table=true
}
if(point.start.cell.isRowStart()){
point.start.row=true
}
if(open.para){
point.start.para=open.para
}
point.start.p=true
}
},
paraSplitPoints:function(point,open){
var paraStart=point.start.para;
if(point.end.para){
point.end.p=true
}
if(paraStart){
point.start.p=true
}
if(paraStart&&paraStart.isOrdered()){
if(!open.para.continuedIndex||!open.para.continuedIndex.length){
open.listCount=0;
open.para.continuedIndex=[open.para.listIndex]
}else{
open.para.continuedIndex.push(open.para.listIndex+open.listCount)
}
}
if(Ext.isDefined(open.listCount)&&point.start.p){
open.listCount+=1
}
}
});
Ext.ns('web.data.text.utils');
web.data.text.utils.Remover=Ext.extend(Object,{
constructor:function(richtext){
this.richtext=richtext
},
remove:function(start,end){
var richtext=this.richtext,t=richtext.text;
richtext.text=t.substr(0,start)+t.substr(end,t.length);
richtext.shift(start,start-end);
richtext.paras.repair()
},
removeText:function(start,end){
var richtext=this.richtext,negs={},segs=[],seg,i;
if(richtext.replaceMode){
richtext.storeStash()
}
richtext.cells.forEach(function(cell){
negs[cell.end-1]=true
},this);
for(i=start;i<=end;i+=1){
if(seg&&(negs[i]||end===i)){
seg[1]=i;
segs.push(seg);
seg=null;
i+=1
}
if(!seg&&!negs[i]){
seg=[];
seg[0]=i
}
}
segs.reverse();
segs.forEach(function(seg){
richtext.next(seg[0],seg[1]);
this.remove(seg[0],seg[1]);
richtext.prev()
},this);
richtext.end=start
},
removeTables:function(){
},
removeRows:function(){
},
removeColumns:function(){
},
removeStyles:function(){
},
removeParas:function(){
},
removeLinks:function(){
}
});
web.data.text.Richtext=Ext.extend(Object,{
constructor:function(cfg){
this.cls='text textnormal';
this.baseCls='text';
this.text='';
this.width=320;
this.start=0;
this.end=0;
this.history=[];
this.atypes=[
'styles',
'links',
'paras',
'cells'
];
this.writer=new web.data.text.HtmlWriter({richtext:this});
this.remover=new web.data.text.utils.Remover(this);
if(cfg.parent){
this.parent=cfg.parent
}
this.initAspects();
this.set(cfg)
},
initAspects:function(){
var ns=web.data.text;
this.paras=new ns.Paras({richtext:this});
this.styles=new ns.Styles({richtext:this});
this.links=new ns.Links({richtext:this});
this.cells=new ns.Cells({richtext:this})
},
set:function(cfg){
if(Ext.isObject(cfg)){
if(cfg.text){
this.text=cfg.text;
delete cfg.text
}
this.atypes.forEach(function(name){
if(cfg[name]){
this[name].set({data:cfg[name]});
delete cfg[name]
}
},this);
Ext.apply(this,cfg)
}
},
disableEndShift:function(){
this.atypes.forEach(function(type){
this[type].disableEndShift()
},this)
},
enableEndShift:function(){
this.atypes.forEach(function(type){
this[type].enableEndShift()
},this)
},
getText:function(){
return this.text
},
render:function(doc,onIndent){
var i,aspects,len;
aspects=this.styles;
for(i=0,len=aspects.getCount();i<len;i+=1){
doc.addStyle(aspects.itemAt(i).getPart())
}
aspects=this.paras;
for(i=0,len=aspects.getCount();i<len;i+=1){
doc.addStyle(aspects.itemAt(i).getPart())
}
aspects=this.links;
for(i=0,len=aspects.getCount();i<len;i+=1){
doc.addStyle(aspects.itemAt(i).getPart().getStyle())
}
aspects=this.cells;
for(i=0,len=aspects.getCount();i<len;i+=1){
doc.addStyle(aspects.itemAt(i).getStyleCell())
}
if(this.text||this.parent.getRelParaItems()){
this.writer.write(doc,onIndent)
}else if(doc.editMode){
this.parent.renderEmpty(doc,'emptyText')
}
},
getWidth:function(){
return this.parent.getInnerWidth()
},
getStyles:function(){
var result=[];
this.styles.forEach(function(style){
result.push(style)
},this);
return result
},
isParaAt:function(index){
var chr=this.text.charAt(index-1);
return!index||chr==='\n'||chr==='	'
},
isParaEndAt:function(index){
var text=this.text,chr=text.charAt(index);
return index===text.length||chr==='\n'||chr==='	'
},
findValidCursorIndex:function(index,searchForward){
if(!Ext.isDefined(searchForward)){
searchForward=true
}
var len=this.getText().length;
if(index>len){
index=len
}
if(this.isTable()){
if(index===len){
index=len-1
}
}
return index
},
findNextWordStart:function(index){
var len=this.text.length;
index=this.findValidCursorIndex(index);
while(index!==null&&!this.text.charAt(index).match(/\s/)){
index=this.findValidCursorIndex(index+1);
if(index===len){
break
}
}
while(index!==null&&this.text.charAt(index).match(/\s/)){
index=this.findValidCursorIndex(index+1);
if(index===len){
break
}
}
return index
},
findPrevWordStart:function(index){
index=this.findValidCursorIndex(index,false);
while(index!==null&&this.text.charAt(index).match(/\s/)){
index=this.findValidCursorIndex(index-1,false);
if(index<0){
break
}
}
while(index!==null&&!this.text.charAt(index).match(/\s/)){
index=this.findValidCursorIndex(index-1,false);
if(index<0){
break
}
}
return this.findValidCursorIndex(index+1)
},
findParaStart:function(index,forward){
var length=this.text.length,newIndex=index;
if(forward){
newIndex+=1;
while(!this.isParaAt(newIndex)&&newIndex<=length){
newIndex+=1
}
}else{
newIndex-=1;
while(!this.isParaAt(newIndex)&&newIndex>=0){
newIndex-=1
}
}
if(this.isParaAt(newIndex)&&newIndex>=0&&newIndex<=length+(this.isTable()?-1:0)){
return newIndex
}
return index
},
getParaStart:function(index){
var i;
if(isNaN(index)){
index=this.getStart()
}
if(index){
for(i=index;i>=0;i-=1){
if(this.isParaAt(i)){
return i
}
}
}
return 0
},
getParaEnd:function(index){
var text=this.text,len=text.length,i;
if(isNaN(index)){
index=this.getEnd()
}
if(index<len){
for(i=index;i<len;i+=1){
if(this.isParaEndAt(i)){
return i
}
}
}
return len
},
toJSON:function(){
var json={
cls:this.cls,
baseCls:this.baseCls,
text:this.text,
width:this.getWidth(),
start:this.getStart(),
end:this.getEnd()
};
this.atypes.forEach(function(name){
json[name]=this[name].toJSON()
},this);
return json
},
copy:function(){
return new web.data.text.Richtext(Ext.apply({parent:this.parent},this.toJSON()))
},
getBaseCls:function(){
var baseCls=this.baseCls||this.cls;
return baseCls
},
getClass:function(){
return this.cls
},
refreshRichness:function(aspect){
var cfg,start,end,i,richness=this.richness,len=richness.length,richnessNew=[],richOld,oldStart,oldEnd,oldCfg;
cfg={};
cfg[aspect.type]=aspect;
start=aspect.start;
end=aspect.end;
for(i=0;i<len;i+=1){
richOld=richness[i];
oldStart=richOld[0];
oldEnd=richOld[1];
oldCfg=richOld[2];
if(start===end&&oldStart!==oldEnd&&(start<oldEnd&&end>=oldStart||oldEnd===0)||start<oldEnd&&end>oldStart){
if(start>oldStart){
richnessNew.push([
oldStart,
start,
oldCfg
])
}
richnessNew.push([
oldStart>start?oldStart:start,
oldEnd<end?oldEnd:end,
Ext.apply(Ext.apply({},oldCfg),cfg)
]);
if(end<oldEnd){
richnessNew.push([
end,
oldEnd,
oldCfg
])
}
}else{
richnessNew.push(richOld)
}
}
this.richness=richnessNew
},
reset:function(){
this.start=this.end=0
},
isTable:function(){
return this.cells.getCount()>0
},
position:function(start,end){
if(Ext.isArray(start)){
this.start=start[0]-0;
this.end=start[1]-0
}else if(!isNaN(start)){
this.start=start;
this.end=isNaN(end)?start:end
}
},
next:function(start,end){
this.history.push(this.getPosition());
this.position(start-0,end-0)
},
prev:function(){
this.position(this.history.pop())
},
getPosition:function(){
return[
this.getStart(),
this.getEnd()
]
},
getStart:function(){
var len=this.text.length;
if(this.start>=len){
var cells=this.cells;
this.start=this.isTable()?cells.items[cells.items.length-1].end:len
}
return this.start
},
getEnd:function(){
var len=this.text.length;
if(this.end>=len){
var cells=this.cells;
this.end=this.isTable()?cells.items[cells.items.length-1].end:len
}
return this.end
},
shift:function(start,amount){
this.atypes.forEach(function(name){
this[name].shift(start,amount)
},this)
},
insert:function(text,start){
if(text instanceof web.data.text.Richtext){
var t=text.text,s=start,e=s+t.length;
this.insertText(t,s);
this.position(s,e);
this.atypes.forEach(function(name){
this[name].applyAspects(text[name])
},this);
this.position(e,e)
}else if(Ext.isString(text)){
this.insertText(text,start)
}
},
insertText:function(text,start){
var t=this.text,end=start;
this.text=t.substr(0,start)+text+t.substr(end,t.length);
this.shift(start,text.length);
this.start=this.end=start+text.length;
if(this.stash){
this.next(start,this.end);
this.applyStash();
this.prev();
this.replaceMode=false
}
},
remove:function(start,end){
this.next(start,end);
this.remover.remove(start,end);
this.prev()
},
removeText:function(start,end){
this.remover.removeText(start,end)
},
replaceText:function(text,start,end){
this.replaceMode=true;
this.removeText(start,end);
this.insertText(text,start)
},
storeStash:function(){
this.stash={
style:this.styles.getCurrent()[0],
para:this.paras.getCurrent()[0],
link:this.links.getCurrent()[0]
}
},
applyStash:function(){
var stash=this.stash;
if(stash){
if(stash.style){
this.styles.applyAspect(stash.style)
}
if(stash.para){
this.paras.applyAspect(stash.para)
}
if(stash.link){
this.links.applyAspect(stash.link)
}
this.stash=null
}
}
});
web.data.components.Text=Ext.extend(web.data.components.Component,{
type:'web.data.components.Text',
constructor:function(config){
this.richtext=new web.data.text.Richtext({parent:this});
web.data.components.Text.superclass.constructor.call(this,config)
},
set:function(opts){
web.data.components.Text.superclass.set.call(this,opts);
this.richtext.set(Ext.applyIf({parent:this},opts))
},
getRenderClass:function(doc){
var cls=web.data.components.Text.superclass.getRenderClass.call(this,doc),normal,size,stylesheet;
cls+=' text textnormal';
if(doc.isMobile()){
stylesheet=this.getStylesheet();
if(stylesheet){
normal=stylesheet.getStyleByRef('normal','StyleText');
size=normal.size;
if(size>20){
cls+=' mobile-oversized'
}
if(size<12){
cls+=' mobile-undersized-lower'
}
if(size<16){
cls+=' mobile-undersized-upper'
}
}
}
return cls
},
getBlocks:function(){
var id=this.id;
return this.getAllItems().filter(function(item){
var relPara=item.getRelPara();
return item.relIn&&item.relIn.id===id&&relPara&&!item.isGhost()
})
},
renderSelfStart:function(doc){
doc.openTag({
cls:this.getRenderClass(doc),
style:this.getRenderStyle(doc),
weight:doc.isMobile()&&this.isMobileLeaf()&&!this.inPage()?this.getMobileSortWeight():null,
newLine:false
})
},
renderSelf:function(doc,onIndent){
this.renderSelfStart(doc);
this.richtext.render(doc,onIndent);
this.renderSelfEnd(doc)
},
toJSON:function(){
var json=web.data.components.Text.superclass.toJSON.call(this),richtext=this.richtext;
json.text=richtext.text;
richtext.atypes.forEach(function(name){
json[name]=richtext[name].toJSON()
},this);
return json
},
toJSONAnon:function(){
var json=this.toJSON();
delete json.id;
delete json.rev;
return json
},
getText:function(){
return this.richtext.getText()
},
insert:function(text,start){
if(text instanceof web.data.components.Text){
this.richtext.insert(text.richtext,start)
}else{
this.richtext.insertText(text,start)
}
},
insertText:function(text,start){
this.richtext.insertText(text,start)
},
remove:function(start,end){
this.richtext.removeText(start,end)
},
removeText:function(start,end){
this.richtext.removeText(start,end)
},
replace:function(text,start,end){
if(text instanceof web.data.components.Text){
this.remove(start,end);
this.insert(text,start)
}else{
this.richtext.replaceText(text,start,end)
}
},
getAllStyles:function(){
var styles=[],richtext=this.richtext,textStyles=richtext.styles,cells=richtext.cells,links=richtext.links;
textStyles.forEach(function(style){
styles.push(style.getPart())
});
cells.forEach(function(cell){
styles.push(cell.getStyleCell())
});
links.forEach(function(link){
styles.push(link.getPart().getStyle())
});
return web.data.components.Text.superclass.getAllStyles.call(this).concat(styles)
},
getCurrentAspects:function(name){
var result=[],aspects=this.richtext[name].getCurrent();
aspects.forEach(function(aspect){
result.push(aspect.getPart())
},this);
return result
},
applyStyle:function(style){
return this.richtext.styles.applyAspect(style)
},
removeStyles:function(){
this.richtext.styles.removeAspects()
},
getStyles:function(){
var styles=this.richtext.getStyles(),result=[];
styles.forEach(function(style){
result.push(style.getPart())
},this);
return result
},
getCurrentStyles:function(start,end){
this.richtext.next(start,end);
var styles=this.getCurrentAspects('styles');
this.richtext.prev();
return styles
},
applyPara:function(para){
return this.richtext.paras.applyAspect(para)
},
getCurrentParas:function(selStart,selEnd){
this.richtext.next(selStart,selEnd);
var styles=this.getCurrentAspects('paras');
this.richtext.prev();
return styles
},
applyLink:function(link,selStart,selEnd){
if(selStart&&selEnd){
this.richtext.next(selStart,selEnd)
}
this.richtext.links.applyAspect(link);
if(selStart&&selEnd){
this.richtext.prev()
}
},
removeLinks:function(selStart,selEnd){
if(selStart&&selEnd){
this.richtext.next(selStart,selEnd)
}
this.richtext.links.removeAspects();
if(selStart&&selEnd){
this.richtext.prev()
}
},
getCurrentLinks:function(selStart,selEnd){
this.richtext.next(selStart,selEnd);
var styles=this.getCurrentAspects('links');
this.richtext.prev();
return styles
},
getRichtext:function(){
return this.richtext
},
reset:function(){
this.richtext.reset()
},
position:function(start,end){
this.richtext.position(start,end)
},
getPosition:function(){
return this.richtext.getPosition()
},
getStart:function(){
return this.richtext.getStart()
},
getEnd:function(){
return this.richtext.getEnd()
},
getSnippet:function(start,end){
var snippet=this.dm.create(this.toJSONAnon()),richtext=snippet.richtext;
richtext.position(end,snippet.getText().length);
richtext.remove(end,snippet.getText().length);
richtext.position(0,start);
richtext.remove(0,start);
richtext.position(0,end-start);
richtext.cells.removeAspects();
richtext.text=richtext.text.replace(/\t/g,'\n');
snippet.type='web.data.components.Text';
return snippet
},
getItems:function(){
return[]
},
isEmpty:function(){
return!this.richtext.getText().length
},
getCurrentCells:function(selStart,selEnd){
this.richtext.next(selStart,selEnd);
var styles=this.getCurrentAspects('cells');
this.richtext.prev();
return styles
},
getParagraphCount:function(){
return this.getText().split(/[\t\n]/g).length
},
isMobileAutoSort:function(){
var result=web.data.components.Text.superclass.isMobileAutoSort.call(this);
if(result){
this.getStyles().forEach(function(style){
if(result){
var global=style.getGlobal();
if(global&&global.getRef()==='heading.1'){
result=false
}
}
},this)
}
return result
}
});
web.data.components.Text.NAME='Text';
web.data.components.Table=Ext.extend(web.data.components.Text,{
type:'web.data.components.Table',
constructor:function(config){
web.data.components.Table.superclass.constructor.call(this,config)
},
set:function(opts){
web.data.components.Table.superclass.set.call(this,opts);
if(opts.table){
this.insertTable(opts.table)
}
this.repair()
},
repair:function(){
var richtext=this.richtext,cells=richtext.cells,rows=cells.getRows(),cell,stylesheet,global,globalId;
if(rows.length===0){
this.insertTable({
rows:1,
cols:1
})
}
cell=cells.itemAt(0);
cell.setStart(0);
cell=cells.itemAt(cells.getCount()-1);
cell.setEnd(richtext.getText().length);
stylesheet=this.getStylesheet();
global=stylesheet?stylesheet.getStyleByRef('normal','stylecell'):null;
globalId=global?global.getId():null;
if(globalId){
cells.forEach(function(cell){
if(!stylesheet.getStyle(cell.style.globalId)){
cell.style.globalId=globalId
}
})
}
},
insertCell:function(cell){
this.richtext.cells.add(cell)
},
applyCell:function(cell){
return this.richtext.cells.applyCell(cell)
},
applyStyleCell:function(styleCfg){
var cells=this.getCurrentAspects('cells');
cells.forEach(function(cell){
var style=cell.getStyleCell();
if(styleCfg.block){
style.getBlock().set(styleCfg.block)
}
if(styleCfg.text){
style.getText().set(styleCfg.text)
}
if(styleCfg.globalId){
style.set({globalId:styleCfg.globalId})
}
if(styleCfg.verticalAlign){
style.set({verticalAlign:styleCfg.verticalAlign})
}
if(styleCfg.horizontalAlign){
style.set({horizontalAlign:styleCfg.horizontalAlign})
}
},this)
},
insertTable:function(tableCfg){
var stylesheet,globalNormal;
if(!tableCfg.cellCfg){
tableCfg.cellCfg={style:{type:'web.data.styles.StyleCell'}};
stylesheet=this.getStylesheet();
if(stylesheet){
globalNormal=stylesheet.getStyleByRef('normal','StyleCell');
if(globalNormal){
tableCfg.cellCfg.style.globalId=globalNormal.getId()
}
}
}
this.richtext.cells.insertTable(tableCfg)
},
getAssets:function(){
var assets=[];
this.richtext.cells.forEach(function(cell){
var asset=cell.getStyleCell().block.getBackground().getAsset();
if(asset){
assets.push(asset)
}
});
return assets
},
getRows:function(){
return this.richtext.cells.getRows()
},
getCols:function(){
return this.richtext.cells.getCols()
},
insertRow:function(){
this.richtext.cells.insertRow()
},
insertCol:function(){
this.richtext.cells.insertCol()
},
deleteRow:function(){
this.richtext.cells.deleteRow()
},
deleteCol:function(){
this.richtext.cells.deleteCol()
}
});
web.data.components.Table.NAME='Table';
web.data.components.Buttons=Ext.extend(web.data.components.Component,{
type:'web.data.components.Buttons',
constructor:function(config){
this.styleButton=null;
this.btnText='Button';
this.action=null;
config.height=config.height!==undefined?config.height:web.data.components.Buttons.DEFAULT_HEIGHT;
web.data.components.Buttons.superclass.constructor.call(this,config)
},
set:function(config){
web.data.components.Buttons.superclass.set.call(this,config);
if(config.styleButton||!this.styleButton){
this.styleButton=this.dm.create(Ext.apply({
type:'web.data.styles.StyleButton',
dm:this.dm,
parent:this
},config.styleButton))
}
if(config.localFontSize){
this.styleButton.inactive.text.size=config.localFontSize
}
if(config.btnText){
this.btnText=config.btnText
}
if(config.action instanceof web.data.Action){
config.action.dm=this.dm;
config.action.parent=this;
this.action=config.action
}else if(config.action===null){
this.action=null
}else if(config.action){
this.action=new web.data.Action(Ext.apply({
dm:this.dm,
parent:this
},config.action))
}
},
toJSON:function(){
var json=web.data.components.Buttons.superclass.toJSON.call(this);
json.styleButton=this.styleButton.toJSON();
json.btnText=this.btnText;
json.action=this.action?this.action.toJSON():null;
return json
},
getAllStyles:function(){
var styles=[this.styleButton];
return web.data.components.Buttons.superclass.getAllStyles.call(this).concat(styles)
},
getStyleButton:function(){
return this.styleButton
},
getGlobalStyleId:function(){
return this.styleButton.globalId
},
getBtnText:function(){
return this.btnText
},
getAction:function(){
return this.action
},
isFixedHeight:function(){
return true
},
renderSelf:function(doc){
doc.addStyle(this.styleButton);
this.renderSelfStart(doc);
this.renderButton(doc);
this.renderSelfEnd(doc)
},
getRenderClass:function(doc){
var cls=web.data.components.Buttons.superclass.getRenderClass.call(this,doc);
return cls+' buttonself'
},
renderButton:function(doc){
var clsSfx=1,globalStyle=this.dm.get(this.styleButton.globalId),action=this.getAction(),url,target,htmlEncode=Ext.util.Format.htmlEncode,border=0,borderWidth,localStyle=this.styleButton.getCSSDeclarations(doc,true);
if(globalStyle){
clsSfx=globalStyle.ref.split('.')[1];
if(globalStyle.getInactive().getBlock().getBorder()){
borderWidth=globalStyle.getInactive().getBlock().getBorder().width;
border=borderWidth.top+borderWidth.bottom
}
}
doc.openTag({
cls:'button'+clsSfx,
style:localStyle
});
if(action){
url=action.getURL(doc);
target=action.getTarget()
}
var anchrorAttributes=function(){
var str=' href="'+(!doc.editMode&&url?htmlEncode(url):'javascript:void(0);')+'"';
if(doc.previewMode){
var msg='';
if(url){
if(document.createElement&&web.utils.String.isExternal(url)){
msg='External links do not work when previewing. Please publish your site to test this link.'
}
}else{
msg='Broken link.'
}
str+=msg?' title="'+msg+'"':''
}
str+=' onclick="'+(doc.editMode?'if(event.preventDefault){event.preventDefault();}event.returnValue=false;':this.inImageWithLink()?'event.stopPropagation();':'')+'"';
if(!doc.editMode){
str+=target?' target="'+target+'"':''
}
return str
}.call(this);
doc.append('<a '+anchrorAttributes+'>');
doc.append('<span>'+htmlEncode(this.getBtnText())+'</span>');
doc.append('</a>');
doc.closeTag()
}
});
web.data.components.Buttons.NAME='Button';
web.data.components.Buttons.DEFAULT_HEIGHT=35;
(function(){
function duplicatePage(dm,page,component,workCallback){
var templateId=page.getTemplateId(),copier=new web.utils.Copier,pageConfig={
id:Math.uuid(),
name:'hi there',
title:'how are you?',
templateId:templateId,
items:[copier.copy(component.toJSON(),/^globalId|linkId$/)]
},pageCopy=new web.data.components.Page(Ext.apply({dm:dm},pageConfig)),template=dm.get(templateId),templateItems=template.items;
template.items=[];
var resultOfWork=workCallback(pageCopy);
template.items=templateItems;
return resultOfWork
}
web.utils.ShadowRenderer={
getDimensions:function(dm,page,component,relatedElementsSelector){
function doWork(pageCopy){
var doc=new web.Document({
dm:dm,
domain:'who-cares.hj',
isShadowRendering:true,
forceMobile:false,
previewMode:true,
editMode:false,
previewTarget:'desktop'
});
pageCopy.render(doc);
var div=document.createElement('div'),html=doc.toBodyHTML(),styleCss=doc.getStylesCSS(),styleDom=oneJQuery('<style>'+styleCss+'</style>');
oneJQuery('head').append(styleDom);
document.body.appendChild(div);
div.innerHTML=html;
var elements=relatedElementsSelector(div,component.id),dimensions=elements.map(function(element){
var $element=oneJQuery(element);
return{
width:$element.width(),
height:$element.height()
}
});
oneJQuery(div).remove();
styleDom.remove();
return dimensions
}
return duplicatePage(dm,page,component,doWork)
}
}
}());
(function(){
web.utils.IsNode=!function(){
try{
return this===window
}catch(e){
return false
}
}
}());
(function(){
function selectMenuItems(div){
return oneJQuery(div).find('.menu li').toArray()
}
web.data.components.Menu=Ext.extend(web.data.components.Component,{
type:'web.data.components.Menu',
vertical:null,
horizontalAlign:null,
verticalAlign:null,
level:null,
accordion:null,
cascade:null,
levelStyles:null,
constructor:function(config){
this.vertical=false;
this.horizontalAlign=null;
this.verticalAlign='top';
this.level=1;
this.accordion=0;
this.cascade=0;
this.menuStyle=null;
this.accordionStyles=[];
this.cascadeStyles=[];
this.renderMoreStub=config.renderMoreStub;
this.moreText=null;
web.data.components.Menu.superclass.constructor.call(this,config)
},
destroy:function(){
delete this.vertical;
delete this.horizontalAlign;
delete this.verticalAlign;
delete this.level;
delete this.accordion;
delete this.cascade;
delete this.menuStyle;
delete this.accordionStyles;
delete this.cascadeStyles;
delete this.moreText;
web.data.components.Menu.superclass.destroy.call(this)
},
set:function(opts){
var copy=Ext.apply({},opts),menuStyle,accordionStyles,cascadeStyles,i,len;
if(copy.levelStyles){
menuStyle=copy.levelStyles[0];
delete copy.levelStyles
}
if(copy.menuStyle){
menuStyle=copy.menuStyle;
delete copy.menuStyle
}
if(copy.accordionStyles){
accordionStyles=copy.accordionStyles;
delete copy.accordionStyles
}
if(copy.cascadeStyles){
cascadeStyles=copy.cascadeStyles;
delete copy.cascadeStyles
}
if(copy.moreText){
this.moreText=copy.moreText
}
if(copy.moreButtonEnabled){
this.moreButtonEnabled=copy.moreButtonEnabled
}
if(copy.level<1){
copy.level=1
}
web.data.components.Menu.superclass.set.call(this,copy);
if(menuStyle||!this.menuStyle){
this.menuStyle=this.dm.create(Ext.apply({
type:'web.data.styles.StyleMenu',
dm:this.dm,
parent:this
},menuStyle))
}
if(accordionStyles){
for(i=0,len=accordionStyles.length;i<len;i+=1){
this.accordionStyles[i]=this.dm.create(Ext.apply({
type:'web.data.styles.StyleMenu',
dm:this.dm,
parent:this
},accordionStyles[i]))
}
}
if(cascadeStyles){
for(i=0,len=cascadeStyles.length;i<len;i+=1){
this.cascadeStyles[i]=this.dm.create(Ext.apply({
type:'web.data.styles.StyleMenu',
dm:this.dm,
parent:this
},cascadeStyles[i]))
}
}
if(!this.horizontalAlign){
this.horizontalAlign=copy.vertical?'fit':'left'
}
},
check:function(){
if(!web.data.components.Menu.superclass.check.call(this)){
return false
}
if(!Ext.isBoolean(this.vertical)){
return false
}
if(isNaN(this.level)||this.level<1||Math.round(this.level)!==this.level){
return false
}
if(!this.menuStyle||!(this.menuStyle instanceof web.data.styles.StyleMenu)||!this.menuStyle.check()){
return false
}
this.accordionStyles.forEach(function(style){
if(!style||!(style instanceof web.data.styles.StyleMenu)||!style.check()){
return false
}
});
this.cascadeStyles.forEach(function(style){
if(!style||!(style instanceof web.data.styles.StyleMenu)||!style.check()){
return false
}
});
return true
},
toJSON:function(){
var obj=web.data.components.Menu.superclass.toJSON.call(this);
Ext.apply(obj,{
vertical:this.vertical,
horizontalAlign:this.horizontalAlign,
verticalAlign:this.verticalAlign,
level:this.level,
accordion:this.accordion,
cascade:this.cascade,
menuStyle:this.menuStyle.toJSON(),
accordionStyles:[],
cascadeStyles:[],
fittedItemsCount:this.fittedItemsCount,
moreButtonEnabled:this.moreButtonEnabled,
moreText:this.moreText,
renderMoreStub:this.renderMoreStub
});
this.accordionStyles.forEach(function(style){
obj.accordionStyles.push(style.toJSON())
},this);
this.cascadeStyles.forEach(function(style){
obj.cascadeStyles.push(style.toJSON())
},this);
return obj
},
renderSelf:function(doc){
var styles=[this.menuStyle].concat(this.accordionStyles,this.cascadeStyles);
styles.forEach(function(style){
doc.addStyle(style.getGlobal()||style)
});
this.renderSelfStart(doc);
this.renderLevel(doc);
this.renderSelfEnd(doc);
if(!doc.editMode){
doc.requireScript('dropDownMenu')
}
},
getBlockRenderClass:function(doc){
var cls=web.data.components.Menu.superclass.getBlockRenderClass.call(this,doc);
return(cls?cls+' ':'')+'menu'
},
getBlockRenderStyle:function(doc){
var style=web.data.components.Menu.superclass.getBlockRenderStyle.call(this,doc);
style+='width:'+this.getWidth()+'px;';
return style
},
getRenderClass:function(doc){
var cls=web.data.components.Menu.superclass.getRenderClass.call(this,doc),h=this.getHorizontalAlign(),v=this.getVerticalAlign();
return cls+' menuself'+(this.isVertical()?' menuvertical':' menuhorizontal')+' menuhorizontal'+(h?h:'left')+' menuvertical'+(v?v:'top')
},
renderLevel:function(doc){
var helper=new web.data.components.Menu.RenderHelper(this,doc);
if(helper.path.length>=this.level){
helper.renderItems(helper.path[this.level-1].getItems())
}
},
isVertical:function(){
return this.vertical
},
isFixedHeight:function(){
return true
},
getHorizontalAlign:function(){
return this.horizontalAlign
},
getVerticalAlign:function(){
return this.verticalAlign
},
getLevel:function(){
return this.level
},
getAccordion:function(){
return this.accordion
},
getCascade:function(){
return this.cascade
},
getMoreButtonEnabled:function(){
return this.moreButtonEnabled
},
getMoreText:function(){
return this.moreText||'More'
},
getMenuStyle:function(){
return this.menuStyle
},
getAccordionStyles:function(){
return this.accordionStyles
},
getCascadeStyles:function(){
return this.cascadeStyles
},
getItems:function(){
return[]
},
isMobileLeaf:function(){
var parent=this.getRelInParent();
return parent&&parent.isBackground&&parent.isBackground()
},
getAllStyles:function(){
var styles=[this.menuStyle].concat(this.accordionStyles,this.cascadeStyles);
return web.data.components.Menu.superclass.getAllStyles.call(this).concat(styles)
},
isMobileAutoSort:function(){
return false
}
});
web.data.components.Menu.RenderHelper=function(menu,doc){
var style;
this.menu=menu;
this.doc=doc;
this.accordionCount=0;
this.cascadeCount=0;
this.page=doc.getPage();
this.path=this.calcPath();
style=menu.menuStyle;
this.style=style=style.getGlobal()||style;
this.cls=style?style.getCSSClass():''
};
web.data.components.Menu.RenderHelper.prototype={
calcPath:function(){
var root=this.menu.dm.getSite().getFolder(),children=root.getItems().concat(),child,parents=[],pageId=this.page.getId();
while(children.length){
child=children.shift();
if(child.getItems){
children=children.concat(child.getItems())
}
if(child.getPageId&&child.getPageId()===pageId){
break
}
}
parents.unshift(child);
while(child&&!!(child=child.getParent())){
parents.unshift(child)
}
parents.shift();
return parents
},
startGroup:function(cls){
this.doc.openTag({
tag:'ul',
cls:cls+(this.cascadeCount?' menucascade':'')
})
},
endGroup:function(){
this.doc.closeTag({
tag:'ul',
newLine:false
})
},
renderDivider:function(cls,isWrapping){
var doc=this.doc,divCfg={
tag:isWrapping?'div':'li',
cls:'divider '+cls+'divider',
newLine:false
};
doc.openTag(divCfg);
doc.closeTag(divCfg)
},
renderCascade:function(item){
var doc=this.doc,items=item.getItems();
if(items.length){
this.cascadeCount+=1;
doc.openTag({cls:'menucascadeanchor'});
this.renderItems(items,'cascade');
doc.closeTag({newLine:false});
this.cascadeCount-=1
}
},
renderAccordionIndent:function(isOpenTag){
var doc=this.doc,count=this.accordionCount,cfg;
if(count){
cfg={
tag:'span',
cls:'indent '+this.cls+'indent'+count,
newLine:false
};
if(isOpenTag===true){
doc.openTag(cfg)
}
if(isOpenTag===false){
doc.closeTag(cfg)
}
}
},
renderAccordionIndentStart:function(){
this.renderAccordionIndent(true)
},
renderAccordionIndentEnd:function(){
this.renderAccordionIndent(false)
},
_calcItemsAndMoreButtonDimensions:function(){
var currentCascade=this.menu.cascade;
this.menu.cascade=0;
this.menu.renderMoreStub=true;
var itemsDimensions=web.utils.ShadowRenderer.getDimensions(this.doc.dm,this.page,this.menu,selectMenuItems);
this.menu.cascade=currentCascade;
this.menu.renderMoreStub=false;
return{
moreButtonDimensions:itemsDimensions.pop(),
itemsDimensions:itemsDimensions
}
},
_getFittedItemsCount:function(){
var menuWidth=this.menu.getWidth(),fittedItemsCount=0,currentItemsWidth=0,dimensions=this._calcItemsAndMoreButtonDimensions(),itemsDimensions=dimensions.itemsDimensions,moreButtonWidth=dimensions.moreButtonDimensions.width;
while(fittedItemsCount<itemsDimensions.length){
var currentItem=itemsDimensions[fittedItemsCount],currentItemWidth=currentItem.width,nextItemsWidth=currentItemsWidth+currentItemWidth;
if(nextItemsWidth<=menuWidth){
currentItemsWidth=nextItemsWidth;
fittedItemsCount++
}else{
while(currentItemsWidth+moreButtonWidth>menuWidth&&fittedItemsCount>0){
currentItem=itemsDimensions[fittedItemsCount-1];
fittedItemsCount--;
currentItemWidth=currentItem.width;
currentItemsWidth-=currentItemWidth;
if(fittedItemsCount<=0){
fittedItemsCount=0;
break
}
}
break
}
}
return fittedItemsCount
},
_createMoreItem:function(childrenItems){
return this.doc.dm.create({
type:'web.data.links.LinkPage',
items:childrenItems,
name:this.menu.getMoreText()
})
},
_getVisibleItems:function(items,isRootRender){
var visibleItems=items.filter(function(item){
return!item.isHidden()&&item.isPublic()
});
if(this.menu.renderMoreStub){
visibleItems.push(this._createMoreItem([this._createMoreItem([])]))
}
if(!this.doc.editMode||!isRootRender){
return visibleItems
}
var isMoreFunctional=this.menu.horizontalAlign!=='fit'&&!this.menu.vertical&&this.menu.cascade;
if(this.menu.moreButtonEnabled&&isMoreFunctional){
var fittedItemsCount=web.utils.IsNode?this.fittedItemsCount:this._getFittedItemsCount(),visibleItemsLength=visibleItems.length;
if(fittedItemsCount<visibleItemsLength){
var moreChildrenItems=visibleItems.slice(fittedItemsCount),moreItem=this._createMoreItem(moreChildrenItems);
visibleItems.length=fittedItemsCount;
visibleItems.push(moreItem)
}
}
return visibleItems
},
renderItems:function(items,type){
var doc=this.doc,menu=this.menu,path=this.path,accordion=menu.accordion,cascade=menu.cascade,htmlEncode=Ext.util.Format.htmlEncode,cfg,cls=this.cls,style=this.style,pageId=this.page.getId(),isWrapping=!type&&menu.horizontalAlign!=='fit'&&!menu.vertical,isRootRender=type===undefined,visibleItems=this._getVisibleItems(items,isRootRender),isMoreEnabled=menu.moreButtonEnabled&&menu.horizontalAlign!=='fit'&&!menu.vertical&&cascade;
if(!doc.editMode&&!doc.isShadowRendering&&isMoreEnabled&&this.cascadeCount===0){
visibleItems.push(this._createMoreItem([this._createMoreItem([])]))
}
if(visibleItems.length){
if(type==='accordion'){
style=this.menu.getAccordionStyles()[0]||this.menu.getMenuStyle();
style=style.getGlobal()||style;
cls=style.getCSSClass()
}else if(type==='cascade'){
style=this.menu.getCascadeStyles()[0]||this.menu.getMenuStyle();
style=style.getGlobal()||style;
cls=style.getCSSClass()
}
this.startGroup(cls);
visibleItems.forEach(function(item,index){
var isActive=path.some(function(link){
return link.getId()===item.getId()
},this),isExpandable=!!item.getItems().length;
if(isExpandable){
isExpandable=item.getItems().some(function(subItem){
return!subItem.hidden
})
}
var isExpanded=isExpandable&&isActive&&!cascade,isSelected=item.getPageId&&item.getPageId()===pageId&&type!=='cascade'&&!isExpandable,itemClass='';
itemClass+=cls+'item';
itemClass+=isExpandable?' '+cls+'expandable':'';
itemClass+=isSelected?' '+cls+'selected':'';
itemClass+=isExpanded?' '+cls+'expanded':'';
if(isMoreEnabled&&this.cascadeCount===0){
itemClass+=doc.editMode||doc.isShadowRendering?'':' displayNone';
if(index===visibleItems.length-1){
itemClass+=' moreEnabled'
}
}
itemClass+=' ';
itemClass=itemClass.trim();
if(index&&!isWrapping){
this.renderDivider(cls,isWrapping)
}
doc.openTag({
tag:'li',
newLine:false
});
if(index&&isWrapping){
this.renderDivider(cls,isWrapping)
}
if(isWrapping){
doc.openTag({})
}
cfg={
tag:doc.editMode?'div':'a',
cls:'menuitem '+itemClass,
target:item.getTarget?item.getTarget():undefined,
newLine:false
};
if(!doc.editMode){
if(item instanceof web.data.links.LinkPage){
cfg.href=item.getURL(doc);
if(doc.previewMode){
cfg.href+=(cfg.href.indexOf('?')===-1?'?':'&')+'templateselectorpreview=desktop'
}
if(!item.pageId){
cfg.href=''
}
}else if(item instanceof web.data.links.LinkExternal){
if(doc.previewMode){
cfg.title='External links do not work when previewing. Please publish your site to test this link.'
}
cfg.href=item.getURL(doc)
}
}
if(doc.editMode){
cfg.linkId=item.getId()
}
doc.openTag(cfg);
this.renderAccordionIndentStart(cls);
doc.appendToBody(htmlEncode(item.getName()));
this.renderAccordionIndentEnd(cls);
doc.closeTag(cfg);
if(cascade>this.cascadeCount){
this.renderCascade(item)
}
if(isWrapping){
doc.closeTag()
}
doc.closeTag({
tag:'li',
newLine:false
});
if(accordion>this.accordionCount&&isActive&&type!=='cascade'&&item.getItems().length){
this.renderDivider(cls);
this.accordionCount+=1;
this.renderItems(item.getItems(),'accordion');
this.accordionCount-=1
}
},this);
this.endGroup()
}
}
};
web.data.components.Menu.NAME='Menu'
}());
web.data.components.Code=Ext.extend(web.data.components.Component,{
type:'web.data.components.Code',
constructor:function(cfg){
this.code='';
this.name='';
this.info=web.data.components.Code.NAME;
this.location='';
web.data.components.Code.superclass.constructor.call(this,cfg)
},
getCode:function(){
return this.code
},
getName:function(){
return this.name
},
getInfo:function(){
return this.info
},
getLocation:function(){
return web.data.components.Code.locationTypes[this.location]?this.location:''
},
getFinalCode:function(doc){
var code=this.code,id=this.getId();
if(doc.editMode){
var html='<div class="codedevwrapper">'+'<div class="codedevicon '+this.getIconCls()+'"></div>'+'<div class="codedevtext">'+'<div class="codedevname">'+this.getNameHTML()+'</div>'+'<div class="codedevinfo">'+this.getInfoHTML()+'</div>'+'</div>'+'<div class="codedevend"></div>'+'</div>',location=this.getLocation().toLowerCase(),inPage=this.inPage()?1:0;
if(location){
html='<div data-id="'+id+'" class="codedev">'+html+'</div>';
doc.fixedCode=doc.fixedCode||{};
doc.fixedCode[location]=doc.fixedCode[location]||[];
doc.fixedCode[location][inPage]=doc.fixedCode[location][inPage]||'';
doc.fixedCode[location][inPage]+=html
}else{
return html
}
}else{
code=this.supportOneComGallery(code)
}
return'<!--#begin code '+id+'-->'+code+'<!--#end code '+id+'-->\n'
},
supportOneComGallery:function(finalCode){
if(finalCode.match(/data="http:\/\/ilostatic.one.com\/iloapp\/gallery\/swf\/embedFlashGallery.swf/)){
var url,html,id=Math.uuid();
url=finalCode.match(/<a +href="[^"]+/i);
url=url&&url[0].replace(/<a +href="/,'')||'';
html=[
'<div style=\'border:1px dashed #ccc\'>',
'<div style=\'height:@heightpx;padding:1em;border:1px dashed #333\'>',
'<a href=\'@url\' target=\'_blank\'>',
'Unfortunately your gallery does not work when previewed. Please publish your site to see your gallery.',
'</a>',
'</div>',
'</div>'
].join('').replace(/@url/,url).replace(/@width/,this.getInnerWidth()).replace(/@height/,this.getInnerHeight()-4);
finalCode+=[
'<script id="'+id+'">',
'  if (window.location.href.match(/^https:/i) && self !== top) {',
'    document.getElementById("'+id+'").parentNode.innerHTML = "'+html+'";',
'  }',
'</script>'
].join('\n')
}
return finalCode
},
getIconCls:function(){
return'icon'
},
getNameHTML:function(){
return this.name?this.name:web.data.components.Code.NAME
},
getInfoHTML:function(){
var info=this.info?this.info:this.code,oldLen=info.length,newLen,splitLine;
info=info.substr(0,144);
newLen=info.length;
info=info.replace(/\&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
if(!this.info){
splitLine=info.split('\n')
}
if(newLen<oldLen||!this.info&&splitLine.length>4){
if(!this.info){
if(splitLine.length>1){
splitLine.pop();
info=splitLine.slice(0,4).join('\n')
}
info+='\n'
}
info+='...'
}
return info?this.info?info:'<div class="codedevcode">'+info+'</div>':'&nbsp;'
},
getBlockRenderClass:function(doc){
var cls=web.data.components.Code.superclass.getBlockRenderClass.call(this,doc),extraCls='';
if(doc.editMode){
var height=this.getHeight(),sizeCls=height<30?'codesize3':height<45?'codesize2':height<60?'codesize1':'';
extraCls='codedev'+(sizeCls?' '+sizeCls:'')
}
return(cls?cls+' ':'')+extraCls
},
set:function(cfg){
var newCfg=Ext.apply({},cfg);
web.data.components.Code.superclass.set.call(this,newCfg);
if(newCfg.code){
this.code=newCfg.code
}
},
render:function(doc){
var prefix='append',location=this.getLocation();
if(!location){
web.data.components.Code.superclass.render.call(this,doc)
}else{
if(typeof this[prefix+location]!=='function'){
throw new Error('No such method: '+prefix+location)
}
this[prefix+location](doc)
}
},
getRenderClass:function(doc){
var cls=web.data.components.Code.superclass.getRenderClass.call(this,doc);
return'code'+(cls?' '+cls:'')
},
getRenderStyle:function(doc){
var style=web.data.components.Code.superclass.getRenderStyle.call(this,doc);
if(doc.editMode){
style+='height:'+this.getInnerHeight()+'px;'
}
return style
},
renderSelf:function(doc){
this.append(doc)
},
append:function(doc){
this.renderSelfStart(doc);
doc.append(this.getFinalCode(doc));
this.renderSelfEnd(doc)
},
appendHead:function(doc){
doc.appendToEndHead(this.getFinalCode(doc))
},
appendBodyEnd:function(doc){
doc.appendToFooter(this.getFinalCode(doc))
},
toJSON:function(){
var json;
json=web.data.components.Code.superclass.toJSON.call(this);
json.code=this.code;
json.name=this.name;
json.location=this.getLocation();
return json
},
isGhost:function(){
return!!this.getLocation()
},
isMobileSortable:function(){
return false
}
});
web.data.components.Code.NAME='Code';
web.data.components.Code.locationTypes={
'':0,
'Head':1,
'BodyEnd':2
};
web.data.components.Clamp=Ext.extend(web.data.components.Component,{
type:'web.data.components.Clamp',
constructor:function(config){
this.state=null;
web.data.components.Clamp.superclass.constructor.call(this,config)
},
set:function(config){
var cfg=Ext.apply({},config);
delete cfg.state;
web.data.components.Clamp.superclass.set.call(this,cfg);
if(config.state){
this.setState(config.state)
}
},
toJSON:function(){
var obj=web.data.components.Clamp.superclass.toJSON.call(this);
obj.state=this.state?this.state.toJSON():null;
return obj
},
getState:function(){
return this.state
},
setState:function(instance){
var cfg={
parent:this,
height:this.height
};
if(instance){
if(instance instanceof web.data.components.Component){
instance.set(cfg)
}else{
instance=this.dm.create(Ext.apply(cfg,instance))
}
this.state=instance
}
},
addItem:function(item){
this.setState(item)
},
renderSelf:function(doc){
if(this.state){
this.state.bbox=this.getBBox();
this.state.mobileHide=this.isMobileHide();
this.state.mobileDown=this.getMobileDown();
this.state.renderSelf(doc)
}
},
isFixedHeight:function(){
return!this.state||this.state.isFixedHeight()
}
});
web.data.components.Video=Ext.extend(web.data.components.Clamp,{
type:'web.data.components.Video',
constructor:function(config){
config.height=config.height!==undefined?config.height:web.data.components.Video.DEFAULT_HEIGHT;
web.data.components.Video.superclass.constructor.call(this,config)
},
set:function(config){
web.data.components.Video.superclass.set.call(this,config);
var url=this.getURL();
if(url!==null){
this.setURL(url)
}
},
initService:function(videoProvider,url){
var config={},current=this.getState();
if(videoProvider==='Youtube'){
if(!current||current.type!=='web.data.components.widgets.Youtube'){
config.type='web.data.components.widgets.Youtube';
this.setState(this.dm.create(config))
}
return this.setURL(url)
}
return false
},
setURL:function(url){
var setting=this.getState().getSetting('href'),regex=setting.param.regex,output=setting.param.transform,matches,len,i,regexObj;
if(typeof regex!=='undefined'&&typeof output!=='undefined'){
matches=url.match(new RegExp(regex,''));
if(matches!==null){
for(i=1,len=matches.length;i<len;i+=1){
regexObj=new RegExp('{\\\\'+i+'}','g');
output=output.replace(regexObj,matches[i]);
if(i===1){
setting.value.videoId=matches[i]
}
}
setting.value.input=url;
setting.value.output=output;
return true
}else{
one.debug('Either URL is wrong or video regex transform of URL is wrong');
setting.value.input=url;
setting.value.output=''
}
}
return false
},
getURL:function(){
if(this.getState()){
if(!this.getState().getSetting){
throw new Error('Trying to call getSetting on object:\n'+JSON.stringify(this.getState()))
}
return this.getState().getSetting('href').value.input
}
return null
},
getProvider:function(){
if(this.getState()){
return this.getState().type.split('.').pop()
}
return null
},
toJSON:function(){
return web.data.components.Video.superclass.toJSON.call(this)
},
isContentHeight:function(){
return false
}
});
web.data.components.Video.NAME='Video';
web.data.components.Video.DEFAULT_HEIGHT=200;
Ext.ns('web.data.components.form');
web.data.components.form.FormField=Ext.extend(Object,{
type:'web.data.components.form.FormField',
formFieldId:'',
name:'',
isRequired:true,
errorMessage:'',
constructor:function(config){
this.formField=null;
this.formFieldId=Math.uuid()
},
set:function(config){
var copy=Ext.apply({},config);
if(copy.name){
this.name=config.name
}
if(copy.inputType){
this.inputType=config.inputType
}
if(copy.values){
this.values=config.values.slice(0)
}
if(typeof copy.isRequired==='boolean'){
this.isRequired=config.isRequired
}
if(copy.errorMessage){
this.errorMessage=config.errorMessage
}
},
toJSON:function(){
var json={};
json.name=this.name;
json.inputType=this.inputType;
json.values=this.values?this.values.slice(0):null;
json.isRequired=this.isRequired;
json.errorMessage=this.errorMessage;
return json
},
getName:function(){
return this.name||null
},
getFormFieldId:function(){
return this.formFieldId
},
getErrorMessage:function(){
return this.errorMessage||null
},
getRequired:function(){
return this.isRequired||true
},
getInputType:function(){
return this.inputType||null
},
getInputValues:function(){
return this.values||null
},
getRequiredText:function(){
return''
},
getRequireStar:function(){
return this.isRequired?'*':''
},
render:function(doc,index){
var formElementDOM='',inputType=this.getInputType(),inputValues=this.getInputValues(),htmlEncodedName=this.getHtmlEncodedString(this.getName());
if(inputValues){
formElementDOM+='<div class="contact-form-field-container" dataFormElement="'+htmlEncodedName+'" data-index ='+index+'><label>'+htmlEncodedName+' '+this.getRequireStar()+' </label>\n';
if(inputType==='checkbox'||inputType==='radio'){
formElementDOM+=this.getCheckboxDOM()
}else if(inputType==='dropdown'){
formElementDOM+=this.getDropdownDOM()
}
formElementDOM+='</div>';
doc.append(formElementDOM)
}else{
var containerTpl='<div class="contact-form-field-container" dataFormElement="%dfe%" data-index="%di%">'+'<label>%label%</label>'+'%field%'+'</div>';
var fieldTpl='';
if('textarea'===inputType){
fieldTpl='<textarea id="%id%" type="text" %reqText% name="%name%"></textarea>'
}else{
fieldTpl='<input id="%id%" type="%type%" name="%name%"';
if('number'===inputType){
fieldTpl+=' ctype="number"'
}
fieldTpl+=' %reqText% />'
}
containerTpl=containerTpl.replace('%field%',fieldTpl);
var type=inputType&&'number'!==inputType?inputType:'text';
var field=containerTpl.replace('%dfe%',htmlEncodedName).replace('%di%',index).replace('%label%',htmlEncodedName+' '+this.getRequireStar()).replace('%id%',this.formFieldId).replace('%type%',type).replace('%name%',htmlEncodedName).replace('%reqText%',this.getRequiredText());
doc.append(field)
}
},
getCheckboxDOM:function(){
var values=this.getInputValues(),formElementDOM='',htmlEncodedName=this.getHtmlEncodedString(this.getName()),htmlEncodedValue='';
for(var i=0;i<values.length;i=i+1){
htmlEncodedValue=this.getHtmlEncodedString(values[i]);
formElementDOM+='<input id="'+this.formFieldId+'" type="'+this.getInputType()+'" name="'+htmlEncodedName+'" value="'+htmlEncodedValue+'"> '+htmlEncodedValue+' </br> \n'
}
return formElementDOM
},
getDropdownDOM:function(){
var values=this.getInputValues(),formElementDOM='',htmlEncodedValue='';
formElementDOM+='<select id="'+this.formFieldId+'" name="'+this.getHtmlEncodedString(this.getName())+'">';
formElementDOM+='<option value=""> -- </option>';
for(var i=0;i<values.length;i=i+1){
htmlEncodedValue=this.getHtmlEncodedString(values[i]);
formElementDOM+='<option value="'+htmlEncodedValue+'">'+htmlEncodedValue+'</option>'
}
formElementDOM+='</select> </br> \n';
return formElementDOM
},
getHtmlEncodedString:function(value){
return Ext.util.Format.htmlEncode(value)
}
});
web.data.styles.StyleForm=Ext.extend(web.data.styles.Style,{
type:'web.data.styles.StyleForm',
constructor:function(config){
this.font=null;
this.fontSize=null;
this.fontColor=null;
this.primaryColor=null;
this.fieldBgColor=null;
this.fieldBorderColor=null;
web.data.styles.StyleForm.superclass.constructor.call(this,config);
if(this.inStylesheet()){
if(!this.fontColor){
this.fontColor=one.color.RGB(0,0,0)
}
}
this.clsPfx=config.clsPfx||'';
this.commonCls='test-contact-form'
},
destroy:function(){
web.data.styles.StyleForm.superclass.destroy.call(this);
if(this.font!==null){
this.font.destroy()
}
delete this.font;
delete this.color;
delete this.highlight
},
set:function(opts){
var styleOpts=Ext.apply({},opts);
if(opts===null){
this.font=null;
this.fontSize=null;
this.fontColor=null;
this.primaryColor=null;
this.fieldBgColor=null;
this.fieldBorderColor=null;
return
}
if(!isNaN(styleOpts.font)){
if(styleOpts.font!==null){
this.font=new web.data.styles.Font({fontType:styleOpts.font})
}else{
this.font=null
}
delete styleOpts.font
}else if(typeof styleOpts.font==='string'){
if(styleOpts.font!==null){
this.font=new web.data.styles.Font({fontType:styleOpts.font})
}else{
this.font=null
}
delete styleOpts.font
}
if(styleOpts.fontSize){
this.fontSize=styleOpts.fontSize;
delete styleOpts.fontSize
}
if(styleOpts.fontColor){
this.fontColor=styleOpts.fontColor?one.color(styleOpts.fontColor):null;
delete styleOpts.fontColor
}
if(styleOpts.primaryColor){
this.primaryColor=one.color(styleOpts.primaryColor);
delete styleOpts.primaryColor
}
if(styleOpts.fieldBgColor){
this.fieldBgColor=one.color(styleOpts.fieldBgColor);
delete styleOpts.fieldBgColor
}
if(styleOpts.fieldBorderColor){
this.fieldBorderColor=one.color(styleOpts.fieldBorderColor);
delete styleOpts.fieldBorderColor
}
web.data.styles.StyleForm.superclass.set.call(this,styleOpts)
},
toCSS:function(doc){
return this.getCSSDeclarations(doc)
},
getCSSDeclarations:function(doc){
var css='',alpha=1,defaultTextStyle=this.getTextStyleNormalGlobalStyle(),font=this.font||defaultTextStyle.getFont()||null,fontSize=this.fontSize||defaultTextStyle.getSize()||null,fontColor=this.fontColor||defaultTextStyle.getColor()||null;
css+='.'+this.clsPfx+' .oneWebCntForm,'+this.clsPfx+' .contactFormResponseStatus {\n';
css+='min-width: 200px;\n';
css+=' padding: 0 10px 10px 10px;\n';
css+=font?' font-family:'+font.getCSSValue(doc)+';\n':'';
css+=fontSize?' font-size:'+fontSize+'px;\n}\n':'\n}\n';
if(fontColor){
css+='.'+this.clsPfx+' .oneWebCntForm,'+this.clsPfx+' .contactFormResponseStatus {\n';
alpha=fontColor.alpha();
if(alpha===0){
css+=' color:transparent;\n'
}else if(alpha===1){
css+=' color:'+fontColor.css()+';\n'
}else{
css+=' color:'+fontColor.cssa()+'!important;\n';
css+=' color:'+fontColor.css()+';\n'
}
css+='}\n'
}
css+='.contactFormContainer form {\n';
css+='padding-top: 3px !important;\n';
css+='}\n';
css+='.contactFormContainer form>div {\n'+' padding: 0 5px 0 5px;\n'+' position: relative;\n'+' border: 2px solid transparent;\n'+'}\n'+':invalid {\n'+' box-shadow: none;\n'+'}\n'+':-moz-submit-invalid {\n'+' box-shadow: none;\n'+'}\n'+':-moz-ui-invalid {\n'+' box-shadow:none;\n'+'}\n'+'.contactFormContainer form>div>label {\n'+' display: block;\n'+' padding: 5px 0;\n'+' word-wrap: break-word;\n'+'}\n'+'.contactFormContainer input:not([type=submit]), .contactFormContainer input[type=text], .contactFormContainer textarea {\n'+' width: 100%;\n'+' height: 30px;\n'+' border: 1px solid #BBBBBB;\n'+' padding: 1px 8px;\n'+' background: #FFF;\n'+' box-sizing: border-box;\n'+' font-size: 13px;\n'+'}\n'+'.contactFormContainer input[type="checkbox"], .contactFormContainer input[type="radio"] {\n'+' border: none;\n'+' box-sizing: inherit;\n'+'}\n'+'.contactFormContainer input::-webkit-outer-spin-button, .contactFormContainer input::-webkit-inner-spin-button {\n'+' -webkit-appearance: none;\n'+'  margin: 0;\n'+'}\n'+'.contactFormContainer input[type="number"] {\n'+' -moz-appearance:textfield;\n'+'}\n'+'.contactFormContainer input[type="radio"], .contactFormContainer input[type="checkbox"]{\n'+' background: transparent;\n'+'}\n'+'.contactFormContainer input[type=checkbox], .contactFormContainer input[type=radio] {\n'+' width: auto;\n'+' height: 16px;\n'+' display: inline-block;\n'+' vertical-align: middle;\n'+' padding: 5px;\n'+'}\n'+'.contactFormContainer form>div>textarea {\n'+' min-height: 130px;\n'+'}\n'+'.contactFormContainer .error {\n'+' margin-left: 7px;\n'+' border: 0;\n'+' padding: 0 !important;\n'+' color: #971414;\n'+' font-weight: bold;\n'+' font-size: 12px;\n'+' -moz-user-select: -moz-none;\n'+' -khtml-user-select: none;\n'+' -webkit-user-select: none;\n'+' -ms-user-select: none;\n'+' user-select: none;\n'+' line-height: 1.2;\n'+'}\n'+'.contactFormContainer form>div.contact-form-submit-btn-container {min-height:25px;margin-bottom:3px;padding:5px;text-align:right}\n'+'.contactFormContainer form>div>input[type="submit"] {\n'+' width: auto;\n'+' height: auto;\n'+' min-height: 30px;\n'+' cursor: pointer;\n'+' transition: background-color .2s ease-out,border .2s ease-out,color .2s ease-out;\n'+'}\n';
css+='.oneweb-hidden-field { \n'+' display: none; \n'+''+'}\n';
css+='.contactFormResponseStatus{\n'+' padding:0 10px 10px 20px;\n'+' display:none;\n'+'}\n'+'.formSuccess, .formError{\n'+' visibility:visible;\n'+'}\n'+'.formSuccess.contactFormResponseStatus, .formError.contactFormResponseStatus {\n'+' display:inline-block;\n'+'}\n'+'.formError.contactFormResponseStatus {\n'+' color:#971414\n'+'}\n';
return css
},
getTextStyleNormalGlobalStyle:function(){
var document=this.getDocument(),defaultStyle;
try{
defaultStyle=document instanceof web.data.styles.Stylesheet?document.getStyleByRef('normal','StyleText'):document.getStylesheet().getStyleByRef('normal','StyleText');
return defaultStyle
}catch(e){
one.fatal(' StyleForm.getDocument() is not instanceof web.Document or web.data.styles.Stylesheet')
}
},
toJSON:function(){
var json=web.data.styles.StyleForm.superclass.toJSON.call(this);
return Ext.apply(json,this.getSpecificJSON())
},
initDefaultStyles:function(){
this.set({
font:new web.data.styles.Font,
fontSize:12,
fontColor:new one.color(0,0,0),
primaryColor:new one.color(255,0,0),
fieldBgColor:new one.color(255,255,255),
fieldBorderColor:new one.color(60,60,60)
})
},
getSpecificJSON:function(){
var json={};
json.font=this.font?this.font.toJSON():null;
json.fontSize=this.fontSize?this.fontSize:null;
json.fontColor=this.fontColor?this.fontColor.toJSON():null;
json.primaryColor=this.primaryColor?this.primaryColor.toJSON():null;
json.fieldBgColor=this.fieldBgColor?this.fieldBgColor.toJSON():null;
json.fieldBorderColor=this.fieldBorderColor?this.fieldBorderColor.toJSON():null;
return json
},
isEqual:function(o){
return this.fontSize===o.fontSize&&(this.font===o.font||this.font&&o.font&&this.font.isEqual(o.font))&&(this.fontColor===o.fontColor||this.fontColor&&o.fontColor&&this.fontColor.hexa()===o.fontColor.hexa())&&(this.primaryColor===o.primaryColor||this.primaryColor&&o.primaryColor&&this.primaryColor.hexa()===o.primaryColor.hexa())&&(this.fieldBgColor===o.fieldBgColor||this.fieldBgColor&&o.fieldBgColor&&this.fieldBgColor.hexa()===o.fieldBgColor.hexa())&&(this.fieldBorderColor===o.fieldBorderColor||this.fieldBorderColor&&o.fieldBorderColor&&this.fieldBorderColor.hexa()===o.fieldBorderColor.hexa())
},
check:function(){
if(!web.data.styles.StyleForm.superclass.check.call(this)){
one.debug('StyleText superclass not ok');
return false
}
if(this.font&&!this.font.check()){
one.debug('StyleText font not ok');
return false
}
if(this.fontSize!==null&&(isNaN(this.fontSize)||this.fontSize<=0)){
one.debug('StyleText size not ok');
return false
}
return true
},
getFont:function(){
return this.font
},
getFontSize:function(){
return this.fontSize
},
getFontColor:function(){
return this.fontColor
},
getPrimaryColor:function(){
return this.primaryColor
},
getFieldBgColor:function(){
return this.getFieldBgColor
},
getFieldBorderColor:function(){
return this.getFieldBorderColor
}
});
web.data.styles.StyleForm.names=['form'];
web.data.components.ContactForm=Ext.extend(web.data.components.Block,{
type:'web.data.components.ContactForm',
contactFormId:'',
constructor:function(cfg){
this.name=null;
this.email=null;
this.formElements=null;
this.submitBtn=null;
this.successMessage=null;
this.recipientEmail=null;
this.formElementsOrder=[
'name',
'email',
'message'
];
this.editSelectedElement=null;
this.contactFormId=Math.uuid();
this.emailRegex=one.validation.email;
this.styleForm=null;
this.styleButton=null;
web.data.components.ContactForm.superclass.constructor.call(this,cfg)
},
destroy:function(){
web.data.components.ContactForm.superclass.destroy.call(this);
delete this.name;
delete this.email;
delete this.submitBtn;
delete this.successMessage;
delete this.styleForm;
delete this.styleButton;
delete this.recipientEmail
},
set:function(config){
var copy=Ext.apply({},config),ns=web.data.components.form,name,email,formElements,submitBtn,styleForm,successMessage,domainEmails,recipientEmail,editSelectedElement,formElementsOrder,activeElement;
if(config.contactFormId){
this.contactFormId=config.contactFormId
}
if(copy.name){
name=copy.name;
delete copy.name
}
if(copy.email){
email=copy.email;
delete copy.email
}
if(copy.formElements){
formElements=copy.formElements;
delete copy.formElements
}
if(copy.submitBtn){
submitBtn=copy.submitBtn;
delete copy.submitBtn
}
if(copy.styleForm){
styleForm=copy.styleForm;
delete copy.styleForm
}
if(copy.successMessage){
successMessage=copy.successMessage;
delete copy.successMessage
}
if(copy.domainEmails){
domainEmails=copy.domainEmails;
delete copy.domainEmails
}
if(copy.recipientEmail){
recipientEmail=copy.recipientEmail;
delete copy.recipientEmail
}
if(copy.editSelectedElement){
editSelectedElement=copy.editSelectedElement;
delete copy.editSelectedElement
}
if(copy.formElementsOrder){
formElementsOrder=copy.formElementsOrder;
delete copy.formElementsOrder
}
if(copy.activeElement){
activeElement=copy.activeElement;
delete copy.activeElement
}
web.data.components.ContactForm.superclass.set.call(this,copy);
if(formElements||!this.formElements){
if(typeof formElements==='undefined'){
formElements=this._getDefaultFormElements()
}
if(!this.formElements){
this.formElements={};
Object.keys(formElements).forEach(function(key){
if(formElements[key].name==='Phone'){
formElements[key].inputType='tel'
}
this.formElements[key]=new ns.FormField(formElements[key]);
this.formElements[key].set(formElements[key])
}.bind(this))
}else{
Object.keys(formElements).forEach(function(key){
var activeElement=this.activeElement,index=activeElement?this.formElementsOrder.indexOf(activeElement):null;
if(!this.formElements[key]){
this.formElementsOrder.splice(index,0,key);
this.formElements[key]=new ns.FormField(formElements[key]);
this.formElements[key].set(formElements[key])
}else{
this.formElements[key].set(formElements[key])
}
}.bind(this))
}
}else{
Object.keys(this.formElements).forEach(function(key){
if(formElementsOrder){
if(formElementsOrder.indexOf(key)===-1){
delete this.formElements[key]
}
}
}.bind(this))
}
if(submitBtn||!this.submitBtn){
this.submitBtn=submitBtn
}
if(styleForm||!this.styleForm){
this.styleForm=this.dm.create(Ext.apply({
type:'web.data.styles.StyleForm',
dm:this.dm,
parent:this
},styleForm,{clsPfx:'contactFormContainer'}))
}
if(copy.styleButton||!this.styleButton){
this.styleButton=this.dm.create(Ext.apply({
type:'web.data.styles.StyleButton',
dm:this.dm,
parent:this
},copy.styleButton))
}
if(successMessage||!this.successMessage){
this.successMessage=successMessage
}
if(recipientEmail||!this.recipientEmail){
this.recipientEmail=recipientEmail
}
if(editSelectedElement||!this.editSelectedElement){
this.editSelectedElement=editSelectedElement
}
if(formElementsOrder||!this.formElementsOrder){
this.formElementsOrder=formElementsOrder
}
if(activeElement||!this.activeElement){
this.activeElement=activeElement
}
},
getAllStyles:function(){
var styles=[this.styleButton].concat(this.styleForm);
return web.data.components.ContactForm.superclass.getAllStyles.call(this).concat(styles)
},
getFormElements:function(){
return Ext.apply({},this.formElements)||null
},
getFormElementByIndex:function(index){
var element=this.formElementsOrder[index];
return element?this.formElements[element].toJSON():null
},
getFormElementByName:function(name){
return name?this.formElements[name].toJSON():null
},
getEditSelectedElement:function(){
return this.editSelectedElement
},
getSubmitBtnText:function(){
return this.submitBtn?this.submitBtn:'Send'
},
getStyleForm:function(){
return this.styleForm
},
getStyleButton:function(){
return this.styleButton
},
getGlobalStyleId:function(){
return this.styleButton.globalId
},
getSuccessMessage:function(){
return this.successMessage?this.successMessage:'Thank you for your message.'
},
getRecipientEmail:function(){
return this.recipientEmail||null
},
getFormElementsOrder:function(){
return this.formElementsOrder.slice()||null
},
getSelectedFormElement:function(){
return this.activeElement||null
},
getRenderClass:function(doc){
var cls=web.data.components.ContactForm.superclass.getRenderClass.call(this,doc);
return cls+' contactFormContainer'
},
_getDefaultFormElements:function(){
return{
name:{
name:'Name',
errorMessage:'Please enter a valid name',
inputType:'text',
trackingName:'Name'
},
email:{
name:'Email',
errorMessage:'Please enter a valid email address.',
inputType:'email',
trackingName:'Email'
},
message:{
name:'Message',
inputType:'textarea',
errorMessage:'Please enter a valid message',
trackingName:'Message'
}
}
},
renderSelf:function(doc){
this.addContactStyleForm(doc);
this.renderSelfStart(doc);
this.renderContactForm(doc);
this.renderSelfEnd(doc)
},
addContactStyleForm:function(doc){
var style=this.styleForm;
if(style){
doc.addStyle(style)
}
if(this.styleButton){
doc.addStyle(this.styleButton)
}
},
renderContactForm:function(doc){
if(doc.editMode){
this.renderContactFormInEditMode(doc)
}else{
var formElementsErrorMessages={},allFieldErrorMessage={},successMessage=this.getSuccessMessage(),errorMessage='Something went wrong. Please try again later.',pageName=doc.getPage().getName();
if(this.getFormElementsOrder().length>0){
doc.requireScript('jquery');
this.appendContactFormDOM(doc)
}
this.formElementsOrder.forEach(function(item,index){
try{
var element=this.formElements[item],errorMessage=encodeURIComponent(element.errorMessage),message=element.isRequired?errorMessage:null;
formElementsErrorMessages[index]=message;
allFieldErrorMessage[index]=errorMessage
}catch(e){
one.fatal('contactForm component formElementsOrder not in sync with formElements data')
}
}.bind(this));
var urlRegexStr='^('+one.validation.fragments.httpUrlIdn.source+')$';
doc.requireScript('contactForm');
doc.appendToScripts('<script type="text/javascript"> \n '+'(function (){'+'oneJQuery(function() {'+'oneJQuery(".oneWebCntForm .contact-form-submit-btn").prop("disabled", false);'+'new window.OnewebContactForm('+JSON.stringify({
formDOMId:this.contactFormId,
postURL:'/____formmail/1/',
recipientEmail:encodeURIComponent(this.getRecipientEmail()),
subject:encodeURIComponent('New message via contact form on '+doc.domain+' - '+pageName+' page'),
successMessage:encodeURIComponent(successMessage),
errorMessage:encodeURIComponent(errorMessage),
emailRegex:one.validation.email.source,
urlRegex:urlRegexStr,
previewMode:doc.previewMode,
formElementsErrorMessages:JSON.stringify(formElementsErrorMessages),
allFieldErrorMessage:JSON.stringify(allFieldErrorMessage)
})+');\n'+'});'+'})();\n'+'</script>',true)
}
},
renderContactFormInEditMode:function(doc){
this.appendContactFormDOM(doc);
setTimeout(function(){
oneJQuery('.oneWebCntForm').submit(function(event){
event.preventDefault();
return false
})
},100)
},
appendContactFormDOM:function(doc){
var clsSfx='',globalStyle=this.dm.get(this.styleButton.globalId),buttonLocalStyle=this.styleButton.getCSSDeclarations(doc,true)||'';
if(globalStyle){
clsSfx=globalStyle.ref.split('.')[1]
}
doc.append('<form id="'+this.contactFormId+'" accept-charset="ISO-8859-1" class="oneWebCntForm" name="contact form">');
this.getFormElementsOrder().forEach(function(element,index){
if(this.formElements[element]){
this.formElements[element].render(doc,index)
}
doc.append('<span class="error">&nbsp;</span>')
}.bind(this));
doc.append('<div class="contact-form-formField-container oneweb-hidden-field">'+'<label>oneweb</label><input type="text" name="subject" autofill="off">'+'</div>'+'<div class="contact-form-submit-btn-container">'+'<input class="contact-form-submit-btn button'+clsSfx+'" type="submit" value="'+this.getSubmitBtnText()+'" disabled="true"'+' style="'+buttonLocalStyle+'">'+'</div>'+'<div id="contactFormResponseContainer" class="contactFormResponseStatus" ></div>');
doc.append('</form>')
},
toJSON:function(){
var json;
json=web.data.components.ContactForm.superclass.toJSON.call(this);
json.formElements=this.getFormElements();
json.submitBtn=this.getSubmitBtnText();
json.styleForm=this.styleForm.toJSON();
json.styleButton=this.styleButton.toJSON();
json.successMessage=this.getSuccessMessage();
json.formElementsOrder=this.getFormElementsOrder();
json.recipientEmail=this.getRecipientEmail();
return json
},
updateFormElementsOrder:function(index,formElement){
this.formElementsOrder.splice(this.formElementsOrder.indexof(formElement),1);
this.formElementsOrder.splice(index,0,formElement)
},
isStretchy:function(){
return false
},
isSingle:function(){
return true
}
});
web.data.components.ContactForm.NAME='Contact Form';
web.data.components.GoogleDocsViewer=Ext.extend(web.data.components.Component,{
type:'web.data.components.GoogleDocsViewer',
constructor:function(config){
config.height=config.height!==undefined?config.height:web.data.components.GoogleDocsViewer.DEFAULT_HEIGHT;
web.data.components.GoogleDocsViewer.superclass.constructor.call(this,config)
},
editSafe:true,
renderSelf:function(doc){
var renderedCode=this.getCode(doc);
this.renderSelfStart(doc);
doc.append('<div style="height:'+this.getInnerHeight()+'px;" class="web-widget web-widget-document-viewer">'+renderedCode+'</div>',false);
this.renderSelfEnd(doc)
},
getCode:function(doc){
var data=this.getDataValues(doc);
var ttemplate=new web.utils.TinyTemplate;
var html=ttemplate.process('<iframe src="{src}" width="{width}" height="{height}" style="border:none;"></iframe>',data);
return html
},
getURL:function(doc){
if(doc&&/^webspace:/.test(this.url)){
return doc.getAssetURL()+this.url.replace(/^webspace:/,'/webspace')
}else{
return this.url
}
},
getDataValues:function(doc){
var data={};
var fileLocation=this.settings.src;
var publicURL;
fileLocation=fileLocation.replace(/^webspace:webspace:/,'webspace:');
if(/^webspace:/.test(fileLocation)){
publicURL='http://'+doc.domain+fileLocation.replace(/^webspace:/,'')
}else{
publicURL=fileLocation
}
data.src='https://docs.google.com/viewer?embedded=true&url='+encodeURIComponent(publicURL);
data.width='100%';
data.height='100%';
return data
},
set:function(config){
web.data.components.GoogleDocsViewer.superclass.set.call(this,config);
if(config&&config.src){
if(!this.settings){
this.settings={}
}
this.settings.src=config.src
}
},
toJSON:function(){
var json=web.data.components.GoogleDocsViewer.superclass.toJSON.call(this);
if(!json.settings){
json.settings={}
}
json.settings.src=this.settings.src;
return json
},
isContentHeight:function(){
return false
}
});
web.data.components.GoogleDocsViewer.NAME='Document';
web.data.components.GoogleDocsViewer.DEFAULT_HEIGHT=200;
web.utils.Function={
impede:function(iterations,callback,scope){
var total=0;
return function(){
total+=1;
if(total===iterations){
callback.call(scope||window)
}
}
},
createChain:function(fns){
return function(firstParam){
var result=firstParam,next;
fns.forEach(function(item){
next=item.fn;
result=next.call(item.scope||window,result)
})
}
}
};
web.data.components.Gallery=Ext.extend(web.data.components.Component,{
constructor:function(config){
this.images=[];
this.scale=0.33;
this.crop=true;
this.lightbox=true;
this.links=false;
this.minHeight=40;
this.imageStyle=new web.data.styles.StyleBlock({});
this.captionsEnabled=false;
this.captionsAlignment='left';
web.data.components.Gallery.superclass.constructor.call(this,config)
},
set:function(opts){
var options=Ext.apply({},opts);
delete options.images;
delete options.imageStyle;
web.data.components.Gallery.superclass.set.call(this,options);
if(this.dm){
this.imageStyle.set({dm:this.dm});
if(opts.images){
this.images=opts.images.map(function(image){
var action;
if(image.action instanceof web.data.Action){
image.action.dm=this.dm;
image.action.parent=this;
action=image.action
}else if(image.action===null){
action=null
}else if(image.action){
action=new web.data.Action(Ext.apply({
dm:this.dm,
parent:this
},image.action))
}
return{
caption:image.caption||'',
asset:this.dm.create(Ext.applyIf({
parent:this,
type:'web.data.assets.Image'
},image.asset)),
action:action
}
},this)
}
}
},
destroy:function(){
this.images.forEach(function(image){
image.destroy()
});
this.imageStyle.destroy();
this.images=null;
this.imageStyle=null
},
toJSON:function(){
var json=web.data.components.Gallery.superclass.toJSON.call(this);
json.images=this.images.map(function(image){
return{
caption:image.caption,
asset:image.asset.toJSON(),
action:image.action?image.action.toJSON():null
}
});
json.scale=this.scale;
json.crop=this.crop;
json.captionsEnabled=this.captionsEnabled;
json.imageStyle=this.imageStyle.toJSON();
json.captionsAlignment=this.captionsAlignment;
json.lightbox=this.lightbox;
json.links=this.links;
return json
},
getImages:function(withCaption){
if(withCaption){
return this.images.slice()
}
return Ext.pluck(this.images,'asset')
},
getScale:function(){
return this.scale
},
getCrop:function(){
return this.crop
},
isCaptionEnabled:function(){
return this.captionsEnabled
},
isLightboxEnabled:function(){
return this.lightbox
},
isLinksEnabled:function(){
return this.links
},
getCaptionsAlignment:function(){
return this.captionsAlignment||'left'
},
getAssets:function(){
var imageStyleAssets=this.imageStyle.getAssets();
return web.data.components.Gallery.superclass.getAssets.call(this).concat(this.getImages(),imageStyleAssets)
},
addImages:function(assets){
var imagesByUrl=this.createAssetUrlMap(this.getImages());
assets.forEach(function(asset){
if(imagesByUrl[asset.url]){
imagesByUrl[asset.url].set({
etag:asset.etag,
width:asset.width,
height:asset.height,
filesize:asset.filesize,
bpp:asset.bpp,
alpha:asset.alpha
})
}else{
this.images.push({
asset:asset,
caption:'',
action:null
});
imagesByUrl[asset.url]=asset
}
},this)
},
insertImage:function(asset,index,caption){
this.images.splice(index,0,{
asset:asset,
caption:caption!==undefined?caption:''
})
},
removeImages:function(assets){
var images=this.images,index=0,currentAsset,found,cb=function(assetToDelete){
return assetToDelete===currentAsset
};
while(images.length&&index<images.length){
currentAsset=images[index].asset;
found=assets.some(cb);
if(found){
images.splice(index,1)
}else{
index+=1
}
}
},
removeImage:function(asset){
this.images.some(function(image,index){
if(image.asset===asset){
this.images.splice(index,1);
return true
}
},this)
},
getLayoutConfig:function(){
var componentWidth=this.getInnerWidth(),imagesPerRow,maxThumbnailWidth,maxThumbnailHeight,rows;
maxThumbnailWidth=this.scale*componentWidth;
if(this.crop){
maxThumbnailHeight=maxThumbnailWidth*5/6
}else{
maxThumbnailHeight=Math.min.apply(Math,this.images.map(function(image){
var asset=image.asset;
return asset.height*(maxThumbnailWidth/asset.width)
}))
}
imagesPerRow=Math.floor(componentWidth/maxThumbnailWidth);
rows=Math.ceil(this.images.length/ imagesPerRow);
return{
maxThumbnailWidth:maxThumbnailWidth,
maxThumbnailHeight:maxThumbnailHeight,
imagesPerRow:imagesPerRow,
rows:rows
}
},
getRenderStyle:function(doc){
var style=web.data.components.Gallery.superclass.getRenderStyle.call(this,doc);
style+='text-align: center;';
return style
},
renderSelf:function(doc){
doc.requireScript('shinybox');
this.renderSelfStart(doc);
if(this.images.length){
this.renderItems(doc)
}else{
this.renderEmpty(doc,'emptyGallery')
}
this.renderSelfEnd(doc)
},
renderItems:function(doc){
var layout=this.getLayoutConfig(),imagesPerRow=layout.imagesPerRow,textClass='textnormal',renderImage=this.createImageRenderer(doc,layout),spaceBetweenRows=Math.floor((this.getInnerWidth()/ imagesPerRow-layout.maxThumbnailWidth)/2),textAlign=this.getCaptionsAlignment();
this.images.forEach(function(image,index){
doc.append('<div '+'data-index="'+index+'" '+'class="gallery-cell '+textClass+'" '+'style="width:'+Math.floor(layout.maxThumbnailWidth)+'px;padding:'+spaceBetweenRows+'px;text-align:'+textAlign+';"'+'>');
renderImage(image);
doc.append('</div>')
});
var placeholders=(imagesPerRow-this.images.length%imagesPerRow)%imagesPerRow;
for(var i=0;i<placeholders;i+=1){
doc.append('<div '+'class="gallery-cell '+textClass+'" '+'style="width:'+Math.floor(layout.maxThumbnailWidth)+'px;padding:'+spaceBetweenRows+'px;text-align:'+textAlign+';">'+'</div>')
}
},
renderEmptyCaption:function(doc,width){
if(doc.editMode){
doc.openTag({
tag:'div',
cls:'empty gallery-caption',
style:'padding:5px;width:'+Math.floor(width)+'px;',
newLine:false
});
doc.append('<span>');
doc.appendLabel('emptyText');
doc.append('</span>');
doc.closeTag({
tag:'div',
newLine:false
})
}else{
doc.openTag({
tag:'div',
cls:'gallery-caption',
style:'padding:2px;width:'+Math.floor(width)+'px;',
newLine:false
});
doc.append('<span>&nbsp;</span>');
doc.closeTag({
tag:'div',
newLine:false
})
}
},
getRenderClass:function(doc){
return web.data.components.Gallery.superclass.getRenderClass.call(this,doc)+' gallery'+(!this.crop?' uncropped':'')
},
createAssetUrlMap:function(images){
var map={};
images.forEach(function(image){
map[image.url]=image
},this);
return map
},
createImageRenderer:function(doc,layout){
var that=this,assetRenderFn,renderFn;
if(doc.editMode){
assetRenderFn=this.createEditModeAssetRenderer(doc,layout)
}else{
assetRenderFn=this.createAssetRenderer(doc,layout)
}
if(this.captionsEnabled){
renderFn=function(image){
image=assetRenderFn.call(this,image);
if(image){
var text=image.caption;
if(text===''||text===undefined){
that.renderEmptyCaption(doc,image.width)
}else{
doc.append('<p class="gallery-caption" style="padding:5px;width:'+Math.floor(image.width)+'px;"><span>'+Ext.util.Format.nl2br(Ext.util.Format.htmlEncode(text))+'</span></p>')
}
}
};
renderFn=renderFn.createDelegate(this)
}else{
renderFn=assetRenderFn.createDelegate(this)
}
return renderFn
},
createAssetRenderer:function(doc,layout){
var maxThumbnailHeight=layout.maxThumbnailHeight,maxThumbnailWidth=layout.maxThumbnailWidth,baseUrl=doc.getAssetURL(),renderFn,retinaThumbSize,resizeForRetinaFn=function(w,h){
var MINSIDE=160;
if(w>=h&&w<MINSIDE){
h=h*MINSIDE/w;
w=MINSIDE
}else if(h>w&&h<MINSIDE){
w=w*MINSIDE/h;
h=MINSIDE
}
return{
width:w,
height:h
}
};
if(this.crop){
renderFn=function(image){
if(image){
var asset=image.asset,bigAssetUrls,srcset,html;
retinaThumbSize=resizeForRetinaFn(maxThumbnailWidth,maxThumbnailHeight);
bigAssetUrls=this.getScaledImageUrl(doc,asset,baseUrl,retinaThumbSize.width,retinaThumbSize.height);
srcset=bigAssetUrls.srcset;
srcset=srcset?' srcset="'+srcset+'"':'';
html=this.getLinkHTML(doc,image,asset);
if(html){
doc.append(html);
doc.append('<img src="'+bigAssetUrls.src+'"'+srcset+' style="height:'+Math.floor(maxThumbnailHeight)+'px;"/>');
doc.append('</a>')
}else{
doc.append('<img src="'+bigAssetUrls.src+'"'+srcset+' style="height:'+Math.floor(maxThumbnailHeight)+'px;"/>')
}
return{
caption:image.caption,
width:maxThumbnailWidth
}
}
}
}else{
renderFn=function(image){
if(image){
var asset=image.asset,assetRatio=asset.width/asset.height,thumbnailWidth=assetRatio*maxThumbnailHeight,bigAssetUrls,srcset,html;
retinaThumbSize=resizeForRetinaFn(thumbnailWidth,maxThumbnailHeight);
bigAssetUrls=this.getScaledImageUrl(doc,asset,baseUrl,retinaThumbSize.width,retinaThumbSize.height);
srcset=bigAssetUrls.srcset;
srcset=srcset?' srcset="'+srcset+'"':'';
html=this.getLinkHTML(doc,image,asset);
if(html){
doc.append(html);
doc.append('<img src="'+bigAssetUrls.src+'"'+srcset+' style="height:'+Math.floor(asset.height>=maxThumbnailHeight?maxThumbnailHeight:asset.height)+'px;"/>');
doc.append('</a>')
}else{
doc.append('<img src="'+bigAssetUrls.src+'"'+srcset+' style="height:'+Math.floor(asset.height>=maxThumbnailHeight?maxThumbnailHeight:asset.height)+'px;"/>')
}
return{
caption:image.caption,
width:thumbnailWidth
}
}
}
}
return renderFn
},
getLinkHTML:function(doc,image,asset){
var html,url,target,title=Ext.util.Format.htmlEncode(image.caption),baseUrl=doc.getAssetURL();
if(this.isLightboxEnabled()){
html='<a href="'+asset.getRelativeUrl(baseUrl)+'" rel="lightbox[oneweb] '+this.id+'" class="shinybox" title="'+title+'" onclick="event.stopPropagation();">'
}else if(image.action){
url=image.action.getURL(doc);
target=image.action.getTarget();
html='<a href="'+Ext.util.Format.htmlEncode(url)+'"'+(target?' target="'+target+'"':'')+' title="'+title+'" onclick="event.stopPropagation();">'
}
return html
},
createEditModeAssetRenderer:function(){
var savedDimensions={},lru=[],cacheLimit=100;
function getOrStoreDimensions(gallery,dimensions){
var hash=gallery.id+gallery.crop,recalledDimensions=savedDimensions[hash];
if(recalledDimensions&&Math.abs(dimensions[0]-recalledDimensions[0])/dimensions[0]<0.25){
return recalledDimensions
}
savedDimensions[hash]=dimensions;
if(!recalledDimensions){
lru.push(hash);
if(lru.length>cacheLimit){
delete savedDimensions[lru.shift()]
}
}
return dimensions
}
return function(doc,layout){
var maxThumbnailHeight=layout.maxThumbnailHeight,maxThumbnailWidth=layout.maxThumbnailWidth,cachedDimensions=getOrStoreDimensions(this,[
maxThumbnailWidth,
maxThumbnailHeight
]),baseUrl=doc.getAssetURL(),renderFn;
if(this.crop){
renderFn=function(image){
if(image){
var asset=image.asset,assetUrls=this.getScaledImageUrl(doc,asset,baseUrl,cachedDimensions[0],cachedDimensions[1]),srcset=assetUrls.srcset;
srcset=srcset?' srcset="'+srcset+'"':'';
doc.append('<div style="overflow:hidden;width:'+Math.floor(maxThumbnailWidth)+'px;height:'+Math.floor(maxThumbnailHeight)+'px;"'+(doc.editMode?' class="editMode"':'')+'>');
doc.append('<img onload="this.parentNode.className=\'editMode loading-complete\'" data-assetId="'+asset.id+'" src="'+assetUrls.src+'"'+srcset+' height="'+Math.floor(maxThumbnailHeight)+'"/>');
doc.append('</div>');
return{
caption:image.caption,
width:maxThumbnailWidth
}
}
}
}else{
renderFn=function(image){
if(image){
var asset=image.asset,height=Math.min(maxThumbnailHeight,asset.height),width=asset.height===height?asset.width:asset.width*height/asset.height,assetUrls=this.getScaledImageUrl(doc,asset,baseUrl,cachedDimensions[0],cachedDimensions[1]),srcset=assetUrls.srcset;
srcset=srcset?' srcset="'+srcset+'"':'';
doc.append('<img data-assetId="'+asset.id+'" + src="'+assetUrls.src+'"'+srcset+' height="'+Math.floor(height)+'"/>');
return{
caption:image.caption,
width:width
}
}
}
}
return renderFn
}
}(),
getScaledImageUrl:function(doc,asset,baseUrl,containerWidth,containerHeight){
var hdImages=doc.hdImages;
var makeUrl=function(asset,baseUrl,containerWidth,containerHeight,scale){
var assetUrl=asset.getRelativeUrl(baseUrl),assetWidth=asset.width,assetHeight=asset.height,ratio=assetWidth/assetHeight,containerRatio=containerWidth/containerHeight,params=[
'etag='+encodeURIComponent(asset.etag),
'sourceContentType='+encodeURIComponent(asset.contentType)
],width,height,reduceFactor;
if(ratio>containerRatio||!this.crop){
height=containerHeight;
width=ratio*height
}else if(ratio<containerRatio){
width=containerWidth;
height=width/ratio
}else{
width=assetWidth;
height=assetHeight
}
if(!asset.animated||asset.contentType!=='image/gif'){
if(hdImages){
width=width*scale;
height=height*scale;
reduceFactor=web.utils.ImageSize.getReduceFactor(width,height,assetWidth,assetHeight);
width=width*reduceFactor;
height=height*reduceFactor;
containerWidth=Math.round(containerWidth*scale*reduceFactor);
containerHeight=Math.round(containerHeight*scale*reduceFactor)
}
width=Math.round(width);
height=Math.round(height);
params.push('ignoreAspectRatio','resize='+width+'+'+height,'extract=0+0+'+Math.floor(Math.min(containerWidth,width))+'+'+Math.floor(Math.min(containerHeight,height)))
}
return assetUrl+'?'+params.join('&')
};
var url,url1x,srcset;
web.Constants.imagePixelRatios.forEach(function(pixelRatio){
url=makeUrl.call(this,asset,baseUrl,containerWidth,containerHeight,pixelRatio);
if(pixelRatio===1){
url1x=url
}
if(hdImages){
srcset=srcset||[];
srcset.push(url+' '+pixelRatio+'x')
}
},this);
return{
src:url1x,
srcset:srcset&&srcset.join(', ')
}
}
});
web.data.components.Gallery.NAME='Gallery';
web.data.components.Gallery.MAX_IMAGES=100;
Ext.ns('web.data.components.resources');
web.data.components.resources.Resource=Ext.extend(web.data.components.Block,{
type:'web.data.components.resources.Resource',
constructor:function(config){
web.data.components.resources.Resource.superclass.constructor.call(this,config)
},
set:function(opts){
var obj=Ext.apply({},opts),asset;
if(obj.asset){
asset=obj.asset;
delete obj.asset
}
web.data.components.resources.Resource.superclass.set.call(this,obj);
if(asset){
this.setAsset(asset)
}
},
getAsset:function(){
return this.asset
},
setAsset:function(asset){
this.asset=this.dm.create(Ext.applyIf({parent:this},asset))
},
toJSON:function(){
var obj=web.data.components.resources.Resource.superclass.toJSON.call(this);
obj.asset=this.asset.toJSON();
return obj
},
getAssets:function(){
return[].concat(this.getAsset(),web.data.components.resources.Resource.superclass.getAssets.call(this))
},
getItems:function(){
return[]
},
isStretchy:function(){
return false
}
});
Ext.ns('web.data.components.resources.image');
web.utils.Float={
fixFloat:function(num){
return parseFloat(num.toPrecision(15))
}
};
web.data.components.resources.image.AbstractRender=Ext.extend(Object,{
features:{
dragging:false,
zooming:false,
fadedImage:false
},
render:function(doc,image){
var asset=image.getAsset();
var fixFloat=web.utils.Float.fixFloat;
if(asset.url.indexOf('webspace:/')!==0&&asset.url.indexOf('repository:/')!==0){
asset.url='webspace:/'+asset.url
}
if(asset.url==='webspace:/'||asset.url==='repository:/'){
asset.url='webspace:/image-component-with-no-url'
}
var html='',id=image.getId(),assetUrl=asset.getRelativeUrl(doc.getAssetURL()),assetUrlObj,mobileRect,dims=this.getDims(image),w=dims.width,h=dims.height,top=dims.top,left=dims.left,editMode=doc.editMode,params=this.initParams(image),paramStr,styleStr='display:block;',clientSide=this.isClientSide(doc,image),inText;
this.image=image;
image.renderSelfStart(doc);
html+='<img';
html+=' data-scaleStrategy="'+image.scaleStrategy+'"';
if(clientSide){
if(image.rotation%180===90){
html+=' width="'+fixFloat(h)+'"';
html+=' height="'+fixFloat(w)+'"'
}else{
html+=' width="'+fixFloat(w)+'"';
html+=' height="'+fixFloat(h)+'"'
}
if(image.rotation%180===90){
top=top+h/2-w/2;
left=left+w/2-h/2
}
styleStr+=top||left?'margin-top:'+top+'px;margin-left:'+left+'px;':'';
html+=editMode?' id="image-'+id+'"':'';
if(image.rotation){
styleStr+=[
'-ms-transform:rotate(angle);',
'-webkit-transform:rotate(angle);',
'transform:rotate(angle);'
].join('').replace(/angle/g,image.rotation+'deg')
}
paramStr=Ext.urlEncode(params);
if(paramStr){
assetUrl+='?'+paramStr
}
html+=' src="'+Ext.util.Format.htmlEncode(assetUrl)+'"';
html+=styleStr?' style="'+styleStr+'"':''
}else{
html+=' width="'+fixFloat(w)+'"';
html+=' height="'+fixFloat(h)+'"';
params.sourceContentType=asset.contentType;
assetUrlObj=this.getHtmlUrl(doc,image);
if(doc.isMobile()){
inText=image.getRenderParent()instanceof web.data.components.Text
}
html+=editMode||mobileRect?' id="image-'+id+'"':'';
if(!inText&&w>doc.mobileMinWidth-20){
html+=' class="mobile-fit"'
}
html+=' src="'+Ext.util.Format.htmlEncode(assetUrlObj.src)+'"';
if(assetUrlObj.srcset){
html+=' srcset="'+Ext.util.Format.htmlEncode(assetUrlObj.srcset.join(', '))+'"'
}
html+=styleStr?' style="'+styleStr+'"':''
}
if(image.title){
html+=' title="'+Ext.util.Format.htmlEncode(image.title)+'"';
html+=' alt="'+Ext.util.Format.htmlEncode(image.title)+'"'
}
html+='>';
doc.appendToBody(html);
image.renderSelfEnd(doc);
image.assetUrl=assetUrl
},
getDims:function(image){
var w=image.getInnerWidth(),h=image.getInnerHeight();
return{
width:w,
height:h,
domWidth:w,
domHeight:h,
altWidth:w,
altHeight:h,
left:0,
top:0
}
},
initParams:function(image){
var params={},etag=image.getAsset().getETag();
if(etag){
params.etag=etag
}
return params
},
isAlwaysClientSide:function(image){
var dims=this.getDims(image),size=dims.width*dims.height;
return image.isAnimated()||size>web.Constants.imageScaleMaxPixels
},
isClientSide:function(doc,image){
return doc.editMode&&!doc.forceMobile||this.isAlwaysClientSide(image)
},
applyTransform:function(cfg){
var url,url1x,srcset,cssUrls={},params=cfg.params,hdImages=cfg.hdImages,pixelRatios=hdImages?web.Constants.imagePixelRatios:[1],reduceFactor,image=this.image,asset=image.asset,w,h;
pixelRatios.forEach(function(pixelRatio){
var processParams=[];
url=cfg.url;
if(image.rotation!==0){
processParams.push('rotate='+image.rotation)
}
w=image.getInnerWidth();
h=image.getInnerHeight();
if(w!==asset.width||h!==asset.height){
if(hdImages){
w=w*pixelRatio;
h=h*pixelRatio
}
reduceFactor=web.utils.ImageSize.getReduceFactor(w,h,asset.width,asset.height);
w=Math.round(w*reduceFactor);
h=Math.round(h*reduceFactor);
processParams.push('ignoreAspectRatio','resize='+w+'+'+h)
}
var paramStr=Ext.urlEncode(params);
if(processParams.length>0){
if(asset.contentType==='image/jpeg'){
processParams.push('quality='+image.JPEG_COMPRESSION_QUALITY)
}
if(paramStr.length>0){
paramStr+='&'
}
paramStr+=processParams.join('&')
}
url=url.replace(/'/g,'%27').replace(/\(/g,'%28').replace(/\)/g,'%29');
if(paramStr){
url+='?'+paramStr
}
if(hdImages){
srcset=srcset||[];
srcset.push(url+' '+pixelRatio+'x')
}
if(hdImages||pixelRatio===1){
cssUrls[pixelRatio]=url
}
url1x=url1x||url
});
return{
src:url1x,
srcset:srcset,
cssUrls:cssUrls
}
},
getHtmlUrl:function(doc,image){
var params=this.initParams(image),asset=image.getAsset(),assetUrl=asset.getRelativeUrl(doc.getAssetURL()),dims=this.getDims(image);
this.image=image;
params.sourceContentType=asset.contentType;
return this.applyTransform({
hdImages:doc.hdImages,
url:assetUrl,
params:params,
w:dims.width,
h:dims.height,
left:dims.left,
top:dims.top
})
}
});
web.data.components.resources.image.CropRender=Ext.extend(web.data.components.resources.image.AbstractRender,{
features:{
dragging:true,
zooming:true,
fadedImage:true
},
render:function(doc,image){
var asset=image.getAsset();
var fixFloat=web.utils.Float.fixFloat;
if(asset.url.indexOf('webspace:/')!==0&&asset.url.indexOf('repository:/')!==0){
asset.url='webspace:/'+asset.url
}
if(asset.url==='webspace:/'||asset.url==='repository:/'){
asset.url='webspace:/image-component-with-no-url'
}
var html='',id=image.getId(),assetUrl=asset.getRelativeUrl(doc.getAssetURL()),assetUrlObj,mobileRect,dims=this.getDims(image),w=dims.width,h=dims.height,top=dims.top,left=dims.left,flagSkipThisImgTag=false,editMode=doc.editMode,params=this.initParams(image),paramStr,styleStr='display:block;',clientSide=this.isClientSide(doc,image),inText;
this.image=image;
image.renderSelfStart(doc);
html+='<img';
html+=' data-scaleStrategy="'+image.scaleStrategy+'"';
if(clientSide){
if(left+w<dims.domWidth){
left-=w+left-dims.domWidth
}
if(top+h<dims.domHeight){
top-=h+top-dims.domHeight
}
if(image.rotation%180===90){
top=top+h/2-w/2;
left=left+w/2-h/2
}
if(image.rotation%180===90){
html+=' width="'+fixFloat(h)+'"';
html+=' height="'+fixFloat(w)+'"'
}else{
html+=' width="'+fixFloat(w)+'"';
html+=' height="'+fixFloat(h)+'"'
}
styleStr+=top||left?'margin-top:'+top+'px;margin-left:'+left+'px;':'';
html+=editMode?' id="image-'+id+'"':'';
if(image.rotation){
styleStr+=[
'-ms-transform:rotate(angle);',
'-webkit-transform:rotate(angle);',
'transform:rotate(angle);'
].join('').replace(/angle/g,image.rotation+'deg')
}
paramStr=Ext.urlEncode(params);
if(paramStr){
assetUrl+='?'+paramStr
}
html+=' src="'+Ext.util.Format.htmlEncode(assetUrl)+'"';
html+=styleStr?' style="'+styleStr+'"':''
}else{
html+=' width="'+fixFloat(dims.altWidth)+'"';
html+=' height="'+fixFloat(dims.altHeight)+'"';
if(dims.altHeight===0||dims.altWidth===0){
flagSkipThisImgTag=true
}
assetUrlObj=this.getHtmlUrl(doc,image);
if(doc.isMobile()){
inText=image.getRenderParent()instanceof web.data.components.Text
}
html+=editMode||mobileRect?' id="image-'+id+'"':'';
if(!inText&&dims.altWidth>doc.mobileMinWidth-20){
html+=' class="mobile-fit"'
}
html+=' src="'+Ext.util.Format.htmlEncode(assetUrlObj.src)+'"';
if(assetUrlObj.srcset){
html+=' srcset="'+Ext.util.Format.htmlEncode(assetUrlObj.srcset.join(', '))+'"'
}
html+=styleStr?' style="'+styleStr+'"':''
}
if(image.title){
html+=' title="'+Ext.util.Format.htmlEncode(image.title)+'"';
html+=' alt="'+Ext.util.Format.htmlEncode(image.title)+'"'
}
html+='>';
if(!flagSkipThisImgTag){
doc.appendToBody(html)
}
image.renderSelfEnd(doc);
image.assetUrl=assetUrl
},
getDims:function(image){
var asset=image.getAsset(),domWidth=image.getInnerWidth(),domHeight=image.getInnerHeight(),w,h;
if(image.rotation%180===90){
w=asset.height*image.getScale();
h=asset.width*image.getScale()
}else{
w=asset.width*image.getScale();
h=asset.height*image.getScale()
}
return{
width:w,
height:h,
domWidth:domWidth,
domHeight:domHeight,
altWidth:Math.min(w,domWidth),
altHeight:Math.min(h,domHeight),
top:-image.cropTop,
left:-image.cropLeft
}
},
applyTransform:function(cfg){
var url,url1x,srcset,cssUrls={},params=cfg.params,hdImages=cfg.hdImages,pixelRatios=hdImages?web.Constants.imagePixelRatios:[1],reduceFactor,reducedPixelRatio,image=this.image,w,h,el,et,ew,eh,left=cfg.left,top=cfg.top,asset=this.image.asset,processParams;
var icw=this.image.getInnerWidth();
var ich=this.image.getInnerHeight();
pixelRatios.forEach(function(pixelRatio){
processParams=[];
w=cfg.w;
h=cfg.h;
url=cfg.url;
if(image.rotation!==0){
processParams.push('rotate='+image.rotation)
}
var flagResize=false,flagExtract=false;
if(image.getScale()!==1){
flagResize=true
}
if(w>icw||h>ich){
flagExtract=true;
if(left+w<icw){
left-=w+left-icw
}
if(top+h<ich){
top-=h+top-ich
}
}
if(flagExtract||flagResize){
if(hdImages){
w=w*pixelRatio;
h=h*pixelRatio
}
reduceFactor=web.utils.ImageSize.getReduceFactor(w,h,asset.width,asset.height);
w=Math.round(w*reduceFactor);
h=Math.round(h*reduceFactor);
processParams.push('ignoreAspectRatio','resize='+w+'+'+h);
if(asset.contentType==='image/gif'&&!asset.isAnimated()){
processParams.push('png')
}
}
if(flagExtract){
reducedPixelRatio=pixelRatio*reduceFactor;
el=Math.floor(Math.max(0,-left*reducedPixelRatio));
et=Math.floor(Math.max(0,-top*reducedPixelRatio));
ew=Math.floor(Math.max(1,icw*reducedPixelRatio));
eh=Math.floor(Math.max(1,ich*reducedPixelRatio));
processParams.push('extract='+el+'+'+et+'+'+ew+'+'+eh)
}
var paramStr=Ext.urlEncode(params);
if(processParams.length>0){
if(asset.contentType==='image/jpeg'){
processParams.push('quality='+image.JPEG_COMPRESSION_QUALITY)
}
if(paramStr.length>0){
paramStr+='&'
}
paramStr+=processParams.join('&')
}
url=url.replace(/'/g,'%27').replace(/\(/g,'%28').replace(/\)/g,'%29');
if(paramStr){
url+='?'+paramStr
}
if(hdImages){
srcset=srcset||[];
srcset.push(url+' '+pixelRatio+'x')
}
if(hdImages||pixelRatio===1){
cssUrls[pixelRatio]=url
}
url1x=url1x||url
});
return{
src:url1x,
srcset:srcset,
cssUrls:cssUrls
}
}
});
web.data.components.resources.image.FitRender=Ext.extend(web.data.components.resources.image.AbstractRender,{});
web.data.components.resources.image.StretchRender=Ext.extend(web.data.components.resources.image.AbstractRender,{});
web.data.components.resources.Image=Ext.extend(web.data.components.resources.Resource,{
type:'web.data.components.resources.Image',
MIN_HEIGHT:16,
MIN_WIDTH:16,
scale:null,
scaleStrategy:null,
rotation:null,
anchorLeft:0,
anchorTop:0,
cropLeft:0,
cropTop:0,
title:null,
lightBoxEnabled:false,
JPEG_COMPRESSION_QUALITY:85,
savedInWbtgen:false,
constructor:function(config){
this.scale=1;
this.rotation=0;
this.anchorTop=50;
this.anchorLeft=50;
this.cropLeft=0;
this.cropTop=0;
this.title=config.title||'';
this.lightBoxEnabled=false;
this.action=null;
web.data.components.resources.Image.superclass.constructor.call(this,config)
},
set:function(cfg){
var newCfg=Ext.apply({},cfg);
if(newCfg.action!==undefined){
delete newCfg.action
}
web.data.components.resources.Image.superclass.set.call(this,newCfg);
if('lightBoxEnabled'in cfg){
this.lightBoxEnabled=cfg.lightBoxEnabled?true:false
}
if(cfg.action instanceof web.data.Action){
cfg.action.dm=this.dm;
cfg.action.parent=this;
this.action=cfg.action
}else if(cfg.action===null){
this.action=null
}else if(cfg.action){
this.action=new web.data.Action(Ext.apply({
dm:this.dm,
parent:this
},cfg.action))
}
if(this.title===null||typeof this.title==='undefined'){
this.title=''
}
if(this.scale===null||typeof this.scale==='undefined'){
this.scale=1
}
if(this.rotation===null||typeof this.rotation==='undefined'||this.rotation%90!==0){
this.rotation=0
}
if(this.scaleStrategy!==web.data.components.resources.Image.SCALE_SETTING.CROP&&this.scaleStrategy!==web.data.components.resources.Image.SCALE_SETTING.FIT&&this.scaleStrategy!==web.data.components.resources.Image.SCALE_SETTING.STRETCH){
this.scaleStrategy=web.data.components.resources.Image.SCALE_SETTING.CROP;
var rect=this.asset?this.percentToPixels():{
top:0,
left:0
};
this.cropTop=-rect.top;
this.cropLeft=-rect.left
}
if(this.scaleStrategy===web.data.components.resources.Image.SCALE_SETTING.CROP){
this.scaleStrategyObj=new web.data.components.resources.image.CropRender
}else if(this.scaleStrategy===web.data.components.resources.Image.SCALE_SETTING.FIT){
this.scaleStrategyObj=new web.data.components.resources.image.FitRender
}else if(this.scaleStrategy===web.data.components.resources.Image.SCALE_SETTING.STRETCH){
this.scaleStrategyObj=new web.data.components.resources.image.StretchRender
}
if(this.scaleStrategy===web.data.components.resources.Image.SCALE_SETTING.FIT){
if(Math.abs(this.getInnerWidth()/this.getInnerHeight()-this.asset.width/this.asset.height)>0.01){
this.autoHeight=this.getInnerHeightWithoutAuto();
this.bbox.bottom=this.bbox.top+this.autoHeight
}
}
if(this.anchorTop===null||typeof this.anchorTop==='undefined'||isNaN(this.anchorTop)||this.anchorLeft===null||typeof this.anchorLeft==='undefined'||isNaN(this.anchorLeft)){
this.anchorTop=50;
this.anchorLeft=50
}
},
setAsset:function(asset){
this.asset=this.dm.create(Ext.applyIf({
parent:this,
type:'web.data.assets.Image'
},asset))
},
getWidth:function(){
var w=web.data.components.resources.Image.superclass.getWidth.call(this);
if(w===null||typeof w==='undefined'){
w=this.MIN_WIDTH
}
return w
},
getHeight:function(){
var h=web.data.components.resources.Image.superclass.getHeight.call(this);
if(this.scaleStrategy===web.data.components.resources.Image.SCALE_SETTING.FIT){
if(this.savedInWbtgen){
if(this.rotation%180===90){
h=this.getInnerWidth()*this.asset.width/this.asset.height
}else{
h=this.getInnerWidth()*this.asset.height/this.asset.width
}
if(this.style&&this.style.border&&this.style.border.width){
var border=this.style.border.width;
h+=border.top+border.bottom
}
}else{
if(this.rotation%180===90){
h=this.getWidth()*this.asset.width/this.asset.height
}else{
h=this.getWidth()*this.asset.height/this.asset.width
}
}
}
return h
},
getInnerHeightWithoutAuto:function(){
var height=this.getHeight(),spacing=this.getSpacing();
return Math.max(0,height-spacing.top-spacing.bottom)
},
getScale:function(){
return Math.max(this.scale||1,this.getMinZoom())
},
getMinZoom:function(override){
override=override||{};
var asset=this.getAsset(),wr,hr,rotation,minScale;
if(typeof override.rotation!=='undefined'){
rotation=override.rotation
}else{
rotation=this.rotation
}
if(rotation%180===90){
wr=this.getInnerWidth()/asset.getHeight();
hr=this.getInnerHeight()/asset.getWidth()
}else{
wr=this.getInnerWidth()/asset.getWidth();
hr=this.getInnerHeight()/asset.getHeight()
}
minScale=Math.max(wr,hr);
return minScale
},
getMaxZoom:function(){
var userHappiness=2,moreZoom=Math.ceil(this.getMinZoom()*10*userHappiness)/10;
return Math.max(this.getScale(),1,moreZoom)
},
getAction:function(){
return this.action
},
getCSSClass:function(){
return('id'+this.id).replace(/[^a-z0-9 ]+/gi,'')
},
getBlockRenderClass:function(doc){
var cls=web.data.components.resources.Image.superclass.getBlockRenderClass.call(this,doc);
cls='chrome-border-fix image'+(cls?' '+cls:'');
cls+=this.isContainer()?' '+this.getCSSClass():'';
cls+=doc.isMobile()&&this.isMobileLeaf()&&this.isMobileHide()?' mobile-forcehide':'';
return cls
},
getRenderClass:function(doc){
var cls=web.data.components.resources.Image.superclass.getRenderClass.call(this,doc);
return'imageself'+(cls?' '+cls:'')
},
renderSelf:function(doc){
this.scaleStrategyObj.render(doc,this)
},
isActive:function(){
return this.lightBoxEnabled||this.action
},
renderLinkStart:function(doc){
var html,url,target,action=this.action,title=this.title,htmlEncode=Ext.util.Format.htmlEncode,isContainer=this.isContainer();
if(!doc.editMode){
var style='';
if(isContainer){
style=' style="width:100%;min-height:'+this.getInnerHeight()+'px;"'
}
if(this.lightBoxEnabled){
doc.requireScript('shinybox');
url=this.asset.getRelativeUrl(doc.getAssetURL());
if(this.rotation){
url+='?rotate='+this.rotation
}
if(isContainer){
var fakeHref=htmlEncode(url);
if(!doc.editMode&&!doc.previewMode){
var rootPath='//'+doc.domain+'/';
fakeHref=this.asset.getURL().replace('webspace:/',rootPath)
}
html='<div href="'+fakeHref+'" rel="lightbox[oneweb]" class="shinybox container-link" title="'+htmlEncode(title)+'"'
}else{
html='<a href="'+htmlEncode(url)+'" rel="lightbox[oneweb]" class="shinybox" title="'+htmlEncode(title)+'"'
}
html+=style;
html+='>'
}else if(action){
url=action.getURL(doc);
target=action.getTarget();
html=function(){
var str='',urlEncoded=htmlEncode(url);
var externalLinkInPreviewMode=doc.previewMode&&document.createElement&&web.utils.String.isExternal(url);
if(isContainer){
str+='<div';
if(urlEncoded){
if(!externalLinkInPreviewMode){
str+=' onclick="linkOpener(event, \''+this.getId().replace(/\-/g,'')+'\', GETSTATICURL(\''+urlEncoded+'\'), \''+(target||'_self')+'\')"'
}
str+=' class="container-link"'
}
}else{
str+='<a';
str+=target?' target="'+target+'"':'';
str+=' href="'+(urlEncoded||'javascript:void(0);')+'"';
if(!externalLinkInPreviewMode){
str+=this.inImageWithLink()?' onclick="event.stopPropagation();"':''
}
}
str+=' title="'+htmlEncode(title);
if(doc.previewMode){
var msg='';
if(url){
if(externalLinkInPreviewMode){
msg='External links do not work when previewing. Please publish your site to test this link.'
}
}else{
msg='Broken link.'
}
if(msg&&title){
msg=' - '+msg
}
str+=msg
}
str+='"';
str+=style;
str+='>';
return str
}.call(this)
}
doc.appendToBody(html)
}
},
renderLinkEnd:function(doc){
if(!doc.editMode&&(this.lightBoxEnabled||this.action)){
doc.appendToBody(this.isContainer()?'</div>':'</a>')
}
},
toJSON:function(){
var json=web.data.components.resources.Image.superclass.toJSON.call(this);
json=Ext.apply(json,{
title:this.title,
anchorTop:this.anchorTop,
anchorLeft:this.anchorLeft,
scale:this.getScale(),
rotation:this.rotation,
scaleStrategy:this.scaleStrategy,
cropTop:this.cropTop,
cropLeft:this.cropLeft,
savedInWbtgen:this.savedInWbtgen
});
if(this.lightBoxEnabled){
json.lightBoxEnabled=true
}else if(this.action){
json.action=this.action.toJSON()
}
return json
},
percentToPixels:function(){
var asset=this.getAsset(),comp,rotAsset,scaledAsset,top,left,scale,rect;
top=Ext.isNumber(this.anchorTop)?this.anchorTop:50;
left=Ext.isNumber(this.anchorLeft)?this.anchorLeft:50;
scale=this.getScale();
comp={
w:this.getInnerWidth(),
h:this.getInnerHeight()
};
if(this.rotation%180===90){
rotAsset={
w:asset.getHeight(),
h:asset.getWidth()
}
}else{
rotAsset={
w:asset.getWidth(),
h:asset.getHeight()
}
}
scaledAsset={
w:Math.max(rotAsset.w*scale,1),
h:Math.max(rotAsset.h*scale,1)
};
rect={
left:comp.w/2-scaledAsset.w/2+(comp.w-scaledAsset.w)*(left/100-0.5),
top:comp.h/2-scaledAsset.h/2+(comp.h-scaledAsset.h)*(top/100-0.5),
width:scaledAsset.w,
height:scaledAsset.h
};
return rect
},
isFixedHeight:function(){
return true
},
isContentHeight:function(){
return false
},
isAnimated:function(){
return this.asset&&this.asset.isAnimated()
},
isMobileLeaf:function(){
var that=this,item=that,parent;
if(!this.isAllItemsMobileHidden()){
return false
}
while(item&&(parent=item.getRelInParent())){
if(item.getRelPara()){
return false
}
if(!parent.isContainer()){
return true
}
item=parent
}
return true
},
isAllItemsMobileHidden:function(){
var comps=this.getRelInItems(),i=0;
while(i<comps.length){
if(comps[i].type!=='web.data.components.Block'&&!comps[i].wrap&&!comps[i].mobileHide){
return false
}
comps=comps.concat(comps[i].getRelInItems());
i++
}
return true
},
isMobileBase:function(){
return false
},
getAspectRatio:function(){
return this.asset&&this.asset.height>0&&this.asset.width>0?this.asset.width/this.asset.height:1
},
getSnapSize:function(){
return{
width:this.asset.width,
height:this.asset.height
}
},
isRatioLock:function(){
return this.scaleStrategy===web.data.components.resources.Image.SCALE_SETTING.FIT
},
onBeforeBboxChanged:function(changes,state){
var componentBBox=state&&state.bbox||this.bbox;
if(changes.bbox&&this.scaleStrategy===web.data.components.resources.Image.SCALE_SETTING.CROP){
if(changes.bbox.left!==componentBBox.left){
changes.cropLeft=Math.max(0,this.cropLeft+changes.bbox.left-componentBBox.left)
}
if(changes.bbox.top!==componentBBox.top){
changes.cropTop=Math.max(0,this.cropTop+changes.bbox.top-componentBBox.top)
}
changes.scale=Math.max(this.scale,this.getMinZoom())
}
},
isContainer:function(){
return!this.scaleStrategyObj.isAlwaysClientSide(this)&&this.getRelInItems().length
},
renderSelfStart:function(doc){
web.data.components.resources.Image.superclass.renderSelfStart.call(this,doc);
if(!doc.editMode){
doc.requireScript('jquery');
doc.requireScript('linkOpener')
}
this.renderLinkStart(doc)
},
renderSelfEnd:function(doc){
this.renderLinkEnd(doc);
web.data.components.resources.Image.superclass.renderSelfEnd.call(this,doc)
},
getBlockRenderStyle:function(doc){
var style=web.data.components.resources.Image.superclass.getBlockRenderStyle.call(this,doc);
if(this.isContainer()&&!doc.editMode){
var assetUrlObj=this.scaleStrategyObj.getHtmlUrl(doc,this);
var ratio=Math.round(this.getHeight()/this.getWidth()*1000000)/1000000;
var hdStyle='',cssClass=this.getCSSClass();
Object.keys(assetUrlObj.cssUrls).forEach(function(ppr){
if(ppr>1){
hdStyle+='@media (-webkit-min-device-pixel-ratio:'+ppr+'),(min-resolution:'+ppr+'dppx),(min-resolution:'+ppr*96+'dpi) {'
}
hdStyle+='.'+cssClass+' {'+'background:transparent url("") top/cover no-repeat;'+'background-image:url("'+assetUrlObj.cssUrls[ppr]+'");'+'}';
if(ppr>1){
hdStyle+='}\n'
}
});
doc.appendToCSS(hdStyle);
doc.appendToCSSMobile('.'+this.getCSSClass()+':not(.mobile-base-moved)'+'{min-height:calc(100vw * '+ratio+')!important;}')
}
return style
}
});
web.data.components.resources.Image.NAME='Image';
web.data.components.resources.Image.RenderTemplate=null;
web.data.components.resources.Image.DIMENSION_LIMIT=web.Constants.imageScaleMaxPixels;
web.data.components.resources.Image.SCALE_SETTING={
CROP:'crop',
FIT:'fit',
STRETCH:'stretch'
};
Ext.ns('web.data.components.widgets');
web.data.components.widgets.Setting=Ext.extend(Object,{
constructor:function(cfg){
this.name='';
this.note='';
this.help='';
this.param=null;
this.ref='';
this.type='String';
this.value=null;
this.xtype='web-widget-ui-text';
this.set(cfg)
},
set:function(cfg){
Ext.apply(this,cfg)
},
toJSON:function(){
var json={};
if(this.help){
json.help=this.help
}
if(this.name){
json.name=this.name
}
if(this.note){
json.note=this.note
}
if(this.ref){
json.ref=this.ref
}
if(this.type){
json.type=this.type
}
if(this.param){
json.param=this.param
}
if(this.value!==null){
json.value=this.value
}
if(this.xtype){
json.xtype=this.xtype
}
return json
},
getName:function(){
return this.name
},
getNote:function(){
return this.note
},
getHelp:function(){
return this.help
},
getRef:function(){
return this.ref
},
getField:function(){
return this.field
},
getType:function(){
return this.type
},
getParam:function(){
return this.param
},
getValue:function(){
return this.value
},
getWidget:function(){
return this.parent.parent
},
getWidth:function(){
return Ext.isNumber(this.width)?this.width:'auto'
},
getXType:function(){
return this.xtype
},
setValue:function(newValue){
this.value=newValue
}
});
web.data.components.widgets.Settings=Ext.extend(Object,{
constructor:function(items){
this.reservedWords=[
'id',
'width'
];
this.items=[];
this.set(items)
},
set:function(cfg){
var newCfg=Ext.isArray(cfg)?{items:cfg}:Ext.apply({},cfg),items=newCfg.items;
if(items){
if(this.items.length){
this.items=[]
}
items.forEach(function(itemCfg){
this.addItem(new web.data.components.widgets.Setting(itemCfg))
},this);
delete newCfg.items
}
Ext.apply(this,newCfg)
},
setItem:function(ref,value){
this.getItem(ref).value=value
},
toJSON:function(){
var json=[];
this.items.forEach(function(item){
json.push(item.toJSON())
},this);
return json
},
addItem:function(setting){
var ref=setting.getRef();
if(this.reservedWords.indexOf(ref)===-1){
setting.set({parent:this});
this.items.push(setting)
}
},
removeItem:function(setting){
var index=this.items.indexOf(setting);
if(index!==-1){
this.items.splice(index,1);
setting.set({parent:null})
}
return index
},
getItem:function(ref){
var result=null;
this.items.forEach(function(item){
if(item.getRef()===ref){
result=item;
return
}
},this);
return result
},
getItems:function(){
var items=[];
this.items.forEach(function(item){
items.push(item)
},this);
return items
},
getItemRefs:function(){
var settings={};
this.items.forEach(function(item){
settings[item.ref]=item
});
return settings
},
getValues:function(){
var settings={},ref;
this.items.forEach(function(item){
ref=item.getRef();
if(ref.length>0){
settings[ref]=item.getValue()
}
});
return settings
}
});
web.utils.TinyTemplate=Ext.extend(Object,{
isQuoted:function(str){
var s=str[0],e=str[str.length-1];
return s==='"'&&e==='"'||s==='\''&&e==='\''
},
reference:function(part,data){
var sub=part.split('.'),val=data,j;
for(j=0;j<sub.length;j+=1){
if(Ext.isDefined(val[sub[j]])){
val=val[sub[j]]
}else{
throw'Cannot reference {'+part+'}'
}
}
return val
},
strEscape:function(str){
return str.replace(/([^\\]|^)(['"])/g,'$1\\$2')
},
strUnescape:function(str){
return str.slice(1,-1).replace(new RegExp('\\\\([\'"])','g'),'$1')
},
processIfHead:function(expr,data){
var lvalue='([a-zA-Z_$][0-9a-zA-Z_$]*\\.)*[a-zA-Z_$][0-9a-zA-Z_$]*',op='[<>=!]{2,3}',rvalue='("([^"\\\\]|\\\\.)*")|(\'([^\'\\\\]|\\\\.)*\')|[0-9\\.]+|true|false',regex='{[ ]*if[ ]*(('+lvalue+')[ ]*('+op+')[ ]*('+rvalue+'))[ ]*}.+',matches=expr.match(new RegExp(regex,'')),result=null,numRegEx;
if(matches!==null&&matches.length>1){
lvalue=matches[2];
op=matches[4];
rvalue=matches[5];
numRegEx=new RegExp('[0-9]+(\\.[0-9]+)*','');
if(this.isQuoted(rvalue)){
rvalue=this.strUnescape(rvalue)
}else if(rvalue==='true'||rvalue==='false'){
rvalue=rvalue==='true'
}else if(numRegEx.test(rvalue)){
rvalue=parseFloat(rvalue)
}
lvalue=this.reference(lvalue,data);
switch(op){
case'==':
result=lvalue===rvalue;
break;
case'!==':
result=lvalue!==rvalue;
break;
case'<=':
result=lvalue<=rvalue;
break;
case'>=':
result=lvalue>=rvalue;
break;
case'>':
result=lvalue>rvalue;
break;
case'<':
result=lvalue<rvalue;
break
}
}
return result
},
process:function(tpl,data){
var objectNotation='(?:[a-zA-Z_$][0-9a-zA-Z_$]*\\.)*[a-zA-Z_$][0-9a-zA-Z_$]*',op='[<>=!]{2,3}',rvalue='(?:"(?:[^"\\\\]|\\\\.)*")|(?:\'(?:[^\'\\\\]|\\\\.)*\')|[0-9\\.]+|true|false',regex='{[ ]*if[ ]*(('+objectNotation+')[ ]*('+op+')[ ]*('+rvalue+'))[ ]*}(.+?)(?:{else}(.+?))?{/if}',output=tpl,that=this;
output=output.replace(new RegExp(regex,'g'),function(stmt){
var part,part1,part2,result;
result=that.processIfHead.apply(that,[
stmt,
data
]);
part=stmt.match(new RegExp(regex,''));
part1=part[part.length-2];
part2=part[part.length-1];
if(result){
return part1
}else if(part2){
return part2
}else{
return''
}
});
var reservedWords=['{else}'];
output=output.replace(new RegExp('{'+objectNotation+'}','g'),function(part){
if(reservedWords.indexOf(part)===-1){
var partCopy=part;
part=part.slice(1,-1).trim();
try{
return that.reference.apply(that,[
part,
data
])
}catch(e){
one.debug(e);
return partCopy
}
}
});
return output
}
});
web.data.components.widgets.Widget=Ext.extend(web.data.components.Component,{
type:'web.data.components.widgets.Widget',
constructor:function(config){
this.init();
this.settings=new web.data.components.widgets.Settings({parent:this});
web.data.components.widgets.Widget.superclass.constructor.call(this,config)
},
init:function(){
},
getDataValues:function(doc){
var data={
id:this.getId(),
width:this.getWidth(),
height:this.getHeight()
};
Ext.apply(data,this.settings.getValues());
if(this.minHeight){
if(data.height<this.minHeight){
data.height=this.minHeight
}
}
return data
},
getCode:function(doc){
var renderedCode={},data=this.getDataValues(doc),ttemplate=new web.utils.TinyTemplate;
Ext.iterate(this.code,function(location,value){
if(value instanceof Array){
var html='',js='',len=value.length,i,codeObj;
renderedCode[location]=[];
for(i=0;i<len;i+=1){
codeObj=value[i];
renderedCode[location][i]={};
if(location!=='onload'){
if(codeObj.html){
html=ttemplate.process(codeObj.html,data);
renderedCode[location][i].html=html
}else{
renderedCode[location][i].html='';
one.debug('Widget '+this.getName()+': code.'+location+'['+i+'].html isn\'t set.')
}
}else{
if(codeObj.js){
js=ttemplate.process(codeObj.js,data);
renderedCode[location][i].js=js
}else{
renderedCode[location][i].js='';
one.debug('Widget '+this.getName()+': code.onload['+i+'].js isn\'t set.')
}
}
if(typeof codeObj.once!=='undefined'){
renderedCode[location][i].once=codeObj.once
}
}
}else{
one.debug('Widget '+this.getName()+': code.'+location+' isn\'t an array.')
}
},this);
return renderedCode
},
getCompanyName:function(){
return this.companyName
},
getHelp:function(){
return this.help
},
getIconCls:function(){
return'icon'
},
getIconId:function(){
return this.iconId
},
getIcon:function(){
return this.dm.get(this.iconId)
},
getInfo:function(){
return this.info
},
getLocation:function(){
return web.data.components.Code.locationTypes[this.location]?this.location:''
},
getName:function(){
return this.name
},
getNameHTML:function(){
return this.name||web.data.components.Code.NAME
},
getInfoHTML:function(){
var info=this.info,oldLen=info.length,newLen,splitLine;
info=info.substr(0,144);
newLen=info.length;
info=info.replace(/\&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
if(!this.info){
splitLine=info.split('\n')
}
if(newLen<oldLen||!this.info&&splitLine.length>4){
if(!this.info){
if(splitLine.length>1){
splitLine.pop();
info=splitLine.slice(0,4).join('\n')
}
info+='\n'
}
info+='...'
}
return info?this.info?info:'<div class="codedevcode">'+info+'</div>':'&nbsp;'
},
getDevCode:function(){
return'<div data-id="'+this.getId()+'" class="codedev">'+'<div class="codedevicon '+this.getIconCls()+'"></div>'+'<div class="codedevtext">'+'<div class="codedevname">'+this.getNameHTML()+'</div>'+'<div class="codedevinfo">'+this.getInfoHTML()+'</div>'+'</div><div class="codedevend"></div></div>'
},
getRef:function(){
return this.ref
},
getTerms:function(){
return this.terms
},
getSetting:function(ref){
return this.settings.getItem(ref)
},
getSettings:function(){
return this.settings
},
set:function(opts){
var newOpts=Ext.apply({},opts);
if(opts.settings){
this.settings.set(opts.settings);
delete newOpts.settings
}
web.data.components.widgets.Widget.superclass.set.call(this,newOpts)
},
setSetting:function(ref,value){
this.settings.setItem(ref,value)
},
isEditSafe:function(){
return this.editSafe
},
isGhost:function(){
return!!this.getLocation()
},
appendSelf:function(doc,code,once){
doc.append(code,!!once)
},
appendHead:function(doc,code,once){
doc.appendToHead(code,!!once)
},
appendBody:function(doc,code,once){
doc.appendToFooter(code,!!once)
},
prependBody:function(doc,code,once){
doc.prependToBody(code,!!once)
},
addOnloadScript:function(doc,code,once){
doc.addOnloadScript(code,!!once)
},
appendDev:function(doc){
this.renderSelfStart(doc);
doc.append(this.getDevCode());
this.renderSelfEnd(doc)
},
appendDevHead:function(doc){
doc.appendToDevHead(this.getDevCode())
},
appendDevBodyEnd:function(doc){
doc.appendToDevFooter(this.getDevCode())
},
addBodyInplaceCode:function(doc,code,editSafe){
var len,i,codeObj;
if(code.inplace){
len=code.inplace.length;
for(i=0;i<len;i+=1){
codeObj=code.inplace[i];
if(!editSafe){
this.appendSelf(doc,codeObj.html,codeObj.once)
}else{
this.appendSelf(doc,'<div style="height:'+this.getInnerHeight()+'px;" class="web-widget">'+codeObj.html+'</div>',codeObj.once)
}
}
}
},
addHeadCode:function(doc,code){
if(code.head){
var len=code.head.length,i,codeObj;
for(i=0;i<len;i+=1){
codeObj=code.head[i];
this.appendHead(doc,codeObj.html,codeObj.once)
}
}
},
addBodyHeadCode:function(doc,code){
if(code.bodyHead){
var len=code.bodyHead.length,i,codeObj;
for(i=0;i<len;i+=1){
codeObj=code.bodyHead[i];
this.prependBody(doc,codeObj.html,codeObj.once)
}
}
},
addBodyEndCode:function(doc,code){
if(code.bodyEnd){
var len=code.bodyEnd.length,i,codeObj;
for(i=0;i<len;i+=1){
codeObj=code.bodyEnd[i];
this.appendBody(doc,codeObj.html,codeObj.once)
}
}
},
addOnloadCode:function(doc,code){
if(code.onload){
var len=code.onload.length,i,codeObj;
for(i=0;i<len;i+=1){
codeObj=code.onload[i];
this.addOnloadScript(doc,codeObj.js,codeObj.once)
}
}
},
toJSON:function(){
var json;
json=web.data.components.widgets.Widget.superclass.toJSON.call(this);
json.settings=this.settings.toJSON();
return json
},
renderSelf:function(doc){
var renderedCode;
if(doc.editMode&&!this.editSafe){
this['appendDev'+this.getLocation()](doc)
}else{
this.renderSelfStart(doc);
if(doc.editMode&&this.editSafe){
renderedCode=this.getCode(doc);
this.addBodyHeadCode(doc,renderedCode);
this.addBodyInplaceCode(doc,renderedCode,true)
}else{
renderedCode=this.getCode(doc);
this.addHeadCode(doc,renderedCode);
this.addOnloadCode(doc,renderedCode);
this.addBodyHeadCode(doc,renderedCode);
this.addBodyInplaceCode(doc,renderedCode,false);
this.addBodyEndCode(doc,renderedCode)
}
this.renderSelfEnd(doc)
}
}
});
web.utils.clone=function(obj){
var copy,i,len,attr;
if(obj===null||typeof obj!=='object'){
return obj
}
if(obj instanceof Date){
copy=new Date;
copy.setTime(obj.getTime());
return copy
}
if(obj instanceof Array){
copy=[];
for(i=0,len=obj.length;i<len;i+=1){
copy[i]=web.utils.clone(obj[i])
}
return copy
}
if(obj instanceof Object){
copy={};
for(attr in obj){
if(obj.hasOwnProperty(attr)){
copy[attr]=web.utils.clone(obj[attr])
}
}
return copy
}
throw new Error('Unable to copy obj! Its type isn\'t supported.')
};
web.data.components.widgets.PresetWidget=Ext.extend(web.data.components.widgets.Widget,{
type:'web.data.components.widgets.PresetWidget',
constructor:function(config){
if(!config.settings){
config.settings=web.utils.clone(this.defaultSettings)
}else{
var userSettings=config.settings,ref={};
Ext.each(userSettings,function(item,index){
if(item.ref&&Ext.isString(item.ref)){
ref[item.ref]=item
}
});
var defaultSettings=web.utils.clone(this.defaultSettings);
Ext.each(defaultSettings,function(item,index){
item.value=ref[item.ref]?ref[item.ref].value:null
}.createDelegate(this));
config.settings=defaultSettings
}
web.data.components.widgets.PresetWidget.superclass.constructor.call(this,config)
},
toJSON:function(){
var json;
json=web.data.components.Code.superclass.toJSON.call(this);
json.settings=[];
Ext.each(this.settings.getItems(),function(item,index){
if(item.ref&&Ext.isString(item.ref)){
json.settings.push({
ref:item.ref,
value:item.getValue()
})
}
});
return json
}
});
web.data.components.widgets.Youtube=Ext.extend(web.data.components.widgets.PresetWidget,{
code:{inplace:[{html:'<iframe id="video-{id}" class="youtube-player" type="text/html" width="{width}" height="{height}" allowfullscreen '+'src="{href.output}'+'{if showInfo == false}'+'&showinfo=0'+'{/if}'+'{if autoPlay == true}'+'&autoplay=1'+'{/if}'+'{if repeat == true}'+'&loop=1&playlist={href.videoId}'+'{/if}'+'{if showControls == false}'+'&controls=0'+'{/if}'+'" frameborder="0"></iframe>'}]},
companyName:'Youtube',
editSafe:true,
help:'',
info:'',
location:'',
name:'Youtube Video',
ref:'',
type:'web.data.components.widgets.Youtube',
defaultSettings:[
{
type:'Object',
xtype:'web-widget-ui-texttransform',
param:{
regex:'(?:http|https)://www\\.youtube\\.com/watch\\?v=([^&]+).*',
transform:'https://www.youtube.com/embed/{\\1}?wmode=transparent&enablejsapi=1'
},
note:'eg https://www.youtube.com/watch?v=xxx-xxxxxxx',
name:'Link to Video',
ref:'href',
value:{
input:'',
output:''
}
},
{
type:'Boolean',
xtype:'web-widget-ui-boolean',
name:'Show information about video',
ref:'showInfo',
value:true
},
{
type:'Boolean',
xtype:'web-widget-ui-boolean',
name:'Start playing automatically',
ref:'autoPlay',
value:false
},
{
type:'Boolean',
xtype:'web-widget-ui-boolean',
name:'Play video again when it ends',
ref:'repeat',
value:false
},
{
type:'Boolean',
xtype:'web-widget-ui-boolean',
name:'Show controls',
ref:'showControls',
value:true
}
],
constructor:function(config){
web.data.components.widgets.Youtube.superclass.constructor.call(this,config)
},
getDataValues:function(doc){
var data=web.data.components.widgets.Youtube.superclass.getDataValues.apply(this,arguments);
if(doc.editMode||doc.templateSelectorPreviewMode){
data.autoPlay=false
}
if(!data.href.output){
data.href.output=''
}
return data
},
toJSON:function(){
var json=web.data.components.widgets.Youtube.superclass.toJSON.call(this);
var i,len=json.settings.length,data;
for(i=0;i<len;i+=1){
data=json.settings[i];
if(data.ref==='href'){
json.settings[i].value={input:data.value.input};
break
}
}
return json
},
isFixedHeight:function(){
return true
},
renderSelf:function(doc){
web.data.components.widgets.Youtube.superclass.renderSelf.call(this,doc);
var w,h,maxW,mobileW,mobileH,id;
if(doc.isMobile()){
w=this.getWidth();
h=this.getHeight();
id=this.getId();
maxW=300-10*2;
mobileW=maxW;
mobileH=Math.round(h*maxW/w);
doc.appendToCSSMobile('#video-'+id+'{width:100%!important;height:'+mobileH+'px!important;}\n')
}
}
});
web.data.components.widgets.Youtube.NAME='Video';
web.data.components.ImageSlider=Ext.extend(web.data.components.Component,{
type:'web.data.components.ImageSlider',
MIN_WIDTH:128,
MIN_HEIGHT:64,
indicator:null,
navigator:null,
autoNext:null,
transition:null,
delay:null,
lightbox:false,
links:false,
captionsEnabled:false,
captionsAlignment:'left',
captionsPlacement:'bottom',
crop:false,
constructor:function(cfg){
this.indicator=web.data.components.ImageSlider.Options.NEVER;
this.navigator=web.data.components.ImageSlider.Options.MOUSEOVER;
this.autoNext=true;
this.transition='slide';
this.delay=5;
this.slides=[];
web.data.components.ImageSlider.superclass.constructor.call(this,cfg)
},
getWidth:function(){
var w=web.data.components.ImageSlider.superclass.getWidth.call(this);
return w
},
getCurrentSlide:function(){
var el=oneJQuery('#slidesjs-'+this.id),owl=el&&el.data&&el.data('owlCarousel'),index=0;
if(owl&&owl.currentItem){
index=owl.currentItem>=this.slides.length?0:owl.currentItem
}
return index
},
isLightboxEnabled:function(){
return this.lightbox
},
isLinksEnabled:function(){
return this.links
},
set:function(cfg){
web.data.components.ImageSlider.superclass.set.call(this,cfg);
if(!cfg.slides&&cfg.assets){
cfg.slides=cfg.assets.map(function(item){
var json={};
json.asset=item;
json.action=item.action;
json.caption=item.caption;
return json
})
}
if(cfg.slides){
this.slides=[];
cfg.slides.forEach(function(item){
var json={},asset=this.dm.create(Ext.applyIf({
parent:this,
type:'web.data.assets.Image'
},item.asset)),action;
json.asset=asset;
if(item.action instanceof web.data.Action){
item.action.dm=this.dm;
item.action.parent=this;
action=item.action
}else if(item.action===null){
action=null
}else if(item.action){
action=new web.data.Action(Ext.apply({
dm:this.dm,
parent:this
},item.action))
}
json.action=action;
json.caption=item.caption;
this.slides.push(json)
},this);
delete cfg.slides
}
},
getSlides:function(){
return this.slides
},
getAssets:function(){
return this.slides.map(function(slide){
return slide.asset
})
},
addAsset:function(asset){
var json={};
asset=this.dm.create(Ext.applyIf({parent:this},asset));
json.asset=asset;
json.caption='';
this.slides=this.slides||[];
this.slides.push(json)
},
renderSelf:function(doc){
var docAssetUrl=doc.getAssetURL(),html,script,images='',compId='slidesjs-'+this.getId(),navigator,indicator,notEnoughImagesMode=this.getSlides().length<=1,that=this,style;
doc.requireScript('shinybox');
this.renderSelfStart(doc);
var tempArray=this.getSlides().concat();
if(this.getSlides().length&&this.transition==='slide'){
tempArray.push(this.getSlides()[0])
}
tempArray.forEach(function(image,index){
var asset=image.asset,etag=asset.getETag(),url,target,title='',text,bgStyle,bgClass,reduceFactor,slidew,slideh,hdImages=doc.hdImages,hdStyle='',params;
var urlForImagePixelRatioOne='';
bgClass=('slide'+asset.getId()).replace(/[^a-z0-9]+/gi,'');
web.Constants.imagePixelRatios.forEach(function(pixelRatio){
params=[];
if(etag){
params.push('etag='+encodeURIComponent(etag))
}
if(asset.width>this.getInnerWidth()&&!(asset.contentType==='image/gif'&&asset.animated===true)){
params.sourceContentType=asset.contentType;
slidew=this.getInnerWidth();
slideh=asset.height*this.getInnerWidth()/asset.width;
if(hdImages){
slidew=slidew*pixelRatio;
slideh=slideh*pixelRatio
}
reduceFactor=web.utils.ImageSize.getReduceFactor(slidew,slideh,asset.width,asset.height);
slidew=Math.round(slidew*reduceFactor);
slideh=Math.round(slideh*reduceFactor);
params.push('resize='+slidew+','+slideh)
}
url=asset.getRelativeUrl(docAssetUrl);
url=url.replace(/'/g,'%27').replace(/\(/g,'%28').replace(/\)/g,'%29');
if(params.length>0){
url+='?'+params.join('&')
}
if(pixelRatio===1){
urlForImagePixelRatioOne=url
}
if(pixelRatio>1){
hdStyle+='@media (-webkit-min-device-pixel-ratio:'+pixelRatio+'),(min-resolution:'+pixelRatio+'dppx),(min-resolution:'+pixelRatio*96+'dpi) {\n'
}
hdStyle+='.'+bgClass+' {\n'+'background: url("") 50% no-repeat;\n'+'background-image:url("'+url+'") !important;\n'+'}\n';
if(pixelRatio>1){
hdStyle+='}\n'
}
},this);
doc.appendToCSS(hdStyle);
text=image.caption?Ext.util.Format.nl2br(Ext.util.Format.htmlEncode(image.caption)):doc.editMode?doc.labels.emptyText:'';
if(this.isCaptionEnabled()&&text){
images+='<div class="slide-cntnr textnormal '+this.getCaptionsPlacement()+'" style="min-height:@height;max-height:@height;">'+'<p class="slider-caption" style="text-align:'+this.getCaptionsAlignment()+'"><span>'+text+'</span></p>'
}
bgStyle='background: url(&quot;'+(urlForImagePixelRatioOne||url)+'&quot;) 50% no-repeat;';
bgStyle+='width:100%;background-size:'+(this.getCrop()?'cover':'contain')+';display:block;min-height:@height;max-height:@height;';
if(!doc.editMode&&image.action&&this.isLinksEnabled()){
target=image.action.getTarget();
images+='<a href="'+Ext.util.Format.htmlEncode(image.action.getURL(doc))+'"'+(target?' target="'+target+'"':'')+' title="'+title+'" onclick="event.stopPropagation();">';
images+='<div class="slider-item '+bgClass+'" data-assetId="'+asset.getId()+'" style="'+bgStyle+'"></div>';
images+='</a>'
}else if(!doc.editMode&&this.isLightboxEnabled()&&index<this.slides.length){
images+='<a href="'+asset.getRelativeUrl(doc.getAssetURL())+'" rel="'+this.id+'" class="shinybox"'+' title="'+title+'" onclick="event.stopPropagation();">';
images+='<div class="slider-item '+bgClass+'" data-assetId="'+asset.getId()+'" style="'+bgStyle+'"></div>';
images+='</a>'
}else{
images+='<div class="slider-item '+bgClass+'" data-assetId="'+asset.getId()+'" style="'+bgStyle+'"></div>'
}
if(this.isCaptionEnabled()&&text){
images+='</div>'
}
},this);
if(doc.editMode&&that._startValue===undefined){
style='z-index:-1;position:relative;min-height:@height;max-height:@height;overflow:hidden'
}else{
style='position:relative;min-height:@height;max-height:@height;overflow:hidden'
}
html='<div id="@id" style="'+style+'" class="owl-carousel owl-theme @owl-dontrewind @navigation-attitude @pagination-attitude">'+images+'</div>';
if(this.transition==='slide'){
html=html.replace('@owl-dontrewind','owl-dontrewind')
}else{
html=html.replace('@owl-dontrewind','')
}
navigator=this.navigator;
indicator=this.indicator;
if(notEnoughImagesMode){
navigator=web.data.components.ImageSlider.Options.NEVER;
indicator=web.data.components.ImageSlider.Options.NEVER
}
html=html.replace(/@id/g,compId).replace(/@width/g,this.getInnerWidth()+'px').replace(/@height/g,this.getInnerHeight()+'px').replace(/@navigation-attitude/g,'owl-navigation-visibility-'+navigator).replace(/@pagination-attitude/g,'owl-pagination-visibility-'+indicator);
var json={
slideSpeed:1024,
singleItem:true,
itemsScaleUp:true,
autoPlay:false,
afterAction:function(){
var cb;
if(doc.editMode){
cb=function(){
var that=this;
clearTimeout(this.preemptFirstSlideTimo);
if(!this.options.transitionStyle){
if(this.currentItem===this.itemsAmount-1){
if(this.prevItem!==0){
setTimeout(function(){
that.jumpTo(0)
},1024)
}else{
that.jumpTo(that.currentItem);
setTimeout(function(){
that.goTo(that.currentItem-1)
},10)
}
}
}
oneJQuery('#'+compId+' .slider-caption').each(function(){
var el=oneJQuery(this);
if(el.parent().width()-10<=0){
return
}
el.width(el.parent().width()-10)
});
oneJQuery('#'+compId+' .slide-cntnr.middle p.slider-caption').each(function(){
var el=oneJQuery(this);
el.height(el.find('span').height())
})
}
}else{
cb=function(){
var that=this;
clearTimeout(this.preemptFirstSlideTimo);
if(!this.options.transitionStyle){
if(this.currentItem===this.itemsAmount-1){
if(this.prevItem!==0){
setTimeout(function(){
that.jumpTo(0)
},1024)
}else{
that.jumpTo(that.currentItem);
setTimeout(function(){
that.goTo(that.currentItem-1)
},10)
}
}else if(this.currentItem===0&&this.options.autoPlay){
this.preemptFirstSlideTimo=setTimeout(function(){
that.goTo(1)
},this.options.autoPlay-1024)
}
}
oneJQuery('#@id .slider-caption').each(function(){
var el=oneJQuery(this);
el.width(el.parent().width()-10)
});
oneJQuery('#@id .slide-cntnr.middle p.slider-caption').each(function(){
var el=oneJQuery(this);
el.height(el.find('span').height())
})
}
}
return cb
}(),
afterMove:function(){
if(doc.editMode){
web.data.components.ImageSlider.observable.fireEvent('slideChanged',true)
}
},
afterInit:function(){
if(that._startValue>=0){
this.jumpTo(that._startValue);
setTimeout(function(){
web.data.components.ImageSlider.observable.fireEvent('slideChanged',true)
},100)
}
},
navigation:true,
navigationText:[
'',
''
]
},ratio;
if(this.transition==='fade'){
Ext.apply(json,{transitionStyle:'fade'})
}else if(this.transition==='backSlide'){
Ext.apply(json,{transitionStyle:'backSlide'})
}else if(this.transition==='goDown'){
Ext.apply(json,{transitionStyle:'goDown'})
}else if(this.transition==='scaleUp'){
Ext.apply(json,{transitionStyle:'scaleUp'})
}else{
Ext.apply(json,{transitionStyle:false})
}
if(this.autoNext){
Ext.apply(json,{autoPlay:this.delay*1024})
}
if(notEnoughImagesMode){
json.navigation={active:false}
}
script=[
'<script>',
'oneJQuery(function($) {',
'var json = @json;',
'json.afterAction = @afterAction;',
'var $slidejs = $("#@id");',
'if ($slidejs.children().length) {',
'var carousel = $slidejs.owlCarousel(json);',
'carousel.data("owlCarousel").updateVars();',
'var resetHeight = function () {',
'if (window.innerWidth < @mobileMaxWidth) {',
'var ratio = @ratio;',
'if ($("#@id").parents(".textblock").length) {',
'ratio = ratio / 2;',
'}',
'$("#@id").height((window.innerWidth - 40) * ratio);',
'$("#@id .slider-item").height((window.innerWidth - 40) * ratio);',
'$("#@id .slider-caption").parent().height((window.innerWidth - 40) * ratio);',
'}',
'};',
'$(window).resize(resetHeight);',
'resetHeight();',
'}',
'});',
'</script>'
].join('\n');
ratio=this.getInnerWidth()>this.MIN_WIDTH?this.getInnerHeight()/this.getInnerWidth():this.getInnerHeight()/this.MIN_WIDTH;
script=script.replace(/@id/g,compId);
script=script.replace(/@json/g,JSON.stringify(json));
script=script.replace(/@ratio/g,String(ratio));
script=script.replace(/@mobileMaxWidth/g,String(doc.mobileMaxWidth));
script=script.replace(/@afterAction/g,String(json.afterAction).replace(/@id/g,compId));
doc.appendToBody(html);
if(doc.editMode){
setTimeout(function(){
var owl=oneJQuery('#'+compId);
owl.owlCarousel(json)
},0)
}else{
doc.requireScript('imageSlider');
doc.appendToScripts(script)
}
this.renderSelfEnd(doc)
},
toJSON:function(){
var json;
json=web.data.components.ImageSlider.superclass.toJSON.call(this);
json.slides=this.slides.map(function(item){
var json={};
json.asset=item.asset.toJSON();
json.action=item.action instanceof web.data.Action?item.action.toJSON():item.action;
json.caption=item.caption;
return json
});
json.indicator=this.indicator;
json.navigator=this.navigator;
json.autoNext=this.autoNext;
json.transition=this.transition;
json.lightbox=this.lightbox;
json.links=this.links;
json.captionsEnabled=this.captionsEnabled;
json.captionsAlignment=this.captionsAlignment;
json.captionsPlacement=this.captionsPlacement;
json.delay=this.delay;
json.crop=this.crop;
return json
},
getWrapperRenderClass:function(doc){
var cls=web.data.components.ImageSlider.superclass.getWrapperRenderClass.call(this,doc);
return'imageslider'+(cls?' '+cls:'')
},
getRenderClass:function(doc){
var cls=web.data.components.ImageSlider.superclass.getRenderClass.call(this,doc);
return'imagesliderself'+(cls?' '+cls:'')
},
getCaptionsAlignment:function(){
return this.captionsAlignment
},
getCaptionsPlacement:function(){
return this.captionsPlacement
},
getCrop:function(){
return this.crop
},
isContentHeight:function(){
return false
},
isCaptionEnabled:function(){
return this.captionsEnabled
}
});
web.data.components.ImageSlider.NAME='Image Slider';
web.data.components.ImageSlider.Options={
'ALWAYS':'always',
'MOUSEOVER':'mouseover',
'NEVER':'never'
};
web.data.components.ImageSlider.MAX_IMAGES=100;
web.data.components.ImageSlider.Observable=Ext.extend(Ext.util.Observable,{
constructor:function(config){
this.addEvents('slideChanged');
this.listeners=config.listeners;
web.data.components.ImageSlider.Observable.superclass.constructor.call(this,config)
}
});
web.data.components.ShareButtons=Ext.extend(web.data.components.Component,{
type:'web.data.components.ShareButtons',
styleInfo:null,
verbToDisplay:'like',
showFriends:true,
showFacebook:false,
showFacebookShare:true,
showTwitter:true,
showLinkedIn:true,
showGplus:true,
align:'center',
localeMap:{
facebook:{
'cs':'cs_CZ',
'da':'da_DK',
'de':'de_DE',
'en_gb':'en_GB',
'en_us':'en_US',
'es':'es_LA',
'fr':'fr_FR',
'it':'it_IT',
'nl':'nl_NL',
'nb':'nb_NO',
'pl':'pl_PL',
'pt':'pt_PT',
'fi':'fi_FI',
'sv':'sv_SE'
},
googleplus:{
'cs':'cs',
'da':'da',
'de':'de',
'en_gb':'en-GB',
'en_us':'en-US',
'es':'es',
'fr':'fr',
'it':'it',
'nl':'nl',
'nb':'n0',
'pl':'pl',
'pt':'pt-PT',
'fi':'fi',
'sv':'sv'
},
linkedin:{
'cs':'cs_CZ',
'da':'da_DK',
'de':'de_DE',
'en_gb':'en_US',
'en_us':'en_US',
'es':'es_ES',
'fr':'fr_FR',
'it':'it_IT',
'nl':'nl_NL',
'nb':'no_NO',
'pl':'pl_PL',
'pt':'pt_BR',
'fi':'en_US',
'sv':'sv_SE'
},
twitter:{
'cs':'cs',
'da':'da',
'de':'de',
'en_gb':'en-gb',
'en_us':'en',
'es':'es',
'fr':'fr',
'it':'it',
'nl':'nl',
'nb':'nb',
'pl':'pl',
'pt':'pt',
'fi':'fi',
'sv':'sv'
}
},
constructor:function(config){
this.styleInfo='horizontalcount';
config.height=config.height!==undefined?config.height:web.data.components.ShareButtons.DEFAULT_HEIGHT;
web.data.components.ShareButtons.superclass.constructor.call(this,config)
},
editSafe:true,
set:function(config){
var propsArr=this.getPropsArr();
web.data.components.ShareButtons.superclass.set.call(this,config);
propsArr.forEach(function(props){
if(config[props]!==undefined){
this[props]=config[props]
}
},this)
},
getPropsArr:function(){
return[
'styleInfo',
'verbToDisplay',
'showFriends',
'showFacebook',
'showFacebookShare',
'showTwitter',
'showLinkedIn',
'showGplus',
'align'
]
},
toJSON:function(){
var json=web.data.components.ShareButtons.superclass.toJSON.call(this),propsArr=this.getPropsArr();
propsArr.forEach(function(props){
json[props]=this[props]
},this);
return json
},
renderSelf:function(doc){
var loadExternalScript,lazyLoadScript,localeMap=this.localeMap,locale=doc.getPage().getTemplate().getLocale();
this.locale=locale;
lazyLoadScript=function(){
try{
IN.parse();
FB.XFBML.parse();
twttr.widgets.load();
gapi.plus.go()
}catch(err){
}
};
loadExternalScript=function(){
var scriptLoader=function(id,src,locale){
var js,fjs,elem=document.getElementById(id);
if(elem){
if(elem.getAttribute('locale')===locale){
return
}
elem.parentNode.removeChild(elem);
try{
document.getElementById('fb-root').remove();
delete window.FB
}catch(e){
}
try{
delete window.IN
}catch(e){
}
}
js=document.createElement('script');
js.id=id;
js.src=src;
js.type='text/javascript';
js.setAttribute('locale',locale);
fjs=document.getElementsByTagName('script')[0];
if(id==='googleplus'){
window.___gcfg={
lang:locale,
parsetags:'onload'
}
}else if(id==='linkedinjs'){
js.innerHTML='\n'+'lang: '+locale+'\n'
}
fjs.parentNode.insertBefore(js,fjs)
};
scriptLoader('facebook-jssdk','https://connect.facebook.net/'+localeMap.facebook[locale]+'/all.js#xfbml=1&version=v2.7',localeMap.facebook[locale]);
scriptLoader('googleplus','https://apis.google.com/js/plusone.js',localeMap.googleplus[locale]);
scriptLoader('linkedinjs','https://platform.linkedin.com/in.js',localeMap.linkedin[locale],'lang: '+localeMap.linkedin[locale]);
scriptLoader('twitter-wjs','https://platform.twitter.com/widgets.js',localeMap.twitter[locale])
};
if(doc.editMode&&this.editSafe){
loadExternalScript();
setTimeout(lazyLoadScript,2000)
}else{
doc.appendToHead('<link href="/renderStatic/shareButtons/ShareButtons.css" rel="stylesheet" type="text/css"/>',true);
doc.appendToHead('<script>IN=twttr=___jsl=__gapi_jstiming__=gapi=null;</script>',true);
doc.appendToHead('<script src="https://connect.facebook.net/'+localeMap.facebook[locale]+'/all.js#xfbml=1&version=v2.7"></script>',true);
doc.appendToHead('<script type="text/javascript">window.___gcfg={lang: "'+localeMap.googleplus[locale]+'", parsetag: "onload"};</script>',true);
doc.appendToHead('<script src="https://apis.google.com/js/plusone.js"></script>',true);
doc.appendToHead('<script src="https://platform.twitter.com/widgets.js?lang='+localeMap.twitter[locale]+'"></script>',true);
doc.appendToHead('<script src="https://platform.linkedin.com/in.js" type="text/javascript">'+'\n'+'lang: '+localeMap.linkedin[locale]+'\n'+'</script>',true);
doc.requireScript('shareButtons')
}
this.renderSelfStart(doc);
this.renderCode(doc);
this.renderSelfEnd(doc)
},
getRenderClass:function(doc){
var cls=web.data.components.ShareButtons.superclass.getRenderClass.call(this,doc);
return cls+' shareself'+(doc.editMode?' web-widget':'')
},
getMinWidth:function(raw){
return this.supr().getMinWidth.call(this,raw)+75
},
isContentHeight:function(){
return false
},
isFixedHeight:function(){
return true
},
applyConfig:function(html){
html=html.replace(/@verbToDisplay/g,this.verbToDisplay).replace(/@showFriends/g,this.showFriends);
return html
},
getHorizontalCountHtml:function(){
var html='';
html+='<ul class="shareButtonCntnr '+this.align+'">';
if(this.showFacebook){
if(this.verbToDisplay==='like'){
html+='<li class="fblikeHCntnr">'
}else{
html+='<li class="fbrecomendHCntnr">'
}
html+='<div class="fb-like" data-layout="button_count" data-action="@verbToDisplay"></div></li>'
}
if(this.showFacebookShare){
html+='<li class="fblikeHCntnr"><div class="fb-share-button" data-type="button_count"></div></li>'
}
if(this.showGplus){
html+='<li class="g-plusone-cntnr"><g:plus action="share" annotation="bubble" align="left" height="20"></g:plus></li>'
}
if(this.showLinkedIn){
html+='<li class="linkedInCls"><script type="IN/Share" data-counter="right" data-showzero="true">IN</script></li>'
}
if(this.showTwitter){
html+='<li><a href="" class="twitter-share-button" data-lang="'+this.localeMap.twitter[this.locale]+'"  data-count="horizontal"></a></li>'
}
html+='</ul>';
return html
},
getVerticalCountHtml:function(){
var html='';
html+='<ul class="shareButtonCntnr verticalCountCls '+this.align+'">';
if(this.showFacebook){
if(this.verbToDisplay==='like'){
html+='<li>'
}else{
html+='<li class="fbrecomendVCntnr">'
}
html+='<div class="fb-like" data-layout="box_count" data-action="@verbToDisplay"></div></li>'
}
if(this.showFacebookShare){
html+='<li><div class="fb-share-button" data-type="box_count"></div></li>'
}
if(this.showGplus){
html+='<li class="g-plusone-cntnr"><g:plus action="share" align="left" annotation="vertical-bubble"></g:plus></li>'
}
if(this.showLinkedIn){
html+='<li><script type="IN/Share" data-showzero="false" data-counter="top">IN</script></li>'
}
if(this.showTwitter){
html+='<li><a href="" class="twitter-share-button" data-lang="'+this.localeMap.twitter[this.locale]+'" data-count="vertical"></a></li>'
}
html+='</ul>';
return html
},
getWithoutCountHtml:function(){
var html='';
html+='<ul class="shareButtonCntnr withoutCountCls '+this.align+'">';
if(this.showFacebook){
if(this.verbToDisplay==='like'){
html+='<li class="withoutCountFblikeCntnr">'
}else{
html+='<li class="withoutCountFbRecCntnr">'
}
html+='<div class="fb-like" data-layout="button" data-action="@verbToDisplay"></div></li>'
}
if(this.showFacebookShare){
html+='<li class="withoutCountFblikeCntnr"><div class="fb-share-button" data-type="button"></div></li>'
}
if(this.showGplus){
html+='<li class="g-plusone-cntnr"><g:plus action="share" align="left" annotation="none" height="20"></g:plus></li>'
}
if(this.showLinkedIn){
html+='<li><script type="IN/Share" >IN</script></li>'
}
if(this.showTwitter){
html+='<li class="twtrCls"><a href="" class="twitter-share-button" data-lang="'+this.localeMap.twitter[this.locale]+'" data-count="none"></a></li>'
}
html+='</ul>';
return html
},
getExtraInfoHtml:function(){
var html='';
html+='<ul class="shareButtonCntnr extraInfoCls">';
if(this.showFacebook){
html+='<li class="fbLikeExtraInfoCls"><div class="fb-like" data-action="@verbToDisplay" data-show-faces="@showFriends"></div></li>'
}
if(this.showFacebookShare){
html+='<li class="fbLikeExtraInfoCls"><div class="fb-share-button" data-type="button"></div></li>'
}
if(this.showGplus){
html+='<li class="g-plusone-cntnr"><g:plus action="share" align="left" annotation="inline" height="20"></g:plus></li>'
}
if(this.showLinkedIn){
html+='<li class="linkedInCls"><script type="IN/Share" >IN</script></li>'
}
if(this.showTwitter){
html+='<li class="twtrCls"><a href="" class="twitter-share-button" data-lang="'+this.localeMap.twitter[this.locale]+'" data-count="none"></a></li>'
}
html+='</ul>';
return html
},
getRoundStyleHtml:function(){
var html='';
html+='<ul class="shareButtonCntnr roundStyleCls '+this.align+'">';
if(this.showFacebook||this.showFacebookShare){
html+='<li>'+'<a href="https://www.facebook.com/sharer/sharer.php?u=">'+'<div class="icon shareButtonsFbIcon1">'+'</div></a></li>'
}
if(this.showGplus){
html+='<li>'+'<a href="https://plus.google.com/share?url=">'+'<div class="icon shareButtonsGplusIcon1">'+'</div></a></li>'
}
if(this.showLinkedIn){
html+='<li>'+'<a href="https://www.linkedin.com/shareArticle?mini=true&url=">'+'<div class="icon shareButtonsInIcon1">'+'</div></a></li>'
}
if(this.showTwitter){
html+='<li>'+'<a href="https://twitter.com/share?url=">'+'<div class="icon shareButtonsTwttrIcon1">'+'</div></a></li>'
}
html+='</ul>';
return html
},
getSquareStyleHtml:function(){
var html='';
html+='<ul class="shareButtonCntnr squareStyleCls '+this.align+'">';
if(this.showFacebook||this.showFacebookShare){
html+='<li>'+'<a href="https://www.facebook.com/sharer/sharer.php?u=">'+'<div class="icon shareButtonsFbIcon2">'+'</div></a></li>'
}
if(this.showGplus){
html+='<li>'+'<a href="https://plus.google.com/share?url=">'+'<div class="icon shareButtonsGplusIcon2">'+'</div></a></li>'
}
if(this.showLinkedIn){
html+='<li>'+'<a href="https://www.linkedin.com/shareArticle?mini=true&url=">'+'<div class="icon shareButtonsInIcon2">'+'</div></a></li>'
}
if(this.showTwitter){
html+='<li>'+'<a href="https://twitter.com/share?url=">'+'<div class="icon shareButtonsTwttrIcon2">'+'</div></a></li>'
}
html+='</ul>';
return html
},
renderCode:function(doc){
var html;
switch(this.styleInfo){
case'horizontalcount':
html=this.getHorizontalCountHtml();
break;
case'verticalcount':
html=this.getVerticalCountHtml();
break;
case'withoutcount':
html=this.getWithoutCountHtml();
break;
case'extrainfo':
html=this.getExtraInfoHtml();
break;
case'simple1':
html=this.getRoundStyleHtml();
break;
case'simple2':
html=this.getSquareStyleHtml();
break
}
doc.openTag({style:'height:'+this.getInnerHeight()+'px'});
doc.openTag({});
doc.append(this.applyConfig(html));
doc.closeTag();
doc.closeTag()
}
});
web.data.components.ShareButtons.NAME='Share Buttons';
web.data.components.ShareButtons.DEFAULT_HEIGHT=140;
web.data.components.FacebookPage=Ext.extend(web.data.components.Component,{
type:'web.data.components.FacebookPage',
href:'',
showFriendsFaces:false,
useSmallHeader:false,
hideCoverPhoto:false,
showPagePosts:false,
minWidth:180,
maxWidth:500,
minHeight:70,
fbFriendsFaceContainerHeight:85,
fbPagePostContainerHeight:200,
editSafe:true,
localeMap:{
'cs':'cs_CZ',
'da':'da_DK',
'de':'de_DE',
'en_gb':'en_GB',
'en_us':'en_US',
'es':'es_LA',
'fr':'fr_FR',
'it':'it_IT',
'nl':'nl_NL',
'nb':'nb_NO',
'pl':'pl_PL',
'pt':'pt_PT',
'fi':'fi_FI',
'sv':'sv_SE'
},
constructor:function(config){
web.data.components.FacebookPage.superclass.constructor.call(this,config)
},
isMobileLeaf:function(){
return false
},
set:function(config){
web.data.components.FacebookPage.superclass.set.call(this,config)
},
toJSON:function(){
var json=web.data.components.FacebookPage.superclass.toJSON.call(this);
json.href=this.href;
json.locale=this.locale;
json.showFriendsFaces=this.showFriendsFaces;
json.useSmallHeader=this.useSmallHeader;
json.hideCoverPhoto=this.hideCoverPhoto;
json.showPagePosts=this.showPagePosts;
return json
},
renderSelf:function(doc){
var id,data,ttemplate,html,loadExternalScript,lazyLoadScript,counter=10,locale=doc.getPage().getTemplate().getLocale(),localeMap=this.localeMap;
lazyLoadScript=function(id){
try{
FB.XFBML.parse(document.getElementById(id))
}catch(e){
counter=counter-1;
if(counter){
setTimeout(function(){
lazyLoadScript(id)
},1000)
}
}
};
loadExternalScript=function(){
var scriptLoader=function(id,src,locale){
var js,fjs,elem=document.getElementById(id);
if(elem){
if(elem.getAttribute('locale')===locale){
return
}else{
try{
elem.parentNode.removeChild(elem);
document.getElementById('fb-root').remove();
delete window.FB
}catch(e){
}
}
}
js=document.createElement('script');
js.id=id;
js.src=src;
js.type='text/javascript';
js.setAttribute('locale',locale);
fjs=document.getElementsByTagName('script')[0];
fjs.parentNode.insertBefore(js,fjs)
};
scriptLoader('facebook-jssdk','https://connect.facebook.net/'+localeMap[locale]+'/all.js#xfbml=1&version=v2.7&appId=486613084714993',localeMap[locale])
};
this.renderSelfStart(doc);
data=this.getDataValues(doc);
ttemplate=new web.utils.TinyTemplate;
html=ttemplate.process('<div class="fb-page" data-width={width} data-height={height} data-href="{href}" data-small-header="{useSmallHeader}" data-hide-cover="{hideCoverPhoto}" data-show-facepile="{showFriendsFaces}" data-tabs="{showPagePosts}"><div class="fb-xfbml-parse-ignore"><blockquote cite="{href}"><a href="{href}">{href}</a></blockquote></div></div>',data);
id=doc.editMode&&this.editSafe?new Date().getTime():'';
doc.append('<div data-original-width="'+data.width+'" id="'+id+'" style="height:'+data.height+'px; width:'+data.width+'px;margin:auto;" class="web-widget fb-page-container">'+html+'</div>');
if(doc.editMode&&this.editSafe){
loadExternalScript();
window.setTimeout(function(){
lazyLoadScript(id)
},1000)
}else{
doc.appendToHead('<script type="text/javascript" src="https://connect.facebook.net/'+localeMap[locale]+'/all.js#xfbml=1&version=v2.7" defer></script>',true);
doc.requireScript('fbPagePluginResize')
}
this.renderSelfEnd(doc)
},
getDataValues:function(doc){
var that=this,cmpHeight=that.getHeight(),cmpWidth=that.getWidth(),data={
id:that.getId(),
href:that.href,
locale:that.locale,
showFriendsFaces:that.showFriendsFaces,
useSmallHeader:that.useSmallHeader,
hideCoverPhoto:that.hideCoverPhoto,
showPagePosts:that.showPagePosts?'timeline':''
};
if(cmpHeight<that.minHeight){
cmpHeight=data.useSmallHeader===true?that.minHeight:web.data.components.FacebookPage.START_HEIGHT;
cmpHeight=cmpHeight+(data.showFriendsFaces===true?145:0);
cmpHeight=cmpHeight+(data.showPagePosts===true?that.fbPagePostContainerHeight:0)
}else if(cmpHeight<web.data.components.FacebookPage.START_HEIGHT){
if(that.useSmallHeader===true){
if(that.showFriendsFaces===true){
cmpHeight=that.minHeight+that.fbFriendsFaceContainerHeight
}else{
cmpHeight=that.minHeight
}
}else{
if(that.showFriendsFaces===true){
cmpHeight=web.data.components.FacebookPage.START_HEIGHT+that.fbFriendsFaceContainerHeight
}else{
cmpHeight=web.data.components.FacebookPage.START_HEIGHT
}
}
if(that.showPagePosts){
cmpHeight=cmpHeight+that.fbPagePostContainerHeight
}
}else{
if(data.useSmallHeader){
if(data.showFriendsFaces===true&&cmpHeight<that.minHeight+that.fbFriendsFaceContainerHeight){
cmpHeight=that.minHeight+that.fbFriendsFaceContainerHeight;
if(data.showPagePosts===true){
cmpHeight=cmpHeight+that.fbPagePostContainerHeight
}
}else if(data.showFriendsFaces===true&&data.showPagePosts===true&&cmpHeight<that.minHeight+that.fbFriendsFaceContainerHeight+that.fbPagePostContainerHeight){
cmpHeight=that.minHeight+that.fbFriendsFaceContainerHeight+that.fbPagePostContainerHeight
}else if(data.showPagePosts&&cmpHeight<that.minHeight+that.fbPagePostContainerHeight){
cmpHeight=that.minHeight+that.fbPagePostContainerHeight
}
}else{
if(data.showFriendsFaces===true){
if(cmpHeight<web.data.components.FacebookPage.START_HEIGHT+that.fbFriendsFaceContainerHeight){
cmpHeight=web.data.components.FacebookPage.START_HEIGHT+that.fbFriendsFaceContainerHeight
}
if(data.showPagePosts===true&&cmpHeight<web.data.components.FacebookPage.START_HEIGHT+that.fbFriendsFaceContainerHeight+that.fbPagePostContainerHeight){
cmpHeight=web.data.components.FacebookPage.START_HEIGHT+that.fbFriendsFaceContainerHeight+that.fbPagePostContainerHeight
}
}else if(data.showPagePosts&&cmpHeight<web.data.components.FacebookPage.START_HEIGHT+that.fbPagePostContainerHeight){
cmpHeight=web.data.components.FacebookPage.START_HEIGHT+that.fbPagePostContainerHeight
}
}
}
data.width=cmpWidth;
data.height=cmpHeight;
that.setHeight(cmpHeight);
return data
},
getMinWidth:function(){
return this.minWidth
},
getMaxWidth:function(){
return this.maxWidth
},
getMinHeight:function(){
return this.minHeight
},
isContentHeight:function(){
return false
}
});
web.data.components.FacebookPage.NAME='Facebook Page';
web.data.components.FacebookPage.START_HEIGHT=130;
web.data.components.FacebookPage.START_WIDTH=340;
web.data.styles.WebShop=Ext.extend(web.data.styles.Style,{
type:'web.data.styles.WebShop',
constructor:function(config){
this.font=new web.data.styles.Font({fontType:0});
this.fontColor=one.color('#000000');
this.focusColor=one.color('#63aadb');
this.hoverColor=one.color('rgba(255,255,255,0.2)');
this.fieldBgColor=one.color('#ffffff');
this.fieldBorderColor=one.color('#bbbbbb');
this.labelBgColor=one.color('#63aadb');
this.labelTextColor=one.color('#ffffff');
web.data.styles.WebShop.superclass.constructor.call(this,config)
},
set:function(opts){
opts=Ext.apply({},opts);
if('font'in opts){
if(opts.font!==null){
this.font.set({fontType:opts.font})
}
delete opts.font
}
if('fontColor'in opts){
this.fontColor=one.color(opts.fontColor||'#000000');
delete opts.fontColor
}
if('focusColor'in opts){
this.focusColor=one.color(opts.focusColor||'#63aadb');
delete opts.focusColor
}
if('hoverColor'in opts){
this.hoverColor=one.color(opts.hoverColor||'rgba(255,255,255,0.2)');
delete opts.hoverColor
}
if('fieldBgColor'in opts){
this.fieldBgColor=one.color(opts.fieldBgColor||'#ffffff');
delete opts.fieldBgColor
}
if('fieldBorderColor'in opts){
this.fieldBorderColor=one.color(opts.fieldBorderColor||'#bbbbbb');
delete opts.fieldBorderColor
}
if('labelBgColor'in opts){
this.labelBgColor=one.color(opts.labelBgColor||'#63aadb');
delete opts.labelBgColor
}
if('labelTextColor'in opts){
this.labelTextColor=one.color(opts.labelTextColor||'#ffffff');
delete opts.labelTextColor
}
web.data.styles.WebShop.superclass.set.call(this,opts)
},
toJSON:function(){
var obj=web.data.styles.WebShop.superclass.toJSON.call(this);
return Ext.apply(obj,{
font:this.font.toJSON(),
fontColor:this.fontColor?this.fontColor.toJSON():null,
focusColor:this.focusColor?this.focusColor.toJSON():null,
hoverColor:this.hoverColor?this.hoverColor.toJSON():null,
fieldBgColor:this.fieldBgColor?this.fieldBgColor.toJSON():null,
fieldBorderColor:this.fieldBorderColor?this.fieldBorderColor.toJSON():null,
labelBgColor:this.labelBgColor?this.labelBgColor.toJSON():null,
labelTextColor:this.labelTextColor?this.labelTextColor.toJSON():null,
buttonId:this.buttonId
})
},
getAppliedButton:function(doc){
return doc.dm.get(this.buttonId)||doc.getPage().getTemplate().getStylesheet().getStyleByRef('button.1')
},
getButtonClassname:function(doc){
return this.getAppliedButton(doc).getCSSClass()
},
renderGlobalStyles:function(doc){
var css='';
css+=this.getAppliedButton(doc).toCSS(doc);
css+=doc.getPage().getTemplate().getStylesheet().getStyleByRef('link.1').toCSS(doc);
return css
},
getFontName:function(doc){
var that=this;
var font;
if(web.data.styles.Font.isType(this.font.fontType)){
Object.keys(web.data.styles.Font.types).some(function(type,index){
if(that.font.fontType===index){
font=type;
return true
}
})
}else if(/^google:\/\//.test(this.font.fontType)){
this.font.getCSSValue(doc);
font=this.font.fontType
}
return font
},
toCSS:function(doc){
var fontColor=this.fontColor||one.color('#000');
var focusColor=this.focusColor||one.color('#63aadb');
var fieldBgColor=this.fieldBgColor||one.color('#fff');
var fieldBorderColor=this.fieldBorderColor||one.color('#e4e5e7');
var hoverColor=this.hoverColor||one.color('rgba(255,255,255,0.8)');
var categoryTextColor=one.color(fieldBgColor.hex()==='#000000'?'#ffffff':'#000000');
var lightFontColor=fontColor.alpha(0.5);
var lighterFontColor=fontColor.alpha(0.2);
var lightFocusColor=focusColor.alpha(0.5);
var lightFocusBgColor=focusColor.alpha(0.1);
var lightFocusContrastColor=one.color(lightFocusColor.lightness()>0.5?'#000000':'#ffffff');
var css=this.renderGlobalStyles(doc);
css+='.onecom-webshop-main {';
css+='font-family: '+this.font.getCSSValue(doc)+';';
css+='}';
css+='.onecom-webshop-main,'+'.onecom-webshop-main a.link, .onecom-webshop-main a.link:link,'+'.onecom-webshop-main a.link:visited, .onecom-webshop-main a.link:hover,'+'.onecom-webshop-main a.link:active, .onecom-webshop-main input,'+'.onecom-webshop-main select, .onecom-webshop-main .text-color {';
css+='color: '+fontColor.cssa()+';';
css+='}';
css+='.onecom-webshop-main .text-color svg {';
css+='fill: '+fontColor.cssa()+';';
css+='}';
css+='.onecom-webshop-main .bg-color {';
css+='background-color: '+fieldBgColor.cssa()+' !important;';
css+='}';
css+='.onecom-webshop-main .border-color {';
css+='border-color: '+fieldBorderColor.cssa()+' !important;';
css+='}';
css+='.onecom-webshop-main .category-text {';
css+='color: '+categoryTextColor.cssa()+' !important;';
css+='}';
css+='.onecom-webshop-main .category-text svg {';
css+='fill: '+categoryTextColor.cssa()+' !important;';
css+='}';
css+='.onecom-webshop-main .bg-light-focus:hover {';
css+='color: '+lightFocusContrastColor.cssa()+' !important;';
css+='background-color: '+lightFocusColor.cssa()+' !important';
css+='}';
css+='.onecom-webshop-main .border-fcolor, .onecom-webshop-main .border-light-color {';
css+='border-color: '+fontColor.cssa()+' !important;';
css+='}';
css+='.onecom-webshop-main .border-light-font-color {';
css+='border-color: '+lightFontColor.cssa()+' !important;';
css+='}';
css+='.onecom-webshop-main .focus, .onecom-webshop-main .mobile-slider a {';
css+='color: '+focusColor.cssa()+' !important;';
css+='}';
css+='.onecom-webshop-main .focus svg {';
css+='fill: '+focusColor.cssa()+' !important;';
css+='}';
css+='.onecom-webshop-main .bg-extra-light-focus:hover {';
css+='background-color: '+lightFocusBgColor.cssa()+' !important;';
css+='}';
css+='.onecom-webshop-main .bg-extra-light-focus {';
css+='border-color: '+lighterFontColor.cssa()+' !important;';
css+='}';
css+='.onecom-webshop-main .overlay-container:hover .overlay {';
css+='background-color: '+hoverColor.cssa()+' !important;';
css+='}';
css+='.onecom-webshop-main .product-label {';
css+='background-color: '+this.labelBgColor.cssa()+' !important;';
css+='color: '+this.labelTextColor.cssa()+' !important;';
css+='}';
return css
}
});
web.data.components.WebShop=Ext.extend(web.data.components.Component,{
type:'web.data.components.WebShop',
constructor:function(cfg){
this.category=null;
this.style=null;
this.showCategory=true;
this.showWelcomeMessage=true;
this.imageRatio='square';
this.cropImages=true;
this.productsPerRow=4;
this.productsPerPage=24;
this.sortProducts='name-ascending';
this.userCanSortProducts=false;
this.labelPosition='topRight';
web.data.components.WebShop.superclass.constructor.call(this,cfg)
},
set:function(opts){
if(opts.dm){
this.dm=opts.dm;
delete opts.dm
}
if(this.dm){
if(opts.style){
this.style=this.dm.create(Ext.apply({
dm:this.dm,
parent:this,
type:'web.data.styles.WebShop'
},opts.style));
delete opts.style
}else if(!this.style){
this.style=this.dm.create({
dm:this.dm,
parent:this,
type:'web.data.styles.WebShop'
})
}else{
this.style.set(opts.style)
}
}
web.data.components.WebShop.superclass.set.call(this,opts)
},
check:function(){
var valid=!!this.style;
return valid&&web.data.components.WebShop.superclass.check.call(this)
},
toJSON:function(){
var json=web.data.components.WebShop.superclass.toJSON.call(this);
json.category=this.category;
json.showCategory=this.showCategory;
json.style=this.style.toJSON();
json.showWelcomeMessage=this.showWelcomeMessage;
json.imageRatio=this.imageRatio;
json.cropImages=this.cropImages;
json.productsPerRow=this.productsPerRow;
json.productsPerPage=this.productsPerPage;
json.sortProducts=this.sortProducts;
json.userCanSortProducts=this.userCanSortProducts;
json.labelPosition=this.labelPosition;
return json
},
getMinWidth:function(){
return 680
},
getMinHeight:function(){
return 450
},
getInnerHeight:function(doc){
if(doc.editMode){
return web.data.components.WebShop.superclass.getInnerHeight.call(this)
}else{
return this.getMinHeight()
}
},
getGlobalStyleId:function(){
return this.styleButtonId
},
renderSelf:function(doc){
var style=this.style;
doc.addStyle(this.style);
this.renderSelfStart(doc);
if(doc.templateSelectorPreviewMode&&doc.domain==='repository'){
doc.append('<img src="'+{
'084AA085-3E96-4BB7-AF97-52B6841485F2':{
'desktop':'//webeditor-static.cdn-one.com/desktop.36f55bb7e9.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.7cf2518524.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.9da18afdb1.png'
},
'094E5907-DC68-48D2-8332-698762E42BBC':{
'desktop':'//webeditor-static.cdn-one.com/desktop.3b7215c9d8.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.333d46d00c.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.2528c8441b.png'
},
'0B5BF67A-FAD2-4D02-91C9-01AA3D6576CB':{
'desktop':'//webeditor-static.cdn-one.com/desktop.e7b57cf34d.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.d7571862ef.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.a1ccf62c1a.png'
},
'193FC023-1254-47CF-985D-64AFF94F545A':{
'desktop':'//webeditor-static.cdn-one.com/desktop.abfb7c2606.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.2098448d4e.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.13538d448f.png'
},
'2B7FF5A4-4A25-4A8F-988E-3489998623A1':{
'desktop':'//webeditor-static.cdn-one.com/desktop.6eefbaa2c2.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.dc0f51dc02.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.157666b67d.png'
},
'4BEB6758-39F6-416F-A401-21E96893BE88':{
'desktop':'//webeditor-static.cdn-one.com/desktop.8c7888fa09.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.0fa6318f4a.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.608a3c32be.png'
},
'51DDF162-F046-469F-9606-2CAB7996C3BD':{
'desktop':'//webeditor-static.cdn-one.com/desktop.7d38695526.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.85a9a6bd7e.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.ee50d601a0.png'
},
'5A458E4C-9000-4D48-8BD1-15A3AA401DCC':{
'desktop':'//webeditor-static.cdn-one.com/desktop.073eb2ee1d.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.666177f69a.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.ffb26225d4.png'
},
'607B35C9-EF6E-4608-B895-2C48E5604BED':{
'desktop':'//webeditor-static.cdn-one.com/desktop.43f2b8da53.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.9b69bae529.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.a0396ed620.png'
},
'6D09DA65-0A2B-4D5F-A9E3-E747F3CF573D':{
'desktop':'//webeditor-static.cdn-one.com/desktop.ae2022b048.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.0123e5156c.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.e9a55a9649.png'
},
'72F3B3E6-317B-4204-B379-7D4097E9CA51':{
'desktop':'//webeditor-static.cdn-one.com/desktop.133616f1f4.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.ad0631049d.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.ab0831d805.png'
},
'86117364-431F-4A21-BB3D-0B1C1CFF132E':{
'desktop':'//webeditor-static.cdn-one.com/desktop.302e7b167d.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.2f1b32ac7c.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.509d610631.png'
},
'958E323F-C0C0-46DF-B396-DF2E0517A528':{
'desktop':'//webeditor-static.cdn-one.com/desktop.ac8d32137c.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.ba49924347.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.77110a53e6.png'
},
'9E870A8F-A32D-42E0-BCC9-B9A8B88DE6A5':{
'desktop':'//webeditor-static.cdn-one.com/desktop.edfef9514c.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.48ef8180b3.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.fa371c3590.png'
},
'A5B48925-EA51-411E-A0F5-7DE9454F5A67':{
'desktop':'//webeditor-static.cdn-one.com/desktop.38ebaf39a3.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.2082f083ea.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.2f6a64e12d.png'
},
'A8468CE8-AB84-4589-82C7-C9727CA3D68A':{
'desktop':'//webeditor-static.cdn-one.com/desktop.ae2022b048.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.0123e5156c.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.e9a55a9649.png'
},
'A887B21D-7067-42F0-924C-5433BFE46B7C':{
'desktop':'//webeditor-static.cdn-one.com/desktop.90d9ab2a2e.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.48eae704f5.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.7f945c314e.png'
},
'B0B705C5-08C6-4C2C-9A08-580C5170C8F5':{
'desktop':'//webeditor-static.cdn-one.com/desktop.b58b2e9456.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.8d2f6e49c5.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.deaa124d55.png'
},
'C1CEE732-EB92-4F4C-B2C6-0BDDA86BCAF7':{
'desktop':'//webeditor-static.cdn-one.com/desktop.48806eae48.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.9286880675.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.eef409a83c.png'
},
'C552B33A-818E-4429-A3F8-8897E1FDF9EB':{
'desktop':'//webeditor-static.cdn-one.com/desktop.8922aea4bd.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.875b098784.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.68b7b9f473.png'
},
'DF17CD5A-F3CD-4BE5-8C2D-8EE8D79D0958':{
'desktop':'//webeditor-static.cdn-one.com/desktop.d44e0029f8.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.cbb9cb38ae.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.0c22331e47.png'
},
'E21A6B10-0424-483F-B6B7-86397C8A4787':{
'desktop':'//webeditor-static.cdn-one.com/desktop.644cfba1f6.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.f5bde65ef9.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.9fac660376.png'
},
'F4C3303D-1217-4373-82AD-40E9390F66EE':{
'desktop':'//webeditor-static.cdn-one.com/desktop.11c9ee5861.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.0d26942e52.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.8719c80831.png'
},
'F69311A4-5E3B-4C43-9E6D-3E9423706AC3':{
'desktop':'//webeditor-static.cdn-one.com/desktop.ccb7c15494.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.d005884fa6.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.4a382740b6.png'
},
'FF96AF94-74E7-4CFB-ADF1-513509DAAFDD':{
'desktop':'//webeditor-static.cdn-one.com/desktop.7e539ea5f7.png',
'mobile-horizontal':'//webeditor-static.cdn-one.com/mobile-horizontal.46ca45a94a.png',
'mobile-vertical':'//webeditor-static.cdn-one.com/mobile-vertical.782c523ca6.png'
}
}[doc.page.id][doc.templateSelectorPreviewMode]+'" />')
}else if(doc.editMode||doc.previewMode||doc.previewBackup){
var locale=one&&one.locale&&one.locale.id;
var queryString=Ext.urlEncode({
locale:locale,
font:style.getFontName(),
fontColor:style.fontColor?style.fontColor.hex().slice(1):'',
focusColor:style.focusColor?style.focusColor.hex().slice(1):'',
bgColor:style.fieldBgColor?style.fieldBgColor.hex().slice(1):'',
borderColor:style.fieldBorderColor?style.fieldBorderColor.hexa().slice(1):'',
buttonStyle:style.getAppliedButton(doc).toCSS(doc),
hoverColor:style.hoverColor?style.hoverColor.cssa():'',
showCategory:this.showCategory,
imageRatio:this.imageRatio,
cropImages:this.cropImages,
productsPerRow:this.productsPerRow,
productsPerPage:this.productsPerPage,
sortProducts:this.sortProducts,
userCanSortProducts:this.userCanSortProducts,
labelBgColor:style.labelBgColor?style.labelBgColor.hex().slice(1):'',
labelTextColor:style.labelTextColor?style.labelTextColor.hex().slice(1):'',
labelPosition:this.labelPosition
});
doc.append('<div class="web-widget webshop-comp" style="height:'+this.getHeight()+'px">'+'<iframe frameborder="0" width="100%" '+'height="100%" '+'src="/api/v1/'+doc.domain+'/webshoppreview?'+queryString+'"></iframe>'+(doc.previewTarget?[
'<script>',
'(function(){',
'var iframes = document.getElementsByTagName("iframe"),',
'iframe = iframes[iframes.length - 1],',
'heightAdjustTimer, cleanupTimer;',
'iframe.onload = function(event) {',
'cleanup();',
'resizeIframe();',
'addResizeListener();',
'};',
'iframe.onerror = function(event) {',
'cleanup();',
'};',
'function resizeIframe() {',
'try {',
'var body = iframe.contentDocument.body,',
'computedStyle = getComputedStyle(body),',
'margin = parseInt(computedStyle.marginTop, 10) + parseInt(computedStyle.marginBottom, 10),',
'elOneComWebShop = body.querySelector("#onecomwebshop");',
'var tmp = body.style.overflow;',
'body.style.overflow = "hidden";',
'iframe.parentNode.style.height = (elOneComWebShop.clientHeight + margin) + "px";',
'setTimeout(function(){body.style.overflow = tmp;}, 0);',
'} catch(e) {',
'}',
'if (heightAdjustTimer) {',
'heightAdjustTimer = setTimeout(resizeIframe, 100);',
'}',
'}',
'function cleanup() {',
'clearTimeout(heightAdjustTimer);',
'heightAdjustTimer = null;',
'clearTimeout(cleanupTimer);',
'cleanupTimer = null;',
'}',
'function addResizeListener() {',
'try {',
'iframe.contentWindow.onresize = function(event) {',
'resizeIframe();',
'}',
'} catch(e) {',
'}',
'}',
'heightAdjustTimer = setTimeout(resizeIframe, 100);',
'})();',
'</script>'
].join('\n'):'')+'</div>')
}else{
doc.append('<div class="web-widget">'+'<!--#begin code '+this.id+'-->'+'<script type="text/javascript" src="/____webshop/v1/'+doc.domain+'/init.js"></script>'+'<onecom-webshop-main class="onecom-webshop-main" params="'+'imageRatio: \''+this.imageRatio+'\','+'cropImages: '+this.cropImages+','+'productsPerRow: '+this.productsPerRow+','+'productsPerPage: '+this.productsPerPage+','+'showCategorySelector: '+this.showCategory+','+'sortProducts: \''+this.sortProducts+'\','+'userCanSortProducts: '+this.userCanSortProducts+','+'buttonClassname: \''+this.style.getButtonClassname(doc)+'\','+'labelPosition: \''+this.labelPosition+'\','+'embedType: \'websitebuilder\''+'"></onecom-webshop-main>'+'<!--#end code '+this.id+'-->'+'</div>')
}
this.renderSelfEnd(doc)
},
getRenderStyle:function(doc){
var style=web.data.components.WebShop.superclass.getRenderStyle.apply(this,arguments);
if(doc.templateSelectorPreviewMode&&doc.domain==='repository'){
style+='padding: 0px !important;'
}
return style
},
isSingle:function(){
return true
},
setDefaultProperties:function(){
this.showWelcomeMessage=true
}
});
web.data.components.WebShop.NAME='Webshop';
Ext.override(Ext.Button,{
buttonSelector:'a',
template:function(){
var template=new Ext.Template('<div id="{4}" class="web-button {3}">','<div class="{1}">','<em class="{2}"><a unselectable="on"></a></em>','</div></div>');
template.compile();
return template
}(),
onDisableChange:function(disabled){
if(this.el){
this.el[disabled?'addClass':'removeClass'](this.disabledClass)
}
this.disabled=disabled
},
doAutoWidth:function(){
if(this.autoWidth!==false&&this.el&&this.text&&this.width===undefined){
if(Ext.isIE7&&Ext.isStrict){
var ib=this.btnEl;
if(ib&&ib.getWidth()>20){
ib.clip();
ib.setWidth(Ext.util.TextMetrics.measure(ib,this.text).width+ib.getFrameWidth('lr'))
}
}
if(this.minWidth){
if(this.el.getWidth()<this.minWidth){
this.el.setWidth(this.minWidth)
}
}
}
}
});
Ext.ns('web.workspace');
Ext.ns('web.panels');
web.panels.Panel=Ext.extend(Ext.Container,{
xtype:null,
app:null,
constructor:function(config){
this.stateId=this.type;
this.stateEvents=[
'collapse',
'expand'
];
this.getState=function(){
return{collapsed:this.collapsed}
};
web.panels.Panel.superclass.constructor.call(this,config)
},
afterRender:function(){
web.panels.Panel.superclass.afterRender.call(this);
this.initListeners()
},
initListeners:function(){
}
});
web.workspace.Panel=Ext.extend(web.panels.Panel,{
xtype:'web-workspace',
page:null,
styleNode:null,
overlay:null,
initComponent:function(config){
this.addEvents.apply(this,this.app.coreEvents);
this.app.relayEvents(this,this.app.coreEvents);
var cfg=Ext.apply({layout:'fit'},config);
this.cls='web-workspace';
this.border=false;
this.initRender();
this.initStyles();
this.initInterface();
this.initPlugins();
this.initSelect();
web.workspace.Panel.superclass.initComponent.call(this,cfg)
},
getPage:function(){
return this.page
}
});
Ext.ComponentMgr.registerType('web-workspace',web.workspace.Panel);
Ext.override(web.workspace.Panel,{
initRender:function(){
this.addEvents('redraw','afterredraw','reflow','repaint','constrain')
},
getDoc:function(){
var app=this.app,labels={
emptyText:'Empty text. Double click to type text.',
emptyGallery:'No images selected.',
noSortCode:'Code components can\'t be moved.'
};
return new web.Document({
dm:app.dm,
page:this.page,
domain:app.dal.domain,
classPrefix:'web-workspace',
labels:labels,
editMode:true,
hdImages:app.user.subscriptionStatus===web.UserSubscriptionStatus.PREMIUM
})
},
onRender:function(){
var app=this.app,page=app.getSelected('page'),body,style,append=function(node,cfg){
return Ext.get(Ext.DomHelper.append(node,cfg))
};
web.workspace.Panel.superclass.onRender.apply(this,arguments);
body=this.el;
style=body.dom.style;
if(style.overflowX!==undefined){
style.overflowX='auto';
style.overflowY='scroll'
}else{
style.overflow='scroll'
}
this.contentEl=append(body,{cls:'web-workspace-content'});
this.contentEl.dom.onselectstart=function(){
return false
};
this.deskEl=append(this.contentEl,{cls:'web-workspace-desk'});
this.headerEl=append(this.deskEl,{cls:'web-workspace-header'});
this.templateHeaderEl=append(this.headerEl,{cls:'web-workspace-template-header'});
this.pageHeaderEl=append(this.headerEl,{cls:'web-workspace-page-header'});
this.baseEl=append(this.deskEl,{cls:'body blockbody'});
this.lowerEl=append(this.baseEl,{cls:'web-workspace-lower'});
this.upperEl=append(this.baseEl,{cls:'web-workspace-upper'});
this.footerEl=append(this.deskEl,{cls:'web-workspace-footer'});
this.templateFooterEl=append(this.footerEl,{cls:'web-workspace-template-footer'});
this.pageFooterEl=append(this.footerEl,{cls:'web-workspace-page-footer'});
append(this.deskEl,{
cls:'web-workspace-dragexpand',
html:'Drag components here to expand the height'
});
this.fillersEl=append(this.contentEl,{cls:'fillers'});
if(page){
this.setPage(page)
}
},
updateMenus:function(folder){
var menus=this.el.select('.menu');
menus.each(function(el){
var doc=this.getDoc(),menu=this.getElComponent(el);
doc.setPage(this.page);
if(menu){
menu.render(doc);
el=this.getComponentEl(menu);
if(!Ext.isOpera){
el.insertHtml('beforeBegin',doc.toBodyHTML());
el.remove()
}else{
var clone=el.dom.cloneNode(true);
el.dom.parentNode.replaceChild(clone,el.dom)
}
}
},this);
this.clearEls();
this.fireEvent('redraw',this.page,this.el)
},
insertComponent:function(part){
var doc=this.getDoc(),el,lowerDom=this.lowerEl,upperDom=this.upperEl,parentEl=part.isStretch()?lowerDom:upperDom;
doc.setPage(this.page);
part.render(doc);
this.updateStyles(doc);
if(part.isCode()){
this.writeGhostCode(part,doc)
}
el=oneJQuery(doc.toBodyHTML())[0];
parentEl.dom.appendChild(el);
this.fireEvent('redraw',part,el)
},
removeComponent:function(part){
var el=this.getComponentEl(part);
if(el){
el.remove();
this.clearEls(part);
this.fireEvent('redraw',part,el)
}
},
updateComponent:function(part,isResize){
var doc,el,parent=part.getParent();
if(!parent){
return
}
doc=this.getDoc();
doc.setPage(this.page);
part.render(doc);
if(!isResize){
this.updateStyles(doc)
}
if(part.isCode()){
this.writeGhostCode(part,doc)
}
el=this.getComponentOuterEl(part);
if(el){
var parentEl=el.parent();
if(parentEl===this.lowerEl&&!part.isStretch()){
this.upperEl.appendChild(el)
}
if(parentEl===this.upperEl&&part.isStretch()){
this.lowerEl.appendChild(el)
}
if(!Ext.isOpera){
el.insertHtml('beforeBegin',doc.toBodyHTML());
el.remove()
}else{
var clone=el.dom.cloneNode(true);
el.dom.parentNode.replaceChild(clone,el.dom)
}
this.clearEls(part);
this.fireEvent('redraw',part,el,{isResize:isResize})
}
},
updateGhosts:function(){
var doc=this.getDoc();
this.page.render(doc);
this.writeGhosts(doc)
},
reRenderComponents:function(components){
var updateComponent=this.updateComponent.bind(this);
components.forEach(function(component){
if(component.type==='web.data.components.Menu'){
updateComponent(component,false)
}
})
},
setPage:function(page){
var app=this.app,baseDom=this.baseEl.dom,lowerDom=this.lowerEl.dom,upperDom=this.upperEl.dom,deskDom=this.deskEl.dom,template,width,doc;
this.page=page;
template=page.getTemplate()||app.getSelected('template');
template.currentPage=page;
if(!template){
return
}
this.clearStyles();
var items=template.getAllItems(),lowers=[],uppers=[];
items.forEach(function(item){
if(item.isStretch()){
lowers.push(item)
}else{
uppers.push(item)
}
});
doc=this.getDoc();
template.render(doc);
this.updateStyles(doc);
doc=this.getDoc();
lowers.forEach(function(item){
item.render(doc)
});
lowerDom.innerHTML=doc.toBodyHTML();
this.updateStyles(doc);
this.writeGhosts(doc);
this.reRenderComponents(lowers);
doc=this.getDoc();
uppers.forEach(function(item){
item.render(doc)
});
upperDom.setAttribute('style',template.getTemplateRenderStyle(doc));
upperDom.innerHTML=doc.toBodyHTML();
this.updateStyles(doc);
this.writeGhosts(doc);
baseDom.setAttribute('data-id',template.id);
deskDom.setAttribute('data-id',page.id);
width=template.getWidth();
width+=50*(template.getAlign()==='center'?2:1);
baseDom.style.minWidth=width+'px';
deskDom.style.minWidth=width+'px';
this.fireEvent('redraw',page,this.el)
},
writeGhosts:function(doc,append){
var th=this.toCodeHTML(doc,'head',false),ph=this.toCodeHTML(doc,'head',true),tf=this.toCodeHTML(doc,'bodyend',false),pf=this.toCodeHTML(doc,'bodyend',true),thd=this.templateHeaderEl.dom,phd=this.pageHeaderEl.dom,tfd=this.templateFooterEl.dom,pfd=this.pageFooterEl.dom;
thd.innerHTML=((append?thd.innerHTML:'')||'')+th;
phd.innerHTML=((append?phd.innerHTML:'')||'')+ph;
tfd.innerHTML=((append?tfd.innerHTML:'')||'')+tf;
pfd.innerHTML=((append?pfd.innerHTML:'')||'')+pf;
this.hasGhosts=thd.innerHTML||phd.innerHTML||tfd.innerHTML||pfd.innerHTML
},
writeGhostCode:function(ghost,doc){
var items=this.page.getTemplate().getAllItems();
items.forEach(function(i){
if(i.isGhost()&&i!==ghost){
i.render(doc)
}
});
this.writeGhosts(doc)
},
toCodeHTML:function(doc,location,inPage){
var loc=location.toLowerCase(),template=doc.getPage().getTemplate(),width=template?template.getInnerWidth():1000,str=(doc.fixedCode&&doc.fixedCode[loc]?doc.fixedCode[loc][inPage?1:0]:'')||'';
if(str){
str='<div class="codedevcontainer codedevcontainer'+loc+'">'+'<div class="codedevcenter" style="width:'+width+'px;">'+str+'</div><div class="codedevend"></div></div>'
}
return str
}
});
Ext.override(web.workspace.Panel,{
initStyles:function(){
var node,doc;
doc=new web.Document({editMode:true});
node=this.createStyleNode('default');
this.setCSS(node,doc.getDefaultCSS());
this.extraStyleNode=this.createStyleNode('extra');
this.styleNode=this.createStyleNode('page-styles');
this.cssIds={};
this.globalStyles=[];
this.localStyles=[]
},
getDomHead:function(){
return document.head||document.getElementsByTagName('head')[0]
},
createStyleNode:function(id){
var styleNode=document.createElement('style');
styleNode.type='text/css';
styleNode.id=id;
this.getDomHead().appendChild(styleNode);
return styleNode
},
getStyleId:function(style){
return style.inStylesheet()?style.getCSSClass():style.getId()
},
setStylesheet:function(stylesheet){
stylesheet.getStyles().forEach(function(style){
this.updateStyle(style)
},this);
this.styleNode=this.setCSS(this.styleNode,this.globalStyles.concat(this.localStyles).join('\n'))
},
setCSS:function(node,css){
if(node){
var id=node.id,temp=document.createElement('style');
temp.type='text/css';
if(temp.styleSheet){
try{
temp.styleSheet.cssText=css
}catch(ex){
}
}else{
temp.appendChild(document.createTextNode(css))
}
this.getDomHead().insertBefore(temp,node);
this.getDomHead().removeChild(node);
temp.id=id;
return temp
}
},
clearStyles:function(){
this.cssIds={};
this.globalStyles=[];
this.localStyles=[];
this.styleNode=this.setCSS(this.styleNode,'');
this.extraStyleNode=this.setCSS(this.extraStyleNode,'')
},
updateStyles:function(doc){
var styles=doc.getStyles(),extra=doc.css.join('\n');
styles.forEach(function(style){
this.updateStyle(style)
},this);
this.styleNode=this.setCSS(this.styleNode,this.globalStyles.concat(this.localStyles).join('\n'));
if(extra){
this.extraStyleNode=this.setCSS(this.extraStyleNode,extra)
}
},
updateStyle:function(style){
var doc=this.getDoc(),decs=style.getCSSDeclarations(doc),id=this.getStyleId(style),index=this.cssIds[id],css;
if(decs||Ext.isNumber(index)){
css=style.toCSS(doc);
if(!Ext.isNumber(index)){
if(style.inStylesheet()){
this.cssIds[id]=this.globalStyles.length;
this.globalStyles.push(css)
}else{
this.cssIds[id]=this.localStyles.length;
this.localStyles.push(css)
}
}else{
if(style.inStylesheet()){
this.globalStyles[index]=css
}else{
this.localStyles[index]=css
}
}
}
}
});
Ext.ns('web.workspace.plugins');
web.workspace.plugins.AutoAdjust=Ext.extend(Ext.util.Observable,{
init:function(workspace){
this.workspace=workspace;
workspace.autoAdjust=this;
var that=this,app=workspace.app;
workspace.on('resize',function(){
if(!this.pageIsLoaded){
return
}
this.fix()
},this);
workspace.on('render',function(){
this.scheduleAdjust=true;
if(this.fontsInactive||this.pageIsLoaded){
this.fixOnLoad()
}
},this);
workspace.on('afterredraw',function(conf){
if(conf&&conf.docs){
this.scheduleAdjust=true
}
if(this.fontsInactive||this.pageIsLoaded){
this.fixOnLoad()
}
},this);
app.on('load',function(){
that.pageIsLoaded=false
});
app.on('fonts-active',this.fixOnLoad,this);
app.on('activate',function(name){
if(name==='workspace'&&!this.off){
this.fix()
}
},this);
app.on('fonts-inactive',function(){
this.fontsInactive=true;
if(this.scheduleAdjust){
this.fixOnLoad()
}
},this)
},
fixOnLoad:function(){
this.fix();
this.pageIsLoaded=true;
this.scheduleAdjust=false;
this.fontsInactive=false
},
fix:function(){
var workspace=this.workspace;
if(!this.off&&workspace.app.getSelected('page')){
workspace.refreshElRegion();
this.populate();
this.fixRelIns();
this.fixTops();
workspace.fireEvent('redraw',workspace.page,workspace.upperEl);
this.fixHeight();
this.constrainToViewport();
this.fireEvent('adjust');
workspace.fireEvent('auto-adjust')
}
},
populate:function(){
var workspace=this.workspace,dm=workspace.app.dm,lowerEls=Array.prototype.slice.call(workspace.lowerEl.dom.children,0),upperEls=Array.prototype.slice.call(workspace.upperEl.dom.children,0),cmpEls=this.cmpEls=lowerEls.concat(upperEls);
this.domMap={};
cmpEls.forEach(function(el){
var cmp=dm.get(el.getAttribute('data-id'));
if(cmp){
cmp.autoTop=0;
cmp.autoHeight=el.offsetHeight;
this.domMap[cmp.id]=el
}
},this)
},
fixRelIns:function(){
var page=this.workspace.app.getSelected('page'),layers=page?page.getLayers():[];
layers.reverse().forEach(function(groups){
groups.forEach(function(group){
this.fixDown(group)
},this)
},this);
layers.reverse().forEach(function(groups){
groups.forEach(function(group){
this.fixUp(group)
},this)
},this)
},
fixDown:function(group){
var items=group.items,block=group.block,autoHeight=block.autoHeight||block.getHeight(),innerHeight=0,bottomSpacing=block.getSpacing().bottom;
var minBottom=Infinity,maxMinBottom=Math.max(1000,Math.min(autoHeight,block.getMaxHeight()));
items.forEach(function(item){
if(item.relIn&&!item.getRelPara()&&!block.isText()){
minBottom=Math.min(minBottom,-item.relIn.bottom,maxMinBottom)
}
});
minBottom=minBottom===Infinity?bottomSpacing:minBottom;
var pageItemsMap={},maxAutoBottom=0;
items.forEach(function(item){
var top=group.level&&item.relIn?item.relIn.top:item.bbox.top,relItem,relPara=item.getRelPara(),relTo=item.getRelTo(),relPage=item.getRelPage(),groupId=item.getRelToGroupId(),pageItems=pageItemsMap[groupId]||[],pageMax=0,autoBottom=0;
item.autoTop=top;
if(relPara){
var relParaEl,relParaRegion,relRegion;
relItem=item.dm.get(item.relIn.id);
relParaEl=this.workspace.contentEl.child('[data-id="'+item.relIn.id+'"] '+'[data-paraindex="'+relPara.index+'"]');
if(relItem&&relParaEl){
relParaRegion=this.workspace.adjustRegion(relParaEl.getRegion());
relRegion=this.workspace.getComponentRegion(relItem);
item.autoTop=relItem.autoTop+relParaRegion.top-relRegion.top+relPara.offset;
if(this.domMap[item.id]){
this.domMap[item.id].style.top=item.autoTop+'px'
}
}
}
var page=this.workspace.app.getSelected('page');
if(relTo&&!relPara||relPage){
var newTop=0;
relItem=item.getRelToItem();
if(relTo&&relItem){
newTop=relItem.autoTop+relItem.autoHeight+relTo.below
}
if(relPage&&relPage[page.id]!==undefined){
pageItems.forEach(function(pageItem){
if(item.bbox.left<pageItem.bbox.right&&pageItem.bbox.left<item.bbox.right){
pageMax=Math.max(pageMax,pageItem.autoTop+pageItem.autoHeight)
}
});
if(pageMax){
newTop=pageMax+relPage[page.id];
if(relItem){
newTop=Math.max(newTop,relItem.autoTop+relItem.autoHeight)
}
}
}
if(newTop){
item.autoTop=newTop;
if(this.domMap[item.id]){
this.domMap[item.id].style.top=newTop+'px'
}
}
}
autoBottom=item.autoTop+item.autoHeight;
if(item.inPage()){
pageItemsMap[groupId]=pageItemsMap[groupId]||[];
pageItemsMap[groupId].push(item)
}
if(autoBottom>maxAutoBottom){
innerHeight=Math.max(innerHeight,autoBottom+minBottom);
maxAutoBottom=autoBottom
}
},this);
if(innerHeight&&block instanceof web.data.components.Block){
autoHeight=innerHeight
}else{
autoHeight=Math.max(autoHeight,innerHeight)
}
block.autoHeight=autoHeight;
if(block.getParent()){
var el=Ext.get(this.domMap[block.id]);
if(el){
(el.last()||el).dom.style.height=block.autoHeight+'px'
}
}
},
fixUp:function(group){
var items=group.items;
items.forEach(function(item){
item.autoTop+=group.block.autoTop||0;
item.finalAutoTop=item.autoTop;
if(this.domMap[item.id]){
this.domMap[item.id].style.top=item.autoTop+'px'
}
},this)
},
fixTops:function(){
var workspace=this.workspace,page=workspace.app.getSelected('page'),items=page?page.getAllItems():[],maxY=0;
if(!page){
return
}
items.forEach(function(item){
if(!item.isGhost()){
maxY=Math.max(maxY,item.autoTop+(item.autoHeight||item.getHeight()))
}
},this);
this.maxY=maxY
},
fixHeight:function(){
var workspace=this.workspace,baseEl=workspace.baseEl,deskEl=workspace.deskEl,height,minHeight;
baseEl.dom.style.minHeight='0';
height=workspace.el.getHeight();
minHeight=Math.max(height-deskEl.getPadding('tb'),100);
minHeight=Ext.isNumber(minHeight)?minHeight:0;
minHeight=Math.max(minHeight,100);
minHeight=Math.max(this.maxY,minHeight,100);
minHeight=Math.min(minHeight,1000000);
minHeight=Math.round(minHeight);
try{
baseEl.dom.style.minHeight=minHeight+'px';
workspace.refreshBaseElRegion();
workspace.refreshElRegion()
}catch(e){
one.fatal('Could not set baseEl.dom.style.minHeight to '+minHeight+'px.')
}
},
constrainToViewport:function(){
var workspace=this.workspace,region=workspace.baseEl.getRegion(),cmpEls=this.cmpEls,limit=50;
if(cmpEls&&cmpEls.length){
cmpEls.forEach(function(el){
el=Ext.get(el);
var elRegion=el.getRegion(),dt,dl,dr,dx=0,dy=0;
if(elRegion.getArea()){
dt=elRegion.bottom-region.top;
if(dt<limit&&elRegion.top<region.top){
dy=limit-dt
}
dl=elRegion.right-region.left;
if(dl<limit&&elRegion.left<region.left){
dx=limit-dl
}else{
dr=elRegion.left-region.right;
if(dr>-limit&&elRegion.right>region.right){
dx=-limit-dr
}
}
if(dx||dy){
el.setRegion(elRegion.adjust(dy,dx,dy,dx))
}
}
},this)
}
}
});
web.workspace.plugins.ModeMask=Ext.extend(Object,{
init:function(workspace){
this.workspace=workspace;
workspace.modeMask=this;
workspace.on('render',function(){
this.initListeners();
this.update()
},this)
},
initListeners:function(){
var workspace=this.workspace;
workspace.app.on('mode',this.update,this)
},
update:function(){
var workspace=this.workspace,mode=workspace.app.getMode(),oppMode=mode==='page'?'template':'page',el=workspace.deskEl;
el.addClass('web-mode-'+mode);
el.removeClass('web-mode-'+oppMode)
}
});
web.workspace.plugins.MouseSpeed=Ext.extend(Ext.util.Observable,{
init:function(workspace){
this.workspace=workspace;
var that=this;
workspace.on('render',function(){
this.initListeners()
},this);
workspace.getMouseSpeed=function(){
return that.distance
}
},
initListeners:function(){
var workspace=this.workspace;
workspace.el.on('mousemove',function(e){
var oldXY=this.oldXY,xy=e.xy;
if(oldXY){
var pos=xy,distanceX=pos[0]-oldXY[0],distanceY=pos[1]-oldXY[1];
this.distance=Math.floor(Math.sqrt(distanceX*distanceX+distanceY*distanceY))
}
this.oldXY=e.xy
},this)
}
});
web.workspace.plugins.Overlay=Ext.extend(Ext.util.Observable,{
paper:null,
paperEl:null,
init:function(workspace){
this.workspace=workspace;
workspace.overlay=this;
this.lastTimeoutID=null;
this.addEvents('redrawiframe');
workspace.on('render',function(){
this.render()
},this)
},
render:function(){
this.draw();
this.initListeners();
this.refresh()
},
draw:function(){
var x,y,w,h,el=Ext.get(this.workspace.el),paperEl=this.paperEl;
this.el=el;
el.addClass('web-overlay-owner');
x=this.x=el.getX();
y=this.y=el.getY();
this.refreshDimensions();
w=this.width;
h=this.height;
this.paper=Raphael(el.dom,w,h);
paperEl=this.paperEl=el.first();
Ext.apply(paperEl.dom.style,{
pointerEvents:'none',
position:'absolute',
zIndex:'1000',
left:'0px',
top:'0px'
});
el.addClass('web-overlay-owner');
function fixPointerEvents(){
if(!this.fixedPointer){
if(Ext.isIE){
Ext.apply(paperEl.dom.style,{visibility:'hidden'});
if(paperEl.dom.nodeName.toLowerCase()==='svg'){
var children=paperEl.dom.childNodes,i,len=children.length;
for(i=0;i<len;i+=1){
children[i].style.visibility='visible'
}
}
paperEl.un('mouseover',fixPointerEvents)
}else{
this.drawInIframe()
}
this.fixedPointer=true
}
}
paperEl.on('mouseover',fixPointerEvents,this);
this.instrumentPaperEl(paperEl)
},
drawInIframe:function(){
var w=this.width,h=this.height,paperEl=this.paperEl,webkitFrameBody;
this.items={};
this.webkitFrame=Ext.DomHelper.createDom({
tag:'iframe',
cls:'isvg',
scrolling:'no'
});
this.webkitFrame.style.height=h+'px';
this.webkitFrame.style.width=w+'px';
this.el.dom.appendChild(this.webkitFrame);
webkitFrameBody=this.webkitFrame.contentWindow.document.body;
Ext.get(webkitFrameBody).insertFirst(paperEl);
Ext.apply(paperEl.dom.style,{
pointerEvents:'none',
position:'absolute',
zIndex:'1000',
left:'0px',
top:'0px'
});
this.fireEvent('redrawiframe')
},
instrumentPaperEl:function(paperEl){
this.paperEl.overlay=this;
paperEl.getRegion=function(){
var overlay=this.overlay,x=overlay.x,y=overlay.y,region=new Ext.lib.Region(y,x+overlay.width,y+overlay.height,x);
return region
}
},
initListeners:function(){
this.workspace.on({
afterlayout:this.refresh,
scope:this
});
this.workspace.on('reflow',this.refresh,this)
},
refresh:function(){
function callback(){
if(!this.paper){
return
}
this.onRefresh();
this.fireEvent('refresh',this)
}
clearTimeout(this.lastTimeoutID);
this.lastTimeoutID=callback.defer(100,this)
},
onRefresh:function(){
this.refreshDimensions();
this.paper.setSize(this.width,this.height);
this.paperEl.dom.style.height=this.height+'px';
if(this.webkitFrame){
this.webkitFrame.style.height=this.height+'px';
this.webkitFrame.style.width=this.width+'px'
}
},
refreshDimensions:function(){
var el=this.workspace.deskEl;
this.width=el.getWidth();
this.height=el.getHeight()
}
});
web.windows.BuildOutsideWarning=Ext.extend(web.windows.Window,{
type:'web.windows.BuildOutsideWarning',
modal:true,
resizable:false,
multiSelect:false,
constructor:function(config){
this.width=500;
this.cls='buildOutside web-modal-warning x-window-dlg';
this.iconCls='web-warning-icon';
web.windows.BuildOutsideWarning.superclass.constructor.call(this,config)
},
initComponent:function(){
this.title='Components placed outside the content area';
this.items=[{
xtype:'container',
items:[
{
xtype:'container',
html:'You have placed a component outside of the content area of your website.'
},
{
style:{'padding':'10px 0'},
xtype:'container',
html:'We recommend staying inside the vertical dashed lines, to ensure that the page will look right on mobile.'
},
{
ref:'../hideWarning',
xtype:'checkbox',
boxLabel:'Don\'t show this again'
}
]
}];
this.buttons=[{
cls:'x-btn-primary',
text:'OK',
listeners:{
click:this.onCancel,
scope:this
}
}];
web.windows.BuildOutsideWarning.superclass.initComponent.apply(this,arguments)
},
onCancel:function(){
this.hide();
this.fireEvent('cancel',this);
if(this.hideWarning.checked){
this.app.dal.uiState.set('hideWarning',true)
}
}
});
Ext.ComponentMgr.registerType('web-windows-warning-message',web.windows.BuildOutsideWarning);
web.workspace.plugins.OverlapDecos=Ext.extend(Object,{
init:function(workspace){
this.workspace=workspace;
this.overlay=workspace.overlay;
workspace.overlapDecos=this;
this.decos=[];
workspace.on('render',function(){
this.initListeners()
},this)
},
initListeners:function(){
var timer,workspace=this.workspace,that=this;
workspace.autoAdjust.on('adjust',function(){
clearTimeout(timer);
timer=setTimeout(function(){
that.show();
var page=workspace.app.getSelected('page'),template=page.getTemplate(),templateRegion=workspace.getComponentInnerRegion(template);
if(!workspace.app.dal.uiState.get('hideWarning')){
if(workspace.getSelected().some(function(item){
var or=workspace.getBBoxRegion(item.bbox)||item.getBBox();
return!item.isStretch()&&(or.left<templateRegion.left||or.right>templateRegion.right)
})){
var win=workspace.app.windows.create({type:'web.windows.BuildOutsideWarning'});
win.show()
}
}
},500)
},this);
workspace.multiSelect.on('adjust',function(region,changes){
if(region){
this.show({
components:workspace.multiSelect.selected,
changes:changes,
region:region
})
}
},this);
workspace.app.on('update',function(cmp,cfg){
this.resizeRegion=null
},this)
},
getOverlaps:function(event){
var workspace=this.workspace,point=workspace.getPoint(event),overlaps=[];
this.decos.forEach(function(deco){
var id=deco.data('id'),cmp=id?workspace.app.dm.get(id):null,b,region;
if(cmp){
b=deco.getBBox();
region=new Ext.lib.Region(b.y,b.x+b.width,b.y+b.height,b.x);
if(region.contains(point)){
overlaps.push(cmp)
}
}
});
overlaps.sort(function(a,b){
return a.getZIndex()-b.getZIndex()
});
return overlaps
},
showDeco:function(r,attr,id,offset){
offset=offset||0;
var paper=this.overlay.paper,el;
el=paper.rect(r.left+offset,r.top+offset,Math.max(r.right-r.left-offset*2,2),Math.max(r.bottom-r.top-offset*2,2)).attr(attr).toBack();
if(id){
el.data('id',id)
}
this.decos.push(el)
},
show:function(drop){
var redFill={
'fill':'rgba(204, 51, 51, 0.3)',
'stroke-width':0
},workspace=this.workspace,page=workspace.app.getSelected('page'),template=page.getTemplate(),templateRegion=workspace.getComponentInnerRegion(template),items=page.getAllItems(),selected=workspace.multiSelect.selected,dm=workspace.app.dm;
this.hide();
var regions=[],changes={};
if(drop&&drop.region){
regions=workspace.multiSelect.getRegions(drop.region);
changes=drop.changes||{}
}
function getFluxRegion(item){
var change=changes[item.id]||{};
return change.bbox?workspace.getBBoxRegion(change.bbox):item.getParent()?workspace.getComponentRegion(item)||workspace.getBBoxRegion(item):workspace.getComponentInnerRegion(item)
}
function getFluxBox(item){
var change=changes[item.id]||{};
return(change.relIn?dm.get(change.relIn.id):change.relIn===null?null:item.getRelInParent())||template
}
var o,oIndex,or,oRel;
items.forEach(function(item){
if(item.isGhost()){
return
}
o=item;
oIndex=item.getZIndex();
or=getFluxRegion(o);
oRel=getFluxBox(o);
items.forEach(each,this);
if(!item.isStretch()){
var otr;
if(or.left<templateRegion.left){
otr=workspace.copyRegion(or);
otr.right=Math.min(otr.right,templateRegion.left);
this.showDeco(otr,redFill,o.id)
}
if(or.right>templateRegion.right){
otr=workspace.copyRegion(or);
otr.left=Math.max(otr.left,templateRegion.right);
this.showDeco(otr,redFill,o.id)
}
}
},this);
function each(u){
if(u.isGhost()){
return
}
if(o===u){
return
}
var uIndex=u.getZIndex();
if(oIndex>uIndex){
var ur=getFluxRegion(u);
var oiu=or.intersect(ur);
oiu=oiu&&oiu.getArea()?oiu:null;
if(oiu){
var hasAncestor;
if(oRel){
hasAncestor=u===oRel||oRel.hasRenderAncestor(u)
}else{
hasAncestor=o.hasRenderAncestor(u)
}
var oActive=selected.indexOf(o)!==-1&&drop,uActive=selected.indexOf(u)!==-1&&drop,uText=u instanceof web.data.components.Text,isDirect=u===oRel,isOverlap=false;
isOverlap=isOverlap||!(uText&&oActive)&&!u.isContainerFor(o)&&(isDirect||!hasAncestor);
isOverlap=isOverlap||uText&&!hasAncestor;
isOverlap=isOverlap||uText&&uActive&&!oActive;
isOverlap=isOverlap||or.contains(ur)&&or.getArea()>ur.getArea();
if(isOverlap){
this.showDeco(oiu,redFill,u.id)
}
}
}
}
},
hide:function(){
this.decos.forEach(function(deco,index){
try{
deco.hide();
deco.remove()
}catch(e){
}
},this);
this.decos=[]
}
});
web.workspace.plugins.Hover=Ext.extend(Object,{
init:function(workspace){
this.workspace=workspace;
workspace.hover=this;
this.overlay=workspace.overlay;
this.borderWidth=2;
this.isActive=true;
this.timeout=null;
workspace.on('render',function(){
this.onRender();
this.initListeners()
},this)
},
initListeners:function(){
var workspace=this.workspace,app=workspace.app;
workspace.el.on('mouseover',function(event,node){
if(workspace.select.active){
var selected=app.getSelected('component'),region=workspace.getComponentRegion(selected);
if(region&&region.contains(workspace.getPoint(event))){
return
}
}
this.hoverOver(node)
},this);
app.el.on('mousemove',function(event,node){
if(!this.hoverNode){
return
}
var region=this.limitEl.getRegion();
if(!region.contains(new Ext.lib.Point(event.getXY()))){
this.hideLocal()
}
},this);
app.on('select',function(part){
this.hideLocal()
},this)
},
onRender:function(){
var overlay=this.overlay,paper=overlay.paper,borderWidth;
borderWidth=this.borderWidth;
this.hoverEdge=paper.rect(0,0,0,0).attr({
'stroke':'rgba(255, 255, 255, 0.4)',
'stroke-width':borderWidth+2,
'stroke-linejoin':'miter'
});
this.hover=paper.rect(0,0,0,0).attr({
'stroke':'rgba(63, 63, 63, 1)',
'stroke-width':borderWidth,
'stroke-linejoin':'miter'
});
this.limitEl=this.workspace.el
},
hoverOver:function(node){
node=node?this.getComponentNode(node):this.hoverNode;
var that=this;
function draw(){
that.draw(node)
}
if(node){
this.hoverNode=node;
clearTimeout(this.timeout);
this.timeout=setTimeout(draw,50)
}
},
getComponentNode:function(node){
var body=this.workspace.el,id;
this.dataId=null;
while(node){
if(node.id===body.id){
node=body.dom;
break
}
id=node.getAttribute&&(node.getAttribute('data-id')||node.getAttribute('data-partid'));
if(id){
this.dataId=id;
break
}
node=node.parentNode
}
return node
},
draw:function(node){
if(this.isHidden){
return
}
var dm=this.workspace.app.dm,id=node.getAttribute('data-id'),component;
if(id){
component=dm.get(id);
if(component){
this.drawComponent(component,node);
return
}
}
this.hideLocal()
},
drawComponent:function(component,node){
var x,y,w,h,o=3,workspace=this.workspace,app=workspace.app,selected=app.getSelected('component'),region,inPage=app.inPageMode();
if(component instanceof web.data.components.Template||component instanceof web.data.components.Page||inPage&&!component.inPage()||!inPage&&component.inPage()){
component=app.getSelected(inPage?'page':'template');
if(component){
node=workspace.getComponentEl(component)
}else{
this.hideLocal();
return
}
}
if(selected===component){
this.hideLocal();
return
}
region=workspace.getComponentRegion(component);
if(!region){
return
}
x=region.left-o;
y=region.top-o;
w=Math.max(region.right-x+o,0);
h=Math.max(region.bottom-y+o,0);
this.hover.attr({
x:x,
y:y,
width:w,
height:h
}).show();
this.hoverEdge.attr({
x:x,
y:y,
width:w,
height:h
}).show()
},
drawEdge:function(component,node){
var x,y,w,h,bWidth=this.borderWidth,bWidthHalf=bWidth/2,workspace=this.workspace,region,edge=node.getAttribute('data-partedge'),mod=node.getAttribute('data-mod'),isCol=edge==='left'||edge==='right';
region=workspace.adjustRegion(Ext.get(node).getRegion());
x=region.left;
y=region.top;
w=region.right-x;
h=region.bottom-y;
if(isCol){
x+=8-(mod||0);
w=0.01;
h=Math.max(h-bWidthHalf,0)
}else{
y+=8-(mod||0);
w=Math.max(w-bWidthHalf,0);
h=0.01
}
x=x+bWidthHalf;
y=y+bWidthHalf;
this.hover.attr({
x:x,
y:y,
width:w,
height:h,
'stroke-width':this.borderWidth*2
}).show();
this.hoverEdge.attr({
x:x,
y:y,
width:w,
height:h,
'stroke-width':this.borderWidth*2+2
}).show();
region=workspace.getComponentRegion(component)
},
hideLocal:function(){
this.hoverEdge.hide();
this.hover.hide()
},
show:function(){
this.isHidden=false;
this.workspace.edgeDeco.show()
},
hide:function(){
this.isHidden=true;
this.hideLocal();
this.workspace.edgeDeco.hide()
}
});
web.workspace.plugins.Select=Ext.extend(Ext.util.Observable,{
init:function(workspace){
this.workspace=workspace;
workspace.select=this;
this.component=workspace.app.getSelected('component');
this.addEvents('select','deselect','multiselect');
workspace.on('render',function(){
this.initListeners();
this.render()
},this)
},
render:function(){
if(this.component){
this.update()
}
},
update:function(component){
this.setComponent(component)
},
deselect:function(component){
},
setComponent:function(component){
if(component){
if(this.component&&component!==this.component){
this.deselect(component)
}
this.component=component
}
if(this.component){
this.calcEl();
this.calcRegion()
}
},
initListeners:function(){
var workspace=this.workspace,app=workspace.app;
workspace.relayEvents(this,app.coreEvents);
var isInnerMousedown;
workspace.mon(workspace.el,'mousedown',function(e,t){
var selected=app.getSelected('component');
isInnerMousedown=this.getComponent(t)===selected||e.getTarget('.workspace-edit')||e.getTarget('.web-resize')||e.getTarget('.selectimage-ui-controls');
if(!isInnerMousedown){
var selectedEl=workspace.getComponentRegion(selected);
isInnerMousedown=selectedEl?selectedEl.contains(workspace.getPoint(e)):isInnerMousedown
}
},this);
workspace.mon(workspace.el,'mouseup',function(e,t){
if(workspace.isActive(this)){
return
}
if(this.active&&!isInnerMousedown){
this.update(this.getComponent(t));
this.deactivate();
return
}
},this);
workspace.mon(workspace.app,'select',this.onPageChange(),this);
var constrainTimer;
workspace.on('auto-adjust',function(){
clearTimeout(constrainTimer);
constrainTimer=setTimeout(function(){
if(!workspace.isActive(this)){
this.update()
}
}.createDelegate(this),50)
},this)
},
onPageChange:function(){
var workspace=this.workspace;
function onSelect(part){
function select(){
this.update(part)
}
if(part instanceof web.data.components.Component){
if(workspace.isBeingRedrawn()){
workspace.on('afterredraw',select,this,{single:true})
}else{
select.call(this)
}
}
}
return function(part){
if(!part||!part.getParent){
return
}
var parent=part.getParent();
if(this.active||!parent){
if(!parent){
this.deactivate()
}else{
onSelect.call(this,part)
}
}
}
},
isPage:function(component){
return component instanceof web.data.components.Page
},
deactivateComponent:function(component){
var parent=component.getParent();
this.deactivate();
if(parent){
this.component=parent
}
},
isEditable:function(e,t){
var tel=Ext.get(t),isMove=tel.hasClass('web-move')&&!tel.hasClass('web-move-title');
return isMove&&this.workspace.multiSelectEdit.isEdit()
},
activate:function(e){
var workspace=this.workspace,app=workspace.app,selected=app.getSelected('component'),component=workspace.multiSelect.selected[0];
this.active=true;
workspace.multiSelect.select([component]);
this.update(component);
if(selected&&!(selected instanceof web.data.components.Template||selected instanceof web.data.components.Page)){
this.fireEvent('deselect',selected)
}
this.fireEvent('select',component,{
event:e.browserEvent,
extEvent:e
});
if(!(component instanceof web.data.components.Text)){
if(document.activeElement&&document.activeElement.tagName.toLowerCase()!=='body'){
document.activeElement.blur()
}
}
},
deactivate:function(){
if(this.active){
this.active=false;
var workspace=this.workspace,selected=workspace.app.getSelected('component');
if(selected.getParent()){
workspace.multiSelect.select([selected])
}
}
},
getComponent:function(htmlElement){
var workspace=this.workspace,id;
if(htmlElement.tagName.toLowerCase()==='shape'){
return workspace.app.dm.get(workspace.hover.dataId)
}
while(!id&&htmlElement){
if(htmlElement.id===workspace.el.id){
return workspace.getPage()
}
id=htmlElement.getAttribute('data-id');
htmlElement=htmlElement.parentNode
}
return workspace.app.dm.get(id)
},
calcEl:function(){
this.el=this.workspace.getComponentEl(this.component)
},
calcRegion:function(){
var region=this.workspace.getComponentRegion(this.component);
this.region=region||this.region
},
getRegion:function(){
if(!this.region){
this.calcRegion()
}
return this.region
}
});
web.workspace.plugins.SelectDecorator=Ext.extend(web.workspace.plugins.Select,{
constructor:function(plugin){
this.plugin=plugin;
web.workspace.plugins.SelectDecorator.superclass.constructor.call(this);
this.initDecorator()
},
init:function(workspace){
web.workspace.plugins.SelectDecorator.superclass.init.call(this,workspace);
this.populate()
},
populate:function(){
this.plugin.workspace=this.workspace;
this.plugin.component=this.component;
this.plugin.region=this.region;
if(this.plugin.populate){
this.plugin.populate()
}
},
render:function(){
this.preRender();
this.plugin.render();
this.onRender()
},
update:function(component){
this.setComponent(component);
if(this.component){
this.plugin.update(component);
this.onUpdate(component)
}
},
deselect:function(component){
if(component){
this.plugin.deselect(component);
this.onDeselect(component)
}
},
initDecorator:function(){
},
preRender:function(){
},
isActive:function(){
return Ext.query('.web-select-label-edit')[0].style.visibility==='hidden'
},
onRender:function(){
},
onUpdate:function(component){
},
onDeselect:function(newComponent){
}
});
web.workspace.plugins.SelectSpacing=Ext.extend(web.workspace.plugins.SelectDecorator,{
initDecorator:function(){
},
onRender:function(){
var workspace=this.workspace,paper=workspace.overlay.paper,cp=workspace.copyRegion,cfg={
'stroke-width':1,
'stroke-dasharray':'- ',
'stroke':'rgba(255, 255, 255, 0.5)',
'fill':'rgba(63, 63, 63, 0.7)'
};
workspace.selectSpacing=this;
this.decoSpace=paper.path('').attr(cfg);
workspace.mon(workspace.el,'mousemove',function(e,t){
var app=workspace.app,cmp=this.getComponent(t),selected=app.getSelected('component');
if(cmp&&cmp===selected&&cmp.getParent()){
var point=workspace.getPoint(e),innerRegion=workspace.getComponentInnerRegion(cmp),el=workspace.getComponentEl(cmp);
if(!this.defaultCursor){
this.defaultCursor=el.dom.style.cursor
}
if(!innerRegion.contains(point)){
el.dom.style.cursor='pointer'
}else{
el.dom.style.cursor=this.defaultCursor
}
}
},this);
var selectTime=0;
workspace.app.on('select',function(cmp){
selectTime=new Date().getTime()
},this);
workspace.mon(workspace.el,'click',function(e,t){
var app=workspace.app,cmp=this.getComponent(t),selected=app.getSelected('component');
if(cmp&&cmp===selected&&cmp.getParent()&&cmp.getPadding&&selectTime+50<new Date().getTime()){
var point=workspace.getPoint(e),padding=cmp.getPadding(),innerRegion=workspace.getComponentInnerRegion(cmp),paddingRegion,borderWidth,field;
if(!innerRegion.contains(point)){
paddingRegion=cp(innerRegion,-padding.top,-padding.left,padding.bottom,padding.right);
if(!paddingRegion.contains(point)){
borderWidth=cmp.getBorderWidth();
if(cp(paddingRegion,-borderWidth.top,0,0,0).contains(point)){
field='top'
}else if(cp(paddingRegion,0,0,0,borderWidth.right).contains(point)){
field='right'
}else if(cp(paddingRegion,0,0,borderWidth.bottom,0).contains(point)){
field='bottom'
}else if(cp(paddingRegion,0,-borderWidth.left,0,0).contains(point)){
field='left'
}
app.fireEvent('activate',{
win:'border',
field:field,
component:cmp
})
}else{
if(cp(innerRegion,-padding.top,0,0,0).contains(point)){
field='top'
}else if(cp(innerRegion,0,0,0,padding.right).contains(point)){
field='right'
}else if(cp(innerRegion,0,0,padding.bottom,0).contains(point)){
field='bottom'
}else if(cp(innerRegion,0,-padding.left,0,0).contains(point)){
field='left'
}
app.fireEvent('activate',{
win:'padding',
field:field,
component:cmp
})
}
}
}
},this)
},
onUpdate:function(){
var region,path='',pathArray,lastStart,tb,rb,bb,lb,tp,rp,bp,lp,fixFuz=0.5,workspace=this.workspace,cmp=this.component,p=cmp.getPadding?cmp.getPadding():{
top:0,
right:0,
bottom:0,
left:0
},b=cmp.getBorderWidth?cmp.getBorderWidth():{
top:0,
right:0,
bottom:0,
left:0
},parent=cmp?cmp.getRenderParent():null;
if(parent&&p.top+p.right+p.bottom+p.left){
region=workspace.copyRegion(this.getRegion(),-fixFuz,-fixFuz,fixFuz,fixFuz).adjust(b.top?b.top+1:0,b.left?b.left+1:0,b.bottom?-b.bottom-1:0,b.right?-b.right-1:0);
lb=region.left;
tb=region.top;
rb=region.right;
bb=region.bottom;
region=workspace.copyRegion(region,p.top,p.left,-p.bottom,-p.right);
lp=region.left;
tp=region.top;
rp=region.right;
bp=region.bottom;
pathArray=[
[
lb,
tb,
rb,
tb,
rb,
bb,
lb,
bb,
false,
lp,
tp,
lp,
bp,
rp,
bp,
rp,
tp
],
[
lb,
tb,
rb,
tb,
rb,
bb,
lb,
bb,
lb,
bp,
rp,
bp,
rp,
tp,
lb,
tp
],
[
lb,
tb,
rb,
tb,
rb,
bb,
rp,
bb,
rp,
tp,
lp,
tp,
lp,
bb,
lb,
bb
],
[
lb,
tb,
rb,
tb,
rb,
bb,
rp,
bb,
rp,
tp,
lb,
tp
],
[
lb,
tb,
rb,
tb,
rb,
tp,
lp,
tp,
lp,
bp,
rb,
bp,
rb,
bb,
lb,
bb
],
[
lb,
tb,
rb,
tb,
rb,
tp,
lb,
tp,
false,
lb,
bp,
rb,
bp,
rb,
bb,
lb,
bb
],
[
lb,
tb,
rb,
tb,
rb,
tp,
lp,
tp,
lp,
bb,
lb,
bb
],
[
lb,
tb,
rb,
tb,
rb,
tp,
lb,
tp
],
[
lb,
tb,
lp,
tb,
lp,
bp,
rp,
bp,
rp,
tb,
rb,
tb,
rb,
bb,
lb,
bb
],
[
rp,
tb,
rb,
tb,
rb,
bb,
lb,
bb,
lb,
bp,
rp,
bp
],
[
lb,
tb,
lp,
tb,
lp,
bb,
lb,
bb,
false,
rp,
tb,
rb,
tb,
rb,
bb,
rp,
bb
],
[
rp,
tb,
rb,
tb,
rb,
bb,
rp,
bb
],
[
lb,
tb,
lp,
tb,
lp,
bp,
rb,
bp,
rb,
bb,
lb,
bb
],
[
lb,
bp,
rb,
bp,
rb,
bb,
lb,
bb
],
[
lb,
tb,
lp,
tb,
lp,
bb,
lb,
bb
]
][!p.top*8+!p.right*4+!p.bottom*2+!p.left*1];
path='M';
lastStart=0;
pathArray.forEach(function(item,index){
if(item===false){
path+='z M';
lastStart=index+1
}else{
path+=(lastStart===index-2?'L':index?',':'')+item
}
});
path+='z';
this.decoSpace.attr({path:path}).show()
}else{
this.decoSpace.hide()
}
},
show:function(){
this.onUpdate()
},
hide:function(){
this.decoSpace.hide()
}
});
web.workspace.plugins.SelectMouseCursor=Ext.extend(web.workspace.plugins.SelectDecorator,{
initDecorator:function(){
},
onUpdate:function(){
var component=this.component,context=component instanceof web.data.components.Page?'page':component instanceof web.data.components.Template?'template':'component';
this.workspace.el.addClass('web-workspace-selected-'+context);
if(this.el){
this.el.addClass('web-component-select')
}
},
onDeselect:function(){
var component=this.component,context=component instanceof web.data.components.Page?'page':component instanceof web.data.components.Template?'template':'component';
this.workspace.el.removeClass('web-workspace-selected-'+context);
if(this.el){
this.el.removeClass('web-component-select')
}
}
});
web.commands.Command=Ext.extend(Ext.util.Observable,{
constructor:function(config){
Ext.apply(this,config);
this.prevState='';
this.addEvents('update','select','deselect');
web.commands.Command.superclass.constructor.call(this,config)
},
execute:Ext.emptyFn,
undo:Ext.emptyFn
});
Ext.ns('web.commands.components.gallery');
web.commands.components.gallery.RemoveImage=Ext.extend(web.commands.Command,{
constructor:function(cfg){
this.executed=false;
web.commands.components.gallery.RemoveImage.superclass.constructor.call(this,cfg)
},
execute:function(){
if(this.executed){
this.gallery.insertImage(this.prevState.asset,this.index,this.prevState.caption)
}else{
this.prevState=this.gallery.getImages(true)[this.index];
this.gallery.removeImage(this.prevState.asset)
}
this.executed=!this.executed;
this.fireEvent('update',this.gallery)
},
undo:function(){
this.execute()
}
});
Ext.ns('web.commands.components');
web.commands.components.gallery.GalleryImageLink=Ext.extend(web.commands.Command,{
constructor:function(cfg){
web.commands.components.gallery.GalleryImageLink.superclass.constructor.call(this,cfg)
},
execute:function(){
var target=this.target,link=this.link,images;
images=target.getImages(true);
this.prevState=images[this.index].action;
images[this.index].action=link;
target.set({images:images});
this.fireEvent('update',target)
},
undo:function(){
var target=this.target,link=this.link,undo=!this.isUndo,images;
this.isUndo=undo;
images=target.getImages(true);
images[this.index].action=undo?this.prevState:link;
target.set({images:images});
this.fireEvent('update',target)
}
});
web.workspace.plugins.SelectGalleryThumbnailActions=Ext.extend(web.workspace.plugins.SelectDecorator,{
buttonsRendered:false,
showDelete:true,
onRender:function(){
this.workspace.mon(this.workspace.el,'click',this.handleDeleteThumbnailClick,this);
this.workspace.mon(this.workspace.el,'click',this.handleLinkClick,this);
this.workspace.mon(this.workspace.el,'click',this.handleUnLinkClick,this);
this.workspace.mon(this.workspace.app,'select',this.onPageChange(),this)
},
onPageChange:function(){
return function(part){
if(!part||!this.component){
return
}
if(this.isPage(part)){
this.deactivateComponent(this.component)
}
}
},
onUpdate:function(component){
if(this.component instanceof web.data.components.Gallery){
this.createButtonPanel()
}
},
onDeselect:function(newComponent){
if(this.component instanceof web.data.components.Gallery){
var el=this.workspace.getComponentEl(this.component);
if(el){
el.select('div.thumb-button-panel').remove()
}
}
},
openLinkDialog:function(dataIndex){
var selectedImage=this.component.getImages(true)[dataIndex];
this.workspace.app.windows.show({
type:'web.windows.Link',
values:selectedImage.action,
okFn:function(wn,linkType,actionType,value){
var link,action=null;
if(linkType==='linkId'){
link=this.workspace.app.dm.get(value);
action={
linkId:link.getId(),
actionType:actionType
}
}else if(linkType==='href'){
action={
link:{
type:'web.data.links.LinkExternal',
name:value,
url:value
},
actionType:actionType
}
}
this.workspace.app.invoker.execute(new web.commands.components.gallery.GalleryImageLink({
target:this.component,
link:action,
index:dataIndex
}))
},
scope:this
})
},
handleLinkClick:function(e){
var target=e.getTarget('.workspace-gallery-thumbnail-link');
if(target){
this.openLinkDialog(target.getAttribute('data-index'))
}
},
handleUnLinkClick:function(e){
var target=e.getTarget('.workspace-gallery-thumbnail-unlink');
if(target){
if(Ext.get(target).hasClass('disabled')){
return false
}
this.openLinkDialog(target.getAttribute('data-index'))
}
},
handleDeleteThumbnailClick:function(e){
var target=e.getTarget('.workspace-gallery-thumbnail-delete');
if(target){
this.workspace.app.invoker.execute(new web.commands.components.gallery.RemoveImage({
gallery:this.component,
index:target.getAttribute('data-index')
}))
}
},
createButtonPanel:function(){
var el=this.workspace.getComponentEl(this.component),imageEls,images=this.component.getImages(true);
if(!el){
return
}
if(this.component.getCrop()){
imageEls=el.select('div.gallery-cell > div:first-child')
}else{
imageEls=el.select('img')
}
imageEls.each(function(imageEl,compositeEl,index){
var panelEl,deleteEl,linkEl,unlinkEl,region=imageEl.getRegion(),padding=5;
if(el.select('div.thumb-button-panel[data-index='+index+']').getCount()===0){
panelEl=el.createChild({
cls:'thumb-button-panel',
'data-index':index
});
if(this.component.isLinksEnabled()){
linkEl=panelEl.createChild({
cls:'web-button workspace-gallery-thumbnail-link',
'data-index':index,
style:images[index].action?'display: none':'',
cn:{
tag:'a',
html:'Link'
}
});
unlinkEl=panelEl.createChild({
cls:'web-button workspace-gallery-thumbnail-unlink ',
'data-index':index,
style:images[index].action?'':'display: none',
cn:{
tag:'a',
cls:'icon-web-buttons-link'
}
})
}
if(this.showDelete){
deleteEl=panelEl.createChild({
cls:'web-button workspace-gallery-thumbnail-delete',
'data-index':index,
cn:{
tag:'a',
cls:'icon-web-buttons-trash'
}
})
}
panelEl.setLocation(region.right-padding-panelEl.getWidth(),region.top+padding)
}
},this)
}
});
web.workspace.plugins.MultiSelect=Ext.extend(Ext.util.Observable,{
type:'web.workspace.plugins.MultiSelect',
constructor:function(isFirst){
if(isFirst){
this.register=new Ext.util.Observable
}
web.workspace.plugins.MultiSelect.superclass.constructor.call(this)
},
init:function(workspace){
this.workspace=workspace;
this.overlay=workspace.overlay;
workspace.multiSelect=this;
this.addEvents('multiselect','beforemultiselect','deselect','change','adjust');
this.selected=[];
this.region=null;
this.ctrl=false;
this.shift=false;
workspace.on('render',function(){
this.initListeners()
},this)
},
initListeners:function(){
var workspace=this.workspace,app=workspace.app;
this.on('multiselect',function(components){
workspace.fireEvent('multiselect',components)
},this);
this.on('deselect',function(){
workspace.fireEvent('multiselect',[])
},this);
app.on('mode',function(mode){
this.select([])
},this);
app.on('select',function(part){
if(part instanceof web.data.components.Page){
if(this.selected.length>0&&part!==this.page){
this.select([])
}
this.page=part
}
},this);
app.on('dragstart',function(name){
if(name==='components'){
this.select([])
}
},this);
app.on('update',function(part,config){
var components=[];
if(config&&config.onRemove){
this.selected.forEach(function(item){
if(item.getParent()){
components.push(item)
}
},this);
if(components.length<this.selected.length){
this.select(components)
}
}else if(!workspace.isActive()&&part.isComponent){
components=this.selected;
setTimeout(function(){
this.select(components)
}.bind(this),50)
}
},this);
app.on('selectall',function(e){
if(!workspace.isActive()){
this.select(workspace.app.getModeDoc().getItems());
e.preventDefault()
}
}.createDelegate(this));
var oldRegion;
workspace.boxSelect.on('adjust',function(region,cfg){
if(!oldRegion){
oldRegion=workspace.copyRegion(this.region)
}
if(!cfg.extEvent.ctrlKey&&!cfg.extEvent.shiftKey){
this.selected=[]
}
this.selectRegion(region)
},this);
workspace.boxSelect.on('select',function(region,cfg){
if(cfg.extEvent.shiftKey&&oldRegion){
region=region.union(oldRegion)
}
oldRegion=null;
if(!cfg.extEvent.ctrlKey&&!cfg.extEvent.shiftKey){
this.selected=[]
}
this.selectRegion(region)
},this)
},
isFocus:function(){
var activeElement=document.activeElement||document.body,isTextField=activeElement.tagName==='INPUT'&&activeElement.getAttribute('type')==='text'||activeElement.tagName==='TEXTAREA';
return this.selected.length&&!this.workspace.select.active&&!isTextField&&!this.workspace.multiSelectTitleSize.hasFocus()
},
select:function(components){
this.fireEvent('beforemultiselect',components);
var newComponents=[],len=components.length,actionTips=this.workspace.app.actionTips;
components.forEach(function(component){
if(component&&component.getParent()&&(!component.isGhost()||len===1)){
newComponents.push(component)
}
},this);
if(this.isFocus()){
actionTips.pushMessage('actionTip-selectSecondComp')
}
this.selected=[].concat(newComponents);
this.refresh()
},
selectRegion:function(region){
var workspace=this.workspace,app=workspace.app,doc=app.getModeDoc(),items=doc.getItems(),newSelected=[].concat(this.selected);
items.forEach(function(item){
if(region.contains(workspace.getComponentRegion(item))&&newSelected.indexOf(item)<0){
newSelected.push(item)
}
},this);
this.select(newSelected)
},
refresh:function(){
var selected=this.selected,len=selected.length,workspace=this.workspace,app=workspace.app;
this.selected=selected=selected.sort(function(a,b){
return a.getIndex()-b.getIndex()
});
this.region=null;
selected.forEach(function(component){
var region=workspace.getComponentRegion(component);
this.region=this.region?this.region.union(region):region
},this);
if(len===0){
app.fireEvent('select',app.getModeDoc());
this.fireEvent('deselect',this.selected)
}else{
this.fireEvent('multiselect',this.selected)
}
this.fireEvent('change',this.selected)
},
isGhost:function(){
return this.selected.length===1&&this.selected[0].isGhost()
},
isStretchy:function(){
var isStretchy=true;
this.selected.forEach(function(item){
isStretchy=isStretchy&&item.isStretchy()
});
return isStretchy
}
});
web.workspace.plugins.MultiSelectDecorator=Ext.extend(web.workspace.plugins.MultiSelect,{
constructor:function(plugin){
this.plugin=plugin;
this.register=plugin.register;
web.workspace.plugins.MultiSelectDecorator.superclass.constructor.call(this)
},
init:function(workspace){
web.workspace.plugins.MultiSelectDecorator.superclass.init.call(this,workspace);
this.initPopulate();
var that=this;
while(that&&that.initDecorator){
that.initDecorator();
that=that.plugin
}
},
initListeners:function(){
var that=this;
while(that&&that.preRender){
that.preRender();
that=that.plugin
}
web.workspace.plugins.MultiSelectDecorator.superclass.initListeners.call(this);
that=this;
while(that&&that.initRender){
that.initRender();
that=that.plugin
}
var timer;
this.workspace.on('redraw',function(){
cancelAnimationFrame(timer);
timer=requestAnimationFrame(this.redraw.createDelegate(this))
},this);
this.workspace.multiSelectResize.on('adjustsize',function(region,changes){
this.adjust(region,changes,{resize:true})
},this);
this.workspace.multiSelectResize.on('adjustsizeend',function(region,changes){
this.adjustEnd(region,changes)
},this);
this.workspace.on('componentover',function(drop){
this.adjust(drop.getRegion(),drop.position.changes,drop)
},this);
this.workspace.on('dropcomponent',function(drop){
this.adjustEnd(drop.getRegion(),drop.position.changes,drop)
},this)
},
initPopulate:function(){
this.plugin.workspace=this.workspace;
this.plugin.selected=this.selected;
if(this.plugin.initPopulate){
this.plugin.initPopulate()
}
},
populate:function(secondaryCall){
if(!secondaryCall){
this.region=null;
this.selected.forEach(function(item){
var region=this.workspace.getComponentRegion(item);
this.region=this.region?this.region.union(region):region
},this)
}
this.plugin.region=this.region;
this.plugin.selected=this.selected;
if(this.plugin.populate){
this.plugin.populate(true)
}
},
refresh:function(){
web.workspace.plugins.MultiSelectDecorator.superclass.refresh.call(this);
this.populate();
var that=this;
while(that&&that.onRefresh){
that.onRefresh();
that=that.plugin
}
},
redraw:function(){
this.populate();
var that=this;
while(that&&that.onRedraw){
that.onRedraw();
that=that.plugin
}
},
adjust:function(region,position,drop){
this.workspace.multiSelect.fireEvent('adjust',region,position);
var that=this;
while(that&&that.onAdjust){
that.onAdjust(region,position,drop);
that=that.plugin
}
},
adjustEnd:function(region,drop){
var that=this;
while(that&&that.onAdjustEnd){
that.onAdjustEnd(region,drop);
that=that.plugin
}
},
initDecorator:function(){
},
preRender:function(){
},
initRender:function(){
},
onRefresh:function(){
},
onRedraw:function(){
},
onAdjust:function(region){
},
onAdjustEnd:function(region){
},
getRegion:function(newRegion){
this.getRegions().forEach(function(region){
newRegion.left=newRegion[0]=Math.min(newRegion.left,region.left);
newRegion.right=Math.max(newRegion.right,region.right);
newRegion.top=newRegion[1]=Math.min(newRegion.top,region.top);
newRegion.bottom=Math.max(newRegion.bottom,region.bottom)
});
return newRegion
},
getRegions:function(nR){
var workspace=this.workspace,oR=this.region,iR=this.register.initialRegion,oTop,oRight,oBottom,oLeft,oHeight,oWidth,nHeight,nWidth,isResize,isMove,regions,wwRatio,hhRatio;
if(oR&&nR){
oTop=oR.top;
oBottom=oR.bottom;
oLeft=oR.left;
oRight=oR.right;
oHeight=oBottom-oTop;
oWidth=oRight-oLeft;
nHeight=nR.bottom-nR.top;
nWidth=nR.right-nR.left;
isResize=oHeight!==nHeight||oWidth!==nWidth;
isMove=!isResize&&(oTop!==nR.top||oLeft!==nR.left)
}
if(isResize){
wwRatio=nWidth/(this.register.iWidth||oWidth);
hhRatio=nHeight/(this.register.iHeight||oHeight)
}
var dx,dy;
if(isMove){
dx=nR.left-oLeft;
dy=nR.top-oTop
}
regions=this.selected.map(function(item,index){
var region=workspace.getComponentRegion(item),iComponentRegion;
if(!region){
return region
}
if(isResize){
iComponentRegion=this.register.iRegions?this.register.iRegions[index]:region;
region=this.adjustRegionResize(region,iComponentRegion,nR,iR||oR,wwRatio,hhRatio)
}
if(isMove){
region=workspace.copyRegion(region);
region.adjust(dy,dx,dy,dx)
}
return region
}.bind(this));
return regions
},
adjustRegionResize:function(newComponentRegion,oldComponentRegion,newSelectionRegion,oldSelectionRegion,wRatio,hRatio){
var region=this.workspace.copyRegion(newComponentRegion);
if(wRatio!==1){
region.left=newSelectionRegion.left+(oldComponentRegion.left-oldSelectionRegion.left)*wRatio;
region.right=newSelectionRegion.left+(oldComponentRegion.right-oldSelectionRegion.left)*wRatio
}
if(hRatio!==1){
region.top=newSelectionRegion.top+(oldComponentRegion.top-oldSelectionRegion.top)*hRatio;
region.bottom=newSelectionRegion.top+(oldComponentRegion.bottom-oldSelectionRegion.top)*hRatio
}
region.top=Math.round(region.top);
region.bottom=Math.max(region.top+1,Math.round(region.bottom));
region.left=Math.round(region.left);
region.right=Math.max(region.left+1,Math.round(region.right));
return region
}
});
web.utils.Object={
getGlobalFromObjectNotation:function(ns){
ns=ns.split('.');
var obj=window;
ns.forEach(function(part){
if(obj){
obj=obj[part]
}
});
return obj
},
keys:function(o){
if(Object.keys){
return Object.keys(o)
}
var keys=[];
for(var x in o){
if(o.hasOwnProperty(x)){
keys.push(x)
}
}
return keys
}
};
web.workspace.plugins.MultiSelectClick=Ext.extend(web.workspace.plugins.MultiSelectDecorator,{
type:'web.workspace.plugins.MultiSelectClick',
initDecorator:function(){
this.workspace.on('render',function(){
this.initListeners()
},this)
},
initListeners:function(){
var workspace=this.workspace,app=workspace.app;
workspace.contentEl.on('click',function(e,t){
var part,actions=[],actionedMap={};
if(e.browserEvent.which===3||e.browserEvent.button===2){
return
}
if(workspace.isActive()){
return
}
if(e.getTarget('.web-move-title')||e.getTarget('.web-workspace-multiselectclick')){
return
}
if(e.getTarget('.web-edge-multi')){
return
}
var doc=app.getModeDoc();
if(workspace.select.isEditable(e,t)){
part=this.selected[0];
actions.push({
type:'edit',
component:part
});
actionedMap[part.id]=true
}else{
part=workspace.getElComponent(t);
if(part&&doc===part.getParent()){
actions.push({
type:'select',
component:part
});
actionedMap[part.id]=true
}
}
if(e.getTarget('.web-move')){
var items=doc.getItems(),point=workspace.getPoint(e);
part=null;
items.sort(function(a,b){
return a.getZIndex()-b.getZIndex()
}).forEach(function(item){
var region=workspace.getComponentRegion(item);
if(region.contains(point)){
part=item
}
},this);
if(part&&doc===part.getParent()&&!actionedMap[part.id]){
actions.push({
type:'select',
component:part
});
actionedMap[part.id]=true
}
}
if(e.getTarget('.web-workspace')){
document.activeElement.blur()
}
var overlaps=workspace.overlapDecos.getOverlaps(e);
overlaps.reverse().forEach(function(part){
if(part&&doc===part.getParent()&&!actionedMap[part.id]){
actions.push({
type:'select',
component:part,
underneath:true
});
actionedMap[part.id]=true
}
},this);
if(actions.length===1){
this.handleAction(actions[0],e)
}else if(actions.length){
this.handleActions(actions,e)
}else{
workspace.multiSelect.select([])
}
},this);
workspace.contentEl.on('dblclick',function(e){
var isOverlapped=!!workspace.overlapDecos.getOverlaps(e).length;
if(e.getTarget('.web-workspace-multiselectclick')){
isOverlapped=true
}
if(isOverlapped){
app.actionTips.pushMessage('actionTip-doubleClickSameArea')
}
})
},
handleAction:function(action,e){
if(action.type==='edit'){
this.workspace.select.activate(e)
}else if(action.type==='select'){
this.handleSelect(action.component,e)
}
},
handleActions:function(actions,e){
var underlyingComponents='<span style="font-weight:bold">'+actions.length+'</span>'+' components are placed on top of each other. Select one of them:',footerText='<footer class="contextMenuFooter x-menu-item-text">'+('Click '+'<a class="icon icon-web-buttons-move-small"></a>'+' to move components backwards and forwards.')+'</footer>';
if(actions.length>1){
if(!this.actionsMenu){
this.actionsMenu=new Ext.menu.Menu({
renderTo:this.workspace.contentEl,
cls:'web-workspace-multiselectclick multi-select-action-menu',
listeners:{
hide:function(){
this.lastHoveredItem=null
},
scope:this
},
plugins:[new web.ui.plugins.DomObserver({
mouseover:this.onActionItemMouseOver,
scope:this
})]
})
}
this.actionsMenu.removeAll(true);
this.actionsMenu.addText('<header class="contextMenuHeader x-menu-item-text">'+underlyingComponents+'</header>');
actions.forEach(function(action,index){
var iconCls='icon-'+action.component.type.split('.').slice(-1)[0].toLowerCase()+'-small';
if(action.type==='select'){
var translatedComponentType=web.utils.Object.getGlobalFromObjectNotation(action.component.type).NAME,text;
if(action.underneath){
text='Select '+('<span style="font-weight:bold">'+translatedComponentType+'</span>')+' component underneath'
}else{
text='Select '+('<span style="font-weight:bold">'+translatedComponentType+'</span>')+' component'
}
this.actionsMenu.add(new Ext.menu.Item({
text:text,
iconCls:'icon '+iconCls,
listeners:{
afterrender:function(item,action){
item.el.dom.setAttribute('data-cmpid',action.component.getId())
}.createDelegate(this,[action],true),
click:this.onActionItemClick.createDelegate(this,[
action,
e
])
}
}))
}else if(action.type==='edit'){
this.actionsMenu.add(new Ext.menu.Item({
text:'Edit component',
iconCls:'icon '+iconCls,
listeners:{
afterrender:function(item,action){
item.el.dom.setAttribute('data-cmpid',action.component.getId())
}.createDelegate(this,[action],true),
click:this.onActionItemClick.createDelegate(this,[
action,
e
])
}
}))
}
},this);
this.actionsMenu.addText(footerText);
this.actionsMenu.doLayout();
var pos=[
e.getPageX(),
e.getPageY()
],workspaceBody=this.workspace.el,renderedWidth=this.actionsMenu.el.getWidth();
pos[0]-=25;
pos[1]-=25;
if(pos[0]-workspaceBody.getX()+renderedWidth>workspaceBody.dom.clientWidth+workspaceBody.dom.scrollLeft){
pos[0]=e.getPageX()-renderedWidth+25
}
this.actionsMenu.showAt(pos)
}
},
onActionItemClick:function(action,e){
this.handleAction(action,e)
},
onActionItemMouseOver:function(e){
var componentId,component,anchorTag=Ext.get(e.getTarget('a'));
if(anchorTag){
componentId=anchorTag.getAttribute('data-cmpid');
if(componentId){
component=this.workspace.app.dm.get(componentId)
}
if(component&&this.lastHoveredItem!==component){
var componentEl=this.workspace.getComponentEl(component);
if(componentEl&&componentEl.dom){
this.workspace.hover.show();
this.workspace.hover.hoverOver(componentEl.dom);
this.lastHoveredItem=component
}
}
}
e.stopEvent()
},
handleSelect:function(part,e){
var workspace=this.workspace,selected=this.selected;
selected=[].concat(selected);
if(e.ctrlKey){
var index=selected.indexOf(part);
if(index>=0){
selected.splice(index,1)
}else{
selected.push(part)
}
}else if(e.shiftKey&&selected.length){
workspace.multiSelect.selectRegion(this.region.union(workspace.getComponentRegion(part)));
return
}else{
selected=[part]
}
workspace.multiSelect.select(selected)
}
});
web.workspace.plugins.MultiSelectTemplateDeco=Ext.extend(web.workspace.plugins.MultiSelectDecorator,{
type:'web.workspace.plugins.MultiSelectTemplateDeco',
initDecorator:function(){
this.workspace.multiSelectTemplateDeco=this;
this.decos=[]
},
initRender:function(){
var attrInner={
'fill':'transparent',
stroke:'rgba(63, 63, 63, 1)',
'stroke-width':1,
'stroke-dasharray':'- '
},attrOuter={
'fill':'transparent',
stroke:'rgba(255, 255, 255, 0.4)',
'stroke-width':1,
'stroke-dasharray':'- '
},paper=this.workspace.overlay.paper;
this.leftOuter=paper.path().attr(attrOuter);
this.rightOuter=paper.path().attr(attrOuter);
this.leftInner=paper.path().attr(attrInner);
this.rightInner=paper.path().attr(attrInner);
this.workspace.app.on('mode',function(){
this.show()
},this);
this.workspace.on('reflow',function(){
this.show()
},this);
this.show()
},
onAdjust:function(drop){
this.show(drop)
},
onAdjustEnd:function(){
this.show()
},
show:function(drop){
this.showDecos(drop)
},
showDecos:function(drop){
var workspace=this.workspace,template=workspace.app.getSelected('template'),region=template?workspace.getComponentInnerRegion(template):null;
if(!region){
return
}
var x1=region.left,y1=region.top,x2=region.right,y2=region.bottom,o=0.5;
this.leftOuter.attr({path:'M'+(x1-o)+' '+y1+'L'+(x1-o)+' '+y2}).show();
this.leftInner.attr({path:'M'+(x1+o)+' '+y1+'L'+(x1+o)+' '+y2}).show();
this.rightInner.attr({path:'M'+(x2-o)+' '+y1+'L'+(x2-o)+' '+y2}).show();
this.rightOuter.attr({path:'M'+(x2+o)+' '+y1+'L'+(x2+o)+' '+y2}).show()
},
hide:function(){
this.region=null;
this.hideDecos()
},
hideDecos:function(){
this.leftOuter.hide();
this.rightOuter.hide();
this.leftInner.hide();
this.rightInner.hide()
}
});
web.workspace.plugins.MultiSelectDeco=Ext.extend(web.workspace.plugins.MultiSelectDecorator,{
type:'web.workspace.plugins.MultiSelectDeco',
initDecorator:function(){
this.workspace.multiSelectDeco=this;
this.decos=[]
},
onRefresh:function(){
this.show()
},
onRedraw:function(){
this.show(null,this.isAdjusting)
},
onAdjust:function(region){
this.isAdjusting=true;
this.show(region,true)
},
onAdjustEnd:function(region){
this.isAdjusting=false;
this.show(region)
},
show:function(region,insideEdge){
this.showDecos(region,insideEdge)
},
showDecos:function(nR,insideEdge){
var attr1={
'fill':'transparent',
stroke:'rgba(63, 63, 63, 1)',
'stroke-width':1
},attr2={
'fill':'transparent',
stroke:'rgba(255, 255, 255, 0.4)',
'stroke-width':1
},workspace=this.workspace,paper=workspace.overlay.paper,that=this,add=function(r,attr,offset){
offset=offset||0;
that.decos.push(paper.rect(r.left+offset,r.top+offset,Math.max(r.right-r.left-offset*2,2),Math.max(r.bottom-r.top-offset*2,2)).attr(attr).toBack())
};
this.hideDecos();
var regions=this.getRegions(nR);
this.selected.forEach(function(item,index){
var region=regions[index];
if(region){
add(region,attr2,-1.5+(insideEdge?1:0))
}
},this);
this.selected.forEach(function(item,index){
var region=regions[index];
if(region){
add(region,attr1,-0.5+(insideEdge?1:0))
}
},this)
},
hide:function(){
this.region=null;
this.hideDecos()
},
hideDecos:function(){
this.decos.forEach(function(deco,index){
try{
deco.hide();
deco.remove()
}catch(e){
}
},this);
this.decos=[]
}
});
web.workspace.plugins.MultiSelectMove=Ext.extend(web.workspace.plugins.MultiSelectDecorator,{
type:'web.workspace.plugins.MultiSelectMove',
initDecorator:function(){
this.workspace.multiSelectMove=this;
this.moveEls=[]
},
initRender:function(){
var workspace=this.workspace,app=workspace.app;
workspace.multiSelect.on('select',this.show,this);
workspace.multiSelect.on('deselect',this.hide,this);
workspace.app.on('select',function(part){
if(part instanceof web.data.components.Component&&part.getParent()){
this.hide(true)
}
},this);
app.on('dragstart',function(){
app.el.addClass('web-movemulti')
},this);
app.on('dragend',function(){
app.el.removeClass('web-movemulti')
},this)
},
onRefresh:function(){
this.show()
},
onRedraw:function(){
this.show()
},
show:function(){
var workspace=this.workspace,multiSelect=workspace.multiSelect,region=multiSelect.region,x,y,w,h;
this.hide();
var addMoveEl=function(x,y,w,h,isTitle){
this.moveEls.push(Ext.get(Ext.DomHelper.append(workspace.contentEl,{
cls:'web-move handle'+(isTitle?' web-move-title':''),
style:'left:'+x+'px;'+'top:'+y+'px;'+'width:'+w+'px;'+'height:'+h+'px;'
})))
}.createDelegate(this);
if(region&&!workspace.select.active){
var lr=workspace.adjustRegion(workspace.multiSelectTitle.labelEl.getRegion());
addMoveEl(lr.left,lr.top,region.right-lr.left+5,lr.bottom-lr.top,true);
multiSelect.selected.forEach(function(item){
if(item.isGhost()){
return
}
var region=workspace.getComponentRegion(item);
x=region.left;
y=region.top;
w=region.right-x;
h=region.bottom-y;
addMoveEl(x,y,w,h)
},this)
}
},
hide:function(partial){
var el,els=this.moveEls;
while((!partial||els.length>1)&&(el=els.pop())){
el.hide();
el.remove()
}
}
});
web.workspace.plugins.MultiSelectFrame=Ext.extend(web.workspace.plugins.MultiSelectDecorator,{
type:'web.workspace.plugins.MultiSelectFrame',
initDecorator:function(){
this.workspace.multiSelectFrame=this
},
preRender:function(){
this.borderEdge=this.workspace.overlay.paper.rect(0,0,0,0).attr({
'stroke-width':1,
'stroke':'rgba(255, 255, 255, 0.4)'
})
},
initRender:function(){
this.border=this.workspace.overlay.paper.rect(0,0,0,0).attr({
'stroke-width':2,
'stroke':'rgba(63, 63, 63, 1)'
})
},
onRefresh:function(){
this.onUpdate()
},
onRedraw:function(){
this.onUpdate()
},
onAdjust:function(region){
this.isAdjusting=true;
this.onUpdate(region)
},
onAdjustEnd:function(region){
this.isAdjusting=false;
this.onUpdate(region)
},
onUpdate:function(region){
var x,y;
if(this.selected.length){
region=region||this.region;
x=this.x=region.left;
y=this.y=region.top;
this.w=region.right-x;
this.h=region.bottom-y;
this.showBorder();
this.border.show();
this.borderEdge.show();
this.isActive=true
}else{
this.border.hide();
this.borderEdge.hide();
this.isActive=false
}
},
showBorder:function(){
var x=this.x,y=this.y,w=this.w,h=this.h;
var offset=this.isAdjusting?-1:3;
x-=offset;
y-=offset;
w+=offset*2;
h+=offset*2;
w=Math.max(w,0);
h=Math.max(h,0);
this.border.attr({
x:x,
y:y,
width:w,
height:h
});
x-=1.5;
y-=1.5;
w+=3;
h+=3;
this.borderEdge.attr({
x:x,
y:y,
width:w,
height:h
})
},
show:function(){
if(this.selected.length){
this.border.show();
this.borderEdge.show()
}
this.workspace.multiSelectTitle.show();
this.workspace.multiSelectResize.show();
this.workspace.multiSelectEdge.show();
this.workspace.multiSelectWrap.show()
},
hide:function(){
this.border.hide();
this.borderEdge.hide();
this.workspace.multiSelectWrap.hide();
this.workspace.multiSelectEdge.hide();
this.workspace.multiSelectResize.hide();
this.workspace.multiSelectTitle.hide()
}
});
web.commands.CompoundCommand=Ext.extend(web.commands.Command,{
constructor:function(config){
this.commands=[];
web.commands.CompoundCommand.superclass.constructor.call(this,config)
},
executeCommand:function(command){
command.app=this.app;
this.relayEvents(command,command.app?command.app.coreEvents:[
'update',
'select',
'deselect'
]);
command.execute();
this.commands.push(command)
},
undo:function(){
var i,commands=this.commands,len=commands.length;
commands=commands.reverse();
for(i=0;i<len;i+=1){
commands[i].undo()
}
this.commands=commands;
this.onUndo()
},
onUndo:function(){
}
});
web.commands.components.InsertSimple=Ext.extend(web.commands.Command,{
execute:function(){
this.target.addItem(this.component);
this.fireEvent('update',this.component,this.config)
},
undo:function(){
var isUndo=this.isUndo=!this.isUndo,undoConfig;
if(isUndo){
this.target.removeItem(this.component);
undoConfig=Ext.apply({},this.config);
if(undoConfig.onInsert){
delete undoConfig.onInsert;
undoConfig.onRemove=true
}
this.fireEvent('update',this.component,undoConfig)
}else{
this.execute()
}
}
});
web.commands.components.RemoveSimple=Ext.extend(web.commands.Command,{
execute:function(){
var target=this.target=this.component.getParent();
this.index=target.removeItem(this.component);
this.fireEvent('update',this.component,this.config)
},
undo:function(){
var isUndo=this.isUndo=!this.isUndo,undoConfig;
if(isUndo){
this.target.addItem(this.component,this.index);
undoConfig=Ext.apply({},this.config);
if(undoConfig.onRemove){
delete undoConfig.onRemove;
undoConfig.onInsert=true
}
this.fireEvent('update',this.component,undoConfig)
}else{
this.execute()
}
}
});
web.commands.components.SetConfig=Ext.extend(web.commands.Command,{
execute:function(){
var cmp=this.component,cfg=this.config,json=cmp.toJSON(),prevState={},name;
for(name in cfg){
if(cfg.hasOwnProperty(name)){
prevState[name]=json[name]
}
}
this.prevState=prevState;
cmp.set(cfg);
this.fireEvent('update',cmp,this.eventConfig)
},
undo:function(){
var cmp=this.component,undoConfig;
this.isUndo=!this.isUndo;
cmp.set(this.isUndo?this.prevState:this.config);
if(this.isUndo){
undoConfig=Ext.apply({},this.eventConfig);
if(undoConfig.onInsert){
delete undoConfig.onInsert;
undoConfig.onRemove=true
}else if(undoConfig.onRemove){
delete undoConfig.onRemove;
undoConfig.onInsert=true
}
}
this.fireEvent('update',cmp,this.isUndo?undoConfig:this.eventConfig)
}
});
web.commands.components.ChangeMulti=Ext.extend(web.commands.CompoundCommand,{
execute:function(){
var components=this.components||[],changes=this.changes,target=this.target,dm=this.dm||(this.app?this.app.dm:components[0].dm),ns=web.commands.components;
if(target){
components.forEach(function(component){
this.executeCommand(new ns.InsertSimple({
component:component,
target:target,
config:{onInsert:true}
}))
},this)
}
var id,page,template,aChanges=[];
for(id in changes){
if(changes.hasOwnProperty(id)){
var cmp=dm.get(id),doc=cmp.getParent(),tid=doc?doc.getId():null;
if(!tid){
one.fatal('Component is missing parent during ChangeMulti.',{
component:cmp.toJSON(),
changes:changes,
target:target?target.toJSON():null
})
}
template=template||cmp.getTemplate()||cmp;
page=page||cmp.getPage()||template.getCurrentPage();
aChanges.push({
cmp:cmp,
cfg:changes[id]||{}
})
}
}
if(!page){
return
}
aChanges.forEach(function(change){
if(change.cfg.parentId&&!change.cfg.add){
var doc=dm.get(change.cfg.parentId);
this.executeCommand(new ns.RemoveSimple({
component:change.cmp,
config:{onRemove:true}
}));
this.executeCommand(new ns.InsertSimple({
target:doc,
component:change.cmp,
config:{onInsert:true}
}))
}
},this);
aChanges.forEach(function(changeInfo){
var index=changeInfo.cfg.index;
if(index!==undefined){
changeInfo.cmp.setIndex(index)
}
});
this.adjustments=[];
for(id in changes){
if(changes.hasOwnProperty(id)){
var change=changes[id],component=dm.get(id),oldRelIn,newRelIn,changeEventConfig;
if(component&&change){
oldRelIn=component.getRelInParent();
if(oldRelIn instanceof web.data.components.Text){
this.queueAdjustComponent(oldRelIn)
}
if(change.remove){
this.executeCommand(new ns.RemoveSimple({
component:component,
config:{onRemove:true}
}));
continue
}
if(this.components&&this.components.indexOf(component)===-1){
changeEventConfig={calcOnly:true}
}
this.executeCommand(new ns.SetConfig({
component:component,
config:change,
eventConfig:changeEventConfig
}));
if(change.location!==undefined){
this.queueAdjustComponent(component.getTemplate())
}
newRelIn=component.getRelInParent();
if(newRelIn instanceof web.data.components.Text){
this.queueAdjustComponent(newRelIn)
}
}
}
}
this.fireAdjustments()
},
queueAdjustComponent:function(cmp){
if(this.adjustments.indexOf(cmp)===-1){
this.adjustments.push(cmp)
}
},
onUndo:function(){
this.fireAdjustments()
},
fireAdjustments:function(){
(this.adjustments||[]).forEach(function(cmp){
this.fireEvent('adjust',cmp)
},this)
}
});
web.ui.onMouseup=function(fn,scope){
Ext.getBody().on('mouseup',fn,scope);
Ext.EventManager.addListener(window,'mouseup',fn,scope);
Ext.EventManager.addListener(document,'contextmenu',fn,scope)
};
web.workspace.plugins.MultiSelectResize=Ext.extend(web.workspace.plugins.MultiSelectDecorator,{
initDecorator:function(){
this.handles=[
{
tag:'nw',
edges:[
'left',
'top'
]
},
{
tag:'n',
edges:[
null,
'top'
]
},
{
tag:'ne',
edges:[
'right',
'top'
]
},
{
tag:'e',
edges:[
'right',
null
]
},
{
tag:'se',
edges:[
'right',
'bottom'
]
},
{
tag:'s',
edges:[
null,
'bottom'
]
},
{
tag:'sw',
edges:[
'left',
'bottom'
]
},
{
tag:'w',
edges:[
'left',
null
]
}
];
this.handleMap={
nw:0,
n:1,
ne:2,
e:3,
se:4,
s:5,
sw:6,
w:7
};
this.borderWidth=4;
this.squareSize=10;
this.xyCache=[];
this.addEvents('adjustsize','adjustsizeend')
},
preRender:function(){
this.renderSquares(true)
},
initRender:function(){
var workspace=this.workspace,body=workspace.el;
workspace.multiSelectResize=this;
this.bodyEl=body.first('div');
this.renderOverlays();
this.renderSquares();
body.on('mousemove',function(ev){
if(this.grabHandle){
this.onHandlemove(ev)
}
},this);
body.on('scroll',function(ev){
if(this.grabHandle){
this.onHandlemove(ev)
}
},this);
Ext.EventManager.addListener(document,'contextmenu',function(ev){
if(this.active){
ev.preventDefault()
}
},this);
body.on('mousedown',function(ev,node){
var handle=this.getHandle(node),region=this.region,edgeX,edgeY;
this.grabHandle=handle||this.grabHandle;
if(handle){
this.active=true;
this.obbMap={};
edgeX=handle.edges[0];
edgeY=handle.edges[1];
handle.grabXY=this.getCursorXY(ev);
handle.changeXY=[
0,
0
];
handle.oldWidth=region.right-region.left;
handle.oldHeight=region.bottom-region.top;
handle.oldRegion=region;
this.register.initialRegion=region;
this.register.iHeight=region.bottom-region.top;
this.register.iWidth=region.right-region.left;
this.register.iRegions=this.selected.map(function(item){
return workspace.getComponentRegion(item)
});
handle.changeLimitXY=[
edgeX?this.getMoveEdgeLimits(edgeX):null,
edgeY?this.getMoveEdgeLimits(edgeY):null
];
handle.isDualXY=[
edgeX?this.isMoveEdgeDual(edgeX):null,
edgeY?this.isMoveEdgeDual(edgeY):null
];
workspace.hover.hide();
workspace.multiSelectEdit.hide();
workspace.multiSelectSize.show(region)
}
},this);
web.ui.onMouseup(function(ev){
var changeXY,moveXY,handle=this.grabHandle;
if(handle){
changeXY=handle.changeXY;
this.adjustFinal();
this.adjustXY([
-changeXY[0],
-changeXY[1]
]);
moveXY=this.getMoveXY(this.getCursorXY(ev));
if(moveXY[0]||moveXY[1]){
this.updateXY(moveXY)
}
this.grabHandle=null;
var that=this;
window.setTimeout(function(){
workspace.hover.show();
workspace.multiSelectSize.hide();
if(workspace.multiSelectEdit.isEdit()&&!workspace.isActive()){
workspace.multiSelectEdit.show()
}
that.xyCache=[];
that.active=false
},10)
}
},this)
},
onRefresh:function(){
this.showLocal()
},
onRedraw:function(){
if(!this.isAdjusting){
this.showLocal()
}
},
onAdjust:function(region){
this.isAdjusting=true;
this.hideLocal()
},
onAdjustEnd:function(region){
this.isAdjusting=false;
this.showLocal(region)
},
canMoveEdge:function(edge){
var limits;
if(this.isGhost()){
return false
}else if(edge==='bottom'){
return true
}else{
limits=this.getMoveEdgeLimits(edge);
return limits[0]!==limits[1]
}
},
getMinWidth:function(){
return 1
},
getMinHeight:function(){
return 1
},
getMoveEdgeLimits:function(edge){
var first=-Infinity,last=Infinity,region=this.region,minWidth=this.getMinWidth(),minHeight=this.getMinHeight(),width=region?region.right-region.left:minWidth,height=region?region.bottom-region.top:minHeight,xShrink=width-minWidth,yShrink=height-minHeight;
switch(edge){
case'top':
last=yShrink;
break;
case'right':
first=-xShrink;
break;
case'bottom':
first=-yShrink;
break;
case'left':
last=xShrink;
break
}
return[
first,
last
]
},
isMoveEdgeDual:function(edge){
var cmp=this.selected.length===1?this.selected[0]:null;
return cmp&&cmp.inText()&&cmp.align==='center'
},
renderOverlays:function(){
var i,j,handles=this.handles,handle,node,domHelper=Ext.DomHelper,domTarget=this.workspace.contentEl;
for(i=1;i<8;i+=2){
handle=handles[i];
node=domHelper.append(domTarget,{cls:'web-resize'});
node.setAttribute('data-tag',handle.tag);
handle.overlays=[node]
}
for(i=0;i<8;i+=2){
handle=handles[i];
handle.overlays=[];
for(j=0;j<2;j+=1){
node=domHelper.append(domTarget,{cls:'web-resize'});
node.setAttribute('data-tag',handle.tag);
handle.overlays.push(node)
}
}
},
renderSquares:function(isBorder){
var i,handles=this.handles,handle,paper=this.workspace.overlay.paper,size=this.squareSize-4,cssDark='rgba(63, 63, 63, 1)',cssLight='rgba(255, 255, 255, 0.4)',attrSquare=isBorder?{
stroke:cssLight,
'stroke-width':4,
fill:'transparent'
}:{
stroke:cssDark,
'stroke-width':2,
'stroke-linejoin':'miter',
fill:'transparent'
};
for(i=0;i<8;i+=1){
handle=handles[i];
handle[isBorder?'squareEdge':'square']=paper.rect(0,0,size,size).attr(attrSquare).hide()
}
},
onHandlemove:function(ev){
var cursorXY=this.getCursorXY(ev),moveXY=this.getMoveXY(cursorXY),points=[],isInCache,app=this.workspace.app;
if(!app.actionTips.isAlreadySeen('actionTip-jigglingMouseWhileResize')){
isInCache=this.xyCache.some(function(cacheXY){
return cacheXY[0]===moveXY[0]&&cacheXY[1]===moveXY[1]
});
if(!isInCache){
this.xyCache.unshift([
moveXY[0],
moveXY[1]
]);
this.xyCache.length=50
}else{
points=this.xyCache.filter(function(cacheXY){
return Math.abs(cacheXY[0]-moveXY[0])<10&&Math.abs(cacheXY[1]-moveXY[1])<10
})
}
if(points.length>15){
app.actionTips.pushMessage('actionTip-jigglingMouseWhileResize')
}
}
this.ratioLock=ev.shiftKey;
this.snapTo=!ev.altKey;
this.adjustXY(moveXY);
this.adjustHandle(moveXY);
ev.stopEvent()
},
getCursorXY:function(ev){
var xy=ev.getXY(),bxy=this.bodyEl.getXY();
if(!xy[0]&&!xy[1]){
xy=this.cursorXY
}
this.cursorXY=xy;
return[
xy[0]-bxy[0],
xy[1]-bxy[1]
]
},
isRatioLock:function(){
var handle=this.grabHandle,xEdge,yEdge,componentLocked=this.selected[0]&&this.selected[0].isRatioLock();
if(handle){
xEdge=handle.edges[0];
yEdge=handle.edges[1]
}
return this.ratioLock||xEdge&&yEdge||componentLocked
},
getMoveXY:function(cursorXY){
var handle=this.grabHandle,xEdge,yEdge,grabXY,changeXY,changeX,changeY,limitXY,limitX,limitY,moveXY=[
0,
0
];
if(handle){
xEdge=handle.edges[0];
yEdge=handle.edges[1];
grabXY=handle.grabXY;
changeXY=handle.changeXY;
changeX=cursorXY[0]-grabXY[0];
changeY=cursorXY[1]-grabXY[1];
limitXY=handle.changeLimitXY;
limitX=limitXY[0];
limitY=limitXY[1];
if(limitX){
changeX=changeX<limitX[0]?limitX[0]:changeX>limitX[1]?limitX[1]:changeX
}
if(limitY){
changeY=changeY<limitY[0]?limitY[0]:changeY>limitY[1]?limitY[1]:changeY
}
moveXY[0]=Math.round(changeX-changeXY[0]);
moveXY[1]=Math.round(changeY-changeXY[1])
}
return moveXY
},
adjustXY:function(xy){
var handle=this.grabHandle,xEdge,yEdge;
if(handle){
xEdge=handle.edges[0];
yEdge=handle.edges[1];
if(xEdge){
handle.changeXY[0]+=xy[0]
}
if(yEdge){
handle.changeXY[1]+=xy[1]
}
}
},
adjustHandle:function(xy){
var handle=this.grabHandle,workspace=this.workspace,xEdge,yEdge,isLeft,isTop,isDualXY,isDualX,isDualY,dx=0,dy=0,dw=0,dh=0,region;
if(handle){
xEdge=handle.edges[0];
yEdge=handle.edges[1];
isLeft=xEdge==='left';
isTop=yEdge==='top';
isDualXY=handle.isDualXY;
isDualX=isDualXY[0];
isDualY=isDualXY[1];
if(xEdge){
dx+=isLeft?xy[0]:isDualX?-xy[0]:0;
dw+=xy[0]*(isLeft?-1:1)*(isDualX?2:1)
}
if(yEdge){
dy+=isTop?xy[1]:isDualY?-xy[1]:0;
dh+=xy[1]*(isTop?-1:1)*(isDualY?2:1)
}
region=handle.adjustRegion=workspace.copyRegion(handle.adjustRegion||handle.oldRegion,dy,dx,dy+dh,dx+dw);
region=handle.snapRegion=this.snapTo?workspace.toSnapRegion(region,[
xEdge,
yEdge
]):region;
if(region.right-region.left<this.getMinWidth()){
region.right=handle.adjustRegion.right;
region.left=handle.adjustRegion.left
}
if(region.bottom-region.top<this.getMinHeight()){
region.top=handle.adjustRegion.top;
region.bottom=handle.adjustRegion.bottom
}
if(this.isRatioLock()){
var oldRatio=handle.oldWidth/handle.oldHeight,w=region.right-region.left,h=region.bottom-region.top;
if(!yEdge){
h=w/oldRatio;
region.top=Math.round((region.top+region.bottom-h)/2);
region.bottom=region.top+Math.round(h)
}else if(!xEdge){
w=h*oldRatio;
region.left=Math.round((region.left+region.right-w)/2);
region.right=region.left+Math.round(w)
}else{
if(oldRatio>=1){
h=Math.round(w/oldRatio)
}else{
w=Math.round(h*oldRatio)
}
if(xEdge==='left'){
region.left=region.right-w
}else{
region.right=region.left+w
}
if(yEdge==='top'){
region.top=region.bottom-h
}else{
region.bottom=region.top+h
}
}
}
if(this.oldRegion&&region.top===this.oldRegion.top&&region.right===this.oldRegion.right&&region.bottom===this.oldRegion.bottom&&region.left===this.oldRegion.left){
return
}
this.oldRegion=region;
this.regions=this.getRegions(region);
this.selected.forEach(function(cmp){
this.obbMap[cmp.id]=this.obbMap[cmp.id]||cmp.bbox
},this);
workspace.autoAdjust.off=true;
clearTimeout(this.resizeTimeout);
var now=Date.now(),wait=35;
this.renderTimestamp=this.renderTimestamp||now;
var last=now-this.renderTimestamp;
if(last>wait){
this.adjustWithDom(handle);
this.renderTimestamp=now;
this.adjustProcess()
}else{
this.resizeTimeout=setTimeout(function(){
this.adjustWithDom(handle);
this.renderTimestamp=now;
this.adjustProcess()
}.bind(this),wait-last)
}
}
},
adjustWithDom:function(handle){
var isTop=handle?handle.edges[1]==='top':null,workspace=this.workspace;
(this.regions||[]).forEach(function(region,index){
var cmp=this.selected[index],bbox=workspace.getRegionBBox(region),el,domRegion,change={bbox:bbox};
cmp.onBeforeBboxChanged(change,this.previousChange);
cmp.set(change);
this.previousChange=change;
cmp.finalAutoTop=bbox.top;
workspace.updateComponent(cmp,true);
el=workspace.getComponentEl(cmp);
el.dom.style.top=bbox.top+'px';
domRegion=workspace.getComponentRegion(cmp);
if(isTop){
var height=region.bottom-region.top,domHeight=domRegion.bottom-domRegion.top;
if(domHeight>height){
domRegion.bottom=region.bottom;
domRegion.top=domRegion.bottom-domHeight;
cmp.set({bbox:workspace.getRegionBBox(domRegion)});
workspace.updateComponent(cmp);
el=workspace.getComponentEl(cmp);
el.dom.style.top=domRegion.top+'px'
}
}
this.regions[index]=domRegion;
cmp.set({bbox:this.obbMap[cmp.id]})
},this)
},
adjustProcess:function(){
var changes={},region=this.grabHandle?this.grabHandle.snapRegion:[],workspace=this.workspace;
(this.regions||[]).forEach(function(region,index){
var cmp=this.selected[index];
changes[cmp.id]={bbox:workspace.getRegionBBox(region)}
},this);
this.changes=changes;
if(region){
this.fireEvent('adjustsize',region,changes)
}
},
adjustFinal:function(){
var changes={},region=this.grabHandle?this.grabHandle.snapRegion:[],workspace=this.workspace;
(this.regions||[]).forEach(function(region,index){
var cmp=this.selected[index];
changes[cmp.id]={bbox:workspace.getRegionBBox(region)}
},this);
this.changes=changes=workspace.calcRels(changes);
if(region){
this.fireEvent('adjustsize',region,changes);
workspace.app.actionTips.pushMessage('actionTip-moveOrResizeFirstComp')
}
},
updateXY:function(xy){
var handle=this.grabHandle;
if(handle){
this.adjustWithDom(handle);
this.previousChange=null;
this.workspace.autoAdjust.off=false;
if(handle.snapRegion!==handle.oldRegion){
this.workspace.app.invoker.execute(new web.commands.components.ChangeMulti({
changes:this.changes,
components:this.selected
}))
}
this.fireEvent('adjustsizeend',this.getRegion(handle.snapRegion),this.changes);
handle.adjustRegion=null;
handle.snapRegion=null
}
},
getHandle:function(node){
return this.handles[this.handleMap[node.getAttribute('data-tag')]]
},
onUpdate:function(region){
var x,y,isAdjust=!!region;
clearTimeout(this.onUpdateTimer);
if(this.selected.length){
region=region||this.region;
x=this.x=region.left;
y=this.y=region.top;
this.w=region.right-x;
this.h=region.bottom-y;
this.calcRegions();
if(!isAdjust){
this.onUpdateTimer=setTimeout(function(){
this.showOverlays();
this.showSquares()
}.bind(this),10)
}else{
this.showOverlays();
this.showSquares()
}
}else{
this.hideLocal()
}
},
showOverlays:function(){
var handles=this.handles,i,handle,regions,overlays,xEdge,yEdge,can,tag,isValid=this.selected.length;
for(i=0;i<8;i+=1){
handle=handles[i];
tag=handle.tag;
xEdge=handle.edges[0];
yEdge=handle.edges[1];
can=(!xEdge||this.canMoveEdge(xEdge))&&(!yEdge||this.canMoveEdge(yEdge));
regions=handle.extendedRegions;
overlays=handle.overlays;
if(isValid&&(can||handle.edges[1]!=='top')){
overlays.forEach(function(overlay,index){
var region=regions[index];
overlay.setAttribute('style','left:'+region[0]+'px;'+'top:'+region[1]+'px;'+'width:'+(region[2]-region[0])+'px;'+'height:'+(region[3]-region[1])+'px;'+'display:'+(this.isHidden?'none':'block')+';');
overlay.setAttribute('class','web-resize'+(can?' web-resize-'+tag:''))
},this)
}else{
overlays.forEach(function(overlay,index){
overlay.setAttribute('style','display:none;')
},this)
}
}
},
showSquares:function(){
var handles=this.handles,i,handle,square,squareEdge,region,xEdge,yEdge,can,x,y,isHidden=this.isHidden;
for(i=0;i<8;i+=1){
handle=handles[i];
xEdge=handle.edges[0];
yEdge=handle.edges[1];
can=(!xEdge||this.canMoveEdge(xEdge))&&(!yEdge||this.canMoveEdge(yEdge));
square=handle.square;
squareEdge=handle.squareEdge;
region=handle.region;
if(can&&region){
x=region[0];
y=region[1];
if(x&&y){
square.attr({
x:x+2,
y:y+2
});
squareEdge.attr({
x:x+2,
y:y+2
});
if(!isHidden){
square.show();
squareEdge.show()
}
}
}else{
square.hide();
squareEdge.hide()
}
}
},
calcRegions:function(){
var ss=this.squareSize,ssh=Math.round(ss/2),o=1,x=this.x,y=this.y,w=this.w,h=this.h,cw=Math.round(w/2),ch=Math.round(h/2),a=[
x-ss-o,
x-o,
x+cw-ssh,
x+cw+ssh,
x+w+o,
x+w+ss+o
],b=[
y-ss-o,
y-o,
y+ch-ssh,
y+ch+ssh,
y+h+o,
y+h+ss+o
],rs=[
[
a[0],
b[0],
a[1],
b[1]
],
[
a[2],
b[0],
a[3],
b[1]
],
[
a[4],
b[0],
a[5],
b[1]
],
[
a[4],
b[2],
a[5],
b[3]
],
[
a[4],
b[4],
a[5],
b[5]
],
[
a[2],
b[4],
a[3],
b[5]
],
[
a[0],
b[4],
a[1],
b[5]
],
[
a[0],
b[2],
a[1],
b[3]
]
],sw=Math.min(Math.round(w/10),50),sh=Math.min(Math.round(h/10),50),es=[
[
[
a[0],
b[0],
a[1]+sw,
b[1]
],
[
a[0],
b[0],
a[1],
b[1]+sh
]
],
[[
a[1]+sw,
b[0],
a[4]-sw,
b[1]
]],
[
[
a[4]-sw,
b[0],
a[5],
b[1]
],
[
a[4],
b[0],
a[5],
b[1]+sh
]
],
[[
a[4],
b[1]+sh,
a[5],
b[4]-sh
]],
[
[
a[4]-sw,
b[4],
a[5],
b[5]
],
[
a[4],
b[4]-sh,
a[5],
b[5]
]
],
[[
a[1]+sw,
b[4],
a[4]-sw,
b[5]
]],
[
[
a[0],
b[4],
a[1]+sw,
b[5]
],
[
a[0],
b[4]-sh,
a[1],
b[5]
]
],
[[
a[0],
b[1]+sh,
a[1],
b[4]-sh
]]
],handles=this.handles,i;
for(i=0;i<8;i+=1){
handles[i].region=rs[i];
handles[i].extendedRegions=es[i]
}
},
showLocal:function(region){
this.onUpdate(region)
},
hideLocal:function(){
this.handles.forEach(function(handle){
handle.square.hide();
handle.squareEdge.hide();
handle.overlays.forEach(function(overlay){
overlay.style.display='none'
})
},this)
},
show:function(){
this.showLocal()
},
hide:function(){
this.hideLocal()
}
});
web.commands.components.AdjustRelations=Ext.extend(web.commands.CompoundCommand,{
execute:function(){
var workspace=this.app.workspace,ns=web.commands.components;
this.components.forEach(function(item){
if(this.others&&this.others.indexOf(item)>=0){
return
}
var oldRelTo=item.getRelTo(),newRelTo=workspace.getIdealRelTo(item);
if(!oldRelTo&&newRelTo||oldRelTo&&!newRelTo||oldRelTo&&newRelTo&&(oldRelTo.id!==newRelTo.id||oldRelTo.page!==newRelTo.page||newRelTo.id&&oldRelTo.below!==newRelTo.below)){
this.executeCommand(new ns.SetConfig({
component:item,
config:{
relTo:newRelTo,
relIn:item.getRelIn()
}
}))
}
},this)
}
});
web.commands.components.MoveEdge=Ext.extend(web.commands.CompoundCommand,{
execute:function(){
var component=this.component,edge=this.edge,amount=this.amount,oldHeight=this.oldHeight,bbox=component.getBBox(),relIn=component.getRelIn(true),relTo=component.getRelTo(),relPara=component.getRelPara(),relPage=component.getRelPage(),ns=web.commands.components,calcOnlyUpdate={calcOnly:true};
if(oldHeight!==component.getHeight()){
this.executeCommand(new ns.SetConfig({
component:component,
config:{height:oldHeight}
}))
}
if(component instanceof web.data.components.Template){
bbox.right+=(edge==='left'?-amount:amount)*(component.getAlign()==='center'?2:1);
bbox.right=Math.max(bbox.right,component.getMinWidth());
var w=bbox.right-bbox.left;
if(component.getAlign()==='center'&&w%2){
bbox.right+=1
}
this.executeCommand(new ns.SetConfig({
component:component,
config:{bbox:bbox}
}));
this.fireEvent('update',component.getCurrentPage())
}
if(edge==='top'||!this.isTarget){
bbox.top+=amount;
bbox.bottom+=amount;
this.executeCommand(new ns.SetConfig({
component:component,
config:{bbox:bbox}
}));
if(relIn){
relIn.top+=amount;
this.executeCommand(new ns.SetConfig({
component:component,
config:{relIn:relIn},
eventConfig:calcOnlyUpdate
}))
}
if(relPara){
relPara.offset+=amount;
this.executeCommand(new ns.SetConfig({
component:component,
config:{relPara:relPara},
eventConfig:calcOnlyUpdate
}))
}
if(relTo){
relTo.below+=amount;
this.executeCommand(new ns.SetConfig({
component:component,
config:{relTo:relTo},
eventConfig:calcOnlyUpdate
}))
}
var page=this.component.getPage()||(this.component.getParent()?this.component.getParent().getCurrentPage():this.component.getCurrentPage());
if(relPage&&relPage[page.id]&&this.isTarget){
relPage[page.id]+=amount;
this.executeCommand(new ns.SetConfig({
component:component,
config:{relPage:relPage},
eventConfig:calcOnlyUpdate
}))
}
}
if(edge==='bottom'&&this.isTarget){
bbox.bottom+=amount;
this.executeCommand(new ns.SetConfig({
component:component,
config:{bbox:bbox}
}));
component.getRelInItems().forEach(function(item){
var cb=item.getBBox(),cr=item.getRelIn(),db=cb.bottom-bbox.bottom;
cr.bottom=db;
this.executeCommand(new ns.SetConfig({
component:item,
config:{relIn:cr},
eventConfig:calcOnlyUpdate
}))
},this)
}
var parent=component.getRelInParent();
this.adjustments=[];
while(parent&&!parent.isDocument()){
this.adjustments.push(parent);
parent=parent.getRelInParent()
}
this.fireAdjustments()
},
onUndo:function(){
this.fireAdjustments()
},
fireAdjustments:function(){
(this.adjustments||[]).forEach(function(cmp){
this.fireEvent('adjust',cmp)
},this)
}
});
web.commands.components.MultiMoveEdge=Ext.extend(web.commands.CompoundCommand,{
execute:function(){
var comingComponents=this.components,edge=this.edge,amount=this.amount,ns=web.commands.components,components=comingComponents[0].removeChildren(comingComponents[0].removeRelToDependant(comingComponents)),originalSet=components,parents=[],belowParents=[];
if(!components.length){
return
}
components.forEach(function(component){
var parent=component;
while(parent&&!parent.isDocument()){
if(parents.indexOf(parent)===-1){
parents.push(parent);
belowParents=belowParents.concat(parent.removeRelToDependant(parent.toSingleParent(parent.calcBelow([parent],edge))))
}
parent=parent.getRelInParent()
}
});
components=components.concat(belowParents);
components=web.utils.Array.unique(components);
components=originalSet[0].removeRelToDependant(components);
components.forEach(function(component){
this.executeCommand(new ns.MoveEdge({
component:component,
edge:edge,
amount:amount,
isTarget:originalSet.indexOf(component)>-1
}))
},this)
}
});
web.workspace.plugins.MultiSelectEdge=Ext.extend(web.workspace.plugins.MultiSelectDecorator,{
initDecorator:function(){
this.addEvents('adjustedge','adjustedgeend')
},
preRender:function(){
var workspace=this.workspace,body=workspace.el;
workspace.multiSelectEdge=this;
this.dx=22;
this.dy=14;
this.top=new web.workspace.decos.VEdge({
workspace:workspace,
light:true,
edge:'top',
dx:this.dx,
dy:this.dy
});
this.bottom=new web.workspace.decos.VEdge({
workspace:workspace,
light:true,
edge:'bottom',
dx:this.dx,
dy:this.dy
});
var cls='web-edge web-edge-multi web-edge-row';
this.topEl=Ext.get(Ext.DomHelper.append(workspace.contentEl,{cls:cls}));
this.bottomEl=Ext.get(Ext.DomHelper.append(workspace.contentEl,{cls:cls}));
this.topEl.hide();
this.bottomEl.hide();
body.on('mousedown',function(ev){
var target=ev.getTarget('.web-edge-multi');
if(target){
ev.stopPropagation();
this.active=true;
this.onStart(ev,Ext.get(target))
}
},this);
body.on('mousemove',function(ev){
if(this.active){
this.onMove(ev)
}
},this);
web.ui.onMouseup(function(ev){
if(this.active){
ev.stopPropagation();
this.active=false;
this.onEnd(ev)
}
},this)
},
onStart:function(ev,target){
var workspace=this.workspace,edge=target===this.topEl?'top':'bottom';
this.handle={
startY:ev.getXY()[1],
scrollY:workspace.el.dom.scrollTop,
startTop:target.getY(),
edge:edge,
deco:this[edge],
el:target
};
workspace.multiSelectFrame.hide();
workspace.hover.hide();
this.show()
},
onMove:function(ev){
var handle=this.handle,y=ev.getXY()[1],dy=handle.dy=y+this.workspace.el.dom.scrollTop-(handle.startY+handle.scrollY);
var components=this.selected,minDY=handle.edge==='top'?-components[0].getTopShiftMin(components):components[0].getBottomShiftMin(components);
handle.dy=dy=Math.max(dy,minDY);
handle.el.setY(y);
handle.deco.set({region:this.workspace.copyRegion(this.region,dy,0,dy,0)}).show()
},
onEnd:function(){
var handle=this.handle,workspace=this.workspace;
if(handle.dy){
workspace.app.invoker.execute(new web.commands.components.MultiMoveEdge({
components:this.selected,
edge:handle.edge,
amount:handle.dy
}))
}
var that=this;
window.setTimeout(function(){
workspace.hover.show();
workspace.multiSelectFrame.show();
that.active=false
},50)
},
onRefresh:function(){
this.showLocal()
},
onRedraw:function(){
if(!this.isAdjusting){
this.showLocal()
}
},
onAdjust:function(region){
this.isAdjusting=true;
this.hideLocal()
},
onAdjustEnd:function(region){
this.isAdjusting=false;
this.showLocal(region)
},
onUpdate:function(region){
var hh=10,dx=this.dx+9,dy=this.dy;
region=region||this.region;
if(this.selected.length&&region){
this.top.set({region:region}).show();
this.bottom.set({region:region}).show();
this.topEl.dom.setAttribute('style','left:'+(region.left-dx)+'px;'+'top:'+(region.top-dy-hh)+'px;'+'width:'+(region.right-region.left+dx*2)+'px;'+'height:20px;'+'display:block;');
this.bottomEl.dom.setAttribute('style','left:'+(region.left-dx)+'px;'+'top:'+(region.bottom+dy-hh)+'px;'+'width:'+(region.right-region.left+dx*2)+'px;'+'height:20px;'+'display:block;')
}else{
this.hideLocal()
}
},
showLocal:function(region){
this.onUpdate(region)
},
hideLocal:function(){
this.top.hide();
this.bottom.hide();
this.topEl.hide();
this.bottomEl.hide()
},
show:function(){
this.showLocal()
},
hide:function(){
this.hideLocal()
}
});
web.workspace.plugins.MultiSelectSnapTo=Ext.extend(web.workspace.plugins.MultiSelectDecorator,{
type:'web.workspace.plugins.MultiSelectSnapTo',
criticalSpeed:5,
initDecorator:function(){
this.workspace.multiSelectSnapTo=this;
this.decos=[]
},
onAdjust:function(region,pos,drop){
this.show(region,drop)
},
onAdjustEnd:function(){
this.hide()
},
show:function(region,drop){
this.showDecos(region,drop)
},
showDecos:function(region,drop){
var attr1={
'fill':'transparent',
stroke:'rgba(126, 126, 126, 1)',
'stroke-width':1
},attr2={
'fill':'transparent',
stroke:'rgba(101, 101, 167, 1)',
'stroke-width':1
},workspace=this.workspace,paper=workspace.overlay.paper,that=this,add=function(path,attr){
that.decos.push(paper.path(path).attr(attr))
};
this.hideDecos();
if(drop&&drop.distance>this.criticalSpeed){
return
}
region.middle=Math.round((region.top+region.bottom)/2);
region.center=Math.round((region.left+region.right)/2);
var template=workspace.app.getSelected('template'),items=template.getAllItems().concat([template]),vpRegion=workspace.getViewportRegion(),exclude=this.selected,edges=[
'top',
'right',
'bottom',
'left',
'middle',
'center'
],opp={
top:'bottom',
right:'left',
bottom:'top',
left:'right'
},snaps={};
items=items.filter(function(item){
var outer=item.getParent()?this.getComponentRegion(item):this.getComponentInnerRegion(item);
return!item.isGhost()&&vpRegion.intersect(outer)
}.bind(workspace));
items.forEach(function(item){
var outer=item.getParent()?workspace.getComponentRegion(item):workspace.getComponentInnerRegion(item);
if(outer&&exclude.indexOf(item)===-1){
outer.middle=Math.round((outer.top+outer.bottom)/2);
outer.center=Math.round((outer.left+outer.right)/2);
edges.forEach(function(edge){
if(opp[edge]&&(region[edge]===outer[edge]||region[edge]===outer[opp[edge]])){
snaps[edge]=true
}
if(!opp[edge]&&region[edge]===outer[edge]){
snaps[edge]=true
}
})
}
if(item instanceof web.data.components.Text&&region.intersect(outer)&&exclude.indexOf(item)===-1){
var relInEl=workspace.getComponentEl(item),paraEls=relInEl.select('[data-index]');
paraEls.each(function(paraEl,els,index){
var paraRegion=workspace.adjustRegion(paraEl.getRegion());
if(region.top===paraRegion.top){
snaps.top=true
}
},this)
}
},this);
var v=workspace.adjustRegion(workspace.getDeskElRegion());
edges.forEach(function(edge){
if(snaps[edge]){
var x1=v.left-10,y1=v.top-10,x2=v.right+10,y2=v.bottom+10,attr=attr1;
switch(edge){
case'top':
y1=y2=region.top+0.5;
break;
case'right':
x1=x2=region.right-0.5;
break;
case'bottom':
y1=y2=region.bottom-0.5;
break;
case'left':
x1=x2=region.left+0.5;
break;
case'middle':
y1=y2=region.middle-0.5;
attr=attr2;
break;
case'center':
x1=x2=region.center-0.5;
attr=attr2;
break
}
add('M'+x1+' '+y1+'L'+x2+' '+y2,attr)
}
})
},
hide:function(){
this.region=null;
this.hideDecos()
},
hideDecos:function(){
this.decos.forEach(function(deco,index){
try{
deco.hide();
deco.remove()
}catch(e){
}
},this);
this.decos=[]
}
});
web.workspace.plugins.MultiSelectTitle=Ext.extend(web.workspace.plugins.MultiSelectDecorator,{
initDecorator:function(){
this.workspace.multiSelectTitle=this;
this.isHidden=false;
this.borderWidth=4;
this.menuHeight=26;
this.minWidth=88;
this.offsetY=-26;
this.gap=74
},
initRender:function(){
var workspace=this.workspace,paper=workspace.overlay.paper,cssDark='rgba(63, 63, 63, 1)',cssLight='rgba(255, 255, 255, 0.4)';
this.menuMainEdge=paper.rect(0,0,0,0).attr({
fill:cssLight,
stroke:cssLight,
'stroke-width':1.5,
'stroke-linejoin':'miter'
});
this.menuTipEdge=paper.path().attr({
fill:cssLight,
stroke:cssLight,
'stroke-width':1.5,
'stroke-linejoin':'miter'
});
this.menuMain=paper.rect(0,0,0,0).attr({
fill:cssDark,
stroke:'transparent'
});
this.menuTip=paper.path().attr({
fill:cssDark,
stroke:'transparent'
});
this.labelEl=Ext.get(Ext.DomHelper.append(workspace.contentEl,{cls:'web-select-label'}));
this.iconEl=Ext.get(Ext.DomHelper.append(this.labelEl,{cls:'web-select-label-icon icon'}));
this.textEl=Ext.get(Ext.DomHelper.append(this.labelEl,{cls:'web-select-label-text'}))
},
menuToFront:function(){
this.menuMain.toFront()
},
onRefresh:function(){
this.onUpdate()
},
onAdjust:function(){
this.hideTitle()
},
onAdjustEnd:function(region){
this.onUpdate(region)
},
onUpdate:function(region){
var x,y,w,h,width=this.minWidth;
if(this.selected.length){
region=region||this.region;
x=this.x=region.left;
if(region.top>this.menuHeight+this.borderWidth+-this.offsetY){
y=this.y=Math.max(30,region.top+this.offsetY);
this.menuTipDirection='down'
}else{
y=this.y=Math.max(30,region.bottom+this.menuHeight+this.borderWidth+-this.offsetY);
this.menuTipDirection='up'
}
w=this.w=region.right-x;
h=this.h=region.bottom-y;
this.x+=w-width;
this.w=width;
var contentEl=this.workspace.contentEl,contentWidth=contentEl.dom.scrollLeft+contentEl.dom.clientWidth;
if(region.right>contentWidth){
this.x=contentWidth-(width+12)
}
this.showLabel();
this.showMenu();
this.showTitle()
}else{
this.hideTitle()
}
},
getName:function(){
var cmp=this.selected.length===1?this.selected[0]:null;
return cmp?cmp.constructor.NAME:'Multiple'
},
showMenu:function(){
var iw=1,mw=this.borderWidth,cx=this.x,cy=this.y,cw=this.w,mh=this.menuHeight,x=cx-iw-mw,y=cy-iw-mw-mh,w=cw+iw*2+mw*2,h=mh+mw,labelWidth=this.labelEl.getWidth(),labelX=this.labelX;
w=this.selected.length>1?w-30:w;
x=this.selected.length>1?x+30:x;
this.menuMainEdge.attr({
x:labelX+labelWidth+this.gap,
y:y,
width:w,
height:h
});
this.menuMain.attr({
x:labelX+labelWidth+this.gap,
y:y,
width:w,
height:h
});
if(this.menuTipDirection==='down'){
this.menuTipEdge.attr({
path:[
[
'M',
x+w-10,
y+h
],
[
'L',
x+w-20,
y+h+10
],
[
x+w-30,
y+h
]
]
});
this.menuTip.attr({
path:[
[
'M',
x+w-10,
y+h
],
[
'L',
x+w-20,
y+h+10
],
[
x+w-30,
y+h
]
]
})
}else{
this.menuTipEdge.attr({
path:[
[
'M',
x+w-10,
y
],
[
'L',
x+w-20,
y-10
],
[
x+w-30,
y
]
]
});
this.menuTip.attr({
path:[
[
'M',
x+w-10,
y
],
[
'L',
x+w-20,
y-10
],
[
x+w-30,
y
]
]
})
}
},
showLabel:function(){
var name=this.getName(),iw=1,mw=this.borderWidth,cx=this.x,cy=this.y,mh=this.menuHeight,x=cx-iw-4,y=cy-iw-mw-mh,h=30,items=this.selected,type,labelEl=this.labelEl,labelWidth;
if(items.length){
this.iconEl.dom.className='web-select-label-icon icon';
if(items.length>1){
this.iconEl.dom.className+=' icon-multiple-small';
x+=30
}else{
type=items[0].type;
this.iconEl.dom.className+=' icon-'+type.split('.').reverse()[0].toLowerCase()+'-small'
}
this.textEl.dom.innerHTML=name;
labelWidth=labelEl.getWidth();
x-=labelWidth+this.gap;
if(x<5){
x=5
}
this.labelX=x;
labelEl.dom.setAttribute('style','left:'+x+'px;'+'top:'+y+'px;'+'height:'+h+'px;'+'visibility:'+(this.isHidden?'hidden':'visible')+';')
}else{
labelEl.hide()
}
},
showTitle:function(){
this.menuMainEdge.show();
this.menuTipEdge.show();
this.menuMain.show();
this.menuTip.show();
this.labelEl.show();
this.itemsShown=true
},
hideTitle:function(){
if(this.itemsShown){
this.menuMainEdge.hide();
this.menuTipEdge.hide();
this.menuMain.hide();
this.menuTip.hide();
this.labelEl.hide();
this.itemsShown=false
}
},
show:function(){
this.isHidden=false;
if(this.selected.length){
this.showTitle()
}
this.workspace.multiSelectTitleSize.show();
this.workspace.multiSelectNav.show();
this.workspace.multiSelectLevel.show();
this.workspace.multiSelectDelete.show()
},
hide:function(){
this.isHidden=true;
this.hideTitle();
this.workspace.multiSelectTitleSize.hide();
this.workspace.multiSelectNav.hide();
this.workspace.multiSelectLevel.hide();
this.workspace.multiSelectDelete.hide()
}
});
web.workspace.plugins.MultiSelectTitleSize=Ext.extend(web.workspace.plugins.MultiSelectDecorator,{
initDecorator:function(){
},
initRender:function(){
var workspace=this.workspace;
workspace.multiSelectTitleSize=this;
this.width=new Ext.form.NumberField({
cls:'web-select-titlesize-field web-select-titlesize-widthfield',
renderTo:workspace.contentEl,
enableKeyEvents:true,
minValue:1,
maxValue:2000
});
this.height=new Ext.form.NumberField({
cls:'web-select-titlesize-field web-select-titlesize-heightfield',
renderTo:workspace.contentEl,
enableKeyEvents:true,
minValue:1,
maxValue:100000
});
this.container=Ext.get(Ext.DomHelper.append(workspace.contentEl,{cls:'web-select-titlesize'}));
this.widthLabel=Ext.get(Ext.DomHelper.append(this.container,{cls:'label'}));
Ext.DomHelper.append(this.container,{
cls:'label',
html:' x '
});
this.heightLabel=Ext.get(Ext.DomHelper.append(this.container,{cls:'label'}));
function stopProp(e){
e.stopPropagation()
}
this.width.el.on('click',stopProp);
this.height.el.on('click',stopProp);
this.width.el.on('mousedown',stopProp);
this.height.el.on('mousedown',stopProp);
this.width.on('keyup',this.onKeyup,this);
this.height.on('keyup',this.onKeyup,this);
function flush(){
clearTimeout(this.keyupTimer);
this.applyChange()
}
workspace.multiSelect.on('beforemultiselect',flush,this);
workspace.app.on('update',function(){
var that=this;
setTimeout(function(){
that.onUpdate()
},50)
},this);
function restore(){
flush.call(this);
this.onUpdate()
}
this.width.on('blur',restore,this);
this.height.on('blur',restore,this);
this.hideLocal()
},
hasFocus:function(){
var active=document.activeElement;
return active===this.width.el.dom||active===this.height.el.dom
},
onKeyup:function(field,e){
clearTimeout(this.keyupTimer);
var value,isWidth;
if(field.isValid()){
value=field.getValue();
isWidth=field===this.width;
this.onAdjustFields({
width:isWidth?value:null,
height:isWidth?null:value
})
}
this.nextChange={
value:value,
isWidth:isWidth
};
if(e.getKey()===13){
this.applyChange();
return
}
this.keyupTimer=setTimeout(this.applyChange.createDelegate(this),2000)
},
applyChange:function(){
var change=this.nextChange;
if(change){
var value=change.value,isWidth=change.isWidth,workspace=this.workspace,oldRegion=this.region,newRegion=workspace.copyRegion(oldRegion);
if(isNaN(value)||value<=0||!/^[0-9]+$/.test(value)){
return
}
if(isWidth){
newRegion.left=newRegion.right-value
}else{
newRegion.bottom=newRegion.top+value
}
var regions=this.getRegions(newRegion),changes={};
regions.forEach(function(region,index){
var cmp=this.selected[index];
changes[cmp.id]={bbox:workspace.getRegionBBox(region)}
},this);
changes=workspace.calcRels(changes);
workspace.app.invoker.execute(new web.commands.components.ChangeMulti({changes:changes}));
this.nextChange=null
}
},
onRefresh:function(){
this.onUpdate()
},
onAdjust:function(){
this.hideLocal()
},
onAdjustEnd:function(){
this.onUpdate()
},
onAdjustFields:function(cfg){
var region=this.region;
if(!region){
return
}
var width=(cfg||{}).width||region.right-region.left,height=(cfg||{}).height||region.bottom-region.top;
this.widthLabel.dom.innerHTML=width;
if(this.heightLabel){
this.heightLabel.dom.innerHTML=height
}
if(!cfg){
if(width!==this.width.getValue()){
this.width.setValue(width)
}
if(height!==this.height.getValue()){
this.height.setValue(height)
}
}
this.width.el.setRegion(this.widthLabel.getRegion());
this.height.el.setRegion(this.heightLabel.getRegion())
},
onUpdate:function(){
var x,y,bbox,container=this.container;
clearTimeout(this.showTimer);
if(this.selected.length){
this.showTimer=setTimeout(function(){
if(!this.isHidden){
this.showLocal()
}
bbox=this.workspace.multiSelectTitle.menuMain.getBBox();
x=bbox.x-73;
y=bbox.y;
container.dom.style.left=x+'px';
container.dom.style.top=y+'px';
if(this.canEditWidth()){
this.width.enable()
}else{
this.width.disable()
}
this.onAdjustFields()
}.createDelegate(this),50)
}else{
this.hideLocal()
}
},
canEditWidth:function(){
var result=true;
(this.selected||[]).forEach(function(item){
result=result&&!item.isStretch()
});
return result
},
show:function(){
this.isHidden=false;
this.showLocal()
},
hide:function(){
clearTimeout(this.showTimer);
this.isHidden=true;
this.hideLocal()
},
hideLocal:function(){
if(this.itemsShown){
this.container.hide();
this.width.hide();
this.height.hide();
this.itemsShown=false;
this.width.disable();
this.height.disable()
}
},
showLocal:function(){
if(this.selected.length){
this.container.show();
this.width.show();
this.height.show();
this.itemsShown=true
}
this.width.enable();
this.height.enable()
}
});
web.workspace.plugins.MultiSelectNav=Ext.extend(web.workspace.plugins.MultiSelectDecorator,{
initDecorator:function(){
this.borderWidth=4
},
initRender:function(){
this.workspace.multiSelectNav=this;
this.relativesTip='Find components close to this component';
this.relationsBtn=new Ext.Button({
renderTo:this.workspace.contentEl,
style:{
zIndex:1800,
position:'absolute'
},
hidden:true,
tooltip:this.relativesTip,
cls:'web-select-btn',
iconCls:'icon icon-web-workspace-multiselectnav-tree',
width:23,
listeners:{
click:this.onClickRelationsBtn,
scope:this
}
});
this.relativesList=new Ext.menu.Menu({
renderTo:this.workspace.contentEl,
cls:'web-workspace-multiselectnav-rellist',
hidden:true,
width:'auto',
listeners:{
hide:function(){
this.lastHoveredItem=null
},
beforehide:this.onRelativesListBeforeHide,
scope:this
},
plugins:[new web.ui.plugins.DomObserver({
click:this.onRelativeClick,
mouseover:this.onRelativeMouseOver,
scope:this
})]
})
},
onRefresh:function(){
this.onUpdate()
},
onAdjust:function(){
this.relationsBtn.hide()
},
onAdjustEnd:function(){
this.onUpdate()
},
getComponent:function(){
return this.selected.length===1?this.selected[0]:null
},
onUpdate:function(){
var x,y,bbox,component=this.getComponent(),pbtn=this.relationsBtn;
clearTimeout(this.showTimer);
if(component&&component.getParent()){
this.showTimer=setTimeout(function(){
if(!this.isHidden){
pbtn.show()
}
bbox=this.workspace.multiSelectTitle.menuMain.getBBox();
x=bbox.x+7;
y=bbox.y;
pbtn.el.dom.style.left=x+'px';
pbtn.el.dom.style.top=y+'px'
}.createDelegate(this),50)
}else{
pbtn.hide()
}
},
getNearestRelatives:function(){
var component=this.getComponent(),rels={};
if(component){
rels.parent=component.getRelInParent();
if(rels.parent instanceof web.data.components.Template){
rels.parent=null;
rels.siblings=[].concat([component])
}else{
rels.siblings=[].concat(rels.parent.getRelInItems())
}
rels.children=[].concat(component.getRelInItems());
return rels
}else{
one.debug('MultiSelectNav.js, getNearestRelatives method: this.getComponent() is undefined')
}
},
onRelativesListBeforeHide:function(){
if(Ext.EventObject.getTarget('#'+this.relationsBtn.el.id)){
return false
}
},
onClickRelationsBtn:function(){
function renderList(item,level){
var html='<ul class="level'+level+'">\n';
if(item.items&&item.items.length){
html+=renderListItems(item.items,level)
}
html+='</ul>\n';
return html
}
function renderListItems(items,level){
var html='';
(items||[]).forEach(function(item){
var iconCls='icon-'+item.component.type.split('.').slice(-1)[0].toLowerCase()+'-small',translatedComponentType=web.utils.Object.getGlobalFromObjectNotation(item.component.type).NAME;
html+='<li class="'+(item.cls||'')+'" data-cmpid="'+item.component.getId()+'">\n'+'<a href="#">\n'+'<img src="'+Ext.BLANK_IMAGE_URL+'" class="icon '+iconCls+'" />\n'+'<span>'+translatedComponentType+'</span>\n'+'</a>\n';
if(item.inner){
html+=renderList(item.inner,level+1)
}
html+='</li>\n'
});
return html
}
return function(btn,event){
event.stopEvent();
if(this.relativesList.isVisible()){
this.relativesList.suspendEvents();
this.relativesList.hide();
this.relativesList.resumeEvents();
this.lastHoveredItem=null;
return
}
var rels=this.getNearestRelatives(),current=this.getComponent(),list,commonItems={
items:rels.siblings.map(function(component){
var item={component:component};
if(component===current){
item.cls='current';
item.inner={
items:rels.children.map(function(component){
return{component:component}
})
}
}
return item
})
};
if(rels.parent){
list={
items:[{
component:rels.parent,
inner:commonItems
}]
}
}else{
list=commonItems
}
var html=renderList(list,1);
this.relativesList.update(html);
this.relativesList.el.removeClass('box-arrow-top-right');
this.relativesList.el.removeClass('box-arrow-top-left');
this.relativesList.el.removeClass('box-arrow-bottom-right');
this.relativesList.el.removeClass('box-arrow-bottom-left');
var xy=this.relationsBtn.el.getXY(),workspaceBody=this.workspace.el,renderedWidth=this.relativesList.getWidth(),renderedHeight=this.relativesList.getHeight()+11,arrowDirection=[
'left',
'top'
];
this.relativesList.showAt(xy.slice());
if(xy[0]-workspaceBody.getX()+renderedWidth>workspaceBody.dom.clientWidth){
xy[0]=this.relationsBtn.el.getX()-renderedWidth+this.relationsBtn.el.getWidth()+10;
arrowDirection[0]='right'
}else{
xy[0]-=9
}
if(xy[1]-workspaceBody.getY()+renderedHeight>workspaceBody.dom.clientHeight){
xy[1]=this.relationsBtn.el.getY()-renderedHeight;
arrowDirection[1]='bottom'
}else{
xy[1]+=this.relationsBtn.getHeight()+11
}
this.relativesList.el.setStyle('left',xy[0]-Ext.fly(this.relativesList.el.dom.offsetParent).getX()+'px');
this.relativesList.el.setStyle('top',xy[1]-Ext.fly(this.relativesList.el.dom.offsetParent).getY()+'px');
this.relativesList.el.addClass('box-arrow-'+arrowDirection[1]+'-'+arrowDirection[0])
}
}(),
onRelativeMouseOver:function(e){
var componentId,component,li=Ext.get(e.getTarget('li'));
if(li){
componentId=li.getAttribute('data-cmpid');
if(componentId){
component=this.workspace.app.dm.get(componentId)
}
if(component&&this.lastHoveredItem!==component){
var node=this.workspace.getComponentEl(component).dom;
this.workspace.hover.show();
this.workspace.hover.hoverOver(node);
this.lastHoveredItem=component
}
}
e.stopEvent()
},
onRelativeClick:function(e){
var componentId,component,li=Ext.get(e.getTarget('li'));
if(li&&!li.hasClass('current')){
componentId=li.getAttribute('data-cmpid');
var app=this.workspace.app;
if(componentId){
component=app.dm.get(componentId)
}
if(component){
if(component.getRoot().type==='web.data.components.Page'&&app.getMode()==='template'){
app.fireEvent('mode','page')
}else if(component.getRoot().type==='web.data.components.Template'&&app.getMode()==='page'){
app.fireEvent('mode','template')
}
this.select(component);
this.relativesList.hide()
}
}
e.stopEvent()
},
select:function(item){
var workspace=this.workspace,region=workspace.getComponentRegion(item),view=workspace.el,width=view.getWidth(),height=view.getHeight(),x=region.right-Math.round(width/2)-100,y=region.top-Math.round(height/2);
this.workspace.setSelected(item);
workspace.el.animate({
scroll:{
to:[
x,
y
]
}
},0.35,null,'easeOut','scroll')
},
show:function(){
this.isHidden=false;
if(this.getComponent()){
this.relationsBtn.show()
}
},
hide:function(){
clearTimeout(this.showTimer);
this.isHidden=true;
this.relationsBtn.hide()
}
});
web.workspace.plugins.MultiSelectLevel=Ext.extend(web.workspace.plugins.MultiSelectDecorator,{
initDecorator:function(){
},
initRender:function(){
this.workspace.multiSelectLevel=this;
this.depthBtn=new Ext.Button({
renderTo:this.workspace.contentEl,
style:{
zIndex:1800,
position:'absolute'
},
cls:'web-select-btn',
iconCls:'icon icon-web-buttons-move-small',
hidden:true,
tooltip:'Change depth',
listeners:{
click:this.onDepthBtnClick,
scope:this
}
});
this.moveToFrontOption=new Ext.menu.Item({
text:'Move to front',
iconCls:'icon icon-web-buttons-move-to-front-small',
listeners:{
click:this.onMoveToFront,
scope:this
}
});
this.moveForwardOption=new Ext.menu.Item({
text:'Move forward',
iconCls:'icon icon-web-buttons-move-forward-small',
listeners:{
click:this.onMoveForward,
scope:this
}
});
this.moveBackwardOption=new Ext.menu.Item({
text:'Move backward',
iconCls:'icon icon-web-buttons-move-backward-small',
listeners:{
click:this.onMoveBackward,
scope:this
}
});
this.moveToBackOption=new Ext.menu.Item({
text:'Move to back',
iconCls:'icon icon-web-buttons-move-to-back-small',
listeners:{
click:this.onMoveToBack,
scope:this
}
});
this.depthOptions=new Ext.menu.Menu({
renderTo:this.workspace.contentEl,
cls:'web-workspace-multiselectlevel',
hidden:true,
items:[
this.moveToFrontOption,
this.moveForwardOption,
this.moveBackwardOption,
this.moveToBackOption
],
listeners:{
beforehide:this.onDepthOptionsBeforeHide,
scope:this
}
})
},
onRefresh:function(){
this.onUpdate()
},
onAdjust:function(){
if(!this.depthBtn.hidden){
this.depthBtn.hide()
}
if(!this.depthOptions.hidden){
this.depthOptions.hide()
}
},
onAdjustEnd:function(){
this.onUpdate()
},
hasSelectedComponents:function(){
return Boolean(this.selected.length)
},
onUpdate:function(){
var x,y,bbox,components=this.selected;
clearTimeout(this.showTimer);
if(components.length){
var mixed=this.isMixedStretch();
if(!mixed&&this.getUnderItems(true).length){
this.moveToBackOption.enable();
this.moveBackwardOption.enable()
}else{
this.moveToBackOption.disable();
this.moveBackwardOption.disable()
}
if(!mixed&&this.getAboveItems(true).length){
this.moveToFrontOption.enable();
this.moveForwardOption.enable()
}else{
this.moveToFrontOption.disable();
this.moveForwardOption.disable()
}
this.showTimer=setTimeout(function(){
if(!this.isHidden){
this.depthBtn.show()
}
bbox=this.workspace.multiSelectTitle.menuMain.getBBox();
x=this.selected.length>1?bbox.x+8:bbox.x+38;
y=bbox.y;
this.depthBtn.el.dom.style.left=x+'px';
this.depthBtn.el.dom.style.top=y+'px'
}.createDelegate(this),50)
}else{
this.depthBtn.hide()
}
},
isMixedStretch:function(){
var stretchCount=0,components=this.selected,len=components.length;
components.forEach(function(item){
stretchCount+=item.isStretch()?1:0
});
return len>1&&stretchCount&&stretchCount!==len
},
getUnderItems:function(all){
var items=[],allItems,workspace=this.workspace,components=this.selected,doc=workspace.app.getModeDoc(),region=this.region,highest,index,stretch;
if(doc&&region){
highest=components[components.length-1];
stretch=Boolean(highest.isStretch());
allItems=doc.getAllItems();
index=allItems.indexOf(highest);
allItems.forEach(function(item){
if(stretch===Boolean(item.isStretch())&&index>allItems.indexOf(item)&&components.indexOf(item)===-1){
var outer=workspace.getComponentRegion(item);
if(doc!==item.getParent()&&!Boolean(item.isStretch())){
return
}
if(all||outer&&outer.intersect(region)){
items.push(item)
}
}
},this)
}
return items
},
getAboveItems:function(all){
var items=[],allItems,workspace=this.workspace,components=this.selected,doc=workspace.app.getModeDoc(),region=this.region,lowest,index,stretch;
if(doc&&region){
lowest=components[0];
stretch=Boolean(lowest.isStretch());
allItems=doc.getAllItems();
index=allItems.indexOf(lowest);
allItems.forEach(function(item){
if(stretch===Boolean(item.isStretch())&&index<allItems.indexOf(item)&&components.indexOf(item)===-1){
var outer=workspace.getComponentRegion(item);
if(doc!==item.getParent()&&!Boolean(item.isStretch())){
return
}
if(all||outer&&outer.intersect(region)){
items.push(item)
}
}
},this)
}
return items
},
onDepthOptionsBeforeHide:function(){
if(Ext.EventObject.getTarget('#'+this.depthBtn.el.id)){
return false
}
},
onDepthBtnClick:function(btn,event){
event.stopEvent();
if(this.depthOptions.isVisible()){
this.depthOptions.suspendEvents();
this.depthOptions.hide();
this.depthOptions.resumeEvents();
return
}
var xy=this.depthBtn.el.getXY();
this.depthOptions.el.removeClass('box-arrow-top-right');
this.depthOptions.el.removeClass('box-arrow-top-left');
this.depthOptions.el.removeClass('box-arrow-bottom-right');
this.depthOptions.el.removeClass('box-arrow-bottom-left');
this.depthOptions.showAt(xy.slice());
var workspaceBody=this.workspace.el,renderedWidth=this.depthOptions.getWidth(),renderedHeight=this.depthOptions.getHeight()+11,arrowDirection=[
'left',
'top'
];
if(xy[0]-workspaceBody.getX()+renderedWidth>workspaceBody.dom.clientWidth){
xy[0]=this.depthBtn.el.getX()-renderedWidth+this.depthBtn.el.getWidth()+7;
arrowDirection[0]='right'
}else{
xy[0]-=7
}
if(xy[1]-workspaceBody.getY()+renderedHeight>workspaceBody.dom.clientHeight){
xy[1]=this.depthBtn.el.getY()-renderedHeight;
arrowDirection[1]='bottom'
}else{
xy[1]+=this.depthBtn.getHeight()+11
}
this.depthOptions.el.setStyle('left',xy[0]-Ext.fly(this.depthOptions.el.dom.offsetParent).getX()+'px');
this.depthOptions.el.setStyle('top',xy[1]-Ext.fly(this.depthOptions.el.dom.offsetParent).getY()+'px');
this.depthOptions.el.addClass('box-arrow-'+arrowDirection[1]+'-'+arrowDirection[0])
},
onMoveToBack:function(btn,event){
event.stopEvent();
this.applyIndex(0)
},
onMoveBackward:function(btn,event){
var unders=this.getUnderItems();
event.stopEvent();
this.applyIndex(!unders.length?0:unders[unders.length-1].getIndex())
},
onMoveForward:function(btn,event){
var aboves=this.getAboveItems(),len=this.workspace.app.getModeDoc().getAllItems().pop().getIndex()+1;
event.stopEvent();
this.applyIndex(!aboves.length?len:aboves[0].getIndex()+1)
},
onMoveToFront:function(btn,event){
var len=this.workspace.app.getModeDoc().getAllItems().pop().getIndex()+1;
event.stopEvent();
this.applyIndex(len)
},
applyIndex:function(index){
var workspace=this.workspace,app=workspace.app,selected=this.selected,changes={},counterForSelected=index,counterForRest=index+selected.length,doc=app.getModeDoc(),items=doc.getAllItems(),tempItems=items.map(function(item){
return{
index:item.getIndex(),
item:item,
oldIndex:item.getIndex()
}
});
tempItems.forEach(function(tItem){
if(selected.indexOf(tItem.item)>-1){
tItem.index=counterForSelected;
counterForSelected++
}else if(tItem.oldIndex>=index){
tItem.index=counterForRest;
counterForRest++
}
},this);
tempItems.sort(function(a,b){
return a.index-b.index
});
tempItems.forEach(function(tItem,currentIndex){
tItem.index=currentIndex;
if(tItem.oldIndex!==tItem.index){
changes[tItem.item.id]={
index:tItem.index,
oldIndex:tItem.oldIndex
}
}
});
changes=workspace.calcRels(changes);
app.invoker.execute(new web.commands.components.ChangeMulti({changes:changes}))
},
show:function(){
this.isHidden=false;
if(this.hasSelectedComponents()){
this.depthBtn.show()
}
},
hide:function(){
clearTimeout(this.showTimer);
this.isHidden=true;
this.depthBtn.hide()
}
});
web.workspace.plugins.MultiSelectDelete=Ext.extend(web.workspace.plugins.MultiSelectDecorator,{
initDecorator:function(){
this.borderWidth=4
},
initRender:function(){
var deleteToolTip='Delete';
deleteToolTip+=Ext.isMac?' ('+'Backspace'+')':' ('+'Del'+')';
this.workspace.multiSelectDelete=this;
this.button=new Ext.Button({
renderTo:this.workspace.contentEl,
style:{
zIndex:2000,
position:'absolute'
},
tooltip:deleteToolTip,
cls:'web-select-btn',
iconCls:'icon icon-web-buttons-delete-small',
listeners:{
click:this.onDelete,
scope:this
}
});
this.disable()
},
onRefresh:function(){
this.onUpdate()
},
onAdjust:function(){
this.button.hide()
},
onAdjustEnd:function(){
this.onUpdate()
},
onUpdate:function(){
var x,y,bbox,btn=this.button;
clearTimeout(this.showTimer);
if(this.selected.length){
this.showTimer=setTimeout(function(){
if(!this.isHidden){
this.enable()
}
bbox=this.workspace.multiSelectTitle.menuMain.getBBox();
x=this.selected.length>1?bbox.x+41:bbox.x+71;
y=bbox.y;
btn.el.dom.style.left=x+'px';
btn.el.dom.style.top=y+'px'
}.createDelegate(this),50)
}else{
this.disable()
}
},
onDelete:function(btn,event){
event.stopEvent();
if(!this.selected.length){
one.fatal('Delete button pressed without selection.');
return
}
this.deleteComponents()
},
deleteComponents:function(components){
components=components||this.selected;
var newComponents=[],app=this.workspace.app;
components.forEach(function(component){
var parent=component.getParent();
if(!parent){
var page=app.getSelected('page'),template=app.getSelected('template');
if(page&&template){
if(page.items.indexOf(component)>=0){
component.setParent(page)
}else if(template.items.indexOf(component)>=0){
component.setParent(template)
}
}
}
if(component.getParent()){
newComponents.push(component)
}
});
components=newComponents;
if(!components.length){
return
}
var changes={};
components.forEach(function(component){
changes[component.id]={remove:true}
},this);
changes=this.workspace.calcRels(changes);
this.workspace.app.invoker.execute(new web.commands.components.ChangeMulti({
changes:changes,
components:components
}))
},
show:function(){
this.isHidden=false;
this.enable()
},
hide:function(){
clearTimeout(this.showTimer);
this.isHidden=true;
this.disable()
},
disable:function(){
this.button.hide();
this.button.disable()
},
enable:function(){
if(this.selected.length){
this.button.show()
}
this.button.enable()
}
});
web.workspace.plugins.MultiSelectSize=Ext.extend(web.workspace.plugins.MultiSelectDecorator,{
initDecorator:function(){
this.workspace.multiSelectSize=this
},
onRefresh:function(){
this.hide()
},
onAdjust:function(region,changes,options){
if(options&&options.resize){
this.show(region,changes)
}
},
onAdjustEnd:function(){
this.hide()
},
show:function(region,changes){
var top,right,bottom,left,x,y,workspace=this.workspace,dims=[];
function getFluxParent(item){
var change=changes[item.id];
return change&&change.relIn?lowest.dm.get(change.relIn.id):item.getRelInParent()
}
if(region){
top=region.top;
right=region.right;
bottom=region.bottom;
left=region.left;
x=Math.round((left+right)/2);
y=Math.round((top+bottom)/2);
dims.push({
x:x,
y:y,
value:right-left+' x '+(bottom-top)
});
var selected=this.selected,lowest=selected[0],parent,outer;
var baseItems=[];
if(changes&&lowest){
selected.forEach(function(item){
var parent=getFluxParent(item);
if(selected.indexOf(parent)===-1){
baseItems.push(item)
}
})
}
if(changes&&lowest&&baseItems.length===1){
parent=getFluxParent(lowest);
outer=workspace.copyRegion(workspace.getComponentInnerRegion(parent))
}
if(outer){
lowest.getTemplate().getAllItems().forEach(function(item){
if(this.selected.indexOf(item)===-1){
var sibParent=getFluxParent(item),sibr;
if(sibParent===parent){
sibr=workspace.getComponentRegion(item);
if(!sibr){
return
}
if(sibr.left<x&&x<sibr.right){
if(sibr.top<y){
outer.top=Math.max(outer.top,sibr.bottom)
}
if(sibr.bottom>y){
outer.bottom=Math.min(outer.bottom,sibr.top)
}
}
if(sibr.top<y&&y<sibr.bottom){
if(sibr.left<x){
outer.left=Math.max(outer.left,sibr.right)
}
if(sibr.right>x){
outer.right=Math.min(outer.right,sibr.left)
}
}
}
}
},this);
var dt=region.top-outer.top,dr=outer.right-region.right,db=outer.bottom-region.bottom,dl=region.left-outer.left,tx=70,ty=30,cx,cy;
if(dt>=0){
cy=region.top-Math.round(dt/2);
cy=Math.min(cy,y-ty);
dims.push({
x:x,
y:cy,
value:dt
})
}
if(dr>=0){
cx=region.right+Math.round(dr/2);
cx=Math.max(cx,x+tx);
dims.push({
x:cx,
y:y,
value:dr
})
}
if(db>=0){
cy=region.bottom+Math.round(db/2);
cy=Math.max(cy,y+ty);
dims.push({
x:x,
y:cy,
value:db
})
}
if(dl>=0){
cx=region.left-Math.round(dl/2);
cx=Math.min(cx,x-tx);
dims.push({
x:cx,
y:y,
value:dl
})
}
}
this.workspace.dims.show(dims)
}
},
hide:function(){
this.workspace.dims.hide()
}
});
web.workspace.plugins.MultiSelectEdit=Ext.extend(web.workspace.plugins.MultiSelectDecorator,{
initDecorator:function(){
this.workspace.multiSelectEdit=this
},
initRender:function(){
var workspace=this.workspace;
this.textEl=Ext.get(Ext.DomHelper.append(workspace.contentEl,{
cls:'web-select-label-edit',
html:'<i></i><span>'+'Click to edit'+'</span>'
}))
},
onRefresh:function(){
this.onUpdate()
},
onAdjust:function(){
if(this.visible){
this.textEl.hide();
this.visible=false
}
},
onAdjustEnd:function(region){
this.onUpdate(region)
},
isEdit:function(){
var selected=this.selected;
return selected.length===1&&selected[0].getType().match(/(Gallery|Image|ImageSlider|Text|Table|ContactForm)$/)
},
onUpdate:function(region){
region=region||this.region;
var x,y,w,h;
if(this.isEdit()&&this.isFocus()&&region){
x=this.x=region.left;
y=this.y=region.top;
w=this.w=region.right-x;
h=this.h=region.bottom-y;
this.showText()
}else{
this.textEl.hide();
this.textEl.hidden=true
}
},
showText:function(){
var x=this.x,y=this.y,w=this.w,h=this.h,textEl=this.textEl;
if(this.selected.length===1){
this.visible=true;
if(w>=300){
textEl.removeClass('selected-component-width-less-than-300')
}else{
textEl.addClass('selected-component-width-less-than-300')
}
x+=Math.round((w-textEl.getWidth())/2);
y+=Math.round((h-textEl.getHeight())/2);
textEl.dom.setAttribute('style','left:'+x+'px;'+'top:'+y+'px;'+'visibility:'+(this.isHidden?'hidden':'visible')+';')
}else{
textEl.hide();
this.textEl.hidden=true
}
},
show:function(){
this.showText()
},
hide:function(){
this.visible=false;
this.textEl.hide()
}
});
web.workspace.plugins.MultiSelectKeys=Ext.extend(web.workspace.plugins.MultiSelectDecorator,{
type:'web.workspace.plugins.MultiSelectKeys',
initDecorator:function(){
this.dx=0;
this.dy=0;
this.deleteKey=new Ext.KeyMap(document,{
key:46,
fn:this.onDelete,
scope:this
});
if(Ext.isMac){
this.backspaceKey=new Ext.KeyMap(document,{
key:8,
fn:this.onDelete,
scope:this
})
}
this.arrowKeys=new Ext.KeyMap(document,{
key:[
37,
38,
39,
40
],
fn:this.onArrow,
scope:this
})
},
onAdjust:function(){
this.adjusting=true
},
onAdjustEnd:function(region){
this.adjusting=false
},
onDelete:function(key,event){
if(this.isFocus()&&!this.adjusting){
event.stopEvent();
this.workspace.multiSelectDelete.deleteComponents()
}
},
getMoveChanges:function(){
var changes={};
if(!this.oldBBoxs){
this.oldBBoxs={};
this.selected.forEach(function(item){
this.oldBBoxs[item.id]=item.getBBox()
},this)
}
this.selected.forEach(function(item){
var bbox=this.oldBBoxs[item.id];
if(!bbox){
return
}
changes[item.id]={
bbox:{
top:bbox.top+this.dy,
right:bbox.right+this.dx,
bottom:bbox.bottom+this.dy,
left:bbox.left+this.dx
}
}
},this);
return this.workspace.calcRels(changes)
},
onArrow:function(key,event){
var workspace=this.workspace;
if(this.isFocus()&&(!this.adjusting||this.keyAdjusting)){
event.stopEvent();
var now=new Date().getTime();
if(this.lastTime&&now-this.lastTime<100){
return
}
this.dx+=key===37?-1:key===39?1:0;
this.dy+=key===38?-1:key===40?1:0;
this.oldRegion=this.oldRegion||workspace.copyRegion(this.region);
var dx=this.dx,dy=this.dy,region=workspace.copyRegion(this.oldRegion,dy,dx,dy,dx),changes=this.getMoveChanges();
this.selected.forEach(function(cmp,index){
var el=workspace.getComponentEl(cmp),region=(changes[cmp.id]||{}).bbox||cmp.getBBox();
if(el){
el.dom.style.left=region.left+'px';
el.dom.style.top=region.top+'px'
}
},this);
this.lastTime=now;
this.keyAdjusting=true;
this.adjust(region,changes,{resize:true});
clearTimeout(this.onArrowTimer);
this.onArrowTimer=setTimeout(function(){
var changes=this.getMoveChanges();
if(this.dx||this.dy){
workspace.app.invoker.execute(new web.commands.components.ChangeMulti({changes:changes}))
}
this.dx=0;
this.dy=0;
this.oldRegion=null;
this.oldBBoxs=null;
this.adjustEnd(region,changes);
this.keyAdjusting=false
}.createDelegate(this),1000)
}
}
});
web.workspace.plugins.MultiSelectWrap=Ext.extend(web.workspace.plugins.MultiSelectDecorator,{
initDecorator:function(){
this.borderWidth=4
},
initRender:function(){
this.workspace.multiSelectWrap=this;
this.wrapTip='Wrap text';
this.unwrapTip='Unwrap text';
this.button=new Ext.Button({
renderTo:this.workspace.contentEl,
style:{
zIndex:2000,
position:'absolute'
},
tooltip:this.wrapTip,
cls:'web-select-btn web-select-btn-wrap',
iconCls:'icon icon-web-buttons-wrap-small',
listeners:{
click:this.onToggle,
scope:this
}
});
this.disable()
},
onRefresh:function(){
this.onUpdate()
},
onRedraw:function(){
this.onUpdate()
},
onAdjust:function(){
this.button.hide()
},
onAdjustEnd:function(){
this.onUpdate()
},
onUpdate:function(){
var x,y,region,wrap,btn=this.button,item=this.getItem()||null;
clearTimeout(this.showTimer);
if(this.isOn()){
this.showTimer=setTimeout(function(){
var tooltipText,quickTip;
if(!this.isHidden){
this.enable()
}
region=this.region;
x=Math.max(region.right-32,region.left+8);
y=Math.max(region.bottom-32,region.top+8);
btn.el.dom.style.left=x+'px';
btn.el.dom.style.top=y+'px';
wrap=this.isWrap();
btn.setIconClass('icon icon-web-buttons-'+(wrap?'un':'')+'wrap-small');
tooltipText=wrap?this.unwrapTip:this.wrapTip;
btn.setTooltip(tooltipText);
quickTip=Ext.QuickTips.getQuickTip();
if(quickTip.isVisible()){
quickTip.hide();
Ext.get(quickTip.el.query('.x-tip-body')).update(tooltipText);
quickTip.show()
}
}.createDelegate(this),50)
}else{
this.disable();
if(item){
if(item.isWrap()){
this.wrapComponents([item],true)
}
}
}
},
onToggle:function(btn,event){
event.stopEvent();
if(!this.isOn()){
one.fatal('Wrap button pressed without appropriate selection.');
return
}
this.wrapComponents([this.getItem()],this.isWrap())
},
wrapComponents:function(components,unwrap){
components=components||this.selected;
var changes={};
components.forEach(function(component){
changes[component.id]={wrap:!unwrap}
},this);
changes=this.workspace.calcRels(changes);
this.workspace.app.invoker.execute(new web.commands.components.ChangeMulti({changes:changes}));
this.workspace.multiSelect.select(this.selected)
},
getItem:function(){
var selected=this.selected;
return selected.length===1?selected[0]:null
},
isOn:function(){
var item=this.getItem();
return item&&item.getRelInParent()instanceof web.data.components.Text
},
isWrap:function(){
var item=this.getItem();
return item&&this.isOn()&&item.isWrap()
},
show:function(){
this.isHidden=false;
this.enable()
},
hide:function(){
clearTimeout(this.showTimer);
this.isHidden=true;
this.disable()
},
disable:function(){
this.button.hide();
this.button.disable()
},
enable:function(){
if(this.selected.length){
this.button.show()
}
this.button.enable()
}
});
web.workspace.plugins.MultiSelectStretch=Ext.extend(web.workspace.plugins.MultiSelectDecorator,{
initDecorator:function(){
this.borderWidth=4
},
initRender:function(){
this.workspace.multiSelectStretch=this;
this.stretchText='Stretch';
this.unstretchText='Unstretch';
this.button=new Ext.Button({
renderTo:this.workspace.contentEl,
style:{
zIndex:2000,
position:'absolute'
},
cls:'web-select-btn web-select-btn-stretch translucent',
iconCls:'icon icon-web-buttons-stretch-small',
listeners:{
click:this.onToggle,
scope:this
}
});
this.disable()
},
onRefresh:function(){
this.onUpdate()
},
onRedraw:function(){
this.onUpdate()
},
onAdjust:function(){
this.button.hide()
},
onAdjustEnd:function(){
this.onUpdate()
},
onUpdate:function(){
var x,y,region,stretched,btn=this.button;
clearTimeout(this.showTimer);
if(this.isOn()){
this.showTimer=setTimeout(function(){
if(!this.isHidden){
this.enable()
}
region=this.region;
x=Math.max(region.right-69,region.left+8);
y=region.top+8;
btn.el.dom.style.left=x+'px';
btn.el.dom.style.top=y+'px';
stretched=this.isStretch();
btn.setIconClass('icon icon-web-buttons-'+(stretched?'un':'')+'stretch-small');
var tooltipText=stretched?this.unstretchText:this.stretchText;
btn.setTooltip(tooltipText);
var quickTip=Ext.QuickTips.getQuickTip();
if(quickTip.isVisible()){
quickTip.hide();
Ext.get(quickTip.el.query('.x-tip-body')).update(tooltipText)
}
}.createDelegate(this),50)
}else{
this.disable()
}
},
onToggle:function(btn,event){
event.stopEvent();
this.stretchComponents([this.getItem()],this.isStretch())
},
stretchComponents:function(components,state){
components=components||this.selected;
var changes={},template=this.workspace.app.getSelected('template'),tWidth=template.getWidth();
components.forEach(function(component){
var bbox=component.getBBox(),change={stretch:!state};
change.index=0;
change.bbox={
top:bbox.top,
right:tWidth,
bottom:bbox.bottom,
left:0
};
changes[component.id]=change
},this);
changes=this.workspace.calcRels(changes);
this.workspace.app.invoker.execute(new web.commands.components.ChangeMulti({changes:changes}))
},
getItem:function(){
var selected=this.selected;
return selected.length===1?selected[0]:null
},
isOn:function(){
var item=this.getItem();
return item&&item.isStretchy()
},
isStretch:function(){
var item=this.getItem();
return item&&item.isStretch()
},
show:function(){
this.isHidden=false;
this.enable()
},
hide:function(){
clearTimeout(this.showTimer);
this.isHidden=true;
this.disable()
},
disable:function(){
this.button.hide();
this.button.disable()
},
enable:function(){
if(this.selected.length){
this.button.show()
}
this.button.enable()
}
});
web.workspace.plugins.BoxSelect=Ext.extend(Ext.util.Observable,{
init:function(workspace){
this.workspace=workspace;
this.overlay=workspace.overlay;
workspace.boxSelect=this;
this.addEvents('adjust','select');
this.startPoint=null;
this.region=null;
workspace.on('render',function(){
this.initRender();
this.initListeners()
},this)
},
initRender:function(){
this.box=this.overlay.paper.rect(0,0,0,0).attr({
fill:'rgba(255, 255, 255, 0.5)',
stroke:'rgba(63, 63, 63, 0.5)',
'stroke-width':1
}).hide()
},
initListeners:function(){
var workspace=this.workspace,el=workspace.el;
function onStop(e){
var that=this;
if(this.region){
if(this.active){
this.fireEvent('adjust',this.region,{extEvent:e});
this.fireEvent('select',this.region,{extEvent:e});
workspace.hover.show()
}
this.startPoint=null;
this.region=null;
this.hide()
}
setTimeout(function(){
that.active=false
},50)
}
el.on('mousedown',function(e,t){
var tel=Ext.get(t),cmp=workspace.getElComponent(tel),mode=workspace.app.getMode(),cmpMode=cmp&&cmp.inPage()?'page':'template';
if(!workspace.isActive()&&!tel.parent('.one-rte')&&(!cmp||!cmp.getParent()||mode!==cmpMode)&&!tel.parent('.handle')&&!tel.hasClass('handle')&&!e.getTarget('.multi-select-action-menu')&&(e.browserEvent.which!==3&&e.browserEvent.button!==2)){
this.startTime=new Date().getTime();
this.startPoint=workspace.getPoint(e);
if(Ext.get(e.target).hasClass('web-workspace')&&e.target.getBoundingClientRect().right-e.getPageX()<17||e.getTarget('.web-button')||e.getTarget('.x-menu-list')){
this.startPoint=null
}
this.region=workspace.copyRegion(this.startPoint)
}
},this);
el.on('mousemove',function(e,t){
var threshhold=5,start=this.startPoint,end,isStarted;
if(start){
var cmp=workspace.getElComponent(t);
isStarted=!cmp||!cmp.getParent()||new Date().getTime()-this.startTime>350
}
if(isStarted){
end=workspace.getPoint(e);
if(this.active||!workspace.isActive()&&Math.pow(start.left+end.left,2)+Math.pow(start.top+end.top,2)>Math.pow(threshhold,2)){
if(!this.active){
workspace.hover.hide();
if(workspace.selectFrame){
workspace.selectFrame.hide()
}
}
this.active=true;
this.region=Ext.apply(this.region,{
top:Math.min(start.top,end.top),
right:Math.max(start.right,end.right),
bottom:Math.max(start.bottom,end.bottom),
left:Math.min(start.left,end.left)
});
this.fireEvent('adjust',this.region,{extEvent:e})
}
}
this.show()
},this);
workspace.on('componentover',onStop,this);
web.ui.onMouseup(onStop,this)
},
show:function(){
var region=this.region;
if(region){
this.box.attr({
x:region.left+0.5,
y:region.top+0.5,
width:Math.max(region.right-region.left-1,1),
height:Math.max(region.bottom-region.top-1,1)
}).show()
}else{
this.hide()
}
},
hide:function(){
this.box.hide()
}
});
web.workspace.plugins.WidgetOverlay=function(){
this.overlayEl=null;
this.overlayTpl=Ext.DomHelper.createTemplate({
tag:'div',
cls:'web-workspace-widgetOverlay',
html:'<div class="web-workspace-widgetOverlay-bg"></div>'+'<div class="web-workspace-widgetOverlay-textwrap">'+'<div class="web-workspace-widgetOverlay-text">'+'Preview Only'+'</div>'+'</div>',
'ext:qtip':'To interact with this component, click \'Preview\' or \'Publish\' at the top.'
});
this.overlayTpl.compile()
};
web.workspace.plugins.WidgetOverlay.prototype={
init:function(workspace){
this.workspace=workspace;
workspace.on('render',function(cmp){
cmp.mon(cmp.getEl(),'mouseover',this.onEnter,this);
cmp.mon(cmp.getEl(),'mouseout',this.onLeave,this);
workspace.on('componentover',function(drop){
this.onMove(drop.getRegion())
},this);
cmp.mon(cmp.getEl(),'mousemove',this.onMouseMove,this)
},this)
},
onEnter:function(e){
var workspace=this.workspace,overlayEl=this.overlayEl,target=e.getTarget('.web-widget',workspace.el,true),cmp,dataId,region;
if(target){
this.component=cmp=workspace.getElComponent(target);
dataId=cmp.getId();
region=workspace.getComponentEl(cmp).getRegion();
if(!overlayEl){
this.overlayEl=overlayEl=this.overlayTpl.append(workspace.contentEl,region,true)
}
overlayEl.setRegion(region);
overlayEl.set({'data-id':dataId});
this.isShown=true
}
},
onLeave:function(e){
var overlayEl=this.overlayEl,xy=e.getXY(),region={
top:xy[1],
right:xy[0],
bottom:xy[1],
left:xy[0]
};
if(overlayEl&&!overlayEl.getRegion().contains(region)){
this.hideOverlay()
}
},
onMove:function(region){
var workspace=this.workspace,overlayEl=this.overlayEl;
if(overlayEl&&this.isShown&&workspace.isActive()){
region=workspace.multiSelect.selected.length===1?workspace.unadjustRegion(region):workspace.getComponentEl(this.component).getRegion();
overlayEl.setRegion(region)
}
},
onMouseMove:function(e){
if(this.isShown&&this.workspace.multiSelectResize.active){
this.hideOverlay()
}
},
hideOverlay:function(){
this.overlayEl.setXY([
-9999,
-9999
]);
this.isShown=false
}
};
Ext.ns('web.dd');
web.dd.WorkspaceDrag=function(config){
this.app=config.app;
this.panel=config.panel;
this.proxy=new Ext.dd.StatusProxy({
dropAllowed:this.dropAllowed,
dropNotAllowed:this.dropNotAllowed
})
};
web.dd.WorkspaceDrag.prototype={
ddGroup:'components',
dropAllowed:'web-dd-ok',
dropNotAllowed:'web-dd-nodrop',
scroll:false,
isUnderneath:false,
xyCache:[],
getDragData:function(e){
var target=e.getTarget(),dragData=null,hasClass,component,parent,app=this.app,workspace=app.workspace,multi=workspace.multiSelect,components=multi.selected,point=workspace.getPoint(e),region,el;
if(e.getTarget('.web-move-title')){
workspace.select.deactivate()
}
if(workspace.isActive()){
return
}
hasClass=Ext.get(target).hasClass('handle');
component=workspace.getElComponent(target);
parent=component?component.getParent():null;
if(!hasClass&&parent===app.getModeDoc()&&multi.selected.length<=1){
region=workspace.getComponentRegion(component);
el=workspace.getComponentEl(component);
dragData={
instaDrag:true,
components:[component],
region:region,
regions:[region]
}
}else if(hasClass&&components.length){
region=multi.region;
el=workspace.getComponentEl(components[0]);
dragData={
components:components,
region:region,
regions:[]
};
dragData.components.forEach(function(item){
dragData.regions.push(workspace.getComponentRegion(item))
},this)
}
if(el){
dragData.ddel=el.dom;
dragData.pos={
left:el.getLeft(true),
top:el.getTop(true)
}
}else{
return false
}
if(region){
dragData.offsetX=point.left-region.left;
dragData.offsetY=point.top-region.top
}
this.dragData=dragData;
return dragData
},
onDrag:function(e){
var app=this.app,dragData=this.dragData,region=dragData.region,xy=e.getXY(),points=[],isInCache;
if(!app.actionTips.isAlreadySeen('actionTip-jigglingMouseWhileResize')){
isInCache=this.xyCache.some(function(cacheXY){
return cacheXY[0]===xy[0]&&cacheXY[1]===xy[1]
});
if(!isInCache){
this.xyCache.unshift([
xy[0],
xy[1]
]);
this.xyCache.length=50
}else{
points=this.xyCache.filter(function(cacheXY){
return Math.abs(cacheXY[0]-xy[0])<10&&Math.abs(cacheXY[1]-xy[1])<10
})
}
if(points.length>15){
app.actionTips.pushMessage('actionTip-jigglingMouseWhileDrag')
}
}
if(!region){
return
}
var width=region.right-region.left,height=region.bottom-region.top;
this.app.proxy.show({
x:xy[0]-dragData.offsetX,
y:xy[1]-dragData.offsetY,
width:width,
height:height,
valid:e.getTarget('.web-workspace-content')
});
app.actionTips.pushMessage('actionTip-moveOrResizeFirstComp')
},
onMouseDown:function(e){
var app=this.app,workspace=app.workspace,dragData=this.dragData,region=workspace.unadjustRegion(dragData.region),cfg,components=workspace.overlapDecos.getOverlaps(e),sRegion=dragData.region;
if(!region){
return
}
cfg={
x:region.left,
y:region.right,
width:region.right-region.left,
height:region.bottom-region.top,
valid:e.getTarget('.web-workspace-content')
};
app.proxy.show(cfg);
this.isUnderneath=components.some(function(component,index,arr){
var partRegion;
if(index<arr.length){
partRegion=workspace.getComponentRegion(arr[index]);
return sRegion.contains(partRegion)||partRegion.contains(sRegion)
}
});
app.fireEvent('dragstart','workspace')
},
onMouseUp:function(x,y){
var app=this.app;
setTimeout(function(){
app.workspace.dragging=false;
this.xyCache=[]
},50);
app.fireEvent('dragend');
app.proxy.hide()
},
onInvalidDrop:function(){
var workspace=this.app.workspace,dragData=this.dragData;
this.supr().onInvalidDrop.call(this,arguments);
dragData.components.forEach(function(cmp,index){
var el=workspace.getComponentEl(cmp),region=cmp.getBBox();
if(el){
el.dom.style.left=region.left+'px';
el.dom.style.top=region.top+'px'
}
},this);
setTimeout(function(){
workspace.multiSelect.select(dragData.components);
workspace.multiSelectSnapTo.hideDecos()
},50)
}
};
web.dd.WorkspaceDrop=function(config){
this.app=config.app;
this.panel=config.panel
};
web.dd.WorkspaceDrop.prototype={
ddGroup:'components',
getTargetFromEvent:function(e){
var target=e.getTarget('[data-id]'),dropData={
dropEl:null,
component:null
},component;
if(target){
component=this.app.workspace.getElComponent(target)||this.app.getSelected(this.app.inPageMode()?'page':'template');
if(component){
dropData={
dropEl:target,
component:component
}
}
}
return dropData
},
onNodeOver:function(dropData,drag,e,dragData){
var app=this.app,workspace=app.workspace,drop=workspace.dropper.getDrop(dragData,e);
if(dragData.instaDrag&&workspace.multiSelect.selected[0]!==dragData.components[0]){
workspace.multiSelect.select(dragData.components)
}
app.proxy.setValid(drop.isValid());
workspace.dragging=true;
drop.distance=workspace.getMouseSpeed();
drop.getRegion();
workspace.fireEvent('componentover',drop);
workspace.hover.hide();
dragData.components.forEach(function(cmp,index){
var el=workspace.getComponentEl(cmp),region=drop.position.bboxs[index];
if(el){
el.dom.style.left=region.left+'px';
el.dom.style.top=region.top+'px'
}
},this);
this.drop=drop;
return drop&&drop.isValid()?drag.dropAllowed||this.dropAllowed:drag.dropNotAllowed||this.dropNotAllowed
},
onNodeDrop:function(dropData,drag,e,dragData){
var app=this.app,workspace=app.workspace,drop=this.drop,result,invalidSelection=false,showWarning=function(cmpType){
var win=this.app.windows.create({type:'web.windows.WarningMessage'});
if(cmpType==='web.data.components.WebShop'){
win.setTitle('Webshop cannot be placed on a template');
win.setMessage('You cannot place your webshop on the template. Please add it to a page instead.');
win.show()
}else{
win.setTitle('Contact form cannot be placed on a template');
win.setMessage('You cannot place your contact form on the template. Please add it to a page instead.');
win.show()
}
}.bind(this);
app.proxy.hide();
this.distance=null;
if(app.getMode()==='template'){
dragData.components.forEach(function(cmp){
if(cmp.isSingle()){
showWarning(cmp.type);
invalidSelection=true;
return
}
})
}
if(invalidSelection){
setTimeout(function(){
workspace.multiSelect.select([])
},100);
return false
}
workspace.fireEvent('dropcomponent',drop);
result=drop&&drop.execute(dragData);
setTimeout(function(){
workspace.dragging=false;
workspace.hover.show();
if(result&&dragData.isNewComponent){
workspace.multiSelect.select(dragData.components)
}
},50);
return result
}
};
web.workspace.plugins.DragDrop=function(){
this.ddm=Ext.dd.DDM
};
web.workspace.plugins.DragDrop.prototype={
init:function(workspace){
var cfg={
app:workspace.app,
panel:workspace
};
this.panel=workspace;
Ext.EventManager.un(document,'mousemove',this.ddm.handleMouseMove,this.ddm);
this.ddm.handleMouseMove=function(e){
var diffX,diffY;
if(!this.dragCurrent){
return true
}
if(!this.dragThreshMet){
diffX=Math.abs(this.startX-e.getPageX());
diffY=Math.abs(this.startY-e.getPageY());
if(diffX>this.clickPixelThresh||diffY>this.clickPixelThresh){
this.startDrag(this.startX,this.startY)
}
}
if(this.dragThreshMet){
this.dragCurrent.b4Drag(e);
this.dragCurrent.onDrag(e);
if(!this.dragCurrent.moveOnly){
this.fireEvents(e,false)
}
}
return true
};
Ext.EventManager.on(document,'mousemove',this.ddm.handleMouseMove,this.ddm,true);
this.drag=new web.dd.WorkspaceDrag(cfg);
this.drop=new web.dd.WorkspaceDrop(cfg);
this.panel.addEvents('componentover','dropcomponent','imageloaded');
this.initListeners()
},
initListeners:function(){
var panel=this.panel;
panel.mon(panel,'render',function(){
this.initDragDrop()
},this)
},
initDragDrop:function(){
var panel=this.panel;
panel.dragZone=new Ext.dd.DragZone(panel.el,this.drag);
panel.dropZone=new Ext.dd.DropZone(panel.el,this.drop)
}
};
web.workspace.plugins.DragDropDeco=Ext.extend(Ext.util.Observable,{
init:function(workspace){
this.workspace=workspace;
this.overlay=workspace.overlay;
this.animTime=350;
workspace.on('render',function(){
this.onRender();
this.initListeners()
},this)
},
onRender:function(){
var cssGhost='rgba(112,135,146,0.7)',cssDark='#20343E',destAttr={
fill:cssGhost,
stroke:cssDark,
'stroke-width':1
},paper=this.overlay.paper;
this.destination=paper.path().attr(destAttr).hide();
this.decos=[]
},
initListeners:function(){
var workspace=this.workspace,timeout=null,hideHandler=function(scope){
return function(){
scope.hide.apply(scope,arguments)
}
}(this);
workspace.mon(workspace,'componentover',this.onOver,this);
workspace.mon(workspace,'dropcomponent',this.hide,this);
workspace.mon(workspace,'dragend',this.hide,this);
workspace.mon(workspace.el,'mouseleave',function(){
clearTimeout(timeout);
timeout=setTimeout(hideHandler,150)
},this);
workspace.mon(workspace.el,'scroll',this.onScroll,this)
},
onScroll:function(){
clearTimeout(this.overTimer);
this.scrolling=true;
this.hideDragDrop()
},
onOver:function(drop){
if(this.scrolling&&this.isShown){
clearTimeout(this.overTimer);
this.overTimer=setTimeout(function(scope,drop){
return function(){
scope.show(drop);
scope.scrolling=false
}
}(this,drop),50)
}else{
this.show(drop)
}
},
show:function(drop){
var path;
if(drop){
drop.setOffset(0.5);
if(drop.isValid()){
path=drop.getInsertPath()
}
}
if(path&&drop.isNew){
this.workspace.hover.hide();
this.destination.attr({path:path}).show();
this.isShown=true;
this.destinationShown=true
}else{
this.destination.hide();
this.destinationShown=false
}
},
showDims:function(drop){
var pos=drop.position,r=pos?pos.region:drop.region,o=pos?pos.wRegion||pos.baseRegion||pos.destRegion:null,v,id=drop.component.id,dims=[];
this.workspace.dims.hide();
if(r){
var w=r.right-r.left,h=r.bottom-r.top,cx=Math.round((r.left+r.right)/2),cy=Math.round((r.top+r.bottom)/2);
dims.push({
id:id,
x:cx,
y:cy,
value:w+' x '+h
});
if(o&&!pos.toEdge){
v=r.top-o.top;
dims.push({
id:id+'-top',
x:cx,
y:Math.round((o.top+r.top)/2),
value:v,
show:v>0
});
v=o.bottom-r.bottom;
dims.push({
id:id+'-bottom',
x:cx,
y:Math.round((o.bottom+r.bottom)/2),
value:v,
show:v>0
});
v=r.left-o.left;
dims.push({
id:id+'-left',
x:Math.round((o.left+r.left)/2),
y:cy,
value:v,
show:v>0
});
v=o.right-r.right;
dims.push({
id:id+'-right',
x:Math.round((o.right+r.right)/2),
y:cy,
value:v,
show:v>0
})
}
this.workspace.dims.show(dims)
}
},
hide:function(){
if(this.isShown){
clearTimeout(this.showTimer);
this.showTimer=setTimeout(function(){
this.workspace.hover.show()
}.createDelegate(this),250);
this.hideDragDrop();
this.isShown=false
}
},
hideDragDrop:function(){
if(this.destination){
this.destination.hide();
this.workspace.dims.hide();
this.workspace.multiSelectSnapTo.hide()
}
}
});
web.workspace.plugins.EdgeHandle=Ext.extend(Object,{
init:function(workspace){
this.workspace=workspace;
workspace.resizeHandle=this;
workspace.on('render',function(){
var that=this;
window.setTimeout(function(){
that.onRender();
that.initListeners()
},0)
},this)
},
onRender:function(){
this.el=Ext.get(Ext.DomHelper.append(this.workspace.contentEl,{cls:'web-edges'}));
this.draw()
},
initListeners:function(){
var workspace=this.workspace;
workspace.on('reflow',function(part,el,config){
if(config&&config.isResize){
return
}
this.draw(part)
},this);
workspace.app.on('mode',function(){
this.draw()
},this);
workspace.el.on('mousemove',function(ev){
var point=workspace.getPoint(ev),region=workspace.copyRegion(workspace.multiSelect.region,-24,-12,24,12);
if(region&&region.contains(point)){
this.hide()
}else{
this.show()
}
},this);
this.isHidden=false;
workspace.on('componentover',this.hide,this);
workspace.on('dropcomponent',this.show,this);
workspace.on('dragend',this.show,this)
},
show:function(){
if(this.isHidden){
this.el.show();
this.isHidden=false
}
},
hide:function(){
if(!this.isHidden){
this.el.hide();
this.isHidden=true
}
},
draw:function(part){
var workspace=this.workspace,doc=workspace.app.getModeDoc(),items,decos=[];
if(!doc){
return
}
items=part&&!part.isDocument()?[part]:doc.getItems();
decos=items.reduce(function(decos,item){
var el=workspace.getComponentEl(item);
if(el){
decos=decos.concat(this.calcRow(el,item))
}
return decos
}.bind(this),[]);
if(part&&!part.isDocument()){
var topDeco=decos.filter(function(deco){
return deco['data-partedge']==='top'
})[0];
var bottomDeco=decos.filter(function(deco){
return deco['data-partedge']==='bottom'
})[0];
if(this.decos){
this.decos.forEach(function(deco,index){
if(deco['data-partid']===part.id){
if(deco['data-partedge']==='top'){
this.decos[index]=topDeco||this.decos[index]
}else{
this.decos[index]=bottomDeco||this.decos[index]
}
}
}.bind(this))
}
decos.forEach(this.createDecoStyle);
var $el=oneJQuery(this.el.dom);
decos.forEach(function(deco){
$el.find('[data-partid='+part.id+'][data-partedge='+deco['data-partedge']+']').css(deco.style)
}.bind(this));
return
}
this.decos=decos;
if(doc instanceof web.data.components.Template){
this.calcTemplate()
}
this.calcSpace();
this.decos.forEach(this.createDecoStyle);
this.el.dom.innerHTML=Ext.DomHelper.markup(this.decos)
},
createDecoStyle:function(deco){
var region=deco.region;
try{
deco.style={
left:region.left+'px',
top:region.top+'px',
width:region.right-region.left+'px',
height:region.bottom-region.top+'px'
}
}catch(e){
one.fatal(e.message,{note:'Uncaught illegal access error still occurs'});
throw new Error('#Error logging is already handled')
}
delete deco.region;
delete deco.isCol
},
calcSpace:function(el){
var decos=this.decos,i,j,iDeco,jDeco,ir,jr,iIndex,jIndex,iEdge,dist,avail,space,rem,mod,start,end,leaveSpace,dm=this.workspace.app.dm,iPart,jPart;
decos.forEach(function(deco){
deco.cx=Math.round((deco.region.left+deco.region.right)/2);
deco.cy=Math.round((deco.region.top+deco.region.bottom)/2);
deco.center=deco.isCol?deco.cx:deco.cy
},this);
decos.sort(function(a,b){
return(a.isCol?1:0)-(b.isCol?1:0)
});
for(i=0;(iDeco=decos[i])&&(ir=iDeco.region);i+=1){
for(j=0;(jDeco=decos[j])&&(jr=jDeco.region);j+=1){
if(iDeco!==jDeco&&iDeco.isCol===jDeco.isCol){
start=null;
leaveSpace=true;
if(iDeco.isCol){
if(ir.left<jr.left&&jr.bottom>ir.top&&jr.top<ir.bottom){
start='left';
end='right'
}
}else{
if(jr.right>ir.left&&jr.left<ir.right){
if(ir.top<jr.top){
start='top';
end='bottom'
}else if(ir.top===jr.top){
iPart=dm.get(iDeco['data-partid']);
jPart=dm.get(jDeco['data-partid']);
if(!iPart||!jPart){
continue
}
iIndex=iPart.getIndex();
jIndex=jPart.getIndex();
iEdge=iDeco['data-partedge'];
if(iPart&&(iIndex>jIndex&&iEdge==='bottom'||iIndex<jIndex&&iEdge==='top')){
start='top';
end='bottom';
leaveSpace=false
}
}
}
}
if(start){
dist=jr[start]-ir[end];
if(dist<10){
avail=20+dist;
space=leaveSpace?Math.max(0,Math.ceil(avail/3)):0;
rem=avail-space;
mod=Math.max(10-Math.min(9,Math.floor(rem/2)),0);
jr[start]+=mod;
ir[end]-=mod;
jr[start]=Math.min(jr[start],jDeco.center);
ir[end]=Math.max(ir[end],iDeco.center);
jDeco['data-mod']=jr[start]-jDeco.center+10
}
}
}
}
}
},
calcTemplate:function(){
var workspace=this.workspace,template=workspace.app.getSelected('template'),inner=workspace.getComponentInnerRegion(template),region=inner?workspace.copyRegion(inner,-200,0,10000,0):null,id=template?template.id:null,width=region?region.right-region.left:null,align=template?template.getAlign():null,deco;
if(!region){
return
}
if(align!=='left'){
deco={
cls:'web-edge web-edge-col web-edge-intemplate',
'data-partid':id,
'data-partedge':'left',
region:workspace.copyRegion(region,0,-10,0,10-width)
};
this.decos.push(deco)
}
if(align!=='right'){
deco={
cls:'web-edge web-edge-col web-edge-intemplate',
'data-partid':id,
'data-partedge':'right',
region:workspace.copyRegion(region,0,width-10,0,10)
};
this.decos.push(deco)
}
},
calcRow:function(el,component){
var workspace=this.workspace,region=workspace.getComponentRegion(component),id=el.dom.getAttribute('data-id'),part=workspace.app.dm.get(id),parent=part?part.getRelInParent():null,doc=part?part.getParent():null,docName=part&&part.inPage()?'page':'template',template=doc?doc.getTemplate():null,height=region.bottom-region.top,deco,result=[];
if(doc&&parent&&!part.isGhost()){
var ibb=part.getBBox(),pbb=parent.getBBox();
if(parent===template||ibb.top!==pbb.top){
deco={
cls:'web-edge web-edge-row web-edge-in'+docName,
'data-partid':id,
'data-partedge':'top',
region:workspace.copyRegion(region,-10,0,10-height,0)
};
result.push(deco)
}
if(parent===template||ibb.bottom!==pbb.bottom){
deco={
cls:'web-edge web-edge-row web-edge-in'+docName,
'data-partid':id,
'data-partedge':'bottom',
region:workspace.copyRegion(region,height-10,0,10,0)
};
result.push(deco)
}
}
return result
}
});
web.workspace.plugins.EdgeMove=Ext.extend(Ext.util.Observable,{
init:function(workspace){
this.workspace=workspace;
workspace.edgeMove=this;
this.addEvents('start','move','end');
workspace.on('render',function(){
this.onRender()
},this)
},
onRender:function(){
var workspace=this.workspace,body=workspace.el;
this.bodyEl=body.first('div');
body.on('mousemove',function(ev){
if(this.grabHandle){
this.onHandlemove(ev)
}
},this);
body.on('scroll',function(ev){
if(this.grabHandle){
this.onHandlemove(ev)
}
},this);
body.on('mousedown',function(ev,node){
var handle=this.grabHandle=this.getHandle(node),region=this.region,component=this.component,edgeX,edgeY;
if(handle&&component){
this.active=true;
edgeX=handle.edges[0];
edgeY=handle.edges[1];
handle.grabXY=this.getCursorXY(ev);
handle.changeXY=[
0,
0
];
handle.oldWidth=region.right-region.left;
handle.oldHeight=region.bottom-region.top;
handle.oldRegion=region;
handle.changeLimitXY=[
edgeX?this.getMoveEdgeLimits(edgeX):null,
edgeY?this.getMoveEdgeLimits(edgeY):null
];
handle.dualXY=[
edgeX?this.getDual(edgeX):null,
edgeY?this.getDual(edgeY):null
];
if(edgeY==='bottom'){
this.normalizeHeight()
}
workspace.multiSelectFrame.hide();
workspace.hover.hide();
this.fireEvent('start',this)
}
},this);
web.ui.onMouseup(function(ev){
var changeXY,moveXY,handle=this.grabHandle,that=this;
if(handle){
changeXY=handle.changeXY;
this.adjustXY([
-changeXY[0],
-changeXY[1]
]);
moveXY=this.getMoveXY(this.getCursorXY(ev));
this.updateXY(moveXY);
this.grabHandle=null;
window.setTimeout(function(){
workspace.hover.show();
workspace.multiSelectFrame.show();
that.fireEvent('end',this);
that.active=false
},50)
}
},this)
},
canMoveEdge:function(edge){
var limits=this.getMoveEdgeLimits(edge);
return limits[0]!==limits[1]
},
getDual:function(edge){
var cmp=this.component;
if(edge==='left'||edge==='right'){
return cmp.getAlign&&cmp.getAlign()==='center'
}
return false
},
getAvail:function(edge,cmp){
var avail,region,height;
if(edge==='left'||edge==='right'){
avail=cmp.getWidth()-cmp.getMinWidth()
}else{
region=this.workspace.getComponentOuterRegion(cmp);
height=region.bottom-region.top;
avail=height-cmp.getMinHeight()
}
return avail
},
getLimitsBottom:function(edge,cmp){
var region=this.workspace.getComponentOuterRegion(cmp),height=region.bottom-region.top,availMaxHeight=Math.max(cmp.getMaxHeight()-height,0),result;
result=[
-this.getAvail(edge,cmp),
availMaxHeight
];
return result
},
getLimits:function(edge,cmp){
var result;
if(edge==='left'||edge==='right'){
var avail=this.getAvail(edge,cmp),availMaxWidth=Math.max(cmp.getMaxWidth()-cmp.getWidth(),0);
if(cmp instanceof web.data.components.Template){
var dualMinMove=Math.round(avail/2),dualMaxMove=Math.round(availMaxWidth/2);
result=edge==='right'?[
-dualMinMove,
dualMaxMove
]:[
-dualMaxMove,
dualMinMove
]
}else{
result=edge==='right'?[
-avail,
availMaxWidth
]:[
-availMaxWidth,
avail
]
}
}else{
result=edge==='bottom'?this.getLimitsBottom(edge,cmp):[
-cmp.getTopShiftMin(),
10000
]
}
return result
},
getMoveEdgeLimits:function(edge,cmp){
cmp=cmp||this.component;
return this.getLimits(edge,cmp)
},
getCursorXY:function(ev){
var xy=ev.getXY(),bxy=this.bodyEl.getXY();
if(!xy[0]&&!xy[1]){
xy=this.cursorXY
}
this.cursorXY=xy;
return[
xy[0]-bxy[0],
xy[1]-bxy[1]
]
},
updateXY:function(xy){
var handle=this.grabHandle,xEdge=handle.edges[0],yEdge=handle.edges[1],sr=handle.snapRegion,or=handle.oldRegion,x=xEdge&&sr&&or?sr[xEdge]-or[xEdge]:0,y=yEdge&&sr&&or?sr[yEdge]-or[yEdge]:0,component=this.component,ns=web.commands.components,comm;
if(x||y){
if(xEdge){
comm=new ns.MultiMoveEdge({
components:[component],
edge:xEdge,
amount:x
})
}else{
comm=new ns.MultiMoveEdge({
components:[component],
edge:yEdge,
amount:y
})
}
this.workspace.app.invoker.execute(comm)
}
handle.adjustRegion=null;
handle.snapRegion=null
},
normalizeHeight:function(){
var component=this.component,region=this.region,dataHeight=component.getHeight(),trueHeight=region.bottom-region.top;
if(dataHeight!==trueHeight){
component.setHeight(trueHeight)
}
},
getHandle:function(node){
var component,workspace=this.workspace,id=node.getAttribute('data-partid'),edge=node.getAttribute('data-partedge');
if(id&&edge){
component=this.component=workspace.app.dm.get(id);
this.region=component instanceof web.data.components.Template?workspace.getComponentInnerRegion(component):workspace.getComponentRegion(component);
return component&&this.region?{
node:node,
edges:edge==='left'||edge==='right'?[
edge,
null
]:[
null,
edge
]
}:null
}
return null
},
onHandlemove:function(ev){
var cursorXY=this.getCursorXY(ev),moveXY=this.getMoveXY(cursorXY);
this.adjustXY(moveXY);
this.adjustHandle(moveXY);
this.fireEvent('move',this);
ev.stopEvent()
},
getMoveXY:function(cursorXY){
var handle=this.grabHandle,grabXY=handle.grabXY,changeXY=handle.changeXY,changeX=cursorXY[0]-grabXY[0],changeY=cursorXY[1]-grabXY[1],limitXY=handle.changeLimitXY,limitX=limitXY[0],limitY=limitXY[1],moveXY=[
0,
0
];
if(limitX){
changeX=changeX<limitX[0]?limitX[0]:changeX>limitX[1]?limitX[1]:changeX
}
if(limitY){
changeY=changeY<limitY[0]?limitY[0]:changeY>limitY[1]?limitY[1]:changeY
}
moveXY[0]=Math.round(changeX-changeXY[0]);
moveXY[1]=Math.round(changeY-changeXY[1]);
return moveXY
},
adjustXY:function(xy){
var handle=this.grabHandle,xEdge=handle.edges[0],yEdge=handle.edges[1];
if(xEdge){
handle.changeXY[0]+=xy[0]
}
if(yEdge){
handle.changeXY[1]+=xy[1]
}
},
adjustHandle:function(xy){
var workspace=this.workspace,handle=this.grabHandle,cmp=this.component,xEdge=handle.edges[0],yEdge=handle.edges[1],dx=0,dy=0,dw=0,dh=0,isSnap,dual,align,region;
if(xEdge){
dual=handle.dualXY[0];
align=cmp.getAlign?cmp.getAlign():'left';
dx=xy[0]*(xEdge==='right'?-1:1);
dw=-dx*(dual?2:1);
if(align==='left'&&xEdge==='right'){
dx=0;
dw=xy[0]
}
isSnap=false
}
if(yEdge){
dy=xy[1];
if(yEdge==='bottom'){
dh=dy;
dy=0
}
isSnap=true
}
region=handle.adjustRegion=workspace.copyRegion(handle.adjustRegion||handle.oldRegion,dy,dx,dy+dh,dx+dw);
var w=region.right-region.left;
if(dual&&align==='center'&&w%2){
region.right+=1
}
region=handle.snapRegion=isSnap?workspace.toSnapRegion(region,[
xEdge,
yEdge
]):region;
if(region.right-region.left<cmp.getMinWidth()){
region.right=handle.adjustRegion.right;
region.left=handle.adjustRegion.left
}
if(region.bottom-region.top<cmp.getMinHeight()){
region.top=handle.adjustRegion.top;
region.bottom=handle.adjustRegion.bottom
}
}
});
Ext.ns('web.workspace.decos');
web.workspace.decos.VEdge=Ext.extend(Object,{
constructor:function(cfg){
this.edge='top';
this.dx=0;
this.dy=0;
this.set(cfg);
this.onRender()
},
set:function(cfg){
Ext.apply(this,cfg);
return this
},
onRender:function(){
var paper=this.workspace.overlay.paper,borderWidth=2,light=this.light,colorDark='rgba(63, 63, 63, 1)',colorLight='rgba(162, 162, 162, 1)',color=light?colorLight:colorDark,imgUrlDark='//webeditor-static.cdn-one.com/edgedrag.f3f5445d97.png',imgUrlLight='//webeditor-static.cdn-one.com/edgedrag-grey.29e4fb550b.png',imgUrl=light?imgUrlLight:imgUrlDark;
this.hoverEdge=paper.rect(0,0,0,0).attr({
'stroke':'rgba(255, 255, 255, 0.4)',
'stroke-width':borderWidth+2,
'stroke-linejoin':'miter'
});
this.leftEdge=paper.rect(0,0,18,18).attr({
'stroke':'rgba(255, 255, 255, 0.4)',
'stroke-width':2,
'stroke-linejoin':'miter'
});
this.rightEdge=paper.rect(0,0,18,18).attr({
'stroke':'rgba(255, 255, 255, 0.4)',
'stroke-width':2,
'stroke-linejoin':'miter'
});
this.hover=paper.rect(0,0,0,0).attr({
'stroke':color,
'stroke-width':borderWidth,
'stroke-linejoin':'miter'
});
this.leftImg=paper.image(imgUrl,0,0,18,18);
this.rightImg=paper.image(imgUrl,0,0,18,18)
},
refresh:function(){
var region=this.region,edge=this.edge,dx=this.dx,dy=this.dy,x,y,w,h;
if(!this.hidden&&region){
x=region.left;
y=region.top;
w=region.right-x;
h=region.bottom-y;
x-=dx;
y+=edge==='bottom'?h+dy:-dy;
w+=dx*2;
h=0.01;
this.leftEdge.attr({
x:x-9,
y:y-9
}).show();
this.rightEdge.attr({
x:x+w-9,
y:y-9
}).show();
this.leftImg.attr({
x:x-9,
y:y-9
}).show();
this.rightImg.attr({
x:x+w-9,
y:y-9
}).show();
this.hoverEdge.attr({
x:x,
y:y,
width:w,
height:h
}).show();
this.hover.attr({
x:x,
y:y,
width:w,
height:h
}).show()
}else{
this.hoverEdge.hide();
this.leftEdge.hide();
this.rightEdge.hide();
this.hover.hide();
this.leftImg.hide();
this.rightImg.hide()
}
},
toFront:function(){
this.hoverEdge.toFront();
this.leftEdge.toFront();
this.rightEdge.toFront();
this.hover.toFront();
this.leftImg.toFront();
this.rightImg.toFront()
},
show:function(){
this.hidden=false;
this.refresh()
},
hide:function(){
this.hidden=true;
this.refresh()
}
});
web.workspace.plugins.EdgeDeco=Ext.extend(Object,{
init:function(workspace){
this.workspace=workspace;
workspace.edgeDeco=this;
this.overlay=workspace.overlay;
this.borderWidth=2;
this.isActive=true;
this.timeout=null;
workspace.on('render',function(){
this.onRender();
this.initListeners()
},this)
},
initListeners:function(){
var workspace=this.workspace,app=workspace.app;
workspace.el.on('mouseover',function(event,node){
if(!this.workspace.edgeMove.active){
this.hoverOver(node)
}
},this);
workspace.el.on('mousemove',function(event,node){
if(this.workspace.edgeMove.active){
this.point=this.workspace.getPoint(event)
}
},this);
app.on('select',function(part){
this.hideLocal();
this.point=null
},this);
workspace.edgeMove.on('move',function(edgeMove){
this.drawEdge(edgeMove.grabHandle.snapRegion)
},this)
},
onRender:function(){
var paper=this.overlay.paper,borderWidth;
borderWidth=this.borderWidth;
this.vEdge=new web.workspace.decos.VEdge({
workspace:this.workspace,
light:true,
dx:4
});
this.hoverEdge=paper.rect(0,0,0,0).attr({
'stroke':'rgba(255, 255, 255, 0.4)',
'stroke-width':borderWidth+2,
'stroke-linejoin':'miter'
});
this.hover=paper.rect(0,0,0,0).attr({
'stroke':'rgba(63, 63, 63, 0.8)',
'stroke-width':borderWidth,
'stroke-linejoin':'miter'
});
this.hoverEdgeDual=paper.rect(0,0,0,0).attr({
'stroke':'rgba(255, 255, 255, 0.4)',
'stroke-width':borderWidth+2,
'stroke-linejoin':'miter'
});
this.hoverDual=paper.rect(0,0,0,0).attr({
'stroke':'rgba(63, 63, 63, 0.8)',
'stroke-width':borderWidth,
'stroke-linejoin':'miter'
});
this.limitEl=this.workspace.el
},
hoverOver:function(node){
if(node){
this.hoverNode=node;
clearTimeout(this.timeout);
this.timeout=setTimeout(function(){
this.draw(node)
}.createDelegate(this),50)
}
},
getComponentNode:function(node){
return node
},
draw:function(node){
if(this.isHidden){
return
}
var dm=this.workspace.app.dm,id=node.getAttribute('data-partid'),component;
if(id){
component=dm.get(id);
if(component){
this.component=component;
this.node=node;
this.drawEdge();
return
}
}
this.hideLocal()
},
drawEdge:function(region){
var x,y,w,h,node=this.node,workspace=this.workspace,id=node.getAttribute('data-partid'),component=workspace.app.dm.get(id),edge=node.getAttribute('data-partedge'),isActive=!!region;
region=region||(component instanceof web.data.components.Template?workspace.getComponentInnerRegion(component):workspace.getComponentRegion(component));
if(!region){
return
}
x=region.left;
y=region.top;
w=region.right-x;
h=region.bottom-y;
if(edge==='left'||edge==='right'){
this.vEdge.hide();
if(component.getAlign&&component.getAlign()==='center'){
this.hoverEdgeDual.attr({
x:x,
y:y,
width:0.01,
height:h
}).show();
this.hoverDual.attr({
x:x,
y:y,
width:0.01,
height:h
}).show();
x+=w
}else{
this.hoverEdgeDual.hide();
this.hoverDual.hide();
x+=edge==='right'?w:0
}
w=0.01;
this.hoverEdge.attr({
x:x,
y:y,
width:w,
height:h
}).show();
this.hover.attr({
x:x,
y:y,
width:w,
height:h
}).show();
if(this.point){
this.workspace.dims.hide();
this.workspace.dims.show([{
x:Math.round((region.left+region.right)/2),
y:this.point.top,
value:region.right-region.left
}])
}
}else{
this.vEdge.set({
edge:edge,
region:region
}).show();
this.hoverEdgeDual.hide();
this.hoverDual.hide();
this.hoverEdge.hide();
this.hover.hide()
}
if(!isActive){
this.hoverEdge.toFront();
this.hover.toFront();
this.hoverEdgeDual.toFront();
this.hoverDual.toFront();
this.vEdge.toFront();
workspace.multiSelectTitle.menuToFront()
}
},
hideLocal:function(){
this.hoverEdge.hide();
this.hover.hide();
this.hoverEdgeDual.hide();
this.hoverDual.hide();
this.vEdge.hide();
this.workspace.dims.hide()
},
show:function(){
this.isHidden=false
},
hide:function(){
this.isHidden=true;
this.hideLocal()
}
});
web.workspace.plugins.EdgeSnapTo=Ext.extend(Object,{
type:'web.workspace.plugins.EdgeSnapTo',
init:function(workspace){
this.workspace=workspace;
workspace.edgeSnapTo=this;
this.overlay=workspace.overlay;
this.decos=[];
workspace.on('render',function(){
this.initListeners()
},this)
},
initListeners:function(){
var workspace=this.workspace,edgeMove=workspace.edgeMove;
edgeMove.on('move',function(){
this.show(edgeMove)
},this);
edgeMove.on('end',function(){
this.hide()
},this)
},
show:function(edgeMove){
this.showDecos(edgeMove)
},
showDecos:function(edgeMove){
var handle=edgeMove.grabHandle,region=handle.snapRegion,cmp=edgeMove.component,attr={
'fill':'rgba(63, 63, 63, 0)',
stroke:'rgba(126, 126, 126, 1)',
'stroke-width':1
},workspace=this.workspace,paper=workspace.overlay.paper,that=this,add=function(r,attr,offset){
offset=offset||0;
that.decos.push(paper.rect(r.left+offset,r.top+offset,Math.max(r.right-r.left-offset*2,2),Math.max(r.bottom-r.top-offset*2,2)).attr(attr))
};
if(cmp instanceof web.data.components.Template){
return
}
this.hideDecos();
var template=workspace.app.getSelected('template'),items=template.getAllItems().concat([template]),exclude=[cmp],edges=[],opp={
top:'bottom',
right:'left',
bottom:'top',
left:'right'
},snaps={};
handle.edges.forEach(function(edge){
if(edge){
edges.push(edge)
}
});
items.forEach(function(item){
var outer=item.getParent()?workspace.getComponentRegion(item):workspace.getComponentInnerRegion(item);
if(!outer){
return
}
if(exclude.indexOf(item)===-1){
edges.forEach(function(edge){
if(region[edge]===outer[edge]||region[edge]===outer[opp[edge]]){
snaps[edge]=true
}
})
}
if(item instanceof web.data.components.Text&&region.intersect(outer)&&edges.indexOf('top')!==-1){
var relInEl=workspace.getComponentEl(item),paraEls=relInEl.select('[data-index]');
paraEls.each(function(paraEl,els,index){
var paraRegion=workspace.adjustRegion(paraEl.getRegion());
if(region.top===paraRegion.top){
snaps.top=true
}
},this)
}
},this);
edges.forEach(function(edge){
if(snaps[edge]){
var snapRegion=workspace.getComponentRegion(template);
snapRegion=workspace.copyRegion(snapRegion,-200,-200,20000,200);
snapRegion[edge]=region[edge];
add(snapRegion,attr,0.5)
}
})
},
hide:function(){
this.region=null;
this.hideDecos()
},
hideDecos:function(){
this.decos.forEach(function(deco,index){
try{
deco.hide();
deco.remove()
}catch(e){
}
},this);
this.decos=[]
}
});
web.utils.Event={
add:function(element,eventName,handler){
if(element.addEventListener){
element.addEventListener(eventName,handler,false)
}else if(element.attachEvent){
var r=element.attachEvent('on'+eventName,handler);
return r
}
},
remove:function(element,eventName,handler){
if(element.removeEventListener){
element.removeEventListener(eventName,handler,false)
}else if(element.attachEvent){
var r=element.detachEvent('on'+eventName,handler);
return r
}
}
};
web.utils.ComponentSerializer=function(){
return{
serialize:function(components){
var data={
components:[],
styles:{},
stylesheetId:null
},template;
components=Ext.isArray(components)?components:[components];
if(components.length){
components.forEach(function(item){
data.components.push(item.toJSON());
item.getAllStyles().forEach(function(style){
var global=style.getGlobal();
if(global){
data.styles[global.getId()]=global
}
})
});
template=components[0].getTemplate();
if(template){
data.stylesheetId=template.stylesheetId
}
}
return data
},
deserialize:function(data,newStylesheet){
var isChange=data.stylesheetId&&data.stylesheetId!==newStylesheet.getId(),dm=newStylesheet.dm,components=[],idMap={};
data.components.forEach(function(item){
var oldId=item.id;
function newUuidDeep(obj,idMap){
var key;
for(key in obj){
if(Ext.isObject(obj[key])){
newUuidDeep(obj[key],idMap)
}else if(key==='id'){
idMap[obj[key]]=obj[key];
obj[key]=Math.uuid()
}
}
}
newUuidDeep(item,idMap);
var cmp=dm.create(Ext.apply({},item));
idMap[oldId]=item.id;
components.push(cmp);
if(isChange){
cmp.getAllStyles().forEach(function(style){
if(style.globalId){
var oldGlobalCfg=data.styles[style.globalId],oldGlobal=dm.get(oldGlobalCfg.id)||dm.create(oldGlobalCfg),newGlobal=newStylesheet.getClosestStyle(oldGlobal);
if(newGlobal){
style.set({globalId:newGlobal.getId()})
}
}
})
}
});
components.forEach(function(item){
var newId;
if(item.relIn){
newId=idMap[item.relIn.id];
if(newId){
item.relIn.id=newId
}else{
delete item.relIn
}
}
if(item.relTo){
newId=idMap[item.relTo.id];
if(newId){
item.relTo.id=newId
}else if(!item.relTo.page){
delete item.relTo
}
}
});
return components
}
}
}();
Ext.ns('web.commands.text');
web.commands.text.BBoxAdjust=Ext.extend(web.commands.Command,{
execute:function(){
var target=this.target,height=Math.max(target.getHeight(),this.app.workspace.rte.editor.getHeight());
this.oldBottom=target.bbox.bottom;
target.bbox.bottom=target.bbox.top+height;
this.newBottom=target.bbox.bottom
},
undo:function(){
var target=this.target,bottom=this.undone?this.newBottom:this.oldBottom;
target.bbox.bottom=bottom;
this.undone=!this.undone
}
});
web.commands.text.ShiftRelPara=Ext.extend(web.commands.Command,{
execute:function(){
var target=this.target,afterIndex=this.afterIndex,indexShift=this.indexShift,cellParaShift=this.cellParaShift,afterRowIndex=this.afterRowIndex,rowShift=this.rowShift,blocks=target.getBlocks();
this.oldRelPara=[];
this.newRelPara=[];
if(target.getRichtext().isTable()){
if(cellParaShift){
var totalShift=0;
cellParaShift.forEach(function(obj){
var relPara=obj.block.relPara;
this.oldRelPara.push({
block:obj.block,
index:relPara.index,
cellIndex:relPara.cellIndex
});
totalShift+=obj.amount;
relPara.index+=totalShift;
relPara.cellIndex+=obj.amount;
this.newRelPara.push({
block:obj.block,
index:relPara.index,
cellIndex:relPara.cellIndex
})
},this)
}else if(rowShift){
blocks.forEach(function(block){
var relPara=block.relPara;
if(relPara.row>afterRowIndex){
this.oldRelPara.push({
block:block,
row:relPara.row
});
relPara.row+=rowShift;
this.newRelPara.push({
block:block,
row:relPara.row
})
}
},this)
}
}else{
blocks.forEach(function(block){
var relPara=block.relPara;
if(indexShift&&relPara.index>afterIndex){
this.oldRelPara.push({
block:block,
index:relPara.index,
cellIndex:relPara.cellIndex
});
relPara.index+=indexShift;
this.newRelPara.push({
block:block,
index:relPara.index,
cellIndex:relPara.cellIndex
})
}
},this)
}
},
undo:function(){
var relParaInfo=this.undone?this.newRelPara:this.oldRelPara;
relParaInfo.forEach(function(item){
var block=item.block;
if(Ext.isNumber(item.index)){
block.relPara.index=item.index
}
if(Ext.isNumber(item.cellIndex)){
block.relPara.cellIndex=item.cellIndex
}
if(Ext.isNumber(item.row)){
block.relPara.row=item.row
}
},this);
this.undone=!this.undone
}
});
web.commands.text.Insert=Ext.extend(web.commands.CompoundCommand,{
execute:function(){
var target=this.target,text=this.text,insertedText=text,oldHeight,newHeight,changes={},parent=target.getRelIn()&&target.getRelInParent();
if(text instanceof web.data.components.Text){
this.end=this.start+text.getText().length;
insertedText=text.getText()
}else{
this.end=this.start+text.length
}
var blocks=target.getBlocks();
if(blocks.length&&insertedText.indexOf('\n')>-1){
var newParas=insertedText.match(/\n/g).length,parasBeforeInsertionPoint=(target.getText().slice(0,this.start).match(/[\n\t]/g)||[]).length,cellParaShift=[];
if(target.getRichtext().isTable()){
var affectedCell=target.getCurrentCells()[0],cellStart=affectedCell.getStart(),cellEnd=affectedCell.getEnd(),cellStartPara=(target.text.slice(0,cellStart).match(/[\n\t]/g)||[]).length,cellEndPara=(target.text.slice(0,cellEnd).match(/[\n\t]/g)||[]).length;
blocks.forEach(function(block){
var relPara=block.relPara;
if(relPara.index>parasBeforeInsertionPoint&&cellStartPara<=relPara.index&&relPara.index<cellEndPara){
cellParaShift.push({
cellIndex:affectedCell.getIndex(),
block:block,
amount:newParas
})
}
})
}
this.executeCommand(new web.commands.text.ShiftRelPara({
target:target,
afterIndex:parasBeforeInsertionPoint,
indexShift:newParas,
cellParaShift:cellParaShift
}))
}
this.oldJSON=target.toJSON();
this.oldPos=[
this.start,
this.start
];
target.insert(text,this.oldPos[0]);
if(this.styling){
target.position(this.start,this.end);
if(this.styling.style&&Object.keys(this.styling.style).length>0){
target.applyStyle(this.styling.style)
}
target.position(this.end)
}
this.updateStyles();
this.newJSON=target.toJSON();
this.newPos=[
this.end,
this.end
];
this.app.workspace.rte.fireEvent('select',{
component:target,
start:this.newPos[0],
end:this.newPos[1],
cursorIndex:this.newPos[1]
});
oldHeight=target.getHeight();
this.executeCommand(new web.commands.text.BBoxAdjust({target:target}));
this.fireEvent('update',target);
newHeight=target.getHeight();
if(newHeight>oldHeight&&parent){
var bbox=parent.getBBox();
bbox.bottom+=newHeight-oldHeight;
changes[parent.id]={bbox:bbox};
this.executeCommand(new web.commands.components.ChangeMulti({
changes:changes,
components:[parent]
}))
}
},
undo:function(){
var target=this.target,json=this.undone?this.newJSON:this.oldJSON,pos=this.undone?this.newPos:this.oldPos;
target.set(json);
if(pos){
target.position(pos);
this.app.workspace.rte.fireEvent('select',{
component:target,
start:pos[0],
end:pos[1],
cursorIndex:pos[1]
})
}
this.undone=!this.undone;
web.commands.text.Insert.superclass.undo.call(this);
this.fireEvent('update',target)
},
updateStyles:function(){
this.target.getCurrentStyles().forEach(function(style){
this.fireEvent('update',style)
},this)
}
});
web.commands.text.Remove=Ext.extend(web.commands.text.Insert,{
constructor:function(cfg){
web.commands.text.Remove.superclass.constructor.call(this,cfg)
},
execute:function(){
var target=this.target,text=target.getText(),textToRemove='';
var cells=target.getRichtext().cells,blocks=target.getBlocks();
if(blocks.length){
if(target.getRichtext().isTable()){
var pos=this.start,cellParaShift=[];
cells.forEach(function(cell,i){
var cellStart=cell.getStart(),cellEnd=cell.getEnd();
if(pos<=this.end&&cellStart<=pos&&pos<cellEnd){
var cellStartPara=(text.slice(0,cellStart).match(/[\n\t]/g)||[]).length,cellEndPara=(text.slice(0,cellEnd).match(/[\n\t]/g)||[]).length,blocksInCell=blocks.filter(function(block){
var relPara=block.relPara;
return cellStartPara<=relPara.index&&relPara.index<cellEndPara
},this);
blocksInCell.forEach(function(block){
var relPara=block.relPara,parasBetweenStartAndBlock=relPara.index-(text.slice(0,pos).match(/[\n\t]/g)||[]).length;
if(parasBetweenStartAndBlock){
cellParaShift.push({
cellIndex:i,
block:block,
amount:-parasBetweenStartAndBlock
})
}
});
pos=cellEnd
}
},this);
this.executeCommand(new web.commands.text.ShiftRelPara({
target:target,
cellParaShift:cellParaShift
}))
}else{
textToRemove=text.slice(this.start,this.end);
if(textToRemove.indexOf('\n')>-1){
var removedParas=textToRemove.match(/\n/g).length,parasBeforeStart=(target.getText().slice(0,this.start).match(/[\n\t]/g)||[]).length;
this.executeCommand(new web.commands.text.ShiftRelPara({
target:target,
afterIndex:parasBeforeStart,
indexShift:-removedParas
}))
}
}
}
this.oldJSON=target.toJSON();
this.oldPos=[
this.start,
this.end
];
target.remove(this.oldPos[0],this.oldPos[1]);
this.newJSON=target.toJSON();
this.newPos=[
this.start,
this.start
];
this.app.workspace.rte.fireEvent('select',{
component:target,
start:this.newPos[0],
end:this.newPos[1],
cursorIndex:this.newPos[1]
});
this.executeCommand(new web.commands.text.BBoxAdjust({target:target}));
this.fireEvent('update',target)
}
});
web.commands.text.Replace=Ext.extend(web.commands.text.Insert,{
constructor:function(cfg){
web.commands.text.Replace.superclass.constructor.call(this,cfg)
},
execute:function(){
var target=this.target,fullText=target.getText(),text=this.text,newText=text instanceof web.data.components.Text?text.getText():text,newEnd=this.start+newText.length,parasBeforeInsertionPoint=(fullText.slice(0,this.start).match(/[\n\t]/g)||[]).length;
var cells=target.getRichtext().cells,blocks=target.getBlocks();
if(blocks.length){
if(target.getRichtext().isTable()){
var pos=this.start,cellParaShift=[],firstCell=false;
cells.forEach(function(cell,i){
var cellStart=cell.getStart(),cellEnd=cell.getEnd();
if(pos<=this.end&&cellStart<=pos&&pos<cellEnd){
var cellStartPara=(fullText.slice(0,cellStart).match(/[\n\t]/g)||[]).length,cellEndPara=(fullText.slice(0,cellEnd).match(/[\n\t]/g)||[]).length,blocksInCell=blocks.filter(function(block){
var relPara=block.relPara;
return cellStartPara<=relPara.index&&relPara.index<cellEndPara
},this);
blocksInCell.forEach(function(block){
var relPara=block.relPara,parasBetweenStartAndBlock=relPara.index-(fullText.slice(0,pos).match(/[\n\t]/g)||[]).length;
if(firstCell&&relPara.index>parasBeforeInsertionPoint){
parasBetweenStartAndBlock+=(newText.match(/[\n\t]/g)||[]).length
}
if(parasBetweenStartAndBlock){
cellParaShift.push({
cellIndex:i,
block:block,
amount:-parasBetweenStartAndBlock
})
}
});
if(firstCell){
firstCell=false
}
pos=cellEnd
}
},this);
this.executeCommand(new web.commands.text.ShiftRelPara({
target:target,
cellParaShift:cellParaShift
}))
}else{
var oldText=fullText.slice(this.start,this.end),shiftParas=(newText.match(/[\n\t]/g)||[]).length-(oldText.match(/[\n\t]/g)||[]).length;
if(shiftParas){
this.executeCommand(new web.commands.text.ShiftRelPara({
target:target,
afterIndex:parasBeforeInsertionPoint-1,
indexShift:shiftParas
}))
}
}
}
this.oldJSON=target.toJSON();
this.oldPos=[
this.start,
this.end
];
target.replace(text,this.oldPos[0],this.oldPos[1]);
this.newJSON=target.toJSON();
this.newPos=[
newEnd,
newEnd
];
this.app.workspace.rte.fireEvent('select',{
component:target,
start:this.newPos[0],
end:this.newPos[1],
cursorIndex:this.newPos[1]
});
this.executeCommand(new web.commands.text.BBoxAdjust({target:target}));
this.fireEvent('update',target)
}
});
web.windows.WarningMessage=Ext.extend(web.windows.Window,{
type:'web.windows.WarningMessage',
modal:true,
resizable:false,
multiSelect:false,
constructor:function(config){
this.width=500;
this.cls='web-modal-warning x-window-dlg';
this.iconCls='web-warning-icon';
web.windows.WarningMessage.superclass.constructor.call(this,config)
},
initComponent:function(){
this.items=[{
xtype:'label',
ref:'desc'
}];
this.buttons=[{
cls:'x-btn-primary',
text:'OK',
listeners:{
click:this.onCancel,
scope:this
}
}];
web.windows.WarningMessage.superclass.initComponent.apply(this,arguments)
},
onCancel:function(){
this.hide();
this.fireEvent('cancel',this)
},
setMessage:function(msg){
this.desc.setText(msg)
}
});
Ext.ComponentMgr.registerType('web-windows-warning-message',web.windows.WarningMessage);
web.workspace.plugins.Clipboard=Ext.extend(Ext.util.Observable,{
init:function(workspace){
this.workspace=workspace;
this.part=null;
this.selected=null;
this.app=workspace.app;
this.selection={
start:0,
end:0
};
this.pageOffsetCount={};
this.addEvents('update','deselect');
workspace.on('afterrender',this.initDom,this);
this.app.on('select',function(part){
if(part instanceof web.data.components.Component){
this.part=part;
this.selected=null
}
},this);
workspace.multiSelect.on('multiselect',function(selected){
if(selected[0]!==this.part){
this.selected=selected;
this.part=null
}
},this)
},
initDom:function(){
this.app.relayEvents(this,this.app.coreEvents);
this.cb=Ext.DomHelper.append(this.app.getEl(),{
tag:'textarea',
id:'web-clipboard'
});
web.utils.Event.add(document,'keydown',function(e){
var keycode=e.keyCode,listenTo=[
67,
86,
88
];
if(Ext.isSafari&&(keycode===91||keycode===93)){
if(this.checkContext(e)){
this.focusOnClipboard();
this.prepareField()
}
}else if((e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey&&listenTo.indexOf(keycode)>-1){
if(this.checkContext(e)){
this.focusOnClipboard();
this.prepareField()
}
}else if(document.activeElement===this.cb){
this.blurOnClipboard(true)
}
}.createDelegate(this));
web.utils.Event.add(document,'keyup',function(e){
var keycode=e.keyCode;
if(Ext.isSafari&&(keycode===91||keycode===93)){
this.blurOnClipboard()
}
}.createDelegate(this));
this.workspace.el.on('mousedown',function(e){
if(e.button===2&&this.checkContext(e)){
this.showAt(e.getPageX(),e.getPageY());
this.focusOnClipboard();
this.prepareField()
}
},this);
this.workspace.rte.on('select',function(cfg){
this.setSelection(cfg.start,cfg.end)
},this);
web.utils.Event.add(this.cb,'contextmenu',function(){
this.hideTimer=this.hide.defer(100,this)
}.createDelegate(this));
web.utils.Event.add(document,'mouseup',function(e){
if(e.button!==2&&document.activeElement===this.cb){
this.blurOnClipboard(true)
}
}.createDelegate(this));
web.utils.Event.add(this.cb,'copy',this.copy.createDelegate(this));
web.utils.Event.add(this.cb,'paste',this.paste.createDelegate(this));
web.utils.Event.add(this.cb,'cut',this.cut.createDelegate(this))
},
setSelection:function(start,end){
this.selection.start=start;
this.selection.end=end
},
getSelStart:function(){
return this.selection.start
},
getSelEnd:function(){
return this.selection.end
},
showAt:function(x,y){
this.clipboardVisible=true;
window.clearTimeout(this.hideTimer);
this.hideTimer=null;
this.cb.style.zIndex=1000;
this.cb.style.left=x+'px';
this.cb.style.top=y+'px'
},
hide:function(){
if(this.clipboardVisible){
this.clipboardVisible=false;
this.cb.style.zIndex=-1;
this.cb.style.left=this.cb.style.top='0px'
}
},
getPreparedText:function(){
var serialized,part=this.part,selected,internal='',external='';
if(part&&part.getParent&&!part.getParent()){
return
}
if(part instanceof web.data.components.Text){
if(this.getSelStart()<this.getSelEnd()){
part=part.getSnippet(this.getSelStart(),this.getSelEnd())
}else{
return
}
external=part.getText()
}
if(this.selected||part){
selected=this.selected||[part];
serialized=web.utils.ComponentSerializer.serialize(selected);
internal=Ext.encode(serialized);
if(!external){
external=internal
}
return{
internal:internal,
external:external
}
}
},
prepareField:function(){
var text=this.getPreparedText();
if(text){
var cb=this.cb;
cb.value=text.external;
cb.select();
cb.focus()
}
},
saveCopy:function(){
var text=this.getPreparedText();
if(text){
this.valueInternal=text.internal;
this.valueExternal=text.external
}
},
checkContext:function(e){
var dom=e.target||e.srcElement,name=dom.nodeName.toLowerCase();
return dom===this.cb||Ext.fly(dom).hasClass('one-rte-capture')||name!=='input'&&name!=='textarea'
},
focusOnClipboard:function(){
if(document.activeElement!==this.cb){
this.oldFocus=document.activeElement
}
this.cb.focus();
this.cb.select()
},
blurOnClipboard:function(){
function restoreFocus(){
this.blurTimer=null;
if(this.oldFocus){
if(this.oldFocus===document.body){
this.cb.blur()
}else{
this.oldFocus.focus()
}
this.oldFocus=null
}
}
return function(now){
if(this.oldFocus){
if(now){
restoreFocus.call(this)
}else{
window.clearTimeout(this.blurTimer);
this.blurTimer=window.setTimeout(restoreFocus.createDelegate(this),100)
}
}
}
}(),
paste:function(){
function pasteCheck(){
this.focusOnClipboard();
var current=this.cb.value;
if(current===this.valueExternal){
this.pasteInternal()
}else{
this.pasteExternal()
}
this.blurOnClipboard(true)
}
return function(e){
pasteCheck.defer(100,this)
}
}(),
pasteInternal:function(){
var val=this.valueInternal,app=this.app,workspace=app.workspace;
try{
var dsObjs=web.utils.ComponentSerializer.deserialize(Ext.decode(val),app.getSelected('stylesheet')),dsObj=dsObjs[0],nsComponents=web.data.components,docId=app.getModeDoc().getId(),offsetStep=30,count=this.pageOffsetCount[docId]||0,offset=offsetStep*count;
if(this.part&&dsObjs.length<2&&dsObj instanceof nsComponents.Text&&workspace.rte.editor.isActive){
if(!(dsObj instanceof nsComponents.Table)){
if(this.getSelStart()<this.getSelEnd()){
app.invoker.execute(new web.commands.text.Replace({
text:dsObj,
target:this.part,
start:this.getSelStart(),
end:this.getSelEnd()
}))
}else{
app.invoker.execute(new web.commands.text.Insert({
text:dsObj,
target:this.part,
start:this.getSelStart()
}))
}
}
}else{
var changes={},filteredDsObjs,showWarning=function(mode,cmpType){
var win=this.app.windows.create({type:'web.windows.WarningMessage'});
if(mode==='template'){
if(cmpType==='web.data.components.WebShop'){
win.setTitle('Webshop cannot be placed on a template');
win.setMessage('You cannot place your webshop on the template. Please add it to a page instead.');
win.show()
}else{
win.setTitle('Contact form cannot be placed on a template');
win.setMessage('You cannot place your contact form on the template. Please add it to a page instead.');
win.show()
}
}else{
if(cmpType==='web.data.components.WebShop'){
win.setTitle('Only one webshop per page');
win.setMessage('You cannot have two webshops on the same page. Please remove the other webshop component first.');
win.show()
}else{
win.setTitle('Contact form already exists');
win.setMessage('You cannot have more than one contact form on a page.');
win.show()
}
}
}.bind(this);
filteredDsObjs=dsObjs.filter(function(item){
var bbox=item.getBBox();
if(!item.canAddTo(app.getModeDoc())){
showWarning(app.getMode(),item.type);
return false
}
if(count){
bbox.top+=offset;
bbox.right+=offset;
bbox.bottom+=offset;
bbox.left+=offset
}
changes[item.id]={bbox:bbox};
return true
}.bind(this));
changes=workspace.calcRels(changes);
app.invoker.execute(new web.commands.components.ChangeMulti({
components:filteredDsObjs,
changes:changes,
target:app.getModeDoc()
}));
this.pageOffsetCount[docId]=count+1;
setTimeout(function(){
app.workspace.multiSelect.select(dsObjs)
},50)
}
}catch(emptyEx){
one.debug([
'paste.ex',
emptyEx,
val
])
}
},
pasteExternal:function(){
var val=this.cb.value,part=this.app.dm.create({
type:'web.data.components.Text',
text:val.replace(/\t/g,'')
}),serialized=web.utils.ComponentSerializer.serialize(part,this.app),json;
try{
json=JSON.parse(val)
}catch(err){
}
this.valueInternal=json&&json.components?val:Ext.encode(serialized);
this.pasteInternal()
},
copy:function(e){
this.saveCopy();
this.blurOnClipboard();
this.pageOffsetCount={};
this.pageOffsetCount[this.app.getModeDoc().getId()]=1
},
cut:function(){
function cutRemove(){
var part=this.part,selected=this.selected||(part?[part]:null),app=this.app,ns=web.data.components;
if(part instanceof ns.Component&&!(part instanceof ns.Page)&&!(part instanceof ns.Template)){
if(part instanceof ns.Text){
app.invoker.execute(new web.commands.text.Remove({
target:part,
start:this.getSelStart(),
end:this.getSelEnd()
}))
}else{
app.workspace.multiSelectDelete.deleteComponents([part])
}
}else if(selected&&selected.length){
app.workspace.multiSelectDelete.deleteComponents(selected)
}
this.blurOnClipboard(true)
}
return function(e){
this.saveCopy();
cutRemove.defer(100,this);
this.pageOffsetCount={}
}
}()
});
Ext.ns('web.workspace.text');
Ext.ns('web.workspace.text.editor');
Ext.ns('web.workspace.text.view');
web.utils.Dom={
getChildIndex:function(child){
if(!child.parentNode){
var msg='Richtext DOM error';
one.fatal(msg);
throw new Error(msg)
}
if(child.parentNode.childNodes){
return Array.prototype.indexOf.call(child.parentNode.childNodes,child)
}
var parent=child.parentNode,node,index,found=-1;
for(node=parent.firstChild,index=0;node;index+=1,node=node.nextSibling){
if(node===child){
found=index;
break
}
}
return index
},
isAncestor:function(element,node){
while(node){
if(node===element){
return true
}
node=node.parentNode
}
return false
},
getPrevNode:function(node,ancestor,callback,scope){
if(!node){
return null
}
var isOpenTag=false,ret=null;
do{
if(ret==='halt'){
return null
}
if(!isOpenTag&&node.lastChild&&!ret){
node=node.lastChild;
ret=callback.call(scope,node,false,'lastChild')
}else if(node.previousSibling&&node!==ancestor&&ret!=='break'){
node=node.previousSibling;
isOpenTag=false;
ret=callback.call(scope,node,false,'previousSibling')
}else if(node.parentNode&&node!==ancestor){
node=node.parentNode;
isOpenTag=true;
ret=callback.call(scope,node,true,'parentNode')
}else{
node=null
}
}while(node&&ret!=='return');
if(node){
return{
element:node.parentNode,
childIndex:web.utils.Dom.getChildIndex(node)
}
}
return null
},
getNextNode:function(node,ancestor,callback,scope){
if(!node){
return null
}
var isOpenTag=true,ret=null;
do{
if(ret==='halt'){
return null
}
if(isOpenTag&&node.firstChild&&!ret){
node=node.firstChild;
ret=callback.call(scope,node,true,'firstChild')
}else if(node.nextSibling&&node!==ancestor&&ret!=='break'){
node=node.nextSibling;
isOpenTag=true;
ret=callback.call(scope,node,true,'nextSibling')
}else if(node.parentNode&&node!==ancestor){
node=node.parentNode;
isOpenTag=false;
ret=callback.call(scope,node,false,'parentNode')
}else{
node=null
}
}while(node&&ret!=='return');
if(node){
return{
element:node.parentNode,
childIndex:web.utils.Dom.getChildIndex(node)
}
}
return null
},
elementInDocument:function(element){
while(element){
if(element===document){
return true
}
element=element.parentNode
}
return false
},
applyCSS:function(dom,css){
css.split(';').forEach(function(style){
style=style.split(':');
if(style[0]&&style[1]){
if(!(Ext.isIE9&&style[0].trim()==='background-image'&&style[1].trim().indexOf('-gradient')>-1)){
dom.style.setProperty(style[0].trim(),style[1].trim(),null)
}
}
})
},
copyRegion:function(region,t,l,b,r){
if(!region){
return region
}
return new Ext.lib.Region(region.top+(t?t:0),region.right+(r?r:0),region.bottom+(b?b:0),region.left+(l?l:0))
},
getWindowOrigin:function(win){
var location=win.location;
return location.origin||location.protocol+'//'+location.hostname+(location.port?':'+location.port:'')
}
};
web.workspace.text.view.TextNode=Ext.extend(Object,{
constructor:function(config){
Ext.apply(this,{
element:null,
childIndex:-1
});
if(config.textnode){
this.set(config.textnode);
delete config.textnode
}
Ext.apply(this,config)
},
set:function(textnode){
if(textnode){
Ext.apply(this,{
element:textnode.parentNode,
childIndex:web.utils.Dom.getChildIndex(textnode)
})
}
},
getNode:function(){
if(!this.element){
return null
}
if(this.element.childNodes){
return this.element.childNodes[this.childIndex]||null
}
var temp=this.element.firstChild,index;
for(index=0;temp&&index<this.childIndex;index+=1){
temp=temp.nextSibling
}
return temp||null
},
getRect:function(offset){
var textnode=this.getNode(),range=document.createRange(),rect;
if(offset>=textnode.nodeValue.length){
throw new Error('Calling getRect with an out-of-bound offset')
}
range.setStart(textnode,offset);
range.setEnd(textnode,offset+1);
try{
rect=range.getClientRects();
if(!rect||!rect.length){
one.debug('Cannot getRect. Reason: Most likely a detached text node, text editor is hidden or hidden spaces within justified text.');
return null
}
rect=rect.length>1&&rect[0].width===0?rect[1]:rect[0]
}catch(e){
throw new Error('Richtext DOM Error')
}
var ret;
if(Ext.isIE&&screen.logicalXDPI!==screen.deviceXDPI){
var factor=screen.logicalXDPI/screen.deviceXDPI;
ret={
right:Math.floor(rect.right*factor),
bottom:Math.floor(rect.bottom*factor)
};
ret.x=ret.left=Math.floor(rect.left*factor);
ret.y=ret.top=Math.floor(rect.top*factor)
}else{
ret={
x:Math.round(rect.left),
y:Math.round(rect.top),
left:Math.round(rect.left),
top:Math.round(rect.top),
right:Math.round(rect.right),
bottom:Math.round(rect.bottom)
}
}
ret.width=ret.right-ret.left;
ret.height=ret.bottom-ret.top;
return ret
}
});
web.workspace.text.view.Letter=Ext.extend(web.workspace.text.view.TextNode,{
constructor:function(config){
Ext.apply(this,{
scrollEl:null,
offset:-1,
rect:null
});
web.workspace.text.view.Letter.superclass.constructor.call(this,config)
},
getChar:function(){
if(this.offset>-1){
return this.getNode().nodeValue[this.offset]
}
return null
},
getRect:function(recalculate){
if(this.rect&&!recalculate){
return this.rect
}else{
this.rect=web.workspace.text.view.Letter.superclass.getRect.call(this,this.offset);
return this.rect
}
}
});
web.workspace.text.view.CursorClick=Ext.extend(Object,{
constructor:function(scrollEl){
if(!web.workspace.text.view.CursorClick.singleton){
this.scrollEl=scrollEl;
web.workspace.text.view.CursorClick.singleton=this
}
return web.workspace.text.view.CursorClick.singleton
},
getCaretPosition:function(richtextEl,cfg){
var letter=this.findPos(cfg);
if(letter){
letter=this.fixLetter(letter)
}
return letter
},
getCaretByIndex:function(el,index){
if(!el){
return null
}
var dataEls=el.querySelectorAll('*[data-index]'),dataEl,startIndex,length,left=true,alignment;
dataEls=Array.prototype.slice.call(dataEls);
while(dataEl=dataEls.shift()){
startIndex=parseInt(dataEl.getAttribute('data-index'),10);
length=parseInt(dataEl.getAttribute('data-length'),10);
if(startIndex<=index&&index<startIndex+length){
if(index===startIndex+length-1){
if(length!==1){
index-=1;
left=false
}else{
alignment=Ext.fly(dataEl).getStyle('text-align');
left=alignment!=='right'
}
}
index-=startIndex;
break
}
}
var ret=null;
if(dataEl){
web.utils.Dom.getNextNode(dataEl,dataEl,function(node){
if(node.nodeType===3){
length=node.nodeValue.length;
if(index>=length){
index-=length
}else{
ret=new web.workspace.text.view.Letter({
scrollEl:this.scrollEl,
element:node.parentNode,
childIndex:web.utils.Dom.getChildIndex(node),
offset:index,
left:left
});
return'halt'
}
}
},this)
}
return ret
},
getIndexByLetter:function(el,letter){
if(!el||letter.offset<0){
return-1
}
var index=letter.offset,dataEl;
web.utils.Dom.getPrevNode(letter.getNode(),el,function(node,isOpenTag){
if(node.nodeType===3){
index+=node.nodeValue.length
}
if(isOpenTag&&node.nodeType===1){
var dataIndex=parseInt(node.getAttribute('data-index'),10),dataLength;
if(Ext.isNumber(dataIndex)){
dataEl=node;
index+=dataIndex;
dataLength=parseInt(node.getAttribute('data-length'),10);
if(!letter.left&&(Ext.get(node).getStyle('text-align')==='justify'||index+1===dataIndex+dataLength-1)&&dataLength>1){
index+=1
}
return'halt'
}
}
},this);
return dataEl?index:-1
},
fixLetter:function(letter){
var node,p,alignment;
if(letter&&letter.getNode){
node=letter.getNode();
if(node&&node.nodeValue.length===1&&node.nodeValue.charCodeAt(0)===160){
p=node.parentNode;
alignment=Ext.get(p).getStyle('text-align');
letter.left=alignment==='right'?false:true
}
}
return letter
},
findPos:function(cfg){
var element=cfg.targetEl,letter,result,last=null,mousepos={
x:cfg.pageX,
y:cfg.pageY
};
web.utils.Dom.getNextNode(element,element,function(node,isOpenTag){
if(isOpenTag){
if(node.nodeType===1&&node.className.indexOf('textblock')>-1){
return'continue'
}
if(node.nodeType===3){
var TextNode=new web.workspace.text.view.TextNode({textnode:node});
letter=this.recursiveFindPos(TextNode,null,mousepos);
if(!letter){
return'halt'
}
if(letter.offset===letter.getNode().nodeValue.length-1){
last=letter
}else{
if(last){
result=this.resolveDual(last.rect,letter.rect,mousepos);
letter=result===1?last:letter
}
return'halt'
}
}
}
},this);
return letter
},
recursiveFindPos:function(TextNode,elPos,mousepos,start,end){
var textnode=TextNode.getNode();
if(!elPos){
elPos={
x:Ext.get(textnode.parentNode).getX(),
y:Ext.get(textnode.parentNode).getY()
}
}
if(typeof start==='undefined'){
start=0
}
var text=textnode.nodeValue;
if(typeof end==='undefined'||end>text.length){
end=text.length-1
}
var mid=Math.floor((start+end)/2),charRect,result,left,temp;
if(text.length>=1){
charRect=TextNode.getRect(mid);
if(!charRect){
return null
}
result=mousepos.x>=charRect.x&&mousepos.y>=charRect.y;
if(result){
if(mousepos.x<charRect.x+charRect.width&&mousepos.y<charRect.y+charRect.height){
result=2;
left=this.isOnLeft(charRect,mousepos);
mid=new web.workspace.text.view.Letter({
scrollEl:this.scrollEl,
element:TextNode.element,
childIndex:TextNode.childIndex,
offset:mid,
left:left,
rect:charRect,
exactMatch:true
})
}else{
result=3
}
}else{
if(mousepos.y>=charRect.y+charRect.height){
result=3
}else{
result=1
}
}
if(result!==2){
var deadend=start===mid&&end===mid,dual=false;
if(!deadend){
if(result===3){
if(start===mid&&end!==mid){
dual=true
}else{
mid=this.recursiveFindPos(TextNode,elPos,mousepos,mid,end)
}
if(dual){
var charRect2=TextNode.getRect(end);
if(!charRect2){
return null
}
dual=this.resolveDual(charRect,charRect2,mousepos);
if(dual===2){
mid+=1;
charRect=charRect2;
left=this.isOnLeft(charRect,mousepos)
}
deadend=true
}
}else{
temp=mid<end?mid:mid-1;
mid=this.recursiveFindPos(TextNode,elPos,mousepos,start,temp)
}
}
if(deadend){
if(typeof left==='undefined'){
left=result===1
}
mid=new web.workspace.text.view.Letter({
scrollEl:this.scrollEl,
element:TextNode.element,
childIndex:TextNode.childIndex,
offset:mid,
left:left,
rect:charRect,
exactMatch:false
})
}
}
}else{
mid=null
}
return mid
},
diff:function(coord,rect,mousepos){
var dif,dim=coord==='y'?'height':'width';
if(mousepos[coord]<rect[coord]){
dif=mousepos[coord]-rect[coord]
}else if(mousepos[coord]>=rect[coord]+rect[dim]){
dif=mousepos[coord]-(rect[coord]+rect[dim])
}else{
dif=0
}
return dif
},
resolveDual:function(rect1,rect2,mousepos){
var y1=this.diff('y',rect1,mousepos),y2=this.diff('y',rect2,mousepos),x1,x2;
if(y1!==0){
y1/=Math.abs(y1)
}
if(y2!==0){
y2/=Math.abs(y2)
}
if(y1!==y2){
if(y1===0){
return 1
}else if(y2===0){
return 2
}else if(y1<0){
return 1
}else if(y2<0){
return 2
}
}else{
if(y1===-1){
return 1
}else if(y1===1){
return 2
}else{
x1=this.diff('x',rect1,mousepos);
x2=this.diff('x',rect2,mousepos);
return x1*x1<x2*x2?1:2
}
}
},
isOnLeft:function(rect,mousepos){
return mousepos.x<=rect.x+Math.floor(rect.width/2)
}
});
web.workspace.text.view.CursorLine=Ext.extend(Object,{
constructor:function(scrollEl){
if(!web.workspace.text.view.CursorLine.singleton){
this.rectMgr=new web.workspace.text.view.rectManager(scrollEl);
this.scrollEl=scrollEl;
web.workspace.text.view.CursorLine.singleton=this
}
return web.workspace.text.view.CursorLine.singleton
},
up:function(richtextEl,pivot){
var XY=this.rectMgr.upPoint(richtextEl,pivot);
return this.getLetterAtPoint(richtextEl,XY)
},
down:function(richtextEl,pivot){
var XY=this.rectMgr.downPoint(richtextEl,pivot);
return this.getLetterAtPoint(richtextEl,XY)
},
startOfLine:function(richtextEl,pivot){
var XY=this.rectMgr.startOfLine(richtextEl,pivot);
return this.getLetterAtPoint(richtextEl,XY)
},
endOfLine:function(richtextEl,pivot){
var XY=this.rectMgr.endOfLine(richtextEl,pivot);
return this.getLetterAtPoint(richtextEl,XY)
},
getLetterAtPoint:function(richtextEl,cfg){
if(cfg){
var cursorClick=new web.workspace.text.view.CursorClick;
return cursorClick.getCaretPosition(richtextEl,{
pageX:cfg.x,
pageY:cfg.y,
targetEl:cfg.textnode.getNode().parentNode
})
}
return null
}
});
web.workspace.text.view.rectManager=Ext.extend(Object,{
constructor:function(scrollEl){
this.scrollEl=scrollEl;
this.lines=[];
this.lineIndex=0
},
upPoint:function(richtextEl,pivot){
if(this.retrieveNLines(richtextEl,pivot,2,'upward')){
var result=this.calcLetter();
return result
}
},
downPoint:function(richtextEl,pivot){
if(this.retrieveNLines(richtextEl,pivot,2,'downward')){
var result=this.calcLetter();
return result
}
},
startOfLine:function(richtextEl,pivot){
if(this.retrieveNLines(richtextEl,pivot,1,'upward')){
var temp;
if(this.lines[0]&&this.lines[0].length){
temp=this.lines[0][this.lines[0].length-1];
return{
x:temp.rect.left,
y:temp.rect.top+Math.round(temp.rect.height/2),
textnode:temp.textnode
}
}
}
return null
},
endOfLine:function(richtextEl,pivot){
if(this.retrieveNLines(richtextEl,pivot,1,'downward')){
var temp;
if(this.lines[0]&&this.lines[0].length){
temp=this.lines[0][this.lines[0].length-1];
return{
x:temp.rect.right-1,
y:temp.rect.top+Math.round(temp.rect.height/2),
textnode:temp.textnode
}
}
}
return null
},
setPivot:function(pivot){
this.pivot=pivot
},
retrieveNLines:function(richtextEl,pivot,n,direction){
this.setPivot(pivot);
this.lines=[];
this.lineIndex=0;
var iSawABlock=false,travFunc=direction==='upward'?web.utils.Dom.getPrevNode:web.utils.Dom.getNextNode,rel=direction!=='upward';
if(!this.addRects(pivot.node,direction)){
return false
}
if(this.lineIndex<n){
travFunc(pivot.node,richtextEl,function(node,isOpenTag){
if(isOpenTag===rel&&node.nodeType===3){
this.addRects(node,direction,iSawABlock);
iSawABlock=false;
if(this.lineIndex>=n){
return'halt'
}
}
if(node.nodeType!==3&&Ext.get(node).getStyle('display')!=='inline'){
iSawABlock=true
}
if(node.nodeType!==3&&node.className.indexOf('textblock')>-1){
return'continue'
}
},this)
}
return true
},
addRects:function(textnode,direction,wasBlock){
direction=direction==='upward'?-1:1;
var ref=new web.workspace.text.view.TextNode({textnode:textnode}),rect,prevRect,oneline,i,rects=this.getRects(textnode.parentNode);
if(rects.length){
var curLine=direction<0?rects.length-1:0;
if(this.lines.length===0){
curLine=this.findLine(rects)
}
prevRect=this.peekRect(false);
if(prevRect){
prevRect=prevRect.rect
}
for(i=curLine;i>=0&&i<rects.length;i+=direction){
rect=rects[i];
if(prevRect){
if(direction<0){
oneline=this.isRectsOneLine(rect,prevRect)
}else{
oneline=this.isRectsOneLine(prevRect,rect)
}
if(!oneline||wasBlock){
this.lineIndex+=1
}
wasBlock=oneline=false
}
this.push({
rect:rect,
textnode:ref
});
prevRect=rect
}
}else{
one.debug('Cannot getClientRects. Most likely the text node has been detached from document or text editor is hidden.');
return false
}
return true
},
push:function(rect){
if(!this.lines[this.lineIndex]){
this.lines[this.lineIndex]=[]
}
this.lines[this.lineIndex].push(rect)
},
peekRect:function(includePrevLine){
var line,len;
if(this.lines[this.lineIndex]){
line=this.lines[this.lineIndex];
len=line.length;
if(len){
return line[len-1]
}
}else if(includePrevLine&&this.lineIndex>0&&this.lines[this.lineIndex-1]){
line=this.lines[this.lineIndex-1];
len=line.length;
if(len){
return line[len-1]
}
}
return null
},
colorRects:function(){
function colorRect(rect){
var span=document.createElement('span');
span.style.position='absolute';
span.style.left=rect.left+'px';
span.style.top=rect.top+document.documentElement.scrollTop+'px';
span.style.width=rect.right-rect.left+'px';
span.style.height=rect.bottom-rect.top+'px';
span.style.opacity=0.4;
span.style.zIndex='1001';
span.style.backgroundColor='#000000'.replace(/0/g,function(){
return Math.floor(Math.random()*16).toString(16)
});
span.className='colorRect';
document.body.appendChild(span)
}
return function(){
var i,len=this.lines.length,j,len2;
if(len>3){
len=3
}
for(i=0;i<len;i+=1){
len2=this.lines[i].length;
for(j=0;j<len2;j+=1){
colorRect(this.lines[i][j].rect)
}
}
}
}(),
findLine:function(rects){
var i,len=rects.length,y=this.pivot.y;
for(i=0;i<len;i+=1){
if(y<=rects[i].top||y>=rects[i].top&&y<Math.min(rects[i].bottom,(rects[i+1]||{}).top||0)){
return i
}
}
return len-1
},
isRectsOneLine:function(r1,r2){
return r1.right<=r2.left+1
},
calcLetter:function(){
var line=this.lines[1];
if(!line){
return null
}
var i,len=line.length,x=this.pivot.x,rect,nearest=null,left,right,textnode;
for(i=0;i<len;i+=1){
rect=line[i].rect;
textnode=line[i].textnode;
if(rect.left<=x&&rect.right>x){
return{
x:x,
y:rect.top+Math.round(rect.height/2),
textnode:textnode
}
}else if(i===0||i===len-1){
left=Math.abs(rect.left-x);
right=Math.abs(rect.right-x);
if(nearest===null||nearest.left===true&&left<nearest.offset||nearest.left===false&&right<nearest.offset){
nearest={
rect:rect,
offset:left<right?left:right,
left:left<right?true:false,
textnode:textnode
}
}
}
}
rect=nearest.rect;
textnode=nearest.textnode;
return{
x:nearest.left?rect.left:rect.right-1,
y:rect.top+Math.round(rect.height/2),
textnode:textnode
}
},
getRects:function(span){
var rects=span.getClientRects(),rect,ret=[],i,len=rects.length,temp;
for(i=0;i<len;i+=1){
rect=rects[i];
temp={
top:Math.round(rect.top),
bottom:Math.round(rect.bottom),
left:Math.round(rect.left),
right:Math.round(rect.right)
};
temp.width=temp.right-temp.left;
temp.height=temp.bottom-temp.top;
ret.push(temp)
}
return ret
}
});
web.workspace.text.view.Cursor=Ext.extend(Object,{
lastPivotX:null,
letter:null,
constructor:function(config){
if(!config.letter){
config.letter=null
}
Ext.apply(this,config);
this.cursor=Ext.get(Ext.DomHelper.append(this.scrollZone,{cls:'one-rte-cursor'}))
},
cacheLetter:function(letter){
if(letter){
this.letter=letter
}
},
getCursorEl:function(){
return this.cursor
},
appendTo:function(scrollZone){
this.scrollZone=scrollZone;
this.cursor.appendTo(scrollZone);
this.cursor.show();
this.cursor.dom.style.display='none'
},
remove:function(){
this.cursor.remove()
},
blink:function(){
this.cursorBlink=!this.cursorBlink;
this.cursor.dom.className='one-rte-cursor'+(this.cursorBlink?' one-rte-cursor-blink':'')
},
cursorHide:function(){
clearInterval(this.cursorTimer);
this.cursorTimer=null;
this.cursor.dom.style.display='none'
},
cursorShow:function(letter,recalc){
var div,offsetParent,rect,left,offsetX,offsetY,borderLeft,borderTop,that=this;
if(this.cursor.dom){
this.cursor.dom.style.display='block'
}
this.cacheLetter(letter);
if(this.letter&&this.letter.getNode()&&this.letter.getNode().nodeType===3&&Ext.isDefined(this.letter.getChar())){
div=this.cursor.dom;
offsetParent=Ext.get(div.offsetParent);
if(!offsetParent){
return
}
rect=this.letter.getRect(!!recalc);
if(!rect){
return
}
left=this.letter.left;
offsetX=offsetParent.getX();
offsetY=offsetParent.getY();
borderLeft=parseInt(offsetParent.getStyle('border-left-width'),10)||0;
borderTop=parseInt(offsetParent.getStyle('border-top-width'),10)||0;
div.style.left=rect.x+(left?0:rect.width)-offsetX-borderLeft+div.offsetParent.scrollLeft+'px';
div.style.top=rect.y-offsetY-borderTop+div.offsetParent.scrollTop+'px';
div.style.height=rect.height+'px';
clearInterval(this.cursorTimer);
this.cursorBlink=true;
this.blink();
this.cursorTimer=setInterval(function(){
that.blink()
},500)
}
},
getAndCacheLetterByIndex:function(el,index){
if(el){
var cursorClick=new web.workspace.text.view.CursorClick(this.scrollZone.dom),letter=cursorClick.getCaretByIndex(el.dom,index);
if(Ext.isObject(letter)){
this.cacheLetter(letter);
return letter
}
}
},
placeCursorByLetter:function(letter){
if(letter instanceof web.workspace.text.view.Letter){
this.cursorShow(letter)
}
},
placeCursorByEvent:function(el,event){
if(el){
event=event||window.event;
event.targetEl=event.target||event.srcElement;
if(!Ext.isDefined(event.pageX)){
event.pageX=event.clientX;
event.pageY=event.clientY
}
if(event.targetEl===this.cursor.dom){
return null
}
if(!web.utils.Dom.isAncestor(el.dom,event.targetEl)){
event.targetEl=document.elementFromPoint(event.pageX,event.pageY);
if(!web.utils.Dom.isAncestor(el.dom,event.targetEl)){
event.targetEl=el.dom
}
}
var cursorClick=new web.workspace.text.view.CursorClick(this.scrollZone.dom),letter=cursorClick.getCaretPosition(el.dom,event),result;
if(letter){
this.tryForceCursorToLeft(el,letter);
this.letter=letter;
result=cursorClick.getIndexByLetter(el.dom,letter);
if(result>-1){
return result
}else{
one.debug('Richtext: Element returned by getIndexByLetter is wrong ('+result+').')
}
}
}
return null
},
moveUp:function(el){
var newLetter,result,cursorClick=new web.workspace.text.view.CursorClick(this.scrollZone.dom),cursorLine=new web.workspace.text.view.CursorLine(this.scrollZone.dom),letter=this.letter,rect=letter.getRect(),x=letter.left?rect.left:rect.right;
if(!this.lastPivotX){
this.lastPivotX=x
}
newLetter=cursorLine.up(el.dom,{
node:letter.getNode(),
x:this.lastPivotX,
y:rect.y
});
if(newLetter&&web.utils.Dom.isAncestor(el.dom,newLetter.getNode())){
result=cursorClick.getIndexByLetter(el.dom,newLetter);
if(result>-1){
this.cursorShow(newLetter,true);
return result
}else{
one.debug('Richtext: Element returned by getIndexByLetter is wrong ('+result+').')
}
}
return null
},
moveDown:function(el){
var newLetter,result,cursorClick=new web.workspace.text.view.CursorClick(this.scrollZone.dom),cursorLine=new web.workspace.text.view.CursorLine(this.scrollZone.dom),letter=this.letter,rect=letter.getRect(),x=letter.left?rect.left:rect.right;
if(!this.lastPivotX){
this.lastPivotX=x
}
newLetter=cursorLine.down(el.dom,{
node:letter.getNode(),
x:this.lastPivotX,
y:rect.y
});
if(newLetter&&web.utils.Dom.isAncestor(el.dom,newLetter.getNode())){
result=cursorClick.getIndexByLetter(el.dom,newLetter);
if(result>-1){
this.cursorShow(newLetter,true);
return result
}else{
one.debug('Richtext: Element returned by getIndexByLetter is wrong ('+result+').')
}
}
return null
},
moveToStartOfLine:function(el){
var newLetter,result,cursorClick=new web.workspace.text.view.CursorClick(this.scrollZone.dom),cursorLine=new web.workspace.text.view.CursorLine(this.scrollZone.dom),letter=this.letter,rect=letter.getRect();
newLetter=cursorLine.startOfLine(el.dom,{
node:letter.getNode(),
y:rect.y
});
if(newLetter&&web.utils.Dom.isAncestor(el.dom,newLetter.getNode())){
newLetter.left=true;
result=cursorClick.getIndexByLetter(el.dom,newLetter);
if(result>-1){
this.cursorShow(newLetter,true);
return result
}else{
one.debug('Richtext: Element returned by getIndexByLetter is wrong ('+result+').')
}
}
return null
},
moveToEndOfLine:function(el){
var newLetter,result,cursorClick=new web.workspace.text.view.CursorClick(this.scrollZone.dom),cursorLine=new web.workspace.text.view.CursorLine(this.scrollZone.dom),letter=this.letter,rect=letter.getRect();
this.clearPivot();
newLetter=cursorLine.endOfLine(el.dom,{
node:letter.getNode(),
y:rect.y
});
if(newLetter&&web.utils.Dom.isAncestor(el.dom,newLetter.getNode())){
result=cursorClick.getIndexByLetter(el.dom,newLetter);
if(result>-1){
this.cursorShow(newLetter,true);
return result
}else{
one.debug('Richtext: Element returned by getIndexByLetter is wrong ('+result+').')
}
}
return null
},
tryForceCursorToLeft:function(el,letter){
var toForce,nextNodeExists=false;
if(!letter.left){
toForce=true;
if(letter.offset===letter.getNode().nodeValue.length-1){
web.utils.Dom.getNextNode(letter.getNode(),el.dom,function(node,isOpenTag){
if(isOpenTag){
nextNodeExists=true;
if(node.nodeType!==3&&Ext.get(node).getStyle('display').indexOf('inline')<0){
toForce=false
}
return'halt'
}
},this);
if(!nextNodeExists){
toForce=false
}
}
if(toForce){
letter.left=true
}
}
},
clearPivot:function(){
this.lastPivotX=null
}
});
web.workspace.text.view.Display=Ext.extend(Object,{
constructor:function(cfg){
this.cursor=new web.workspace.text.view.Cursor({scrollZone:cfg.scrollZone});
this.writer=new web.data.text.HtmlWriter;
delete cfg.scrollZone;
this.set(cfg)
},
set:function(cfg){
Ext.apply(this,cfg||{})
},
refresh:function(){
var el=this.el;
if(el&&el.dom){
this.doc.reset();
this.writer.set({
richtext:this.richtext,
selection:true
});
this.writer.write(this.doc);
el.dom.innerHTML=this.doc.toBodyHTML()
}
},
insertDOMText:function(text,styling){
var letter=this.cursor.letter;
if(letter&&letter.getNode()){
var node=letter.getNode(),offset=letter.offset;
if(offset===0&&letter.left){
var haltAt=[
'P',
'LI',
'H1',
'H2',
'H3',
'H4',
'H5',
'H6'
],textnode=web.utils.Dom.getPrevNode(node,this.el.dom,function(someNode){
if(someNode.nodeType===3){
return'return'
}
if(someNode.nodeName&&haltAt.indexOf(someNode.nodeName)>-1){
return'halt'
}
},this);
if(textnode){
Ext.apply(letter,textnode);
textnode=new web.workspace.text.view.TextNode(textnode);
node=textnode.getNode();
offset=textnode.getNode().nodeValue.length-1;
Ext.apply(letter,{
offset:offset,
left:false
})
}
}
if(!letter.left){
offset+=1
}
var insertSpan=false,style,span;
if(styling&&styling.style&&Object.keys(styling.style).length>0){
style=new web.data.text.Style(Ext.apply({dm:this.doc.dm},styling.style));
span=node.parentNode;
if(span.className.indexOf('editor-buffer')<0){
insertSpan=true
}else{
span.setAttribute('style',style.toCSS())
}
}
if(!insertSpan){
node.nodeValue=node.nodeValue.substr(0,offset)+text+node.nodeValue.substr(offset);
letter.offset+=text.length
}else{
var range=document.createRange();
span=document.createElement('span');
span.className='editor-buffer '+style.getClass(this.doc);
span.setAttribute('style',style.toCSS(this.doc));
span.innerHTML=text;
range.setStart(node,offset);
range.setEnd(node,offset);
range.insertNode(span);
letter.set(span.firstChild);
Ext.apply(letter,{
offset:text.length-1,
left:false
})
}
this.cursor.cursorShow(letter,true);
return true
}
},
removeChar:function(delKey){
var letter=this.cursor.letter;
if(letter&&letter.getNode()){
var node=letter.getNode(),offset=letter.offset,text=node.nodeValue,len=text.length;
if(len>1&&(!delKey&&offset>0||delKey&&offset<len-1)){
if(!letter.left){
offset+=1
}
if(delKey){
var pos=len-1;
if(offset+1<pos){
pos=offset+1
}
node.nodeValue=text.substr(0,offset)+text.substr(pos)
}else{
node.nodeValue=text.substr(0,offset-1)+text.substr(offset);
letter.offset-=1;
letter.index-=1
}
this.cursor.cursorShow(letter,true);
return true
}else{
return false
}
}
}
});
web.workspace.text.editor.Editor=Ext.extend(Ext.util.Observable,{
focusCls:'',
isActive:false,
constructor:function(cfg){
this.scrollZone=Ext.getBody();
this.el=Ext.get(Ext.DomHelper.append(this.scrollZone,{}));
this.display=new web.workspace.text.view.Display({scrollZone:this.scrollZone});
this.handlers={};
this.initKeypress();
this.initCursor();
this.initBuffer();
this.initSelection();
this.initAspects();
Ext.iterate(this.handlers,function(key,func){
this.handlers[key]=func.createDelegate(this)
},this);
this.addEvents('inserttext','removetext','replacetext','selecttext','click','refresh','visible','hidden','stylepara');
this.listeners=cfg.listeners;
web.workspace.text.editor.Editor.superclass.constructor.call(this)
},
getHeight:function(){
return this.el.getHeight()
},
activate:function(cfg){
if(this.hasOwnProperty('focusCls')){
delete this.focusCls
}
Ext.apply(this,cfg);
if(!this.richtext){
return
}
this.el.appendTo(this.scrollZone);
this.display.cursor.appendTo(this.scrollZone);
this.editCls=Ext.isString(this.editCls)?this.editCls:'x-form-text';
this.baseCls=this.baseCls||'one-rte-';
this.cls='one-rte '+this.editCls;
this.el.dom.className=this.cls;
this.data=this.richtext?this.richtext instanceof web.data.text.Richtext?this.richtext.toJSON():this.richtext:{};
this.data.baseCls=this.baseCls;
this.data.editMode=true;
this.richtext=new web.data.text.Richtext(Ext.apply({parent:this.richtext?this.richtext.parent:null},this.data));
delete this.data;
this.isActive=true;
this.activateKeys();
this.activateSelection();
var doc=new web.Document({
dm:this.app.dm,
domain:this.app.dal.domain,
editMode:true
});
this.display.set({
doc:doc,
el:this.el,
richtext:this.richtext
});
this.show(true);
this.refreshView();
if(cfg.selectConfig&&cfg.selectConfig.event){
this.mouseActive=true;
this.mouseup(cfg.selectConfig.event);
this.showCursor()
}else{
this.to(this.richtext.findValidCursorIndex(0))
}
this.focus()
},
deactivate:function(){
if(this.isActive){
this.flushBuffer();
this.deactivateKeys();
this.deactivateSelection();
this.hide();
this.blur();
this.isActive=false;
this.rendered=false
}
},
update:function(richtext){
if(this.isActive){
if(this.buffer.length()){
this.flushBuffer();
return
}
this.setRichtext(richtext);
this.selectedBlock=null;
this.refreshView();
this.fixCursor();
this.clearPreselectedStyles()
}
},
setRichtext:function(richtext){
this.richtext=richtext;
this.display.set({richtext:this.richtext});
richtext.baseCls=this.baseCls
},
show:function(dontFocus){
if(this.el.dom&&this.isActive){
this.el.dom.style.display='block';
this.capture.dom.style.display='block';
this.isHidden=false;
if(!dontFocus){
this.focus()
}
this.fireEvent('visible')
}
},
hide:function(){
if(this.el.dom&&this.isActive){
this.isHidden=true;
this.blur();
this.capture.dom.style.display='none';
this.el.dom.style.display='none';
this.fireEvent('hidden')
}
},
beforeDestroy:function(){
this.rendered=false
},
onDestroy:function(){
this.deactivate();
this.display.cursor.remove();
this.capture.remove();
this.el.remove()
},
refresh:function(index){
this.display.refresh();
if(!Ext.isNumber(index)){
index=this.getCursorIndex()
}
this.placeCursorByIndex(index);
this.fireEvent('refresh',this)
},
refreshView:function(){
this.display.refresh()
}
});
Ext.reg('one-rte-editor',web.workspace.text.editor.Editor);
Ext.override(web.workspace.text.editor.Editor,{
initCursor:function(){
this.cursorIndex=0
},
setCursorIndex:function(index){
if(Ext.isNumber(index)){
this.display.cursor.letter=Ext.apply(this.display.cursor.letter||{},{index:index});
this.cursorIndex=index
}
},
getCursorIndex:function(){
return this.cursorIndex
},
placeCursorByEvent:function(event){
var index=this.display.cursor.placeCursorByEvent(this.el,event);
this.setCursorIndex(index);
return index
},
placeCursorByIndex:function(index){
if(this.el){
var ns=this.display.cursor,letter=ns.getAndCacheLetterByIndex(this.el,index);
if(letter){
this.setCursorIndex(index);
if(this.hasFocus()&&!this.isHidden){
ns.placeCursorByLetter(letter)
}
}else{
one.debug('Richtext: getCaretByIndex is returning garbage ('+letter+')')
}
}
},
showCursor:function(){
this.display.cursor.cursorShow(null,true)
},
hideCursor:function(){
this.display.cursor.cursorHide()
},
cursorNext:function(){
var index=this.richtext.getParaEnd(this.getCursorIndex()+1);
index=index===this.richtext.getText().length?0:index;
this.to(index)
},
cursorBack:function(){
var index=this.getCursorIndex();
index=index?index-1:0;
if(this.ctrl){
index=this.richtext.findPrevWordStart(index)
}else{
index=this.richtext.findValidCursorIndex(index,false)
}
if(index!==null){
this.to(index)
}
},
cursorForward:function(){
var index=this.getCursorIndex(),len=this.richtext.getText().length;
index=index<len?index+1:len;
if(this.ctrl){
index=this.richtext.findNextWordStart(index)
}else{
index=this.richtext.findValidCursorIndex(index)
}
if(index!==null){
this.to(index)
}
},
cursorUp:function(){
var index;
if(this.ctrl){
index=this.richtext.findParaStart(this.getCursorIndex()||0,false)
}else{
index=this.display.cursor.moveUp(this.el)
}
if(index!==null){
this.to(index)
}
},
cursorDown:function(){
var index,len=this.richtext.text.length;
if(this.ctrl){
index=this.getCursorIndex();
index=this.richtext.findParaStart(index===null?len:index,true)
}else{
index=this.display.cursor.moveDown(this.el)
}
if(index!==null){
this.to(index)
}
},
cursorHome:function(){
var index=this.display.cursor.moveToStartOfLine(this.el);
if(index!==null){
this.to(index)
}
},
cursorEnd:function(){
var index=this.display.cursor.moveToEndOfLine(this.el);
if(index!==null){
this.to(index)
}
},
clearUpDownPivot:function(){
this.display.cursor.clearPivot()
},
fixCursor:function(){
var richtext=this.richtext,pos=this.getCursorIndex();
if(pos!==richtext.findValidCursorIndex(pos)){
pos=richtext.findValidCursorIndex(pos);
if(pos===null){
pos=richtext.findValidCursorIndex(this.getCursorIndex(),false)
}
this.to(pos)
}else{
this.placeCursorByIndex(pos);
if(!this.hasFocus()){
this.hideCursor()
}
}
}
});
Ext.override(web.workspace.text.editor.Editor,{
initKeypress:function(){
this.capture=Ext.get(Ext.DomHelper.append(Ext.getBody(),{
tag:'textarea',
cls:'one-rte-capture'
}));
var specialKeys=[
13,
8,
46,
16,
17,
9,
37,
39,
38,
40,
36,
35,
18
];
this.prevCapture='';
this.keyHandlers={
keydown:function(event,key){
if(key&&specialKeys.indexOf(key)!==-1){
this.onKey(event,key)
}
},
keypress:function(event,key){
this.checkForNewChars()
},
keyup:function(event,key){
this.onKeyup(key);
this.checkForNewChars()
}
};
this.initKeyUtils()
},
onFocus:function(focus,oldFocus,eventType){
if(this.isActive){
var capture=this.capture.dom;
if(focus===capture&&!this.isHidden){
this.showCursor()
}else if(this.focusTimer&&this.isValidFocus(focus)){
clearTimeout(this.focusTimer)
}
if(oldFocus===capture){
if(!this.isHidden&&!this.isValidFocus(focus)){
clearTimeout(this.focusTimer);
this.focusTimer=setTimeout(function(){
capture.focus();
return
},0)
}
this.flushBuffer();
this.hideCursor()
}
}
},
activateKeys:function(){
this.capture.addClass(this.focusCls);
this.registerKeyUtil({
keydown:this.keyHandlers.keydown,
keypress:this.keyHandlers.keypress,
keyup:this.keyHandlers.keyup
})
},
deactivateKeys:function(){
this.capture.removeClass(this.focusCls);
this.unregisterKeyUtil()
},
isValidFocus:function(dom){
var name=dom.nodeName.toLowerCase();
return name==='input'||name==='textarea'
},
checkForNewChars:function(){
var captured=this.getCapture(),captureCursor=this.getCaptureCursor();
if(captureCursor.start!==captureCursor.end||captureCursor.end!==captured.length){
this.setCaptureCursor(captured.length)
}
var i,lenPrev=this.prevCapture.length,lenNow=captured.length,found=-1,replace=false;
for(i=0;i<lenPrev&&i<lenNow;i+=1){
if(this.prevCapture[i]!==captured[i]){
found=i;
break
}
}
if(found>-1){
replace=lenPrev-found
}else if(lenPrev<lenNow){
found=lenPrev
}
if(found>-1){
this.onChar(captured.substr(found),replace)
}
this.prevCapture=captured
},
getCapture:function(){
return this.capture.dom.value.replace(/[\n\r]/g,'')
},
getCaptureCursor:function(){
var textarea=this.capture.dom,pos=null;
if(Ext.isNumber(textarea.selectionStart)&&Ext.isNumber(textarea.selectionEnd)){
pos={
start:textarea.selectionStart,
end:textarea.selectionEnd
}
}else if(document.selection){
var range=document.selection.createRange();
var storedRange=range.duplicate();
storedRange.moveToElementText(textarea);
storedRange.setEndPoint('EndToEnd',range);
pos={
start:storedRange.text.length-range.text.length,
end:storedRange.text.length
}
}
return pos
},
setCaptureCursor:function(selectionStart,selectionEnd){
if(!Ext.isDefined(selectionEnd)){
selectionEnd=selectionStart
}
var textarea=this.capture.dom;
if(document.activeElement!==textarea){
textarea.focus()
}
if(textarea.setSelectionRange){
textarea.setSelectionRange(selectionStart,selectionEnd)
}else if(textarea.createTextRange){
var range=textarea.createTextRange();
range.collapse(true);
range.moveEnd('character',selectionEnd);
range.moveStart('character',selectionStart);
range.select()
}
},
cleanCapture:function(){
var value=this.capture.dom.value;
if(value.length>100){
this.capture.dom.value=value.substr(value.length-10);
this.prevCapture=this.getCapture()
}
},
focus:function(){
if(this.isActive&&!this.hasFocus()){
this.capture.focus()
}else{
this.showCursor()
}
},
blur:function(){
if(this.hasFocus()){
this.capture.blur()
}else{
this.hideCursor()
}
},
hasFocus:function(){
return document.activeElement===this.capture.dom
},
typeChar:function(chr){
if(this.getSelStart()!==this.getSelEnd()){
this.replaceChars(chr)
}else{
this.insertChar(chr)
}
},
onChar:function(text,replace){
if(!text||this.ctrl&&!this.alt){
return
}
this.clearUpDownPivot();
var chr=text[text.length-1];
if(chr===13){
return
}
if(Ext.isNumber(replace)){
this.setSelection(this.getSelStart()-replace,this.getSelStart())
}
this.typeChar(text)
},
onKey:function(event,key){
var isRange,block,paraStyle;
isRange=this.getSelStart()!==this.getSelEnd();
block=this.selectedBlock;
if(block){
block.onKey(key);
return
}
if(!(key===38||key===40)){
this.clearUpDownPivot()
}
if(key!==13&&key!==17){
this.clearPreselectedStyles()
}
switch(key){
case 13:
if(this.isList()&&(this.ctrl||this.shift)){
this.typeChar('\n');
this.applyPara({
indent:this.getParaIndent(),
bullet:null,
order:null
})
}else if(this.isList()&&this.richtext.isParaAt(this.getSelStart())&&this.richtext.isParaEndAt(this.getSelStart())){
paraStyle={indent:this.getParaIndent()-1};
if(this.getParaIndent()===1){
paraStyle.bullet=null;
paraStyle.order=null
}
this.applyPara(paraStyle)
}else{
this.typeChar('\n')
}
return;
case 8:
if(isRange){
this.flushBuffer();
this.removeChars()
}else if(this.richtext.isParaAt(this.getSelStart())&&this.getParaIndent()>0){
if(this.isList()){
this.applyPara({
indent:this.getParaIndent(),
bullet:null,
order:null
})
}else{
this.applyPara({indent:this.getParaIndent()-1})
}
event.preventDefault()
}else{
this.removeChar(true)
}
return;
case 46:
if(isRange){
this.flushBuffer();
this.removeChars()
}else{
this.removeChar()
}
return;
case 17:
this.flushBuffer();
return;
case 9:
this.flushBuffer();
if(this.richtext.isTable()){
this.cursorNext()
}else{
this.applyPara({indent:this.getParaIndent()+1})
}
event.preventDefault();
return;
case 37:
this.flushBuffer();
this.cursorBack();
return;
case 39:
this.flushBuffer();
this.cursorForward();
return;
case 38:
this.flushBuffer();
this.cursorUp();
return;
case 40:
this.flushBuffer();
this.cursorDown();
return;
case 36:
this.flushBuffer();
this.cursorHome();
return;
case 35:
this.flushBuffer();
this.cursorEnd();
return
}
},
onKeyup:function(key){
if(key===13){
this.capture.dom.value=this.capture.dom.value.replace(/[\n\r]/g,'')
}
}
});
Ext.override(web.workspace.text.editor.Editor,function(){
var keyHandlers=null;
function ctrlKey(event){
return event.ctrlKey||event.metaKey
}
return{
initKeyUtils:function(){
Ext.apply(this.handlers,{
utilKeydown:this.utilKeydown,
utilKeypress:this.utilKeypress,
utilKeyup:this.utilKeyup,
utilDocKeydown:this.utilDocKeydown,
utilDocKeyup:this.utilDocKeyup
})
},
registerKeyUtil:function(config){
keyHandlers=config;
web.utils.Event.add(this.capture.dom,'keydown',this.handlers.utilKeydown);
web.utils.Event.add(this.capture.dom,'keypress',this.handlers.utilKeypress);
web.utils.Event.add(this.capture.dom,'keyup',this.handlers.utilKeyup);
web.utils.Event.add(document,'keydown',this.handlers.utilDocKeydown);
web.utils.Event.add(document,'keyup',this.handlers.utilDocKeyup)
},
unregisterKeyUtil:function(){
keyHandlers=null;
web.utils.Event.remove(this.capture.dom,'keydown',this.handlers.utilKeydown);
web.utils.Event.remove(this.capture.dom,'keypress',this.handlers.utilKeypress);
web.utils.Event.remove(this.capture.dom,'keyup',this.handlers.utilKeyup);
web.utils.Event.remove(document,'keydown',this.handlers.utilDocKeydown);
web.utils.Event.remove(document,'keyup',this.handlers.utilDocKeyup)
},
utilKeydown:function(event){
var key=event.keyCode;
this.ctrl=ctrlKey(event);
this.shift=event.shiftKey;
this.alt=event.altKey;
if(Ext.isGecko&&key===224||Ext.isWebKit&&(key===91||key===93)){
key=17
}
keyHandlers.keydown.call(this,event,key)
},
utilKeypress:function(event){
var key=event.keyCode;
keyHandlers.keypress.call(this,event,key)
},
utilKeyup:function(event){
var key=event.keyCode;
this.ctrl=ctrlKey(event);
this.shift=event.shiftKey;
this.alt=event.altKey;
if(Ext.isGecko&&key===224||Ext.isWebKit&&(key===91||key===93)){
key=17
}
keyHandlers.keyup.call(this,event,key)
},
utilDocKeydown:function(event){
this.ctrl=ctrlKey(event);
this.alt=event.altKey
},
utilDocKeyup:function(event){
this.ctrl=ctrlKey(event);
this.alt=event.altKey
}
}
}());
Ext.override(web.workspace.text.editor.Editor,{
initSelection:function(){
this.selection={
start:0,
end:0
};
this.activeStart=null;
this.activeEnd=null;
Ext.apply(this.handlers,{
selMousedown:this.mousedown,
selMousemove:this.mousemove,
selMouseup:this.mouseup
});
this.ctrlA=new Ext.KeyMap(document,{
key:'a',
ctrl:true,
alt:false,
shift:false,
fn:this.selectAll,
scope:this
});
this.ctrlA.disable()
},
activateSelection:function(){
var bodyEl=Ext.getBody();
web.utils.Event.add(this.el.dom,'mousedown',this.handlers.selMousedown);
web.utils.Event.add(this.display.cursor.getCursorEl().dom,'mousedown',this.handlers.selMousedown);
web.utils.Event.add(bodyEl.dom,'mousemove',this.handlers.selMousemove);
web.utils.Event.add(bodyEl.dom,'mouseup',this.handlers.selMouseup);
this.ctrlA.enable();
var pos=this.richtext.findValidCursorIndex(0);
this.activeEnd=pos;
this.richtext.position(pos,pos);
this.setSelection(pos,pos)
},
hideSelection:function(){
this.el.addClass('hide-one-rte-selection')
},
showSelection:function(){
this.el.removeClass('hide-one-rte-selection')
},
deactivateSelection:function(){
var bodyEl=Ext.getBody();
web.utils.Event.remove(this.el.dom,'mousedown',this.handlers.selMousedown);
web.utils.Event.remove(this.display.cursor.getCursorEl().dom,'mousedown',this.handlers.selMousedown);
web.utils.Event.remove(bodyEl.dom,'mousemove',this.handlers.selMousemove);
web.utils.Event.remove(bodyEl.dom,'mouseup',this.handlers.selMouseup);
this.ctrlA.disable()
},
isValidMouseTarget:function(el,node){
do{
if(typeof node.className==='string'&&node.className.indexOf('textblock')>-1||node.nodeName==='svg'){
return false
}
node=node.parentNode
}while(node&&node!==el);
return true
},
preventDefault:function(event){
if(event.preventDefault){
event.preventDefault()
}else{
event.returnValue=false
}
},
mousedown:function(e){
e=e||window.event;
if(e.type!=='mousedown'){
return
}
if(e.button===0||Ext.isIE8&&e.button===1){
var target=e.target||e.srcElement;
if(!this.isValidMouseTarget(this.el.dom,target)){
return
}
this.flushBuffer();
var index=this.placeCursorByEvent(e);
this.mouseActive=true;
this.preventDefault(e);
if(index!==null){
this.clearUpDownPivot();
this.clearPreselectedStyles();
if(this.shift){
var end=this.getSelEnd();
this.activeStart=this.activeEnd===end?this.getSelStart():end
}
this.hover(index)
}
this.focus();
this.cleanCapture()
}
},
mousemove:function(e){
e=e||window.event;
var index;
if(this.mouseActive){
var target=e.target||e.srcElement;
if(!this.isValidMouseTarget(this.el.dom,target)){
return
}
this.preventDefault(e);
if(this.activeStart!==null){
index=this.placeCursorByEvent(e);
if(index!==null){
this.hover(index)
}
}
}
},
mouseup:function(e){
e=e||window.event;
if(e.type!=='mouseup'&&e.type!=='click'){
return
}
var index;
if(this.mouseActive&&(e.button===0||Ext.isIE8&&e.button===1)){
var target=e.target||e.srcElement;
if(this.isValidMouseTarget(this.el.dom,target)){
this.preventDefault(e);
index=this.placeCursorByEvent(e);
if(index!==null){
this.activeEnd=index;
this.selectify(false)
}else if(this.isActive&&this.activeStart!==null){
this.selectify(false)
}
}
this.mouseActive=false
}
},
setSelection:function(start,end){
this.selection.start=start<end?start:end;
this.selection.end=start<end?end:start
},
to:function(index,silent){
var s,e;
if(this.shift){
s=this.getSelStart();
e=this.getSelEnd();
this.activeStart=this.activeEnd===e?s:e
}
this.activeEnd=index;
this.placeCursorByIndex(index);
this.selectify(silent,true)
},
selectAll:function(){
if(this.isActive&&document.activeElement===this.capture.dom){
var lastChar=this.richtext.getText().length;
if(this.richtext.isTable()){
lastChar-=1
}
this.position(0,lastChar);
this.activeStart=0;
this.activeEnd=lastChar;
this.placeCursorByIndex(lastChar);
this.selectify(false)
}
},
hover:function(index){
this.activeEnd=index;
this.selectify(true)
},
selectify:function(silent,forceModeZero){
var start,end,as=this.activeStart,ae=this.activeEnd,s=this.getSelStart(),e=this.getSelEnd(),mode=null,result;
if(as===null){
this.activeStart=ae;
as=ae
}
start=Math.min(as,ae);
end=Math.max(as,ae);
if(start!==end&&(s!==start||e!==end)){
mode=0
}else if(start===end){
if(silent){
mode=0
}else{
if(this.clickStart!==start){
this.clickCount=0;
this.clickStart=start
}else{
this.clickCount=(this.clickCount+1)%3
}
mode=this.clickCount
}
}
if(forceModeZero){
mode=0
}
if(mode!==null){
switch(mode){
case 0:
this.position(start,end);
break;
case 1:
result=this.positionWordByIndex(start);
if(result===false){
mode=0;
this.position(start,end)
}
break;
case 2:
this.positionParaByIndex(start);
break
}
while(mode>1&&mode<=2){
if(this.getSelStart()!==s||this.getSelEnd()!==e){
break
}
if(mode===2){
this.positionParaByIndex(start);
this.clickCount=3
}else{
this.position(start,start);
this.clickCount=0
}
mode+=1
}
}
if(!silent){
this.fireEvent('selecttext',this,this.getSelStart(),this.getSelEnd());
this.activeStart=null
}
},
positionWordByIndex:function(index){
var text=this.richtext.text,start=index,end=index,len=text.length,char=/[a-zA-Z0-9\-_]/;
while(text.charAt(start).match(char)&&start>=0){
start-=1
}
start+=1;
while(text.charAt(end).match(char)&&end<len){
end+=1
}
if(start<end){
this.position(start,end)
}
return start<end
},
positionParaByIndex:function(index){
var richtext=this.richtext;
this.position(richtext.getParaStart(index),richtext.getParaEnd(index))
},
positionAll:function(){
this.position(0,this.richtext.text.length)
},
position:function(start,end){
if(this.richtext){
this.richtext.position(start,end);
var prev={
start:this.getSelStart(),
end:this.getSelEnd()
};
this.setSelection(start,end);
if(prev.start!==prev.end||start!==end){
this.refresh()
}
}
},
getStart:function(){
return this.richtext?this.richtext.getStart():0
},
getEnd:function(){
return this.richtext?this.richtext.getEnd():0
},
getSelStart:function(){
return this.selection.start
},
getSelEnd:function(){
return this.selection.end
}
});
Ext.override(web.workspace.text.editor.Editor,{
initAspects:function(){
this.clearPreselectedStyles()
},
setPreselectedStyles:function(cfg){
Ext.iterate(cfg,function(type,val){
this.preselectedStyles[type]=Ext.apply(this.preselectedStyles[type]||{},val)
},this)
},
clearPreselectedStyles:function(){
this.preselectedStyles={}
},
getPreselectedStyles:function(){
return this.preselectedStyles
},
getParaIndent:function(){
var paraStyle=this.richtext.paras.getCurrent()[0];
return paraStyle?paraStyle.getIndent():0
},
isList:function(){
var paraStyle=this.richtext.paras.getCurrent()[0];
return paraStyle?paraStyle.isList():false
},
applyPara:function(para){
this.fireEvent('stylepara',this,para)
},
applyStyle:function(style){
var start=this.getSelStart(),end=this.getSelEnd();
if(start!==end){
this.richtext.styles.insert([
start,
end,
style
])
}else{
this.currentStyle=style
}
}
});
Ext.override(web.workspace.text.editor.Editor,{
initBuffer:function(){
this.buffer=new web.workspace.text.editor.Buffer;
this.bufferDelay=300
},
insertChar:function(chr){
var last=this.buffer.getLastPushed(),obj={
chr:chr,
index:this.getSelStart(),
insertOp:true
};
if(last&&!last.insertOp){
this.buffer.pushToNewQueue(obj)
}else{
this.buffer.push(obj)
}
this.processBuffer()
},
processBuffer:function(flushNow){
if(!this.bufferLock&&this.buffer.hasCurrent()){
var temp=this.buffer.getCurrent(),prev=this.buffer.getFromCurrent(-1),chr=temp.chr,richtext=this.richtext,pos;
this.buffer.moveForward();
if(temp.removeOp){
richtext.removeText(temp.index,temp.index+1);
richtext.position(temp.index,temp.index);
this.setSelection(temp.index,temp.index);
this.activeEnd=temp.index;
this.setCursorIndex(temp.index);
if(!this.display.removeChar(!temp.shift)){
this.refresh(temp.index)
}
if(!temp.shift&&prev){
temp.index=prev.index+1
}
}else{
if(temp.replaceOp){
richtext.replaceText(chr,this.getSelStart(),this.getSelEnd());
pos=this.getSelStart()+chr.length;
richtext.position(pos,pos);
this.setSelection(pos,pos);
this.activeEnd=pos;
this.refresh(pos)
}else{
richtext.insertText(chr,this.selection.start);
pos=this.getSelStart()+chr.length;
var styling=this.getPreselectedStyles();
if(styling){
richtext.position(this.selection.start,pos);
if(styling.style&&Object.keys(styling.style).length>0){
richtext.styles.applyAspect(styling.style)
}
}
richtext.position(pos,pos);
this.setSelection(pos,pos);
this.activeEnd=pos;
this.setCursorIndex(pos);
if(chr!=='\n'){
this.display.insertDOMText(chr,styling)
}else{
this.refresh(pos)
}
}
if(chr==='\n'){
flushNow=true
}
}
window.clearTimeout(this.flushTimer);
if(flushNow){
this.flushBuffer()
}else{
this.flushTimer=window.setTimeout(this.flushBuffer.createDelegate(this),this.bufferDelay)
}
}
},
flushBuffer:function(){
if(!this.bufferLock){
this.bufferLock=true;
window.clearTimeout(this.flushTimer);
this.flushTimer=null;
var buffer=this.buffer,start,end,richtext,text,temp,queue;
while(buffer.length()){
queue=buffer.dequeue();
temp=queue.shift();
text=temp.chr;
if(temp.removeOp){
start=temp.index;
end=temp.index+1;
var last=queue[queue.length-1];
if(last){
if(last.shift){
start=last.index
}else{
end=last.index+1
}
}
this.fireEvent('removetext',this,start,end)
}else if(temp.replaceOp){
richtext=new web.data.text.Richtext({text:temp.chr});
this.fireEvent('replacetext',this,richtext,temp.replaceStart,temp.replaceEnd)
}else{
start=temp.index;
while(queue.length){
temp=queue.shift();
text+=temp.chr
}
end=temp.index;
richtext=new web.data.text.Richtext({text:text});
this.fireEvent('inserttext',this,richtext,start,this.getPreselectedStyles())
}
}
this.bufferLock=false
}
},
removeChar:function(shift){
var richtext=this.richtext,text=richtext.text,index=this.getSelStart();
shift=!!shift;
if(shift&&index===0||!shift&&index===text.length){
return
}
if(shift){
index=richtext.findValidCursorIndex(index-1,false);
if(index!==null&&index!==this.getSelStart()-1){
this.to(index)
}
}else{
index=richtext.findValidCursorIndex(index);
if(index!==null&&index!==this.getSelStart()){
this.to(index)
}
}
if(index===null){
return
}
var last=this.buffer.getLastPushed(),obj={
removeOp:true,
shift:shift,
index:index
};
if(last&&!last.removeOp){
this.buffer.pushToNewQueue(obj)
}else if(last&&last.removeOp&&last.shift!==shift){
this.buffer.pushToNewQueue(obj)
}else{
this.buffer.push(obj)
}
this.processBuffer()
},
removeChars:function(){
var richtext=this.richtext,start=this.getSelStart(),end=this.getSelEnd();
if(start!==end){
richtext.removeText(start,end);
richtext.position(start,start);
this.setCursorIndex(start);
this.fireEvent('removetext',this,start,end)
}
},
replaceChars:function(chr){
var start=this.getSelStart(),end=this.getSelEnd(),obj;
if(start!==end){
obj={
chr:chr,
index:start,
replaceStart:start,
replaceEnd:end,
replaceOp:true
};
this.buffer.pushToNewQueue(obj);
this.processBuffer()
}
}
});
web.workspace.text.editor.Buffer=Ext.extend(Object,{
constructor:function(){
this.buffer=[];
this.pointer=[
-1,
-1
]
},
initQueueIf:function(){
if(this.buffer.length===0){
this.buffer.push([])
}
},
isPointerInit:function(){
return!(this.pointer[0]===-1||this.pointer[1]===-1)
},
initPointerIf:function(){
var notInit=!this.isPointerInit(),len=this.buffer.length;
if(notInit&&len&&this.buffer[len-1].length){
this.pointer=[
len-1,
this.buffer[len-1].length-1
]
}
},
push:function(obj){
this.initQueueIf();
this.buffer[this.buffer.length-1].push(obj);
this.initPointerIf()
},
pushToNewQueue:function(obj){
this.buffer.push([]);
this.buffer[this.buffer.length-1].push(obj);
this.initPointerIf()
},
getLastPushed:function(){
var len1=this.buffer.length,len2;
if(len1>0){
len2=this.buffer[len1-1].length;
if(len2>0){
return this.buffer[len1-1][len2-1]
}
}
return null
},
getCurrent:function(){
if(this.isPointerInit()){
return this.buffer[this.pointer[0]][this.pointer[1]]
}
return null
},
getFromCurrent:function(offset){
var queue,i,j,ret=null;
if(this.isPointerInit()){
i=this.pointer[0];
j=this.pointer[1];
queue=this.buffer[i];
if(queue[j+offset]){
ret=queue[j+offset]
}
}
return ret
},
hasCurrent:function(){
return this.isPointerInit()
},
moveForward:function(){
var i,j,index=null;
if(this.isPointerInit()){
i=this.pointer[0];
j=this.pointer[1];
if(this.buffer[i]&&this.buffer[i][j+1]){
this.pointer=[
i,
j+1
];
index=this.buffer[i][j+1]
}else if(this.buffer[i+1]&&this.buffer[i+1].length){
this.pointer=[
i+1,
0
];
index=this.buffer[i+1][0]
}else{
this.pointer=[
-1,
-1
]
}
}
return index
},
dequeue:function(){
var ret=null,i;
if(this.buffer.length>0){
ret=this.buffer.shift();
if(this.isPointerInit()){
i=this.pointer[0];
if(this.buffer[i-1]){
this.pointer[0]=i-1;
this.pointer[1]=0
}else{
this.pointer=[
-1,
-1
]
}
}
}
return ret
},
length:function(){
return this.buffer.length
},
showContent:function(){
var i,j,len1=this.buffer.length,len2,text='',temp,chr;
for(i=0;i<len1;i+=1){
text+='[';
for(j=0,len2=this.buffer[i].length;j<len2;j+=1){
temp=this.buffer[i][j];
if(temp.removeOp){
chr=temp.shift?'<bkspc>':'<del>'
}else if(temp.chr){
chr=temp.chr
}
text+=chr
}
text+=']'
}
return text
}
});
web.commands.text.ApplyStyle=Ext.extend(web.commands.CompoundCommand,{
constructor:function(cfg){
web.commands.text.ApplyStyle.superclass.constructor.call(this,cfg)
},
execute:function(){
var target=this.target,style=this.style;
this.oldJSON=target.toJSON();
if(this.replace){
target.removeStyles()
}
target.applyStyle(style);
this.updateStyles();
this.newJSON=target.toJSON();
this.executeCommand(new web.commands.text.BBoxAdjust({target:target}));
this.fireEvent('update',target)
},
undo:function(){
var target=this.target,json=this.undone?this.newJSON:this.oldJSON;
target.set(json);
this.undone=!this.undone;
this.updateStyles();
web.commands.text.ApplyStyle.superclass.undo.call(this);
this.fireEvent('update',target)
},
updateStyles:function(){
this.target.getCurrentStyles().forEach(function(style){
this.fireEvent('update',style)
},this)
}
});
web.commands.text.ApplyPara=Ext.extend(web.commands.text.ApplyStyle,{
constructor:function(cfg){
web.commands.text.ApplyPara.superclass.constructor.call(this,cfg)
},
execute:function(){
var target=this.target,style=this.style;
this.oldJSON=target.toJSON();
target.applyPara(style);
this.updateStyles();
this.newJSON=target.toJSON();
this.executeCommand(new web.commands.text.BBoxAdjust({target:target}));
this.fireEvent('update',target)
},
updateStyles:function(){
this.target.getCurrentParas().forEach(function(style){
this.fireEvent('update',style)
},this)
}
});
web.workspace.plugins.RTE=Ext.extend(Ext.util.Observable,{
init:function(workspace){
this.workspace=workspace;
workspace.rte=this;
this.block=null;
this.editor=new web.workspace.text.editor.Editor({
listeners:{
inserttext:this.onInsertText,
removetext:this.onRemoveText,
replacetext:this.onReplaceText,
selecttext:this.onSelectText,
refresh:this.onRefresh,
stylepara:this.onParaStyle,
visible:function(){
this.block.show()
},
hidden:function(){
this.block.hide()
},
scope:this
}
});
this.part=null;
this.fontStyle=null;
this.paraStyle=null;
this.wrappedComponentZIndex={};
workspace.on('render',function(){
this.block=Ext.get(Ext.DomHelper.append(workspace.el,{
id:'workspace-rte',
cls:'workspace-edit'
}));
this.initListeners()
},this)
},
initListeners:function(){
var editor=this.editor,workspace=this.workspace,app=workspace.app,panels=app.panels,el=panels.properties.getEl();
workspace.multiSelect.on('change',function(items){
var part=items.length===1?items[0]:null;
if(this.part!==part&&this.part){
this.deactivateEditor();
this.part=null
}
},this);
app.on('select',function(part,config){
if(this.part!==part&&part instanceof web.data.components.Text){
this.part=part;
this.activateEditor(config)
}
},this);
this.on('select',function(config){
editor.setSelection(config.start,config.end);
if(Ext.isNumber(config.cursorIndex)){
editor.setCursorIndex(config.cursorIndex)
}
},this);
app.on('update',function(part){
if(this.part&&part===this.part&&editor.isActive){
editor.update(this.part.getRichtext().copy());
this.checkStyleChange(editor.getSelStart(),editor.getSelEnd())
}
},this);
app.on('focus',function(focus,oldFocus){
if(this.part){
editor.onFocus(focus,oldFocus)
}
},this);
app.on('dragstart',function(){
this.hideEditor()
},this);
app.on('dragend',function(){
this.showEditor()
},this);
app.on('resize',function(){
if(this.part&&editor.isActive&&!editor.isHidden){
this.activateEditor({})
}
},this);
workspace.on('reflow',function(){
if(this.part){
this.activateEditor(null)
}
},this);
el.on('mousemove',function(event){
if(event.getTarget('.one-color-area')||event.getTarget('.one-color-slider')){
this.editor.hideSelection()
}else{
this.editor.showSelection()
}
},this);
el.on('mouseleave',function(event){
this.editor.showSelection()
},this);
app.on('button',this.onButton,this)
},
activateEditor:function(config){
var workspace=this.workspace,part=this.part,el;
if(part){
el=workspace.getSelfEl(part);
if(el&&web.utils.Dom.elementInDocument(el.dom)){
this.adjustOverlay(el.parent());
el.dom.style.visibility='hidden';
this.wrappedComponentZIndex={};
this.getWrappedComponents().forEach(function(cmp){
var wrappedEl=workspace.getComponentEl(cmp);
this.wrappedComponentZIndex[cmp.id]=wrappedEl.getStyle('z-index');
wrappedEl.setStyle({
'z-index':901,
'pointer-events':'none'
})
}.createDelegate(this));
if(!this.editor.isActive){
this.editor.activate({
app:workspace.app,
scrollZone:this.block,
editCls:el.dom.className+' innerfocusable',
focusCls:'innerfocus',
richtext:part.getRichtext().copy(),
selectConfig:config
});
this.checkStyleChange(this.editor.getSelStart(),this.editor.getSelEnd())
}
}
}
},
getWrappedComponents:function(){
var workspace=this.workspace,partId=this.part.id,items=workspace.app.getModeDoc().getItems(),wrappedComponents=[];
items.forEach(function(item){
var relIn=item.getRelIn();
if(relIn&&relIn.id===partId&&item.getRelPara()){
wrappedComponents.push(item)
}
});
return wrappedComponents
},
deactivateEditor:function(){
if(this.part){
var el=this.workspace.getSelfEl(this.part);
if(el&&web.utils.Dom.elementInDocument(el.dom)){
el.dom.style.removeProperty('visibility')
}
this.getWrappedComponents().forEach(function(cmp){
var wrappedEl=this.workspace.getComponentEl(cmp);
wrappedEl.setStyle({
'z-index':this.wrappedComponentZIndex[cmp.id],
'pointer-events':'auto'
})
}.createDelegate(this));
this.editor.deactivate()
}
},
hideEditor:function(){
if(this.part){
var el=this.workspace.getSelfEl(this.part);
if(el&&web.utils.Dom.elementInDocument(el.dom)){
el.dom.style.removeProperty('visibility')
}
this.editor.hide()
}
},
showEditor:function(){
if(this.part){
var el=this.workspace.getSelfEl(this.part);
if(el&&web.utils.Dom.elementInDocument(el.dom)){
el.dom.style.visibility='hidden'
}
this.editor.show()
}
},
adjustOverlay:function(trackEl){
this.editor.show(true);
var scrollZone=this.workspace.el,relative=scrollZone.getXY(),xy=trackEl.getXY(),dom=this.block.dom;
dom.className='workspace-edit';
dom.style.position='absolute';
dom.style.left=xy[0]-relative[0]+scrollZone.dom.scrollLeft+'px';
dom.style.top=xy[1]-relative[1]+scrollZone.dom.scrollTop+'px';
dom.style.width=trackEl.getStyle('width');
dom.style.height=trackEl.getHeight()?trackEl.getStyle('height'):trackEl.first().getStyle('height');
if(this.editor.hasFocus()){
this.editor.showCursor()
}
},
setPreselectedStyles:function(cfg){
this.editor.setPreselectedStyles(cfg)
},
clearPreselectedStyles:function(){
this.editor.clearPreselectedStyles()
},
getPreselectedStyles:function(){
return this.editor.getPreselectedStyles()
},
onInsertText:function(editor,richtext,start,preselectedStyles){
this.workspace.app.invoker.execute(new web.commands.text.Insert({
target:this.part,
text:richtext.text,
start:start,
styling:preselectedStyles
}))
},
onRemoveText:function(editor,start,end){
this.part.position(start,end);
this.workspace.app.invoker.execute(new web.commands.text.Remove({
target:this.part,
start:start,
end:end
}))
},
onReplaceText:function(editor,richtext,start,end){
this.part.position(start,end);
this.workspace.app.invoker.execute(new web.commands.text.Replace({
target:this.part,
text:richtext.text,
start:start,
end:end
}))
},
onSelectText:function(editor,start,end){
var part=this.part,config={
component:part,
start:start,
end:end
};
part.position(start,end);
this.fireEvent('select',config);
this.checkStyleChange(start,end);
this.onRefresh(editor)
},
onRefresh:function(editor){
var workspace=this.workspace,panelbox=workspace.el.getBox(),height=panelbox.height+panelbox.y,cursorBox=editor.display.cursor.letter.getRect();
if(!cursorBox){
return false
}
if(cursorBox.y>=height-20){
workspace.el.scrollTo('top',workspace.el.getScroll().top+50)
}else if(cursorBox.y-20<=panelbox.y){
workspace.el.scrollTo('top',workspace.el.getScroll().top-50)
}
},
onParaStyle:function(editor,style){
this.workspace.app.invoker.execute(new web.commands.text.ApplyPara({
target:this.part,
style:style
}))
},
checkStyleChange:function(selStart,selEnd){
var part=this.part,app=this.workspace.app,fontStyle=null,paraStyle=null,cellConfig=null;
if(part){
fontStyle=part.getCurrentStyles(selStart,selEnd)[0];
paraStyle=part.getCurrentParas(selStart,selEnd)[0];
cellConfig=part.getCurrentCells(selStart,selEnd)[0]
}
if(fontStyle!==this.fontStyle){
if(fontStyle){
app.properties.fireEvent('select',fontStyle,{aspectType:'style'})
}else if(this.fontStyle){
app.properties.fireEvent('deselect',this.fontStyle,{aspectType:'style'});
fontStyle=null
}
this.fontStyle=fontStyle
}
if(paraStyle!==this.paraStyle){
if(paraStyle){
app.properties.fireEvent('select',paraStyle,{aspectType:'para'})
}else if(this.paraStyle){
app.properties.fireEvent('deselect',this.paraStyle,{aspectType:'para'});
paraStyle=null
}
this.paraStyle=paraStyle
}
if(cellConfig!==this.cellConfig){
if(cellConfig){
app.properties.fireEvent('select',cellConfig,{aspectType:'cell'})
}else if(this.cellConfig){
app.properties.fireEvent('deselect',this.cellConfig,{aspectType:'cell'});
cellConfig=null
}
this.cellConfig=cellConfig
}
}
});
web.workspace.plugins.Dims=Ext.extend(Object,{
init:function(workspace){
this.workspace=workspace;
this.overlay=workspace.overlay;
workspace.dims=this;
this.dims=[];
this.dimMap={};
workspace.on('render',function(){
this.dimsDom=[
0,
1,
2,
3,
4
].map(function(){
return Ext.get(Ext.DomHelper.append(workspace.contentEl,{cls:'web-select-label-resize'}))
})
},this)
},
show:function(dims){
dims=dims||this.dims;
dims.forEach(function(dim,index){
this.showDim(dim,index)
},this)
},
showDim:function(dim,index){
var ix=12,iy=3,ox=ix+1,oy=iy+1,oldDim=dim.id?this.dimMap[dim.id]:null,dimDom=this.dimsDom[index];
if(!oldDim){
dimDom.dom.innerHTML=dim.value;
this.dims.push(dim);
if(dim.id){
this.dimMap[dim.id]=dim
}
}else{
oldDim.show=true;
this.dimMap[dim.id]=dim=Ext.apply(oldDim,dim);
dimDom.dom.innerHTML=dim.value
}
dimDom.setStyle({
top:dim.y-oy+'px',
left:dim.x-ox+'px'
});
if(dim.show===false){
dimDom.hide()
}else if(!dimDom.isShown){
dimDom.show();
dimDom.isShown=true
}
},
hide:function(){
this.hideDims()
},
hideDims:function(){
this.dimsDom.forEach(function(dim){
dim.hide();
dim.isShown=false
});
this.dims=[];
this.dimMap={}
}
});
web.workspace.plugins.RawDecos=Ext.extend(Ext.util.Observable,{
init:function(workspace){
this.workspace=workspace;
this.overlay=workspace.overlay;
this.decos=[];
workspace.on('render',function(){
this.initListeners()
},this)
},
initListeners:function(){
this.workspace.autoAdjust.on('adjust',function(){
if(window.rawDeco){
this.show()
}
},this);
this.workspace.multiSelect.on('multiselect',function(parts){
var part=parts[0];
if(window.rawDeco&&console&&part){
;
;
;
;
;
;
;
}
},this)
},
show:function(){
this.showDecos()
},
showDecos:function(){
var cssTemplate='rgba(204, 51, 51, 0.4)',cssPage='rgba(51, 51, 204, 0.2)',cssTemplateBg='rgba(255, 102, 102, 0.02)',cssPageBg='rgba(102, 102, 255, 0.01)',attr1={
'fill':cssTemplateBg,
stroke:cssTemplate,
'stroke-width':3
},attr2={
'fill':cssPageBg,
stroke:cssPage,
'stroke-width':3
},attr3={
'fill':'rgba(102, 255, 102, 0)',
stroke:'rgba(51, 204, 51, 0)',
'stroke-width':3
},attrTemplateRelTo={
stroke:cssTemplate,
'stroke-width':3
},attrTemplateRelPage={
stroke:cssTemplate,
'stroke-width':7
},attrPageRelTo={
stroke:cssPage,
'stroke-width':3
},paper=this.overlay.paper,workspace=this.workspace,that=this,deskElRegion=workspace.deskEl.getRegion(),innerElRegion=workspace.upperEl.getRegion(),offsetX=innerElRegion.left-deskElRegion.left,offsetY=innerElRegion.top-deskElRegion.top,page=workspace.app.getSelected('page'),template=page.getTemplate(),dm=page.dm,add=function(r,attr){
var offset=0.5;
that.decos.push(paper.rect(r.left+offset+offsetX,r.top+offset+offsetY,Math.max(r.right-r.left-offset*2,2),Math.max(r.bottom-r.top-offset*2,2)).attr(attr))
},addLine=function(p1,p2,attr){
var offset=0.5;
that.decos.push(paper.path('M'+(p1.left+offset+offsetX)+' '+(p1.top+offset+offsetY)+' '+'L'+(p2.left+offset+offsetX)+' '+(p2.top+offset+offsetY)+'z').attr(attr))
};
this.hideDecos();
page.getAllItems().forEach(function(item){
if(item&&item.bbox){
var inPage=item.inPage(),bbox=(item.pbbox?item.pbbox[page.id]:null)||item.bbox,region=workspace.copyRegion(bbox);
add(region,inPage?attr2:attr1);
var relTo=item.getRelTo(),relToCmp,relToRegion;
if(relTo){
relToCmp=dm.get(relTo.id);
if(relToCmp){
relToRegion=workspace.copyRegion(relToCmp.bbox);
addLine({
top:region.top+2,
left:(region.left+region.right)/2
},{
top:relToRegion.bottom-2,
left:(relToRegion.left+relToRegion.right)/2
},inPage?attrPageRelTo:attrTemplateRelTo)
}
}
var relPage=item.getRelPage();
var pageId=page.id;
if(relPage&&relPage[pageId]){
addLine({
top:region.top-relPage[pageId]-2,
left:(region.left+region.right)/2
},{
top:region.top+2,
left:(region.left+region.right)/2
},attrTemplateRelPage)
}
}
},this);
var area=template.getPageArea(page.id),region=workspace.copyRegion(area.bbox);
add(region,attr3);
var relTo=area.relTo,relToCmp,relToRegion;
if(relTo){
relToCmp=dm.get(relTo.id);
if(relToCmp){
relToRegion=workspace.copyRegion(relToCmp.bbox);
addLine({
top:region.top+2,
left:(region.left+region.right)/2
},{
top:relToRegion.bottom-2,
left:(relToRegion.left+relToRegion.right)/2
},attr3)
}
}
},
hide:function(){
this.hideDecos()
},
hideDecos:function(){
this.decos.forEach(function(deco,index){
try{
deco.hide();
deco.remove()
}catch(e){
}
},this);
this.decos=[]
}
});
web.workspace.plugins.AutoScrollAbstract=Ext.extend(Ext.util.Observable,{
frameRate:20,
acceleration:0.2,
prevXY:[
0,
0
],
scrollMax:Infinity,
constructor:function(config){
this.addEvents('scroll');
web.workspace.plugins.AutoScrollAbstract.superclass.constructor.call(this,config)
},
getScrollEl:function(){
throw new Error('Method should be overridden')
},
getScrollViewEl:function(){
throw new Error('Method should be overridden')
},
animate:function(){
var down=this.downSpeed,right=this.rightSpeed,scrollEl=this.getScrollEl(),scroll,scrollRight,scrollTop;
if(down||right){
scroll=scrollEl.getScroll();
if(down){
scrollTop=Math.min(scroll.top+down,this.scrollMax);
scrollEl.scrollTo('top',scrollTop);
this.downSpeed+=this.acceleration*(down<0?-1:1)
}
if(right){
scrollRight=scroll.left+right;
scrollEl.scrollTo('left',scrollRight);
this.rightSpeed+=this.acceleration*(right<0?-1:1)
}
this.fireEvent('scroll',{
top:scrollTop,
left:scrollRight,
event:this.moveEvent
})
}
this.animateTimer=this.animate.defer(this.frameRate,this)
},
onMousemove:function(e,t,mouseXY){
var cp=web.utils.Dom.copyRegion,region=this.getScrollViewEl().getRegion(),width=region.right-region.left,height=region.bottom-region.top,innerSpace=100,xSpace=Math.min(Math.floor(width/3),innerSpace),ySpace=Math.min(Math.floor(height/3),innerSpace),mouseX=mouseXY[0],mouseY=mouseXY[1],change={
x:mouseX-this.prevXY[0],
y:mouseY-this.prevXY[1]
},inside=cp(region,ySpace,xSpace,-ySpace,-xSpace),speed=3,point=new Ext.lib.Point(mouseX,mouseY);
if(!inside.contains(point)){
if(change.y){
if(cp(region,0,0,ySpace-height,0).contains(point)){
this.downSpeed=-speed
}else if(cp(region,height-ySpace,0,0,0).contains(point)){
this.downSpeed=speed
}else{
this.downSpeed=0
}
}
if(change.x){
if(cp(region,0,0,0,xSpace-width).contains(point)){
this.rightSpeed=-speed
}else if(cp(region,0,width-xSpace,0,0).contains(point)){
this.rightSpeed=speed
}else{
this.rightSpeed=0
}
}
}else{
this.downSpeed=0;
this.rightSpeed=0
}
this.prevXY=mouseXY;
this.moveEvent=e
}
});
web.workspace.plugins.AutoScroll=Ext.extend(web.workspace.plugins.AutoScrollAbstract,{
init:function(workspace){
this.workspace=workspace;
workspace.autoScroll=this;
this.setup()
},
setup:function(){
this.workspace.on('render',function(){
this.initListeners();
clearTimeout(this.animateTimer);
this.animate()
},this)
},
getScrollEl:function(){
return this.workspace.el
},
getScrollViewEl:function(){
return this.workspace.el
},
initListeners:function(){
var workspace=this.workspace,isDown=false,onStart=function(){
isDown=true
},onMove=function(e,t){
if(isDown||workspace.isActive(workspace.select)){
this.onMousemove(e,t,e.getXY())
}
},onStop=function(e,t){
setTimeout(function(){
isDown=false;
this.downSpeed=0;
this.rightSpeed=0
}.createDelegate(this),50)
};
workspace.mon(workspace.el,'mousedown',function(e){
if(e.getTarget('.web-resize')||e.getTarget('.web-edge')){
onStart()
}
},this);
workspace.on('afterlayout',function(){
workspace.mon(workspace.deskEl,'mousemove',onMove,this);
workspace.mon(workspace.fillersEl,'mousemove',onMove,this)
},this);
web.ui.onMouseup(onStop,this);
workspace.app.on('dragstart',onStart,this);
workspace.app.on('dragend',onStop,this)
}
});
web.workspace.plugins.ToolTip=Ext.extend(Object,{
init:function(workspace){
this.workspace=workspace;
workspace.tooltip=this;
this.clickMenuItem='Edit these menu items by editing your pages to the left.';
this.clickMaskedTemplate='Click "Edit Template" to edit this part of your website.';
this.clickMaskedPage='Click "Edit Page" to edit this part of your website.';
this.hoverMaskedTemplate='Drag component here to add it to this page only.';
this.hoverMaskedPage='Drag component here to add it to all pages using this template.';
this.hoverTemplate=this.hoverMaskedPage;
this.hoverEmptyMenu=function(a0){
return'No menu items to show. This menu will only show items when you select a page on level '+a0+' that has subpages.'
};
this.firstTimeHoverEdgeResize='Drag the <b>space adjuster</b> down to quickly add space for new components.';
workspace.on('render',function(){
this.initListeners();
this.render()
},this)
},
render:function(){
var tooltip=this.tooltip=new Ext.ToolTip({
target:this.workspace.el,
trackMouse:true,
showDelay:0,
dismissDelay:0
});
tooltip.show=this.tooltip.show.createSequence(function(){
if(!tooltip.body.dom.innerHTML){
tooltip.hide()
}
},this)
},
initListeners:function(){
var workspace=this.workspace;
workspace.el.on('click',function(event,node){
var tooltip=this.tooltip,region=workspace.baseEl.getRegion(),component=workspace.getElComponent(node),inPage,tip=null,that=this;
if(tooltip){
inPage=workspace.app.inPageMode();
if(region.contains(new Ext.lib.Point(event.getXY()))){
if(inPage&&event.getTarget('.web-modemask-template')){
tip=this.clickMaskedTemplate
}else if(!inPage&&event.getTarget('.web-modemask-page')){
tip=this.clickMaskedPage
}else if(component){
if(inPage&&!component.inPage()){
tip=this.hoverMaskedTemplate
}else if(!inPage&&component.inPage()){
tip=this.clickMaskedPage
}else if(component instanceof web.data.components.Menu&&event.getTarget('li')){
tip=this.clickMenuItem
}else if(!inPage){
tip=this.hoverTemplate
}
}
}
if(tip&&!this.isHidden){
this.isClicked=true;
tooltip.body.dom.innerHTML=tip;
tooltip.show();
window.clearTimeout(this.clickedTimer);
this.clickedTimer=window.setTimeout(function(){
that.isClicked=false
},1000)
}
}
},this);
workspace.el.on('mousemove',function(event,node){
var tooltip=this.tooltip,region,component,inPage,tip;
if(tooltip&&tooltip.rendered){
region=workspace.getBaseElRegion();
tip=null;
if(!this.isClicked){
component=workspace.getElComponent(node);
if(component&&region.contains(new Ext.lib.Point(event.getXY()))){
inPage=workspace.app.inPageMode();
if(inPage&&!component.inPage()){
tip=this.hoverMaskedTemplate
}else if(!inPage&&component.inPage()){
tip=this.hoverMaskedPage
}else if(component instanceof web.data.components.Menu&&workspace.getSelfEl(component)&&!workspace.getSelfEl(component).dom.innerHTML.trim()){
tip=this.hoverEmptyMenu(component.getLevel()-1)
}else if(!inPage){
tip=this.hoverTemplate
}
}else if(Ext.get(event.getTarget()).hasClass('web-edge')){
tip=this.firstTimeHoverEdgeResize
}
if(tip&&!this.isHidden){
tooltip.body.dom.innerHTML=tip;
tooltip.show()
}else if(!tooltip.hidden){
tooltip.body.dom.innerHTML='';
tooltip.hide()
}
}else{
tooltip.show()
}
}
},this);
workspace.el.on('mousedown',this.hide,this);
web.ui.onMouseup(this.show,this);
workspace.app.on('dragstart',this.hide,this);
workspace.app.on('dragend',this.show,this)
},
show:function(){
this.isHidden=false
},
hide:function(){
this.isHidden=true;
this.tooltip.hide()
}
});
web.ui.ProgressBar=Ext.extend(Object,{
constructor:function(config){
this.positionReferenceElements=config.positionReferenceElements||[];
this.html='<div class="progressWrapper">'+'<div class="progress"></div>'+'<div class="progressMessageWrapper">'+'<div class="errorIcon"></div>'+'<div class="progressMessage"></div>'+'</div>'+'</div>';
Ext.apply(this,config)
},
show:function(opts){
var ui=this.ui;
if(!ui){
ui=this.ui=oneJQuery(this.html).appendTo(document.body).hide();
this.progressEle=ui.find('.progress');
this.messageWrapperEle=ui.find('.progressMessageWrapper');
this.messageEle=ui.find('.progressMessage');
this.errorEle=ui.find('.progressMessageWrapper .errorIcon').hide()
}
if(opts.error){
ui.addClass('error');
this.progressEle.addClass('error');
this.messageWrapperEle.addClass('error');
this.messageEle.addClass('error');
this.errorEle.show()
}else{
ui.removeClass('error');
this.progressEle.removeClass('error');
this.messageWrapperEle.removeClass('error');
this.messageEle.removeClass('error');
this.errorEle.hide()
}
this.messageEle.html(opts.msg);
ui.show();
this.fixLocation();
if(opts.startProgress){
this.progressCompleted=false;
var that=this;
setTimeout(function(){
for(var i=0;i<=99;i++){
(function(){
var ii=i;
setTimeout(function(){
if(!that.progressCompleted){
that.updateProgressBar(ii);
if(opts.appendProgressPercentage){
that.appendProgressPercentage(opts.msg,ii)
}
}
},ii*40)
}())
}
},10)
}
},
fixLocation:function(){
var refObj=this.positionReferenceElements.find(function(ref){
return oneJQuery(ref.cls).is(':visible')
});
if(refObj){
var ref=oneJQuery(refObj.cls);
var refPos=ref.offset();
var ui=this.ui;
switch(refObj.position){
case'center':
ui.css({
'left':refPos.left+(ref.outerWidth()-ui.outerWidth())/2+'px',
'top':refPos.top+(ref.outerHeight()-ui.outerHeight())/2+'px'
});
break;
case'below':
ui.css({
'left':refPos.left+(ref.outerWidth()-ui.outerWidth())/2+'px',
'top':refPos.top+ref.outerHeight()+10+'px'
});
break
}
}
},
updateProgressBar:function(percentage){
if(this.progressEle){
this.progressEle.css('left',percentage+'%')
}
},
appendProgressPercentage:function(msg,percentage){
if(this.messageEle){
this.messageEle.html(msg+percentage+'%')
}
},
clearProgress:function(){
this.progressCompleted=true;
this.updateProgressBar(0)
},
completeProgress:function(msg){
this.progressCompleted=true;
this.updateProgressBar(100);
if(msg){
this.appendProgressPercentage(msg,100)
}
},
hide:function(){
var ui=this.ui;
if(ui){
this.progressCompleted=true;
this.ui.remove();
this.progressEle=null;
this.messageEle=null;
this.ui=null
}
}
});
web.windows.AviaryImageEditor=Ext.extend(web.windows.Window,{
xtype:'web-windows-aviary',
type:'web.windows.aviary',
cls:'web-windows-aviary',
title:'Edit image',
modal:true,
resizable:false,
multiSelect:false,
editedImageNameSuffix:'_edited',
contentTypeFilter:/image\/(?:gif|png|jpg|jpeg|x-icon|vnd.microsoft.icon)/,
temporaryImageTagId:'aviary-temp-img',
apiKey:'947c52b7-a552-42ae-9140-d5c8db849e27',
constructor:function(config){
config=config||{};
this.width=900;
this.height=600;
this.addEvents({
'imagesaved':true,
'close':true,
'cancel':true
});
this.featherEditor=null;
var waitThrobber=Aviary.ControlsWidget.prototype.waitThrobber;
Object.defineProperty(Aviary.ControlsWidget.prototype,'waitThrobber',{
get:function(){
if(waitThrobber){
return waitThrobber
}else{
waitThrobber=this.waitThrobber=new Aviary.Spinner({
className:'avpw_canvas_spinner',
lines:12,
length:6,
width:2,
radius:6,
color:'#fff',
speed:0.5,
trail:70
});
return waitThrobber
}
}
});
web.windows.AviaryImageEditor.superclass.constructor.call(this,config)
},
initComponent:function(){
this.items=[{
xtype:'box',
width:this.width,
height:this.height,
ref:'aviaryWrapper'
}];
web.windows.AviaryImageEditor.superclass.initComponent.apply(this,arguments)
},
setValues:function(cfg){
cfg=cfg||{};
this.asset=cfg.asset
},
getProgress:function(){
if(this.progressBar){
return this.progressBar
}
this.progressBar=new web.ui.ProgressBar({
positionReferenceElements:[
{
cls:'.avpw_canvas_spinner',
position:'below'
},
{
cls:'.avpw_canvas_background',
position:'center'
},
{
cls:'.web-windows-aviary',
position:'center'
}
]
});
return this.progressBar
},
onShow:function(){
this.app.track([
'Aviary',
'open'
]);
this.openEditor()
},
hide:function(afterSave){
this.getProgress().hide();
if(this.featherEditor){
this.featherEditor.close()
}
web.windows.AviaryImageEditor.superclass.hide.apply(this,arguments);
this.fireEvent(afterSave?'close':'cancel')
},
openEditor:function(){
if(!window.Aviary){
this.getProgress().show({
msg:'An unexpected error occurred. Please reload Website Builder or contact our support for further assistance.',
error:true
});
return
}
this.getProgress().show({msg:'Loading image...'});
var featherEditor=this.featherEditor;
var location,domain,basePath;
location=window.location;
domain=this.app.workspace.app.dal.domain;
basePath='/api/v1/'+domain;
var url=this.asset.getURL();
var isRepositoryImage=url.match(/^repository/);
var publicURL=isRepositoryImage?location.origin+'/api/v1/'+'repository/webspace'+url.replace(/^repository:/,''):'http://'+domain+url.replace(/^webspace:/,'');
var loadEditor=function(){
var that=this;
if(featherEditor){
featherEditor.launch({
image:that.temporaryImageTagId,
hiresUrl:publicURL,
url:publicURL
})
}else{
featherEditor=this.featherEditor=new Aviary.Feather({
onLoad:function(){
featherEditor.launch({
image:that.temporaryImageTagId,
hiresUrl:publicURL,
url:publicURL
})
},
onReady:function(){
that.getProgress().hide();
that._addAviaryListeners()
},
appendTo:this.aviaryWrapper.el.id,
noCloseButton:true,
theme:'minimum',
language:this.getLanguage(),
displayImageSize:true,
tools:'enhance,effects,frames,orientation,crop,lighting,color,sharpness,focus,vignette,whiten,text,meme,overlays,stickers',
apiKey:'b82599dd73ee499f892a9cb6e5b7eb87',
authenticationURL:basePath+'/aviary',
onSaveButtonClicked:function(){
featherEditor.showWaitIndicator();
that.getProgress().show({msg:'Processing...'});
featherEditor.saveHiRes();
return false
},
onError:function(errorObj){
featherEditor.hideWaitIndicator();
that.getProgress().show({
msg:'An unexpected error occurred. Please reload Website Builder or contact our support for further assistance.',
error:true
});
one.fatal('Aviary Error [PublicUrl:'+publicURL+'] [Asset url:'+url+']',errorObj)
},
onSaveHiRes:function(imageID,newURL){
that.app.track([
'Aviary',
'save'
]);
featherEditor.showWaitIndicator();
that.getProgress().show({
msg:'Saving...',
startProgress:true,
appendProgressPercentage:true
});
that.saveImage(newURL)
},
onClose:function(isDirty){
that.getProgress().hide();
oneJQuery('#'+that.temporaryImageTagId).remove()
}
})
}
}.bind(this);
oneJQuery('<img/>').load(loadEditor).attr('id',this.temporaryImageTagId).attr('src',this.asset.getRelativeUrl(basePath)+'?etag='+encodeURIComponent(this.asset.etag)).appendTo(document.body).hide()
},
_addAviaryListeners:function(){
if(this._aviaryListenersAdded){
return
}
oneJQuery('.avpw #avpw_controlpanel_overlays .avpw_content_packs').on('click',function(e){
var target=oneJQuery(e.target);
var categoryEle=oneJQuery(target).closest('.avpw_isa_control_selector_stickerpack');
if(categoryEle.length){
setTimeout(function(){
var dataPackIndex=categoryEle.attr('data-pack-index');
if(dataPackIndex==='0'){
oneJQuery('.avpw #avpw_controlpanel_overlays .avpw_content_items').addClass('webEditor_aviary_overlays')
}else{
oneJQuery('.avpw #avpw_controlpanel_overlays .avpw_content_items').removeClass('webEditor_aviary_overlays')
}
},50)
}
});
this._aviaryListenersAdded=true
},
getLanguage:function(){
var id=one.locale.id;
var lg=id==='en_us'||id==='en_gb'?'en':id;
if(lg==='nb'){
lg='no'
}
return lg
},
saveImage:function(newImageUrl){
var fileInfo=this.getFileInfo(this.asset);
this.getNewImageFullPath(fileInfo,function(newImageFullPath){
this.app.workspace.app.dal.uploadToWebspace(newImageUrl,newImageFullPath,null,{
onComplete:function(opts,success,response){
if(!success||!response.responseText){
this.getProgress().clearProgress();
this.getProgress().show({
msg:'The network is down or our servers are unreachable.'+'<br/>'+'Please try again later or contact our support for further assistance.',
error:true
});
this.featherEditor.hideWaitIndicator()
}else{
this.getProgress().completeProgress('Saving...');
var data=Ext.decode(response.responseText);
var asset=this.app.dm.create(Ext.applyIf({
url:'webspace:'+newImageFullPath,
type:'web.data.assets.Image'
},data));
this.fireEvent('imagesaved',asset);
setTimeout(function(){
this.getProgress().hide();
this.hide(true)
}.bind(this),200)
}
}
},this)
}.bind(this))
},
getNewImageFullPath:function(fileInfo,cb){
this._getWebspaceContent(fileInfo.dir,function(entries){
if(entries){
var maxFileNumber=0;
var fileName=fileInfo.name;
var hasEditedImageNameSuffix=/_edited\d*$/.test(fileName);
var fileNameWithoutNumberSuffix=hasEditedImageNameSuffix?fileName.replace(/\d*$/g,''):fileName+this.editedImageNameSuffix;
var regex=new RegExp('^'+fileNameWithoutNumberSuffix+'(\\d*).'+fileInfo.extn+'$','g');
entries.forEach(function(entry){
if(this.contentTypeFilter.test(entry.contentType)){
var match=regex.exec(entry.href);
if(match){
var num=parseInt(match[1]);
if(!isNaN(num)&&num>maxFileNumber){
maxFileNumber=num
}
}
}
regex.lastIndex=0
},this);
cb(this._getNewImageName(fileInfo,maxFileNumber+1))
}
}.bind(this))
},
getFileInfo:function(asset){
var imageName=asset.getFilename();
var dotIdx=imageName.lastIndexOf('.');
var url=asset.getURL();
var fullPath=url.replace(/^(webspace|repository):/,'');
var lastSlashIdx=fullPath.lastIndexOf('/');
var extn=imageName.substring(dotIdx+1);
if(extn==='gif'){
extn='png'
}
var dir=fullPath.substring(0,lastSlashIdx+1)||'/';
if(url.match(/^repository/)){
dir+='onewebmedia/'
}
return{
dir:dir,
name:imageName.substring(0,dotIdx),
extn:extn
}
},
_getNewImageName:function(fileInfo,newId){
var imageName=fileInfo.name;
if(imageName.indexOf(this.editedImageNameSuffix)>-1){
imageName=imageName.replace(/(\d+)$/,newId)+'.'+fileInfo.extn
}else{
imageName=imageName+this.editedImageNameSuffix+newId+'.'+fileInfo.extn
}
return fileInfo.dir+imageName
},
_getWebspaceContent:function(directory,cb){
this.app.dal.getWebspaceContent(directory,function(opts,success,result){
if(!success||!result.responseText){
this.getProgress().clearProgress();
this.getProgress().show({
msg:'The network is down or our servers are unreachable.'+'<br/>'+'Please try again later or contact our support for further assistance.',
error:true
});
this.featherEditor.hideWaitIndicator()
}else{
cb(Ext.decode(result.responseText).entries)
}
},this)
}
});
Ext.ComponentMgr.registerType('web-windows-aviary',web.windows.AviaryImageEditor);
var tag=document.createElement('script');
tag.src=window.location.protocol+'//dme0ih8comzn4.cloudfront.net/imaging/v3/editor.js';
document.body.appendChild(tag);
web.workspace.plugins.SelectImage=Ext.extend(web.workspace.plugins.SelectDecorator,{
onRender:function(){
var workspace=this.workspace,paper=workspace.overlay.paper,app=workspace.app;
workspace.selectImage=this;
this.svgLines={
vertical:paper.path('M0,0').attr({
'stroke':'rgba(101, 101, 167, 1)',
'stroke-width':1
}),
horizontal:paper.path('M0,0').attr({
'stroke':'rgba(101, 101, 167, 1)',
'stroke-width':1
})
};
this.svgLines.vertical.hide();
this.svgLines.horizontal.hide();
if(!this.backdropEl){
this.backdropEl=Ext.get(Ext.DomHelper.append(workspace.contentEl,{
tag:'img',
cls:'selectimage-backdrop'
}));
var img=this.backdropEl.dom;
img.style.zIndex=5200;
img.style.position='absolute';
img.style.opacity='0.3';
img.style.pointerEvents='none';
if(Ext.isIE9||Ext.isIE10){
img.style.display='none'
}
}
if(!this.uiControls){
this.uiControls=new Ext.Panel({
width:76,
height:23,
renderTo:this.workspace.contentEl,
cls:'selectimage-ui-controls',
style:{
zIndex:Number(this.backdropEl.dom.style.zIndex)+1,
position:'absolute'
},
layout:'hbox',
items:[
{
xtype:'button',
cls:'translucent',
iconCls:'icon icon-edit',
scale:'small',
angle:270,
handler:this.openAviary,
scope:this
},
{
xtype:'spacer',
width:5
},
{
xtype:'button',
cls:'translucent',
iconCls:'icon icon-rotate-left-new',
scale:'small',
angle:270,
handler:this.rotateButtonHandler,
scope:this
},
{
xtype:'spacer',
width:5
},
{
xtype:'button',
cls:'translucent',
iconCls:'icon icon-rotate-right-new',
scale:'small',
angle:90,
handler:this.rotateButtonHandler,
scope:this
}
]
})
}
this.componentType=web.data.components.resources.Image;
app.on('select',function(part,config){
if(this.part!==part&&part instanceof this.componentType){
this.part=part;
this.activatePlugin(part)
}
},this);
workspace.multiSelect.on('change',function(items){
var part=items.length===1?items[0]:null;
if(this.part!==part&&this.part){
this.deactivatePlugin(this.part);
this.part=null
}
},this);
app.on('dragging',function(component,changes){
if(component instanceof web.data.components.resources.Image){
this.updateBackdropAndLines(component,changes)
}
},this);
app.on('update',function(){
if(this.isActive()){
var that=this,me=that,c=this.part;
setTimeout(function(){
me.applyUrlAndRotate(c);
me.updateBackdropAndLines(c,{mode:'paint'});
me.repositionUIControls()
},300);
setTimeout(function(){
if(me.isActive()){
me.applyDragDropForPan(me.part)
}
},50)
}
},this)
},
activatePlugin:function(component){
var that=this,plugin=that;
this.deactivatePlugin(component);
this.applyUrlAndRotate(component);
this.setBackdropVisibility(this.isActive());
this.updateBackdropAndLines(component,{mode:'paint'});
if(this.isActive()){
this.uiControls.show()
}else{
this.uiControls.hide()
}
this.repositionUIControls();
if(!this.cleanupHackId){
this.cleanupHackId=setInterval(function(){
if(!plugin.isActive()){
clearInterval(plugin.cleanupHackId);
plugin.cleanupHackId=null;
plugin.deactivatePlugin(component);
plugin.part=null
}
},500)
}
this.applyDragDropForPan(component)
},
applyDragDropForPan:function(component){
var extel=Ext.get('image-'+component.getId()),ddGroup='ddgroup-'+component.getId(),cursor,that=this,plugin=that;
if(component.scaleStrategyObj.features.dragging){
cursor=this.changeMousePointer(component);
if(cursor){
this.dd=new Ext.dd.DD(extel,ddGroup,{scroll:false})
}
Ext.apply(this.dd,{
hasOuterHandles:true,
range:function(x,min,max){
var value=x<min?min:x>max?max:x;
value=value.toFixed(2)-0;
return value
},
getDragPositionPx:function(){
var asset=plugin.component.asset;
if(!asset){
return null
}
var scale=plugin.component.getScale(),style=extel.dom.style,w,h,top,left;
w=asset.width*scale;
h=asset.height*scale;
top=Number(style.top.replace('px',''));
left=Number(style.left.replace('px',''));
if(plugin.component.rotation%180===90){
top+=h/2-w/2;
left+=w/2-h/2
}
return{
top:top,
left:left
}
},
startDrag:function(x,y){
if(!plugin.component.asset){
plugin.dd.endDrag()
}
var style=extel.dom.style,top,left;
style.position='relative';
top=style.marginTop.replace(/px/,'');
left=style.marginLeft.replace(/px/,'');
style.top=top+'px';
style.left=left+'px';
style.marginTop='0px';
style.marginLeft='0px';
plugin.enableGuideLines(true);
plugin.updateBackdropAndLines(component,{mode:'dragdrop'})
},
onDrag:function(e){
var asset=plugin.component.asset,scale=plugin.component.getScale(),w,h,rotatedW,rotatedH,pospx,style=extel.dom.style;
if(asset){
w=asset.width*scale;
h=asset.height*scale;
pospx=this.getDragPositionPx();
if(plugin.component.rotation%180===90){
rotatedW=h;
rotatedH=w
}else{
rotatedW=w;
rotatedH=h
}
pospx.top=this.range(pospx.top,plugin.component.getInnerHeight()-rotatedH,0);
pospx.left=this.range(pospx.left,plugin.component.getInnerWidth()-rotatedW,0);
if(plugin.component.rotation%180===90){
pospx.top+=-h/2+w/2;
pospx.left+=-w/2+h/2
}
style.top=pospx.top+'px';
style.left=pospx.left+'px';
pospx.mode='dragdrop';
if(plugin.component.rotation%180===90){
pospx.top+=h/2-w/2;
pospx.left+=w/2-h/2
}
plugin.updateBackdropAndLines(component,pospx)
}
},
endDrag:function(e){
var pospx;
pospx=this.getDragPositionPx();
if(pospx){
plugin.enableGuideLines(false);
plugin.workspace.dims.hide();
plugin.applyChanges({
cropTop:-pospx.top,
cropLeft:-pospx.left
})
}else{
plugin.workspace.app.fireEvent('update',plugin.component)
}
},
scope:this
})
}
},
deactivatePlugin:function(component){
var extel=component&&Ext.get('image-'+component.getId());
if(this.dd){
this.dd.unreg()
}
if(extel){
extel.dom.style.cursor='inherit'
}
this.setBackdropVisibility(false);
this.uiControls.hide()
},
repositionUIControls:function(){
var region=this.getRegion(),uidiv=this.uiControls.el.dom,padding=5;
uidiv.style.top=region.top+padding+'px';
uidiv.style.left=region.right-this.uiControls.width-padding+'px'
},
changeMousePointer:function(component){
var c=component,extel=Ext.get('image-'+c.getId()),el=extel&&extel.dom,aw=Math.round(c.asset.width*c.getScale()),ah=Math.round(c.asset.height*c.getScale()),icw=c.getInnerWidth(),ich=c.getInnerHeight();
if(!extel){
return false
}
if(c.rotation%180===90){
if(icw!==ah&&ich!==aw){
el.style.cursor='move'
}else if(icw!==ah){
el.style.cursor='ew-resize'
}else if(ich!==aw){
el.style.cursor='ns-resize'
}else{
el.style.cursor='inherit';
return false
}
}else{
if(icw!==aw&&ich!==ah){
el.style.cursor='move'
}else if(icw!==aw){
el.style.cursor='ew-resize'
}else if(ich!==ah){
el.style.cursor='ns-resize'
}else{
el.style.cursor='inherit';
return false
}
}
return true
},
isActive:function(){
return web.workspace.plugins.SelectImage.superclass.isActive.call(this)&&this.part
},
setBackdropVisibility:function(visible){
if(!Ext.isIE9&&!Ext.isIE10){
this.backdropEl.dom.style.display=visible?'':'none'
}
},
applyUrlAndRotate:function(c){
if(this.backdropEl.dom.src!==c.assetUrl){
this.backdropEl.dom.src=c.assetUrl
}
this.backdropEl.dom.style.transform='rotate('+c.rotation+'deg)';
this.backdropEl.dom.style.msTransform='rotate('+c.rotation+'deg)';
this.backdropEl.dom.style.webkitTransform='rotate('+c.rotation+'deg)'
},
enableGuideLines:function(enable){
this.guideLinesEnabled=enable;
if(enable){
this.svgLines.vertical.show();
this.svgLines.horizontal.show()
}else{
this.svgLines.vertical.hide();
this.svgLines.horizontal.hide()
}
},
updateBackdropAndLines:function(component,changes){
changes=changes||{};
if(!component||!component.scaleStrategyObj.features.fadedImage){
this.enableGuideLines(false);
this.setBackdropVisibility(false);
return
}
var region=this.getRegion(),c=component,cWidth=c.getInnerWidth(),cHeight=c.getInnerHeight(),scale=Ext.isNumber(changes.scale)?changes.scale:c.getScale(),extel=Ext.get('image-'+c.getId()),style,x,y,w,h,border={
top:c.getStyle().getBorder().getWidth().getTop(),
left:c.getStyle().getBorder().getWidth().getLeft()
};
if(!extel){
return
}
style=extel.dom.style;
w=c.asset.width*scale;
h=c.asset.height*scale;
x=Ext.isNumber(changes.left)?changes.left:-this.component.cropLeft;
y=Ext.isNumber(changes.top)?changes.top:-this.component.cropTop;
if(c.rotation%180===90){
if(x+h<cWidth){
x-=h+x-cWidth
}
if(y+w<cHeight){
y-=w+y-cHeight
}
}else{
if(x+w<cWidth){
x-=w+x-cWidth
}
if(y+h<cHeight){
y-=h+y-cHeight
}
}
if(this.component.rotation%180===90){
y-=h/2-w/2;
x-=w/2-h/2
}
this.backdropEl.dom.style.top=region.top+border.top+y+'px';
this.backdropEl.dom.style.left=region.left+border.left+x+'px';
this.backdropEl.dom.style.width=w+'px';
this.backdropEl.dom.style.height=h+'px'
},
openAviary:function(){
this.workspace.app.windows.show({
type:'web.windows.AviaryImageEditor',
app:this.workspace.app,
listeners:{
imagesaved:function(asset){
var comp=this.component;
this.applyChanges({
asset:asset,
rotation:0,
scale:Math.max(comp.getInnerWidth()/asset.width,comp.getInnerHeight()/asset.height)
})
},
scope:this
},
values:{asset:this.component.getAsset()}
})
},
rotateButtonHandler:function(btn){
var c=this.component;
if(c){
var angle=(c.rotation+btn.angle)%360,alternateMinZoom=c.getMinZoom({rotation:angle}),changes={rotation:angle};
if(c.scaleStrategy==='crop'){
if(alternateMinZoom>c.getScale()){
changes.scale=alternateMinZoom
}
}else if(c.scaleStrategy==='fit'){
changes.bbox=c.bbox;
changes.bbox.right=c.bbox.left+c.getInnerHeight();
changes.bbox.bottom=c.bbox.top+c.getInnerWidth()
}
this.applyChanges(changes)
}
},
applyChanges:function(changes){
var newJSON;
if(this.component){
newJSON=Ext.apply(this.component.toJSON(),changes);
if(Ext.encode(newJSON)===Ext.encode(this.component.toJSON())){
return
}
this.workspace.app.invoker.execute(new web.commands.components.ChangeImageProps({
image:this.component,
json:changes
}))
}
}
});
web.commands.components.UpdateImageSlider=Ext.extend(web.commands.Command,{
constructor:function(config){
this.component=null;
this.json=null;
this.addEvents('afterSlideChange');
web.commands.components.UpdateImageSlider.superclass.constructor.call(this,config)
},
execute:function(){
var component=this.component,json=this.json;
this.component._startValue=this.component.getCurrentSlide();
this.prevState=component.toJSON();
component.set(json);
this.fireEvent('update',component)
},
undo:function(){
var component=this.component,currentState=component.toJSON();
this.component._startValue=this.component.getCurrentSlide();
component.set(this.prevState);
this.prevState=currentState;
this.fireEvent('update',component)
}
});
web.workspace.plugins.SelectImageSlider=Ext.extend(web.workspace.plugins.SelectDecorator,{
visible:false,
showDelete:true,
initDecorator:function(){
web.data.components.ImageSlider.observable=new web.data.components.ImageSlider.Observable({
listeners:{
slideChanged:function(show){
var owl;
if(this.isActive()&&this.part&&this.part instanceof this.componentType){
owl=oneJQuery('#slidesjs-'+this.part.getId());
owl.trigger('owl.stop');
if(this.part.getCaptionsPlacement()==='top'&&!show){
this.hide()
}else if(!this.workspace.selectImageSliderCaption.activeEditor||this.workspace.selectImageSliderCaption.activeEditor&&!this.workspace.selectImageSliderCaption.activeEditor.isVisible()){
this.show()
}
}
}.createDelegate(this)
}
})
},
onDeselect:function(){
if(this.component instanceof web.data.components.ImageSlider){
var owl=oneJQuery('#slidesjs-'+this.component.getId());
if(this.component.autoNext){
owl.trigger('owl.play',this.component.delay*1024)
}
owl.css({'z-index':-1})
}
},
onRender:function(){
this.workspace.selectImageSlider=this;
this.buttonLink=new Ext.Button({
cls:'imageslider-button-link',
text:'Link',
tooltip:'Add link.',
listeners:{
click:this.addLink,
scope:this
}
});
this.buttonUnLink=new Ext.Button({
cls:'imageslider-button-unlink',
tooltip:'Remove link.',
iconCls:'icon icon-web-buttons-link',
hidden:true,
listeners:{
click:this.removeLink,
scope:this
}
});
this.buttonDelete=new Ext.Button({
cls:'imageslider-button-delete',
tooltip:'Delete image',
iconCls:'icon icon-web-buttons-trash',
hidden:!this.showDelete,
listeners:{
click:this.deleteOneImage,
scope:this
}
});
this.panel=new Ext.Panel({
renderTo:this.workspace.contentEl,
cls:'imageslider-select-panel',
style:{
zIndex:Ext.fly(this.workspace.overlay.paper.canvas).dom.style.zIndex-2,
position:'absolute'
},
layout:'vbox',
items:[{
xtype:'panel',
ref:'sortToolbar',
layout:'hbox',
layoutConfig:{pack:'end'},
defaults:{},
items:[
this.buttonLink,
this.buttonUnLink,
this.buttonDelete
]
}]
});
this.hide();
this.componentType=web.data.components.ImageSlider;
this.workspace.app.on('select',function(part){
if(this.part!==part&&part instanceof this.componentType){
this.part=part;
this.activatePlugin(part)
}
},this);
this.workspace.on('redraw',function(){
if(this.part){
this.activatePlugin(this.part)
}
},this);
this.workspace.multiSelect.on('change',function(items){
var part=items.length===1?items[0]:null;
if(this.part!==part&&this.part){
this.deactivatePlugin(this.part);
this.part=null
}
},this)
},
activatePlugin:function(component){
if(this.component instanceof web.data.components.ImageSlider&&this.component.getRenderParent()){
var region=this.getRegion(),w=130,h=22,padding=5,owl=oneJQuery('#slidesjs-'+this.component.getId());
owl.trigger('owl.stop');
owl.css({'z-index':'auto'});
this.panel.el.dom.style.left=region.right-w-padding+'px';
this.panel.el.dom.style.top=region.top+padding+'px';
this.panel.setSize(w,h);
this.panel.sortToolbar.setWidth(w);
this.show();
this.panel.doLayout();
this.panel.sortToolbar.doLayout();
if(this.component.getSlides().length){
this.panel.enable()
}else{
this.panel.disable()
}
}else{
this.hide()
}
},
deactivatePlugin:function(component,turnOff){
if(this.component instanceof web.data.components.ImageSlider){
var owl=oneJQuery('#slidesjs-'+this.component.getId());
if(!turnOff&&this.component.autoNext){
owl.trigger('owl.play',this.component.delay*1024)
}
}
this.hide()
},
deleteOneImage:function(){
var slides,current=this.component.getCurrentSlide();
if(current!==null){
slides=this.component.getSlides().slice();
slides.splice(current,1);
this.workspace.app.invoker.execute(new web.commands.components.UpdateImageSlider({
'component':this.component,
'json':{'slides':slides}
}));
if(current>=slides.length){
current=slides.length-1
}
this.component._startValue=current
}
},
addLink:function(){
var current=this.component.getCurrentSlide(),slides=this.component.getSlides(),selectedSlide;
if(current!==null){
selectedSlide=slides[current];
this.workspace.app.windows.show({
type:'web.windows.Link',
values:selectedSlide.action,
okFn:function(wn,linkType,actionType,value){
var link,action=null;
if(linkType==='linkId'){
link=this.workspace.app.dm.get(value);
action={
linkId:link.getId(),
actionType:actionType
}
}else if(linkType==='href'){
action={
link:{
type:'web.data.links.LinkExternal',
name:value,
url:value
},
actionType:actionType
}
}
selectedSlide.action=action;
this.workspace.app.invoker.execute(new web.commands.components.UpdateImageSlider({
'component':this.component,
'json':{'slides':slides}
}))
},
scope:this
})
}
},
removeLink:function(){
this.addLink()
},
layout:function(){
var padding=10,rg=this.getRegion(),r={
x:rg.left,
y:rg.top,
w:rg.right-rg.left-padding*2,
h:rg.bottom-rg.top-padding*2,
cols:null
},b={
x:0,
y:0,
w:null,
h:null,
size:100,
margin:0,
padding:0,
border:1
},sortArea=Ext.get(Ext.query('.imageslider-sort')[0]),offset={
x:sortArea.getX()+b.margin+padding,
y:sortArea.getY()+padding
},height;
r.cols=Math.max(Math.round(r.w/b.size),1);
b.spc=b.padding+b.border+b.margin;
b.step=Math.floor(r.w/r.cols);
b.w=b.h=b.step-b.spc*2+2;
height=Math.ceil(this.slidesClone.length/r.cols)*b.h;
sortArea.dom.style.width=r.w+'px';
sortArea.dom.style.height=height+'px';
this.component.setHeight(Math.max(height+22+padding*2,this.component.getHeight()));
this.workspace.updateComponent(this.component);
this.component.setHeight(this.beforeSortHeight);
var index=0;
this.slidesClone.forEach(function(slide){
var asset=slide.asset,id='thumb-'+asset.id,c=Ext.get(id);
c.set({'data-index':index}).set({'title':index});
index+=1;
c.moveTo(offset.x+b.x,offset.y+b.y,true);
Ext.get(Ext.DomQuery.select('.draggable')).setWidth(b.w).setHeight(b.h);
b.x+=b.step;
if(b.x+b.step>r.w){
b.x=0;
b.y+=b.step
}
},this)
},
hide:function(){
this.panel.hide();
if(this.visible){
this.visible=false
}
},
show:function(){
var current,slides,selectedSlide,linked;
this.visible=true;
if(this.component instanceof web.data.components.ImageSlider&&this.component.getParent()){
var linkmode=this.component.isLinksEnabled();
current=this.component.getCurrentSlide()||0;
slides=this.component.getSlides().slice();
selectedSlide=slides[current]||{action:null};
linked=selectedSlide.action?true:false;
this.buttonLink.setVisible(linkmode&&!linked);
this.buttonUnLink.setVisible(linkmode&&linked);
this.panel.sortToolbar.doLayout();
this.panel.show()
}
}
});
web.commands.components.gallery.EditCaption=Ext.extend(web.commands.Command,{
gallery:null,
index:null,
text:null,
constructor:function(cfg){
this.gallery=cfg.gallery;
web.commands.components.gallery.EditCaption.superclass.constructor.call(this,cfg)
},
execute:function(){
var images=this.gallery.getImages(true),index=this.index;
this.prevState=images[index].caption;
images[index].caption=this.text;
this.app.fireEvent('update',this.gallery)
},
undo:function(){
var images=this.gallery.getImages(true),caption=this.prevState,index=this.index;
this.prevState=images[index].caption;
images[index].caption=caption;
this.app.fireEvent('update',this.gallery)
}
});
Ext.ns('web.ui.fields');
web.ui.fields.WorkspaceTextField=Ext.extend(Ext.Component,{
updateDelay:300,
textareaEl:null,
donotHideTarget:false,
initComponent:function(){
var cls=this.itmCls||'';
this.renderTo=this.workspace.getEl();
this.autoEl={
tag:'div',
cls:cls+' web-ui-fields-workspacetextfield textnormal innerfocusable',
cn:[{
tag:'p',
cn:[{
tag:'textarea',
cls:'innerfocus'
}]
}]
};
this.listeners={
render:function(){
this.initTextarea()
},
scope:this
};
this.addEvents(['change']);
web.ui.fields.WorkspaceTextField.superclass.initComponent.call(this)
},
getValue:function(){
return this.textareaEl.dom.value.trim()
},
setTextTarget:function(cfg){
var componentId=cfg.componentId,assetId=cfg.assetId,targetEl=cfg.targetEl,text=cfg.text,donotHideTarget=cfg.donotHideTarget;
var targetRegion=targetEl.getRegion(),el=this.textareaEl;
this.targetAssetId=assetId;
this.componentId=componentId;
el.setLocation(targetRegion.left,targetRegion.top);
el.setOverflow('hidden');
el.setWidth(targetRegion.right-targetRegion.left);
el.setHeight(targetRegion.bottom-targetRegion.top+targetEl.getPadding('tb'));
if(text!==undefined){
this.textareaEl.dom.value=text
}else{
this.textareaEl.dom.value=targetEl.dom.textContent
}
if(!donotHideTarget){
this.hideTarget()
}
},
focus:function(delay){
this.textareaEl.focus(delay)
},
hideTarget:function(){
this.setVisibility(false)
},
showTarget:function(){
this.setVisibility(true)
},
setVisibility:function(visible){
var targetEl=this.getTargetEl();
visible=visible?'visible':'hidden';
if(targetEl){
if(this.donotHideTarget){
targetEl.first().setStyle({visibility:visible})
}else{
targetEl.setStyle({visibility:visible});
if(targetEl.child('span')){
targetEl.child('span').setStyle({visibility:visible})
}
}
}
},
initTextarea:function(){
this.textareaEl=Ext.get(this.el.query('textarea')[0]);
this.mon(this.textareaEl,'keyup',function(){
this.bufferUpdate()
},this);
this.mon(this.textareaEl,'blur',function(){
this.showTarget();
this.fireEvent('blur',this);
this.hide()
},this)
},
getTargetEl:function(){
var targetEl;
if(this.targetAssetId){
targetEl=Ext.get(this.workspace.getSelectedEl().query('[data-assetid='+this.targetAssetId+']')[0]);
targetEl=targetEl&&targetEl.parent().first()
}
return targetEl
},
adjustDimensions:function(){
var el=this.textareaEl,targetEl=this.getTargetEl(),targetRegion;
if(!this.hidden&&targetEl){
targetRegion=targetEl.getRegion();
el.setLocation(targetRegion.left,targetRegion.top);
el.setWidth(targetRegion.right-targetRegion.left);
el.setHeight(targetRegion.bottom-targetRegion.top)
}
},
bufferUpdate:function(){
if(this.adjustInterval){
clearInterval(this.adjustInterval)
}
this.adjustInterval=setTimeout(this.doUpdate.createDelegate(this),this.updateDelay)
},
doUpdate:function(){
this.fireEvent('change',this,this.getValue())
}
});
web.workspace.plugins.SelectGalleryCaption=Ext.extend(web.workspace.plugins.SelectDecorator,{
activeEditor:null,
inactiveEditor:null,
index:null,
onRender:function(){
this.workspace.mon(this.workspace.el,'click',function(e){
if(this.component&&!Ext.get(e.target).is('textarea')&&this.component instanceof web.data.components.Gallery){
var captionEl=e.getTarget('.gallery-caption');
if(this.activeEditor&&!this.activeEditor.hidden){
this.updateCaptionValue(this.activeEditor.getValue())
}
if(captionEl&&this.workspace.isActive()){
this.displayEditor(captionEl);
Ext.get(captionEl).setStyle({visibility:'hidden'});
this.assetId=Ext.get(e.getTarget()).parent('.gallery-cell').child('img').getAttribute('data-assetId')
}
if(!captionEl&&this.workspace.isActive()){
this.hideEditor()
}
}
},this);
this.workspace.on('auto-adjust',function(){
var editor=this.activeEditor,captionEl;
if(this.component&&editor&&editor.isVisible()){
captionEl=editor.getTargetEl();
if(captionEl){
editor.textareaEl.setStyle('text-align',captionEl.getStyle('text-align'));
editor.focus(1);
editor.adjustDimensions();
captionEl.setStyle({visibility:'hidden'})
}
}
},this);
this.workspace.on('destroy',this.onDestroy,this)
},
onDeselect:function(){
if(this.component instanceof web.data.components.Gallery){
if(this.activeEditor&&!this.activeEditor.hidden){
this.updateCaptionValue(this.activeEditor.getValue())
}
this.hideEditor()
}
},
displayEditor:function(html){
var gallery=this.workspace.getElComponent(html),images=gallery.getImages(true),captionEl=Ext.get(html);
this.index=captionEl.parent('[data-index]').getAttribute('data-index');
this.renderEditor();
this.activeEditor.show();
this.activeEditor.setTextTarget({
componentId:this.component.id,
assetId:images[this.index].asset.getId(),
targetEl:captionEl,
text:images[this.index].caption
});
this.activeEditor.focus(1);
this.activeEditor.textareaEl.dom.style.textAlign=gallery.getCaptionsAlignment();
this.activeEditor.textareaEl.dom.style.padding='5px';
if(this.inactiveEditor){
this.inactiveEditor.hide.defer(100,this.inactiveEditor)
}
},
hideEditor:function(){
if(this.activeEditor){
this.activeEditor.hide();
if(this.activeEditor.getTargetEl()){
this.activeEditor.getTargetEl().setStyle({visibility:'visible'})
}
}
},
onDestroy:function(){
this.activeEditor.destroy();
this.inactiveEditor.destroy();
this.activeEditor=null;
this.inactiveEditor=null
},
updateCaptionValue:function(value){
var activeImage,img=Ext.query('[data-id='+this.component.id+'] [data-assetid='+this.assetId+']')[0];
if(img){
this.index=Ext.get(img).parent('.gallery-cell').getAttribute('data-index')
}
activeImage=this.component&&this.component.getImages&&this.component.getImages(true)[this.index];
if(activeImage){
if(activeImage.caption!==value){
this.workspace.app.invoker.execute(new web.commands.components.gallery.EditCaption({
gallery:this.component,
index:this.index,
text:value
}))
}
}else{
this.hideEditor()
}
},
renderEditor:function(){
var editor1,editor2,editor;
return function renderEditor(){
var caption=this;
if(this.activeEditor===editor2){
this.activeEditor=editor1;
this.inactiveEditor=editor2
}else if(this.activeEditor===editor1){
if(!editor2){
editor2=new web.ui.fields.WorkspaceTextField({
workspace:this.workspace,
listeners:{
change:function(editor,value){
this.updateCaptionValue(value)
},
scope:this
}
})
}
this.activeEditor=editor2;
this.inactiveEditor=editor1
}else{
editor1=new web.ui.fields.WorkspaceTextField({
workspace:this.workspace,
listeners:{
change:function(editor,value){
this.updateCaptionValue(value)
},
scope:this
}
});
this.activeEditor=editor1
}
this.activeEditor.getTargetEl=function(){
var targetEl;
if(this.targetAssetId){
targetEl=Ext.get(Ext.query('[data-id='+this.componentId+'] [data-assetid='+this.targetAssetId+']')[0]);
targetEl=targetEl&&targetEl.parent('.gallery-cell').child('.gallery-caption')
}
return targetEl
};
editor=this.activeEditor;
this.activeEditor.on('blur',function(){
caption.updateCaptionValue(editor.getValue());
editor.getTargetEl().setStyle({visibility:'visible'})
})
}
}()
});
web.workspace.plugins.SelectImageSliderCaption=Ext.extend(web.workspace.plugins.SelectDecorator,{
activeEditor:null,
index:null,
onRender:function(){
this.workspace.selectImageSliderCaption=this;
this.workspace.mon(this.workspace.el,'click',function(e){
if(this.component instanceof web.data.components.ImageSlider){
var captionEl=e.getTarget('.slider-caption'),slider=this.component,index=slider.getCurrentSlide();
if(index===this.index){
if(this.activeEditor&&!this.activeEditor.hidden){
this.updateCaptionValue(this.activeEditor.getValue());
if(!e.getTarget('.innerfocus')){
this.hideEditor()
}
}
}else{
this.hideEditor()
}
if(captionEl&&this.workspace.isActive()){
this.displayEditor(captionEl);
if(this.component.getCaptionsPlacement()==='top'){
this.workspace.selectImageSlider.deactivatePlugin(this.component,true)
}
Ext.get(captionEl).first().setStyle({visibility:'hidden'})
}
}
},this);
this.workspace.on('auto-adjust',function(){
var editor=this.activeEditor,captionEl;
if(this.component&&editor&&editor.isVisible()){
captionEl=editor.getTargetEl();
if(captionEl){
editor.textareaEl.setStyle('text-align',captionEl.getStyle('text-align'));
editor.focus(1);
setTimeout(editor.adjustDimensions.createDelegate(editor),1);
captionEl.first().setStyle({visibility:'hidden'});
if(this.component.getCaptionsPlacement()==='top'){
this.workspace.selectImageSlider.deactivatePlugin(this.component,true)
}
}
}
},this);
this.workspace.app.on('activate',function(docMode){
if('workspace'===docMode&&this.activeEditor){
this.hideEditor()
}
},this);
this.workspace.on('destroy',this.onDestroy,this)
},
onDeselect:function(){
if(this.component instanceof web.data.components.ImageSlider){
if(this.activeEditor&&!this.activeEditor.hidden){
this.updateCaptionValue(this.activeEditor.getValue())
}
this.hideEditor()
}
},
displayEditor:function(html){
var slider=this.workspace.getElComponent(html),slides=slider.getSlides(),captionEl=Ext.get(html),slide;
this.index=slider.getCurrentSlide();
slide=slides[this.index];
this.renderEditor();
this.activeEditor.show();
this.activeEditor.setTextTarget({
componentId:this.component.id,
assetId:slide.asset.getId(),
targetEl:captionEl,
text:slide.caption||'',
donotHideTarget:true
});
this.activeEditor.focus(1);
this.activeEditor.textareaEl.dom.style.textAlign=slider.getCaptionsAlignment();
this.activeEditor.textareaEl.dom.style.padding='5px'
},
hideEditor:function(){
if(this.activeEditor&&this.activeEditor.getTargetEl()){
this.activeEditor.hide();
this.activeEditor.getTargetEl().first().setStyle({visibility:'visible'});
this.workspace.selectImageSlider.activatePlugin(this.component)
}
},
onDestroy:function(){
this.activeEditor.destroy();
this.activeEditor=null
},
updateCaptionValue:function(value){
var activeImage,cmp=this.component,assets=cmp.getSlides(),index=cmp.getCurrentSlide();
activeImage=this.component&&assets[index];
if(activeImage){
if(activeImage.caption!==value){
activeImage.caption=value;
this.workspace.app.invoker.execute(new web.commands.components.UpdateImageSlider({
'component':cmp,
'json':{'slides':assets}
}))
}
}else{
this.hideEditor()
}
},
renderEditor:function(){
var editor;
return function renderEditor(){
editor=new web.ui.fields.WorkspaceTextField({
workspace:this.workspace,
itmCls:'sliderCmpCls',
listeners:{
change:function(editor,value){
this.updateCaptionValue(value)
},
scope:this
}
});
this.activeEditor=editor
}
}()
});
Ext.ns('web.commands.contactForm');
web.commands.contactForm.ReorderContactFormFields=Ext.extend(web.commands.Command,{
execute:function(){
var contactForm=this.contactForm,formElementsOrder=contactForm.getFormElementsOrder(),dropIndex=formElementsOrder.indexOf(this.dropElement),dragIndex=formElementsOrder.indexOf(this.dragElement);
if(dragIndex===-1){
dragIndex=this.dragIndex;
this.dragElement=formElementsOrder[dragIndex]
}
if(dropIndex===-1){
dropIndex=this.dropIndex;
this.dropElement=formElementsOrder[dropIndex]
}
if(dragIndex===dropIndex){
return
}
if(dragIndex>dropIndex){
formElementsOrder.splice(dropIndex,0,formElementsOrder[dragIndex]);
formElementsOrder.splice(dragIndex+1,1)
}else{
formElementsOrder.splice(dropIndex+1,0,formElementsOrder[dragIndex]);
formElementsOrder.splice(dragIndex,1)
}
contactForm.set({
formElementsOrder:formElementsOrder,
activeElement:this.dragElement
});
this.prevState=dragIndex;
this.app.fireEvent('update',contactForm)
},
undo:function(){
var temp=this.prevState;
this.index=this.prevState;
this.prevState=temp;
this.execute()
}
});
Ext.dd.DragDropMgr.getLocation=function(oDD){
if(!this.isTypeOfDD(oDD)){
return null
}
var el=oDD.getEl(),pos,x1,x2,y1,y2,t,r,b,l;
try{
pos=Ext.lib.Dom.getXY(el)
}catch(e){
}
if(!pos){
return null
}
x1=pos[0];
x2=x1+el.offsetWidth;
y1=pos[1];
y2=y1+el.offsetHeight;
t=y1-oDD.padding[0];
r=x2+oDD.padding[1];
b=y2+oDD.padding[2];
l=x1-oDD.padding[3];
return new Ext.lib.Region(t,r,b,l)
};
web.workspace.plugins.SelectContactFormDragDrop=Ext.extend(web.workspace.plugins.SelectDecorator,{
constructor:function(){
this.drag=null;
web.workspace.plugins.SelectContactFormDragDrop.superclass.constructor.apply(this,arguments)
},
onUpdate:function(){
if(this.component instanceof web.data.components.ContactForm&&this.workspace.getComponentEl(this.component)){
this.initDragDropHandler(this.component)
}
},
onDeselect:function(newComponent){
if(this.component instanceof web.data.components.ContactForm){
this.removeDragDropHandler()
}
},
initDragDropHandler:function(component){
var workspace=this.workspace,componentEl=workspace.getComponentEl(component),paper=workspace.overlay.paper,app=workspace.app,indicator;
this.component=component;
this.removeDragDropHandler();
this.drag=new Ext.dd.DragZone(componentEl,{
ddGroup:component.getId(),
getDragData:function(e){
var fieldEl=e.getTarget('.contact-form-field-container');
if(fieldEl){
return{ddel:fieldEl}
}else{
return null
}
},
beforeInvalidDrop:function(e){
if(indicator){
indicator.remove();
indicator=null
}
},
getLocation:function(odd){
return odd.el.getRegion()
}
});
this.drop=new Ext.dd.DropZone(componentEl,{
ddGroup:component.getId(),
getTargetFromEvent:function(e){
return e.getTarget('div.contact-form-field-container')
},
onNodeOver:function(node,source,e,dragData){
var region=workspace.adjustRegion(Ext.fly(node).getRegion()),fillColor='rgba(112,135,146,0.7)',strokeColor='#20343E',rectangle,dropHere,rectBBOX;
if(indicator){
indicator.remove();
indicator=null
}
rectangle=paper.path('M'+region.left+','+region.top+'H'+region.right+'V'+region.bottom+'H'+region.left+'Z').attr({
fill:fillColor,
stroke:strokeColor,
'stroke-width':1
});
rectBBOX=rectangle.getBBox();
dropHere=paper.text(region.left+rectBBOX.width/2,region.top+rectBBOX.height/2,'Drop here').attr({
'font-size':18,
fill:'#ffffff'
});
indicator=paper.set();
indicator.push(rectangle);
indicator.push(dropHere);
return this.dropAllowed
},
onNodeDrop:function(node,source,e,dragData){
var dragIndex=parseInt(dragData.ddel.getAttribute('data-index'),10),dropIndex=this.getTargetIndex(node,e.getPageX());
if(indicator){
indicator.remove();
indicator=null
}
app.invoker.execute(new web.commands.contactForm.ReorderContactFormFields({
contactForm:component,
dragElement:dragData.ddel.getAttribute('dataformelement'),
dropElement:node.getAttribute('dataformelement'),
dragIndex:dragIndex,
dropIndex:dropIndex
}));
return true
},
getTargetIndex:function(node,left){
var nodeRegion=Ext.fly(node).getRegion(),nodeIndex=parseInt(node.getAttribute('data-index'),10),nodeRegionHalfway=(nodeRegion.left+nodeRegion.right)/2;
if(left>nodeRegionHalfway){
nodeIndex+=1
}
return nodeIndex
}
})
},
removeDragDropHandler:function(){
if(this.drag){
this.drag.unreg();
this.drag=null
}
if(this.drop){
this.drop.unreg();
this.drop=null
}
}
});
web.commands.contactForm.removeFormElement=Ext.extend(web.commands.Command,{
execute:function(){
var contactForm=this.contactForm,formElementsOrder=contactForm?contactForm.getFormElementsOrder():null;
this.prevState=contactForm.toJSON();
formElementsOrder.splice(this.index,1);
this.currentSate=formElementsOrder;
contactForm.set({
formElementsOrder:this.currentSate,
activeElement:formElementsOrder[this.index]
});
this.app.fireEvent('update',contactForm)
},
undo:function(){
var contactForm=this.contactForm,temp=contactForm.toJSON();
this.currentSate=this.prevState;
this.prevState=temp;
contactForm.set(this.currentSate);
this.app.fireEvent('update',contactForm)
}
});
web.workspace.plugins.SelectContactFormElementAction=Ext.extend(web.workspace.plugins.SelectDecorator,{
buttonsRendered:false,
onRender:function(){
this.workspace.mon(this.workspace.el,'click',this.handleDeleteFormElement,this);
this.workspace.mon(this.workspace.el,'click',this.handleFormElementActivate,this)
},
onUpdate:function(component){
if(this.component instanceof web.data.components.ContactForm){
var el=this.workspace.getComponentEl(this.component),activeElement=this.component.activeElement||null,formElementsOrder=this.component.formElementsOrder,selectedFormElementIndex=formElementsOrder?formElementsOrder.indexOf(activeElement):-1;
if(el&&el.select('.workspace-contact-form-element-delete').getCount()===0){
this.createDeleteButtons(this.component);
if(typeof selectedFormElementIndex==='number'&&selectedFormElementIndex!==-1){
el.select('.contact-form-field-container:nth-child('+(selectedFormElementIndex+1)+')').addClass('selected-contact-form-element-container');
this.component.activeElement=formElementsOrder[selectedFormElementIndex]
}
}
}
},
onDeselect:function(newComponent){
if(this.component instanceof web.data.components.ContactForm){
var el=this.workspace.getComponentEl(this.component),selectedEl=el?el.select('.selected-contact-form-element-container'):null;
if(selectedEl){
selectedEl.removeClass('selected-contact-form-element-container')
}
}
},
handleDeleteFormElement:function(e){
var target=e.getTarget('.workspace-contact-form-element-delete');
if(target){
this.workspace.app.invoker.execute(new web.commands.contactForm.removeFormElement({
contactForm:this.component,
index:target.getAttribute('data-index')
}))
}
},
handleFormElementActivate:function(e){
var target=e.getTarget('.contact-form-field-container'),selectedTarget=e.getTarget('.selected-contact-form-element-container'),currentDeleteTarget=e.getTarget('.workspace-contact-form-element-delete'),submitBtnContainer=e.getTarget('.contact-form-submit-btn-container'),app=this.workspace.app,component=this.component,formElementsOrder=component instanceof web.data.components.ContactForm?component.getFormElementsOrder():null,index=target?parseInt(target.getAttribute('data-index'),10):null;
if(e.target.type==='radio'||e.target.type==='checkbox'){
e.target.checked=false
}
if(formElementsOrder){
if(selectedTarget){
e.preventDefault();
return false
}
if(submitBtnContainer&&e.target.type==='submit'){
e.preventDefault()
}
if(target){
Ext.get(e.getTarget('.oneWebCntForm').id).select('.contact-form-field-container').each(function(element){
element.removeClass('selected-contact-form-element-container')
});
if(currentDeleteTarget){
return false
}else if(!this.isActive()){
return false
}else if(Ext.get(target.id)){
Ext.get(target.id).addClass('selected-contact-form-element-container');
component.activeElement=formElementsOrder[index];
app.fireEvent('updateFieldProperties',this.component,index)
}
}else{
if(component){
if(this.workspace.getComponentEl(this.component)){
Ext.get(this.workspace.getComponentEl(this.component).id).select('.selected-contact-form-element-container').each(function(element){
element.removeClass('selected-contact-form-element-container')
})
}
}
}
}
},
createDeleteButtons:function(component){
var el=this.workspace.getComponentEl(component),formEls=el?el.select('.contact-form-field-container'):null;
if(formEls){
formEls.each(function(formEl,compositeEl,index){
var deleteEl=el.createChild({
cls:'web-button workspace-contact-form-element-delete',
'data-index':index,
cn:{
tag:'a',
cls:'icon icon-web-buttons-delete-small',
title:'Delete form element'
}
});
formEl.appendChild(deleteEl)
},this)
}
}
});
web.workspace.plugins.WebshopWelcomeMessage=Ext.extend(web.workspace.plugins.SelectDecorator,{
welcomeMsg:null,
cmpEl:null,
tip:null,
price:null,
daysRemaining:90,
onRender:function(){
this.workspace.on('redraw',this.showWelcomeMsg.createDelegate(this));
this.workspace.mon(this.workspace.el,'click',function(e){
var el,okBtn;
if(this.welcomeMsg){
el=this.welcomeMsg.getEl();
okBtn=el.child('.okBtn')
}else if(this.tip){
el=this.tip.getEl();
okBtn=el.child('.closeIcon')
}
if(el){
if(okBtn.getRegion().contains(e.getPoint())){
if(this.welcomeMsg){
this.handleOkClick()
}else{
this.tip.destroy();
this.tip=null
}
}
}
}.createDelegate(this))
},
showWelcomeMsg:function(component){
var isWebShopAdded=false;
if(component){
isWebShopAdded=component.getAllItems().some(function(cmp){
if(cmp instanceof web.data.components.WebShop){
this.cmpEl=this.workspace.getComponentEl(cmp);
return true
}
}.createDelegate(this));
if(isWebShopAdded&&this.workspace.getElComponent(this.cmpEl).showWelcomeMessage){
this.welcomeMsg=this.welcomeMsg?this.welcomeMsg.destroy():null;
this.welcomeMsg=Ext.create({
xtype:'container',
html:'<div class=welcomeMsgCntnr><div class=contentCntnr><header>Welcome to your webshop!</header><div>Through this component, your customers will see the following 4 pages:</div><ul><li><div class=products></div><p>Products</p></li><li class=singleSeperatorCntnr><div class=seperator></div></li><li class=singleCntnr><div class=single></div><p>Single products</p></li><li><div class=seperator></div></li><li class=cartCntrnr><div class=cart></div><p>Cart overview</p></li><li><div class=seperator></div></li><li><div class=checkout></div><p>Checkout</p></li></ul><div>Style your pages from the Properties panel. Click "Preview" to view and browse, before publishing them.</div><div>You can add and edit products and prices by clicking "Manage webshop" in the Properties panel.</div><div class=okBtn>OK</div></div></div>',
cls:'webShopWelcomeMessageCntnr',
renderTo:this.cmpEl
})
}
}
},
handleOkClick:function(){
var linkText='Manage webshop',app=this.workspace.app,cmp;
cmp=this.workspace.getElComponent(this.cmpEl);
app.invoker.execute(new web.commands.components.UpdateWebShopProperties({
component:cmp,
showWelcomeMessage:false
}));
this.welcomeMsg.destroy();
this.welcomeMsg=null;
setTimeout(function(){
this.tip=Ext.create({
xtype:'container',
html:'You can add and edit products and prices by clicking "'+linkText+'" in the Properties panel.'+'<div class="closeIcon"></div>',
cls:'webShopTip',
renderTo:this.cmpEl,
width:this.cmpEl.getWidth()
})
}.bind(this),50)
}
});
Ext.ns('web.workspace.dropper');
web.workspace.dropper.Drop=Ext.extend(Object,{
constructor:function(cfg){
this.offset=0;
this.minInsertSize=8;
this.arrowWidth=40;
this.arrowWidthD2=20;
this.arrowWidthD4=10;
Ext.apply(this,cfg);
if(this.layer){
this.workspace=this.workspace?this.workspace:this.layer.workspace
}
this.app=this.workspace?this.workspace.app:null
},
getDestination:function(){
return this.layer.component
},
getPosition:function(){
return this.position
},
getRegion:function(){
return this.layer.region
},
getDestRegion:function(){
return this.layer.region
},
isValid:function(){
var dropComponent=this.layer.component,component=this.component;
return dropComponent!==component
},
setOffset:function(offset){
this.offset=offset
},
getInsertRegion:function(){
var offset=this.offset;
return this.layer.workspace.copyRegion(this.getRegion(),offset,offset,offset-1,offset-1)
},
getInsertPathTop:function(){
var region=this.getInsertRegion();
return[[
region.left,
region.top
]]
},
getInsertPathRight:function(){
var region=this.getInsertRegion();
return[[
region.right,
region.top
]]
},
getInsertPathBottom:function(){
var region=this.getInsertRegion();
return[[
region.right,
region.bottom
]]
},
getInsertPathLeft:function(){
var region=this.getInsertRegion();
return[[
region.left,
region.bottom
]]
},
getInsertPath:function(){
var edges=[
'top',
'right',
'bottom',
'left'
],path=[];
edges.forEach(function(edge){
path=path.concat(this['getInsertPath'+edge.substr(0,1).toUpperCase()+edge.substr(1)]())
},this);
return this.encodePath(path)
},
getArrowPath:function(x,y,cfg){
cfg=cfg?cfg:{};
var path=[],w=cfg.width?cfg.width:this.arrowWidth,h=cfg.width?w/2:this.arrowWidthD2,q=cfg.width?h/2:this.arrowWidthD4,dps=cfg.simple?[
[
0,
0
],
[
-h,
h
],
[
-h,
-h
]
]:[
[
0,
0
],
[
0,
q
],
[
q,
0
],
[
-h,
h
],
[
-h,
-h
],
[
q,
0
],
[
0,
-q
]
],swapXY=cfg.swapXY,flipX=cfg.flipX?-1:1,flipY=cfg.flipY?-1:1;
dps.forEach(function(dp){
var dx=flipX*dp[0],dy=flipY*dp[1];
path.push([
x+=swapXY?dy:dx,
y+=swapXY?dx:dy
])
});
return path
},
encodePath:function(path){
var pathStr;
if(path.length){
pathStr+='M '+path[path.length-1].join(',');
path.forEach(function(point,index){
pathStr+=' L '+point.join(',')
},this)
}
return pathStr
},
execute:function(dragData){
var dragCmps,dropCmp,position;
if(this.isValid()){
dragCmps=this.components;
dropCmp=this.getDestination();
position=this.getPosition();
position=position==='top'?'above':position==='bottom'?'below':position;
if(dragCmps&&dropCmp&&position){
if(dragData&&dragData.beforeDrop){
dragData.beforeDrop(function(){
var that=this;
if(dragData.isNewComponent){
dragCmps.forEach(function(cmp){
if(cmp instanceof web.data.components.resources.Image){
var bbox=position.changes[cmp.id].bbox,x=(bbox.left+bbox.right)/2,y=(bbox.top+bbox.bottom)/2,w=cmp.dropWidth,h=cmp.dropHeight;
bbox.left=Math.round(x-w/2);
bbox.right=Math.round(x+w/2);
bbox.top=Math.round(y-h/2);
bbox.bottom=Math.round(y+h/2)
}
})
}
this.executeDropCommand(dragCmps,dropCmp,position,dragData.isNewComponent);
setTimeout(function(){
that.app.workspace.multiSelect.select(dragCmps)
},500)
},this)
}else{
this.executeDropCommand(dragCmps,dropCmp,position,dragData.isNewComponent)
}
return true
}
}
return false
},
executeDropCommand:function(dragCmps,dropCmp,position,isNew){
var dragCmp=isNew||dragCmps.length===1?dragCmps[0]:null,command,app=this.app;
if(this.execCalled){
return
}
this.execCalled=true;
if(isNew&&dragCmp&&!dragCmp.getParent()){
app.track([
'Components',
'add',
dragCmp.type||'wha?'
])
}else{
app.track([
'Components',
'move',
dragCmps.length
])
}
command=new web.commands.components.ChangeMulti({
components:dragCmps,
changes:position.getCompleteChanges(),
target:isNew?position.target:undefined
});
app.invoker.execute(command)
}
});
web.workspace.dropper.LayerDrop=Ext.extend(web.workspace.dropper.Drop,{
criticalSpeed:5,
getPosition:function(){
if(!this.position){
this.reset()
}
return this.position
},
getRegion:function(){
if(!this.position){
this.reset()
}
return this.position.region
},
isValid:function(){
return true
},
reset:function(){
var components=this.components,workspace=this.workspace,app=this.app,isSnap=this.distance<this.criticalSpeed,inner=workspace.getComponentInnerRegion(app.getSelected('template')),region=this.layer.region,height=region.bottom-region.top,bbox;
if(region.top<0){
region.top=0;
region.bottom=height
}
if(isSnap){
var snap=workspace.toSnapRegion(region),dt=snap.top-region.top,dr=snap.right-region.right,db=snap.bottom-region.bottom,dl=snap.left-region.left,dv=dt&&db?Math.abs(db)>Math.abs(dt)?dt:db:dt||db,dh=dl&&dr?Math.abs(dr)>Math.abs(dl)?dl:dr:dl||dr;
region.adjust(dv,dh,dv,dh)
}
bbox={
top:region.top-inner.top,
right:region.right-inner.left,
bottom:region.bottom-inner.top,
left:region.left-inner.left
};
var x=region.left-this.region.left,y=region.top-this.region.top,bboxs=[];
this.regions.forEach(function(region){
bboxs.push({
top:region.top-inner.top+y,
right:region.right-inner.left+x,
bottom:region.bottom-inner.top+y,
left:region.left-inner.left+x
})
},this);
var changes={},target=this.layer.component;
bboxs.forEach(function(bbox,index){
var cmp=components[index],doc=cmp.getParent();
changes[cmp.id]={bbox:bbox};
if(doc!==target){
changes[cmp.id].parentId=target.id
}
},this);
this.position={
bbox:bbox,
bboxs:bboxs,
target:this.layer.component,
region:region,
changes:changes,
getCompleteChanges:function(){
return workspace.calcRels(this.changes)
}
}
}
});
web.workspace.dropper.Plugin=Ext.extend(Object,{
init:function(workspace){
this.workspace=workspace;
workspace.dropper=this
},
getDrop:function(dragData,event){
var workspace=this.workspace,app=workspace.app,point=workspace.getPoint(event),targetCmp=app.getModeDoc(),x=dragData.offsetX,y=dragData.offsetY,region=dragData.region,w=region.right-region.left,h=region.bottom-region.top,targetRegion=workspace.copyRegion(point,-y,-x,h-y,w-x);
return new web.workspace.dropper.LayerDrop({
components:dragData.components,
isNew:dragData.isNewComponent,
region:dragData.region,
regions:dragData.regions,
event:event,
point:point,
layer:{
component:targetCmp,
region:targetRegion,
workspace:workspace
}
})
}
});
one.FileDropTargetPlugin=function(config){
Ext.apply(this,config)
};
one.FileDropTargetPlugin.prototype={
init:function(comp){
Ext.apply(comp,{
onRender:comp.onRender.createSequence(function(ct,pos){
var xy=[
-1,
-1
];
comp.addEvents('droppedfiles','droppedurl','dropenter','dropexit');
comp.el.on({
drop:function(ev){
ev.stopPropagation();
ev.preventDefault();
var data=ev.browserEvent.dataTransfer,files=data.files;
if(!files){
return false
}
if(files.length===0){
comp.fireEvent('droppedurl',comp,ev,data);
return false
}
comp.fireEvent('droppedfiles',comp,ev,files)
},
dragenter:function(ev){
ev.stopPropagation();
ev.preventDefault();
comp.fireEvent('dropenter',comp,ev);
return false
},
dragover:function(ev){
var newXY=ev.getXY();
ev.stopPropagation();
ev.preventDefault();
if(newXY[0]!==xy[0]||newXY[1]!==xy[1]){
comp.fireEvent('dropover',comp,ev);
xy=newXY
}
return false
},
dragexit:function(ev){
ev.stopPropagation();
ev.preventDefault();
comp.fireEvent('dropexit',comp,ev);
return false
}
})
})
})
}
};
Ext.override(web.workspace.Panel,{
initPlugins:function(){
var ns=web.workspace.plugins,multi,select;
this.plugins=[];
this.plugins.push(new ns.AutoAdjust);
this.plugins.push(new ns.ModeMask);
this.plugins.push(new ns.MouseSpeed);
this.plugins.push(new ns.Overlay);
this.plugins.push(new ns.Hover);
this.plugins.push(new ns.EdgeHandle);
this.plugins.push(new ns.EdgeMove);
this.plugins.push(new ns.EdgeDeco);
this.plugins.push(new ns.EdgeSnapTo);
multi=new ns.MultiSelect(true);
multi=new ns.MultiSelectClick(multi);
multi=new ns.MultiSelectSize(multi);
multi=new ns.MultiSelectTemplateDeco(multi);
multi=new ns.MultiSelectDeco(multi);
multi=new ns.MultiSelectMove(multi);
multi=new ns.MultiSelectFrame(multi);
multi=new ns.MultiSelectResize(multi);
multi=new ns.MultiSelectEdge(multi);
multi=new ns.MultiSelectTitle(multi);
multi=new ns.MultiSelectTitleSize(multi);
multi=new ns.MultiSelectDelete(multi);
multi=new ns.MultiSelectNav(multi);
multi=new ns.MultiSelectLevel(multi);
multi=new ns.MultiSelectWrap(multi);
multi=new ns.MultiSelectStretch(multi);
multi=new ns.MultiSelectSnapTo(multi);
multi=new ns.MultiSelectEdit(multi);
multi=new ns.MultiSelectKeys(multi);
this.plugins.push(multi);
select=new ns.Select;
select=new ns.SelectMouseCursor(select);
select=new ns.SelectSpacing(select);
select=new ns.SelectImage(select);
select=new ns.SelectImageSlider(select);
select=new ns.SelectGalleryThumbnailActions(select);
select=new ns.SelectGalleryCaption(select);
select=new ns.SelectImageSliderCaption(select);
select=new ns.SelectContactFormDragDrop(select);
select=new ns.SelectContactFormElementAction(select);
select=new ns.WebshopWelcomeMessage(select);
this.plugins.push(select);
this.plugins.push(new ns.OverlapDecos);
this.plugins.push(new ns.BoxSelect);
this.plugins.push(new ns.WidgetOverlay);
this.plugins.push(new ns.DragDrop);
this.plugins.push(new ns.DragDropDeco);
this.plugins.push(new ns.Clipboard);
this.plugins.push(new ns.RTE);
this.plugins.push(new ns.Dims);
this.plugins.push(new ns.RawDecos);
this.plugins.push(new ns.AutoScroll);
this.plugins.push(new ns.ToolTip);
this.plugins.push(new web.workspace.dropper.Plugin);
this.plugins.push(new one.FileDropTargetPlugin)
}
});
Ext.override(web.workspace.Panel,{
initListeners:function(){
var app=this.app,redraw=function(part,config){
if(part instanceof web.data.components.Page){
this.onComponentAdjust(part,config)
}else if(part instanceof web.data.components.Template){
if(this.page&&this.page.getTemplateId()===part.getId()){
this.onComponentAdjust(this.page,config)
}
}else if(part instanceof web.data.links.LinkPage||part instanceof web.data.links.LinkExternal){
this.updateMenus(part)
}else if(part instanceof web.data.styles.Stylesheet){
if(this.page){
this.setStylesheet(part)
}
}else if(part.isStyle){
this.onStyleAdjust(part)
}else if(part instanceof web.data.components.Component){
this.onComponentAdjust(part,config)
}
};
this.mon(app,'update',redraw,this);
this.mon(app,'adjust',redraw,this);
this.mon(app,'select',function(part){
if(part instanceof web.data.components.Page&&this.page!==part){
this.page=part;
this.onComponentAdjust(part)
}
},this);
this.on('resize',function(cmp,adjWidth,adjHeight){
if(adjHeight||adjWidth){
this.refreshElRegion();
this.clearEls();
this.fireEvent('reflow',this.page,this.upperEl)
}
},this);
this.app.on('resize',function(cmp,adjWidth,adjHeight){
if(adjHeight||adjWidth){
if(this.getWidth()===0){
return
}
setTimeout(function(that){
return function(){
that.fireEvent('reflow',that.page,that.upperEl)
}
}(this),0)
}
},this);
this.on('redraw',function(cmp,el,config){
this.fireEvent('reflow',cmp,el,config)
},this);
this.on('reflow',function(cmp,el){
this.fireEvent('repaint',cmp,el)
},this);
this.mon(this.el,'mousedown',function(e,target){
var tagname=target.tagName.toLowerCase();
if(tagname==='shape'){
this.lastTargetedComponent=this.app.dm.get(this.hover.dataId)
}else{
this.lastTargetedComponent=this.getElComponent(target)
}
if(tagname!=='textarea'&&tagname!=='input'){
e.preventDefault();
Ext.select('body').focus()
}
},this);
this.mon(this.el,'scroll',function(e,t,o){
this.cashedScroll=undefined;
this.fireEvent('scroll',e,t,o)
},this);
this.mon(app,'load',function(){
this.cashedScroll=undefined
},this);
this.mon(app,'flush',this.renderStack,this)
},
onStyleAdjust:function(style){
var rootStyle=style.getRootStyle(),rootStyleParent=rootStyle.getParent();
if(rootStyleParent instanceof web.data.styles.Stylesheet){
this.setStylesheet(rootStyleParent);
this.fireEvent('reflow',this.page,this.el)
}else{
this.updateStyle(style);
this.onComponentAdjust(rootStyleParent)
}
},
adjustTimer:null,
adjustStack:{},
renders:{
'default':function defaultRender(component){
if(!component.parent){
this.setPage(component)
}else{
this.updateComponent(component)
}
},
'onMove':function updateRender(component){
this.updateComponent(component)
},
'onInsert':function insertRender(component){
this.insertComponent(component)
},
'onRemove':function removeRender(component){
this.removeComponent(component)
}
},
isConfigEmpty:function(config){
return!config||Object.keys(config).length===0
},
createRenderer:function(config,component){
var func;
if(this.isConfigEmpty(config)){
func=this.renders.default.bind(this,component);
func.match='update';
return func
}
if(config.moveOnly){
func=this.renders.onMove.bind(this,component);
func.match='update';
return func
}
if(config.onInsert){
func=this.renders.onInsert.bind(this,component);
func.match='insert';
return func
}
if(config.onRemove){
func=this.renders.onRemove.bind(this,component);
func.match='remove';
return func
}
},
removeUpdates:function(stack){
return stack.filter(function(render){
return render.match!=='update'
})
},
createAdjustStackPusher:function(component,config){
var componentId=component.getId(),componentStack=this.adjustStack[componentId]||[],componentActions=componentStack.componentActions||{},isUpdatePrevented=componentActions.insert||componentActions.remove,pushStack=function(render){
componentStack.push(render);
componentStack.componentActions=componentActions;
this.adjustStack[componentId]=componentStack
}.bind(this),empty=function(){
};
if(this.isConfigEmpty(config)&&!isUpdatePrevented){
return pushStack
}else if(this.isConfigEmpty(config)&&isUpdatePrevented){
return empty
}
if(config.moveOnly&&!isUpdatePrevented&&!component.isDocument()){
return pushStack
}
if(config.onRemove&&!component.isDocument()){
componentStack=this.removeUpdates(componentStack);
componentActions.remove=true;
return pushStack
}
if(config.onInsert&&!component.isDocument()){
componentStack=this.removeUpdates(componentStack);
componentActions.insert=true;
return pushStack
}
return empty
},
onComponentAdjust:function(component,config){
var render,pushStack;
if(config&&config.calcOnly){
return
}
pushStack=this.createAdjustStackPusher(component,config);
component.finalAutoTop=null;
this.redrawing=true;
render=this.createRenderer(config,component);
pushStack(render)
},
renderStack:function(){
var id,adjustments=this.adjustStack,docComponents=this.filterDocAdjustments(adjustments);
this.adjustStack={};
if(docComponents){
adjustments=docComponents
}
for(id in adjustments){
if(adjustments[id]&&adjustments.hasOwnProperty(id)){
adjustments[id].forEach(function(render){
render()
})
}
}
this.redrawing=false;
if(docComponents){
this.fireEvent('afterredraw',{docs:true})
}else{
this.fireEvent('afterredraw')
}
},
filterDocAdjustments:function(adjustments){
var id,page=this.app.getSelected('page'),template=page.getTemplate(),returnComponents;
for(id in adjustments){
if(adjustments.hasOwnProperty(id)){
if(id===page.id||id===template.id){
returnComponents={};
returnComponents[page.id]=adjustments[id];
break
}
}
}
return returnComponents
}
});
Ext.override(web.workspace.Panel,{
initInterface:function(){
this.on('redraw',function(part){
this.clearEls(part)
},this);
this.on('reflow',function(part){
this.clearEls(part)
},this);
this.clearEls()
},
clearEls:function(part){
if(part&&!part.isDocument()){
delete this.componentEls[part.id];
delete this.componentOuterRegions[part.id];
delete this.componentRegions[part.id];
delete this.componentInnerRegions[part.id];
delete this.contentRegions[part.id]
}else{
this.componentEls={};
this.componentOuterRegions={};
this.componentRegions={};
this.componentInnerRegions={};
this.contentRegions={};
this.cashedScroll=undefined
}
},
getComponentOuterEl:function(component){
var el=this.getComponentEl(component),parentEl=el?el.parent():null;
el=parentEl&&parentEl.hasClass('marginwrapper')?parentEl:el;
return el
},
getComponentEl:function(component){
var id,el;
if(!component){
one.fatal('Workspace panel getComponentEl method called without component.')
}else if(!component.getId){
one.fatal('Workspace panel getComponentEl method called with invalid component.',component)
}else{
id=component.getId();
el=this.componentEls[id];
if(!el){
if(component instanceof web.data.components.Template){
el=this.baseEl
}else if(component instanceof web.data.components.Page){
el=this.deskEl
}else{
el=this.contentEl.child('*[data-id='+id+']')
}
this.componentEls[id]=el
}
}
return el
},
getComponentOuterRegion:function(component){
var id,region,el;
if(!component){
one.fatal('Workspace panel getComponentOuterRegion method called without component.')
}else if(!component.getId){
one.fatal('Workspace panel getComponentOuterRegion method called with invalid component.',component)
}else{
id=component.getId();
region=this.componentOuterRegions[id];
if(!region){
el=this.getComponentOuterEl(component);
region=el?this.adjustRegion(el.getRegion()):null;
this.componentOuterRegions[id]=region
}
}
return region
},
getComponentRegion:function(component){
var id,region,el;
if(!component){
one.fatal('Workspace panel getComponentRegion method called without component.')
}else if(!component.getId){
one.fatal('Workspace panel getComponentRegion method called with invalid component.',component)
}else{
id=component.getId();
region=this.componentRegions[id];
if(!region){
el=this.getComponentEl(component);
region=el?this.adjustRegion(el.getRegion()):null;
this.componentRegions[id]=region
}
}
return region
},
getComponentInnerRegion:function(component){
var id,region,spacing,el,height;
if(!component){
one.fatal('Workspace panel getComponentInnerRegion method called without component.')
}else if(!component.getId){
one.fatal('Workspace panel getComponentInnerRegion method called with invalid component.',component)
}else{
id=component.getId();
region=this.componentInnerRegions[id];
if(!region){
var isTemplate=component instanceof web.data.components.Template,isStretch=component.isStretch();
if(isTemplate||isStretch){
region=this.getComponentRegion(component);
height=region.bottom-region.top;
el=this.upperEl;
region=this.adjustRegion(el.getRegion());
region.bottom=region.top+Math.max(height,10000)
}
if(!isTemplate){
var templateRegion=region;
spacing=component.getSpacing();
region=this.getComponentRegion(component);
region=this.copyRegion(region,spacing.top,spacing.left,-spacing.bottom,-spacing.right);
if(isStretch&&templateRegion){
region.constrainTo(templateRegion)
}
}
this.componentInnerRegions[id]=region
}
}
return region
},
getContentRegion:function(component){
var id,region,selfEl,firstEl,lastEl;
if(!component){
one.fatal('Workspace panel getSelfRegion method called without component.')
}else if(!component.getId){
one.fatal('Workspace panel getSelfRegion method called with invalid component.',component)
}else{
id=component.getId();
region=this.contentRegions[id];
if(!region){
selfEl=this.getSelfEl(component);
if(selfEl){
firstEl=selfEl.first();
lastEl=selfEl.last();
region=this.adjustRegion(firstEl?lastEl&&firstEl!==lastEl?firstEl.getRegion().union(lastEl.getRegion()):firstEl.getRegion():selfEl.getRegion())
}else{
region=this.getComponentRegion(component)
}
this.contentRegions[id]=region
}
}
return region
},
getSelectedEl:function(){
var selected=this.app.getSelected('component');
return this.getComponentEl(selected)
},
getSelfEl:function(part){
var el=this.getComponentEl(part),selfEl;
if(el&&el.dom){
selfEl=el.first('.self')||el.first('.component').first('.self')
}else{
selfEl=null
}
return selfEl
},
getElComponent:function(el){
var id;
el=Ext.get(el);
while(el&&el.dom&&el.dom.getAttribute&&!id){
id=el.dom.getAttribute('data-id');
el=el.parent()
}
return id?this.app.dm.get(id):null
},
isBeingRedrawn:function(){
return this.redrawing
},
getLastTargetedComponent:function(){
return this.lastTargetedComponent
},
adjustRegion:function(region){
var pregion=this.getElRegion(),scroll=this.getElScroll(),x=-pregion.left+scroll.left,y=-pregion.top+scroll.top;
return this.copyRegion(region,y,x,y,x)
},
getElRegion:function(){
if(!this.cashedElRegion){
this.refreshElRegion()
}
return this.cashedElRegion
},
getBaseElRegion:function(){
if(!this.cashedBaseElRegion){
this.refreshBaseElRegion()
}
return this.cashedBaseElRegion
},
getViewSize:function(){
if(!this.cashedElSize){
this.refreshElRegion()
}
return this.cashedElSize
},
getDeskElRegion:function(){
if(!this.cachedDeskElRegion){
this.refreshElRegion()
}
return this.cachedDeskElRegion
},
refreshElRegion:function(){
this.cashedElRegion=this.el.getRegion();
this.cashedElSize=this.el.getViewSize();
this.refreshBaseElRegion();
if(this.deskEl){
this.deskEl.dom.style.width=this.cashedElSize.width+'px';
this.deskEl.dom.style.width=this.cashedElSize.width+'px';
this.cachedDeskElRegion=this.deskEl.getRegion();
this.contentEl.setWidth(this.cachedDeskElRegion.right-this.cachedDeskElRegion.left);
this.contentEl.setHeight(this.cachedDeskElRegion.bottom-this.cachedDeskElRegion.top)
}
},
refreshBaseElRegion:function(){
this.cashedBaseElRegion=this.baseEl.getRegion()
},
getElScroll:function(){
if(!this.cashedScroll){
this.cashedScroll=this.el.getScroll()
}
return this.cashedScroll
},
unadjustRegion:function(region){
var pregion=this.getElRegion(),scroll=this.getElScroll(),x=-pregion.left+scroll.left,y=-pregion.top+scroll.top;
return this.copyRegion(region,-y,-x,-y,-x)
},
copyRegion:function(region,t,l,b,r){
if(!region){
return region
}
return new Ext.lib.Region(region.top+(t?t:0),region.right+(r?r:0),region.bottom+(b?b:0),region.left+(l?l:0))
},
getPoint:function(event){
var xy=Ext.isArray(event)?event:event.getXY();
return this.adjustRegion(new Ext.lib.Point(xy))
},
getViewportRegion:function(){
var scroll=this.getElScroll(),viewSize=this.getViewSize();
return new Ext.lib.Region(scroll.top,scroll.left+viewSize.width,scroll.top+viewSize.height,scroll.left)
},
isActive:function(exclude){
return this.boxSelect&&this.boxSelect.active||this.edgeMove&&this.edgeMove.active||this.multiSelectMove&&this.multiSelectMove!==exclude&&this.multiSelectMove.active||this.multiSelectResize&&this.multiSelectResize!==exclude&&this.multiSelectResize.active||this.multiSelectEdge&&this.multiSelectEdge!==exclude&&this.multiSelectEdge.active||this.select&&this.select!==exclude&&this.select.active||this.dragging&&!(exclude instanceof web.dd.WorkspaceDrag)
}
});
Ext.override(web.workspace.Panel,{
calcRels:function(changes){
var template=this.app.getSelected('template'),items=[template].concat(template.getAllItems()),selected=this.multiSelect.selected,dm=this.app.dm,isIndexChange,isLocChange,id;
function getFluxBBox(item){
var change=changes[item.id]||{};
return change.bbox||item.getBBox()
}
var newItems=[];
items.forEach(function(item){
var change=changes[item.id],loc=change?change.location:undefined,isLoc=loc!==undefined;
if(isLoc&&loc===''||!isLoc&&!item.isGhost()){
if(isLoc){
item.location=loc;
isLocChange=true
}
newItems.push(item)
}
},this);
items=newItems;
for(id in changes){
if(changes.hasOwnProperty(id)){
var change=changes[id],cmp=template.dm.get(id);
if(items.indexOf(cmp)===-1){
items.push(cmp);
change.add=true
}
isIndexChange=isIndexChange||change.index!==undefined||change.parentId
}
}
if(isIndexChange){
var sortScores={};
items.forEach(function(a){
var aCfg=changes[a.id]||{},aCfgPId=aCfg.parentId||(a.parent?a.parent.id:a.parentId),aCfgStretch=aCfg.stretch!==undefined?aCfg.stetch:a.isStretch(),aPageIndex=aCfgPId?aCfgPId===template.id?0:16000:!a.inPage()?0:16000,aStretch=aCfgStretch?0:8000,aAdd=aCfg.add||aCfg.parentId?4000:0,aIndex=aCfg.index!==undefined?aCfg.index-0.5:a.getIndex(),aScore=aPageIndex+aStretch+aAdd+aIndex;
sortScores[a.id]=aScore
});
items.sort(function(a,b){
return sortScores[a.id]-sortScores[b.id]
},this)
}
items.forEach(function(u,uIndex){
var uid=u.id,ucfg=changes[uid]||{},ubb=ucfg.bbox||u.bbox;
if(ucfg.remove){
items.forEach(function(o,oIndex){
var oid=o.id,ocfg=changes[oid]||{},obb=ocfg.bbox||o.bbox,oheight=obb.bottom-obb.top,orin=ocfg.relIn||o.relIn;
if(orin&&orin.id===uid){
obb.top=ubb.top+orin.top;
obb.bottom=o.bbox.top+oheight
}
})
}
});
var relInMap={};
items.forEach(function(o,oIndex){
var oid=o.id,ocfg=changes[oid]||{},obbox,opoint;
if(ocfg.remove){
return
}
if(ocfg.stretch!==undefined?ocfg.stretch:o.isStretch()){
relInMap[oid]=template.id;
return
}
obbox=getFluxBBox(o);
opoint=new Ext.lib.Point(Math.round((obbox.left+obbox.right)/2),Math.round((obbox.top+obbox.bottom)/2));
items.forEach(function(u,uIndex){
if(uIndex<oIndex){
var uid=u.id,ucfg=changes[uid]||{},utemplate=u instanceof web.data.components.Template,ubbox,uregion;
if(oid===uid){
return
}
if(ucfg.remove){
return
}
ubbox=getFluxBBox(u);
uregion=new Ext.lib.Region(ubbox.top,ubbox.right,ubbox.bottom,ubbox.left);
if(utemplate||uregion.contains(opoint)){
relInMap[oid]=uid
}
}
},this)
},this);
items.forEach(function(o,oIndex){
var oid=o.id,ocfg=changes[oid]||{},oldRelIn=o.getRelInParent()||{},newRelInId=relInMap[oid],uid=newRelInId||oldRelIn.id,u=o.dm.get(uid),ucfg=changes[uid]||{};
if(ocfg.remove||ucfg.remove){
return
}
if(newRelInId&&(newRelInId!==oldRelIn.id||ocfg.bbox)||ucfg.bbox){
var ubbox=getFluxBBox(u),obbox=getFluxBBox(o);
if(newRelInId===template.id){
ocfg.relIn=null
}else{
ocfg.relIn={
id:newRelInId,
top:obbox.top-ubbox.top,
right:obbox.right-ubbox.right,
bottom:obbox.bottom-ubbox.bottom,
left:obbox.left-ubbox.left
}
}
changes[oid]=ocfg
}
});
var relParas={},relParaGroups={};
items.forEach(function(o){
var newRelPara,oid=o.id,ocfg=changes[oid]||{},obbox=getFluxBBox(o),oregion=this.getBBoxRegion(obbox),ocx=Math.round((oregion.left+oregion.right)/2),uid=relInMap[o.id],u=o.dm.get(uid);
if(ocfg.remove){
return
}
if(!o.relPara&&!ocfg.wrap){
return
}
if(selected.indexOf(u)>=0){
relParas[oid]=o.getRelPara();
return
}
if(u instanceof web.data.components.Text){
var isTable=u instanceof web.data.components.Table,uel=this.getComponentEl(u),ucfg=changes[u.id]||{},ubbox=getFluxBBox(u),uregion=uel?this.adjustRegion(uel.getRegion()):null,paraEls=uel?uel.select('[data-index]'):null,lastIndex=paraEls?paraEls.getCount()-1:0,cellEl,rowEl,cellParaIndex,lastCellEl,top=uregion?uregion.top:ubbox.top,correction=ubbox.top-top,bottom;
if(!uel){
return
}
if(ucfg.remove){
return
}
newRelPara=null;
paraEls.each(function(paraEl,els,index){
if(newRelPara){
return
}
var paraRegion=this.adjustRegionToBBox(paraEl.getRegion()),offset;
if(!isLocChange){
paraRegion.adjust(correction,0,correction,0)
}
if(isTable){
cellEl=paraEl.parent('td');
rowEl=paraEl.parent('tr');
if(cellEl){
cellParaIndex=cellEl===lastCellEl?cellParaIndex+1:0;
lastCellEl=cellEl;
var cellRegion=this.adjustRegionToBBox(cellEl.getRegion());
if(!cellParaIndex){
paraRegion.top=Math.min(cellRegion.top,paraRegion.top)
}
paraRegion.left=cellRegion.left;
paraRegion.right=cellRegion.right
}
top=Math.min(paraRegion.top,top);
if(paraRegion.top>top){
top=paraRegion.top
}
}
offset=oregion.top-top;
bottom=paraRegion.bottom;
var isAbove=oregion.top<bottom;
if((!index||isTable&&!cellParaIndex||offset>=0)&&(isAbove||index===lastIndex)&&paraRegion.left<=ocx&&ocx<=paraRegion.right){
if(isTable&&rowEl){
var rowIndex=Array.prototype.indexOf.call(rowEl.parent().dom.childNodes,rowEl.dom);
if(!cellParaIndex&&cellEl){
offset-=cellEl.getFrameWidth('t')
}
newRelPara={
row:rowIndex,
cellIndex:cellParaIndex,
index:index,
offset:offset
}
}else{
if(isAbove){
newRelPara={
index:index,
offset:offset
}
}else{
newRelPara={
index:index+1,
offset:oregion.top-bottom
}
}
}
}
top=bottom
},this);
relParas[o.id]=newRelPara;
relParaGroups[u.id]=relParaGroups[u.id]||[];
relParaGroups[u.id].push(o)
}
},this);
for(id in relParaGroups){
if(relParaGroups.hasOwnProperty(id)){
var group=relParaGroups[id],isTable=this.app.dm.get(id)instanceof web.data.components.Table;
group.forEach(function(o){
var ob=getFluxBBox(o),op=relParas[o.id];
group.forEach(function(u){
if(o!==u){
var ub=getFluxBBox(u),up=relParas[u.id];
if(up&&op&&ub.top>ob.top&&ub.left<ob.right&&ob.left<ub.right&&ub.top-ob.bottom<=50&&(!isTable||up.row===op.row)){
up.offset=op.offset-ob.top+ub.top;
up.index=op.index;
if(isTable){
up.cellIndex=op.cellIndex
}
}
}
})
})
}
}
items.forEach(function(item){
var oldRelPara=item.getRelPara(),newRelPara=relParas[item.id],uid=relInMap[item.id],u=item.dm.get(uid),oActive=selected.indexOf(item),uActive=selected.indexOf(u),change=changes[item.id]||{};
if(oActive===uActive){
return
}
if(Ext.encode(oldRelPara)!==Ext.encode(newRelPara)){
change.relPara=newRelPara;
changes[item.id]=change
}
});
var sibsMap={};
items.forEach(function(item){
var rid=item instanceof web.data.components.Template?null:relInMap[item.id];
if(rid){
sibsMap[rid]=sibsMap[rid]||[];
sibsMap[rid].push(item)
}
});
function getFluxInPage(item){
var change=changes[item.id]||{};
return!change.parentId?item.inPage():change.parentId!==template.id
}
items.forEach(function(u){
var oldRelTo=u.getRelTo(),newRelTo,uid=u.id,ucfg=changes[uid]||{},ubbox=getFluxBBox(u),upage=getFluxInPage(u),urelinid=relInMap[uid]||{},sibs=sibsMap[urelinid]||[],maxOverlap=0;
if(ucfg.remove){
return
}
var options=[],optionChainParentMap={};
sibs.forEach(function(o){
var oid=o.id,obbox=getFluxBBox(o),opage=getFluxInPage(o),below=ubbox.top-obbox.bottom;
if(oid===uid){
return
}
var uleft=ubbox.left,uright=ubbox.right,oleft=obbox.left,oright=obbox.right;
var overlapLeft=Math.max(oleft,uleft),overlapRight=Math.min(oright,uright),overlap=overlapRight-overlapLeft;
if(below>=0&&overlap>0&&(upage||!opage)){
options.push({
below:below,
left:overlapLeft,
right:overlapRight,
overlap:overlap,
item:o
});
if(o.relTo){
optionChainParentMap[o.relTo.id]=true
}
}
},this);
options.sort(function(a,b){
return a.below-b.below
});
for(var i=options.length-1;i>0;i-=1){
var iOption=options[i];
for(var j=i-1;j>=0;j-=1){
var jOption=options[j];
if(iOption.left<jOption.right&&jOption.left<iOption.right){
options.splice(i,1);
break
}
}
}
options.forEach(function(option){
var overlap=option.overlap,item=option.item;
if(overlap>maxOverlap&&!optionChainParentMap[item.id]){
newRelTo={
id:item.id,
below:option.below
};
maxOverlap=overlap
}
});
if(Ext.encode(oldRelTo)!==Ext.encode(newRelTo)){
ucfg.relTo=newRelTo;
changes[uid]=ucfg
}
});
function getFluxRelToItem(item){
var change=changes[item.id]||{};
return change.relTo?dm.get(change.relTo.id):item.getRelToItem()
}
var pageRegionsMap={},templateItemMap={};
for(id in sibsMap){
if(sibsMap.hasOwnProperty(id)){
var sibs=sibsMap[id],pageRegions={};
sibs.forEach(function(sib){
var sid=sib.id,scfg=changes[sid]||{};
if(!sib.inPage()&&(!scfg.parentId||scfg.parentId===template.id)){
return
}
var bb=getFluxBBox(sib),region=new Ext.lib.Region(bb.top,bb.right,bb.bottom,bb.left);
if(scfg.add&&scfg.relTo){
var relItem=sib.dm.get(scfg.relTo.id);
sib=relItem?relItem:sib
}
var templateItem=sib.getRelToTemplate(),tid=templateItem?templateItem.id:0,pageRegion=pageRegions[tid];
if(region){
templateItemMap[sid]=templateItem;
pageRegions[tid]=pageRegion?pageRegion.union(region):this.copyRegion(region)
}
},this);
pageRegionsMap[id]=pageRegions
}
}
items.forEach(function(u){
var oldRelPage=u.getRelPage(),newRelPage=oldRelPage||{},uid=u.id,ucfg=changes[uid]||{},ubbox=getFluxBBox(u),upage=getFluxInPage(u),urelinid=relInMap[uid]||{},sibs=sibsMap[urelinid]||[],pageRegions=pageRegionsMap[urelinid]||{},minPageBelow=Infinity;
if(ucfg.remove){
return
}
if(upage){
return
}
delete newRelPage[pageId];
var relToItem=getFluxRelToItem(u),relToItemBBox=relToItem?getFluxBBox(relToItem):null,pageId=this.app.getSelected('page').id;
delete newRelPage[pageId];
sibs.forEach(function(o){
var oid=o.id,obbox=getFluxBBox(o),opage=getFluxInPage(o),below=ubbox.top-obbox.bottom;
if(!opage){
return
}
var uleft=ubbox.left,uright=ubbox.right,oleft=obbox.left,oright=obbox.right;
var overlap=Math.min(oright,uright)-Math.max(oleft,uleft);
if(below>=0&&overlap>0&&below<minPageBelow&&obbox.bottom>=0&&(!relToItem||obbox.bottom>relToItemBBox.top)){
var templateItem=templateItemMap[oid],tid=templateItem?templateItem.id:0,pageRegion=pageRegions[tid];
if(!pageRegion||pageRegion.bottom>ubbox.top){
return
}
newRelPage[pageId]=below;
minPageBelow=below
}
},this);
if(u.type!=='web.data.components.Template'&&Ext.encode(oldRelPage)!==Ext.encode(newRelPage)){
ucfg.relPage=newRelPage;
changes[uid]=ucfg
}
},this);
delete changes[template.id];
return changes
}
});
Ext.override(web.workspace.Panel,{
toSnapRegion:function(region,edges){
var prox=10,snap=this.copyRegion(region),template=this.app.getSelected('template'),items=template.getAllItems().concat([template]),exclude=this.multiSelect.selected,excludeEdge={},width=region.right-region.left,height=region.bottom-region.top,dvm=prox,dhm=prox,vpRegion=this.getViewportRegion();
if(edges){
[
'top',
'right',
'bottom',
'left'
].forEach(function(name){
excludeEdge[name]=edges.indexOf(name)===-1
})
}
region.middle=Math.round((region.top+region.bottom)/2);
region.center=Math.round((region.left+region.right)/2);
items=items.filter(function(item){
var outer=item.getParent()?this.getComponentRegion(item):this.getComponentInnerRegion(item);
return!item.isGhost()&&vpRegion.intersect(outer)
}.bind(this));
items.forEach(function(item){
var outer=item.getParent()?this.getComponentRegion(item):this.getComponentInnerRegion(item);
if(outer&&exclude.indexOf(item)===-1){
var dtb=Math.abs(outer.bottom-region.top),dbt=Math.abs(outer.top-region.bottom);
if(!excludeEdge.top&&dtb<dvm){
snap.top=outer.bottom;
if(!excludeEdge.bottom){
snap.bottom=snap.top+height
}
dvm=dtb
}
if(!excludeEdge.bottom&&dbt<dvm){
snap.bottom=outer.top;
if(!excludeEdge.top){
snap.top=snap.bottom-height
}
dvm=dbt
}
var dtt=Math.abs(outer.top-region.top),dbb=Math.abs(outer.bottom-region.bottom);
if(!excludeEdge.top&&dtt<dvm){
snap.top=outer.top;
if(!excludeEdge.bottom){
snap.bottom=snap.top+height
}
dvm=dtt
}
if(!excludeEdge.bottom&&dbb<dvm){
snap.bottom=outer.bottom;
if(!excludeEdge.top){
snap.top=snap.bottom-height
}
dvm=dbb
}
var dlr=Math.abs(outer.right-region.left),drl=Math.abs(outer.left-region.right);
if(!excludeEdge.left&&dlr<dhm){
snap.left=outer.right;
if(!excludeEdge.right){
snap.right=snap.left+width
}
dhm=dlr
}
if(!excludeEdge.right&&drl<dhm){
snap.right=outer.left;
if(!excludeEdge.left){
snap.left=snap.right-width
}
dhm=drl
}
var dll=Math.abs(outer.left-region.left),drr=Math.abs(outer.right-region.right);
if(!excludeEdge.left&&dll<dhm){
snap.left=outer.left;
if(!excludeEdge.right){
snap.right=snap.left+width
}
dhm=dll
}
if(!excludeEdge.right&&drr<dhm){
snap.right=outer.right;
if(!excludeEdge.left){
snap.left=snap.right-width
}
dhm=drr
}
outer.middle=Math.round((outer.top+outer.bottom)/2);
outer.center=Math.round((outer.left+outer.right)/2);
var dmm=Math.abs(outer.middle-region.middle);
if(dmm<dvm){
if(excludeEdge.bottom){
snap.top=outer.middle*2-region.bottom
}else if(excludeEdge.top){
snap.bottom=outer.middle*2-region.top
}else{
snap.top=outer.middle-Math.round(height/2);
snap.bottom=snap.top+height
}
dvm=dmm
}
var dcc=Math.abs(outer.center-region.center);
if(dcc<dhm){
if(excludeEdge.right){
snap.left=outer.center*2-region.right
}else if(excludeEdge.left){
snap.right=outer.center*2-region.left
}else{
snap.left=outer.center-Math.round(width/2);
snap.right=snap.left+width
}
dhm=dcc
}
}else{
var aspect=item.getAspectRatio(),snapSize=item.getSnapSize(),handle=(edges||[]).join(',').replace(/,$/,''),isCorner=/,/.test(handle);
if(aspect&&!isCorner){
if(handle==='left'){
if(Math.abs(width-height*aspect)<dhm){
snap.left=Math.round(region.right-height*aspect)
}
}else if(handle==='right'){
if(Math.abs(width-height*aspect)<dhm){
snap.right=Math.round(region.left+height*aspect)
}
}else if(handle==='top'){
if(Math.abs(height-width/aspect)<dvm){
snap.top=Math.round(region.bottom-width/aspect)
}
}else if(handle==='bottom'){
if(Math.abs(height-width/aspect)<dvm){
snap.bottom=Math.round(region.top+width/aspect)
}
}
}
if(snapSize&&handle){
if(Math.abs(width-snapSize.width)<dhm){
if(/left/.test(handle)){
snap.left=region.right-snapSize.width
}
if(/right/.test(handle)){
snap.right=region.left+snapSize.width
}
}
if(Math.abs(height-snapSize.height)<dvm){
if(/top/.test(handle)){
snap.top=region.bottom-snapSize.height
}
if(/bottom/.test(handle)){
snap.bottom=region.top+snapSize.height
}
}
}
}
},this);
var targets=[];
items.forEach(function(item){
if(item instanceof web.data.components.Text&&exclude.indexOf(item)===-1){
var outer=this.getComponentRegion(item);
if(outer&&outer.intersect(region)){
targets.push(item)
}
}
},this);
targets.forEach(function(target){
var targetEl=this.getComponentEl(target),paraEls=targetEl.select('[data-index]');
paraEls.each(function(el){
var outer=this.adjustRegion(el.getRegion());
var dtt=Math.abs(outer.top-region.top);
if(dtt<dvm&&outer.top<snap.bottom){
snap.top=outer.top;
snap.bottom=snap.top+height;
dvm=dtt
}
},this)
},this);
return snap
}
});
Ext.override(web.workspace.Panel,{
initSelect:function(){
this.addEvents('multiselect')
},
isSelected:function(){
return this.multiSelect.selected.length
},
getSelected:function(){
return this.multiSelect.selected
},
setSelected:function(mixed){
this.multiSelect.select(Ext.isArray(mixed)?mixed:[mixed])
}
});
Ext.override(web.workspace.Panel,{
getBBoxRegion:function(component){
var inner=this.getComponentInnerRegion(this.app.getSelected('template')),bbox=component.getBBox?component.getBBox():component;
return new Ext.lib.Region(bbox.top+inner.top,bbox.right+inner.left,bbox.bottom+inner.top,bbox.left+inner.left)
},
adjustRegionToBBox:function(region){
var result=this.adjustRegion(region),dregion=this.deskEl.getRegion(),tregion=this.lowerEl.getRegion(),vadjust=tregion.top-dregion.top;
result.adjust(vadjust,0,vadjust,0);
return result
},
getRegionBBox:function(component){
var inner=this.getComponentInnerRegion(this.app.getSelected('template')),bbox=component.getBBox?component.getBBox():component;
return new Ext.lib.Region(bbox.top-inner.top,bbox.right-inner.left,bbox.bottom-inner.top,bbox.left-inner.left)
},
getIdealRelTo:function(component){
var sibs=component.getRelInSiblings(),region=this.getComponentRegion(component)||this.getBBoxRegion(component),inPage=component.inPage(),minBelow=Infinity,relTo=null;
sibs.forEach(function(item){
var other=this.getComponentRegion(item)||this.getBBoxRegion(item),below=region.top-other.bottom;
if(below>=0&&other.right>region.left&&other.left<region.right){
if(below<minBelow){
relTo={};
if(!inPage&&item.inPage()){
relTo.page=true
}else{
relTo.id=item.id
}
relTo.below=below;
minBelow=below
}
}
},this);
return relTo
}
});
Ext.override(web.workspace.Panel,{
getComputedBackground:function(part){
var app=this.app,bgImage,bgColor,bgGrad,bgSize,doc,css,parent=part,pw,ph,parentBS,parentBg,parentColor,pAsset,pRegion,pGrad,fRegion,x=0,y=0,left,top,stops,startStop,endStop,startOffset,endOffset,width,height,partEl=this.getComponentEl(part),found=false,operation;
if(partEl){
while(parent){
if(!(parent instanceof web.data.components.Component)){
parent=parent.getRenderParent();
continue
}
if(parent instanceof web.data.components.Template){
parentBS=parent.getStylesheet().getStyleByRef('body','StyleBlock')
}else if(parent.getStyle){
parentBS=parent.getStyle()
}
if(parentBS){
parentBg=parentBS.getBackground();
parentColor=parentBg.getColor();
pAsset=parentBg.asset;
pGrad=parentBg.gradient;
if(pAsset&&!bgImage){
pRegion=this.getComponentRegion(parent);
fRegion=this.getComponentRegion(part);
bgSize=null;
if(parentBg.size===null){
bgSize=100
}else if(parentBg.size==='fit'||parentBg.size==='fill'){
pw=pRegion.right-pRegion.left;
ph=pRegion.bottom-pRegion.top;
if(parent instanceof web.data.components.Template){
pw=Ext.fly(Ext.query('.body')[0]).getWidth();
ph=Ext.fly(Ext.query('.body')[0]).getHeight()
}
operation={
'fit':Math.min,
'fill':Math.max
}[parentBg.size];
bgSize=100*operation(pw/pAsset.width,ph/pAsset.height)
}else{
bgSize=parentBg.size
}
left=pRegion.left;
top=pRegion.top;
if(Ext.isArray(parentBg.position)){
x=parentBg.position[0];
y=parentBg.position[1]
}
x=isNaN(x)?(pRegion.right-left-pAsset.width*bgSize/100)*parseInt(x,10)/100:x;
y=isNaN(y)?(pRegion.bottom-top-pAsset.height*bgSize/100)*parseInt(y,10)/100:y;
x+=left-fRegion.left;
y+=top-fRegion.top;
bgImage=new web.data.styles.Background({
asset:pAsset.toJSON(),
repeat:Ext.isArray(parentBg.repeat)?[
parentBg.repeat[0],
parentBg.repeat[1]
]:null,
position:[
x,
y
],
size:parentBg.size===null?null:bgSize
});
found=true
}
if(pGrad){
bgGrad=new web.data.styles.Background({gradient:pGrad.toJSON()});
if(pGrad.gradType==='linear'){
pRegion=this.getComponentRegion(parent);
fRegion=this.getComponentRegion(part);
stops=bgGrad.gradient.stops;
startStop=stops[0];
endStop=stops[1];
if(pGrad.origin==='top'){
height=pRegion.bottom-pRegion.top;
if(height){
startOffset=this.adjustGradientStop(height,fRegion.bottom-fRegion.top,pRegion.top,fRegion.top,parseInt(startStop[1],10));
endOffset=this.adjustGradientStop(height,fRegion.bottom-fRegion.top,pRegion.top,fRegion.top,parseInt(endStop[1],10))
}
}else{
width=pRegion.right-pRegion.left;
if(width){
startOffset=this.adjustGradientStop(width,fRegion.right-fRegion.left,pRegion.left,fRegion.left,parseInt(startStop[1],10));
endOffset=this.adjustGradientStop(width,fRegion.right-fRegion.left,pRegion.left,fRegion.left,parseInt(endStop[1],10))
}
}
stops[0][1]=startOffset+'%';
stops[1][1]=endOffset+'%'
}
if(Ext.isIE8){
bgColor=new web.data.styles.Background({color:bgGrad.gradient.stops[0][0]});
bgGrad=null
}
found=true;
break
}
if(parentColor){
bgColor=new web.data.styles.Background({color:parentColor.toJSON()});
found=true;
break
}
}
parent=parent.getRenderParent()
}
if(found){
doc=new web.Document({
dm:app.dm,
domain:app.dal.domain
});
css=bgColor?bgColor.getCSSDeclarations(doc):'';
css+=bgImage?bgImage.getCSSDeclarations(doc):'';
css+=bgGrad?bgGrad.getCSSDeclarations(doc):'';
return{
color:bgColor,
image:bgImage,
grad:bgGrad,
css:css
}
}
}
return null
},
getComputedBackgroundFromEl:function(el){
var component=this.getElComponent(el),offsets,bg;
if(!component){
return null
}
bg=this.getComputedBackground(component);
if(!bg){
return null
}
offsets=el.getOffsetsTo(this.getComponentEl(component));
if(bg.image){
bg.image.position[0]-=offsets[0];
bg.image.position[1]-=offsets[1]
}
var doc=new web.Document({
dm:this.app.dm,
domain:this.app.dal.domain
});
bg.css=bg.color?bg.color.getCSSDeclarations(doc):'';
bg.css+=bg.image?bg.image.getCSSDeclarations(doc):'';
bg.css+=bg.grad?bg.grad.getCSSDeclarations(doc):'';
return bg
},
adjustGradientStop:function(pWidth,cWidth,pLeft,cLeft,stop){
var stopWidth=pWidth*stop/100,leftPadding=cLeft-pLeft,offset=stopWidth-leftPadding;
return offset/cWidth*100
}
});
web.workspace.Toolbar=Ext.extend(Ext.Container,{
constructor:function(config){
Ext.apply(this,config);
this.addEvents(this.app.coreEvents);
web.workspace.Toolbar.superclass.constructor.call(this,config);
this.initListeners()
},
initComponent:function(){
Ext.apply(this,{
cls:'hbox workspace-toolbar',
defaults:{style:'margin-top: 4px; margin-right: 14px;'},
items:[
{
xtype:'container',
cls:'flex',
html:' '
},
{
xtype:'button',
cls:'btn-site-backups',
height:25,
text:'<img class="icon-backups" src="'+Ext.BLANK_IMAGE_URL+'"/>'+'Backups',
tooltip:'Restore your website to a previous version.',
handler:function(){
this.app.fireEvent('activate','preview',{mode:'backups'})
},
scope:this
},
{
xtype:'button',
cls:'x-btn-premium small outline upgrade-option',
text:'<span class="no-free-upgrade-offer">Upgrade</span><span class="free-upgrade-offer">Free Upgrade</span>',
handler:function(){
web.upgradeToPremiumViaPopup({
app:this.app,
source:'Workspace:PermanentBtn'
})
},
scope:this
},
{
itemId:'undo',
xtype:'button',
cls:'btn-undo-redo',
text:'<img class="icon icon-undo" src="'+Ext.BLANK_IMAGE_URL+'"/>'+'Undo',
tooltip:'Undo your latest action.',
style:'margin-top: 4px; margin-right: 14px; min-width: 70px',
height:25,
disabled:true,
handler:this.onUndo,
scope:this
},
{
itemId:'redo',
xtype:'button',
cls:'btn-undo-redo',
text:'<img class="icon icon-redo" src="'+Ext.BLANK_IMAGE_URL+'"/>'+'Redo',
tooltip:'Redo the latest undone action.',
style:'margin-top: 4px; margin-right: 14px; min-width: 70px',
height:25,
disabled:true,
handler:this.onRedo,
scope:this
}
]
});
web.workspace.Toolbar.superclass.initComponent.apply(this,arguments);
this.undoButton=this.getComponent('undo');
this.redoButton=this.getComponent('redo')
},
initListeners:function(){
var setButtonState=new Ext.util.DelayedTask(function(){
if(this.app.invoker.hasUndoActions()){
this.undoButton.enable()
}else{
this.undoButton.disable()
}
if(this.app.invoker.hasRedoActions()){
this.redoButton.enable()
}else{
this.redoButton.disable()
}
},this);
this.app.mon(this.app,'load',function(part){
this.undoButton.disable();
this.redoButton.disable()
},this);
this.app.mon(this.app,'update',function(part){
setButtonState.delay(200)
},this)
},
onUndo:function(){
this.undoButton.disable();
this.app.invoker.undo()
},
onRedo:function(){
this.redoButton.disable();
this.app.invoker.redo()
}
});
Ext.ns('one.form');
Ext.ns('one.localelib');
one.localelib.Base=function(localeData){
Ext.apply(this,localeData);
this.renderers={}
};
one.localelib.Base.prototype={
formatInterval:function(dateInterval){
if(dateInterval.getDominantMonthInterval().equals(dateInterval)){
return this.renderDate(dateInterval.firstDay,'yMMMM')
}else if(dateInterval.getDominantYearInterval().equals(dateInterval)){
return this.renderDate(dateInterval.firstDay,'y')
}else if(dateInterval.firstDay.getTime()===dateInterval.lastDay.getTime()){
return this.renderDate(dateInterval.firstDay,'yMMMEd')
}else{
return this.renderInterval(dateInterval,'yMMMd')
}
},
tr:function(keyName){
var text=this.texts[keyName]||'[!'+keyName+'!]';
if(arguments.length>1){
var args=arguments;
return text.replace(/\{(\d+)\}/g,function(dontCare,$1){
return args[parseInt($1,10)+1]
})
}else{
return text
}
},
trQuantity:function(patternByQuantity,number){
return this.getPatternRenderer(patternByQuantity[this.getQuantity(number)]).call(window,Array.prototype.slice.call(arguments,1))
},
renderList:function(list){
switch(list.length){
case 0:
return'';
case 1:
return list[0];
case 2:
if('2'in this.listPatterns){
return this.renderPattern(list,this.listPatterns['2'])
}
default:
var str=this.renderPattern(list.slice(-2),this.listPatterns.end||'{0}, {1}');
for(var i=list.length-3;i>=0;i-=1){
str=this.renderPattern([
list[i],
str
],!i&&this.listPatterns.start||this.listPatterns.middle||'{0}, {1}')
}
return str
}
},
tokenizePattern:function(pattern){
var tokens=[];
pattern.replace(/\{(\d+)\}|([^\{]+)/g,function($0,placeHolderNumber,text){
if(text){
tokens.push({
type:'text',
value:text
})
}else{
tokens.push({
type:'placeHolder',
value:parseInt(placeHolderNumber,10)
})
}
});
return tokens
},
makePatternRenderer:function(pattern){
if(pattern){
var predefinedCodeFragments=[].slice.call(arguments,1);
return new Function('values','return '+this.tokenizePattern(pattern).map(function(token){
if(token.type==='placeHolder'){
return predefinedCodeFragments[token.value]||'values['+token.value+']'
}else{
return'"'+token.value.replace(/\"/g,'\\"').replace(/\n/g,'\\n')+'"'
}
}).join('+')+';')
}else{
return function(){
return'[! makePatternRenderer: No pattern provided !]'
}
}
},
makeUnitRenderer:function(unit){
if(!(unit in this.units)){
unit=function(){
switch(unit){
case Date.YEAR:
return'year';
case Date.MONTH:
return'month';
case Date.WEEK:
return'week';
case Date.DAY:
return'day';
case Date.HOUR:
return'hour';
case Date.MINUTE:
return'minute';
case Date.SECOND:
return'second'
}
}()
}
var quantityRenderers={};
Ext.iterate(this.units[unit],function(quantity,pattern){
quantityRenderers[quantity]=this.makePatternRenderer(pattern)
},this);
return function(n){
return quantityRenderers[this.getQuantity(n)]([n])
}.createDelegate(this)
},
makeNumberRenderer:function(numDecimals,factor,prefix,suffix){
return new Function('num','return '+this.makeNumberRendererSource((typeof factor==='undefined'?'':''+factor+'*')+'num',numDecimals,prefix,suffix)+(suffix?'+\''+suffix.replace(/\'/g,'\\\'')+'\'':'')+';')
},
makePercentageRenderer:function(numDecimals){
return new Function('num','return '+this.makeNumberRendererSource('100*num',numDecimals,'',' '+this.numberSymbols.percentSign)+';')
},
makeFileSizeRenderer:function(numDecimals){
return new Function('size','if (size < 1000) {'+'return '+this.makeNumberRendererSource('size',0,'',' bytes')+';'+'} else if (size < 1000000) {'+'return '+this.makeNumberRendererSource('size/1024',numDecimals,'',' KB')+';'+'} else if (size < 1000000000) {'+'return '+this.makeNumberRendererSource('size/1048576',numDecimals,'',' MB')+';'+'} else if (size < 1000000000000) {'+'return '+this.makeNumberRendererSource('size/1073741824',numDecimals,'',' GB')+';'+'} else {'+'return '+this.makeNumberRendererSource('size/1099511627776',numDecimals,'',' TB')+';'+'}')
},
makeNumberRendererSource:function(sourceVariableNameOrExpression,numDecimals,prefix,suffix){
return(prefix?'\''+prefix.replace(/\'/g,'\\\'')+'\'+':'')+'('+sourceVariableNameOrExpression+')'+'.toFixed('+(numDecimals||0)+')'+(this.numberSymbols.decimalPoint==='.'?'':'.replace(\'.\', \''+this.numberSymbols.decimal.replace(/\'/g,'\\\'')+'\')')+(suffix?'+\''+suffix.replace(/\'/g,'\\\'')+'\'':'')
},
makeDateRenderer:function(formatId){
var format;
if(formatId==='hv'){
format=this.getDateFormat('shortTime').replace(/[\.:]i\s*/,'')
}else{
format=this.getDateFormat(formatId)
}
return Ext.util.Format.dateRenderer(format)
},
makeIntervalRenderer:function(formatId){
var greatestDifferences=this.intervalFormats[formatId];
if(!greatestDifferences){
var bestMatchingIntervalFormatId=this.getBestICUFormatId(formatId,this.intervalFormats);
if(bestMatchingIntervalFormatId){
greatestDifferences=Ext.apply({},this.intervalFormats[bestMatchingIntervalFormatId]);
Ext.iterate(greatestDifferences,function(key,value){
greatestDifferences[key]=this.adaptICUFormat(value,formatId)
},this)
}
}
if(greatestDifferences){
return this.makeIntervalRendererFromGreatestDifferences(greatestDifferences)
}else{
var dateFormat=this.getDateFormat(formatId),fallbackRenderer;
if(dateFormat){
var escapedDateFormat=dateFormat.replace(/\"/g,'\\"');
fallbackRenderer=this.getPatternRenderer(this.intervalFallbackFormat,'arguments[0].start.format("'+escapedDateFormat+'")','arguments[0].end.format("'+escapedDateFormat+'")')
}else{
throw'renderInterval: No usable interval format found for '+formatId
}
var m=formatId.match(/^([yMQEd]+)([Hhms]+)$/);
if(m){
var dateFormatId=m[1],timeFormatId=m[2];
return function(interval){
if(interval instanceof one.DateInterval){
return this.renderInterval(interval,dateFormatId)
}else if(interval.firstDay.sameDateAs(interval.lastDay)){
return this.renderDate(interval.firstDay,dateFormatId)+', '+this.renderInterval(interval,timeFormatId)
}else{
return fallbackRenderer(interval)
}
}.createDelegate(this)
}else{
return fallbackRenderer
}
}
},
getDateFormat:function(formatId){
var icuFormat=this.getICUDateFormat(formatId);
return icuFormat&&this.convertICUDateFormatToExt(icuFormat)
},
getICUDateFormat:function(formatId){
var icuFormat=this.dateFormats.basic[formatId]||this.dateFormats.cldr[formatId];
if(icuFormat){
return icuFormat
}else{
var bestCandidateFormatId=this.getBestICUFormatId(formatId,this.dateFormats.cldr);
if(bestCandidateFormatId){
this.dateFormats.cldr[formatId]=this.adaptICUFormat(this.dateFormats.cldr[bestCandidateFormatId],formatId);
return this.dateFormats.cldr[formatId]
}else{
var m=formatId.match(/^y+M+d+$/);
if(m){
this.dateFormats.cldr[formatId]=this.adaptICUFormat(this.dateFormats.basic.shortDate,formatId);
return this.dateFormats.cldr[formatId]
}
m=formatId.match(/^([yMQEd]+)([Hhms]+)$/);
if(m){
var dateFormat=this.getICUDateFormat(m[1]),timeFormat=this.getICUDateFormat(m[2]);
return dateFormat&&timeFormat&&this.renderPattern([
timeFormat,
dateFormat
],this.defaultDateTimePattern)
}else{
return
}
}
}
},
makeIntervalRendererFromFormatString:function(format){
var code=[],special=false,ch='',seenCodes={};
for(var i=0;i<format.length;i+=1){
ch=format.charAt(i);
if(!special&&ch==='\\'){
special=true
}else if(special){
special=false;
code.push('\''+String.escape(ch)+'\'')
}else{
code.push(Date.getFormatCode(ch).replace(/this/g,'interval.'+(seenCodes[ch]?'end':'start')));
seenCodes[ch]=1
}
}
return new Function('interval','return '+code.join('+')+';')
},
makeIntervalRendererFromGreatestDifferences:function(greatestDifferences){
var formatters=[],previousFormatter;
[
'y',
'M',
'd',
'a',
'h',
'm'
].forEach(function(ch,i){
var formatter;
if(ch in greatestDifferences){
formatter=this.makeIntervalRendererFromFormatString(this.convertICUDateFormatToExt(greatestDifferences[ch]));
if(!previousFormatter){
for(var j=0;j<i;j+=1){
formatters[j]=formatter
}
}
previousFormatter=formatters[i]=formatter
}else if(previousFormatter){
formatters[i]=previousFormatter
}
},this);
var intervalRenderers={};
for(var greatestDifference in greatestDifferences){
if(greatestDifferences.hasOwnProperty(greatestDifference)){
intervalRenderers[greatestDifference]=this.makeIntervalRendererFromFormatString(this.convertICUDateFormatToExt(greatestDifferences[greatestDifference]))
}
}
return function(interval){
if(interval.start.getFullYear()!==interval.end.getFullYear()){
return formatters[0](interval)
}else if(interval.start.getMonth()!==interval.end.getMonth()){
return formatters[1](interval)
}else if(interval.start.getDate()!==interval.end.getDate()){
return formatters[2](interval)
}else if(interval.start.getHours()>=12===interval.end.getHours()>=12){
return formatters[4](interval)
}else if(interval.start.getHours()!==interval.end.getHours()){
return formatters[3](interval)
}else{
return formatters[5](interval)
}
}
},
getBestICUFormatId:function(formatId,sourceObject){
var bestCandidateFormatId,matcher=new RegExp('^'+formatId.replace(/(([a-zA-Z])\2*)/g,function($0,formatToken,formatChar){
return formatChar+'{1,'+formatToken.length+'}'
})+'$');
for(var candidateFormatId in sourceObject){
if(matcher.test(candidateFormatId)){
if(!bestCandidateFormatId||candidateFormatId.length>bestCandidateFormatId.length){
bestCandidateFormatId=candidateFormatId
}
}
}
return bestCandidateFormatId
},
adaptICUFormat:function(icuFormat,adaptToFormatId){
adaptToFormatId.replace(/(([a-zA-Z])\2*)/g,function($0,formatToken,formatChar){
var regExpSource;
if(formatChar==='M'){
regExpSource='(([LM])\\2*)'
}else{
regExpSource='('+formatChar+'+)'
}
icuFormat=icuFormat.replace(new RegExp(regExpSource,'g'),function($0,actualFormatToken){
var result='';
for(var i=0;i<formatToken.length;i+=1){
result+=actualFormatToken.charAt(0)
}
return result
})
});
return icuFormat
},
convertICUDateFormatToExt:function(icuFormat){
return icuFormat.replace(/(([a-zA-Z])\2*)|(\'(?:[^\']|\'\')*\')/g,function($0,formatToken,formatChar,quotedString){
if(quotedString){
return quotedString.replace(/^\'|\'$/g,'').replace(/\'\'/g,'\'').replace(/(.)/g,'\\$1')
}else{
var candidates={
G:[''],
Q:[''],
A:[''],
E:[
'D',
'D',
'D',
'l'
],
d:[
'j',
'd'
],
L:[
'n',
'm',
'M',
'F'
],
M:[
'n',
'm',
'M',
'F'
],
y:['Y'],
H:['H'],
h:['g'],
m:['i'],
s:['s'],
a:['a'],
v:['T'],
z:[
'O',
'O',
'O',
'T'
]
}[formatChar];
if(candidates){
return candidates[Math.min(formatToken.length,candidates.length)-1]
}else{
throw'Unsupported format token: '+formatToken+' in format: '+icuFormat
}
}
})
}
};
[
'Unit',
'Number',
'Percentage',
'FileSize',
'Date',
'Interval',
'Pattern'
].forEach(function(rendererType){
one.localelib.Base.prototype['get'+rendererType+'Renderer']=function(){
var rendererId=rendererType+':'+[].join.call(arguments,'/');
return this.renderers[rendererId]||(this.renderers[rendererId]=this['make'+rendererType+'Renderer'].apply(this,arguments))
};
one.localelib.Base.prototype['render'+rendererType]=function(obj){
var makeRendererArgs=[].slice.call(arguments,1);
return(this.renderers[rendererType+':'+makeRendererArgs.join('/')]||this['get'+rendererType+'Renderer'].apply(this,makeRendererArgs))(obj)
}
});
one.localelib.LocaleInfo=Ext.data.Record.create([
{
name:'id',
type:'string'
},
{
name:'display_name',
type:'string'
}
]);
one.localelib.TerritoryInfo=Ext.data.Record.create([
{
name:'id',
type:'string'
},
{
name:'display_name',
type:'string'
},
{
name:'has_time_zones',
type:'boolean'
}
]);
one.localelib.TimeZoneInfo=Ext.data.Record.create([
{
name:'id',
type:'string'
},
{
name:'display_name',
type:'string'
},
{
name:'territory_id',
type:'string'
},
{
name:'utc_offset',
type:'int'
}
]);
(function(){
var stringPrototype=String.prototype;
stringPrototype.capitalize=function(){
return this.charAt(0).toUpperCase()+this.substring(1)
}
}());
Ext.apply(one.localelib.Base.prototype,{
getStoreForBundle:function(bundleName,storeConfig){
return new Ext.data.JsonStore(Ext.apply({
autoLoad:true,
idProperty:'id',
fields:one.localelib[bundleName.capitalize()],
root:bundleName,
proxy:bundleName in this?new Ext.data.MemoryProxy(this):new Ext.data.HttpProxy({
method:'GET',
url:one.viewport.getLocaleFileUrl(bundleName+'.'+one.locale.id+'.json')
})
},storeConfig||{}))
}
});
one.form.LocaleCombo=Ext.extend(Ext.form.ComboBox,{
width:180,
listWidth:220,
valueNotFoundText:'',
editable:false,
disableKeyFilter:true,
forceSelection:true,
triggerAction:'all',
valueField:'id',
displayField:'display_name',
mode:'local',
fieldLabel:'Language',
constructor:function(config){
config=config||{};
if(!('value'in config)){
config.value=one.locale.id
}
this.store=new Ext.data.JsonStore({
autoLoad:true,
idProperty:'id',
fields:one.localelib.LocaleInfo,
root:'localeInfo',
proxy:new Ext.data.MemoryProxy(one.form.LocaleCombo),
listeners:{
scope:this,
load:function(){
this.setValue(this.value)
}
}
});
if(config.flags){
this.tpl='<tpl for="."><div class="x-combo-list-item"><span class="language-text">{'+this.displayField+'}<tpl if="id == one.locale.id"><span class="selected-lang"></span></tpl></span><span class="icon flags flags-{'+this.valueField+'}"></span></div></tpl>'
}
one.form.LocaleCombo.superclass.constructor.call(this,config)
}
});
one.form.LocaleCombo.localeInfo=[
{
id:'cs',
display_name:'etina'
},
{
id:'da',
display_name:'Dansk'
},
{
id:'de',
display_name:'Deutsch'
},
{
id:'en_gb',
display_name:'English (UK)'
},
{
id:'en_us',
display_name:'English (US)'
},
{
id:'es',
display_name:'Espaol'
},
{
id:'fr',
display_name:'Franais'
},
{
id:'it',
display_name:'Italiano'
},
{
id:'nl',
display_name:'Nederlands'
},
{
id:'nb',
display_name:'Norsk bokml'
},
{
id:'pl',
display_name:'Polski'
},
{
id:'pt',
display_name:'Portugus'
},
{
id:'pt_br',
display_name:'Portugus (Brazilian)'
},
{
id:'ru',
display_name:''
},
{
id:'fi',
display_name:'Suomi'
},
{
id:'sv',
display_name:'Svenska'
}
].filter(function(localeInfo){
return[
'cs',
'da',
'de',
'en_gb',
'en_us',
'es',
'fi',
'fr',
'it',
'nb',
'nl',
'pl',
'pt',
'sv'
].indexOf(localeInfo.id)!==-1
});
Ext.reg('one-form-localecombo',one.form.LocaleCombo);
web.windows.MoveToNewWebsiteBuilder=Ext.extend(web.windows.Window,{
type:'web.windows.MoveToNewWebsiteBuilder',
modal:true,
resizable:false,
constructor:function(config){
this.cls='web-modal-info x-window-dlg move-to-new-website-builder move-to-new-website-builder-'+function(){
return((one||{}).locale||{}).id
}();
web.windows.MoveToNewWebsiteBuilder.superclass.constructor.call(this,config)
},
initComponent:function(){
var that=this;
that.items=[{
xtype:'container',
items:[
{
xtype:'container',
style:'padding-left:40px;padding-right:40px;text-align:center',
html:[
'<div class="try-new-website-builder-logo"></div>',
'<div style="padding-bottom:20px;font-size:31px">'+'We are creating a new Website Builder for you'+'</div>',
'<div style="padding-bottom:16px">',
'You\'re invited to try out our new version.',
'<br />',
'We are still busy working on it, so you can also switch back to the old version. We\'d love to hear your feedback, both the good and the bad.',
'</div>'
].join('')
},
{
xtype:'container',
style:'text-align:center;margin-bottom:10px',
items:[{
xtype:'button',
cls:'x-btn-primary large wide',
style:'font-size:13px',
text:'Try the new version now',
handler:function(){
var generateFullScreenCover=function(text){
var $=oneJQuery,$coverFullScreen=$('<div class="cover-full-screen">'+'<div>'+'<div class="animated-loading-dots"><div></div></div>'+'<div class="subtext">'+text+'</div>'+'</div>'+'</div>');
$('body').append($coverFullScreen);
return $coverFullScreen
};
var proceed=function(){
var $coverFullScreen=generateFullScreenCover('Moving to new Website Builder...');
that.app.dal.canUseNewWebsiteBuilder({
app:that.app,
movingToNewWSB:true
},function(canUse,betaWsbCode){
var showError=function(){
one.error('<b>'+'Sorry, we could not move you to the new Website Builder.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.')
};
if(canUse){
that.app.site.prefersNewWSB=true;
that.app.site.betaWsbCode=that.app.site.betaWsbCode||betaWsbCode;
that.app.fireEvent('update',that.app.site,{
success:function(){
that.app.dal.uiState.set('showBetaWelcomeMessage','yes');
window.onbeforeunload=function(){
};
window.location=window.location.origin+'/new'
},
failure:function(){
$coverFullScreen.remove();
showError()
}
})
}else{
$coverFullScreen.remove();
showError()
}
})
};
if(that.app.hasUnsavedChanges()){
Ext.Msg.show({
buttons:{
yes:'Save',
no:'Don\'t Save',
cancel:'Cancel'
},
cls:'hide-secondary-button-from-ext-modal',
title:'Do you want to save recent changes?',
msg:'You have unsaved changes. Do you want to save your recent changes, before moving to new Website Builder?',
fn:function(buttonId,evt){
if(buttonId==='yes'){
var $coverFullScreen=generateFullScreenCover('Saving...');
that.app.save(function(){
$coverFullScreen.remove();
proceed()
},{
failure:function(){
$coverFullScreen.remove()
}
})
}else if(buttonId==='no'){
proceed()
}
},
scope:this
})
}else{
proceed()
}
}
}]
},
{
xtype:'container',
style:'padding-left:40px;padding-right:40px;margin-bottom:62px;text-align:center',
html:'<div style="color:#0a58c2;cursor:pointer;text-decoration:underline">'+'No thanks. Maybe later.'+'</div>',
listeners:{
afterrender:function(component){
var that=this;
this.mon(component.el,'click',function(){
that.hide()
},this)
},
scope:this
}
}
]
}];
that.listeners={
scope:that,
show:function(){
that.center()
}
};
web.windows.MoveToNewWebsiteBuilder.superclass.initComponent.apply(this,arguments)
}
});
Ext.ComponentMgr.registerType('web-windows-move-to-new-website-builder',web.windows.MoveToNewWebsiteBuilder);
web.panels.Header=Ext.extend(Ext.Container,{
cls:'oneweb-header',
initComponent:function(){
this.layout='hbox';
this.layoutConfig={align:'stretch'};
this.items=[
{
xtype:'container',
width:100,
cls:'logo'
},
{
xtype:'container',
flex:1,
layout:'vbox',
layoutConfig:{align:'stretch'},
items:[{
xtype:'container',
flex:1,
layout:'hflex',
layoutConfig:{
align:'middle',
pack:'end'
},
cls:'web-logout-panel',
items:[
{
xtype:'container',
ref:'../../tryNewWebsiteBuilder',
width:'auto',
cls:'try-new-website-builder',
hidden:true,
html:'Try the new Website Builder',
listeners:{
afterrender:function(component){
var that=this;
that.app.dal.canUseNewWebsiteBuilder({app:that.app},function(canUse){
if(canUse){
that.mon(component.el,'click',function(){
that.app.windows.show({type:'web.windows.MoveToNewWebsiteBuilder'})
},that);
var elTryNewWebsiteBuilder=that.tryNewWebsiteBuilder.getEl();
elTryNewWebsiteBuilder.setOpacity(0).animate({
opacity:{
from:0,
to:1
}
},1.5,null,'linear','run');
that.tryNewWebsiteBuilder.show()
}
})
},
scope:this
}
},
{
xtype:'container',
flex:1,
html:'&nbsp;'
},
{
xtype:'container',
width:30,
style:'z-index:1;position:relative;left:147px',
html:'<div style="cursor:default;position:relative;top:2px;height:20px;cursor:default" class="domain-icon"></div>'
},
{
xtype:'container',
style:'z-index:1;position:relative;left:147px;white-space:nowrap',
html:'<span style="cursor:default;position:relative;'+(Ext.isGecko?'top: 0px;':Ext.isChrome?'top: -1px':'')+'; padding-bottom:3px; padding-top:2px">'+this.app.dal.displayDomain+'</span>'
},
{
xtype:'container',
style:'position:relative;left:147px',
cls:'web-logout-panel-separator show-if-premium',
width:21,
html:'<div style="cursor:default;border-right:1px solid #ccc;width: 1px; height: 20px"></div>',
hidden:false
},
{
xtype:'container',
style:'z-index: 1;white-space: nowrap;position:relative;left:147px',
cls:'show-if-premium',
html:'<span class="header-premium-check" style="cursor:default;display:inline-block;position:relative;top:2px;padding-right:10px"></span>'+'<span class="" style="cursor:default;position:relative;text-transform:uppercase;'+(Ext.isGecko?'top: 0px':Ext.isChrome?'top: -1px':'')+';padding-bottom:3px;padding-top:2px;">'+'Premium'+'</span>',
hidden:false
},
{
xtype:'container',
cls:'web-logout-panel-separator',
style:'position:relative;left:147px',
width:21,
html:'<div style="border-right:1px solid #ccc;width:1px;height:20px"></div>'
},
{
style:'white-space:nowrap;position:relative;left:147px;opacity:0.01;cursor:default',
xtype:'container',
html:'<span>'+this.getLangName()+'</span><span style="width:11px"></span>'
},
{
syncFont:false,
xtype:'one-form-localecombo',
ctCls:'web-logout-panel-locale',
listClass:'web-logout-panel-locale-list',
maxHeight:'auto',
style:{
height:'18px',
padding:Ext.isIE?'2px 2px 0px 2px':null,
'margin-top':function(){
if(Ext.isGecko){
return'1px'
}else if(Ext.isIE||Ext.isIE11){
return'0px'
}else if(Ext.isSafari){
return'2px'
}else{
return'-2px'
}
}()
},
value:'en_gb',
width:160,
listWidth:160,
shadow:false,
flags:true,
listeners:{
select:function(combo){
this.onLanguagePick(combo.getValue())
},
expand:function(combobox){
var blurField=function(el){
el.blur()
};
blurField.defer(10,this,[combobox.el])
},
collapse:function(combobox){
var blurField=function(el){
el.blur()
};
blurField.defer(10,this,[combobox.el])
},
scope:this
}
},
{
xtype:'box',
cls:'web-logout-panel-separator',
width:21,
html:'<div style="border-left: 1px solid #ccc;width: 1px; height: 20px; padding: 0px; margin-top: 0px;"></div>'
},
{
xtype:'container',
ref:'../../helpButton',
style:{
lineHeight:'12px',
height:'12px'
},
html:'<span style="white-space:nowrap;display:none" ext:qtip="'+'Show and hide tips'+'">'+'Hide tips'+'</span>'+'<span style="white-space:nowrap" ext:qtip="'+'Show and hide tips'+'">'+'Show tips'+'</span>',
setState:function(state){
if(state){
this.el.dom.firstChild.style.display='';
this.el.dom.firstChild.nextSibling.style.display='none'
}else{
this.el.dom.firstChild.style.display='none';
this.el.dom.firstChild.nextSibling.style.display=''
}
},
listeners:{
afterrender:function(component){
this.mon(Ext.Element.get(component.el.dom.firstChild),'click',function(e,t,o){
o.setState(false);
this.app.startTips.dismissAll()
},this,component);
this.mon(Ext.Element.get(component.el.dom.firstChild.nextSibling),'click',function(e,t,o){
if(!o.disabled){
o.setState(true);
this.app.startTips.displayFirst()
}
},this,component)
},
scope:this
}
},
{
xtype:'container',
cls:'web-logout-panel-separator',
width:21,
html:'<div style="border-left: 1px solid #ccc;width: 1px; height: 20px; padding: 0px; margin-top: 0px;"></div>'
},
{
xtype:'container',
cls:'web-logout',
style:{
lineHeight:'11px',
height:'12px'
},
html:'<span style="white-space:nowrap" ext:qtip="'+'Log out of Website Builder'+'">'+'Log out'+'</span>',
listeners:{
afterrender:function(component){
this.mon(Ext.Element.get(component.el.dom.firstChild),'click',this.onLogout,this)
},
scope:this
}
},
{
xtype:'container',
width:15,
html:'<div></div>'
}
]
}]
}
];
web.panels.Header.superclass.initComponent.call(this)
},
getLangName:function(){
var lang='',prop='display_name';
one.form.LocaleCombo.localeInfo.forEach(function(item){
if(item.id===one.locale.id){
lang=item[prop]
}
});
return lang
},
onLanguagePick:function(lang){
var expires=new Date(2099,1,1);
this.app.request({
type:'language',
lang:lang,
expires:expires
})
},
onLogout:function(e){
this.app.request({type:'logout'})
}
});
Ext.reg('web-panels-header',web.panels.Header);
web.windows.ClobberedAndMissingAssetsList=Ext.extend(web.windows.Window,{
type:'web.windows.ClobberedAndMissingAssetsList',
initComponent:function(){
this.cls='web-modal-warning web-windows-clobberedAndMissingAssetsList x-window-dlg';
this.modal=true;
this.resizable=false;
this.items=[
{
ref:'caption',
xtype:'box',
style:'margin: 0 0 10px'
},
{
ref:'list',
xtype:'box',
style:'margin-left: 10px',
autoScroll:true,
height:90,
data:[],
tpl:new Ext.XTemplate('<ul>','<tpl for=".">','<li>{.}</li>','</tpl>','</ul>')
},
{
ref:'prompt',
xtype:'box',
style:'margin: 10px 0 0'
}
];
this.buttons=[
'->',
{
text:'Cancel',
cls:'x-btn-secondary',
handler:function(){
this.hide();
this.fireEvent('cancel')
},
scope:this
},
{
ref:'../okButton',
text:'OK',
cls:'x-btn-primary',
handler:function(){
this.hide();
this.fireEvent('ok')
},
scope:this
}
];
web.windows.ClobberedAndMissingAssetsList.superclass.initComponent.call(this)
},
setValues:function(data){
if(this.rendered){
this.caption.update(data.captionLabel);
this.prompt.update(data.promptLabel);
this.list.update(data.assets);
this.okButton.setText(data.okLabel);
this.cls+='string'===typeof data.cls?data.cls:'';
this.iconCls='string'===typeof data.iconCls?data.iconCls:''
}else{
this.on('afterlayout',function(){
this.caption.update(data.captionLabel);
this.prompt.update(data.promptLabel);
this.list.update(data.assets);
this.okButton.setText(data.okLabel);
this.cls+='string'===typeof data.cls?data.cls:'';
this.iconCls='string'===typeof data.iconCls?data.iconCls:''
},this,{single:true})
}
}
});
web.utils.ImageInfo={
readPngInfo:function(file){
if(!this.validateFileType(file,'image/png')){
throw'Invalid PNG'
}
var w=this.getLongAt(file,16,true),h=this.getLongAt(file,20,true),bpc=this.getByteAt(file,24),ct=this.getByteAt(file,25),alpha=this.getByteAt(file,25)>=4,bpp=bpc;
if(ct===4){
bpp*=2
}
if(ct===2){
bpp*=3
}
if(ct===6){
bpp*=4
}
return{
contentType:'image/png',
width:w,
height:h,
bpp:bpp,
alpha:alpha
}
},
readGifInfo:function(file){
if(!this.validateFileType(file,'image/gif')){
throw'Invalid GIF'
}
var version=this.getStringAt(file,3,3),w=this.getShortAt(file,6),h=this.getShortAt(file,8),bpp=(this.getByteAt(file,10)>>4&7)+1;
return{
contentType:'image/gif',
version:version,
width:w,
height:h,
bpp:bpp,
alpha:false
}
},
readJpegInfo:function(file){
if(!this.validateFileType(file,'image/jpeg')){
throw'Invalid JPEG'
}
var w=0,h=0,comps=0,len=file.length,offset=2,marker;
while(offset<len){
marker=this.getShortAt(file,offset,true);
offset+=2;
if(marker>=65472&&marker<=65475){
h=this.getShortAt(file,offset+3,true);
w=this.getShortAt(file,offset+5,true);
comps=this.getByteAt(file,offset+7,true);
break
}else{
offset+=this.getShortAt(file,offset,true)
}
}
return{
contentType:'image/jpeg',
width:w,
height:h,
bpp:comps*8,
alpha:false
}
},
readBmpInfo:function(file){
var w=this.getLongAt(file,18),h=this.getLongAt(file,22),bpp=this.getShortAt(file,28);
return{
contentType:'image/bmp',
width:w,
height:h,
bpp:bpp,
alpha:false
}
},
readIcoInfo:function(file){
return{
contentType:'image/x-icon',
width:1,
height:1,
bpp:1,
alpha:false
}
},
readFile:function(file,mime){
var map={
'image/jpeg':this.readJpegInfo,
'image/png':this.readPngInfo,
'image/gif':this.readGifInfo,
'image/bmp':this.readBmpInfo,
'image/x-icon':this.readIcoInfo,
'image/vnd.microsoft.icon':this.readIcoInfo
};
if(map[mime]){
return map[mime].call(this,file)
}else{
return null
}
},
validateFileType:function(file,mime){
var short=this.getShortAt(file,0),long=this.getLongAt(file,0);
if(String.fromCharCode(this.getByteAt(file,0),this.getByteAt(file,1),this.getByteAt(file,2))==='GIF'&&mime==='image/gif'){
return true
}else if(short===55551&&mime==='image/jpeg'){
return true
}else if(long===2303741511&&mime==='image/png'){
return true
}else{
return false
}
},
getByteAt:function(file,offset){
return file[offset].charCodeAt(0)
},
getShortAt:function(file,offset,bigEndian){
var num=bigEndian?(this.getByteAt(file,offset)<<8)+this.getByteAt(file,offset+1):(this.getByteAt(file,offset+1)<<8)+this.getByteAt(file,offset);
if(num<0){
num+=65536
}
return num
},
getLongAt:function(file,offset){
var byte1=this.getByteAt(file,offset),byte2=this.getByteAt(file,offset+1),byte3=this.getByteAt(file,offset+2),byte4=this.getByteAt(file,offset+3),num=(((byte1<<8)+byte2<<8)+byte3<<8)+byte4;
if(num<0){
num+=4294967296
}
return num
},
getStringAt:function(file,offset,length){
var str=[],i,j;
for(i=offset,j=0;i<offset+length;i+=1,j+=1){
str[j]=String.fromCharCode(this.getByteAt(file,i))
}
return str.join('')
}
};
web.windows.Rename=Ext.extend(web.windows.Window,{
initComponent:function(){
this.title='Rename';
this.width=480;
this.items=[
{
xtype:'container',
style:{
display:'inline-block',
paddingRight:'20px'
},
html:'Enter a new filename:'
},
{
ref:'textField',
xtype:'textfield'
},
{
ref:'errorMessage',
xtype:'component',
hidden:true,
html:'Filename already exists. Please choose another name.'
}
];
this.buttons=[
{
cls:'x-btn-secondary',
text:'Cancel',
handler:function(){
this.hide();
this.fireEvent('cancel',this)
},
scope:this
},
{
cls:'x-btn-primary large wide',
text:'OK',
handler:function(){
this.handleRename()
},
scope:this
}
];
web.windows.Rename.superclass.initComponent.call(this)
},
initListeners:function(){
this.on('show',function(){
this.textField.setRawValue(web.DAL.decodeHref(this.filename))
},this);
this.on('beforehide',function(){
this.errorMessage.hide();
return true
},this)
},
setValues:function(values){
this.filename=values.filename;
if(values.files){
this.files=values.files
}
},
handleRename:function(btn){
var i,filesCount=this.files.length,filename=encodeURIComponent(this.textField.getValue());
for(i=0;i<filesCount;i++){
if(this.files[i].filename===filename){
this.errorMessage.show();
return
}
}
this.hide();
this.fireEvent('ok',this,filename)
}
});
one.FileInputButton=Ext.extend(Ext.Button,{
name:'file',
multiple:false,
constructor:function(config){
this.addEvents('fileselected');
one.FileInputButton.superclass.constructor.call(this,config);
this.monConfig={
scope:this,
click:function(e){
e.stopPropagation()
},
mousemove:function(e){
if(this.el.getRegion().contains(new Ext.lib.Point(e.getXY()))){
this.fileInput.setLocation(e.getPageX()-this.fileInputWidth+this.fileInputOffset*3,e.getPageY()-this.fileInputOffset)
}else{
this.hideFileInput()
}
},
change:function(e,dom){
this.fireEvent('fileselected',dom)
},
mouseout:this.hideFileInput,
focus:this.onFocus,
blur:this.onBlur
};
this.on({
scope:this,
mouseover:function(button,e){
this.monConfig.mousemove.call(this,e)
},
click:function(button,e){
this.monConfig.mousemove.call(this,e);
if(e.target.parentElement&&e.target.parentElement.getElementsByTagName('input')[0]&&e.target.parentElement.getElementsByTagName('input')[0].type==='file'){
oneJQuery(e.target.parentElement.getElementsByTagName('input')[0]).trigger('click')
}
},
fileselected:function(fileInput){
this.onBlur();
this.hideFileInput();
this.mun(this.fileInput,this.monConfig);
this.fileInput=this.createFileInput().replace(this.fileInput);
this.onFocus()
}
})
},
onRender:function(){
one.FileInputButton.superclass.onRender.apply(this,arguments);
this.btnEl.dom.tabIndex=-1;
this.fileInput=this.createFileInput();
this.fileInputOffset=Math.floor(this.fileInput.getHeight()/2);
this.fileInputWidth=this.fileInput.getWidth()
},
createFileInput:function(){
var spec={
tag:'input',
type:'file',
name:this.name,
style:{
position:'absolute',
'z-index':'80000',
cursor:'pointer'
}
};
if(this.multiple){
spec.multiple='multiple'
}
if(this.accept){
spec.accept=this.accept.join(',')
}
if(this.tabIndex){
spec.tabindex=this.tabIndex
}
if(this.title){
spec.title=this.title
}
var fileInput=Ext.DomHelper.append(this.btnEl.parent(),spec,true);
if(this.tooltip){
if(Ext.isObject(this.tooltip)){
Ext.QuickTips.register(Ext.apply({target:fileInput},this.tooltip))
}else{
fileInput.dom[this.tooltipType]=this.tooltip
}
}
this.hideFileInput(fileInput);
fileInput.setOpacity(0);
this.mon(fileInput,this.monConfig);
return fileInput
},
hideFileInput:function(fileInput){
if(fileInput&&fileInput.setLocation){
fileInput.setLocation(-10000,-10000)
}else{
this.fileInput.setLocation(-10000,-10000)
}
},
focus:this.onFocus,
blur:this.onBlur,
onFocus:function(e){
if(!this.disabled){
this.el.addClass('x-btn-focus');
this.fileInput.focus();
if(Ext.isGecko){
this.btnEl.setStyle({outline:'1px dotted black'})
}
}
},
onBlur:function(e){
this.el.removeClass('x-btn-focus');
this.fileInput.blur();
if(Ext.isGecko){
this.btnEl.setStyle({outline:'0px'})
}
}
});
Ext.reg('one-fileinputbutton',one.FileInputButton);
web.utils.ImageAnalyzer=Ext.extend(Object,{
analyzeByFile:function(file,callback,scope){
scope=scope||window;
var canvas,ctx,that=this;
canvas=Ext.get('image-analyzer');
if(canvas){
canvas=canvas.dom
}else{
canvas=Ext.DomHelper.append(document.body,{
tag:'canvas',
id:'image-analyzer',
width:100,
height:100,
style:'display: none;',
html:''
})
}
try{
ctx=canvas.getContext('2d');
var reader=new window.FileReader;
reader.onload=function(e){
var img=new Image;
img.onload=function(){
var analysis,imgData;
ctx.drawImage(img,0,0,canvas.width,canvas.height);
imgData=ctx.getImageData(0,0,canvas.width,canvas.height).data;
analysis=that.analyzeByData(imgData);
callback.call(scope,analysis)
};
img.src=e.target.result
};
reader.readAsDataURL(file)
}catch(e){
callback.call(scope,null)
}
},
analyzeByUrl:function(url,callback,scope){
var canvas,ctx,img,that;
canvas=Ext.get('image-analyzer');
if(canvas){
canvas=canvas.dom
}else{
canvas=Ext.DomHelper.append(document.body,{
tag:'canvas',
id:'image-analyzer',
width:100,
height:100,
style:'display: none;',
html:''
})
}
try{
ctx=canvas.getContext('2d');
img=new Image;
that=this;
img.onload=function(){
var analysis,imgData;
ctx.drawImage(img,0,0,canvas.width,canvas.height);
imgData=ctx.getImageData(0,0,canvas.width,canvas.height).data;
analysis=that.analyzeByData(imgData);
scope=scope||window;
callback.call(scope,analysis)
};
img.src=url
}catch(e){
callback.call(scope,null)
}
},
analyzeByData:function(imgData){
var usage,analysis={},colorFactor;
usage=this.colorsUsed(imgData);
colorFactor=Math.max(usage.noticable.r,usage.noticable.g);
colorFactor=Math.max(colorFactor,usage.noticable.b);
analysis.colorFactor=colorFactor;
if(colorFactor<=128){
analysis.inference='paletted';
analysis.confidence=(128-colorFactor)*100/128
}else{
analysis.inference='truecolor';
analysis.confidence=(colorFactor-128)*100/127
}
if(analysis.confidence>=66){
analysis.description=analysis.inference;
analysis.confidenceLevel='high'
}else if(analysis.confidence>=33){
analysis.description='maybe '+analysis.inference;
analysis.confidenceLevel='low'
}else{
analysis.description='not sure';
analysis.confidenceLevel='zero'
}
return analysis
},
colorsUsed:function(imgData){
var chans=[[]],maxCount=0,val,i,j,n,y,m,step=1;
chans=[
[],
[],
[]
];
step*=4;
for(i=0,n=imgData.length;i<n;i+=step){
val=[
imgData[i],
imgData[i+1],
imgData[i+2]
];
for(y=0,m=val.length;y<m;y+=1){
if(val[y]in chans[y]){
chans[y][val[y]]+=1
}else{
chans[y][val[y]]=1
}
if(chans[y][val[y]]>maxCount){
maxCount=chans[y][val[y]]
}
}
}
var noticable={},real={},threshhold=maxCount/100;
for(i=0;i<chans.length;i+=1){
real[i]=0;
noticable[i]=0;
for(j=0;j<chans[i].length;j+=1){
real[i]+=1;
if(chans[i][j]>threshhold){
noticable[i]+=1
}
}
}
return{
real:{
r:real[0],
g:real[1],
b:real[2]
},
noticable:{
r:noticable[0],
g:noticable[1],
b:noticable[2]
}
}
}
});
web.utils.FeatureSupport={multipleFileInput:'multiple'in document.createElement('input')};
web.windows.FileUploader=Ext.extend(web.windows.Window,{
initComponent:function(){
this.addEvents({onupload:true});
this.type='web.windows.FileUploader';
this.files=[];
this.width=500;
this.height=320;
this.modal=true;
this.resizable=false;
this.cls='upload-files-window web-window-lesspadding';
this.bodyCssClass='vbox';
this.title='Upload File';
var that=this;
var fnEnableDisableUploadButton=function(input,evt){
var uploadButton=that.uploadFileBtn,markValidity=that.markValidity;
if(that.downloadFromUrl.isValid(!markValidity)){
input.clearInvalid();
that.markValidity=true;
uploadButton.enable()
}else{
uploadButton.disable()
}
};
this.downloadFromUrl=new Ext.form.TextField({
xtype:'textfield',
name:'company',
width:that.width-40,
hideLabel:true,
style:{marginTop:'7px'},
enableKeyEvents:true,
validator:function(value){
return web.data.links.LinkExternal.validate(value)
},
validationEvent:false,
listeners:{
afterrender:function(c){
c.getEl().set({spellcheck:'false'})
},
specialkey:function(f,e){
if(e.getKey()===e.ENTER){
that.markValidity=true;
if(f.isValid()){
that.hide();
that.fireEvent('ok',that.downloadFromUrl.getValue())
}
}
},
keyup:fnEnableDisableUploadButton,
blur:function(f,e){
that.markValidity=true;
fnEnableDisableUploadButton(f,e)
}
}
});
this.items=[
{
xtype:'container',
cls:'flex container-download-from-url',
border:false,
layout:'vbox',
height:150,
autoWidth:true,
items:[
{
xtype:'label',
cls:'label-from-url',
text:'From URL'
},
{
xtype:'label',
text:'Link to an external URL:'
},
this.downloadFromUrl
]
},
{
xtype:'container',
cls:'web-window-footer hbox cross-center main-end',
items:[
{
xtype:'button',
cls:'x-btn-secondary large wide',
text:'Cancel',
listeners:{
click:this.onCancel,
scope:this
}
},
{
xtype:'spacer',
width:14
},
{
xtype:'button',
cls:'x-btn-primary large wide',
ref:'../uploadFileBtn',
text:'Upload',
disabled:true,
listeners:{
click:function(){
this.hide();
this.fireEvent('ok',this.downloadFromUrl.getValue())
},
scope:this
}
}
]
}
];
this.listeners={
show:function(){
this.downloadFromUrl.setValue('http://');
this.markValidity=false
},
scope:this
};
web.windows.FileUploader.superclass.initComponent.apply(this,arguments)
},
setValues:function(obj){
this.files=obj.files;
this.path=obj.path;
this.parentComponent=obj.parentComponent;
this.uploadSource=obj.uploadSource
},
show:function(){
web.windows.FileUploader.superclass.show.apply(this,arguments);
var title='Upload';
this.lastUploadedAssetConfig=null;
this.fileData=null;
this.uploadFileBtn.disable();
this.arrFailedUploads=[];
this.arrFailedUploadsFilenames=[];
this.downloadFromUrl.clearInvalid();
title=web.utils.FeatureSupport.multipleFileInput?'Upload files':'Upload file';
this.setTitle(title);
this.setHeight(this.height)
},
hide:function(win){
web.windows.FileUploader.superclass.hide.apply(this,arguments)
},
onCancel:function(){
this.hide();
this.fireEvent('cancel',this)
}
});
Ext.ns('web.ui.corefile');
web.ui.FileUploadCtrl=Ext.extend(Ext.util.Observable,{
constructor:function(config){
this.coreFile=config.coreFile;
web.ui.FileUploadCtrl.superclass.constructor.call(this,config)
},
initComponent:function(){
this.addEvents([
'validate:start',
'validate:complete',
'upload:start',
'upload:progress',
'upload:complete',
'upload:error',
'upload:allcomplete'
]);
web.ui.FileUploadCtrl.superclass.initComponent.call(this)
},
stopArrayProcessing:function(){
this.arrayProcessingActive=false
},
uploadFromUrl:function(config){
this.files=config.files;
this.path=config.path;
this.app=config.app;
this.stopArrayProcessing();
this.arrFailedUploads=[];
this.arrFailedUploadsFilenames=[];
this.startUpload({
source:'url',
url:config.url
});
var name=this.url2fileName(config.url),item={
name:name,
type:'unavailable',
file:null,
size:100,
onlySingleFile:true
};
this.fireEvent('validate:start',{fileData:item})
},
uploadFromComputer:function(config){
var el=config.inputField;
this.files=config.files;
this.path=config.path;
this.app=config.app;
this.stopArrayProcessing();
this.arrFailedUploads=[];
this.arrFailedUploadsFilenames=[];
var arrNamesToDisplay=[];
var arrOfErrors={};
arrOfErrors.erroneousImageFileNames=[];
arrOfErrors.unsupportedFileNames=[];
arrOfErrors.invalidImageSizeFileNames=[];
arrOfErrors.invalidImageFilenames=[];
var callback=function(cfg){
var filename=cfg.fileData.name.replace(/^.*[\/\\]/,'');
var isValidFile=true;
if(this.coreFile.allowOnlyImage){
if(!this.validateImageInfo(cfg.imageInfo,cfg.dataURL,arrOfErrors,filename)){
isValidFile=false
}
}
cfg.valid=isValidFile;
this.fireEvent('validate:complete',cfg);
if(filename&&isValidFile){
arrNamesToDisplay.push(filename);
arrNamesToDisplay.sort();
return true
}else{
return false
}
},fileReader,fileData;
this.arrFileData=[];
var files=el.files;
if(!files){
var isSupportedExtension=true;
fileData=el.value;
if(this.coreFile.fileChooser.fileExtensionFilter){
isSupportedExtension=this.coreFile.fileChooser.fileExtensionFilter.test(fileData)
}
if(isSupportedExtension){
files=[{
name:el.value.replace(/^.*[\/\\]/,''),
type:'unavailable',
file:el,
onlySingleFile:true
}]
}else{
arrOfErrors.unsupportedFileNames.push(el.value.replace(/^.*[\/\\]/,''));
this.showAllErrors(arrOfErrors);
return
}
}
if(files){
this.arrayProcessingActive=true;
web.utils.Array.asyncProcessing(files,this,function(item,index,next){
if(!this.arrayProcessingActive){
return
}
this.fireEvent('validate:start',{fileData:item});
var i=index;
fileData=files[i];
var filename=fileData.name.replace(/^.*[\/\\]/,'');
if(window.FileReader){
fileReader=new window.FileReader;
var isSupported=true;
if(this.coreFile.fileChooser.contentTypeFilter){
isSupported=fileData.type.match(this.coreFile.fileChooser.contentTypeFilter)
}
if(isSupported){
(function(that){
var thisFileData=fileData;
fileReader.onload=function(event){
var fileInfo;
if(fileData.type.search('image')!==-1){
var img=new Image;
img.onload=function(){
fileInfo={
contentType:thisFileData.type,
width:img.width,
height:img.height
};
window.URL.revokeObjectURL(img.src);
if(callback.call(that,{
imageInfo:fileInfo,
fileData:thisFileData,
dataURL:event.target.result
})){
that.arrFileData.push(thisFileData)
}
next()
};
img.onerror=function(){
var arr=arrOfErrors.erroneousImageFileNames;
var fileName=thisFileData.name;
if(arr.indexOf(fileName)===-1){
arr.push(fileName);
that.fireEvent('validate:complete',{
fileData:thisFileData,
valid:false
})
}
next()
};
img.src=window.URL.createObjectURL(fileData)
}else{
if(callback.call(that,{
fileData:thisFileData,
dataURL:this.src
})){
that.arrFileData.push(thisFileData)
}
next()
}
};
fileReader.readAsDataURL(fileData)
}(this))
}else{
this.fireEvent('validate:complete',{
fileData:fileData,
valid:false
});
arrOfErrors.unsupportedFileNames.push(fileData.name);
next()
}
}else{
this.arrFileData.push(fileData);
arrNamesToDisplay.push(filename);
next()
}
},function(arr){
var that=this;
this.startUpload({source:'computer'});
that.showAllErrors(arrOfErrors);
this.arrayProcessingActive=false
})
}
},
startUpload:function(config){
var existingFile;
var arrFileData;
var arrFilename=[];
var url,filename,https;
if(config.source==='computer'){
arrFileData=this.arrFileData;
this.allFiles=this.arrFileData.slice();
this.uploadedFilesCount=0;
if(arrFileData&&arrFileData.length){
var i;
for(i=0;i<arrFileData.length;i+=1){
var fileData=arrFileData[i];
arrFilename.push(fileData.name)
}
}else{
Ext.Msg.show({
title:'No File Selected',
cls:'web-modal-warning x-window-dlg',
iconCls:'web-warning-icon',
msg:web.utils.FeatureSupport.multipleFileInput?'Please select files to upload.':'Please select file to upload.',
buttons:{ok:'OK'}
});
return
}
}else{
url=config.url;
https=url.match(/https?:\/\//)?url.match(/https?:\/\//g).pop():'http://';
url=https+url.replace(/https?:\/\//g,'');
filename=url.split('?')[0].match(/.*\/([^\/]+)$/);
if(filename&&filename[1]){
filename=filename[1].replace(/[^A-Za-z0-9\.]/g,'-').replace(/^-+/g,'');
arrFileData=[url];
arrFilename[0]=filename
}else{
Ext.MessageBox.show({
title:'Invalid URL',
msg:'Please enter a valid URL.',
cls:'web-modal-warning x-window-dlg',
iconCls:'web-warning-icon',
buttons:{ok:'OK'}
});
return
}
}
var fnUploadOneFile=function(filename,that,fileData,callback,totalFilesCount,currentFileIndex){
existingFile=that.files.some(function(item){
if(item.filename===filename){
return true
}
});
var fileObject={
fileData:fileData,
filename:filename,
callback:callback,
totalFilesCount:totalFilesCount,
currentFileIndex:currentFileIndex
};
if(existingFile){
that.showConflictDialog(fileObject)
}else{
that.uploadFile(fileObject)
}
};
var uploadFilesInOrder=function(that,totalFilesCount,currentFileIndex){
var fileData=arrFileData.shift();
var filename=encodeURIComponent(arrFilename.shift());
if(fileData){
fnUploadOneFile(filename,that,fileData,function(lastUploadedAssetConfig){
uploadFilesInOrder(that,totalFilesCount,currentFileIndex+1);
if(lastUploadedAssetConfig){
that.lastUploadedAssetConfig=lastUploadedAssetConfig
}
},totalFilesCount,currentFileIndex)
}else{
if(currentFileIndex===totalFilesCount){
var selectLastUploadedFile=function(){
var fileChooser=that.coreFile.fileChooser;
var lastUploaded=that.lastUploadedAssetConfig;
if(fileChooser&&lastUploaded){
fileChooser.showPath(lastUploaded.url.replace(/^webspace:/,''))
}
};
if(that.arrFailedUploads.length){
Ext.Msg.show({
cls:'failed-upload-files-list web-modal-warning',
iconCls:'web-warning-icon',
minWidth:400,
title:'Upload to web space failed',
msg:'The following file(s) did not upload.'+'<br/><br/>'+that.arrFailedUploadsFilenames.join('<br/>')+'<br/>'+('Click '+('<b>'+'OK'+'</b>')+' to try again.'),
buttons:{
yes:'OK',
no:'Cancel'
},
fn:function(buttonId){
if(buttonId==='yes'){
arrFileData=that.arrFailedUploads;
arrFilename=that.arrFailedUploadsFilenames;
that.arrFailedUploads=[];
that.arrFailedUploadsFilenames=[];
uploadFilesInOrder(that,arrFileData.length,0)
}else{
selectLastUploadedFile()
}
},
scope:this
})
}else{
selectLastUploadedFile()
}
}
}
};
uploadFilesInOrder(this,arrFileData.length,0);
this.fireEvent('upload:allstart',{totalFilesCount:arrFileData.length+1})
},
showConflictDialog:function(fileObject){
var filename=fileObject.filename;
var conflictWin=this.app.windows.show({
cls:'web-modal-warning',
iconCls:'web-warning-icon',
modal:true,
type:'web.windows.FileUploader-conflict',
title:'Filename conflict',
width:480,
bodyCfg:{
tag:'div',
html:'A file named "'+web.DAL.decodeHref(filename)+'" already exists. Either rename the file or overwrite the existing file.'
},
buttons:[
{
cls:'x-btn-secondary',
text:'Rename',
handler:function(){
conflictWin.hide();
this.app.windows.show({
type:'web.windows.Rename',
modal:true,
okFn:function(win,filename){
fileObject.filename=filename;
this.uploadFile(fileObject)
},
values:{
filename:filename,
files:this.files
},
scope:this
})
},
scope:this
},
{
cls:'x-btn-primary large wide',
text:'Overwrite',
handler:function(){
var file=this.files.filter(function(item){
if(item.filename===filename){
return true
}
})[0];
conflictWin.hide();
this.uploadFile(fileObject,file.etag)
},
scope:this
}
],
listeners:{
hide:function(){
fileObject.callback()
},
scope:this
}
})
},
uploadFile:function(fileObject,etag){
var fileData=fileObject.fileData,filename=fileObject.filename,callback=fileObject.callback,totalFilesCount=fileObject.totalFilesCount,uploadPath=this.path+filename,arrOfErrors={
erroneousImageFileNames:[],
unsupportedFileNames:[],
invalidImageSizeFileNames:[],
invalidImageFilenames:[]
};
var that=this;
this.fireEvent('upload:start',{fileData:fileObject.fileData});
var onCompleteHandler=function(opts,success,response){
this.fileData=null;
if(success){
var data;
try{
data=Ext.decode(response.responseText)
}catch(e){
one.fatal('Unexpected error from server. Metadata is not set.", { url: "'+uploadPath+'"}',{url:uploadPath})
}
var allowIcoFiles=false,allowOnlyImage=false;
if(this.coreFile.allowOnlyImage){
allowOnlyImage=true;
if(this.coreFile.allowIcoFiles){
allowIcoFiles=true
}
}
var assetConfig;
if(allowOnlyImage){
if(this.validateImageInfo(data,null,arrOfErrors,filename)){
assetConfig=Ext.apply({url:'webspace:'+uploadPath},data);
if(!allowIcoFiles&&/^image\/(x-icon|vnd.microsoft.icon)$/.test(data.contentType)){
callback(assetConfig)
}else if(totalFilesCount===1){
this.fireEvent('upload:complete',assetConfig);
this.fireEvent('upload:allcomplete',[assetConfig])
}else{
callback(assetConfig);
this.uploadedFilesCount+=1;
assetConfig=this.allFiles.map(function(item){
return Ext.apply({url:'webspace:'+that.path+encodeURI(item.name)},data)
});
this.fireEvent('upload:complete',assetConfig[fileObject.currentFileIndex]);
if(this.uploadedFilesCount===totalFilesCount){
this.fireEvent('upload:allcomplete',assetConfig)
}
}
}else{
assetConfig=Ext.apply({url:'webspace:'+uploadPath},data);
this.showAllErrors(arrOfErrors);
this.fireEvent('validate:complete',{
fileData:fileObject.fileData,
valid:false
})
}
}else{
assetConfig=Ext.apply({url:'webspace:'+uploadPath},data);
if(totalFilesCount===1){
this.fireEvent('upload:complete',assetConfig);
this.fireEvent('upload:allcomplete',[assetConfig])
}else{
callback(assetConfig);
this.uploadedFilesCount+=1;
assetConfig=this.allFiles.map(function(item){
return Ext.apply({url:'webspace:'+that.path+encodeURI(item.name)},data)
});
this.fireEvent('upload:complete',assetConfig[fileObject.currentFileIndex]);
if(this.uploadedFilesCount===totalFilesCount){
this.fireEvent('upload:allcomplete',assetConfig)
}
}
}
}else{
this.fireEvent('upload:error',{fileObject:fileObject});
that.arrFailedUploads.push(fileObject.fileData);
that.arrFailedUploadsFilenames.push(fileObject.fileData.name||fileObject.filename);
callback()
}
};
var onProgressHandler=function(evt){
this.fireEvent('upload:progress',{
filename:filename,
total:evt.total,
loaded:evt.loaded
})
};
this.app.dal.uploadToWebspace(fileData.onlySingleFile?fileData.file:fileData,uploadPath,etag,{
onComplete:onCompleteHandler,
onProgress:onProgressHandler
},this);
if(typeof fileObject.fileData==='string'){
var fakeProgressBar=function(name){
for(var i=0;i<99;i+=1){
(function(){
var ii=i;
setTimeout(function(){
that.fireEvent('upload:progress',{
filename:name,
total:100,
loaded:ii,
strict:true
})
},ii*20)
}())
}
};
fakeProgressBar(this.url2fileName(fileObject.fileData))
}
},
validateImageInfo:function(data,dataURL,arrOfErrors,filename){
var checkImageSignature=function(base64Data){
var file=window.atob(base64Data.split(',')[1]),b=function(i){
return file[i].charCodeAt(0)
},w=function(i){
return(b(i+1)<<8)+b(i)
},dw=function(i){
return((((b(i)<<8)+b(i+1)<<8)+b(i+2)<<8)+b(i+3)+4294967296)%4294967296
};
if(file.match(/^GIF/)){
return'image/gif'
}else if(w(0)===55551){
return'image/jpeg'
}else if(dw(0)===2303741511){
return'image/png'
}else if(w(0)===0&&w(2)===1&&w(4)>=1){
return'image/vnd.microsoft.icon'
}
return null
};
if(data){
if(/^image\/(x-icon|vnd.microsoft.icon)$/.test(data.contentType)){
if(!data.width||!data.height){
data.width=1;
data.height=1
}
}
if(data.filesize===0){
if(arrOfErrors){
arrOfErrors.erroneousImageFileNames.push(filename)
}
return false
}else if(!data.width||!data.height){
if(arrOfErrors){
arrOfErrors.unsupportedFileNames.push(filename)
}
return false
}else if(data.width*data.height>web.data.components.resources.Image.DIMENSION_LIMIT){
if(arrOfErrors){
arrOfErrors.invalidImageSizeFileNames.push(filename)
}
return false
}else if(dataURL&&!checkImageSignature(dataURL)){
if(arrOfErrors){
arrOfErrors.invalidImageFilenames.push(filename)
}
return false
}
return true
}else{
if(arrOfErrors){
arrOfErrors.invalidImageFilenames.push(filename)
}
return false
}
},
showAllErrors:function(arrOfErrors){
var fnInvalidImageSize=function(){
if(arrOfErrors.invalidImageSizeFileNames.length){
Ext.Msg.show({
cls:'errorneous-files-list web-modal-warning',
iconCls:'web-warning-icon',
title:'Invalid image size.',
msg:'<b>'+'The selected image is too large. Please add files smaller than 64 megapixels.'+'</b>'+'<br/><br/>'+arrOfErrors.invalidImageSizeFileNames.join('<br/>'),
buttons:{ok:'OK'},
fn:function(btn){
}
})
}
};
var fnUnsupported=function(){
if(arrOfErrors.unsupportedFileNames.length){
var msg;
if(arrOfErrors.unsupportedFileNames.length<2){
msg='<b>'+('"'+arrOfErrors.unsupportedFileNames[0]+'" is not a supported file type.')+'</b> '+'Please choose another file type.'
}else{
msg='<b>'+'These files have an unsupported type:'+'</b>'+'<br/><br/>'+arrOfErrors.unsupportedFileNames.join('<br/>')+'<br/><br/>'+'Please choose another file type.'
}
Ext.Msg.show({
cls:'web-modal-warning errorneous-files-list',
iconCls:'web-warning-icon',
title:'Unsupported file.',
msg:msg,
buttons:{ok:'OK'},
fn:function(btn){
fnInvalidImageSize()
}
})
}else{
fnInvalidImageSize()
}
};
var fnInvalid=function(){
if(arrOfErrors.erroneousImageFileNames.length){
Ext.Msg.show({
cls:'errorneous-files-list web-modal-warning',
iconCls:'web-warning-icon',
title:'Invalid File',
msg:'<b>'+'The file could not be read correctly.'+'</b>'+'<br/><br/>'+arrOfErrors.erroneousImageFileNames.join('<br/>'),
buttons:{ok:'OK'},
fn:function(btn){
fnUnsupported()
}
})
}else{
fnUnsupported()
}
};
var fnCheckForAllErrors=function(){
fnInvalid()
};
fnCheckForAllErrors()
},
url2fileName:function(url){
return url.replace(/[^\/]*\//g,'').replace(/\?[^$]*/,'').replace(/#[^$]*/,'')
}
});
(function(){
var a,AbstractChosen,Chosen,SelectParser,b,c={}.hasOwnProperty,d=function(a,b){
function d(){
this.constructor=a
}
for(var e in b)
c.call(b,e)&&(a[e]=b[e]);
return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a
};
SelectParser=function(){
function SelectParser(){
this.options_index=0,this.parsed=[]
}
return SelectParser.prototype.add_node=function(a){
return'OPTGROUP'===a.nodeName.toUpperCase()?this.add_group(a):this.add_option(a)
},SelectParser.prototype.add_group=function(a){
var b,c,d,e,f,g;
for(b=this.parsed.length,this.parsed.push({
array_index:b,
group:!0,
label:this.escapeExpression(a.label),
title:a.title?a.title:void 0,
children:0,
disabled:a.disabled,
classes:a.className
}),f=a.childNodes,g=[],d=0,e=f.length;e>d;d++)
c=f[d],g.push(this.add_option(c,b,a.disabled));
return g
},SelectParser.prototype.add_option=function(a,b,c){
return'OPTION'===a.nodeName.toUpperCase()?(''!==a.text?(null!=b&&(this.parsed[b].children+=1),this.parsed.push({
array_index:this.parsed.length,
options_index:this.options_index,
value:a.value,
text:a.text,
html:a.innerHTML,
title:a.title?a.title:void 0,
selected:a.selected,
disabled:c===!0?c:a.disabled,
group_array_index:b,
group_label:null!=b?this.parsed[b].label:null,
classes:a.className,
style:a.style.cssText
})):this.parsed.push({
array_index:this.parsed.length,
options_index:this.options_index,
empty:!0
}),this.options_index+=1):void 0
},SelectParser.prototype.escapeExpression=function(a){
var b,c;
return null==a||a===!1?'':/[\&\<\>\"\'\`]/.test(a)?(b={
'<':'&lt;',
'>':'&gt;',
'"':'&quot;',
'\'':'&#x27;',
'`':'&#x60;'
},c=/&(?!\w+;)|[\<\>\"\'\`]/g,a.replace(c,function(a){
return b[a]||'&amp;'
})):a
},SelectParser
}(),SelectParser.select_to_array=function(a){
var b,c,d,e,f;
for(c=new SelectParser,f=a.childNodes,d=0,e=f.length;e>d;d++)
b=f[d],c.add_node(b);
return c.parsed
},AbstractChosen=function(){
function AbstractChosen(a,b){
this.form_field=a,this.options=null!=b?b:{},AbstractChosen.browser_is_supported()&&(this.is_multiple=this.form_field.multiple,this.set_default_text(),this.set_default_values(),this.setup(),this.set_up_html(),this.register_observers(),this.on_ready())
}
return AbstractChosen.prototype.set_default_values=function(){
var a=this;
return this.click_test_action=function(b){
return a.test_active_click(b)
},this.activate_action=function(b){
return a.activate_field(b)
},this.active_field=!1,this.mouse_on_container=!1,this.results_showing=!1,this.result_highlighted=null,this.allow_single_deselect=null!=this.options.allow_single_deselect&&null!=this.form_field.options[0]&&''===this.form_field.options[0].text?this.options.allow_single_deselect:!1,this.disable_search_threshold=this.options.disable_search_threshold||0,this.disable_search=this.options.disable_search||!1,this.enable_split_word_search=null!=this.options.enable_split_word_search?this.options.enable_split_word_search:!0,this.group_search=null!=this.options.group_search?this.options.group_search:!0,this.search_contains=this.options.search_contains||!1,this.single_backstroke_delete=null!=this.options.single_backstroke_delete?this.options.single_backstroke_delete:!0,this.max_selected_options=this.options.max_selected_options||1/0,this.inherit_select_classes=this.options.inherit_select_classes||!1,this.display_selected_options=null!=this.options.display_selected_options?this.options.display_selected_options:!0,this.display_disabled_options=null!=this.options.display_disabled_options?this.options.display_disabled_options:!0,this.include_group_label_in_selected=this.options.include_group_label_in_selected||!1
},AbstractChosen.prototype.set_default_text=function(){
return this.default_text=this.form_field.getAttribute('data-placeholder')?this.form_field.getAttribute('data-placeholder'):this.is_multiple?this.options.placeholder_text_multiple||this.options.placeholder_text||AbstractChosen.default_multiple_text:this.options.placeholder_text_single||this.options.placeholder_text||AbstractChosen.default_single_text,this.results_none_found=this.form_field.getAttribute('data-no_results_text')||this.options.no_results_text||AbstractChosen.default_no_result_text
},AbstractChosen.prototype.choice_label=function(a){
return this.include_group_label_in_selected&&null!=a.group_label?'<b class=\'group-name\'>'+a.group_label+'</b>'+a.html:a.html
},AbstractChosen.prototype.mouse_enter=function(){
return this.mouse_on_container=!0
},AbstractChosen.prototype.mouse_leave=function(){
return this.mouse_on_container=!1
},AbstractChosen.prototype.input_focus=function(){
var a=this;
if(this.is_multiple){
if(!this.active_field)
return setTimeout(function(){
return a.container_mousedown()
},50)
}else if(!this.active_field)
return this.activate_field()
},AbstractChosen.prototype.input_blur=function(){
var a=this;
return this.mouse_on_container?void 0:(this.active_field=!1,setTimeout(function(){
return a.blur_test()
},100))
},AbstractChosen.prototype.results_option_build=function(a){
var b,c,d,e,f;
for(b='',f=this.results_data,d=0,e=f.length;e>d;d++)
c=f[d],b+=c.group?this.result_add_group(c):this.result_add_option(c),(null!=a?a.first:void 0)&&(c.selected&&this.is_multiple?this.choice_build(c):c.selected&&!this.is_multiple&&this.single_set_selected_text(this.choice_label(c)));
return b
},AbstractChosen.prototype.result_add_option=function(a){
var b,c;
return a.search_match?this.include_option_in_results(a)?(b=[],a.disabled||a.selected&&this.is_multiple||b.push('active-result'),!a.disabled||a.selected&&this.is_multiple||b.push('disabled-result'),a.selected&&b.push('result-selected'),null!=a.group_array_index&&b.push('group-option'),''!==a.classes&&b.push(a.classes),c=document.createElement('li'),c.className=b.join(' '),c.style.cssText=a.style,c.setAttribute('data-option-array-index',a.array_index),c.innerHTML=a.search_text,a.title&&(c.title=a.title),this.outerHTML(c)):'':''
},AbstractChosen.prototype.result_add_group=function(a){
var b,c;
return a.search_match||a.group_match?a.active_options>0?(b=[],b.push('group-result'),a.classes&&b.push(a.classes),c=document.createElement('li'),c.className=b.join(' '),c.innerHTML=a.search_text,a.title&&(c.title=a.title),this.outerHTML(c)):'':''
},AbstractChosen.prototype.results_update_field=function(){
return this.set_default_text(),this.is_multiple||this.results_reset_cleanup(),this.result_clear_highlight(),this.results_build(),this.results_showing?this.winnow_results():void 0
},AbstractChosen.prototype.reset_single_select_options=function(){
var a,b,c,d,e;
for(d=this.results_data,e=[],b=0,c=d.length;c>b;b++)
a=d[b],a.selected?e.push(a.selected=!1):e.push(void 0);
return e
},AbstractChosen.prototype.results_toggle=function(){
return this.results_showing?this.results_hide():this.results_show()
},AbstractChosen.prototype.results_search=function(){
return this.results_showing?this.winnow_results():this.results_show()
},AbstractChosen.prototype.winnow_results=function(){
var a,b,c,d,e,f,g,h,i,j,k,l;
for(this.no_results_clear(),d=0,f=this.get_search_text(),a=f.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,'\\$&'),i=new RegExp(a,'i'),c=this.get_search_regex(a),l=this.results_data,j=0,k=l.length;k>j;j++)
b=l[j],b.search_match=!1,e=null,this.include_option_in_results(b)&&(b.group&&(b.group_match=!1,b.active_options=0),null!=b.group_array_index&&this.results_data[b.group_array_index]&&(e=this.results_data[b.group_array_index],0===e.active_options&&e.search_match&&(d+=1),e.active_options+=1),b.search_text=b.group?b.label:b.html,(!b.group||this.group_search)&&(b.search_match=this.search_string_match(b.search_text,c),b.search_match&&!b.group&&(d+=1),b.search_match?(f.length&&(g=b.search_text.search(i),h=b.search_text.substr(0,g+f.length)+'</em>'+b.search_text.substr(g+f.length),b.search_text=h.substr(0,g)+'<em>'+h.substr(g)),null!=e&&(e.group_match=!0)):null!=b.group_array_index&&this.results_data[b.group_array_index].search_match&&(b.search_match=!0)));
return this.result_clear_highlight(),1>d&&f.length?(this.update_results_content(''),this.no_results(f)):(this.update_results_content(this.results_option_build()),this.winnow_results_set_highlight())
},AbstractChosen.prototype.get_search_regex=function(a){
var b;
return b=this.search_contains?'':'^',new RegExp(b+a,'i')
},AbstractChosen.prototype.search_string_match=function(a,b){
var c,d,e,f;
if(b.test(a))
return!0;
if(this.enable_split_word_search&&(a.indexOf(' ')>=0||0===a.indexOf('['))&&(d=a.replace(/\[|\]/g,'').split(' '),d.length))
for(e=0,f=d.length;f>e;e++)
if(c=d[e],b.test(c))
return!0
},AbstractChosen.prototype.choices_count=function(){
var a,b,c,d;
if(null!=this.selected_option_count)
return this.selected_option_count;
for(this.selected_option_count=0,d=this.form_field.options,b=0,c=d.length;c>b;b++)
a=d[b],a.selected&&(this.selected_option_count+=1);
return this.selected_option_count
},AbstractChosen.prototype.choices_click=function(a){
return a.preventDefault(),this.results_showing||this.is_disabled?void 0:this.results_show()
},AbstractChosen.prototype.keyup_checker=function(a){
var b,c;
switch(b=null!=(c=a.which)?c:a.keyCode,this.search_field_scale(),b){
case 8:
if(this.is_multiple&&this.backstroke_length<1&&this.choices_count()>0)
return this.keydown_backstroke();
if(!this.pending_backstroke)
return this.result_clear_highlight(),this.results_search();
break;
case 13:
if(a.preventDefault(),this.results_showing)
return this.result_select(a);
break;
case 27:
return this.results_showing&&this.results_hide(),!0;
case 9:
case 38:
case 40:
case 16:
case 91:
case 17:
break;
default:
return this.results_search()
}
},AbstractChosen.prototype.clipboard_event_checker=function(){
var a=this;
return setTimeout(function(){
return a.results_search()
},50)
},AbstractChosen.prototype.container_width=function(){
return null!=this.options.width?this.options.width:''+this.form_field.offsetWidth+'px'
},AbstractChosen.prototype.include_option_in_results=function(a){
return this.is_multiple&&!this.display_selected_options&&a.selected?!1:!this.display_disabled_options&&a.disabled?!1:a.empty?!1:!0
},AbstractChosen.prototype.search_results_touchstart=function(a){
return this.touch_started=!0,this.search_results_mouseover(a)
},AbstractChosen.prototype.search_results_touchmove=function(a){
return this.touch_started=!1,this.search_results_mouseout(a)
},AbstractChosen.prototype.search_results_touchend=function(a){
return this.touch_started?this.search_results_mouseup(a):void 0
},AbstractChosen.prototype.outerHTML=function(a){
var b;
return a.outerHTML?a.outerHTML:(b=document.createElement('div'),b.appendChild(a),b.innerHTML)
},AbstractChosen.browser_is_supported=function(){
return'Microsoft Internet Explorer'===window.navigator.appName?document.documentMode>=8:/iP(od|hone)/i.test(window.navigator.userAgent)?!1:/Android/i.test(window.navigator.userAgent)&&/Mobile/i.test(window.navigator.userAgent)?!1:!0
},AbstractChosen.default_multiple_text='Select Some Options',AbstractChosen.default_single_text='Select an Option',AbstractChosen.default_no_result_text='No results match',AbstractChosen
}(),a=oneJQuery,a.fn.extend({
chosen:function(b){
return AbstractChosen.browser_is_supported()?this.each(function(){
var c,d;
c=a(this),d=c.data('chosen'),'destroy'===b&&d instanceof Chosen?d.destroy():d instanceof Chosen||c.data('chosen',new Chosen(this,b))
}):this
}
}),Chosen=function(c){
function Chosen(){
return b=Chosen.__super__.constructor.apply(this,arguments)
}
return d(Chosen,c),Chosen.prototype.setup=function(){
return this.form_field_jq=a(this.form_field),this.current_selectedIndex=this.form_field.selectedIndex,this.is_rtl=this.form_field_jq.hasClass('chosen-rtl')
},Chosen.prototype.set_up_html=function(){
var b,c;
return b=['chosen-container'],b.push('chosen-container-'+(this.is_multiple?'multi':'single')),this.inherit_select_classes&&this.form_field.className&&b.push(this.form_field.className),this.is_rtl&&b.push('chosen-rtl'),c={
'class':b.join(' '),
style:'width: '+this.container_width()+';',
title:this.form_field.title
},this.form_field.id.length&&(c.id=this.form_field.id.replace(/[^\w]/g,'_')+'_chosen'),this.container=a('<div />',c),this.is_multiple?this.container.html('<ul class="chosen-choices"><li class="search-field"><input type="text" value="'+this.default_text+'" class="default" autocomplete="off" style="width:25px;" /></li></ul><div class="chosen-drop"><ul class="chosen-results"></ul></div>'):this.container.html('<a class="chosen-single chosen-default" tabindex="-1"><span>'+this.default_text+'</span><div><b></b></div></a><div class="chosen-drop"><div class="chosen-search"><input type="text" autocomplete="off" /></div><ul class="chosen-results"></ul></div>'),this.form_field_jq.hide().after(this.container),this.dropdown=this.container.find('div.chosen-drop').first(),this.search_field=this.container.find('input').first(),this.search_results=this.container.find('ul.chosen-results').first(),this.search_field_scale(),this.search_no_results=this.container.find('li.no-results').first(),this.is_multiple?(this.search_choices=this.container.find('ul.chosen-choices').first(),this.search_container=this.container.find('li.search-field').first()):(this.search_container=this.container.find('div.chosen-search').first(),this.selected_item=this.container.find('.chosen-single').first()),this.results_build(),this.set_tab_index(),this.set_label_behavior()
},Chosen.prototype.on_ready=function(){
return this.form_field_jq.trigger('chosen:ready',{chosen:this})
},Chosen.prototype.register_observers=function(){
var a=this;
return this.container.bind('touchstart.chosen',function(b){
return a.container_mousedown(b),b.preventDefault()
}),this.container.bind('touchend.chosen',function(b){
return a.container_mouseup(b),b.preventDefault()
}),this.container.bind('mousedown.chosen',function(b){
a.container_mousedown(b)
}),this.container.bind('mouseup.chosen',function(b){
a.container_mouseup(b)
}),this.container.bind('mouseenter.chosen',function(b){
a.mouse_enter(b)
}),this.container.bind('mouseleave.chosen',function(b){
a.mouse_leave(b)
}),this.search_results.bind('mouseup.chosen',function(b){
a.search_results_mouseup(b)
}),this.search_results.bind('mouseover.chosen',function(b){
a.search_results_mouseover(b)
}),this.search_results.bind('mouseout.chosen',function(b){
a.search_results_mouseout(b)
}),this.search_results.bind('mousewheel.chosen DOMMouseScroll.chosen',function(b){
a.search_results_mousewheel(b)
}),this.search_results.bind('touchstart.chosen',function(b){
a.search_results_touchstart(b)
}),this.search_results.bind('touchmove.chosen',function(b){
a.search_results_touchmove(b)
}),this.search_results.bind('touchend.chosen',function(b){
a.search_results_touchend(b)
}),this.form_field_jq.bind('chosen:updated.chosen',function(b){
a.results_update_field(b)
}),this.form_field_jq.bind('chosen:activate.chosen',function(b){
a.activate_field(b)
}),this.form_field_jq.bind('chosen:open.chosen',function(b){
a.container_mousedown(b)
}),this.form_field_jq.bind('chosen:close.chosen',function(b){
a.input_blur(b)
}),this.search_field.bind('blur.chosen',function(b){
a.input_blur(b)
}),this.search_field.bind('keyup.chosen',function(b){
a.keyup_checker(b)
}),this.search_field.bind('keydown.chosen',function(b){
a.keydown_checker(b)
}),this.search_field.bind('focus.chosen',function(b){
a.input_focus(b)
}),this.search_field.bind('cut.chosen',function(b){
a.clipboard_event_checker(b)
}),this.search_field.bind('paste.chosen',function(b){
a.clipboard_event_checker(b)
}),this.is_multiple?this.search_choices.bind('click.chosen',function(b){
a.choices_click(b)
}):this.container.bind('click.chosen',function(a){
a.preventDefault()
})
},Chosen.prototype.destroy=function(){
return a(this.container[0].ownerDocument).unbind('click.chosen',this.click_test_action),this.search_field[0].tabIndex&&(this.form_field_jq[0].tabIndex=this.search_field[0].tabIndex),this.container.remove(),this.form_field_jq.removeData('chosen'),this.form_field_jq.show()
},Chosen.prototype.search_field_disabled=function(){
return this.is_disabled=this.form_field_jq[0].disabled,this.is_disabled?(this.container.addClass('chosen-disabled'),this.search_field[0].disabled=!0,this.is_multiple||this.selected_item.unbind('focus.chosen',this.activate_action),this.close_field()):(this.container.removeClass('chosen-disabled'),this.search_field[0].disabled=!1,this.is_multiple?void 0:this.selected_item.bind('focus.chosen',this.activate_action))
},Chosen.prototype.container_mousedown=function(b){
return this.is_disabled||(b&&'mousedown'===b.type&&!this.results_showing&&b.preventDefault(),null!=b&&a(b.target).hasClass('search-choice-close'))?void 0:(this.active_field?this.is_multiple||!b||a(b.target)[0]!==this.selected_item[0]&&!a(b.target).parents('a.chosen-single').length||(b.preventDefault(),this.results_toggle()):(this.is_multiple&&this.search_field.val(''),a(this.container[0].ownerDocument).bind('click.chosen',this.click_test_action),this.results_show()),this.activate_field())
},Chosen.prototype.container_mouseup=function(a){
return'ABBR'!==a.target.nodeName||this.is_disabled?void 0:this.results_reset(a)
},Chosen.prototype.search_results_mousewheel=function(a){
var b;
return a.originalEvent&&(b=a.originalEvent.deltaY||-a.originalEvent.wheelDelta||a.originalEvent.detail),null!=b?(a.preventDefault(),'DOMMouseScroll'===a.type&&(b=40*b),this.search_results.scrollTop(b+this.search_results.scrollTop())):void 0
},Chosen.prototype.blur_test=function(){
return!this.active_field&&this.container.hasClass('chosen-container-active')?this.close_field():void 0
},Chosen.prototype.close_field=function(){
return a(this.container[0].ownerDocument).unbind('click.chosen',this.click_test_action),this.active_field=!1,this.results_hide(),this.container.removeClass('chosen-container-active'),this.clear_backstroke(),this.show_search_field_default(),this.search_field_scale()
},Chosen.prototype.activate_field=function(){
return this.container.addClass('chosen-container-active'),this.active_field=!0,this.search_field.val(this.search_field.val()),this.search_field.focus()
},Chosen.prototype.test_active_click=function(b){
var c;
return c=a(b.target).closest('.chosen-container'),c.length&&this.container[0]===c[0]?this.active_field=!0:this.close_field()
},Chosen.prototype.results_build=function(){
return this.parsing=!0,this.selected_option_count=null,this.results_data=SelectParser.select_to_array(this.form_field),this.is_multiple?this.search_choices.find('li.search-choice').remove():this.is_multiple||(this.single_set_selected_text(),this.disable_search||this.form_field.options.length<=this.disable_search_threshold?(this.search_field[0].readOnly=!0,this.container.addClass('chosen-container-single-nosearch')):(this.search_field[0].readOnly=!1,this.container.removeClass('chosen-container-single-nosearch'))),this.update_results_content(this.results_option_build({first:!0})),this.search_field_disabled(),this.show_search_field_default(),this.search_field_scale(),this.parsing=!1
},Chosen.prototype.result_do_highlight=function(a){
var b,c,d,e,f;
if(a.length){
if(this.result_clear_highlight(),this.result_highlight=a,this.result_highlight.addClass('highlighted'),d=parseInt(this.search_results.css('maxHeight'),10),f=this.search_results.scrollTop(),e=d+f,c=this.result_highlight.position().top+this.search_results.scrollTop(),b=c+this.result_highlight.outerHeight(),b>=e)
return this.search_results.scrollTop(b-d>0?b-d:0);
if(f>c)
return this.search_results.scrollTop(c)
}
},Chosen.prototype.result_clear_highlight=function(){
return this.result_highlight&&this.result_highlight.removeClass('highlighted'),this.result_highlight=null
},Chosen.prototype.results_show=function(){
return this.is_multiple&&this.max_selected_options<=this.choices_count()?(this.form_field_jq.trigger('chosen:maxselected',{chosen:this}),!1):(this.container.addClass('chosen-with-drop'),this.results_showing=!0,this.search_field.focus(),this.search_field.val(this.search_field.val()),this.winnow_results(),this.form_field_jq.trigger('chosen:showing_dropdown',{chosen:this}))
},Chosen.prototype.update_results_content=function(a){
return this.search_results.html(a)
},Chosen.prototype.results_hide=function(){
return this.results_showing&&(this.result_clear_highlight(),this.container.removeClass('chosen-with-drop'),this.form_field_jq.trigger('chosen:hiding_dropdown',{chosen:this})),this.results_showing=!1
},Chosen.prototype.set_tab_index=function(){
var a;
return this.form_field.tabIndex?(a=this.form_field.tabIndex,this.form_field.tabIndex=-1,this.search_field[0].tabIndex=a):void 0
},Chosen.prototype.set_label_behavior=function(){
var b=this;
return this.form_field_label=this.form_field_jq.parents('label'),!this.form_field_label.length&&this.form_field.id.length&&(this.form_field_label=a('label[for=\''+this.form_field.id+'\']')),this.form_field_label.length>0?this.form_field_label.bind('click.chosen',function(a){
return b.is_multiple?b.container_mousedown(a):b.activate_field()
}):void 0
},Chosen.prototype.show_search_field_default=function(){
return this.is_multiple&&this.choices_count()<1&&!this.active_field?(this.search_field.val(this.default_text),this.search_field.addClass('default')):(this.search_field.val(''),this.search_field.removeClass('default'))
},Chosen.prototype.search_results_mouseup=function(b){
var c;
return c=a(b.target).hasClass('active-result')?a(b.target):a(b.target).parents('.active-result').first(),c.length?(this.result_highlight=c,this.result_select(b),this.search_field.focus()):void 0
},Chosen.prototype.search_results_mouseover=function(b){
var c;
return c=a(b.target).hasClass('active-result')?a(b.target):a(b.target).parents('.active-result').first(),c?this.result_do_highlight(c):void 0
},Chosen.prototype.search_results_mouseout=function(b){
return a(b.target).hasClass('active-result')?this.result_clear_highlight():void 0
},Chosen.prototype.choice_build=function(b){
var c,d,e=this;
return c=a('<li />',{'class':'search-choice'}).html('<span>'+this.choice_label(b)+'</span>'),b.disabled?c.addClass('search-choice-disabled'):(d=a('<a />',{
'class':'search-choice-close',
'data-option-array-index':b.array_index
}),d.bind('click.chosen',function(a){
return e.choice_destroy_link_click(a)
}),c.append(d)),this.search_container.before(c)
},Chosen.prototype.choice_destroy_link_click=function(b){
return b.preventDefault(),b.stopPropagation(),this.is_disabled?void 0:this.choice_destroy(a(b.target))
},Chosen.prototype.choice_destroy=function(a){
return this.result_deselect(a[0].getAttribute('data-option-array-index'))?(this.show_search_field_default(),this.is_multiple&&this.choices_count()>0&&this.search_field.val().length<1&&this.results_hide(),a.parents('li').first().remove(),this.search_field_scale()):void 0
},Chosen.prototype.results_reset=function(){
return this.reset_single_select_options(),this.form_field.options[0].selected=!0,this.single_set_selected_text(),this.show_search_field_default(),this.results_reset_cleanup(),this.form_field_jq.trigger('change'),this.active_field?this.results_hide():void 0
},Chosen.prototype.results_reset_cleanup=function(){
return this.current_selectedIndex=this.form_field.selectedIndex,this.selected_item.find('abbr').remove()
},Chosen.prototype.result_select=function(a){
var b,c;
return this.result_highlight?(b=this.result_highlight,this.result_clear_highlight(),this.is_multiple&&this.max_selected_options<=this.choices_count()?(this.form_field_jq.trigger('chosen:maxselected',{chosen:this}),!1):(this.is_multiple?b.removeClass('active-result'):this.reset_single_select_options(),c=this.results_data[b[0].getAttribute('data-option-array-index')],c.selected=!0,this.form_field.options[c.options_index].selected=!0,this.selected_option_count=null,this.is_multiple?this.choice_build(c):this.single_set_selected_text(this.choice_label(c)),(a.metaKey||a.ctrlKey)&&this.is_multiple||this.results_hide(),this.search_field.val(''),(this.is_multiple||this.form_field.selectedIndex!==this.current_selectedIndex)&&this.form_field_jq.trigger('change',{selected:this.form_field.options[c.options_index].value}),this.current_selectedIndex=this.form_field.selectedIndex,a.preventDefault(),this.search_field_scale())):void 0
},Chosen.prototype.single_set_selected_text=function(a){
return null==a&&(a=this.default_text),a===this.default_text?this.selected_item.addClass('chosen-default'):(this.single_deselect_control_build(),this.selected_item.removeClass('chosen-default')),this.selected_item.find('span').html(a)
},Chosen.prototype.result_deselect=function(a){
var b;
return b=this.results_data[a],this.form_field.options[b.options_index].disabled?!1:(b.selected=!1,this.form_field.options[b.options_index].selected=!1,this.selected_option_count=null,this.result_clear_highlight(),this.results_showing&&this.winnow_results(),this.form_field_jq.trigger('change',{deselected:this.form_field.options[b.options_index].value}),this.search_field_scale(),!0)
},Chosen.prototype.single_deselect_control_build=function(){
return this.allow_single_deselect?(this.selected_item.find('abbr').length||this.selected_item.find('span').first().after('<abbr class="search-choice-close"></abbr>'),this.selected_item.addClass('chosen-single-with-deselect')):void 0
},Chosen.prototype.get_search_text=function(){
return a('<div/>').text(a.trim(this.search_field.val())).html()
},Chosen.prototype.winnow_results_set_highlight=function(){
var a,b;
return b=this.is_multiple?[]:this.search_results.find('.result-selected.active-result'),a=b.length?b.first():this.search_results.find('.active-result').first(),null!=a?this.result_do_highlight(a):void 0
},Chosen.prototype.no_results=function(b){
var c;
return c=a('<li class="no-results">'+this.results_none_found+' "<span></span>"</li>'),c.find('span').first().html(b),this.search_results.append(c),this.form_field_jq.trigger('chosen:no_results',{chosen:this})
},Chosen.prototype.no_results_clear=function(){
return this.search_results.find('.no-results').remove()
},Chosen.prototype.keydown_arrow=function(){
var a;
return this.results_showing&&this.result_highlight?(a=this.result_highlight.nextAll('li.active-result').first())?this.result_do_highlight(a):void 0:this.results_show()
},Chosen.prototype.keyup_arrow=function(){
var a;
return this.results_showing||this.is_multiple?this.result_highlight?(a=this.result_highlight.prevAll('li.active-result'),a.length?this.result_do_highlight(a.first()):(this.choices_count()>0&&this.results_hide(),this.result_clear_highlight())):void 0:this.results_show()
},Chosen.prototype.keydown_backstroke=function(){
var a;
return this.pending_backstroke?(this.choice_destroy(this.pending_backstroke.find('a').first()),this.clear_backstroke()):(a=this.search_container.siblings('li.search-choice').last(),a.length&&!a.hasClass('search-choice-disabled')?(this.pending_backstroke=a,this.single_backstroke_delete?this.keydown_backstroke():this.pending_backstroke.addClass('search-choice-focus')):void 0)
},Chosen.prototype.clear_backstroke=function(){
return this.pending_backstroke&&this.pending_backstroke.removeClass('search-choice-focus'),this.pending_backstroke=null
},Chosen.prototype.keydown_checker=function(a){
var b,c;
switch(b=null!=(c=a.which)?c:a.keyCode,this.search_field_scale(),8!==b&&this.pending_backstroke&&this.clear_backstroke(),b){
case 8:
this.backstroke_length=this.search_field.val().length;
break;
case 9:
this.results_showing&&!this.is_multiple&&this.result_select(a),this.mouse_on_container=!1;
break;
case 13:
this.results_showing&&a.preventDefault();
break;
case 32:
this.disable_search&&a.preventDefault();
break;
case 38:
a.preventDefault(),this.keyup_arrow();
break;
case 40:
a.preventDefault(),this.keydown_arrow()
}
},Chosen.prototype.search_field_scale=function(){
var b,c,d,e,f,g,h,i,j;
if(this.is_multiple){
for(d=0,h=0,f='position:absolute; left: -1000px; top: -1000px; display:none;',g=[
'font-size',
'font-style',
'font-weight',
'font-family',
'line-height',
'text-transform',
'letter-spacing'
],i=0,j=g.length;j>i;i++)
e=g[i],f+=e+':'+this.search_field.css(e)+';';
return b=a('<div />',{style:f}),b.text(this.search_field.val()),a('body').append(b),h=b.width()+25,b.remove(),c=this.container.outerWidth(),h>c-10&&(h=c-10),this.search_field.css({width:h+'px'})
}
},Chosen
}(AbstractChosen)
}.call(this));
oneJQuery.infiniteScroll=function(opts){
var defaults={container:opts.container||oneJQuery('body')};
opts=oneJQuery.extend({},opts,defaults);
opts.callback='function'===typeof opts.callback?opts.callback:function(){
};
oneJQuery(opts.container).bind('scroll',function(){
var t=oneJQuery(this);
if(t.scrollTop()>0){
if(t.scrollTop()+t.innerHeight()>=t[0].scrollHeight){
opts.callback()
}
}
})
};
/*! jQuery UI - v1.11.4 - 2015-03-12
* http://jqueryui.com
* Includes: widget.js
* Copyright 2015 jQuery Foundation and other contributors; Licensed MIT */
(function(factory){
if(typeof define==='function'&&define.amd){
define(['jquery'],factory)
}else{
factory(oneJQuery)
}
}(function($){
/*!
 * jQuery UI Widget 1.11.4
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/jQuery.widget/
 */
var widget_uuid=0,widget_slice=Array.prototype.slice;
$.cleanData=function(orig){
return function(elems){
var events,elem,i;
for(i=0;(elem=elems[i])!=null;i++){
try{
events=$._data(elem,'events');
if(events&&events.remove){
$(elem).triggerHandler('remove')
}
}catch(e){
}
}
orig(elems)
}
}($.cleanData);
$.widget=function(name,base,prototype){
var fullName,existingConstructor,constructor,basePrototype,proxiedPrototype={},namespace=name.split('.')[0];
name=name.split('.')[1];
fullName=namespace+'-'+name;
if(!prototype){
prototype=base;
base=$.Widget
}
$.expr[':'][fullName.toLowerCase()]=function(elem){
return!!$.data(elem,fullName)
};
$[namespace]=$[namespace]||{};
existingConstructor=$[namespace][name];
constructor=$[namespace][name]=function(options,element){
if(!this._createWidget){
return new constructor(options,element)
}
if(arguments.length){
this._createWidget(options,element)
}
};
$.extend(constructor,existingConstructor,{
version:prototype.version,
_proto:$.extend({},prototype),
_childConstructors:[]
});
basePrototype=new base;
basePrototype.options=$.widget.extend({},basePrototype.options);
$.each(prototype,function(prop,value){
if(!$.isFunction(value)){
proxiedPrototype[prop]=value;
return
}
proxiedPrototype[prop]=function(){
var _super=function(){
return base.prototype[prop].apply(this,arguments)
},_superApply=function(args){
return base.prototype[prop].apply(this,args)
};
return function(){
var __super=this._super,__superApply=this._superApply,returnValue;
this._super=_super;
this._superApply=_superApply;
returnValue=value.apply(this,arguments);
this._super=__super;
this._superApply=__superApply;
return returnValue
}
}()
});
constructor.prototype=$.widget.extend(basePrototype,{widgetEventPrefix:existingConstructor?basePrototype.widgetEventPrefix||name:name},proxiedPrototype,{
constructor:constructor,
namespace:namespace,
widgetName:name,
widgetFullName:fullName
});
if(existingConstructor){
$.each(existingConstructor._childConstructors,function(i,child){
var childPrototype=child.prototype;
$.widget(childPrototype.namespace+'.'+childPrototype.widgetName,constructor,child._proto)
});
delete existingConstructor._childConstructors
}else{
base._childConstructors.push(constructor)
}
$.widget.bridge(name,constructor);
return constructor
};
$.widget.extend=function(target){
var input=widget_slice.call(arguments,1),inputIndex=0,inputLength=input.length,key,value;
for(;inputIndex<inputLength;inputIndex++){
for(key in input[inputIndex]){
value=input[inputIndex][key];
if(input[inputIndex].hasOwnProperty(key)&&value!==undefined){
if($.isPlainObject(value)){
target[key]=$.isPlainObject(target[key])?$.widget.extend({},target[key],value):$.widget.extend({},value)
}else{
target[key]=value
}
}
}
}
return target
};
$.widget.bridge=function(name,object){
var fullName=object.prototype.widgetFullName||name;
$.fn[name]=function(options){
var isMethodCall=typeof options==='string',args=widget_slice.call(arguments,1),returnValue=this;
if(isMethodCall){
this.each(function(){
var methodValue,instance=$.data(this,fullName);
if(options==='instance'){
returnValue=instance;
return false
}
if(!instance){
return $.error('cannot call methods on '+name+' prior to initialization; '+'attempted to call method \''+options+'\'')
}
if(!$.isFunction(instance[options])||options.charAt(0)==='_'){
return $.error('no such method \''+options+'\' for '+name+' widget instance')
}
methodValue=instance[options].apply(instance,args);
if(methodValue!==instance&&methodValue!==undefined){
returnValue=methodValue&&methodValue.jquery?returnValue.pushStack(methodValue.get()):methodValue;
return false
}
})
}else{
if(args.length){
options=$.widget.extend.apply(null,[options].concat(args))
}
this.each(function(){
var instance=$.data(this,fullName);
if(instance){
instance.option(options||{});
if(instance._init){
instance._init()
}
}else{
$.data(this,fullName,new object(options,this))
}
})
}
return returnValue
}
};
$.Widget=function(){
};
$.Widget._childConstructors=[];
$.Widget.prototype={
widgetName:'widget',
widgetEventPrefix:'',
defaultElement:'<div>',
options:{
disabled:false,
create:null
},
_createWidget:function(options,element){
element=$(element||this.defaultElement||this)[0];
this.element=$(element);
this.uuid=widget_uuid++;
this.eventNamespace='.'+this.widgetName+this.uuid;
this.bindings=$();
this.hoverable=$();
this.focusable=$();
if(element!==this){
$.data(element,this.widgetFullName,this);
this._on(true,this.element,{
remove:function(event){
if(event.target===element){
this.destroy()
}
}
});
this.document=$(element.style?element.ownerDocument:element.document||element);
this.window=$(this.document[0].defaultView||this.document[0].parentWindow)
}
this.options=$.widget.extend({},this.options,this._getCreateOptions(),options);
this._create();
this._trigger('create',null,this._getCreateEventData());
this._init()
},
_getCreateOptions:$.noop,
_getCreateEventData:$.noop,
_create:$.noop,
_init:$.noop,
destroy:function(){
this._destroy();
this.element.unbind(this.eventNamespace).removeData(this.widgetFullName).removeData($.camelCase(this.widgetFullName));
this.widget().unbind(this.eventNamespace).removeAttr('aria-disabled').removeClass(this.widgetFullName+'-disabled '+'ui-state-disabled');
this.bindings.unbind(this.eventNamespace);
this.hoverable.removeClass('ui-state-hover');
this.focusable.removeClass('ui-state-focus')
},
_destroy:$.noop,
widget:function(){
return this.element
},
option:function(key,value){
var options=key,parts,curOption,i;
if(arguments.length===0){
return $.widget.extend({},this.options)
}
if(typeof key==='string'){
options={};
parts=key.split('.');
key=parts.shift();
if(parts.length){
curOption=options[key]=$.widget.extend({},this.options[key]);
for(i=0;i<parts.length-1;i++){
curOption[parts[i]]=curOption[parts[i]]||{};
curOption=curOption[parts[i]]
}
key=parts.pop();
if(arguments.length===1){
return curOption[key]===undefined?null:curOption[key]
}
curOption[key]=value
}else{
if(arguments.length===1){
return this.options[key]===undefined?null:this.options[key]
}
options[key]=value
}
}
this._setOptions(options);
return this
},
_setOptions:function(options){
var key;
for(key in options){
this._setOption(key,options[key])
}
return this
},
_setOption:function(key,value){
this.options[key]=value;
if(key==='disabled'){
this.widget().toggleClass(this.widgetFullName+'-disabled',!!value);
if(value){
this.hoverable.removeClass('ui-state-hover');
this.focusable.removeClass('ui-state-focus')
}
}
return this
},
enable:function(){
return this._setOptions({disabled:false})
},
disable:function(){
return this._setOptions({disabled:true})
},
_on:function(suppressDisabledCheck,element,handlers){
var delegateElement,instance=this;
if(typeof suppressDisabledCheck!=='boolean'){
handlers=element;
element=suppressDisabledCheck;
suppressDisabledCheck=false
}
if(!handlers){
handlers=element;
element=this.element;
delegateElement=this.widget()
}else{
element=delegateElement=$(element);
this.bindings=this.bindings.add(element)
}
$.each(handlers,function(event,handler){
function handlerProxy(){
if(!suppressDisabledCheck&&(instance.options.disabled===true||$(this).hasClass('ui-state-disabled'))){
return
}
return(typeof handler==='string'?instance[handler]:handler).apply(instance,arguments)
}
if(typeof handler!=='string'){
handlerProxy.guid=handler.guid=handler.guid||handlerProxy.guid||$.guid++
}
var match=event.match(/^([\w:-]*)\s*(.*)$/),eventName=match[1]+instance.eventNamespace,selector=match[2];
if(selector){
delegateElement.delegate(selector,eventName,handlerProxy)
}else{
element.bind(eventName,handlerProxy)
}
})
},
_off:function(element,eventName){
eventName=(eventName||'').split(' ').join(this.eventNamespace+' ')+this.eventNamespace;
element.unbind(eventName).undelegate(eventName);
this.bindings=$(this.bindings.not(element).get());
this.focusable=$(this.focusable.not(element).get());
this.hoverable=$(this.hoverable.not(element).get())
},
_delay:function(handler,delay){
function handlerProxy(){
return(typeof handler==='string'?instance[handler]:handler).apply(instance,arguments)
}
var instance=this;
return setTimeout(handlerProxy,delay||0)
},
_hoverable:function(element){
this.hoverable=this.hoverable.add(element);
this._on(element,{
mouseenter:function(event){
$(event.currentTarget).addClass('ui-state-hover')
},
mouseleave:function(event){
$(event.currentTarget).removeClass('ui-state-hover')
}
})
},
_focusable:function(element){
this.focusable=this.focusable.add(element);
this._on(element,{
focusin:function(event){
$(event.currentTarget).addClass('ui-state-focus')
},
focusout:function(event){
$(event.currentTarget).removeClass('ui-state-focus')
}
})
},
_trigger:function(type,event,data){
var prop,orig,callback=this.options[type];
data=data||{};
event=$.Event(event);
event.type=(type===this.widgetEventPrefix?type:this.widgetEventPrefix+type).toLowerCase();
event.target=this.element[0];
orig=event.originalEvent;
if(orig){
for(prop in orig){
if(!(prop in event)){
event[prop]=orig[prop]
}
}
}
this.element.trigger(event,data);
return!($.isFunction(callback)&&callback.apply(this.element[0],[event].concat(data))===false||event.isDefaultPrevented())
}
};
$.each({
show:'fadeIn',
hide:'fadeOut'
},function(method,defaultEffect){
$.Widget.prototype['_'+method]=function(element,options,callback){
if(typeof options==='string'){
options={effect:options}
}
var hasOptions,effectName=!options?method:options===true||typeof options==='number'?defaultEffect:options.effect||defaultEffect;
options=options||{};
if(typeof options==='number'){
options={duration:options}
}
hasOptions=!$.isEmptyObject(options);
options.complete=callback;
if(options.delay){
element.delay(options.delay)
}
if(hasOptions&&$.effects&&$.effects.effect[effectName]){
element[method](options)
}else if(effectName!==method&&element[effectName]){
element[effectName](options.duration,options.easing,callback)
}else{
element.queue(function(next){
$(this)[method]();
if(callback){
callback.call(element[0])
}
next()
})
}
}
});
var widget=$.widget
}));
/*!
 * jQuery UI Widget-factory plugin boilerplate (for 1.8/9+)
 * Author: @addyosmani
 * Further changes: @peolanha
 * Licensed under the MIT license
 */
(function($,window,document,undefined){
var ellipsis=function(str,limit){
return str.length<=limit?str:str.substring(0,limit-3)+'...'
};
var addCategoryIfNotPresent=function(data){
if(data[0]&&data[0].categoryId){
return data
}
return[{
categoryId:null,
items:data
}]
};
$.widget('oneweb.imageGrid',{
arrData:[],
options:{
someValue:null,
multiSelect:false,
showCheckBoxes:false,
buttons:[],
toggleItemSelectionCB:function(){
},
hideImagePreview:function(){
}
},
initialize:function(){
this.arrSelected=[];
this.options.buttons.forEach(function(btn,index){
btn.renderHtml='<div class="'+(btn.cls||'')+(btn.showOnItemHover?' show-on-item-hover':'')+(btn.selectItemOnClick?' select-item-on-click':'')+'">'+(btn.html||'')+'</div>'
})
},
clearAllSelections:function(){
this.arrSelected.splice(0,this.arrSelected.length);
this.element.find('.image-grid-item.selected').removeClass('selected')
},
selectFirstItem:function(){
this.clearAllSelections();
var item=this.element.find('.image-grid-item :eq(0)');
this.toggleItemSelection(item);
var el=item.closest('.image-grid');
if(el){
el.scrollTop(0)
}
},
toggleItemSelection:function($item,selectionOnly){
var arrSelected=this.arrSelected,foundAt,isFound=arrSelected.some(function(item,i){
foundAt=i;
return item.get(0)===$item.get(0)
});
if(!isFound){
if(!this.options.multiSelect){
this.clearAllSelections()
}
arrSelected.push($item);
$item.addClass('selected')
}else{
if(!selectionOnly){
arrSelected.splice(foundAt,1);
$item.removeClass('selected')
}
}
this.options.toggleItemSelectionCB(arrSelected.length>0)
},
_create:function(){
this.initialize()
},
destroy:function(){
$.Widget.prototype.destroy.call(this)
},
noImagesFound:function(msg){
this.clear();
this.element.html('<div class="x-grid-empty bigstock-no-images-found">'+msg+'</div>')
},
loadImages:function(data){
var $el=this.element;
var that=this;
data=addCategoryIfNotPresent(data);
var prevCategoryId=null;
data.forEach(function(category){
var categoryId=category.categoryId;
category.items.forEach(function(item){
var imageId=item.imageId;
var categoryEl;
that.arrData[item.imageId]=item;
if(prevCategoryId!==categoryId){
categoryEl=$('<div id="category_'+categoryId+'" class="image-grid-category"></div>');
$el.append(categoryEl);
prevCategoryId=categoryId;
if(item.categoryName){
categoryEl.append('<div class="category-label">'+item.categoryName+'</div>')
}
}else{
categoryEl=$('#category_'+categoryId)
}
var $imageGridItem=$('<div class="image-grid-item" data-imageid="'+item.imageId+'"></div>');
if(categoryEl.length){
categoryEl.append($imageGridItem)
}else{
$el.append($imageGridItem)
}
$imageGridItem.append($('<div class="bigstock-default-bgimage image-wrapper" data-original="'+item.imageUrl+'" data-original-fallback="'+item.imageUrl2+'"></div>')).append($('<div class="overlay show-on-item-hover"></div>'));
if(!item.hidePreviewBtn){
that.options.buttons.forEach(function(button,index){
var $button=$(button.renderHtml),btnCls=button.cls.split(' ');
if(btnCls.indexOf('btn-delete')>-1){
if(item.hasOwnProperty('showDeleteBtn')&&item.showDeleteBtn){
$imageGridItem.append($button);
if($button.handler){
$button.on('click',function(evt){
button.handler(evt)
})
}
}
}else{
$imageGridItem.append($button)
}
if(btnCls.indexOf('btn-buy')>-1&&button.handler){
$button.on('click',function(evt){
if(button.selectItemOnClick){
that.toggleItemSelection($(this).parents('.image-grid-item'),true)
}
button.handler(evt)
})
}else if(btnCls.indexOf('btn-preview')>-1){
$button.on('mouseenter',function(evt){
that.options.showImagePreview(evt,that.arrData[imageId])
}).on('mouseleave',function(evt){
that.options.hideImagePreview()
})
}
})
}
$imageGridItem.append($('<div class="image-title show-on-item-hover" title="'+item.imageTitle+'">'+ellipsis(item.imageTitle.split('\n').join('<br />'),50)+'</div>'));
$imageGridItem.on('click',function(evt,target){
var selectionOnly=false;
if($(evt.target||evt.srcElement).hasClass('select-item-on-click')){
selectionOnly=true
}
that.toggleItemSelection($imageGridItem,selectionOnly)
}).on('dblclick',function(evt){
that.toggleItemSelection($imageGridItem,true);
$(this).children('.btn-buy').trigger('click')
}).on('mouseenter',function(){
that.options.hideImagePreview(true)
})
})
})
},
getSelectedImageData:function(){
var data=this.arrData[this.element.find('.image-grid-item.selected').attr('data-imageid')];
return data?data:{}
},
clear:function(){
this.element.html('')
},
_setOption:function(key,value){
switch(key){
case'someValue':
break;
default:
break
}
$.Widget.prototype._setOption.apply(this,arguments)
}
})
}(oneJQuery,window,document));
web.ui.BigstockPanel=Ext.extend(Ext.Container,{
xtype:'web-bigstockpanel',
constructor:function(config){
this.app=config.app;
this.html='<div class="bigstock-panel"></div>';
this.height=config.height;
this.purchaseHandler=config.purchaseHandler;
this.bigstockApiUrl=window.location.protocol+'//api.bigstockphoto.com/2/'+'156139';
this.loadingHtml=oneJQuery('<div id="bigstockLoadingImage" class="animated-loading-dots"><div></div></div>');
this.maxPages=2;
this.emptyText='No results found for';
this.fetchImagesJsonpRequest=false;
this.timeoutId=null;
this.currentPage=1;
this.resultsPerPage=30;
this.windowPopulated=true;
web.ui.BigstockPanel.superclass.constructor.call(this,config)
},
initComponent:function(){
this.listeners={
afterlayout:function(){
if(!this.windowPopulated){
this.clearAndUpdateSearchResults();
this.populateCategoryList()
}
},
afterrender:function(){
this.renderBigstockPanel();
this.enableInfiniteScroll()
},
scope:this
};
web.ui.BigstockPanel.superclass.initComponent.apply(this,arguments)
},
getSelectedImageData:function(){
var selectedImageData=this.$grid.imageGrid('getSelectedImageData');
return selectedImageData
},
enableInfiniteScroll:function(){
var that=this;
that.$grid.on('scroll',function(evt){
that.$imagePreview.hide()
});
oneJQuery.infiniteScroll({
container:that.$grid,
callback:function(){
that.updateSearchResults({
resultsPerPage:that.resultsPerPage,
currentPage:that.currentPage
})
}
})
},
enableLazyLoadingOfImages:function(){
var that=this;
oneJQuery(that.$grid).on('unsuccessful.lazy','div.image-wrapper',function(e){
var target=oneJQuery(e.target),original=target.attr('data-original'),fallbackUrl=target.attr('data-original-fallback');
if(original!==fallbackUrl){
target.attr('data-original',fallbackUrl);
target.trigger('appear')
}
}).find('div.image-wrapper').lazyload({container:that.$grid})
},
getBigstockSearchQueryUrl:function(options){
var that=this,val=web.utils.String.stripTags(this.$txtSearch.val()),queryUrl=that.bigstockApiUrl+'/search/?q='+encodeURIComponent(val);
if(this.$selectCategory.val()){
queryUrl+='&category='+this.$selectCategory.val()
}
queryUrl+='&limit='+options.resultsPerPage+'&page='+options.currentPage;
var orientation='&orientation=';
if(that.$landscape.hasClass('active')){
queryUrl+=orientation+'h'
}else if(that.$portrait.hasClass('active')){
queryUrl+=orientation+'v'
}
queryUrl+='&vectors=n';
queryUrl+='&thumb_size=large_thumb';
queryUrl+='&response_detail=all';
queryUrl+='&language='+(one.locale.id==='en_us'||one.locale.id==='en_gb'?'en':one.locale.id||'en');
return queryUrl
},
updateSearchResults:function(options,callback){
var that=this,noImagesFoundMsg=that.emptyText,tmp=[],val=web.utils.String.stripTags(that.$txtSearch.val());
if(that.currentPage>that.maxPages||that.fetchImagesJsonpRequest){
if(that.currentPage>that.maxPages){
that.loadingHtml.remove()
}
return
}
if(web.utils.String.trimAllExtraWhitespaces(val).length>0){
noImagesFoundMsg+=' "'+web.utils.String.trimAllExtraWhitespaces(val)+'".'
}else{
tmp=noImagesFoundMsg.split(' ');
tmp.pop();
noImagesFoundMsg=tmp.join(' ')
}
that.lastSearchedValue=val;
that.fetchImagesJsonpRequest=that.app.dal.jsonp({
url:this.getBigstockSearchQueryUrl({
resultsPerPage:options.resultsPerPage,
currentPage:options.currentPage
}),
error:function(xOptions,textStatus){
if(that.$grid.find('.image-grid-item').length===0){
that.$grid.imageGrid('noImagesFound',[noImagesFoundMsg])
}
},
success:function(response,textStatus,xOptions){
that.fetchImagesJsonpRequest=null;
var data=response.data;
if(data.images){
if(data.images.length){
that.maxPages=data.paging.total_pages;
var arrImages=[];
data.images.forEach(function(item,index){
if(item.id>0){
var bestFormat;
oneJQuery.each(item.formats,function(index,format){
var pixelCount=this.width*this.height;
if(pixelCount<=web.Constants.imageScaleMaxPixels){
if(!bestFormat){
bestFormat=format
}else if(pixelCount>bestFormat.width*bestFormat.height){
bestFormat=format
}
}
});
if(bestFormat){
arrImages.push({
imageId:item.id,
imageUrl:item.large_thumb.url,
imageUrl2:item.large_thumb.url.replace('/small3/','/small2/'),
imageTitle:''+(item.title||item.description||item.id),
imageDescription:''+(item.description||item.title||item.id),
preview:item.preview,
format:bestFormat
})
}
}
});
that.loadingHtml.remove();
that.$grid.imageGrid('loadImages',arrImages);
that.currentPage+=1;
if(that.currentPage<that.maxPages){
that.$grid.append(that.loadingHtml);
if(arrImages.length<5){
that.updateSearchResults({
resultsPerPage:that.resultsPerPage,
currentPage:that.currentPage
})
}
}
that.enableLazyLoadingOfImages()
}else{
that.$grid.imageGrid('noImagesFound',[noImagesFoundMsg])
}
}else{
that.$grid.imageGrid('noImagesFound',[noImagesFoundMsg])
}
if(callback&&'function'===typeof callback){
callback.apply(that)
}
}
})
},
clearSearchResults:function(){
this.$grid.imageGrid('clear')
},
clearAndUpdateSearchResults:function(){
var that=this;
if(this.fetchImagesJsonpRequest){
this.fetchImagesJsonpRequest.abort();
this.fetchImagesJsonpRequest=null
}
that.ownerWindow.toggleBuyImgBtnStatus(false);
that.currentPage=1;
that.clearSearchResults();
that.$grid.append(that.loadingHtml);
that.updateSearchResults({
resultsPerPage:that.resultsPerPage,
currentPage:that.currentPage
},function(){
oneJQuery(that.$grid.find('.image-grid-item:first'))[0].scrollIntoView()
})
},
renderBigstockPanel:function(){
var that=this;
var $=oneJQuery;
var $bigstockPanel=$(this.el.dom).find('.bigstock-panel');
var $divTop=$('<div class="bigstock-panel-top"></div>');
$bigstockPanel.append($divTop);
var $divLeft=$('<div class="bigstock-panel-left">'+'Find and purchase the perfect image for your site, 1 at a time.'+'</div>');
$divTop.append($divLeft);
var $divRight=$('<div class="bigstock-panel-right"></div>');
$divTop.append($divRight);
$divRight.append('<div class="bigstock-category">'+'<select data-placeholder="'+'Loading...'+'" class="bigstock-category-select">'+'</select>'+'</div>');
$divRight.find('select').chosen({
width:'180px',
disable_search:true,
allow_single_deselect:true
});
$divRight.append('<div class="bigstock-search">'+'<input type="button" class="bigstock-search-button" />'+'<input type="text" class="bigstock-search-text" placeholder="'+'Search keyword'+'" />'+'</div>');
$divRight.append('<div class="bigstock-orientation">'+'<input type="button" class="landscape" title="'+'Show landscape images in search results'+'" />'+'<input type="button" class="portrait" title="'+'Show portrait images in search results'+'" />'+'</div>');
var $grid=this.$grid=$('<div class="image-grid"></div>');
$bigstockPanel.append($grid);
$grid.imageGrid({
buttons:[
{
cls:'btn-buy',
showOnItemHover:true,
selectItemOnClick:true,
html:'Buy',
handler:function(evt){
that.purchaseHandler(that.getSelectedImageData())
}
},
{
cls:'btn-preview',
showOnItemHover:true,
selectItemOnClick:true
}
],
toggleItemSelectionCB:function(itemSelected){
that.ownerWindow.toggleBuyImgBtnStatus(itemSelected)
},
hideImagePreview:function(imageId){
that.$imagePreview.hide()
},
showImagePreview:function(evt,arrImageData){
var windowHeight=$(window).height(),windowWidth=$(window).width(),imageTitleHtml=$('<div class="bigstock-image-preview"></div>'),imageResHtml=$('<div class="bigstock-image-preview"></div>');
var previewUrl=arrImageData.preview.url||'',previewHeight=arrImageData.preview.height||0,previewWidth=arrImageData.preview.width||0,previewTitle=Ext.util.Format.ellipsis(arrImageData.imageTitle||'',Math.floor(previewWidth/10),false),previewLeft=evt.clientX>Math.ceil(windowWidth/2)?evt.clientX-(previewWidth+30):evt.clientX+15,previewTop=evt.clientY>Math.ceil(windowHeight/2)?evt.clientY-(previewHeight+30):evt.clientY+15,maxHeight,maxWidth;
if(previewTop+previewHeight>=windowHeight){
previewTop=previewTop-(previewTop+previewHeight-windowHeight);
previewTop-=50
}
previewTop=previewTop<0?0:previewTop;
if(previewUrl.length&&previewHeight&&previewWidth){
that.$imagePreview.css({
'left':previewLeft+'px',
'top':previewTop+'px',
'height':previewHeight+'px',
'width':previewWidth+'px',
'background-image':'url('+previewUrl+')'
}).html(imageTitleHtml.css({
'text-align':'left',
'left':previewLeft+'px',
'top':previewTop+previewHeight+5+'px',
'width':Math.floor(previewWidth*0.7)+'px',
'height':'12px',
'padding-bottom':'5px'
}).html(previewTitle)).append(imageResHtml.css({
'text-align':'right',
'left':previewLeft+Math.ceil(previewWidth*0.7)+'px',
'top':previewTop+previewHeight+5+'px',
'width':Math.ceil(previewWidth*0.3)+'px',
'height':'12px',
'padding-bottom':'5px'
})).show();
maxHeight=arrImageData.format.height;
maxWidth=arrImageData.format.width;
if(maxHeight&&maxWidth){
imageResHtml.html(maxWidth+'x'+maxHeight+'px')
}
}
}
});
this.$imagePreview=$('<div class="bigstock-image-preview"></div>').hide();
$('body').append(this.$imagePreview);
var $selectCategory=this.$selectCategory=$bigstockPanel.find('.bigstock-category-select'),$btnSearch=this.$btnSearch=$bigstockPanel.find('.bigstock-search-button'),$txtSearch=this.$txtSearch=$bigstockPanel.find('.bigstock-search-text'),$landscape=this.$landscape=$bigstockPanel.find('.landscape'),$portrait=this.$portrait=$bigstockPanel.find('.portrait');
$selectCategory.change(function(){
that.clearAndUpdateSearchResults();
that.app.track([
'Bigstock',
'category.selected',
that.$selectCategory.find('option:selected').text()
])
});
that.lastSearchedValue='';
$txtSearch.on('change keyup paste mouseup',function(e){
if(this.fetchImagesJsonpRequest){
this.fetchImagesJsonpRequest.abort();
this.fetchImagesJsonpRequest=null
}
if(e.which===13){
window.clearTimeout(this.timeoutId);
that.clearAndUpdateSearchResults();
that.app.track([
'Bigstock',
'search(enter)',
that.$txtSearch.val()
])
}else{
var trimAllExtraWhitespaces=web.utils.String.trimAllExtraWhitespaces;
window.clearTimeout(this.timeoutId);
this.timeoutId=window.setTimeout(function(){
if(trimAllExtraWhitespaces($txtSearch.val())!==trimAllExtraWhitespaces(that.lastSearchedValue)){
that.clearAndUpdateSearchResults();
that.app.track([
'Bigstock',
'search(auto)',
that.$txtSearch.val()
])
}
},750)
}
});
$btnSearch.on('click',function(){
that.clearAndUpdateSearchResults();
that.app.track([
'Bigstock',
'search(button)',
that.$txtSearch.val()
])
});
var $landscapeAndPortrait=$landscape.add($portrait);
$landscapeAndPortrait.on('click',function(){
if($(this).hasClass('active')){
$(this).removeClass('active')
}else{
$landscapeAndPortrait.removeClass('active');
$(this).addClass('active')
}
that.clearAndUpdateSearchResults();
that.app.track([
'Bigstock',
'orientation.changed',
$(this).attr('class')
])
});
this.clearAndUpdateSearchResults();
this.populateCategoryList()
},
populateCategoryList:function(){
var that=this;
that.app.dal.jsonp({
url:that.bigstockApiUrl+'/categories/?language='+(one.locale.id==='en_us'||one.locale.id==='en_gb'?'en':one.locale.id||'en'),
error:function(xOptions,textStatus){
that.windowPopulated=false
},
success:function(response){
var data=response.data;
data.unshift({
'id':0,
'name':'All categories'
});
that.$selectCategory.html(function(){
var arrCategories=data;
var arrOptions=[];
arrCategories.forEach(function(item){
arrOptions.push('<option value="'+item.id+'">'+item.name+'</option>')
});
return arrOptions.join('')
}());
that.$selectCategory.attr('data-placeholder','All categories').trigger('chosen:updated');
that.windowPopulated=true
}
})
}
});
Ext.reg(web.ui.BigstockPanel.prototype.xtype,web.ui.BigstockPanel);
web.windows.BigstockImages=Ext.extend(web.windows.Window,{
initComponent:function(){
this.type='web.windows.BigstockImages';
this.width=900;
this.modal=true;
this.resizable=false;
this.cls='add-bigstock-images-window web-window-notitle';
var that=this;
this.bodyCssClass='vbox';
this.items=[
{
xtype:'container',
cls:'tab-h1 hbox cross-center',
html:'Add Bigstock Images'
},
{
app:this.app,
xtype:'web-bigstockpanel',
cls:'web-bigstockpanel flex',
ref:'bigstockpanel',
ownerWindow:this,
purchaseHandler:function(dataSelectedImage){
that.initPurchase(dataSelectedImage)
}
},
{
xtype:'container',
cls:'web-window-footer hbox cross-center',
items:[
{
xtype:'spacer',
cls:'flex'
},
{
xtype:'button',
cls:'x-btn-secondary large wide',
text:'Cancel',
listeners:{
click:function(){
this.onCancel()
},
scope:this
}
},
{
xtype:'spacer',
width:14
},
{
xtype:'button',
cls:'x-btn-primary large wide',
text:'Buy Image',
ref:'../buyImageButton',
disabled:true,
listeners:{
scope:this,
click:function(){
var dataSelectedImage=this.bigstockpanel.getSelectedImageData();
this.initPurchase(dataSelectedImage)
}
}
}
]
}
];
var dal=this.app.dal;
var purchaseComplete=function(event){
if(event.origin!==web.utils.Dom.getWindowOrigin(window)){
return
}
var data=event.data;
if(data.purpose!=='bigstock'){
return
}
if(data.status===200){
dal.getWebspaceFileMetadata(data.imagePath,function(opts,success,response){
if(success&&response.responseText){
that.fireEvent('ok',{
bigstockWindow:that,
assetConfig:Ext.applyIf({url:'webspace:'+data.imagePath},Ext.decode(response.responseText))
})
}else{
one.fatal('Bigstock: Image metadata not available for downloaded file.')
}
});
that.app.track([
'Bigstock',
'purchase.complete',
data.imageName
])
}else{
one.fatal('Unexpected status for Bigstock image purchase: ',data);
that.app.track([
'Bigstock',
'purchase.unexpectedStatus',
data.status
])
}
};
window.addEventListener('message',purchaseComplete,false);
web.windows.BigstockImages.superclass.initComponent.apply(this,arguments)
},
initPurchase:function(dataImageToPurchase){
var location,origin,domain,basePath;
location=window.location;
origin=location.origin||location.protocol+'//'+location.hostname+(location.port?':'+location.port:'');
domain=this.app.dal.domain;
basePath=origin+'/api/v1/'+domain+'/bigstock/';
var encode=encodeURIComponent;
var imageName=encode(dataImageToPurchase.imageTitle.substring(0,50).trim());
window.open(basePath+'initiatePurchase'+'?imageId='+encode(dataImageToPurchase.imageId)+'&imageName='+imageName+'&imageSize='+encode(dataImageToPurchase.format.size_code)+'&successUrl='+basePath+'complete'+'&_'+new Date().getTime(),'Buy Image','height=675,width=950,scrollbars=yes,resizable=yes',true).focus();
this.app.track([
'Bigstock',
'purchase.init',
dataImageToPurchase.imageTitle
])
},
setValues:function(obj){
this.openedFromWindow=obj.openedFromWindow
},
show:function(){
web.windows.BigstockImages.superclass.show.apply(this,arguments);
oneJQuery(this.el.dom).find('.bigstock-search-text').focus().select();
this.app.track([
'Bigstock',
'window.open'
])
},
hide:function(win){
web.windows.BigstockImages.superclass.hide.apply(this,arguments);
this.app.track([
'Bigstock',
'window.close'
])
},
toggleBuyImgBtnStatus:function(itemSelected){
if(itemSelected){
this.buyImageButton.enable()
}else{
this.buyImageButton.disable()
}
},
onCancel:function(){
this.hide();
var openedFromWindow=this.openedFromWindow;
if(openedFromWindow){
openedFromWindow.show()
}
}
});
web.ui.CoreFile=Ext.extend(Ext.Container,{
xtype:'web-container-corefile',
type:'web.ui.CoreFile',
cls:'web-container-corefile',
allowOnlyImage:false,
hasGridView:false,
multiSelect:false,
showImagePreviewPanel:true,
fileUploadCtrl:null,
strings:{noFileSelected:'No image selected'},
constructor:function(config){
this.initialPath=null;
this.fileUploadCtrl=new web.ui.FileUploadCtrl({coreFile:this});
web.ui.CoreFile.superclass.constructor.call(this,config)
},
initComponent:function(){
var app=this.app,multipleFileUpload=web.utils.FeatureSupport.multipleFileInput,that=this;
var imagePreviewPanelWidth=260,modalWidth=that.width,modalHeight=that.height;
this.selectedFile=null;
this.layout='form';
this.titleTextLabel=Ext.create({
xtype:'container',
cls:'tab-h1',
html:this.title||'File list'
});
this.uploadFilesButton=Ext.create({
xtype:'button',
layout:'hbox',
cls:'one-btn-upload-files',
text:'Upload file',
tooltip:'Upload multiple files from your computer or a URL',
menu:{
cls:'file-upload-menu',
items:[
{
ref:'../upload',
xtype:'one-fileinputbutton',
name:'body',
text:'From computer',
multiple:multipleFileUpload,
listeners:{
fileselected:function(el){
this.uploadFilesButton.menu.hide();
this.fileUploadCtrl.uploadFromComputer({
inputField:el,
files:this.fileChooser.getCurrentFileList(),
path:this.fileChooser.getCurrentPath(),
app:this.app
})
},
scope:this
}
},
{
xtype:'button',
text:'From external URL',
handler:function(){
this.uploadFilesButton.menu.hide();
this.app.windows.show({
type:'web.windows.FileUploader',
values:{
files:this.fileChooser.getCurrentFileList(),
path:this.fileChooser.getCurrentPath(),
uploadSource:'URL',
parentComponent:this
},
okFn:function(url){
this.fileUploadCtrl.uploadFromUrl({
url:url,
files:this.fileChooser.getCurrentFileList(),
path:this.fileChooser.getCurrentPath(),
app:this.app
})
},
scope:this
})
},
scope:this
}
]
},
menuAlign:'tr-br',
listeners:{
menushow:function(button,menu){
button.prevBorder=button.el.dom.style.borderBottom;
button.el.dom.style.borderBottom='none';
menu.prevBorder=menu.el.dom.style.borderTop;
menu.el.dom.style.borderTop='none';
menu.el.dom.style.top=menu.el.dom.style.top.replace(/px/,'')-2+'px';
if(!menu.el.query('.short-line').length){
var left=0,width=menu.getWidth()-button.getWidth();
if(width<0){
left=width;
width=-width
}
menu.el.insertHtml('afterBegin','<div class="short-line" style="position: absolute; border-top: 1px solid #ccc; left: '+left+'px; width: '+width+'px;"></div>')
}
},
menuhide:function(button,menu){
button.el.dom.style.borderBottom=button.prevBorder;
menu.el.dom.style.borderTop=menu.prevBorder
},
scope:this
}
});
this.breadcrumbs=Ext.create({
cls:'file-tbar-btn-group',
style:'padding-left: 30px;',
xtype:'web-ui-breadcrumbs',
region:'center',
coreFileOb:this
});
this.gotoFileManagerLinkOnTop=Ext.create({
xtype:'button',
layout:'hbox',
cls:'one-link-btn top-panel file-manager-link-top',
style:'text-decoration: underline',
text:'Go to File Manager',
tooltip:'Open One.com File Manager',
listeners:{
click:this.openFileManager,
scope:this
}
});
this.breadcrumbsAndLinkContainer=Ext.create({
xtype:'container',
layout:'border',
style:'background-color:transparent',
height:25,
items:[
this.breadcrumbs,
{
region:'east',
xtype:'container',
width:imagePreviewPanelWidth,
layout:'hbox',
items:function(that){
var items=[];
items.push({
xtype:'spacer',
flex:1
});
if(that.hasGridView){
items.push({
xtype:'container',
cls:'active-list-view',
items:[
{
xtype:'button',
cls:'list-view-icon icon',
height:11,
width:11,
tooltip:'List view',
handler:function(btn){
if(that.fileChooser===that.fileChooserGridView){
this.ownerCt.removeClass('active-grid-view').addClass('active-list-view');
that.fileChooserListView.selectedPaths=that.fileChooserGridView.selectedPaths;
that.fileChooser=that.fileChooserListView;
that.fileChooserCards.layout.setActiveItem(0);
var lastReadPath=that.fileChooserGridView.lastReadPath;
that.fileChooser.readPath(lastReadPath)
}
}
},
{
xtype:'button',
cls:'grid-view-icon icon',
height:11,
width:11,
tooltip:'Grid view',
handler:function(btn){
if(that.fileChooser===that.fileChooserListView){
this.ownerCt.removeClass('active-list-view').addClass('active-grid-view');
that.fileChooserGridView.selectedPaths=that.fileChooserListView.selectedPaths;
that.fileChooser=that.fileChooserGridView;
that.fileChooserCards.layout.setActiveItem(1);
var lastReadPath=that.fileChooserListView.lastReadPath;
that.fileChooser.readPath(lastReadPath)
}
}
}
]
})
}
items.push(that.gotoFileManagerLinkOnTop);
items.push(Ext.create({
xtype:'spacer',
width:10
}));
return items
}(this)
}
]
});
this.bigstockImagesButton=Ext.create({
xtype:'button',
layout:'hbox',
cls:'one-btn-bigstock-images',
text:'Get Bigstock images',
tooltip:'Choose from over 25 million Bigstock images',
listeners:{
scope:this,
click:function(){
var win=this.getContainerWindow();
win.hide();
this.app.windows.show({
type:'web.windows.BigstockImages',
values:{openedFromWindow:win},
scope:this,
okFn:function(msg){
var bigstockWindow=msg.bigstockWindow,assetConfig=msg.assetConfig;
var that=this;
var showAndSelectFileInFileChooser=function(assetConfig){
var url=assetConfig.url.replace(/^webspace:/,'');
that.fileChooser.getSelectedPaths().push({file:url});
that.fileChooser.showPath(url)
};
if(bigstockWindow.isVisible()){
if(win.multiSelect){
bigstockWindow.hide();
win.show();
showAndSelectFileInFileChooser(assetConfig)
}else{
that.fireEvent('fileuploaded',assetConfig);
bigstockWindow.hide()
}
}else{
if(win.isVisible()){
showAndSelectFileInFileChooser(assetConfig)
}
}
}
})
}
}
});
this.imagePreview={
cls:'preview-pane',
ref:'../../../../../imagePreview',
xtype:'container',
displayImage:function(encodedPath,etag,contentType,isUploading){
if(contentType&&contentType.match(/image\/(?:gif|png|jpg|jpeg|x-icon|vnd\.microsoft\.icon)/)){
var el=this.el,encoded=encodedPath+'?etag='+window.escape(etag),msg;
if(contentType==='image/vnd.microsoft.icon'){
encoded+='&gm&png'
}
msg='Image is corrupt';
if(isUploading){
msg='Uploading image...'
}
Ext.fly(el).removeClass('warning-message');
el.update('<img'+' style="height:auto; width:auto; max-height:calc(100% - 20px); max-width:calc(100% - 20px);"'+' src="'+encoded+'"'+' onerror="Ext.fly(this).parent().addClass(\'warning-message\')"'+' />'+'<span class="warning-message">'+msg+'</span>')
}else{
this.clear()
}
},
clear:function(){
var el=this.el;
if(el){
el.update('<table style="width:100%;height:100%"><tbody><tr><td>'+'<span class="no-image-selected">'+that.strings.noFileSelected+'</span>'+'</td></tr></tbody></table>')
}
}
};
var fileChooserConfig={
app:app,
breadcrumbs:this.breadcrumbs,
contentTypeFilter:this.contentTypeFilter,
fileExtensionFilter:this.fileExtensionFilter,
multiSelect:this.multiSelect,
listeners:{
fileselected:function(cfg){
if(this.showImagePreviewPanel){
this.imagePreview.displayImage(app.dal.getWebspacePath(cfg.path),cfg.etag,cfg.contentType,cfg.isUploading)
}
this.fireEvent('fileselected',cfg.path)
},
filedeselected:function(){
this.fireEvent('filedeselected')
},
fileconfirmed:function(grid,path){
this.fireEvent('fileconfirmed',path)
},
directoryselected:function(grid,path){
if(this.showImagePreviewPanel){
this.imagePreview.clear()
}
this.fireEvent('directoryselected',path)
},
scope:this
}
};
var fileChooserGridViewConfig=oneJQuery.extend(true,{},fileChooserConfig);
fileChooserGridViewConfig.cls=(fileChooserGridViewConfig.cls||'')+' grid-view';
fileChooserGridViewConfig.listeners.fileselected=function(grid,path,etag,contentType){
this.fireEvent('fileselected',path)
};
fileChooserGridViewConfig.listeners.directoryselected=function(grid,path,etag,contentType){
this.fireEvent('directoryselected',path)
};
fileChooserGridViewConfig.viewType='grid-view';
this.fileChooserGridView=new web.ui.FileChooser(fileChooserGridViewConfig);
var fileChooserListViewConfig=oneJQuery.extend(true,{},fileChooserConfig);
fileChooserListViewConfig.cls=(fileChooserListViewConfig.cls||'')+' list-view';
fileChooserListViewConfig.viewType='list-view';
this.fileChooserListView=new web.ui.FileChooser(fileChooserListViewConfig);
this.fileChooser=this.fileChooserListView;
var gridWidth=this.showImagePreviewPanel?this.width-imagePreviewPanelWidth:this.width;
this.extraFileName=new Ext.form.TextField({
style:'margin-left: 30px;',
width:gridWidth-60,
hidden:true
});
this.extraFileNameLabel=new Ext.form.Label({
cls:'extra-filename',
text:'Link title:',
hidden:true
});
this.items=[
{
xtype:'container',
ref:'toolbarComp',
items:[{
layout:'hbox',
ref:'headerComp',
items:[
this.titleTextLabel,
{
xtype:'spacer',
flex:1
},
this.bigstockImagesButton,
{
xtype:'spacer',
width:14
},
this.uploadFilesButton,
{
xtype:'spacer',
width:30
}
]
}]
},
{
border:false,
layout:'hflex',
items:[{
xtype:'container',
layout:'vflex',
items:function(that){
var arrItems=[];
if(that.enableExtraFileName){
arrItems.push(that.extraFileNameLabel);
arrItems.push(that.extraFileName)
}
arrItems.push(that.breadcrumbsAndLinkContainer);
arrItems.push({
ref:'../../fileChooserCards',
xtype:'container',
layout:'card',
activeItem:0,
items:[
{
xtype:'container',
layout:'hbox',
items:function(){
var arrItems;
var fileChooser=that.fileChooserListView;
var fileChooserHeight=modalHeight?modalHeight:375;
var containerWindow=that.getContainerWindow();
if(containerWindow instanceof web.windows.SiteMapAddLink){
fileChooserHeight=fileChooserHeight-58
}else if(containerWindow instanceof web.windows.GoogleDocsViewer){
fileChooserHeight=fileChooserHeight-12
}
fileChooser.height=fileChooserHeight;
if(that.showImagePreviewPanel){
fileChooser.width=modalWidth-imagePreviewPanelWidth;
arrItems=[];
arrItems.push(fileChooser);
arrItems.push({
xtype:'container',
layout:'fit',
width:imagePreviewPanelWidth,
height:fileChooserHeight,
style:'border: 1px solid #eff1f0',
items:[that.imagePreview]
})
}else{
arrItems=[fileChooser]
}
return arrItems
}()
},
{
xtype:'container',
layout:'hbox',
items:function(){
var arrItems;
var fileChooser=that.fileChooserGridView;
var fileChooserHeight=373;
var containerWindow=that.getContainerWindow();
if(containerWindow instanceof web.windows.SiteMapAddLink){
fileChooserHeight=fileChooserHeight-58
}else if(containerWindow instanceof web.windows.GoogleDocsViewer){
fileChooserHeight=fileChooserHeight+2
}
fileChooser.height=fileChooserHeight;
var fileChooserWidth=that.width;
fileChooser.width=fileChooserWidth;
arrItems=[fileChooser];
return arrItems
}()
}
]
});
return arrItems
}(this)
}]
}
];
this.addEvents([
'directoryselected',
'fileconfirmed',
'filedeselected',
'fileselected',
'fileuploaded'
]);
this.bindEvents();
web.ui.CoreFile.superclass.initComponent.call(this)
},
bindEvents:function(){
this.on('fileuploaded',function(assetConfig){
this.uploadHandler([assetConfig]);
this.fileChooser.showPath(assetConfig.url.replace(/^webspace:/,''))
},this);
var index,total;
this.fileUploadCtrl.on('upload:allstart',function(uploadState){
index=0;
total=uploadState.totalFilesCount;
this.fileUploadStatus.show();
this.fileUploadStatus.setText(index+' of '+total+' uploaded')
},this);
this.fileUploadCtrl.on('validate:start',function(params){
var resp=this.fileChooser.showFileUploadProgress({
filename:encodeURIComponent(params.fileData.name),
path:this.fileChooser.currentPath+encodeURIComponent(params.fileData.name),
loaded:0,
size:params.fileData.size,
contentType:params.fileData.type
});
this.fileChooser.getView().focusRow(resp.index)
},this);
this.fileUploadCtrl.on('validate:complete',function(params){
if(!params.valid){
var name=params.fileData.name||params.fileData.split('/').pop();
this.fileChooser.removeFileUploadProgress({
filename:name,
path:this.fileChooser.currentPath+encodeURIComponent(params.fileData.name)
});
if(!params.fileData.name){
this.fileChooser.showPath(this.fileChooser.currentPath)
}
this.fileUploadStatus.hide()
}
},this);
this.fileUploadCtrl.on('upload:error',function(params){
this.fileChooser.removeFileUploadProgress(params.fileObject)
},this);
this.fileUploadCtrl.on('upload:progress',function(params){
this.fileChooser.showFileUploadProgress({
filename:params.filename,
path:this.fileChooser.currentPath+params.filename,
loaded:params.loaded,
size:params.total,
strict:params.strict
})
},this);
this.fileUploadCtrl.on('upload:complete',function(assetConfig){
var filename=assetConfig.url.replace(/^webspace:/,'').replace(/[^\/]*\//g,''),path=this.fileChooser.currentPath+filename,wspath=this.app.dal.getWebspacePath(path);
this.fileChooser.showFileUploadProgress({
filename:filename,
path:path,
loaded:assetConfig.filesize,
size:assetConfig.filesize,
contentType:assetConfig.contentType
});
index++;
this.fileUploadStatus.setText(index+' of '+total+' uploaded');
this.fileChooser.onAppearedHandler.call(this.fileChooser,wspath)
},this);
this.fileUploadCtrl.on('upload:allcomplete',function(assetConfigArray){
var that=this,item=assetConfigArray[0],etag=item.etag,filename=item.url.replace(/^webspace:/,''),arr,overflow=false;
if(!this.multiSelect){
this.fileChooser.setSelectedPaths([{
file:filename,
etag:etag
}])
}else{
arr=this.fileChooser.getSelectedPaths();
assetConfigArray.forEach(function(item){
if(arr.length<that.fileChooser.maxFiles){
arr.push({
file:item.url.replace(/^webspace:/,''),
etag:item.etag
})
}else{
overflow=true
}
});
if(overflow){
this.showLimitWarning(assetConfigArray.length>1)
}
}
this.fileChooser.showPath(filename);
this.fileUploadStatus.hide()
},this)
},
refreshFileChooser:function(paths){
var firstFile;
paths=paths||[];
paths=paths.map(function(item){
return{
file:item.replace(/^webspace:/,''),
etag:null
}
});
this.fileChooser.setSelectedPaths(paths);
firstFile=paths.length&&paths[0].file||'';
if(paths.length>0&&!/^repository\:/.test(firstFile)){
this.fileChooser.showPath(firstFile)
}else{
this.fileChooser.showDefaultPath()
}
},
getSelectedAssets:function(config){
var files=this.fileChooser.getSelectedPaths(),numFiles=files.length,progressComplete=function(){
waitWindow.hide();
config.onRequestComplete.call(config.scope||window,errorOccurred);
if(!errorOccurred){
assets=assets.filter(function(n){
return n!==undefined
});
config.onRequestSuccess.call(config.scope||window,assets)
}
},progress=web.utils.Function.impede(numFiles,progressComplete,this),waitWindow=Ext.Msg.wait('Fetching file information...','Please wait'),pixelLimit=web.data.components.resources.Image.DIMENSION_LIMIT,dal=this.app.dal,dm=this.app.dm,errorOccurred=null,assets=[],index=0;
if(files.length===0){
progressComplete()
}
files.forEach(function(file,fileIdx){
if(/^repository:/.test(file.file)){
index+=1;
waitWindow.updateProgress(index/numFiles);
progress()
}else{
dal.getWebspaceFileMetadata(file.file.replace(/^webspace:/,''),function(opts,success,response){
if(success&&response.responseText){
var data=Ext.decode(response.responseText),description,filePath=file&&file.file&&file.file.split('/'),filename=filePath&&filePath[filePath.length-1];
if(filename){
try{
filename=decodeURIComponent(filename)
}catch(e){
filename=unescape(filename)
}
}
if(/image\/(?:gif|png|jpg|jpeg|x-icon|vnd.microsoft.icon)/.test(data.contentType)){
if(data.width&&data.height&&data.width*data.height<pixelLimit||data.contentType.match(/image\/(x-icon|vnd.microsoft.icon)/)){
assets[fileIdx]=dm.create(Ext.applyIf({
url:'webspace:'+file.file,
type:'web.data.assets.Image'
},data))
}else if(data.filesize===0){
if(filename){
description='The image "'+filename+'" appears to be corrupted. Please choose another or upload the image again.'
}else{
description='The image you have chosen appears to be corrupted. Please choose another or upload the image again.'
}
errorOccurred={
error:'Corrupted Image',
description:description
}
}else{
if(filename){
description='The image "'+filename+'" is too large. Please add files smaller than 64 megapixels.'
}else{
description='The selected image is too large. Please add files smaller than 64 megapixels.'
}
errorOccurred={
error:'Invalid image size.',
description:description
}
}
}else{
assets[fileIdx]=dm.create(dm.create(Ext.applyIf({
url:'webspace:'+file.file,
type:'web.data.assets.Asset'
},data)))
}
}else{
errorOccurred={
error:'Unable to fetch file data.',
description:'<b>'+'Unable to fetch file data.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.'
}
}
index+=1;
waitWindow.updateProgress(index/numFiles);
progress()
},this,file.etag)
}
},this)
},
getContainerWindow:function(){
var ownerCt=this.ownerCt;
while(true){
if(ownerCt){
if(ownerCt instanceof web.windows.Window){
return ownerCt
}else{
ownerCt=ownerCt.ownerCt
}
}else{
return null
}
}
},
enableMultiSelect:function(multiSelect){
this.multiSelect=multiSelect===true;
this.fileChooserListView.enableMultiSelect(multiSelect);
this.fileChooserGridView.enableMultiSelect(multiSelect)
},
enableExtraFileName:function(show){
this.extraFileName.setVisible(show);
this.extraFileNameLabel.setVisible(show)
},
setContentTypeFilter:function(filter){
this.fileChooser.contentTypeFilter=filter
},
setAllowIcoFiles:function(allowIcoFiles){
this.allowIcoFiles=allowIcoFiles===true
},
openFileManager:function(){
var url='https://www.one.com/admin/webapp-login.do',authenticationData=one.boneAuth.parseCookieValue()||{},mailId=authenticationData.originallyAuthenticatedEmailAddress,domain=this.app.dal.domain,path=this.app.dal.encodeURI(this.breadcrumbs.getActivePath());
url+='?loginTarget='+'filemanager.one.com'+'&targetDomain='+domain;
if(mailId){
url+='&username='+mailId
}
url+='#'+domain+'/'+domain+'/files'+path;
window.open(url)
},
getUniqueFiles:function(oldPaths,newPaths){
var i,j,oldPathsCount=oldPaths.length,newPathsCount=newPaths.length;
for(i=0;i<oldPathsCount;i++){
for(j=0;j<newPathsCount;j++){
if(oldPaths[i].file===newPaths[j].file){
oldPaths.splice(i,1);
i--;
oldPathsCount--
}
}
}
},
uploadHandler:function(assetConfigs){
var paths=assetConfigs.map(function(item){
return{
file:item.url.replace(/^webspace:/,''),
etag:item.etag
}
}),arr,overflow=false,uploadedFilesCount=paths.length;
if(this.multiSelect){
arr=this.fileChooser.getSelectedPaths();
while(paths.length+arr.length>this.fileChooser.maxFiles&&paths.length>0){
paths.pop();
overflow=true
}
this.getUniqueFiles(arr,paths);
paths=paths.concat(arr);
if(overflow){
this.showLimitWarning(uploadedFilesCount>1)
}
}
this.fileChooser.setSelectedPaths(paths)
},
showLimitWarning:function(multipleFilesUploaded){
if(multipleFilesUploaded){
one.error(this.fileChooser.errorStrings.tooManyFilesMultipleSelect[0],this.fileChooser.errorStrings.tooManyFilesMultipleSelect[1])
}else{
one.error(this.fileChooser.errorStrings.tooManyFilesSingleSelect[0],this.fileChooser.errorStrings.tooManyFilesSingleSelect[1])
}
}
});
Ext.ComponentMgr.registerType('web-ui-corefile',web.ui.CoreFile);
web.windows.Image=Ext.extend(web.windows.Window,{
xtype:'web-windows-image',
type:'web.windows.Image',
cls:'web-windows-image web-window-notitle',
modal:true,
resizable:false,
multiSelect:false,
defaultContentTypeFilter:/^image\/(?:gif|png|jpg|jpeg)$/,
constructor:function(config){
web.windows.Image.superclass.constructor.call(this,config)
},
initComponent:function(){
this.insertImageButtonSingle='Save';
this.insertImageButtonMultiple='Save';
this.width=900;
this.fileUploadStatus=new Ext.form.Label({
cls:'hbox cross-center',
style:'padding-top: 5px; padding-bottom: 1px; margin-left: -10px;',
text:0+' of '+0+' uploaded'
});
this.items=[
{
xtype:'web-ui-corefile',
ref:'core',
app:this.app,
width:this.width,
fileUploadStatus:this.fileUploadStatus,
title:'Select from your images',
contentTypeFilter:this.defaultContentTypeFilter,
fileExtensionFilter:/\.(?:jpg|jpeg|png|gif)$/i,
allowOnlyImage:true,
hasGridView:true,
listeners:{
fileselected:function(encodedPath){
this.selectedFile=encodedPath;
this.insertImageButton.enable()
},
fileconfirmed:function(encodedPath){
this.selectedFile=encodedPath;
this.onSelectImage()
},
fileuploaded:function(asset){
if(!this.multiSelect){
this.fireEvent('ok',this,{images:[asset]});
this.hide()
}
},
directoryselected:function(path){
this.selectedFile=null;
this.insertImageButton.disable()
},
scope:this
}
},
{
xtype:'container',
cls:'web-window-footer hbox cross-center',
items:[
{
xtype:'container',
cls:'vbox flex',
items:[
{
xtype:'container',
cls:'hbox cross-center currently-selected',
style:'padding-bottom: 1px',
items:[
{
xtype:'label',
text:'Currently selected:',
style:'padding-right: 5px;'
},
{
xtype:'label',
html:'<div data-bind="FileChooser.numberOfFiles"></div>',
style:'display: table-cell'
}
]
},
this.fileUploadStatus
]
},
{
xtype:'button',
cls:'x-btn-secondary large wide',
text:'Cancel',
listeners:{
click:this.onCancel,
scope:this
}
},
{
xtype:'spacer',
width:14
},
{
xtype:'button',
cls:'x-btn-primary large wide',
ref:'../insertImageButton',
text:this.insertImageButtonSingle,
disabled:true,
listeners:{
click:function(btn,evt){
this.onSelectImage()
},
scope:this
}
}
]
}
];
this.listeners={
show:function(){
this.el.query('[data-bind=FileChooser.numberOfFiles]')[0].innerHTML='0';
this.core.refreshFileChooser(this.initialPaths);
this.insertImageButton.disable();
if(this.multiSelect){
this.insertImageButton.setText(this.insertImageButtonMultiple)
}else{
this.insertImageButton.setText(this.insertImageButtonSingle)
}
this.fileUploadStatus.hide()
}
};
web.windows.Image.superclass.initComponent.apply(this,arguments)
},
setValues:function(cfg){
cfg=cfg||{};
this.initialPaths=cfg.paths||[];
this.multiSelect=cfg.multiSelect===true;
this.core.enableMultiSelect(this.multiSelect);
this.core.fileChooser.maxFiles=cfg.maxFiles||10;
this.core.fileChooser.errorStrings=cfg.errorStrings;
this.core.fileChooserGridView.maxFiles=cfg.maxFiles||10;
this.core.fileChooserGridView.errorStrings=cfg.errorStrings;
if(cfg.contentTypeFilter){
this.core.setContentTypeFilter(cfg.contentTypeFilter)
}else{
this.core.setContentTypeFilter(this.defaultContentTypeFilter)
}
if(cfg.allowIcoFiles){
this.core.setAllowIcoFiles(cfg.allowIcoFiles)
}
if(this.multiSelect){
this.addClass('multiselect')
}else{
this.removeClass('multiselect')
}
},
onSelectImage:function(){
this.core.getSelectedAssets({
onRequestComplete:function(errorOccurred){
this.fireEvent('complete',this);
if(errorOccurred){
Ext.Msg.alert(errorOccurred.error,errorOccurred.description);
this.fireEvent('error',this,errorOccurred)
}
this.hide()
},
onRequestSuccess:function(images){
this.fireEvent('ok',this,{images:images})
},
scope:this
})
},
onCancel:function(){
this.hide();
this.fireEvent('cancel',this)
}
});
Ext.ComponentMgr.registerType('web-windows-image',web.windows.Image);
web.windows.MissingAssets=Ext.extend(web.windows.Window,{
cls:'web-windows-missingassets',
initComponent:function(){
this.pagesWithMissingAssets=[];
this.missingAssetsWithPages=[];
this.selectReplacementImage=Ext.emptyFn;
this.title='Missing files';
this.width=500;
this.height=400;
this.modal=true;
this.closeAction='close';
this.layout='card';
this.activeItem=0;
this.cls='web-modal-warning';
this.iconCls='web-warning-icon';
this.items=[
{
ref:'front',
layout:'vbox',
layoutConfig:{align:'stretch'},
items:[
{
xtype:'box',
height:20,
html:'These images could not be found on your web space:'
},
{
ref:'list',
xtype:'box',
cls:'assetList',
flex:1,
autoScroll:true,
margins:'10px 0',
tpl:new Ext.XTemplate('<ul>'+'<tpl for=".">'+'<li>'+'<div class="filename">{[this.formatUrl(values.url)]}</div>'+'<div>'+'<span class="affectedPages">'+'Affected pages:'+'</span> '+'{[values.pages.join(", ")]}'+'</div>'+'</li>'+'</tpl>'+'</ul>',{formatUrl:this.formatUrl})
},
{
xtype:'box',
height:50,
html:'They have most likely been deleted or moved to another folder. You can choose to delete all missing files from the components and then insert them again, or replace each file with another one.'
}
]
},
{
ref:'replace',
layout:'vbox',
layoutConfig:{align:'stretch'},
items:[
{
xtype:'box',
height:20,
html:'Please replace each image with a new one:'
},
{
ref:'list',
xtype:'box',
cls:'assetList',
flex:1,
autoScroll:true,
tpl:new Ext.XTemplate('<ul>','<tpl for=".">','<li>','<tpl if="replacement">','<div class="checkbox"></div>','</tpl>','<div class="description">','<div class="filename">','{[this.formatUrl(values.url)]}','</div>','<div>','<span class="affectedPages">'+'Affected pages:'+'</span> ','{[values.pages.join(", ")]}','</div>','</div>','<div data-index="{#}" class="web-button">','<div>','<em>','<a unselectable="on">','Replace image','</a>','</em>','</div>','</div>','</li>','</tpl>','</ul>',{formatUrl:this.formatUrl}),
listeners:{
render:function(cmp){
var getRelatedButton=function(e){
return e.getTarget('.web-button',10,true)
};
this.mon(cmp.el,'click',function(e){
var button=getRelatedButton(e);
if(button){
button.removeClass('x-btn-click');
this.selectReplacementImage(button.getAttribute('data-index')-1)
}
},this);
this.mon(cmp.el,'mousedown',function(e){
var button=getRelatedButton(e);
if(button){
button.addClass('x-btn-click')
}
},this);
this.mon(cmp.el,'mouseup',function(e){
cmp.el.select('.x-btn-click').each(function(el){
el.removeClass('x-btn-click')
})
},this);
this.mon(cmp.el,'mouseover',function(e){
var button=getRelatedButton(e);
if(button){
button.addClass('x-btn-over')
}
},this);
this.mon(cmp.el,'mouseout',function(e){
var button=getRelatedButton(e);
if(button){
button.removeClass('x-btn-over')
}
},this)
},
scope:this
}
},
{
xtype:'box',
height:50,
html:'After replacing each image, please check your pages to make sure they are to your satisfaction before publishing again'
}
]
}
];
this.buttonAlign='center';
this.buttons=[
{
ref:'deleteImagesButton',
text:'Delete all missing images',
cls:'x-btn-primary',
handler:function(button){
button.disable();
this.body.mask('Deleting images from pages...');
this.getFooterToolbar().disable();
this.deleteImages()
},
scope:this
},
{
ref:'replaceImagesButton',
text:'Replace each image',
cls:'x-btn-primary',
handler:function(button){
var bottom=this.getFooterToolbar();
bottom.addFill();
bottom.addButton({
ref:'saveButton',
text:'Save',
cls:'x-btn-primary',
disabled:true,
handler:function(){
this.body.mask('Saving new images...');
bottom.disable();
this.updatePagesWithReplacedImages()
},
scope:this
});
bottom.doLayout();
bottom.remove(bottom.deleteImagesButton);
bottom.remove(bottom.replaceImagesButton);
this.layout.setActiveItem(this.replace);
this.replace.list.update(this.missingAssetsWithPages);
this.replaceImages()
},
scope:this
}
];
web.windows.MissingAssets.superclass.initComponent.call(this)
},
initListeners:function(){
this.on('beforeshow',function(){
this.front.list.update(this.missingAssetsWithPages)
},this)
},
setValues:function(values){
var root=this.app.site.folder,urlsToIndex={},missingAssetsWithPages=[];
this.pagesWithMissingAssets=values.pages;
this.pagesWithMissingAssets.forEach(function(page){
var pageMissingAssets={};
page.missingAssets.forEach(function(missingObj){
var path=missingObj.url=missingObj.url.replace(/\?\S+$/,''),assetIndex;
if(path in urlsToIndex){
assetIndex=urlsToIndex[path]
}else{
assetIndex=missingAssetsWithPages.push({
url:path,
statusCode:missingObj.statusCode,
pages:[],
replacement:null
});
assetIndex-=1;
urlsToIndex[path]=assetIndex
}
if(!(path in pageMissingAssets)){
pageMissingAssets[path]=path;
missingAssetsWithPages[assetIndex].pages.push(root.findLinkPage(page.pageId).getName())
}
})
});
this.missingAssetsWithPages=missingAssetsWithPages
},
deleteImages:function(){
var dm=new web.DM,docIdsToSave=[],anyFailures=false,progress=web.utils.Function.impede(this.pagesWithMissingAssets.length,function(){
var completeProgress=web.utils.Function.impede(docIdsToSave.length,function(){
this.close();
if(anyFailures){
this.displayError('Unable to delete all images.')
}
},this),appDM=this.app.dm,saveTriggered=false;
docIdsToSave.forEach(function(docId){
var doc=dm.get(docId),appDoc=this.app.getSelected(doc.type.split('.').reverse()[0].toLowerCase());
doc.getAssets().forEach(function(asset){
if(asset.url==='repository:/transparent.gif'&&appDM.get(asset.id)){
appDM.get(asset.id).set(asset)
}
},this);
if(appDoc.id===docId){
this.app.fireEvent('update',appDoc);
this.app.fireEvent('select',appDoc);
if(saveTriggered){
completeProgress()
}else{
this.app.save(function(){
completeProgress()
},{scope:this});
saveTriggered=true
}
}else{
this.app.dal.set(doc,function(opts,success,response){
if(!success){
anyFailures=true
}
var appCopyOfDoc=appDM.get(doc.id);
if(appCopyOfDoc){
appDM.unregister(appCopyOfDoc);
appCopyOfDoc.destroy()
}
completeProgress()
})
}
},this)
},this);
this.app.rep.getWebspaceFileMetadata('/transparent.gif',function(opts,success,response){
if(success){
var transparentMetadata=Ext.applyIf({url:'repository:/transparent.gif'},Ext.decode(response.responseText)),assetUrls=this.missingAssetsWithPages.map(function(asset){
return asset.url
});
this.pagesWithMissingAssets.forEach(function(pageWithMissingAsset){
var pageId=pageWithMissingAsset.pageId;
this.app.dal.getWithDependents(pageId,'web.data.components.Page',function(opts,success,response){
if(success){
var data=Ext.decode(response.responseText),assets=dm.create(data.page).getAssets().concat(dm.create(data.template).getAssets(),dm.create(data.stylesheet).getAssets());
assets.forEach(function(asset){
var docId,filter=function(url){
return escape(unescape(url)).search(escape(unescape(asset.url)))!==-1||url.indexOf(asset.url)!==-1
};
if(assetUrls.some(filter)){
if(!asset.getDocument){
one.fatal('Custom - asset.getDocument is not available (delete images)',{
assetUrl:asset.url,
assetType:asset.type
})
}
docId=asset.getDocument().id;
asset.set(transparentMetadata);
if(docIdsToSave.indexOf(docId)===-1){
docIdsToSave.push(docId)
}
}
},this)
}else{
anyFailures=true
}
progress()
},this)
},this)
}else{
this.displayError('Unable to delete missing images')
}
},this)
},
replaceImages:function(){
var replacedAssets={},numMissingAssets=this.missingAssetsWithPages.length,numReplaced=0;
this.selectReplacementImage=function(index){
var missingAsset=this.missingAssetsWithPages[index];
this.app.windows.show({
type:'web.windows.Image',
values:{},
okFn:function(win,selection){
var asset=selection.images[0];
asset=new web.data.assets.Image(asset);
if(!(index in replacedAssets)){
replacedAssets[index]=true;
numReplaced+=1
}
asset=asset.toJSON();
delete asset.id;
missingAsset.replacement=asset;
this.replace.list.update(this.missingAssetsWithPages);
if(numReplaced===numMissingAssets){
this.getFooterToolbar().saveButton.enable()
}
},
scope:this
})
}
},
updatePagesWithReplacedImages:function(){
var dm=new web.DM,missingAssetsWithPages=this.missingAssetsWithPages,assetUrls=missingAssetsWithPages.map(function(asset){
return asset.url
}),docIdsToSave=[],anyFailures=false,progress=web.utils.Function.impede(this.pagesWithMissingAssets.length,function(){
var completeProgress=web.utils.Function.impede(docIdsToSave.length,function(){
this.close();
if(anyFailures){
this.displayError('Unable to save the changes.')
}
},this),appDM=this.app.dm;
docIdsToSave.forEach(function(docId){
var doc=dm.get(docId),appDoc=this.app.getSelected(doc.type.split('.').reverse()[0].toLowerCase());
if(appDoc.id===docId){
doc.getAssets().forEach(function(asset){
appDM.get(asset.id).set(asset)
},this);
this.app.fireEvent('update',appDoc);
this.app.fireEvent('select',appDoc);
this.app.save(function(){
completeProgress()
},{scope:this})
}else{
this.app.dal.set(doc,function(opts,success,response){
if(!success){
anyFailures=true
}
var appCopyOfDoc=appDM.get(doc.id);
if(appCopyOfDoc){
appDM.unregister(appCopyOfDoc);
appCopyOfDoc.destroy()
}
completeProgress()
})
}
},this)
},this);
this.pagesWithMissingAssets.forEach(function(pageWithMissingAsset){
var pageId=pageWithMissingAsset.pageId;
this.app.dal.getWithDependents(pageId,'web.data.components.Page',function(opts,success,response){
if(success){
var data=Ext.decode(response.responseText),assets=dm.create(data.page).getAssets().concat(dm.create(data.template).getAssets(),dm.create(data.stylesheet).getAssets());
assets.forEach(function(asset){
var index=assetUrls.indexOf(asset.url),docId;
if(index!==-1){
if(!asset.getDocument){
one.fatal('Custom - asset.getDocument is not available (replace images)',{
assetUrl:asset.url,
assetType:asset.type
})
}
docId=asset.getDocument().id;
asset.set(missingAssetsWithPages[index].replacement);
if(docIdsToSave.indexOf(docId)===-1){
docIdsToSave.push(docId)
}
}
},this)
}else{
anyFailures=true
}
progress()
},this)
},this)
},
displayError:function(msg){
one.error(msg);
this.body.unmask();
this.getFooterToolbar().enable()
},
formatUrl:function(url){
return url.replace(/^(?:webspace|repository):/,'').split('/').map(web.DAL.decodeHref).join('/')
}
});
Ext.reg('web-windows-missingassets',web.windows.MissingAssets);
web.windows.RenameDirectory=Ext.extend(web.windows.Window,{
type:'web.windows.RenameDirectory',
initComponent:function(){
this.directory=null;
this.title='Rename folders';
this.width=400;
this.height=190;
this.iconCls='web-warning-icon';
this.cls='web-modal-warning x-window-dlg';
this.layout='vbox';
this.layoutConfig={align:'stretch'};
this.items=[
{
ref:'form',
xtype:'form',
labelWidth:80,
flex:1,
items:[{
ref:'directoryName',
xtype:'textfield',
width:250,
fieldLabel:'New name',
value:'',
validator:function(value){
return value!==this.directory&&one.validation.pathname.test(value)
},
listeners:{
valid:function(){
this.renameButton.enable()
},
invalid:function(){
this.renameButton.disable()
},
scope:this
},
invalidText:'The folder name is not valid.'
}]
},
{
xtype:'box',
flex:1,
style:{fontStyle:'italic'},
margins:'0 0 0 85px',
html:'Avoid using ".html" in your new folder name.'
}
];
this.buttons=[
'->',
{
ref:'../renameButton',
cls:'x-btn-primary',
disabled:true,
text:'Rename',
handler:function(){
var textField=this.form.directoryName,filename=textField.getValue();
if(textField.isValid()){
this.body.mask();
this.renameButton.disable();
this.app.dal.queueRequest({
method:'post',
url:this.app.dal.defaultUrl+'/webspace/'+this.directory+'/',
jsonData:{
command:'move',
destination:filename
},
callback:function(opts,success,response){
if(success){
this.fireEvent('ok');
this.close()
}else{
this.body.unmask()
}
},
scope:this
})
}
},
scope:this
}
];
web.windows.RenameDirectory.superclass.initComponent.call(this)
},
setValues:function(directory){
this.directory=directory;
this.form.directoryName.setValue(directory)
}
});
Ext.ns('web.ui.tips');
web.ui.tips.BaseTip=Ext.extend(web.windows.Window,{
style:{
backgroundColor:'#FFFFFF',
color:'#000000',
shadowTop:'box-shadow: 0px 0px 15px rgba(0,0,0,0.33);',
shadowBottom:'box-shadow: 0px 5px 15px rgba(0,0,0,0.33);'
},
width:null,
textHeight:null,
tip:null,
title:null,
text:null,
tutorial:false,
showNextTip:true,
showPrevTip:true,
showFlag:true,
constructor:function(config){
var embedVideoPanelWidth=240;
this.addEvents({
'closeall':true,
'close':true,
'showvideo':true,
'shownext':true,
'switchtab':true
});
this.padding=0;
config.tip=config.tip===undefined?'top left':config.tip||null;
config.width=config.width||280;
config.resizable=false;
config.closeAction='hide';
config.cls=config.cls||'';
if(/top/.test(config.tip)){
config.cls+=' web-basetip web-window-lesspadding tip-top-'+(/left/.test(config.tip)?'left':'right')
}else if(/bottom/.test(config.tip)){
config.cls+=' web-basetip web-window-lesspadding tip-bottom-'+(/left/.test(config.tip)?'left':'right')
}
config.tutorial=config.tutorial?config.tutorial!==true?config.tutorial:'1VYgY6oRqOo':null;
var hideButtons=!config.tutorial&&config.showNextTip===false&&config.showPrevTip===false;
config.items=[
{
xtype:'container',
itemId:'header',
html:[
'<div class="x-window-header x-unselectable hbox cross-center'+(config.showFlag===false?'':' icon-tip-header')+'">',
'<div class="icon icon-tip-flag show-if-normal"></div>',
'<div class="icon-tip-title flex">'+config.title+'</div>',
'<img src="'+Ext.BLANK_IMAGE_URL+'" class="icon icon-tip-cross">',
'</div>',
'</div>'
].join(''),
listeners:{
afterrender:function(component){
this.mon(component.el.child('.icon-tip-cross'),'click',function(){
this.hide();
this.fireEvent('close',this)
},this)
},
scope:this
}
},
{
xtype:'container',
layout:'hbox',
style:'background-color: '+this.style.backgroundColor+';',
height:config.textHeight+97+2-(hideButtons?50:0),
items:[
{
xtype:'container',
width:config.width-(config.tutorial?embedVideoPanelWidth:0),
style:'padding: 0 20px',
layout:'vbox',
layoutConfig:{align:'stretch'},
height:config.textHeight+97+2-(hideButtons?50:0),
items:[
{
xtype:'displayfield',
value:config.text,
height:config.textHeight
},
{
xtype:'container',
html:'<div style="margin-top: 10px;"></div>'
},
{
xtype:'container',
hidden:hideButtons,
html:'<div style="width: '+(config.width-30)+'px; border-top: 1px solid #c7d4b1; margin-top: 10px; margin-bottom: 10px;"></div>'
},
{
xtype:'container',
cls:'hbox cross-center',
hidden:hideButtons,
height:28,
items:[
{
xtype:'button',
cls:'x-btn-primary large show-previous-btn',
iconCls:'icon back-triangle',
text:'',
width:30,
handler:function(){
this.fireEvent('showprev',this)
},
hidden:config.showPrevTip===false,
scope:this
},
{
xtype:'container',
cls:'flex'
},
{
xtype:'button',
cls:'x-btn-primary',
text:'Show next tip',
handler:function(){
this.fireEvent('shownext',this)
},
height:29,
style:{
'float':'right',
'padding-left':'25px',
'padding-right':'25px'
},
hidden:config.showNextTip===false,
scope:this
}
]
}
]
},
{
xtype:'container',
hidden:!config.tutorial,
html:'<div style="height: '+(config.textHeight+65)+'px; border-left: 1px solid #c7d4b1; margin: 10px 0;"></div>'
},
{
xtype:'container',
hidden:!config.tutorial,
width:embedVideoPanelWidth-1,
height:config.textHeight+97,
style:'padding: 20px',
layout:'vbox',
layoutConfig:{align:'stretch'},
items:[
{
xtype:'displayfield',
value:'<b>'+'Getting started with Website Builder'+'</b>'
},
{
xtype:'spacer',
height:10
},
{
xtype:'button',
cls:'tip-video-button',
iconCls:'icon-tip-video',
itemId:'video',
height:110,
width:210,
handler:function(){
var w=new Ext.Window({
width:885,
height:580,
modal:true,
cls:'cross-center web-window-notitle',
items:[
{
ref:'iframediv',
html:''
},
{
xtype:'spacer',
height:6
}
],
onShow:function(){
this.iframediv.update('<iframe id="starttipVideo" width="830px" height="510px" src="https://www.youtube.com/embed/'+config.tutorial+'?rel=0&start=40" frameborder="0" allowfullscreen></iframe>');
Ext.getBody().addClass('one-body-masked-dark')
},
onHide:function(){
this.iframediv.update('');
Ext.getBody().removeClass('one-body-masked-dark')
}
});
w.show()
},
scope:this
},
{
xtype:'spacer',
height:10
},
{
xtype:'displayfield',
value:'Take a tour of Website Builder with this video. Creating your website has never been more easy.'
}
]
}
]
}
];
this.on('show',function(){
var el,that=this;
el=that.el.child('div[class~=x-window-header]');
el.dom.style.display='none';
that.el.dom.style.backgroundColor='transparent';
el=that.el.child('div[class~=x-window-bwrap]');
el.dom.style.backgroundColor='transparent';
this.el.setLeftTop(this.getX(),this.getY())
},this);
web.ui.tips.BaseTip.superclass.constructor.call(this,config)
},
getX:Ext.emptyFn,
getY:Ext.emptyFn
});
web.ui.tips.Publishing=Ext.extend(web.ui.tips.BaseTip,{
constructor:function(cfg){
var config={
width:400,
textHeight:55,
showNextTip:false,
showPrevTip:false,
showFlag:false,
tip:'top left',
title:'<span class="show-if-premium">'+'Publishing a Premium website...'+'</span>'+'<span class="show-if-normal">'+'Your site is being published...'+'</span>',
text:'<div class="show-if-premium">'+'<div class="row-content">'+'<div class="icon icon-tip-premium-cogs"></div>'+'<div class="cards">'+'<div>'+'Publishing pages...'+'</div>'+'<div>'+'Checking sitemap...'+'</div>'+'<div>'+'Injecting high-resolution images...'+'</div>'+'<div>'+'Accelerating the website...'+'</div>'+'</div>'+'</div>'+'<div class="read-more-link-wrapper">'+'<div class="link"><a href="#">'+'Read more'+'</a></div>'+'<div class="text" style="display: none">'+'Premium websites show optimal image resolutions and load faster due to a more advanced publication. You can continue working while publishing.'+'</div>'+'</div>'+'</div>'+'<div class="show-if-normal">'+'<b>'+'Pro tip:'+' </b>'+'<span>'+'Premium displays your website in the best quality resolution on your visitor\'s screens. You also get other nice features, including Backups and more templates.'+'</span>'+'<br><br>'+'<a href="#" class="upgrade-text-color" onclick="web.upgradeToPremiumViaPopup({app: one.viewport.application, source: \'PublishTip:Link\'})">'+'Learn more about Premium'+'</a>'+'</div>',
cls:'premium publish'
};
web.ui.tips.Publishing.superclass.constructor.call(this,config);
this.bindEvents()
},
bindEvents:function(){
var that=this;
this.on('hide',function(){
clearInterval(this._showCardsInterval)
},this);
this.on('show',function(){
var cardId=0,cardEl=oneJQuery('.web-window.publish .cards'),totalCards=cardEl&&cardEl[0].children.length;
var updateText=function(){
cardId=(cardId+1)%totalCards;
for(var i=0;i<totalCards;i+=1){
var c=cardEl.find(':nth-child('+(i+1)+')');
if(i===cardId){
c.show()
}else{
c.hide()
}
}
};
this._showCardsInterval=setInterval(updateText,2000);
updateText()
},this);
function adjustWindowHeight(direction){
var readMore=Ext.get(that.el.query('.read-more-link-wrapper')[0]);
var linkEl=readMore.query('.link');
var textEl=readMore.query('.text');
var linkHeight=oneJQuery(linkEl).height();
var textHeight=oneJQuery(textEl).height();
var diff=(textHeight-linkHeight)*direction;
if(direction===1){
linkEl[0].style.display='none';
textEl[0].style.display=''
}else{
linkEl[0].style.display='';
textEl[0].style.display='none'
}
var applyDiff=function(selector,diff){
var el=that.el.query(selector)[0];
el.style.height=Number(el.style.height.replace('px',''))+diff+'px'
};
applyDiff('.x-window-body > .x-box-layout-ct',diff);
applyDiff('.x-window-body > .x-box-layout-ct > .x-box-inner',diff);
applyDiff('.x-window-body > .x-box-layout-ct > .x-box-inner > [data-xtype=container]',diff);
applyDiff('.x-window-body > .x-box-layout-ct > .x-box-inner > [data-xtype=container] > .x-box-inner',diff)
}
this.on('show',function(){
oneJQuery(this.el.dom).find('.read-more-link-wrapper a').on('click',function(){
adjustWindowHeight.call(that,1)
})
},this,{single:true});
this.on('hide',function(){
var readMore=Ext.get(this.el.query('.read-more-link-wrapper')[0]);
var linkEl=readMore.query('.link');
if(linkEl[0].style.display==='none'){
adjustWindowHeight.call(this,-1)
}
},this)
},
getX:function(){
return 197
},
getY:function(){
return 90
}
});
web.ui.tips.Published=Ext.extend(web.ui.tips.BaseTip,{
constructor:function(cfg){
web.ui.tips.Published.onViewSite=function(){
cfg.listeners.viewsite.call(cfg.listeners.scope||this)
};
var config={
width:400,
textHeight:78,
showNextTip:false,
showPrevTip:false,
showFlag:false,
tip:'top left',
title:'Your site is published',
text:'<div class="show-if-premium" style="text-align: center;">'+'<div class="icon icon-tip-premium-checkmark" style="display: inline-block"></div><br>'+'<a href="javascript:web.ui.tips.Published.onViewSite()">'+'View site'+'</a>'+'</div>'+'<div class="show-if-normal">'+'Any changes made during publication need to be published again to appear on your site.'+'<br><br>'+'<a href="javascript:web.ui.tips.Published.onViewSite()">'+'View site'+'</a>'+'</div>',
cls:'premium publish'
};
web.ui.tips.Published.superclass.constructor.call(this,config)
},
getX:function(){
return 197
},
getY:function(){
return 90
}
});
web.panels.Publishing=Ext.extend(Ext.Toolbar,{
initComponent:function(){
this.defaults={
minWidth:93,
scale:'small',
cls:'x-btn-primary-ws large',
style:{marginLeft:'9px'},
scope:this
};
this.items=[
{
ref:'saveButton',
cls:'x-btn-primary-ws large save-btn',
handler:function(){
this.app.fireEvent('saving');
this.app.save()
},
tooltip:'Save your changes.'
},
{
ref:'previewButton',
text:'Preview',
handler:this.onPreview,
tooltip:'Preview your website.',
disabled:true
},
{
ref:'publishButton',
handler:function(){
this.onPublish()
},
tooltip:'Update your live website with your changes.'
}
];
this.publishingTip=new web.ui.tips.Publishing({app:this.app});
this.publishedTip=new web.ui.tips.Published({
app:this.app,
listeners:{
viewsite:this.onViewSite,
scope:this
}
});
web.panels.Publishing.superclass.initComponent.call(this);
this.initListeners();
if(this.publishStatus==='published'){
this.disablePublishButton()
}else if(this.publishStatus==='publishing'){
this.checkProgress()
}else{
this.enablePublishButton()
}
},
initListeners:function(){
var saveButton=this.saveButton,previewButton=this.previewButton,enableSaveButton=function(){
if(oneJQuery(saveButton.el.dom).hasClass('saving')){
return
}
saveButton.setText('Save');
saveButton.enable();
saveButton.setTooltip('Save your changes.');
saveButton.removeClass('saving')
},disableSaveButton=function(){
saveButton.setText('Saved');
saveButton.disable();
saveButton.setTooltip('All changes are saved.');
saveButton.removeClass('saving')
},disableSaveButtonAsSaving=function(){
saveButton.setText('');
saveButton.disable();
saveButton.setTooltip('Saving');
saveButton.addClass('saving')
},toggleState=new Ext.util.DelayedTask(function(){
if(this.app.hasUnsavedChanges()){
enableSaveButton();
this.enablePublishButton()
}else{
disableSaveButton()
}
},this);
disableSaveButton();
this.mon(this.app,'update',function(part){
if(part instanceof web.data.Site||part instanceof web.data.links.Link){
this.enablePublishButton()
}else{
toggleState.delay(20)
}
},this);
this.mon(this.app,'load',function(){
disableSaveButton()
},this);
this.mon(this.app,'save',function(){
disableSaveButton()
},this);
this.mon(this.app,'saving',function(){
disableSaveButtonAsSaving()
},this);
this.mon(this.app,'savefailed',function(){
enableSaveButton()
},this);
this.mon(this.app,'activate',function(option){
if(option==='workspace'){
this.enableTips()
}else if(option==='preview'||option==='templates'||option==='pageimport'){
this.disableTips()
}
},this);
this.mon(this.app,'select',function(part){
if(part instanceof web.data.components.Page){
previewButton.enable()
}
},this);
if(this.app.getSelected('page')){
previewButton.enable()
}
},
disablePublishButton:function(){
var publishButton=this.publishButton;
publishButton.setText('Published');
if(document.title!==this.app.name){
document.title=this.app.name
}
publishButton.disable();
publishButton.setTooltip('All changes are published.');
this.published=true
},
enablePublishButton:function(){
var publishButton=this.publishButton;
if(this.publishing){
this.enabledWhilePublishing=true;
return
}
publishButton.setText('Publish');
if(document.title!==this.app.name){
document.title=this.app.name
}
publishButton.enable();
publishButton.setTooltip('Update your live website with your changes.');
this.published=false
},
disableTips:function(){
this.tipsDisabled=true;
this.publishingTip.hide();
this.publishedTip.hide()
},
enableTips:function(){
this.tipsDisabled=false;
if(this.publishedTipToShow){
if(!this.publishing){
this.publishedTip.show()
}
this.publishedTipToShow=false;
this.publishingTipToShow=false
}else if(this.publishingTipToShow){
this.publishingTip.show();
this.publishingTipToShow=false
}
},
showPublishingTip:function(){
this.publishingTipToShow=true;
if(!this.tipsDisabled){
this.publishedTip.hide();
this.publishingTip.show();
this.publishingTipToShow=false
}
},
showPublishedTip:function(publicRootUrl){
this.publicRootUrl=publicRootUrl;
this.publishedTipToShow=true;
if(!this.tipsDisabled){
this.publishingTip.hide();
this.publishedTip.show();
this.publishedTipToShow=false
}
},
isPublished:function(){
return this.publishButton.disabled&&this.published
},
onPublish:function(callback,scope){
scope=scope||this;
callback=callback||Ext.emptyFn;
var that=this;
var checkSubscriptionLevel=function(next){
var user=that.app.user;
var package=user.getPackage();
var publicPagesCount=that.app.site.folder.getAllPages().reduce(function(count,page){
return page.public?count+1:count
},0);
if(package.pageLimit&&publicPagesCount>package.pageLimit&&[
web.UserSubscriptionStatus.PREMIUM,
web.UserSubscriptionStatus.UNKNOWN
].indexOf(user.getSubscriptionStatus())===-1){
if(user.freeUpgradeAvailable){
var durationInMonths=function(ts){
var end=new Date(ts);
var now=new Date;
var endMonthsSince0AD=end.getFullYear()*12+end.getMonth();
var nowMonthsSince0AD=now.getFullYear()*12+now.getMonth();
var diffInMonths=endMonthsSince0AD-nowMonthsSince0AD;
var representEndDateAsNumber=end.getDate()*10000000+end.getHours()*100000+end.getMinutes()*1000+end.getSeconds();
var representNowDateAsNumber=now.getDate()*10000000+now.getHours()*100000+now.getMinutes()*1000+now.getSeconds();
if(representEndDateAsNumber-representNowDateAsNumber<0){
diffInMonths-=1
}
return diffInMonths
};
var pricePerMonth='';
if(user.chargesForUpgrade){
pricePerMonth=user.chargesForUpgrade.currencyCode+''+(user.chargesForUpgrade.price/user.chargesForUpgrade.currencyFactor).toFixed(2)
}
var yesText,titleText,msgText;
var premiumIsNeeded=[
'<div class="cards">',
'<div class="card card1">',
'<div class="upgrade-icon"></div>',
'<p class="title">'+'Website Builder Premium is needed'+'</p>',
'<p class="premium-link">',
'<span>',
one.locale.trQuantity({
one:'Upgrade to Website Builder Premium to publish more than 5 pages. It is free in this subscription period ({0} month) and brings extended features.',
other:'Upgrade to Website Builder Premium to publish more than 5 pages. It is free in this subscription period ({0} months) and brings extended features.'
},durationInMonths(user.subscriptionEnd)),
'</span>',
function(){
if(pricePerMonth){
return' <a href="#" style="white-space:nowrap">'+'Read more'+'</a>'
}
return''
}(),
'</p>',
'<br>',
'<div class="upgrade-button-wrap">',
'<div class="web-button x-btn-premium large x-btn-noicon">',
'<div class="x-btn-small x-btn-icon-small-left">',
'<em class="">',
'<a unselectable="on" class="x-btn-text activate-free-upgrade">'+'Activate your free upgrade *'+'</a>',
'</em>',
'</div>',
'</div>',
'</div>',
'<br>',
function(){
if(pricePerMonth){
return[
'<div style="font-style:italic">',
'*',
' <span>',
one.locale.trQuantity({
one:'You will get access to the service, free of charge for {0} month. After that, it is just {1}/month.',
other:'You will get access to the service, free of charge for {0} months. After that, it is just {1}/month.'
},durationInMonths(user.subscriptionEnd),pricePerMonth),
'</span>',
' <span>'+'You can disable Website Builder Premium at anytime during the trial period.'+'</span>',
'</div>'
].join('')
}
return'<p class="premium-link">* <a href="#">'+'Read more'+'</a></p>'
}(),
'</div>',
'<div class="card card2 hide">',
'<div class="upgrade-icon"></div>',
'<p class="title"><span class="greencheckmark-icon"></span> '+'Your subscription is upgraded'+'</p>',
'<p>',
'Publish now and benefit right away from publishing in higher resolution.',
'</p>',
'</div>',
'</div>'
].join('');
if(that.app.hasUnsavedChanges()){
yesText='Save & Publish';
titleText='Save and Publish';
msgText='You have changes which are not saved. These changes need to be saved first.'+premiumIsNeeded
}else{
yesText='Publish';
titleText='Publish all changes';
msgText='Click Publish to update your live website with your changes.'+premiumIsNeeded
}
var messageBox=Ext.Msg.show({
cls:'publish-dialog-with-offer',
width:560,
buttons:{
yes:yesText,
no:'Cancel'
},
title:titleText,
msg:msgText,
fn:function(buttonId){
dlgPublishButton.enable();
if(buttonId==='yes'){
if(that.app.hasUnsavedChanges()){
that.app.save(that.publishAll,{scope:that})
}else{
that.publishAll()
}
callback.call(scope,true)
}else{
callback.call(scope,false)
}
},
scope:that
});
var dialog=messageBox.getDialog();
dialog.center();
Ext.EventManager.onWindowResize(function(){
dialog.center()
});
var dlgPublishButton=dialog.buttons[dialog.buttons.length-1];
dlgPublishButton.disable();
var activateFreeUpgrade=dialog.el.query('.activate-free-upgrade');
Ext.get(activateFreeUpgrade).on('click',function(resp,status,obj){
oneJQuery.ajax('/api/v1/'+that.app.dal.domain+'/seamlessUpgradeToPremium').done(function(){
that.app.user.subscriptionStatus=web.UserSubscriptionStatus.PREMIUM;
that.app.updatePremiumUI();
dlgPublishButton.enable();
Ext.get(dialog.el.query('.cards .card1')).addClass('hide');
Ext.get(dialog.el.query('.cards .card2')).removeClass('hide');
that.app.trackEvent({
eventCategory:'UpgradeToPremium',
eventAction:'seamlessupgrade.success'
})
}).fail(function(obj,status,msg){
one.error(msg);
that.app.trackEvent({
eventCategory:'UpgradeToPremium',
eventAction:'seamlessupgrade.error'
})
}).always(function(){
})
},that);
var readMoreLink=dialog.el.query('.premium-link a');
Ext.get(readMoreLink).on('click',function(){
window.open('https://www.one.com/en/support/faq/what-is-website-builder-premium','One.com FAQs','height=900,width=1200,scrollbars=yes,resizable=yes',true).focus()
},that)
}else{
Ext.Msg.show({
cls:'web-modal-premium',
buttons:{ok:'Upgrade'},
title:'Premium feature',
msg:'You can only publish sites with up to '+package.pageLimit+' pages with your current Website Builder.'+'<br><br>'+'Upgrade to Website Builder Premium to publish your website and get other great features.',
fn:function(buttonId){
if(buttonId==='ok'){
web.upgradeToPremiumViaPopup({
app:that.app,
source:'Publish:UpgradePopup'
})
}
}
})
}
}else{
next()
}
};
var saveChangesAndPrompt=function(){
var config;
if(that.app.hasUnsavedChanges()){
config={
buttons:{
yes:'Save & Publish',
no:'Cancel'
},
title:'Save and Publish',
msg:'You have changes which are not saved. These changes need to be saved first.',
fn:function(buttonId){
if(buttonId==='yes'){
that.app.save(that.publishAll,{scope:that});
callback.call(scope,true)
}else{
callback.call(scope,false)
}
},
scope:that
}
}else{
config={
buttons:{
yes:'Publish',
no:'Cancel'
},
title:'Publish all changes',
msg:'Click Publish to update your live website with your changes.',
fn:function(buttonId){
if(buttonId==='yes'){
that.publishAll();
callback.call(scope,true)
}else{
callback.call(scope,false)
}
},
scope:that
}
}
var homePageId=that.app.site.getHomePageId(),home=that.app.site.folder.items.find(function(item){
return item.pageId===homePageId
});
if(!home||!home.public){
config.cls='web-modal-warning';
config.iconCls='web-warning-icon';
config.title='No Start Page is set';
config.msg='You did not set a Start Page for your website.'+'<br><br>'+'The website will be published, but will not appear when the domain name is entered in a browser window.'+'<br><br>'+'<a target="_blank" href="'+'http://www.one.com/en/support/faq/how-do-i-make-a-page-my-start-page'+'">'+'Show me how to set a Start Page'+'</a>'
}
Ext.Msg.show(config)
};
async.seq(checkSubscriptionLevel,saveChangesAndPrompt)(this)
},
onPreview:function(){
this.app.fireEvent('activate','preview')
},
updateProgressBar:function(progress){
var btn=this.publishButton,btnEl=Ext.get(btn.id),el=this.progressEl;
if(btnEl){
if(!el){
el=this.progressEl=Ext.get(Ext.DomHelper.append(Ext.getBody(),{cls:'web-publishing-progress'}));
window.el=el
}
el.show();
el.setXY(btnEl.getXY());
el.setHeight(btnEl.getHeight());
el.dom.style.backgroundPosition=Math.min(progress,0.9)*btnEl.getWidth()+'px 0px'
}
var publishingText='Publishing';
btn.setText(publishingText);
document.title=publishingText+' ('+Math.round(Math.min(progress,0.99)*100)+'%)';
btn.setTooltip('All changes are being published.')
},
checkProgress:function(direct){
var app=this.app,ticFirst=direct?200:0,ticDelay=50,pageCount=app.site.folder.getPageCount(),checkFn,multiplier=Math.round(Math.pow(pageCount*0.4,1.4)),maxTime=5000+1000*multiplier,checkDelayMin=2000,checkDelay=checkDelayMin,start=Date.now(),check=start,info=this.publishInfo,elapsed=!direct&&info?info.now-info.publicationId:0,now=start,eta=maxTime,pacedEta=eta,pace=0,progress=0,isPublishing=direct?undefined:true,isPublishingTipShown;
elapsed=elapsed?elapsed+3000:0;
checkFn=function(){
if(this.sitePublished){
this.stopProgress();
this.disablePublishButton();
return
}
now=Date.now();
elapsed=elapsed||now-start;
if(now>check+checkDelay*(!direct||this.publishAccepted?1:2)){
check=now;
app.dal.getPublishedState(function(opts,success,response){
if(this.sitePublished){
this.stopProgress();
this.disablePublishButton();
return
}
if(success&&response.responseText){
var data=Ext.decode(response.responseText);
if(data.status==='publishing'){
isPublishing=true;
if(data&&data.etaMs){
eta=data.etaMs+200;
checkDelay=Math.max(checkDelayMin,Math.round(eta/3))
}else{
checkDelay*=1.1
}
if(eta>1000*60*15||checkDelay>1000*60*5){
one.fatal('Publish time is too long.',{
elapsed:Date.now()-start,
eta:eta,
maxTime:maxTime,
pageCount:pageCount,
checkDelay:checkDelay
});
checkDelay=Math.min(checkDelay,1000*60*5)
}
elapsed=Math.max(elapsed,data.now-data.publicationId)
}else if(data.status==='published'){
this.onPublishSuccess(data.publicRootUrl);
this.stopProgress();
isPublishing=false
}else if(data.status==='unpublished'){
if(data.publicationId===this.currentPublicationId){
this.onPublishSuccess(data.publicRootUrl);
this.stopProgress();
isPublishing=false
}
}else{
isPublishing=false;
one.fatal('Unexpected data.status when trying to publish.')
}
}
},this)
}else{
elapsed=now-start
}
if(isPublishing||eta<maxTime/3){
eta-=ticDelay>eta?Math.floor(eta/2):ticDelay;
eta=Math.max(eta,0)
}
if(eta>250){
pace=(eta-pacedEta)/(eta/350);
pacedEta+=pace;
pacedEta=Math.round(Math.max(pacedEta,eta))
}else if(eta){
pacedEta=eta
}else{
pacedEta=0
}
progress=Math.max(progress,elapsed/(elapsed+pacedEta));
if(isPublishing===true||direct){
this.updateProgressBar(progress);
if(!isPublishingTipShown){
this.startProgress();
isPublishingTipShown=true
}
}
if(isPublishing!==false){
var that=this;
this.progressTimer=setTimeout(function(){
checkFn.call(that)
},ticDelay)
}
};
if(ticFirst){
var that=this;
this.progressTimer=setTimeout(function(){
checkFn.call(that)
},ticFirst)
}else{
checkFn.call(this)
}
},
startProgress:function(){
this.publishButton.disable();
this.showPublishingTip();
this.publishing=true
},
stopProgress:function(){
if(!this.publishing){
return
}
this.publishingTip.hide();
clearTimeout(this.progressTimer);
if(this.progressEl){
this.progressEl.hide()
}
this.publishingTipToShow=false;
this.publishedTipToShow=false;
this.publishing=false;
if(this.enabledWhilePublishing){
this.enablePublishButton();
this.enabledWhilePublishing=false
}
},
publishAll:function(force){
var app=this.app;
this.checkProgress(true);
this.publishAccepted=false;
this.sitePublished=false;
var that=this;
app.dal.publish(force===true,function(opts,success,response){
var fnCallback=function(opts,success,response){
if(response.status===202){
this.publishAccepted=true
}else if(success){
this.onPublishSuccess(Ext.decode(response.responseText).publicRootUrl)
}else{
if(response.status===412){
var data=Ext.decode(response.responseText),errorData=data.errorData;
if(errorData.clobberedAssets&&errorData.clobberedAssets.length){
this.showClobberedFiles(errorData.clobberedAssets,errorData.overwrittenAssets)
}else if(errorData.overwrittenAssets&&errorData.overwrittenAssets.length){
this.showOverwrittenFiles(errorData.overwrittenAssets)
}else if(errorData.pagesWithMissingAssets&&errorData.pagesWithMissingAssets.length){
this.showMissingAssets(errorData.pagesWithMissingAssets)
}else if(errorData.directoryClobberedAssets&&errorData.directoryClobberedAssets.length){
this.showClobberedDirectories(errorData.directoryClobberedAssets,errorData.overwrittenAssets)
}else{
if(errorData.error==='needs-premium-version-to-publish'){
one.fatal('Publishing failed because the domain needs premium version to publish the site in its current state.')
}else{
one.fatal('Custom - Publishing failed with status : '+response.status)
}
one.error('<b>'+'An error occurred during publishing.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.','Publishing failed')
}
}else{
one.fatal('Custom - Publishing failed with status : '+response.status);
one.error('<b>'+'An error occurred during publishing.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.','Publishing failed')
}
this.enablePublishButton()
}
if(!this.publishAccepted){
this.stopProgress()
}
};
if(response.status===202){
var responseObj=Ext.decode(response.responseText);
that.currentPublicationId=responseObj.publicationId;
this.app.trackEvent({
eventCategory:'Publishing',
eventAction:'publish',
eventLabel:'pages',
eventValue:this.app.site.findNumberOfPages()
});
web.utils.IntercomTracker.trackEvent('created-webeditor');
setTimeout(function checkPublishedState(){
app.dal.getPublishedState(function(publishedStateOpts,publishedStateSuccess,publishedStateResponse){
if(publishedStateSuccess){
var publishedStateResponseObj=Ext.decode(publishedStateResponse.responseText),status=publishedStateResponseObj.status;
if(status==='published'||status==='unpublished'&&publishedStateResponseObj.publicationId===responseObj.publicationId){
fnCallback.call(that||this,opts,true,response)
}else if(status==='publishing'){
setTimeout(checkPublishedState,10000)
}else if(status==='unpublished'){
if(publishedStateResponseObj.lastPublicationError){
fnCallback.call(that||this,opts,false,{
status:publishedStateResponseObj.lastPublicationError.statusCode,
responseText:'{"errorData":'+Ext.encode(publishedStateResponseObj.lastPublicationError.data)+'}'
})
}else{
fnCallback.call(that||this,opts,false,publishedStateResponse)
}
}
}
})
},10000)
}else{
fnCallback.call(that||this,opts,success,response)
}
},that)
},
showClobberedFiles:function(clobberedFiles,overwrittenFiles){
clobberedFiles=this.getArrayOfUrls(clobberedFiles);
this.app.windows.show({
type:'web.windows.ClobberedAndMissingAssetsList',
iconCls:'web-warning-icon',
cls:'web-modal-warning x-window-dlg',
title:'Pages already exist',
values:{
assets:clobberedFiles,
captionLabel:'The following pages already exist on your web space:',
promptLabel:'Click '+('<b>'+'Overwrite'+'</b>')+' to replace the existing pages with the Website Builder pages.',
okLabel:'Overwrite'
},
okFn:function(){
if(overwrittenFiles&&overwrittenFiles.length){
this.showOverwrittenFiles(overwrittenFiles)
}else{
this.publishAll(true)
}
},
scope:this
})
},
showOverwrittenFiles:function(overwrittenFiles){
overwrittenFiles=this.getArrayOfUrls(overwrittenFiles);
this.app.windows.show({
type:'web.windows.ClobberedAndMissingAssetsList',
title:'Pages modified outside of Website Builder',
values:{
assets:overwrittenFiles,
captionLabel:'',
promptLabel:'have been modified outside of Website Builder. Do you want to overwrite these changes?',
okLabel:'OK'
},
okFn:function(){
this.publishAll(true)
},
scope:this
})
},
showMissingAssets:function(missingAssets){
this.app.windows.show({
type:'web.windows.MissingAssets',
persist:false,
values:{pages:missingAssets}
})
},
showClobberedDirectories:function(assets,overwrittenAssets){
assets=this.getArrayOfUrls(assets);
this.app.windows.show({
title:'Rename folders',
type:'web.windows.ClobberedAndMissingAssetsList',
iconCls:'web-warning-icon',
cls:'web-modal-warning x-window-dlg',
persist:false,
values:{
assets:assets,
captionLabel:'The following folders on your web space need to be renamed for Website Builder to continue publishing:',
promptLabel:'Click Rename to rename the folders.',
okLabel:'Rename',
cls:'web-modal-warning',
iconCls:'web-warning-icon'
},
okFn:function(){
var urls=assets.map(function(item){
return item.replace(/^\//,'')
});
this.renameDirectories(urls,function(success){
if(success){
if(overwrittenAssets&&overwrittenAssets.length){
overwrittenAssets=this.getArrayOfUrls(overwrittenAssets);
this.showOverwrittenFiles(overwrittenAssets)
}else{
this.publishAll(true)
}
}else{
one.error('<b>'+'An error occurred during publishing.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.','Publishing failed')
}
},this)
},
scope:this
})
},
renameDirectories:function(directories,callback,scope){
var remainingDirectories=[].concat(directories),directory=remainingDirectories.shift();
this.app.windows.show({
type:'web.windows.RenameDirectory',
persist:false,
values:directory,
okFn:function(){
if(remainingDirectories.length){
this.renameDirectories(remainingDirectories,callback,scope)
}else{
callback.call(scope||this,true)
}
},
scope:this
})
},
getArrayOfUrls:function(assets){
return assets.map(function(item){
return item.url
})
},
onViewSite:function(){
var page=this.app.getSelected('page'),root=this.app.site.getFolder(),link=root.findLinkPage(page.getId()),linkPath='',siteUrl;
if(this.publicRootUrl){
siteUrl=this.publicRootUrl.replace(/\/$/,'')
}else{
siteUrl='http://'+this.app.dal.getDomain()
}
if(link.isPublic()){
linkPath=link.getUrlPath();
siteUrl+=linkPath
}else{
root.getItems().some(function(item){
if(item.isPublic&&item.isPublic()&&item.getUrlPath){
linkPath=item.getUrlPath();
siteUrl+=linkPath;
link=item;
return true
}
},this)
}
if(linkPath!==''&&link.getItems().length===0){
siteUrl+='.html'
}
var win=window.open(siteUrl,'_blank');
win.focus();
this.publishedTip.hide()
},
onPublishSuccess:function(publicRootUrl){
this.sitePublished=true;
this.disablePublishButton();
this.showPublishedTip(publicRootUrl)
}
});
web.panels.Mode=Ext.extend(Ext.Container,{
initComponent:function(){
this.buttonAlign='right';
this.defaults={
minWidth:75,
cls:'mode-btn-tab',
scale:'small',
enableToggle:true,
toggleGroup:'mode',
handler:this.onChangeMode,
scope:this
};
this.width=332;
this.layout='hbox';
this.layoutConfig={align:'middle'};
var buttonWidth=this.app.isVerbose()?165:120;
this.items=[
{
xtype:'button',
itemId:'page',
ref:'pageBtn',
text:'<img class="icon icon-mode-page" src="'+Ext.BLANK_IMAGE_URL+'"/>'+'Edit Page',
tooltip:'Add content to one single page.',
width:buttonWidth,
height:50
},
{
xtype:'spacer',
width:2
},
{
xtype:'button',
itemId:'template',
ref:'templateBtn',
text:'<img class="icon icon-mode-template" src="'+Ext.BLANK_IMAGE_URL+'"/>'+'Edit Template',
tooltip:'Add content to all pages using the same template.',
width:buttonWidth,
height:50
}
];
web.panels.Mode.superclass.initComponent.apply(this,arguments);
this.initListeners()
},
initListeners:function(){
var app=this.app,that=this;
this.on('afterlayout',function(){
var component=app.getSelected('component');
if(component&&!component.inPage()){
this.templateBtn.toggle(true,true)
}else{
this.pageBtn.toggle(true,true)
}
},this);
this.on('afterrender',function(){
var switchMode=new Ext.util.DelayedTask(function(mode){
app.fireEvent('mode',mode)
});
new Ext.dd.DropZone(this.el,{
ddGroup:'components',
scroll:false,
isTarget:false,
onContainerOver:function(source,e,data){
var target=e.getTarget('.mode-btn-tab'),mode=app.getMode();
if(target){
if(mode==='page'&&target.id===that.templateBtn.id){
switchMode.delay(300,null,null,['template'])
}else if(mode==='template'&&target.id===that.pageBtn.id){
switchMode.delay(300,null,null,['page'])
}
}
return source.dropNotAllowed||this.dropNotAllowed
},
onNodeOver:function(node,source,e,data){
return source.dropNotAllowed||this.dropNotAllowed
},
notifyEnter:function(source,e,data){
return source.dropNotAllowed||this.dropNotAllowed
}
})
},this);
this.on('destroy',function(){
Ext.dd.Registry.unregister(this.el)
},this);
this.mon(app,'mode',function(mode){
this.pageBtn.toggle(mode==='page');
this.templateBtn.toggle(mode==='template');
this.app.panels.components.fireEvent('modeChange',mode)
},this)
},
onChangeMode:function(btn){
var app=this.app,newMode=btn.itemId,oldMode=app.getMode(),isChange=oldMode!==newMode,next=isChange?newMode:null;
if(next){
app.fireEvent('mode',next);
app.track([
'Modes',
'switch',
next
])
}else{
btn.toggle(true)
}
}
});
Ext.ns('web.controllers');
Ext.ns('web.ui.tree');
web.ui.tree.SiteMapNode=Ext.extend(Ext.tree.TreeNode,{
constructor:function(config){
this.addEvents('settingsbtnclick');
web.ui.tree.SiteMapNode.superclass.constructor.call(this,config);
this.on('beforedblclick',function(node,ev){
return false
},this)
},
initListeners:function(nodeUI){
var el=nodeUI.getEl();
if(el.nodeName==='LI'){
var settingBtnEl=oneJQuery('.icon-web-buttons-togglemenu-small',el)[0];
if(!settingBtnEl){
return
}
Ext.fly(settingBtnEl).on('click',function(ev,target){
this.fireEvent('settingsbtnclick',this,ev,true)
},this)
}
},
toggleSelection:function(){
var ui=this.getUI();
ui.toggleMenu();
ui.onOut()
}
});
web.ui.tree.SiteMapNodeUI=Ext.extend(Ext.tree.TreeNodeUI,{
constructor:function(config){
web.ui.tree.SiteMapNodeUI.superclass.constructor.call(this,config);
this.isToggled=false
},
onOver:function(){
if(!this.nodePanel){
this.nodePanel=Ext.DomQuery.selectNode('.web-sitemap-node-panel',this.getEl())
}
this.addClass('x-tree-node-over')
},
onOut:function(){
if(!this.isToggled&&this.nodePanel){
this.removeClass('x-tree-node-over')
}
},
toggleMenu:function(){
this.isToggled=!this.isToggled;
if(this.isToggled){
this.addClass('x-tree-node-over')
}else{
this.removeClass('x-tree-node-over')
}
return this.isToggled
},
getNodeMenuHTML:function(){
return'<div class="web-sitemap-node-panel">'+'<div class="icon-web-buttons-togglemenu-small" ext:qtip="'+'Page options'+'"></div>'+'</div>'
},
renderElements:function(n,a,targetNode,bulkRender){
this.indentMarkup=n.parentNode?n.parentNode.ui.getChildIndent():'';
var shortText=Ext.util.Format.ellipsis(n.text,31);
var cb=Ext.isBoolean(a.checked),nel,cs,index,href=this.getHref(a.href),buf=[
'<li class="x-tree-node',
this.noDrag?' web-sitemap-nodrag':'',
'">',
'<div class="node-and-menu-wrapper">',
'<div ext:tree-node-id="',
n.id,
'" class="x-tree-node-el x-tree-node-leaf x-unselectable ',
a.cls,
'" style="overflow:hidden;position:relative;" unselectable="on">',
'<span class="x-tree-node-indent">',
this.indentMarkup,
'</span>',
'<img alt="" src="',
this.emptyIcon,
'" class="x-tree-ec-icon x-tree-elbow" />',
'<img alt="" src="',
a.icon||this.emptyIcon,
'" class="',
a.icon?' x-tree-node-inline-icon':'',
a.iconCls?' '+a.iconCls:'',
'" unselectable="on" />',
cb?'<input class="x-tree-node-cb" type="checkbox" '+(a.checked?'checked="checked" />':'/>'):'',
'<a hidefocus="on" class="x-tree-node-anchor" href="',
href,
'" tabIndex="1" ',
a.hrefTarget?' target="'+a.hrefTarget+'"':'',
'>',
'<span unselectable="on">',
shortText,
'</span>',
'</a>',
this.getNodeMenuHTML(),
'</div>',
'</div>',
'<ul class="x-tree-node-ct" style="display:none;"></ul>',
'</li>'
].join('');
if(bulkRender!==true&&n.nextSibling&&!!(nel=n.nextSibling.ui.getEl())){
this.wrap=Ext.DomHelper.insertHtml('beforeBegin',nel,buf)
}else{
this.wrap=Ext.DomHelper.insertHtml('beforeEnd',targetNode,buf)
}
this.elNode=this.wrap.firstChild.firstChild;
this.ctNode=this.wrap.childNodes[1];
cs=this.elNode.childNodes;
this.indentNode=cs[0];
this.ecNode=cs[1];
this.iconNode=cs[2];
index=3;
if(cb){
this.checkbox=cs[3];
this.checkbox.defaultChecked=this.checkbox.checked;
index+=1
}
this.anchor=cs[index];
this.textNode=cs[index].firstChild;
if(shortText!==n.text){
new Ext.ToolTip({
target:this.elNode,
trackMouse:true,
showDelay:250,
dismissDelay:0,
html:n.text
})
}
this.node.initListeners.call(this.node,this)
},
onSelectedChange:function(state){
var el=Ext.get(this.elNode.id);
if(state){
if(el){
el.scrollIntoView(Ext.DomQuery.selectNode('.web-sitemap-panel').id)
}
this.addClass('x-tree-selected');
this.addClass('web-sitemap-highlight-node')
}else{
this.removeClass('x-tree-selected');
this.removeClass('web-sitemap-highlight-node')
}
}
});
web.panels.WebSpaceLink=Ext.extend(Ext.Container,{
xtype:'web-link-web-space',
initComponent:function(){
var makeFileName=function(path){
return path.match(/[^\/]*$/)[0].match(/^[^\.]*/)[0]
};
this.defaultPath='/';
this.selectedFile=null;
this.items=[{
ref:'corefilecomp',
xtype:'web-ui-corefile',
width:740,
title:'External link - File',
app:this.app,
fileUploadStatus:this.fileUploadStatus,
showImagePreviewPanel:false,
listeners:{
fileselected:function(path){
this.selectedFile=path;
this.fnSynchronizeLinkTitle(path)
},
fileconfirmed:function(path){
this.selectedFile=path;
this.name.setValue(makeFileName(this.selectedFile));
this.ownerCt.ownerCt.ownerCt.onAddLinkFromWebSpace()
},
fileuploaded:function(asset){
this.selectedFile=asset.url;
this.name.setValue(makeFileName(this.selectedFile));
this.ownerCt.ownerCt.ownerCt.onAddLinkFromWebSpace()
},
directoryselected:function(path){
this.selectedFile=null
},
scope:this
}
}];
var pathToSimpleFileName=function(path){
return web.DAL.decodeHref(path.replace(/.*\//,'')).replace(/(?:\.[^\.]*)?$/,'')
};
this.fnSynchronizeLinkTitle=function(path){
var linkTitle=this.name;
var simpleFileName=pathToSimpleFileName(path);
var lastFileSelected=this.lastFileSelected;
if(linkTitle.getValue()===''||linkTitle.getValue()===lastFileSelected){
linkTitle.setValue(simpleFileName)
}
this.lastFileSelected=simpleFileName
};
web.panels.WebSpaceLink.superclass.initComponent.call(this)
},
doNotCallShowDefaultPath:false,
setValues:function(values){
var fileChooser=this.corefilecomp.fileChooser;
if(!values){
values={}
}
this.corefilecomp.enableMultiSelect(false);
this.corefilecomp.enableExtraFileName(true);
this.name=this.corefilecomp.extraFileName;
this.name.setValue(values.name);
if(values.mode==='edit'){
fileChooser.showPath(values.url);
this.doNotCallShowDefaultPath=true
}else{
if(fileChooser.el){
fileChooser.showPath(this.defaultPath)
}else{
var that=this;
fileChooser.on('afterrender',function(){
if(!that.doNotCallShowDefaultPath){
fileChooser.showPath(that.defaultPath)
}
})
}
}
}
});
Ext.reg('web-link-web-space',web.panels.WebSpaceLink);
web.panels.ExternalLink=Ext.extend(Ext.Container,{
xtype:'web-external-link',
initComponent:function(){
this.cls='vbox cross-stretch';
this.items=[
{
xtype:'container',
cls:'tab-h1 hbox cross-center',
html:'External link - URL'
},
{
xtype:'container',
cls:'extra-filename',
html:'Link title:'
},
{
ref:'name',
xtype:'textfield',
name:'name',
validator:function(value){
return!!value
},
style:{
width:'85%',
margin:'0 0 5px 30px'
}
},
{
xtype:'spacer',
height:5
},
{
xtype:'container',
cls:'extra-filename',
html:'Link to an external URL:'
},
{
ref:'url',
xtype:'textfield',
name:'url',
style:{
width:'85%',
margin:'0 0 5px 30px'
},
validator:function(value){
return web.data.links.LinkExternal.validate(value)
},
listeners:{
blur:function(t){
t.setValue(web.data.links.LinkExternal.compatibleEncodeURL(t.getValue()))
}
}
}
];
web.panels.ExternalLink.superclass.initComponent.call(this)
},
setValues:function(values){
values=values||{};
this.name.setValue(values.name||'');
this.url.setValue(values.url||'http://')
}
});
Ext.reg('web-external-link',web.panels.ExternalLink);
web.windows.SiteMapAddLink=Ext.extend(web.windows.Window,{
resizable:false,
modal:true,
initComponent:function(){
var that=this;
this.width=900;
this.height=580;
this.cls='web-window-link web-window-notitle';
this.bodyCssClass='vbox';
this.fileUploadStatus=new Ext.form.Label({
cls:'hbox cross-center',
style:'padding-top: 5px; padding-bottom: 1px;',
text:0+' of '+0+' uploaded'
});
this.items=[
{
xtype:'web-ui-tabpanel',
cls:'flex',
tabPosition:'west',
ref:'tabPanel',
defaults:{forceLayout:true},
activeTab:1,
autoHeight:true,
items:[
{
xtype:'web-link-web-space',
ref:'tabWebSpace',
title:'File',
tabTip:'Link to any page or file on your web space.',
app:this.app,
fileUploadStatus:this.fileUploadStatus
},
{
xtype:'web-external-link',
ref:'tabExternal',
title:'External URL',
tabTip:'Link to an external URL.'
}
],
listeners:{
tabchange:function(tabPanel,tab){
tab.doLayout();
that.app.windows.setWindowToCenter(that,{onlyIfOutsideView:true})
}
}
},
{
xtype:'container',
cls:'web-window-footer hbox cross-center',
items:[
{
xtype:'container',
cls:'vbox flex',
items:[
{
xtype:'checkbox',
ref:'../../openInNewTab',
name:'hrefTarget',
boxLabel:'Open in new window/tab.'
},
{
xtype:'checkbox',
ref:'../../hideFromMenu',
name:'hidden',
boxLabel:'Don\'t show in menus'
},
this.fileUploadStatus
]
},
{
xtype:'button',
cls:'x-btn-secondary large wide',
text:'Cancel',
ref:'../cancelButton',
listeners:{
click:function(btn,evt){
this.hide()
},
scope:this
}
},
{
xtype:'spacer',
width:20
},
{
xtype:'button',
cls:'x-btn-primary large wide',
text:'Save',
ref:'../addLinkButton',
listeners:{
click:function(btn,evt){
var tp=this.tabPanel;
if(tp.getActiveTabIndex()===0){
this.onAddLinkFromWebSpace()
}else{
this.onAddLinkFromURL()
}
},
scope:this
}
}
]
}
];
this.on('show',function(){
oneJQuery('[data-xtype=web-link-web-space]')[0].style.height='';
this.fileUploadStatus.hide()
});
web.windows.SiteMapAddLink.superclass.initComponent.call(this)
},
linkFrom:function(url){
if(this.values.newLink){
return null
}
if(url.indexOf('webspace:/')===0){
return'webSpace'
}else{
return'externalLink'
}
},
listeners:{
show:function(win){
var tp=this.tabPanel;
if(this.values.mode==='edit'&&this.linkFrom(this.values.url)==='webSpace'){
tp.setActiveTab(tp.tabWebSpace)
}else{
tp.setActiveTab(tp.tabExternal)
}
win.app.windows.setWindowToCenter(win)
}
},
setValues:function(values){
var tp=this.tabPanel;
this.values=values;
var linkFrom=this.linkFrom(values.url);
if(values.mode==='edit'){
if(linkFrom==='webSpace'){
this.tabPanel.tabExternal.setValues({});
this.tabPanel.tabWebSpace.setValues(values);
tp.setActiveTab(tp.tabWebSpace)
}else{
this.tabPanel.tabWebSpace.setValues({});
this.tabPanel.tabExternal.setValues(values);
tp.setActiveTab(tp.tabExternal)
}
this.openInNewTab.setValue(values.newTab||false);
this.hideFromMenu.setValue(values.hidden||false)
}else{
this.tabPanel.tabWebSpace.setValues({});
this.tabPanel.tabExternal.setValues({});
this.openInNewTab.setValue(false);
this.hideFromMenu.setValue(false);
tp.setActiveTab(1)
}
},
onAddLinkFromWebSpace:function(){
var that=this;
var tab=that.tabPanel.tabWebSpace;
var selectedFile=tab.selectedFile;
if(!selectedFile){
Ext.MessageBox.show({
title:'No file is selected',
msg:'Please select a file to be added as a link.',
cls:'web-modal-warning x-window-dlg',
iconCls:'web-warning-icon',
buttons:{ok:'OK'}
})
}else if(!tab.name.isValid()||tab.name.getValue()===''){
Ext.MessageBox.show({
title:'Link title is blank',
msg:'Please provide a link title.',
cls:'web-modal-warning x-window-dlg',
iconCls:'web-warning-icon',
buttons:{ok:'OK'}
})
}else{
that.hide();
that.fireEvent('ok',tab.name.getValue(),'webspace:'+selectedFile,this.openInNewTab.getValue(),this.hideFromMenu.getValue())
}
},
onAddLinkFromURL:function(){
var that=this;
var tab=that.tabPanel.tabExternal;
tab.url.setValue(web.data.links.LinkExternal.clean(tab.url.getValue()));
if(!tab.name.isValid()){
Ext.MessageBox.show({
title:'Link title is blank',
msg:'Please provide a link title.',
cls:'web-modal-warning x-window-dlg',
iconCls:'web-warning-icon',
buttons:{ok:'OK'}
})
}else if(!tab.url.isValid()){
Ext.MessageBox.show({
title:'Invalid URL',
msg:'Please enter a valid URL.',
cls:'web-modal-warning x-window-dlg',
iconCls:'web-warning-icon',
buttons:{ok:'OK'}
})
}else{
that.fireEvent('ok',tab.name.getValue().replace(/(<([^>]+)>)/gi,''),tab.url.getValue(),this.openInNewTab.getValue(),this.hideFromMenu.getValue());
that.hide()
}
}
});
Ext.NewButton=Ext.extend(Ext.BoxComponent,{
basecls:'web-ui-newbutton',
hidden:false,
disabled:false,
pressed:false,
enableToggle:false,
menuAlign:'tl-bl?',
type:'newbutton',
menuClassTarget:'button:first-child',
clickEvent:'click',
handleMouseEvents:true,
tooltipType:'qtip',
scale:'small',
iconAlign:'left',
arrowAlign:'right',
initComponent:function(){
if(this.menu){
if(Ext.isArray(this.menu)){
this.menu={items:this.menu}
}
if(Ext.isObject(this.menu)){
this.menu.ownerCt=this
}
this.menu=Ext.menu.MenuMgr.get(this.menu);
this.menu.ownerCt=undefined
}
Ext.NewButton.superclass.initComponent.call(this);
this.addEvents('click','toggle','mouseover','mouseout','menushow','menuhide','menutriggerover','menutriggerout');
if(Ext.isString(this.toggleGroup)){
this.enableToggle=true
}
},
getTemplateArgs:function(){
return[
this.type,
'x-btn-'+this.scale+' x-btn-icon-'+this.scale+'-'+this.iconAlign,
this.getMenuClass(),
this.cls,
this.id
]
},
setButtonClass:function(){
if(this.useSetClass){
if(!Ext.isEmpty(this.oldCls)){
this.el.removeClass([
this.oldCls,
'x-btn-pressed'
])
}
this.oldCls=this.iconCls||this.icon?this.text?'x-btn-text-icon':'x-btn-icon':'x-btn-noicon';
this.el.addClass([
this.oldCls,
this.pressed?'x-btn-pressed':null
])
}
},
getMenuClass:function(){
return this.menu?this.arrowAlign!=='bottom'?'x-btn-arrow':'x-btn-arrow-bottom':''
},
onRender:function(ct,position){
if(!this.template){
if(!Ext.NewButton.buttonTemplate){
Ext.NewButton.buttonTemplate=new Ext.Template('<button class="'+this.basecls+'" type="{0} {1} {2} {3}"></button>');
Ext.NewButton.buttonTemplate.compile()
}
this.template=Ext.NewButton.buttonTemplate
}
var btn,targs=this.getTemplateArgs();
if(position){
btn=this.template.insertBefore(position,targs,true)
}else{
btn=this.template.append(ct,targs,true)
}
this.btnEl=btn;
this.mon(this.btnEl,{
scope:this,
focus:this.onFocus,
blur:this.onBlur
});
this.initButtonEl(btn,this.btnEl);
Ext.NewButtonToggleMgr.register(this)
},
initButtonEl:function(btn,btnEl){
this.el=btn;
this.setIcon(this.icon);
this.setText(this.text);
this.setIconClass(this.iconCls);
if(Ext.isDefined(this.tabIndex)){
btnEl.dom.tabIndex=this.tabIndex
}
if(this.tooltip){
this.setTooltip(this.tooltip,true)
}
if(this.handleMouseEvents){
this.mon(btn,{
scope:this,
mouseover:this.onMouseOver,
mousedown:this.onMouseDown
})
}
if(this.menu){
this.mon(this.menu,{
scope:this,
show:this.onMenuShow,
hide:this.onMenuHide
})
}
if(this.repeat){
var repeater=new Ext.util.ClickRepeater(btn,Ext.isObject(this.repeat)?this.repeat:{});
this.mon(repeater,'click',this.onRepeatClick,this)
}else{
this.mon(btn,this.clickEvent,this.onClick,this)
}
},
afterRender:function(){
Ext.NewButton.superclass.afterRender.call(this);
this.useSetClass=true;
this.setButtonClass();
this.doc=Ext.getDoc();
this.doAutoWidth()
},
setIconClass:function(cls){
this.iconCls=cls;
if(this.el){
this.btnEl.dom.className=this.basecls;
this.btnEl.addClass([
'x-btn-text',
cls||''
]);
this.setButtonClass()
}
return this
},
setTooltip:function(tooltip,initial){
if(this.rendered){
if(!initial){
this.clearTip()
}
if(Ext.isObject(tooltip)){
Ext.QuickTips.register(Ext.apply({target:this.btnEl.id},tooltip));
this.tooltip=tooltip
}else{
this.btnEl.dom[this.tooltipType]=tooltip
}
}else{
this.tooltip=tooltip
}
return this
},
clearTip:function(){
if(Ext.isObject(this.tooltip)){
Ext.QuickTips.unregister(this.btnEl)
}
},
beforeDestroy:function(){
if(this.rendered){
this.clearTip()
}
if(this.menu&&this.destroyMenu!==false){
Ext.destroy(this.btnEl,this.menu)
}
Ext.destroy(this.repeater)
},
onDestroy:function(){
if(this.rendered){
this.doc.un('mouseover',this.monitorMouseOver,this);
this.doc.un('mouseup',this.onMouseUp,this);
delete this.doc;
delete this.btnEl;
Ext.NewButtonToggleMgr.unregister(this)
}
Ext.NewButton.superclass.onDestroy.call(this)
},
doAutoWidth:function(){
if(this.autoWidth!==false&&this.el&&this.text&&this.width===undefined){
if(Ext.isIE7&&Ext.isStrict){
var ib=this.btnEl;
if(ib&&ib.getWidth()>20){
ib.clip();
ib.setWidth(Ext.util.TextMetrics.measure(ib,this.text).width+ib.getFrameWidth('lr'))
}
}
if(this.minWidth){
if(this.el.getWidth()<this.minWidth){
this.el.setWidth(this.minWidth)
}
}
}
},
setHandler:function(handler,scope){
this.handler=handler;
this.scope=scope;
return this
},
setText:function(text){
this.text=text;
if(this.el){
this.btnEl.update(text||'&#160;');
this.setButtonClass()
}
this.doAutoWidth();
return this
},
setIcon:function(icon){
this.icon=icon;
if(this.el){
this.btnEl.setStyle('background-image',icon?'url('+icon+')':'');
this.setButtonClass()
}
return this
},
getText:function(){
return this.text
},
toggle:function(state,suppressEvent){
state=state===undefined?!this.pressed:!!state;
if(state!==this.pressed){
if(this.rendered){
this.el[state?'addClass':'removeClass']('x-btn-pressed')
}
this.pressed=state;
if(!suppressEvent){
this.fireEvent('toggle',this,state);
if(this.toggleHandler){
this.toggleHandler.call(this.scope||this,this,state)
}
}
}
return this
},
onDisable:function(){
this.onDisableChange(true)
},
onEnable:function(){
this.onDisableChange(false)
},
onDisableChange:function(disabled){
if(this.el){
this.el[disabled?'addClass':'removeClass'](this.disabledClass)
}
this.disabled=disabled
},
showMenu:function(){
if(this.rendered&&this.menu){
if(this.tooltip){
Ext.QuickTips.getQuickTip().cancelShow(this.btnEl)
}
if(this.menu.isVisible()){
this.menu.hide()
}
this.menu.ownerCt=this;
this.menu.show(this.el,this.menuAlign)
}
return this
},
hideMenu:function(){
if(this.hasVisibleMenu()){
this.menu.hide()
}
return this
},
hasVisibleMenu:function(){
return this.menu&&this.menu.ownerCt===this&&this.menu.isVisible()
},
onRepeatClick:function(repeat,e){
this.onClick(e)
},
onClick:function(e){
if(e){
e.preventDefault()
}
if(e.button!==0){
return
}
if(!this.disabled){
this.doToggle();
if(this.menu&&!this.hasVisibleMenu()&&!this.ignoreNextClick){
this.showMenu()
}
this.fireEvent('click',this,e);
if(this.handler){
this.handler.call(this.scope||this,this,e)
}
}
},
doToggle:function(){
if(this.enableToggle&&(this.allowDepress!==false||!this.pressed)){
this.toggle()
}
},
isMenuTriggerOver:function(e,internal){
return this.menu&&!internal
},
isMenuTriggerOut:function(e,internal){
return this.menu&&!internal
},
onMouseOver:function(e){
if(!this.disabled){
var internal=e.within(this.el,true);
if(!internal){
this.el.addClass('x-btn-over');
if(!this.monitoringMouseOver){
this.doc.on('mouseover',this.monitorMouseOver,this);
this.monitoringMouseOver=true
}
this.fireEvent('mouseover',this,e)
}
if(this.isMenuTriggerOver(e,internal)){
this.fireEvent('menutriggerover',this,this.menu,e)
}
}
},
monitorMouseOver:function(e){
if(e.target!==this.el.dom&&!e.within(this.el)){
if(this.monitoringMouseOver){
this.doc.un('mouseover',this.monitorMouseOver,this);
this.monitoringMouseOver=false
}
this.onMouseOut(e)
}
},
onMouseOut:function(e){
var internal=e.within(this.el)&&e.target!==this.el.dom;
this.el.removeClass('x-btn-over');
this.fireEvent('mouseout',this,e);
if(this.isMenuTriggerOut(e,internal)){
this.fireEvent('menutriggerout',this,this.menu,e)
}
},
focus:function(){
this.btnEl.focus()
},
blur:function(){
this.btnEl.blur()
},
onFocus:function(e){
if(!this.disabled){
this.el.addClass('x-btn-focus')
}
},
onBlur:function(e){
this.el.removeClass('x-btn-focus')
},
getClickEl:function(e,isUp){
return this.el
},
onMouseDown:function(e){
if(!this.disabled&&e.button===0){
this.getClickEl(e).addClass('x-btn-click');
this.doc.on('mouseup',this.onMouseUp,this)
}
},
onMouseUp:function(e){
if(e.button===0){
this.getClickEl(e,true).removeClass('x-btn-click');
this.doc.un('mouseup',this.onMouseUp,this)
}
},
onMenuShow:function(e){
if(this.menu.ownerCt===this){
this.menu.ownerCt=this;
this.ignoreNextClick=0;
this.el.addClass('x-btn-menu-active');
this.fireEvent('menushow',this,this.menu)
}
},
onMenuHide:function(e){
if(this.menu.ownerCt===this){
this.el.removeClass('x-btn-menu-active');
this.ignoreNextClick=this.restoreClick.defer(250,this);
this.fireEvent('menuhide',this,this.menu);
delete this.menu.ownerCt
}
},
restoreClick:function(){
this.ignoreNextClick=0
}
});
Ext.reg('newbutton',Ext.NewButton);
Ext.NewButtonToggleMgr=function(){
var groups={};
function toggleGroup(btn,state){
if(state){
var g=groups[btn.toggleGroup];
for(var i=0,l=g.length;i<l;i+=1){
if(g[i]!==btn){
g[i].toggle(false)
}
}
}
}
return{
register:function(btn){
if(!btn.toggleGroup){
return
}
var g=groups[btn.toggleGroup];
if(!g){
g=groups[btn.toggleGroup]=[]
}
g.push(btn);
btn.on('toggle',toggleGroup)
},
unregister:function(btn){
if(!btn.toggleGroup){
return
}
var g=groups[btn.toggleGroup];
if(g){
g.remove(btn);
btn.un('toggle',toggleGroup)
}
},
getPressed:function(group){
var g=groups[group];
if(g){
for(var i=0,len=g.length;i<len;i+=1){
if(g[i].pressed===true){
return g[i]
}
}
}
return null
}
}
}();
web.ui.TabPanel=Ext.extend(Ext.Container,{
cls:'web-ui-tabpanel',
activeItem:0,
tabPosition:'west',
tabWidth:158,
tabHeight:75,
constructor:function(cfg){
cfg=cfg||{};
var items=cfg.items||[],cls=this.cls+' '+cfg.cls;
delete cfg.items;
delete cfg.cls;
if(Ext.isNumber(cfg.activeItem)){
this.activeItem=cfg.activeItem;
delete cfg.activeItem
}
Ext.apply(this,cfg);
this.fixRefs(items);
this.toggleGroup='xxxxxxx'.replace(/x/g,function(m){
return(Math.random()*16|0).toString(16)
});
var isNorth=this.tabPosition==='north';
Ext.apply(this,{
cls:cls+' '+(isNorth?'vbox':'hbox'),
items:[
{
xtype:'container',
cls:'web-ui-tabpanel-tabstrip '+(isNorth?'hbox':'vbox'),
ref:'tabs',
items:items.map(function(item,i){
var title=item.title;
delete item.title;
return{
xtype:'newbutton',
cls:'web-ui-tabpanel-tab '+(item.tabCls?item.tabCls:''),
style:{
width:this.tabWidth+'px',
height:this.tabHeight+'px'
},
text:title,
toggleGroup:this.toggleGroup,
listeners:{click:this.setActiveTab.bind(this,i)}
}
},this).concat([{
xtype:'container',
cls:'web-ui-tabpanel-spacer flex',
style:{
width:isNorth?undefined:this.tabWidth+'px',
height:isNorth?this.tabHeight+'px':undefined
}
}])
},
{
xtype:'container',
layout:'card',
ref:'tabBox',
cls:'web-ui-tabpanel-panel flex',
activeItem:this.activeItem,
items:items
}
]
});
web.ui.TabPanel.superclass.constructor.apply(this,arguments)
},
fixRefs:function(items){
items.forEach(function(item){
if(Ext.isObject(item)&&!(item instanceof Ext.Component)){
if(item.ref){
item.ref='../'+item.ref
}
if(Ext.isArray(item.items)){
this.fixRefs(item.items)
}
}
},this)
},
initComponent:function(){
web.ui.TabPanel.superclass.initComponent.apply(this,arguments);
this.on('afterlayout',function(){
this.setActiveTab(this.activeItem)
},this)
},
getActiveTabIndex:function(){
return this.activeItem
},
activate:function(tab){
if(tab instanceof Ext.Component){
tab=this.tabBox.items.items.indexOf(tab)
}
if(Ext.isNumber(tab)&&tab>=0&&tab<this.tabBox.items.getCount()&&this.tabs.items.get(tab).isVisible()){
this.activeItem=tab;
this.tabs.items.get(this.activeItem).toggle(true,false);
this.tabBox.layout.setActiveItem(this.activeItem);
this.fireEvent('tabchange',this.tabBox,this.tabBox.items.items[tab])
}
},
setActiveTab:function(){
this.activate.apply(this,arguments)
},
hideTabStripItem:function(item){
if(item instanceof Ext.Component){
item=this.tabBox.items.items.indexOf(item)
}
if(Ext.isNumber(item)&&this.tabs.items.get(item)){
this.tabs.items.get(item).hide();
if(this.activeItem===item){
while(this.tabs.items.get(item).isVisible()){
item=(item+1)%this.tabBox.items.getCount()
}
this.setActiveTab(item)
}
}
},
unhideTabStripItem:function(item){
if(item instanceof Ext.Component){
item=this.tabBox.items.items.indexOf(item)
}
if(Ext.isNumber(item)&&this.tabs.items.get(item)){
this.tabs.items.get(item).show()
}
}
});
Ext.reg('web-ui-tabpanel',web.ui.TabPanel);
web.windows.PageProps=Ext.extend(web.windows.Window,{
type:'web.windows.PageProps',
initComponent:function(config){
var that=this;
this.SUPPRESS_PROTECTION=true;
Ext.apply(this,{
resizable:false,
width:900,
height:600,
cls:'web-page-properties web-window-notitle',
closeAction:'hide',
modal:true,
items:[
{
xtype:'web-ui-tabpanel',
tabPosition:'west',
ref:'tabPanel',
activeTab:0,
tabWidth:150,
height:490,
items:[
{
xtype:'container',
title:'Page names',
items:[
{
xtype:'container',
cls:'header tab-h1 hbox cross-center',
html:'Edit page names'
},
{
xtype:'container',
cls:'marL30',
html:'Page name in browser tab:'
},
{
xtype:'spacer',
height:5
},
{
xtype:'textfield',
style:'width: 480px',
cls:'marL30',
ref:'../../pageTitle',
validator:function(value){
this.isValidFlag=value.trim()?true:false;
that.fireEvent('validate');
return this.isValidFlag
},
scope:this
},
{
xtype:'spacer',
height:15
},
{
xtype:'container',
cls:'marL30',
html:'Page name in menu:'
},
{
xtype:'spacer',
height:5
},
{
xtype:'textfield',
style:'width: 480px',
cls:'marL30',
ref:'../../pageName',
validator:function(value){
value=web.utils.String.stripTags(value);
this.isValidFlag=value.trim()?true:false;
that.fireEvent('validate');
return this.isValidFlag
},
scope:this
},
{
xtype:'spacer',
height:45
},
{
xtype:'container',
cls:'marL30 hbox wrap cross-center',
buildCombinedErrorMessage:function(errors){
var combined=[];
errors.forEach(function(error){
combined.push(error.error)
});
return combined.join('<br />')
},
items:[
{
xtype:'displayfield',
ref:'../../../urlParentPath',
text:'?'
},
{
xtype:'textfield',
ref:'../../../url',
style:{margin:'0 12px'},
grow:true,
growMin:150,
growMax:300,
validator:function(value){
var selectedLink=that.selectedNode.attributes.item,homePageId=that.app.site.homePageId,match,validUrl,getByteLength=function(name){
return encodeURIComponent(name).replace(/%../g,'%').length
};
that.url.ownerCt.doLayout();
this.isValidFlag=false;
that.fireEvent('validate');
validUrl=!/[\/\\\?\*\:\|"<>]/.test(value);
if(validUrl){
match=selectedLink.getParent().getItems().some(function(link){
if(link&&link.getPageId&&link.getPageId()!==homePageId&&link!==selectedLink&&decodeURIComponent(link.getUrlFragment())===value){
return true
}
})
}
if(!validUrl){
return'These characters are not allowed:'+' / \\ ? % * : | " < >'
}else if(match){
return'Another page is using this URL. Please choose another.'
}else if(value==='index'&&(selectedLink.parent&&selectedLink.parent.name!=='[root]')){
return'Please choose a different URL.'
}else if(value.match(/\.html$/)){
return'Please choose a different URL.'
}else if(getByteLength(value+'.html')>255){
return'File name cannot be more than 255 characters long.'
}else if(getByteLength(this.scope._fullPath+'/'+value+'.html')>1000){
return'File path cannot be more than 1000 characters long.'
}else{
this.isValidFlag=true;
that.fireEvent('validate');
return true
}
},
scope:this
},
{
xtype:'displayfield',
ref:'../../../urlFileOrFolder',
text:'?'
}
]
},
{
xtype:'displayfield',
ref:'../../visitPageLink',
width:500,
cls:'marL30 visitpage-link',
urlTemplate:'<a class="standard-link" target=_blank href="{{link}}">'+'Visit page'+'</a>',
value:''
},
{
xtype:'spacer',
height:15
},
{
xtype:'container',
cls:'hbox cross-center',
hidden:true,
items:[
{
xtype:'container',
style:'width: 105px',
html:'Category'
},
{
xtype:'checkboxgroup',
width:480,
name:'category',
fieldLabel:'Category',
ref:'../../../categories',
columns:4,
items:[
{
boxLabel:'Blank',
name:'1'
},
{
boxLabel:'Landing',
name:'2'
},
{
boxLabel:'About',
name:'3'
},
{
boxLabel:'Gallery',
name:'4'
},
{
boxLabel:'Contact',
name:'5'
},
{
boxLabel:'News',
name:'6'
},
{
boxLabel:'CV',
name:'7'
},
{
boxLabel:'Portfolio',
name:'8'
},
{
boxLabel:'Shop',
name:'9'
},
{
boxLabel:'Pricelist/Menu',
name:'10'
},
{
boxLabel:'FAQ',
name:'11'
},
{
boxLabel:'Video',
name:'12'
}
],
listeners:{
change:function(){
this.fireEvent('validate')
},
scope:this
}
}
]
}
]
},
{
xtype:'container',
title:'SEO',
items:[
{
xtype:'container',
cls:'header tab-h1 hbox cross-center',
html:'Add SEO Info'
},
{
xtype:'container',
cls:'exclude-from-search-index marL30',
items:[
{html:'Website Builder automatically informs major search engines (Google and Bing etc.) about your site.'+'<br />'+'Adding a page description summarising what your site is about will increase advertising opportunities in search results.'},
{
xtype:'spacer',
height:10
},
{
xtype:'checkbox',
ref:'../../../excludeFromIndexing',
fieldLabel:'',
boxLabel:'&nbsp;'+'Exclude this page and its subpages from search engines',
listeners:{
check:function(){
this.fireEvent('validate')
},
scope:this
}
}
]
},
{
xtype:'container',
cls:'marL30',
html:'Page description'+':'
},
{
xtype:'spacer',
height:5
},
{
xtype:'textarea',
ref:'../../pageDescription',
cls:'seo-description marL30',
listeners:{
valid:function(){
this.fireEvent('validate')
},
scope:this
}
},
{
xtype:'container',
cls:'marL30',
layout:'hbox',
layoutConfig:{align:'middle'},
items:[{
xtype:'checkbox',
ref:'../../../descToSubpages',
cls:'marL30',
fieldLabel:'',
boxLabel:'&nbsp;'+'Apply to all subpages of this page',
anchor:'100%',
listeners:{
check:function(){
this.fireEvent('validate')
},
scope:this
}
}]
},
{
xtype:'spacer',
height:20
},
{
xtype:'container',
cls:'marL30',
html:'Keywords'+':'
},
{
xtype:'container',
cls:'marL30',
html:'Search engines no longer use keywords when indexing websites.'+'<br />'+'<b>'+'Tip:'+'</b>'+' '+'Add text to your pages that use the keywords you want your website to be found on.'
},
{
xtype:'textarea',
cls:'marL30',
anchor:'100%',
fieldLabel:'Keywords',
hidden:true
},
{
xtype:'checkbox',
fieldLabel:'',
style:'margin-left: 30px',
boxLabel:'&nbsp;'+'Apply to subpages of this page',
anchor:'100%',
hidden:true
}
]
},
{
xtype:'container',
title:'Hide Page',
layout:'form',
items:[
{
xtype:'container',
cls:'header tab-h1 hbox cross-center',
html:'Hide Page'
},
{
xtype:'container',
layout:'hbox',
cls:'marL30',
layoutConfig:{align:'middle'},
items:[{
xtype:'checkbox',
ref:'../../../hiddenPage',
boxLabel:'&nbsp;'+'Don\'t show in menus',
listeners:{
check:function(checkbox,checked){
if(!checked){
this.privatePage.setValue(false)
}
this.fireEvent('validate')
},
scope:this
}
}]
},
{
xtype:'container',
cls:'marL30',
items:[{
xtype:'displayfield',
value:'Hide the page and all of its subpages in your menus. The page is still active and you can link to it.'
}]
},
{
xtype:'spacer',
height:35
},
{
xtype:'container',
cls:'marL30',
layout:'hbox',
layoutConfig:{align:'middle'},
items:[{
xtype:'checkbox',
ref:'../../../privatePage',
boxLabel:'&nbsp;'+'Don\'t publish this page',
listeners:{
check:function(checkbox,checked){
if(checked){
this.hiddenPage.setValue(true)
}
this.fireEvent('validate')
},
scope:this
}
}]
},
{
xtype:'container',
cls:'marL30',
items:[{
xtype:'displayfield',
value:'Hide the page and all its subpages completely. The page will only be accessible from the Website Builder.'
}]
}
]
},
{
xtype:'container',
title:'Password Protection',
layout:'vbox',
layoutConfig:{align:'stretch'},
height:200,
items:[
{
xtype:'spacer',
height:10
},
{
xtype:'checkbox',
boxLabel:'&nbsp;'+'Protect with password'
},
{
xtype:'container',
layout:'hbox',
items:[
{
xtype:'spacer',
width:20
},
{
xtype:'label',
text:'Asks the visitor for a password, when accessing this page and all its subpages.'
}
]
},
{
xtype:'spacer',
height:10
},
{
xtype:'container',
layout:'hbox',
layoutConfig:{align:'middle'},
items:[
{
xtype:'spacer',
width:20
},
{
xtype:'label',
text:'Password:'
},
{
xtype:'spacer',
width:10
},
{
xtype:'textfield',
ref:'../../password',
disabled:true
}
]
}
]
}
]
},
{
xtype:'container',
cls:'web-window-footer hbox cross-center',
items:[
{
xtype:'container',
cls:'make-homepage',
ref:'../homePageText',
html:'<span class="icon icon-homepage"></span><span>'+'Make this page your Start Page'+'</span>'
},
{
xtype:'container',
items:[{
xtype:'checkbox',
ref:'../../homePage',
listeners:{
check:function(){
this.fireEvent('validate')
},
scope:this
}
}]
},
{
xtype:'spacer',
cls:'flex'
},
{
xtype:'container',
layout:'hflex',
items:[
{
xtype:'button',
cls:'x-btn-secondary large wide',
text:'Cancel',
listeners:{
click:function(){
this.hide()
},
scope:this
}
},
{
xtype:'spacer',
width:14
},
{
xtype:'button',
text:'Save',
cls:'x-btn-primary large wide',
ref:'../../saveButton',
listeners:{
click:this.onSave,
added:function(){
this.on('validate',function(){
this.activateSaveButton()
}.bind(this))
},
scope:this
}
}
]
}
]
}
]
});
web.windows.PageProps.superclass.initComponent.call(this,config);
if(this.SUPPRESS_PROTECTION){
this.on('beforeshow',function(){
this.tabPanel.hideTabStripItem(3)
},this)
}
this.on('show',function(){
try{
this.tabPanel.setActiveTab(0)
}catch(e){
}
setTimeout(function(){
that.url.ownerCt.doLayout()
},500)
},this);
this.tabPanel.on('tabchange',function(tabPanel,tab){
tab.doLayout()
},this);
this.addEvents('validate')
},
setValues:function(values){
this.previousValues=null;
this.selectedNode=values.selectedNode;
this.app=values.app;
this.controller=values.controller;
var that=this,homePageId,item=this.selectedNode.attributes.item,path=item.getUrlPath(),updateVisitLink,temp;
path=path.substring(0,path.lastIndexOf('/'));
this._fullPath=path;
path=this.app.dal.getDisplayDomain()+decodeURIComponent(path)+'/';
temp=path;
if(temp.length>40){
temp=temp.substring(0,40)+'...'
}
this.urlParentPath.setValue('<div title=\''+path+'\' style=\'padding-top:1px;\'>'+temp+'</div>');
Ext.QuickTips.init();
var registerTooltip=function(component,text){
Ext.QuickTips.register({
target:component.getEl(),
text:text
})
};
updateVisitLink=function(fileOrFolder){
var link='http://'+this.app.dal.getDomain()+item.getUrlPath()+fileOrFolder;
this.visitPageLink.setValue(this.visitPageLink.urlTemplate.replace(/{{link}}/,link))
};
homePageId=this.app.getSite().homePageId;
if(homePageId&&item.getPageId()===homePageId){
this.url.disable();
this.urlFileOrFolder.setValue('<div style=\'padding-top:1px;\'>.html</div>');
updateVisitLink.call(this,(item.getPageId()===homePageId?'/index':'')+'.html')
}else{
this.url.enable();
var fileName=item.items.length>0?'/':'.html';
this.urlFileOrFolder.setValue('<div style=\'padding-top:1px;\'>'+fileName+'</div>');
updateVisitLink.call(this,fileName)
}
if(this.selectedNode.parentNode.text==='[root]'){
this.homePageText.show();
this.homePage.show()
}else{
this.homePageText.hide();
this.homePage.hide()
}
if(!this.urlParentPath.rendered){
this.on('afterrender',registerTooltip.createDelegate(this,[
this.urlParentPath,
path
],false),this,{single:true})
}else{
registerTooltip(this.urlParentPath,path)
}
this.getAndStoreData(function(data){
that.setFormValues(Ext.apply({descToSubpages:false},data))
});
this.previousValues=this.getFormValues()
},
getAndStoreData:function(callback){
var selectedNode=this.selectedNode,item=selectedNode.attributes.item,pageId=item.pageId;
this.data={
pageName:item.name,
url:item.getUrlFragment(),
pageTitle:item.getTitle(),
pageDescription:item.getDescription(),
excludeFromIndexing:item.getRobots()==='noindex'?true:false,
hiddenPage:item.isHidden(),
privatePage:!item.isPublic(),
homePage:this.app.site.homePageId===item.getPageId(),
categories:item.getCatgories()
};
if(pageId===this.app.site.homePageId){
this.data.url='index'
}
callback(this.data)
},
applyMetaToSubpages:function(node,change){
var applyMeta=function(treeNode){
this.controller.changeMeta(treeNode,change)
},recursion=function(treeNode){
if(!treeNode.childNodes){
return
}
var i,childNode;
for(i=0;treeNode.childNodes&&(childNode=treeNode.childNodes[i]);i+=1){
applyMeta.call(this,childNode);
recursion.call(this,childNode)
}
};
recursion.call(this,node)
},
getFormValues:function(){
var selectedCategories=this.categories.getValue().map(function(item){
return item.getName()
});
return{
pageName:web.utils.String.stripTags(this.pageName.getValue()),
url:this.url.getValue(),
pageTitle:this.pageTitle.getValue(),
pageDescription:this.pageDescription.getValue(),
excludeFromIndexing:this.excludeFromIndexing.getValue(),
descToSubpages:this.descToSubpages.getValue(),
hiddenPage:this.hiddenPage.getValue(),
privatePage:this.privatePage.getValue(),
homePage:this.homePage.getValue(),
categories:selectedCategories
}
},
setFormValues:function(data){
Ext.iterate(data,function(key,value){
if(key==='url'){
value=decodeURIComponent(value)
}
if(key==='categories'){
this.categories.reset();
this.categories.eachItem(function(item){
value.forEach(function(val){
if(val===item.getName()){
item.setValue(true)
}
})
})
}else{
this[key].setValue(value)
}
},this)
},
onSave:function(){
var controller=this.controller,selectedNode=this.selectedNode,newData=this.getFormValues(),oldData=this.data,shouldSave=false;
if(!this.url.isValid()){
Ext.MessageBox.show({
title:'URL is already in use.',
cls:'web-modal-warning x-window-dlg',
iconCls:'web-warning-icon',
msg:'Please choose a different URL.',
buttons:Ext.MessageBox.OK
});
return false
}
this.body.mask();
if(newData.pageName!==oldData.pageName){
controller.rename(newData.pageName,selectedNode);
shouldSave=true
}
newData.url=encodeURIComponent(newData.url);
if(newData.url!==oldData.url){
if(newData.url==='index'){
if(selectedNode.parentNode.text==='[root]'){
controller.setHomePage(selectedNode)
}else{
one.error('Cant make a lower level page as a homepage')
}
}else{
controller.changeUrl(newData.url,selectedNode,true);
shouldSave=true
}
}
if(newData.pageTitle!==oldData.pageTitle||newData.pageDescription!==oldData.pageDescription||newData.excludeFromIndexing!==oldData.excludeFromIndexing||newData.categories.toString()!==oldData.categories.toString()){
controller.changeMeta(selectedNode,{
title:newData.pageTitle,
description:newData.pageDescription,
robots:newData.excludeFromIndexing?'noindex':'all',
categories:newData.categories
});
shouldSave=true
}
if(this.descToSubpages.getValue()===true){
this.applyMetaToSubpages(selectedNode,{description:newData.pageDescription});
shouldSave=true
}
if(newData.excludeFromIndexing!==oldData.excludeFromIndexing){
this.applyMetaToSubpages(selectedNode,{robots:newData.excludeFromIndexing?'noindex':'all'});
shouldSave=true
}
if(newData.hiddenPage!==oldData.hiddenPage){
controller.toggleHidden(selectedNode,true);
shouldSave=true
}
if(newData.privatePage!==oldData.privatePage){
controller.togglePublish(selectedNode,true);
shouldSave=true
}
if(newData.homePage!==oldData.homePage){
if(newData.homePage){
controller.setHomePage(selectedNode)
}else{
controller.unsetHomePage()
}
shouldSave=false
}
if(shouldSave){
this.app.fireEvent('update',selectedNode.attributes.item)
}
this.data=newData;
this.body.unmask();
this.hide()
},
activateSaveButton:function(){
var isValid,isChanged,enabled;
isValid=this.pageTitle.isValidFlag&&this.pageName.isValidFlag&&(this.url.isValidFlag||this.url.disabled);
isChanged=this.previousValues&&JSON.stringify(this.previousValues)!==JSON.stringify(this.getFormValues());
enabled=isValid&&isChanged;
this.saveButton.setDisabled(!enabled)
}
});
web.ui.TemplatePanel=Ext.extend(Ext.Container,{
xtype:'web-templatepanel',
imageGridInitialized:false,
page:[],
templates:[],
constructor:function(config){
var that=this;
that.app=config.app;
that.html='<div class="hbox cross-center template-panel"></div>';
that.emptyText='No templates found';
that.loadingHtml=oneJQuery('<div id="layoutLoadingList" class="hbox cross-center template-loading animated-loading-dots"><div></div></div>');
web.ui.TemplatePanel.superclass.constructor.call(that,config)
},
initComponent:function(){
var that=this;
that.store=new Ext.data.Store({
reader:new Ext.data.JsonReader({
idProperty:'id',
fields:[
'id',
'preview',
'pageId',
'templateId',
'stylesheetId',
'name',
'deletable',
'inUse',
'isPlaceholder',
'level',
'subPageIds',
'title'
]
})
});
web.ui.TemplatePanel.superclass.initComponent.apply(that,arguments)
},
renderPanel:function(){
var that=this,$=oneJQuery,templatePanel=$(that.el.dom).find('.template-panel');
templatePanel.append(that.loadingHtml);
that.destroyPanel();
that.$grid=$('<div class="image-grid"></div>');
templatePanel.append(that.$grid);
that.fetchUserTemplates(function(templates){
var arrImages=[];
templates.forEach(function(template){
arrImages.push({
imageId:template.id,
imageUrl:that.app.dal.getPreviewImageUrl(template.id,160,160,1280),
imageTitle:template.name
})
});
templatePanel.find('#layoutLoadingList').remove();
that.$grid.imageGrid();
that.imageGridInitialized=true;
that.$grid.imageGrid('loadImages',arrImages);
that.$grid.click(function(evt){
that.parent.setSaveButtonStatus(true)
});
that.$grid.dblclick(function(evt){
that.parent.updateTemplate()
});
that.enableLazyLoadingOfImages()
},that)
},
renderPanelEditMode:function(){
var that=this,$=oneJQuery,arrImages=[],templatePanel=$(that.el.dom).find('.template-panel');
that.previewTimer=null;
that.delay=200;
that.destroyPanel();
that.$grid=$('<div class="image-grid"></div>');
templatePanel.append(that.$grid);
that.templates.forEach(function(template){
var pageCount=that.getTemplatePageCount(template.id);
arrImages.push({
imageId:template.id,
imageUrl:that.app.dal.getPreviewImageUrl(template.id,160,160,1280),
imageTitle:template.name+(pageCount>0?'\n'+one.locale.trQuantity({
one:'Used by 1 page',
other:'Used by {0} pages'
},pageCount):''),
showDeleteBtn:0===pageCount,
preview:{
height:480,
width:360,
url:that.app.dal.getPreviewImageUrl(template.id,360,480,1280)
}
})
});
that.$grid.imageGrid({
buttons:[
{
cls:'btn-delete btn-buy',
showOnItemHover:false,
selectItemOnClick:true,
handler:function(evt){
var data=that.$grid.imageGrid('getSelectedImageData'),template=that.store.getById(data.imageId);
that.deleteTemplate(template,function(){
(evt.target||evt.srcElement).parentNode.style.display='none'
})
}
},
{
cls:'btn-duplicate btn-buy',
showOnItemHover:true,
selectItemOnClick:true,
html:'<div class="icon-duplicate"></div><div>'+'Duplicate'+'</div>',
handler:function(evt){
var data=that.$grid.imageGrid('getSelectedImageData'),template=that.store.getById(data.imageId);
that.duplicateTemplate(template)
}
},
{
cls:'btn-preview',
showOnItemHover:true,
selectItemOnClick:true,
html:'<div class="icon-preview"></div><div>'+'View'+'</div>'
}
],
hoverCallback:function(item){
},
hideImagePreview:function(noDelay){
clearTimeout(that.previewTimer);
clearTimeout(that.showTimer);
if(noDelay){
that.$imagePreview.fadeOut()
}else{
that.previewTimer=setTimeout(function(){
that.$imagePreview.fadeOut()
},200)
}
},
showImagePreview:function(evt,arrImageData){
var windowHeight=$(window).height(),windowWidth=$(window).width();
var previewUrl=arrImageData.preview.url,previewHeight=arrImageData.preview.height,previewWidth=arrImageData.preview.width,iconEl=$(evt.target).parent().find('.icon-preview'),position=iconEl.offset(),previewLeft=position.left+previewWidth>windowWidth?position.left-previewWidth:position.left+15,previewTop=position.top+previewHeight>windowHeight?position.top-(previewHeight+5):position.top+iconEl.parent().height();
if(previewTop+previewHeight>=windowHeight){
previewTop=previewTop-(previewTop+previewHeight-windowHeight);
previewTop-=50
}
previewTop=previewTop<0?0:previewTop;
if(previewUrl.length&&previewHeight&&previewWidth){
that.showTimer=setTimeout(function(){
that.$imagePreview.css({
'left':previewLeft+'px',
'top':previewTop+'px',
'height':previewHeight+'px',
'width':previewWidth+'px',
'border':'1px solid #7c7a7a',
'background-image':'url('+previewUrl+')'
}).fadeIn()
},300)
}
}
});
that.imageGridInitialized=true;
that.$imagePreview=$('<div class="usertemplate-preview"></div>').hide();
this.$imagePreview.hover(function(evt){
clearTimeout(that.previewTimer);
var parent=oneJQuery(evt.fromElement);
parent=parent.hasClass('image-grid-item')?parent:parent.closest('.image-grid-item');
that.parentEl=parent;
parent.find('.show-on-item-hover').css({display:'block'}).eq(0).css({opacity:0.8})
},function(evt){
that.$imagePreview.fadeOut();
that.parentEl.find('.show-on-item-hover').css({display:''}).closest('.overlay').css({opacity:''})
});
$('body').append(that.$imagePreview);
that.$grid.imageGrid('loadImages',arrImages);
that.enableLazyLoadingOfImages()
},
getTemplatePageCount:function(templateId){
var that=this,page=null,count=0;
that.pages.forEach(function(page){
count+=page.templateId===templateId?1:0
});
if(0===count){
page=that.app.dm.get(that.app.getSelected('page').id);
if(page&&page.getTemplateId()===templateId){
count=count+1
}
}
return count
},
getSelectedImageData:function(){
return this.$grid.imageGrid('getSelectedImageData')
},
destroyPanel:function(){
var that=this;
if(that.imageGridInitialized){
that.imageGridInitialized=false;
that.$grid.imageGrid('destroy');
oneJQuery(that.el.dom).find('.template-panel').html('')
}
},
enableLazyLoadingOfImages:function(){
var that=this,$=oneJQuery;
$(that.$grid).on('unsuccessful.lazy','div.image-wrapper',function(e){
$(e.target).trigger('appear')
}).find('div.image-wrapper').lazyload({container:that.$grid})
},
fetchUserTemplates:function(callback,scope){
var that=this;
that.app.dal.getList('web.data.components.Template',function(opts,success,response){
if(success){
that.templates=Ext.decode(response.responseText);
that.app.dal.getList('web.data.components.Page',function(opts,success,response){
if(success){
var pagesMap={},items=that.app.getSite().getFolder().getAllItems();
Ext.decode(response.responseText).map(function(page){
pagesMap[page.id]=page
});
delete that.pages;
that.pages=[];
items.forEach(function(item){
if(pagesMap[item.pageId]){
that.pages.push(pagesMap[item.pageId])
}
});
that.store.loadData(that.templates);
callback.call(scope,that.templates)
}
},that)
}
},that)
},
filterRecordsByType:function(records,recordType){
return records.filter(function(record){
return record.type===recordType
})
},
deleteTemplate:function(template,callback){
var that=this;
Ext.Msg.show({
title:'Delete template',
msg:'Are you sure you want to delete this template?',
cls:'web-modal-warning',
iconCls:'web-warning-icon',
buttons:Ext.MessageBox.OKCANCEL,
fn:function(buttonId){
if('ok'===buttonId){
that.app.dal.deletePart('web.data.components.Template',template.data.id,function(opts,success,response){
if(success){
that.app.dal.deletePart('web.data.styles.Stylesheet',template.data.stylesheetId,function(opts,success,response){
if(success){
that.templates=that.templates.filter(function(tpl){
return tpl.id!==template.data.id
});
that.store.remove(that.store.getById(template.id));
callback.apply(that)
}
},that)
}
},that)
}
}
})
},
duplicateTemplate:function(record){
var that=this,dal=that.app.dal,dm=that.app.dm,templateId=record.data.id,waitDuplicating;
waitDuplicating=Ext.Msg.wait('Duplicating template. Please wait.','Duplicating template');
dal.getWithDependents(templateId,'web.data.components.Template',function(opts,success,response){
if(success&&response.responseText){
var data=Ext.decode(response.responseText),copier=new web.utils.Copier,template=copier.copy(data.template),stylesheet=copier.copy(data.stylesheet);
template.name=that.fixTemplateName(record.data.id,record.data.name);
dal.set(dm.create(template),function(opts,success,response){
if(success){
var data=Ext.decode(response.responseText);
template.rev=data.rev;
template.etag=data.etag;
dal.set(dm.create(stylesheet),function(opts,success,response){
if(success){
var data=Ext.decode(response.responseText);
stylesheet.rev=data.rev;
stylesheet.etag=data.etag;
that.templates.push(template);
that.store.removeAll();
that.store.loadData(that.templates);
that.renderPanelEditMode();
waitDuplicating.hide()
}else{
one.error('<b>'+'Could not save template.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.')
}
},that)
}else{
one.error('<b>'+'Could not save template.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.')
}
},that)
}else{
waitDuplicating.hide();
one.error('<b>'+'Unable to get templates.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.')
}
},that)
},
fixTemplateName:function(tplId,tplName){
var that=this,matchFound=false,tmp=[],max=2,num=0,nameHasNum=/-\d+$/.test(tplName),tplNameRegex=new RegExp('^'+(nameHasNum?tplName.replace(/-\d+$/,''):tplName)+'\\-');
that.templates.forEach(function(tpl){
if(tplId!==tpl.id){
if(tplNameRegex.test(tpl.name)){
tmp=tpl.name.replace(tplNameRegex,'').match(/^\d+/);
num=tmp&&tmp.length?parseInt(tmp.pop(),10):0;
max=Math.max(num,max);
matchFound=true
}
}else{
matchFound=true;
if(nameHasNum){
num=parseInt(tplName.match(/\d+$/).pop(),10);
max=Math.max(max,num)
}
}
});
return matchFound?nameHasNum?tplName.replace(/\d+$/,max+1):tplName+'-'+(max+1):tplName
}
});
Ext.reg(web.ui.TemplatePanel.prototype.xtype,web.ui.TemplatePanel);
Ext.ns('web.commands.pages');
web.commands.pages.ChangeTemplate=Ext.extend(web.commands.Command,{
constructor:function(config){
this.page=config.page;
this.dm=config.dm;
this.template=config.template;
this.newTemplateChanged=false;
web.commands.pages.ChangeTemplate.superclass.constructor.call(this)
},
execute:function(){
this.prevState=this.page.getTemplateId();
this.page.setTemplate(this.template);
this.fireEvent('update',this.page)
},
undo:function(){
var prevState=this.page.getTemplateId(),template=this.template.dm.get(this.prevState);
this.page.setTemplate(template);
this.prevState=prevState;
this.fireEvent('update',this.page)
}
});
web.windows.TemplateList=Ext.extend(web.windows.Window,{
type:'web.windows.TemplateList',
cls:'web-window-notitle web-window-templatelist',
width:900,
height:630,
closeAction:'hide',
modal:true,
editMode:false,
constructor:function(config){
this.app=config.app;
this.parent=config.parent;
web.windows.TemplateList.superclass.constructor.call(this,config)
},
initComponent:function(){
var that=this;
that.items=[
{
xtype:'container',
cls:'tab-h1 hbox cross-center',
style:'border-bottom: 1px solid 1EFF1F0;',
items:[
{
xtype:'label',
ref:'../headerLabel',
html:'Your existing templates'
},
{
xtype:'spacer',
cls:'flex'
},
{
xtype:'button',
cls:'one-btn-bigstock-images x-btn-noicon',
ref:'../manageButton',
text:'Manage templates',
listeners:{
click:function(button){
that.enableEditMode()
}
}
},
{
xtype:'spacer',
width:28
}
]
},
{
xtype:'container',
cls:'sub-header',
items:[
{
xtype:'label',
ref:'../subHeaderLabel',
html:'Select the template for your page'
},
{
xtype:'spacer',
height:2,
cls:'bdr-btm'
},
{
xtype:'container',
items:[{
app:that.app,
parent:that,
xtype:'web-templatepanel',
ref:'../../templatepanel'
}]
}
]
},
{
xtype:'container',
cls:'web-window-footer hbox cross-center',
items:[
{
xtype:'spacer',
cls:'flex'
},
{
xtype:'button',
text:'Cancel',
ref:'../cancelBtn',
cls:'x-btn-secondary large wide',
listeners:{
click:function(){
if(true===that.editMode){
that.disableEditMode(true)
}else{
that.hide();
if(that.parent){
that.parent.show()
}
}
}
}
},
{
xtype:'spacer',
width:14
},
{
xtype:'button',
text:'Save',
ref:'../okBtn',
disabled:true,
cls:'x-btn-primary large wide',
listeners:{
click:that.updateTemplate,
scope:that
}
}
]
}
];
that.listeners={
show:function(){
var that=this;
that.disableEditMode(true)
},
hide:function(){
var that=this;
that.disableEditMode(false)
}
};
web.windows.TemplateList.superclass.initComponent.apply(that,arguments)
},
updateTemplate:function(){
var that=this,template;
if(true===that.editMode){
that.disableEditMode(true)
}else{
template=that.templatepanel.getSelectedImageData();
if(template){
that.app.dal.getWithDependents(template.imageId,'web.data.components.Template',function(opts,success,response){
if(success){
var data=Ext.decode(response.responseText);
if(that.parent){
that.parent.setTemplate(data.template)
}else{
var app=that.app,page=app.getSelected('page'),template=app.dm.create(data.template);
app.dm.create(data.stylesheet);
app.invoker.execute(new web.commands.pages.ChangeTemplate({
dm:app.dm,
page:page,
template:template
}));
app.fireEvent('activate','workspace');
this.app.fireEvent('select',template)
}
}
},that)
}
that.hide();
if(that.parent){
that.parent.show()
}
}
},
setValues:function(values){
},
setSaveButtonStatus:function(btnStatus){
var that=this;
that.okBtn.setDisabled(!btnStatus)
},
enableEditMode:function(){
var that=this;
that.editMode=true;
that.manageButton.hide();
that.templatepanel.renderPanelEditMode();
that.headerLabel.setText('Manage existing templates');
that.subHeaderLabel.setText('Duplicate to create new templates. Delete unused templates.');
that.okBtn.setText('OK');
that.setSaveButtonStatus(true)
},
disableEditMode:function(renderPanel){
var that=this;
that.editMode=false;
that.manageButton.show();
if(renderPanel){
that.templatepanel.renderPanel()
}else{
that.templatepanel.destroyPanel()
}
that.headerLabel.setText('Your existing templates');
that.subHeaderLabel.setText('Select the template for your page');
that.okBtn.setText('Save');
that.setSaveButtonStatus(false)
}
});
web.ui.tree.PageMenu=Ext.extend(Ext.Container,{
layout:'hflex',
layoutConfig:{align:'center'},
cls:'web-ui-tree-pagemenu',
node:null,
initComponent:function(){
this.addEvents('pagedatabtnclick','infobtnclick','deletebtnclick','startpagebtnclick','duppagebtnclick');
this.items=[
{
ref:'getAllPageDataBtn',
xtype:'container',
html:'<span class="icon-info" style="background-color:#f9fbf4;"></span>',
tooltip:'This opens a new page with the raw page data.',
hidden:true,
plugins:[new web.ui.plugins.DomObserver({
click:function(){
this.fireEvent('pagedatabtnclick')
},
scope:this
})]
},
{
xtype:'container',
html:'<span class="icon-addSubPage"></span>',
tooltip:'Duplicates the currently selected page.',
plugins:[new web.ui.plugins.DomObserver({
click:function(){
this.fireEvent('duppagebtnclick')
},
scope:this
})]
},
{
xtype:'container',
html:'<span class="icon-delete"></span>',
tooltip:'Permanently delete this page.',
plugins:[new web.ui.plugins.DomObserver({
click:function(){
this.fireEvent('deletebtnclick')
},
scope:this
})]
},
{
xtype:'container',
cls:'web-ui-tree-pagemenu-infobtn',
ref:'infoBtn',
html:'<span class="icon-info"></span>',
tooltip:'Page Info.',
plugins:[new web.ui.plugins.DomObserver({
click:function(){
this.fireEvent('infobtnclick')
},
scope:this
})]
}
];
web.ui.tree.PageMenu.superclass.initComponent.call(this);
this.on('afterrender',function(){
var quicktips=new Ext.QuickTip({target:this.getEl()});
this.items.items.forEach(function(item){
if(item.tooltip){
quicktips.register({
target:item.getEl().dom,
text:item.tooltip
})
}
},this)
},this)
},
deselectNode:function(){
if(this.node&&this.node.getUI()){
this.node.getUI().toggleMenu()
}
}
});
web.ui.tree.LinkMenu=Ext.extend(Ext.Container,{
layout:'hflex',
layoutConfig:{align:'center'},
cls:'web-ui-tree-linkmenu',
node:null,
initComponent:function(){
this.addEvents('linkinfobtnclick','linkdeletebtnclick');
this.items=[
{
xtype:'container',
html:'<span class="icon-delete"></span>',
tooltip:'Delete Link',
plugins:[new web.ui.plugins.DomObserver({
click:function(){
this.fireEvent('linkdeletebtnclick')
},
scope:this
})],
scope:this
},
{
xtype:'container',
html:'<span class="icon-info"></span>',
tooltip:'Link Info.',
plugins:[new web.ui.plugins.DomObserver({
click:function(){
this.fireEvent('linkinfobtnclick')
},
scope:this
})],
scope:this
}
];
this.listeners={
hide:this.deselectNode,
scope:this
};
web.ui.tree.LinkMenu.superclass.initComponent.call(this);
this.on('afterrender',function(){
var quicktips=new Ext.QuickTip({target:this.getEl()});
this.items.items.forEach(function(item){
if(item.tooltip){
quicktips.register({
target:item.getEl().dom,
text:item.tooltip
})
}
},this)
},this)
},
deselectNode:function(){
if(this.node&&this.node.getUI()){
this.node.getUI().toggleMenu()
}
}
});
web.ui.SiteMapTree=Ext.extend(Ext.tree.TreePanel,{
constructor:function(config){
this.app=config.app;
this.nodeUiProvider=config.nodeUiProvider;
this.pageMenu=new web.ui.tree.PageMenu;
this.linkMenu=new web.ui.tree.LinkMenu;
this.addEvents('pagedatabtnclick','infobtnclick','deletebtnclick','duppagebtnclick','startpagebtnclick','linkinfobtnclick','linkdeletebtnclick');
this.relayEvents(this.pageMenu,[
'pagedatabtnclick',
'infobtnclick',
'deletebtnclick',
'duppagebtnclick',
'startpagebtnclick'
]);
this.relayEvents(this.linkMenu,[
'linkinfobtnclick',
'linkdeletebtnclick'
]);
this.pagesToLinksMap={};
this.initTreeState();
config.bodyCssClass='web-sitemap-panel';
Ext.applyIf(config,this.treeConfig);
config.root=this.toTreeNodeConfig(this.app.site.getFolder());
config.listeners=config.listeners||{};
var listeners=config.listeners;
if(!listeners.settingsbtnclick){
listeners.settingsbtnclick=listeners.contextmenu=this.toggleMenu.bind(this)
}
web.ui.SiteMapTree.superclass.constructor.call(this,config);
this.on('afterrender',function(){
Ext.fly(document.body).on('click',this.closeMenu,this);
Ext.select('.web-sitemap-panel').on('click',this.closeMenu,this)
},this)
},
getPageMenu:function(){
return this.pageMenu
},
getLinkMenu:function(){
return this.linkMenu
},
onRender:function(){
web.ui.SiteMapTree.superclass.onRender.apply(this,arguments)
},
toTreeNodeConfig:function(link){
var cfg,items,node,htmlEncode=Ext.util.Format.htmlEncode;
cfg={
id:link.getId(),
iconCls:this.getNodeIconClass(link),
item:link,
expanded:true,
text:htmlEncode(link.getName()),
leaf:false,
isFolder:true,
cls:link.isHidden()?web.ui.SiteMapTree.Cls.HIDDEN:web.ui.SiteMapTree.Cls.REGULAR,
children:[]
};
if(!(link.getParent()instanceof web.data.Site)){
cfg.uiProvider=this.nodeUiProvider||web.ui.tree.SiteMapNodeUI;
if(link.getPageId){
this.pagesToLinksMap[link.getPageId()]=link.getId();
cfg.pageId=link.getPageId()
}
}
node=new web.ui.tree.SiteMapNode(cfg);
items=link.getItems();
items.forEach(function(item){
var children=item.getItems(),cfgChild={
id:item.getId(),
item:item,
expanded:true,
leaf:false,
isFolder:true,
text:htmlEncode(item.getName()),
cls:item.isHidden()?web.ui.SiteMapTree.Cls.HIDDEN:web.ui.SiteMapTree.Cls.REGULAR,
iconCls:this.getNodeIconClass(item),
children:[],
uiProvider:this.nodeUiProvider||web.ui.tree.SiteMapNodeUI
};
if(item.getPageId){
this.pagesToLinksMap[item.getPageId()]=item.getId();
cfgChild.pageId=item.getPageId()
}
if(children.length!==0){
node.appendChild(this.toTreeNodeConfig(item))
}else{
if(item instanceof web.data.links.LinkExternal){
cfgChild.allowChildren=false
}
if(!this.pagesOnly||item instanceof web.data.links.LinkPage){
node.appendChild(new web.ui.tree.SiteMapNode(cfgChild))
}
}
},this);
return node
},
refresh:function(){
if(this.app.site instanceof web.data.Site){
this.pagesToLinksMap={};
var nodeId,prevEl;
if(this.pageMenu.isVisible()){
prevEl=this.pageMenu.getEl()?this.pageMenu.getEl().prev():null;
nodeId=prevEl?prevEl.getAttribute('ext:tree-node-id'):null
}
var selectedNode=this.getSelectionModel().getSelectedNode();
this.setRootNode(this.toTreeNodeConfig(this.app.site.getFolder()));
this.expand();
if(selectedNode){
selectedNode=this.getNodeById(selectedNode.id);
if(selectedNode){
selectedNode.select()
}
}
if(nodeId){
var node=this.getNodeById(nodeId);
if(node){
var el=node.getUI().elNode;
el.parentNode.insertBefore(this.pageMenu.el.dom,el.parentNode.children[1])
}
}
}
},
initTreeState:function(){
var getExpanded=function self(node,expanded){
expanded=expanded||[];
node.childNodes.forEach(function(child){
if(child.isExpanded()){
expanded.push(child.id);
expanded=self(child,expanded)
}
},this);
return expanded
};
this.treeConfig=this.getTreeConfig();
Ext.apply(this.treeConfig,{
stateEvents:[
'collapsenode',
'expandnode'
],
getState:function(){
return{expandedNodes:getExpanded(this.root)}
}
})
},
getNodeByPageId:function(pageId){
return this.getNodeById(this.pagesToLinksMap[pageId])
},
getTreeConfig:function(){
return{
useArrows:true,
animate:false,
enableDD:false,
containerScroll:true,
border:false,
rootVisible:false,
titleCollapse:false,
selModel:new Ext.tree.DefaultSelectionModel({
listeners:{
beforeselect:function(selModel,newNode,oldNode){
return!(newNode.attributes.item instanceof web.data.links.LinkExternal)
},
scope:this
}
}),
dragConfig:{
scroll:false,
onDrag:function(){
var el=Ext.DomQuery.selectNode('.web-sitemap-node-panel',this.getDragEl());
el.style.display='none'
}
}
}
},
getActiveLink:function(){
return this.activeLink
},
setActiveLink:function(link){
this.activeLink=link
},
getNodeIconClass:function(link){
if(link instanceof web.data.links.LinkExternal){
if(link.isPublic&&!link.isPublic()){
return web.ui.SiteMapTree.Icons.EXTERNAL_HIDDEN
}
return web.ui.SiteMapTree.Icons.EXTERNAL
}else{
if(link.getPageId&&link.getPageId()===this.app.site.homePageId){
if(link.isPublic&&!link.isPublic()){
return web.ui.SiteMapTree.Icons.HOME_UNPUBLISHED
}else if(link.isHidden&&link.isHidden()){
return web.ui.SiteMapTree.Icons.HOME_HIDDEN
}
return web.ui.SiteMapTree.Icons.HOME
}else{
if(link.isPublic&&!link.isPublic()){
return web.ui.SiteMapTree.Icons.PAGE_UNPUBLISHED
}else if(link.isHidden&&link.isHidden()){
return web.ui.SiteMapTree.Icons.PAGE_HIDDEN
}
return web.ui.SiteMapTree.Icons.PAGE
}
}
return web.ui.SiteMapTree.Icons.PAGE
},
toggleMenu:function(node,e,toState){
var link=node.attributes.item,menu;
if(link instanceof web.data.links.LinkExternal){
menu=this.linkMenu;
if(this.pageMenu.rendered){
this.pageMenu.el.setWidth(0)
}
}else if(link instanceof web.data.links.LinkPage){
menu=this.pageMenu;
if(this.linkMenu.rendered){
this.linkMenu.el.setWidth(0)
}
}
if(menu){
var ui=node.getUI();
if(!ui){
return
}
var el=ui.elNode,dom,isOpen=menu.rendered&&menu.el.getWidth()>0;
if(e&&e.getTarget()===document.body&&!isOpen){
return
}
if(e&&e.getTarget()!==document.body){
e.stopPropagation()
}
if(!Ext.isBoolean(toState)){
toState=!isOpen
}
if(toState){
if(!menu.rendered){
menu.render(el)
}
dom=menu.el.dom;
el.parentNode.appendChild(dom);
oneJQuery(dom).stop(true,false);
dom.style.width='0px';
oneJQuery(dom).animate({width:dom.scrollWidth+'px'},400);
this.menuOnNode=node
}else{
dom=menu.el.dom;
oneJQuery(dom).animate({width:'0px'},400,'swing',function(){
el.parentNode.removeChild(dom)
});
this.menuOnNode=null
}
}
},
closeMenu:function(){
if(this.menuOnNode){
this.toggleMenu(this.menuOnNode,null,false)
}
}
});
web.ui.SiteMapTree.Cls={
HIDDEN:'web-hidden-item',
ACTIVE:'web-sitemap-selected',
REGULAR:'web-sitemap-regular',
HIDDENACTIVE:'web-selected-hidden-item'
};
web.ui.SiteMapTree.Icons={
HOME:'icon icon-tree-page-home',
HOME_HIDDEN:'icon icon-tree-page-home-hidden',
HOME_UNPUBLISHED:'icon icon-tree-page-home-unpublished',
PAGE:'icon icon-tree-page-normal',
PAGE_HIDDEN:'icon icon-tree-page-hidden',
PAGE_UNPUBLISHED:'icon icon-tree-page-unpublished',
EXTERNAL:'icon icon-tree-external-link',
EXTERNAL_HIDDEN:'icon icon-tree-external-link-hidden'
};
Ext.ComponentMgr.registerType('web-sitemaptree',web.ui.SiteMapTree);
Ext.tree.TreeNodeUI.prototype.updateExpandIcon=Ext.tree.TreeNodeUI.prototype.updateExpandIcon.createSequence(function(){
if(this.node.attributes.isFolder&&this.wasLeaf){
this.removeClass('x-tree-node-leaf');
this.addClass('x-tree-node-collapsed');
this.c1='x-tree-node-expanded';
this.c2='x-tree-node-collapsed';
this.wasLeaf=false
}
});
web.ui.LayoutPanel=Ext.extend(Ext.Container,{
xtype:'web-layoutpanel',
constructor:function(config){
this.app=config.app;
this.html='<div class="layout-panel"></div>';
this.selectHandler=config.selectHandler;
this.previewTimer=null;
this.showTimer=null;
this.delay=200;
this.loadingHtml=oneJQuery('<div id="layoutLoadingImage" class="animated-loading-dots"><div></div></div>');
this.emptyText='No results found for';
this.windowPopulated=true;
web.ui.LayoutPanel.superclass.constructor.call(this,config)
},
initComponent:function(){
this.listeners={
afterlayout:function(){
if(!this.windowPopulated){
this.clearAndUpdateSearchResults()
}
this.scrollToTop()
},
afterrender:function(){
this.renderLayoutPanel()
},
scope:this
};
web.ui.LayoutPanel.superclass.initComponent.apply(this,arguments)
},
getSelectedImageData:function(){
var selectedImageData=this.$grid.imageGrid('getSelectedImageData');
return selectedImageData
},
enableLazyLoadingOfImages:function(){
var that=this;
oneJQuery(that.$grid).on('unsuccessful.lazy','div.image-wrapper',function(e){
var target=oneJQuery(e.target),original=target.attr('data-original'),fallbackUrl=target.attr('data-original-fallback');
if(original!==fallbackUrl){
target.attr('data-original',fallbackUrl);
target.trigger('appear')
}
}).find('div.image-wrapper').lazyload({container:that.$grid})
},
updateSearchResults:function(cfg){
var that=this;
cfg.callback=cfg.callback||Ext.emptyFn;
cfg.scope=cfg.scope||window;
that.app.rep.get('web.data.Site','site',function(opts,success,response){
var filterFn=function(link){
var isSecondLevelPage=link.getLevel()===2;
if(link.isPublic()&&/^Layout/i.test(link.name)&&isSecondLevelPage){
return link
}
};
if(success){
var res=Ext.decode(response.responseText),dm=new web.DM,siteData=dm.create(res);
var linkPages=siteData.getFolder().getLinkPages(),arrImages=[],categories={};
linkPages=linkPages.filter(filterFn);
linkPages.forEach(function(item,i){
var key=item.categories[0]||'1',indx=item.name.replace('Layout - ','').split(' ')[1],name=indx&&!/^Layout - Empty/i.test(item.name)?web.ui.LayoutPanel.List[key]+' '+indx:web.ui.LayoutPanel.List[key],opts={
categoryName:web.ui.LayoutPanel.List[key],
imageId:item.pageId,
imageUrl:{
'0F019AEF-8C5A-43AF-B614-2305EB689551':'//webeditor-static.cdn-one.com/0F019AEF-8C5A-43AF-B614-2305EB689551.400a4bc1e1.png',
'231F2CD0-467D-48B6-8008-F002CCF23C9C':'//webeditor-static.cdn-one.com/231F2CD0-467D-48B6-8008-F002CCF23C9C.9a8640bbf7.png',
'42DA110F-C2FC-4BC5-B650-29D83DA5DA69':'//webeditor-static.cdn-one.com/42DA110F-C2FC-4BC5-B650-29D83DA5DA69.d132ace5c6.png',
'487C2B7E-7FD6-4F3A-9B9D-42D66E827B8B':'//webeditor-static.cdn-one.com/487C2B7E-7FD6-4F3A-9B9D-42D66E827B8B.fda966b844.png',
'4C04FBE5-A59B-46EC-96DB-3CA7178E3DCB':'//webeditor-static.cdn-one.com/4C04FBE5-A59B-46EC-96DB-3CA7178E3DCB.8dccbb7295.png',
'4EABE9C6-CDD8-44CF-8431-A58556597CEE':'//webeditor-static.cdn-one.com/4EABE9C6-CDD8-44CF-8431-A58556597CEE.8198020e88.png',
'53BCC831-9515-44B6-8D5B-BE54077E8259':'//webeditor-static.cdn-one.com/53BCC831-9515-44B6-8D5B-BE54077E8259.f0737d74db.png',
'615610D0-7767-49F7-99BA-CF89E21C2FA4':'//webeditor-static.cdn-one.com/615610D0-7767-49F7-99BA-CF89E21C2FA4.e8134e6700.png',
'6399C45A-4B58-49B4-9CC8-B2ADA3496D9B':'//webeditor-static.cdn-one.com/6399C45A-4B58-49B4-9CC8-B2ADA3496D9B.404d04f84b.png',
'6466F6C3-6526-4570-9ADB-43A1E3388203':'//webeditor-static.cdn-one.com/6466F6C3-6526-4570-9ADB-43A1E3388203.ed4aa38809.png',
'6844A05B-94F6-495D-B279-40A4615DA807':'//webeditor-static.cdn-one.com/6844A05B-94F6-495D-B279-40A4615DA807.6b02d8e633.png',
'76504E91-8EE8-43A6-8C19-9609CCE8BFF1':'//webeditor-static.cdn-one.com/76504E91-8EE8-43A6-8C19-9609CCE8BFF1.022cfe2f81.png',
'7E2E406E-8D4F-414C-9702-7EFBE6149CA9':'//webeditor-static.cdn-one.com/7E2E406E-8D4F-414C-9702-7EFBE6149CA9.f1fbf03c30.png',
'81EBB6A5-57E9-4732-82AD-974B4E4DB420':'//webeditor-static.cdn-one.com/81EBB6A5-57E9-4732-82AD-974B4E4DB420.ffa5765e98.png',
'87D84783-643E-445E-AE86-BC7B0CBB1F89':'//webeditor-static.cdn-one.com/87D84783-643E-445E-AE86-BC7B0CBB1F89.52afcf183f.png',
'8C758157-2A63-4509-9D8F-5936A765FB45':'//webeditor-static.cdn-one.com/8C758157-2A63-4509-9D8F-5936A765FB45.81c10ae6a0.png',
'8D08C78A-B6E4-4CDE-AA02-40C7500F05CB':'//webeditor-static.cdn-one.com/8D08C78A-B6E4-4CDE-AA02-40C7500F05CB.5ccd6776c2.png',
'92CD3822-B045-4A73-84B5-D2EB914E4732':'//webeditor-static.cdn-one.com/92CD3822-B045-4A73-84B5-D2EB914E4732.9b8f2fbca8.png',
'95CCE7A1-A5B7-42EE-844D-C07349D0E9E0':'//webeditor-static.cdn-one.com/95CCE7A1-A5B7-42EE-844D-C07349D0E9E0.1b2fb53964.png',
'990B68F0-30A1-4986-80AD-DBAEC052B032':'//webeditor-static.cdn-one.com/990B68F0-30A1-4986-80AD-DBAEC052B032.8dfe7c3717.png',
'9A0CD5A9-F468-4C59-B198-85AA96ED6814':'//webeditor-static.cdn-one.com/9A0CD5A9-F468-4C59-B198-85AA96ED6814.9aa9b7a666.png',
'9AE41064-E6CD-4815-AC0B-EE8CBA792795':'//webeditor-static.cdn-one.com/9AE41064-E6CD-4815-AC0B-EE8CBA792795.8ac6582a9c.png',
'9B148A07-0EE4-4075-9DBD-F9FF7D81B60A':'//webeditor-static.cdn-one.com/9B148A07-0EE4-4075-9DBD-F9FF7D81B60A.5d64572807.png',
'A398E154-2C32-4721-AC71-F44A0ACA57AC':'//webeditor-static.cdn-one.com/A398E154-2C32-4721-AC71-F44A0ACA57AC.34f72a90bd.png',
'AAE0B608-2724-415F-A038-3EDF5C2BDC67':'//webeditor-static.cdn-one.com/AAE0B608-2724-415F-A038-3EDF5C2BDC67.16adbc1ae1.png',
'B12A21B7-B2ED-4FEF-9316-B2E63CC81588':'//webeditor-static.cdn-one.com/B12A21B7-B2ED-4FEF-9316-B2E63CC81588.51543e734a.png',
'B46045EB-35CD-43AE-975D-FA64EEA73AD0':'//webeditor-static.cdn-one.com/B46045EB-35CD-43AE-975D-FA64EEA73AD0.eab5793403.png',
'B810E619-0EDF-4588-A3DB-1F9B8F6066EF':'//webeditor-static.cdn-one.com/B810E619-0EDF-4588-A3DB-1F9B8F6066EF.2b1278587b.png',
'C58F02A3-8657-444E-AD0F-51EA21472678':'//webeditor-static.cdn-one.com/C58F02A3-8657-444E-AD0F-51EA21472678.466d3d64f1.png',
'D426C155-B6EA-4607-98EC-0B7D1C1890E4':'//webeditor-static.cdn-one.com/D426C155-B6EA-4607-98EC-0B7D1C1890E4.265471db7d.png',
'D50A20F6-3B51-4210-B6A0-613C1A3AB626':'//webeditor-static.cdn-one.com/D50A20F6-3B51-4210-B6A0-613C1A3AB626.fc035d93dc.png',
'E47FD848-D7AC-4F2D-A759-28A57719E6AE':'//webeditor-static.cdn-one.com/E47FD848-D7AC-4F2D-A759-28A57719E6AE.a9f155811a.png',
'E8DB0F0D-0B96-4914-A381-A8D9F28B252D':'//webeditor-static.cdn-one.com/E8DB0F0D-0B96-4914-A381-A8D9F28B252D.c6310c8ca3.png',
'EEA665C1-C32D-451C-9600-A7E9AA1D0F87':'//webeditor-static.cdn-one.com/EEA665C1-C32D-451C-9600-A7E9AA1D0F87.7b5b2e0493.png',
'F0DD8728-EEF7-42BD-809C-BEAC8A05DF1A':'//webeditor-static.cdn-one.com/F0DD8728-EEF7-42BD-809C-BEAC8A05DF1A.420bf1122c.png',
'F8FAD337-9DDF-4ACA-B1DD-6D54419A2F2E':'//webeditor-static.cdn-one.com/F8FAD337-9DDF-4ACA-B1DD-6D54419A2F2E.45bc83a8dc.png',
'FA0531ED-A0F4-4703-BF71-E5EF66BC60F1':'//webeditor-static.cdn-one.com/FA0531ED-A0F4-4703-BF71-E5EF66BC60F1.35d057b82d.png'
}[item.pageId],
imageTitle:name,
preview:{
url:{
'0F019AEF-8C5A-43AF-B614-2305EB689551':'//webeditor-static.cdn-one.com/0F019AEF-8C5A-43AF-B614-2305EB689551.8868b6ba4a.png',
'231F2CD0-467D-48B6-8008-F002CCF23C9C':'//webeditor-static.cdn-one.com/231F2CD0-467D-48B6-8008-F002CCF23C9C.07b615741d.png',
'42DA110F-C2FC-4BC5-B650-29D83DA5DA69':'//webeditor-static.cdn-one.com/42DA110F-C2FC-4BC5-B650-29D83DA5DA69.c6cbb69c1b.png',
'487C2B7E-7FD6-4F3A-9B9D-42D66E827B8B':'//webeditor-static.cdn-one.com/487C2B7E-7FD6-4F3A-9B9D-42D66E827B8B.4c4170cdc3.png',
'4C04FBE5-A59B-46EC-96DB-3CA7178E3DCB':'//webeditor-static.cdn-one.com/4C04FBE5-A59B-46EC-96DB-3CA7178E3DCB.657d993fc8.png',
'4EABE9C6-CDD8-44CF-8431-A58556597CEE':'//webeditor-static.cdn-one.com/4EABE9C6-CDD8-44CF-8431-A58556597CEE.0c9cbcaa59.png',
'53BCC831-9515-44B6-8D5B-BE54077E8259':'//webeditor-static.cdn-one.com/53BCC831-9515-44B6-8D5B-BE54077E8259.a81ad3038c.png',
'615610D0-7767-49F7-99BA-CF89E21C2FA4':'//webeditor-static.cdn-one.com/615610D0-7767-49F7-99BA-CF89E21C2FA4.bf2eab108a.png',
'6399C45A-4B58-49B4-9CC8-B2ADA3496D9B':'//webeditor-static.cdn-one.com/6399C45A-4B58-49B4-9CC8-B2ADA3496D9B.3bbdd97c95.png',
'6466F6C3-6526-4570-9ADB-43A1E3388203':'//webeditor-static.cdn-one.com/6466F6C3-6526-4570-9ADB-43A1E3388203.5098b1b860.png',
'6844A05B-94F6-495D-B279-40A4615DA807':'//webeditor-static.cdn-one.com/6844A05B-94F6-495D-B279-40A4615DA807.98585916e7.png',
'76504E91-8EE8-43A6-8C19-9609CCE8BFF1':'//webeditor-static.cdn-one.com/76504E91-8EE8-43A6-8C19-9609CCE8BFF1.efebb2168a.png',
'7E2E406E-8D4F-414C-9702-7EFBE6149CA9':'//webeditor-static.cdn-one.com/7E2E406E-8D4F-414C-9702-7EFBE6149CA9.6d508ad11b.png',
'81EBB6A5-57E9-4732-82AD-974B4E4DB420':'//webeditor-static.cdn-one.com/81EBB6A5-57E9-4732-82AD-974B4E4DB420.52472bd6a6.png',
'8C758157-2A63-4509-9D8F-5936A765FB45':'//webeditor-static.cdn-one.com/8C758157-2A63-4509-9D8F-5936A765FB45.ae820e72c1.png',
'8D08C78A-B6E4-4CDE-AA02-40C7500F05CB':'//webeditor-static.cdn-one.com/8D08C78A-B6E4-4CDE-AA02-40C7500F05CB.b80291276e.png',
'92CD3822-B045-4A73-84B5-D2EB914E4732':'//webeditor-static.cdn-one.com/92CD3822-B045-4A73-84B5-D2EB914E4732.2ea1228d4b.png',
'95CCE7A1-A5B7-42EE-844D-C07349D0E9E0':'//webeditor-static.cdn-one.com/95CCE7A1-A5B7-42EE-844D-C07349D0E9E0.d7684510d6.png',
'990B68F0-30A1-4986-80AD-DBAEC052B032':'//webeditor-static.cdn-one.com/990B68F0-30A1-4986-80AD-DBAEC052B032.3400977832.png',
'9A0CD5A9-F468-4C59-B198-85AA96ED6814':'//webeditor-static.cdn-one.com/9A0CD5A9-F468-4C59-B198-85AA96ED6814.96203fb956.png',
'9AE41064-E6CD-4815-AC0B-EE8CBA792795':'//webeditor-static.cdn-one.com/9AE41064-E6CD-4815-AC0B-EE8CBA792795.702acad777.png',
'9B148A07-0EE4-4075-9DBD-F9FF7D81B60A':'//webeditor-static.cdn-one.com/9B148A07-0EE4-4075-9DBD-F9FF7D81B60A.903b0c7eb3.png',
'A398E154-2C32-4721-AC71-F44A0ACA57AC':'//webeditor-static.cdn-one.com/A398E154-2C32-4721-AC71-F44A0ACA57AC.a4d97ace36.png',
'AAE0B608-2724-415F-A038-3EDF5C2BDC67':'//webeditor-static.cdn-one.com/AAE0B608-2724-415F-A038-3EDF5C2BDC67.77d2d63cba.png',
'B12A21B7-B2ED-4FEF-9316-B2E63CC81588':'//webeditor-static.cdn-one.com/B12A21B7-B2ED-4FEF-9316-B2E63CC81588.391383d0e6.png',
'B46045EB-35CD-43AE-975D-FA64EEA73AD0':'//webeditor-static.cdn-one.com/B46045EB-35CD-43AE-975D-FA64EEA73AD0.e861046587.png',
'B810E619-0EDF-4588-A3DB-1F9B8F6066EF':'//webeditor-static.cdn-one.com/B810E619-0EDF-4588-A3DB-1F9B8F6066EF.ed46ab22bf.png',
'C58F02A3-8657-444E-AD0F-51EA21472678':'//webeditor-static.cdn-one.com/C58F02A3-8657-444E-AD0F-51EA21472678.4162742989.png',
'D426C155-B6EA-4607-98EC-0B7D1C1890E4':'//webeditor-static.cdn-one.com/D426C155-B6EA-4607-98EC-0B7D1C1890E4.09eea5aba5.png',
'D50A20F6-3B51-4210-B6A0-613C1A3AB626':'//webeditor-static.cdn-one.com/D50A20F6-3B51-4210-B6A0-613C1A3AB626.95fe835fbc.png',
'E47FD848-D7AC-4F2D-A759-28A57719E6AE':'//webeditor-static.cdn-one.com/E47FD848-D7AC-4F2D-A759-28A57719E6AE.bf5a888cd5.png',
'E8DB0F0D-0B96-4914-A381-A8D9F28B252D':'//webeditor-static.cdn-one.com/E8DB0F0D-0B96-4914-A381-A8D9F28B252D.8319d1f360.png',
'EEA665C1-C32D-451C-9600-A7E9AA1D0F87':'//webeditor-static.cdn-one.com/EEA665C1-C32D-451C-9600-A7E9AA1D0F87.4fe5120b08.png',
'F0DD8728-EEF7-42BD-809C-BEAC8A05DF1A':'//webeditor-static.cdn-one.com/F0DD8728-EEF7-42BD-809C-BEAC8A05DF1A.5813040a46.png',
'F8FAD337-9DDF-4ACA-B1DD-6D54419A2F2E':'//webeditor-static.cdn-one.com/F8FAD337-9DDF-4ACA-B1DD-6D54419A2F2E.ad53f8d0dc.png',
'FA0531ED-A0F4-4703-BF71-E5EF66BC60F1':'//webeditor-static.cdn-one.com/FA0531ED-A0F4-4703-BF71-E5EF66BC60F1.9325b350b7.png'
}[item.pageId]
},
hidePreviewBtn:/^Layout - Empty/i.test(item.name)
};
if(categories[key]){
categories[key].items.push(opts)
}else{
categories[key]={
categoryId:key,
items:[opts]
};
arrImages.push(categories[key])
}
});
that.loadingHtml.remove();
that.$grid.imageGrid('loadImages',arrImages);
that.$grid.imageGrid('selectFirstItem');
that.enableLazyLoadingOfImages();
cfg.callback.call(cfg.scope,true)
}else{
one.error('<b>'+'Unable to get templates.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.');
cfg.callback.call(cfg.scope,false)
}
},that)
},
clearSearchResults:function(){
this.$grid.imageGrid('clear')
},
clearAndUpdateSearchResults:function(){
this.clearSearchResults();
this.$grid.append(this.loadingHtml);
this.updateSearchResults({
callback:function(){
this.scrollToTop()
},
scope:this
})
},
scrollToTop:function(){
Ext.get(this.el.query('.image-grid')).scrollTo('top',0)
},
renderLayoutPanel:function(){
var that=this;
var $=oneJQuery;
var $layoutPanel=$(this.el.dom).find('.layout-panel');
var $grid=this.$grid=$('<div class="image-grid"></div>');
$layoutPanel.append($grid);
$grid.imageGrid({
multiSelect:false,
buttons:[{
cls:'btn-preview',
showOnItemHover:true,
selectItemOnClick:true,
html:'<div class="icon-preview"></div><div>'+'View'+'</div>'
}],
hideImagePreview:function(noDelay){
clearTimeout(that.previewTimer);
clearTimeout(that.showTimer);
if(noDelay){
that.$imagePreview.fadeOut()
}else{
that.previewTimer=setTimeout(function(){
that.$imagePreview.fadeOut()
},200)
}
},
showImagePreview:function(evt,arrImageData){
var windowHeight=$(window).height(),windowWidth=$(window).width();
var previewUrl=arrImageData.preview.url||'',previewHeight=440,previewWidth=460,iconEl=$(evt.target).parent().find('.icon-preview'),position=iconEl.offset(),previewLeft=position.left+previewWidth>windowWidth?position.left-previewWidth:position.left+iconEl.width(),previewTop=position.top+previewHeight>windowHeight?position.top-(previewHeight+5):position.top+iconEl.parent().height();
if(previewTop+previewHeight>=windowHeight){
previewTop=previewTop-(previewTop+previewHeight-windowHeight);
previewTop-=50
}
previewTop=previewTop<0?0:previewTop;
if(previewUrl.length&&previewHeight&&previewWidth){
that.showTimer=setTimeout(function(){
that.$imagePreview.css({
'left':previewLeft+'px',
'top':previewTop+'px',
'height':previewHeight+'px',
'width':previewWidth+'px',
'border':'1px solid #7c7a7a',
'transition':'width 200ms linear',
'background-image':'url('+previewUrl+')'
}).fadeIn()
},300)
}
}
});
this.$imagePreview=$('<div class="layout-image-preview"></div>').hide();
this.$imagePreview.hover(function(evt){
clearTimeout(that.previewTimer);
var parent=oneJQuery(evt.fromElement);
parent=parent.hasClass('image-grid-item')?parent:parent.closest('.image-grid-item');
that.parentEl=parent;
parent.find('.show-on-item-hover').css({display:'block'}).eq(0).css({opacity:0.8})
},function(evt){
that.$imagePreview.fadeOut();
that.parentEl.find('.show-on-item-hover').css({display:''}).closest('.overlay').css({opacity:''})
});
$grid.dblclick(function(item){
that.selectHandler(that.getSelectedImageData())
});
$grid.click(function(item){
that.selectHandler(null,!!oneJQuery(this).find('.selected').length)
});
$('body').append(this.$imagePreview);
this.clearAndUpdateSearchResults()
}
});
web.ui.LayoutPanel.List={
'1':'Blank page',
'2':'Landing page',
'3':'About',
'4':'Gallery',
'5':'Contact',
'6':'News',
'7':'CV',
'8':'Portfolio',
'9':'Webshop',
'10':'Price list & Menu',
'11':'FAQ',
'12':'Video'
};
Ext.reg(web.ui.LayoutPanel.prototype.xtype,web.ui.LayoutPanel);
web.windows.LinkFile=Ext.extend(web.windows.Window,{
type:'web.windows.LinkFile',
selectedFile:null,
initComponent:function(){
var that=this;
Ext.apply(that,{
cls:'web-windows-linkfile web-window-notitle',
resizable:false,
width:900,
closeAction:'hide',
modal:true,
items:[
{
xtype:'web-ui-corefile',
ref:'corefilecomp',
app:that.app,
showImagePreviewPanel:false,
listeners:{
fileselected:function(path){
that.selectedFile=path;
that.fireEvent('validate:ok',3);
that.okBtn.setDisabled(false)
},
filedeselected:function(){
that.okBtn.setDisabled(true)
},
fileconfirmed:function(path){
that.selectedFile=path;
that.onOK()
},
fileuploaded:function(asset){
that.selectedFile=asset.url;
that.onOK()
},
directoryselected:function(path){
that.selectedFile=null;
that.fireEvent('validate:error',3)
},
scope:that
}
},
{
xtype:'container',
cls:'web-window-footer hbox cross-center',
items:[
{
xtype:'spacer',
cls:'flex'
},
{
xtype:'button',
cls:'x-btn-secondary large wide',
text:'Cancel',
listeners:{
click:function(evt){
this.hide()
},
scope:this
}
},
{
xtype:'spacer',
width:14
},
{
xtype:'button',
ref:'../okBtn',
disabled:true,
cls:'x-btn-primary large wide',
text:'OK',
listeners:{
click:that.onOK,
scope:that
}
}
]
}
],
listeners:{
show:function(){
if(that.selectedFile){
that.corefilecomp.refreshFileChooser([that.selectedFile])
}else{
that.corefilecomp.refreshFileChooser()
}
that.corefilecomp.enableMultiSelect(false);
that.corefilecomp.doLayout();
that.corefilecomp.doLayout()
}
}
});
web.windows.LinkFile.superclass.initComponent.apply(this,arguments)
},
onOK:function(){
var that=this;
that.parent.setUrl('http://'+that.app.dal.getDomain()+that.selectedFile);
that.hide()
}
});
web.ui.tree.SiteLinksNodeUI=Ext.extend(web.ui.tree.SiteMapNodeUI,{
noDrag:true,
getNodeMenuHTML:function(){
return''
},
onOver:function(){
this.addClass('x-tree-node-over')
},
onOut:function(){
this.removeClass('x-tree-node-over')
}
});
web.windows.LinkPage=Ext.extend(web.windows.Window,{
type:'web.windows.LinkPage',
initComponent:function(){
var that=this;
that.tree=new web.ui.SiteMapTree({
app:that.app,
pagesOnly:true,
border:false,
cls:'tree-pages-list',
width:600,
height:435,
nodeUiProvider:web.ui.tree.SiteLinksNodeUI,
listeners:{
click:function(node,e){
that.pagePreview.loadPreview({node:node});
that.okBtn.setDisabled(false)
},
scope:that
}
});
that.pagePreview=new Ext.Container({
flex:1,
html:'',
loadPreview:function(cfg){
cfg=cfg||{};
var node=cfg.node,pageId=cfg.pageId||node&&node.attributes.pageId,url=pageId&&that.app.dal.getPagePreviewImageUrl(pageId)+'?width=240&height=333&zoom=0.22&cropw=240&croph=333';
this.update('<div class="loading-dots">'+'<div style="'+[
'width: 240px',
'height: 375px',
'background-image: url('+(url||'')+')',
'background-size: contain',
'background-repeat: no-repeat',
'background-position: 50% 50%'
].join(';')+'">'+'</div>'+'</div>')
},
app:that.app,
scope:that
});
that.treeSelect=that.tree.getSelectionModel();
Ext.apply(that,{
cls:'web-windows-linkpage',
title:'Link to a page',
resizable:false,
modal:true,
width:900,
height:600,
items:[
{
xtype:'container',
cls:'hbox flex',
items:[
this.tree,
this.pagePreview
]
},
{
xtype:'container',
cls:'web-window-footer hbox cross-center',
items:[
{
xtype:'spacer',
cls:'flex'
},
{
xtype:'button',
cls:'x-btn-secondary large wide',
text:'Cancel',
listeners:{
click:function(evt){
var that=this;
that.hide()
},
scope:that
}
},
{
xtype:'spacer',
width:14
},
{
xtype:'button',
cls:'x-btn-primary large wide',
disabled:true,
ref:'../okBtn',
text:'OK',
listeners:{
click:that.onOK,
scope:that
}
}
]
}
],
listeners:{
show:function(){
that.okBtn.setDisabled(true);
that.tree.getSelectionModel().clearSelections();
that.tree.refresh()
},
scope:that
}
});
web.windows.LinkPage.superclass.initComponent.apply(this,arguments)
},
onOK:function(){
var that=this,page=that.app.dm.get(that.treeSelect.getSelectedNode().id),urlPath=page.getUrlPath(),extension=0===urlPath.length||page.getAllItems().length>0?'':'.html';
that.parent.setUrl('http://'+that.app.dal.getDomain()+that.app.dm.get(page.id).getUrlPath()+extension,page.id);
that.hide()
}
});
web.windows.NewPage=Ext.extend(web.windows.Window,{
type:'web.windows.NewPage',
template:null,
resizable:false,
linkId:null,
initComponent:function(){
var that=this,tabHeight=514;
that.initialHref='http://';
that.selectedTemplate=that.app.getSelected('template');
that.openInNewTab=new Ext.form.Checkbox({boxLabel:'Open in new window'});
that.linkLabel=new Ext.form.Label({ref:'linkLabel'});
that.unlink=new Ext.Button({
itemId:'unlink',
tooltip:'Remove link',
cls:'props-panel-remove-button',
listeners:{
click:that.removeLink,
scope:that
}
});
that.hideFromMenu=new Ext.form.Checkbox({
boxLabel:'Do not publish link',
hidden:true
});
that.layoutTab={
xtype:'container',
itemId:'layout',
ref:'layoutTab',
title:'New page',
tabTip:'Add a new layout',
items:[{
xtype:'container',
height:tabHeight,
width:715,
items:[
{
xtype:'container',
cls:'tab-h1 hbox cross-center',
html:'Add a new blank page or choose a layout'
},
{
xtype:'container',
cls:'newpage-upgrade-note premium-link hbox cross-center upgrade-option',
html:'Note: Your current Website Builder can only publish up to 5 pages.'+'&nbsp; '+'<a href="#" class="newpage-upgrade-link" style="white-space:nowrap;">'+'<span class="no-free-upgrade-offer">'+'Upgrade to Premium'+'</span>'+'<span class="free-upgrade-offer">'+'Upgrade to Premium for free'+'</span>'+'</a>',
style:'font-size:13px;padding-left:5px;padding-right:10px;'
},
{
xtype:'container',
cls:'sublabel padLR20',
items:[{
xtype:'container',
cls:'vbox',
items:[
{
xtype:'container',
cls:'hbox',
items:[
{
xtype:'label',
ref:'../templateName',
html:'The new page will use the template '+('<span id="templateName">'+web.utils.String.ellipsis(that.app.getSelected('template').getName(),50)+'</span>')+'.'
},
{
xtype:'spacer',
width:3
},
{
xtype:'button',
cls:'one-link-btn ',
style:'margin: 0',
ref:'EditGlobalLinkStyles',
html:'<a href="#">'+'Change'+'</a>',
listeners:{
click:function(){
that.hide();
var templateWindow=that.app.windows.get('web.windows.TemplateList');
if(templateWindow){
templateWindow.win.parent=that;
templateWindow.win.show()
}else{
that.app.windows.show({
type:'web.windows.TemplateList',
app:that.app,
parent:that
})
}
}
}
}
]
},
{
xtype:'spacer',
height:10
},
{
xtype:'container',
cls:'hbox',
items:[
{
xtype:'label',
html:'Explore'
},
{
xtype:'spacer',
width:3
},
{
xtype:'button',
cls:'one-link-btn ',
style:'margin: 0',
html:'<a class="onecomtpl"  href="#">'+'One.com templates'+'</a>',
listeners:{
click:function(btn){
var link=that.app.site.getLink(that.app.getSelected('page').id);
that.app.request({
type:'newpageandtemplate',
parent:link.getParent(),
window:that
});
that.tabs.setActiveTab(0);
that.hide()
},
scope:that
}
}
]
}
]
}]
},
{
app:that.app,
xtype:'web-layoutpanel',
cls:'web-layoutpanel flex',
ref:'layoutpanel',
ownerWindow:that,
selectHandler:function(selected,addBtnState){
if(selected){
var app=that.app,link=app.site.getLink(app.getSelected('page').id);
app.request({
type:'newlayout',
parent:link.getParent(),
id:selected.imageId,
selectedTemplate:that.selectedTemplate
});
that.hide()
}else{
that.addBtn[addBtnState?'enable':'disable']()
}
}
}
]
}]
};
that.externalLinkTab={
xtype:'container',
itemId:'externallink',
ref:'externalLinkTab',
style:{'margin-left':'-14px'},
title:'Link',
tabTip:'Add a link to external URL',
items:[{
xtype:'container',
height:tabHeight,
items:[
{
xtype:'container',
cls:'tab-h1 hbox cross-center',
items:[
{
xtype:'spacer',
width:14
},
{
xtype:'label',
ref:'../addLinkTitle',
html:'Add a link in your site menu'
},
{
xtype:'spacer',
cls:'flex'
},
{
xtype:'button',
cls:'one-btn-link-to-file',
text:'Link to file',
listeners:{
click:function(evt){
that.app.windows.show({
type:'web.windows.LinkFile',
app:that.app,
parent:that
})
},
scope:that
}
},
{
xtype:'spacer',
width:14
},
{
xtype:'button',
cls:'one-btn-link-to-page',
text:'Link to page',
listeners:{
click:function(){
that.app.windows.show({
type:'web.windows.LinkPage',
app:that.app,
parent:that
})
},
scope:that
}
},
{
xtype:'spacer',
width:28
}
]
},
{
xtype:'container',
cls:'padLR20',
items:[
{
xtype:'spacer',
height:20
},
{
xtype:'container',
items:[{
xtype:'label',
html:'Link to'
}]
},
{
xtype:'spacer',
height:5
},
{
xtype:'container',
cls:'hbox cross-center',
items:[
{
ref:'../../hrefField',
name:'hrefField',
xtype:'textfield',
value:that.initialHref,
width:440,
validator:function(value){
var isValid=web.data.links.LinkExternal.validate(value);
that.addBtn[isValid?'enable':'disable']();
return isValid
},
listeners:{
change:function(){
that.linkId=null
},
blur:function(t){
t.setValue(web.data.links.LinkExternal.compatibleEncodeURL(t.getValue()))
}
}
},
that.linkLabel,
{
xtype:'spacer',
width:15
},
that.unlink
]
},
{
xtype:'container',
ref:'../linkTitleContainer',
items:[
{
xtype:'container',
items:[
{
xtype:'spacer',
height:20
},
{
xtype:'label',
html:'Link title'+':'
},
{
xtype:'spacer',
height:5
}
]
},
{
xtype:'container',
items:[{
xtype:'textfield',
ref:'../../../linkTitle',
name:'linkTitle',
width:440
}]
}
]
},
{
xtype:'spacer',
height:15
},
{
xtype:'container',
cls:'vbox',
items:[that.openInNewTab]
}
]
}
]
}]
};
Ext.apply(that,{
cls:'web-window-newpage web-window-notitle',
width:900,
height:630,
closeAction:'hide',
modal:true,
items:[
{
xtype:'web-ui-tabpanel',
cls:'flex',
tabPosition:'west',
ref:'tabs',
width:900,
listeners:{
tabChange:function(tabPanel,tab){
var app=that.app;
if('layout'===tab.itemId){
that.selectedTemplate=app.getSelected('template');
if(that.currentTab!=='Layout'){
that.tabs.layoutTab.layoutpanel.$grid.imageGrid('selectFirstItem');
that.addBtn.enable();
that.currentTab='Layout'
}
if(Object.keys(that.tabs.layoutTab.layoutpanel.getSelectedImageData()).length){
that.addBtn.enable()
}
Ext.get('templateName').dom.textContent=web.utils.String.ellipsis(that.selectedTemplate.getName(),50)
}else{
that.tabs.externalLinkTab.hrefField.validate();
that.currentTab='Link'
}
}
},
items:[
that.layoutTab,
that.externalLinkTab
]
},
{
xtype:'container',
cls:'web-window-footer hbox cross-center',
items:[
{
xtype:'container',
ref:'../externalLinkCB',
items:[
that.hideFromMenu,
{
xtype:'spacer',
height:4
},
{
xtype:'label',
text:'The link will not be published and will only exist in Website Builder.',
cls:'padLR20'
}
]
},
{
xtype:'spacer',
cls:'flex'
},
{
xtype:'button',
text:'Cancel',
cls:'x-btn-secondary large wide',
listeners:{
click:function(){
that.hide()
}
}
},
{
xtype:'spacer',
width:14
},
{
xtype:'button',
text:'Add',
ref:'../addBtn',
cls:'x-btn-primary large wide',
listeners:{
click:function(btn){
var activeTab=that.tabs.getActiveTabIndex(),externalLinkTab=that.tabs.externalLinkTab,linkTitle=externalLinkTab.linkTitle.getValue(),hrefField=externalLinkTab.hrefField.getValue();
if(0===activeTab){
var panel=that.tabs.layoutTab.layoutpanel,selected=panel.getSelectedImageData();
if(selected.imageId){
panel.selectHandler(selected)
}
}else if(1===activeTab){
if(0===hrefField.trim().length){
Ext.MessageBox.show({
title:'Invalid URL',
msg:'Please enter a valid URL.',
cls:'web-modal-warning x-window-dlg',
iconCls:'web-warning-icon',
buttons:{ok:'OK'}
});
return
}else if(0===linkTitle.trim().length){
Ext.MessageBox.show({
title:'Link title is blank',
msg:'Please provide a link title.',
cls:'web-modal-warning x-window-dlg',
iconCls:'web-warning-icon',
buttons:{ok:'OK'}
});
return
}
that.fireEvent('ok',oneJQuery.trim(linkTitle).replace(/(<([^>]+)>)/gi,''),hrefField,that.openInNewTab.checked,that.hideFromMenu.checked,that.linkId);
that.hide()
}
}
}
}
]
}
],
listeners:{
afterrender:function(){
this.resizeAndReposition();
this.app.on('resize',function(){
this.resizeAndReposition()
},this);
Ext.get(this.el.query('.newpage-upgrade-link')).on('click',function(){
web.upgradeToPremiumViaPopup({
app:this.app,
source:'NewPageWin:UpgradeLink'
})
},this)
},
show:function(){
if(that.mode&&'edit'===that.mode){
that.hideFromMenu.show();
that.externalLinkCB.show();
that.tabs.externalLinkTab.addLinkTitle.setText('Update link in site menu');
that.addBtn.setText('OK');
that.tabs.setActiveTab(1);
[
0,
1,
2
].forEach(function(tabIdx){
that.tabs.hideTabStripItem(tabIdx)
});
that.tabs.tabs.hide();
that.tabs.externalLinkTab.setWidth(880);
that.unlink.show();
that.linkLabel.show();
that.linkLabel.setText(that.tabs.externalLinkTab.hrefField.getValue());
that.tabs.externalLinkTab.hrefField.hide()
}else{
that.hideFromMenu.hide();
that.externalLinkCB.hide();
that.tabs.externalLinkTab.addLinkTitle.setText('Add a link in your site menu');
that.addBtn.setText('Add');
that.tabs.externalLinkTab.linkTitle.setValue('');
that.tabs.externalLinkTab.hrefField.setValue(that.initialHref);
that.openInNewTab.setValue(false);
that.hideFromMenu.setValue(false);
that.tabs.externalLinkTab.setWidth(742);
that.tabs.tabs.show();
[
0,
1,
2
].forEach(function(tabIdx){
that.tabs.unhideTabStripItem(tabIdx)
});
that.tabs.setActiveTab(0);
that.unlink.hide();
that.linkLabel.hide();
that.tabs.externalLinkTab.hrefField.show()
}
},
hide:function(){
that.linkLabel.hide();
that.unlink.hide();
that.tabs.externalLinkTab.hrefField.show()
},
scope:that
}
});
web.windows.NewPage.superclass.initComponent.apply(that,arguments)
},
resizeAndReposition:function(){
var position,width=900,height=630;
this.setSize(width,height);
position=this.el.getAlignToXY(this.container,'c-c');
this.setPosition(position[0],position[1])
},
setTemplate:function(template){
var that=this;
that.app.dm.unregister(template.id);
that.selectedTemplate=that.app.dm.create(template);
Ext.get('templateName').dom.textContent=web.utils.String.ellipsis(that.selectedTemplate.getName(),50)
},
setValues:function(values){
var that=this,domain=that.app.dal.getDomain(),action=null!==values.linkId&&Ext.isString(values.linkId)?that.app.dm.get(values.linkId):undefined;
that.mode=values.mode;
that.tabs.externalLinkTab.linkTitle.setValue(values.name);
values.url=null!==values.linkId&&Ext.isString(values.linkId)&&undefined!==action?'http://'+domain+action.getUrlPath():values.url;
that.setUrl(values.url,values.linkId);
that.openInNewTab.setValue(values.newTab||false);
that.hideFromMenu.setValue(values.hidden||false)
},
setUrl:function(url,linkId){
var that=this;
that.linkId=linkId;
if(linkId){
that.linkLabel.show();
that.linkLabel.setText(url);
that.unlink.show();
that.tabs.externalLinkTab.hrefField.hide()
}else{
that.linkLabel.hide();
that.unlink.hide();
that.tabs.externalLinkTab.hrefField.show()
}
that.tabs.externalLinkTab.hrefField.setValue(url)
},
showLinkTitlePrompt:function(title,callback){
var linkTitle=new Ext.form.TextField({
xtype:'textfield',
value:title,
width:300,
validator:function(value){
return oneJQuery.trim(value).length>0?true:false
}
});
var win=new Ext.Window({
modal:true,
layout:'form',
cls:'web-window-newpage-linktitle',
title:'Link title',
items:[
{
xtype:'container',
cls:'padLR20',
items:[
{
xtype:'spacer',
height:15
},
{
xtype:'container',
items:[{
xtype:'label',
html:'Add a title for the link'
}]
},
{
xtype:'spacer',
height:15
},
{
xtype:'container',
items:[linkTitle]
},
{
xtype:'spacer',
height:60
}
]
},
{
xtype:'container',
cls:'web-window-footer hbox cross-center',
items:[
{
xtype:'spacer',
cls:'flex'
},
{
xtype:'button',
cls:'x-btn-primary large wide',
text:'OK',
listeners:{
click:function(){
if(linkTitle.isValid()){
callback.call(window,linkTitle.getValue());
win.hide()
}
}
}
},
{
xtype:'spacer',
width:14
},
{
xtype:'button',
text:'Cancel',
cls:'x-btn-secondary large wide',
listeners:{
click:function(){
win.hide()
}
}
}
]
}
]
});
win.show();
linkTitle.focus()
},
removeLink:function(){
var that=this;
that.linkId=null;
that.linkLabel.hide();
that.unlink.hide();
that.tabs.externalLinkTab.hrefField.show();
that.tabs.externalLinkTab.hrefField.setValue('');
that.tabs.externalLinkTab.hrefField.focus()
}
});
web.controllers.SiteMap=function(model,view,app){
this.app=app;
this.model=model;
this.view=view;
this.view.mon(this.app,'update',function(part,opts){
if(part instanceof web.data.links.Link||part instanceof web.data.Site){
if(opts&&(opts.success||opts.failure)){
this.save(null,{
success:function(){
if(opts.success){
opts.success()
}
},
failure:function(){
if(opts.failure){
opts.failure()
}
}
})
}else if(opts&&opts.operation){
this.save(opts.operation)
}else{
this.save()
}
}
},this);
this.view.mon(this.app,'save',function(part,opts){
if(opts&&opts.saveFailed){
return
}
var page,node;
view=this.view;
if(part instanceof web.data.links.Link||part instanceof web.data.Site){
if(!opts||!opts.self){
view.refresh();
page=this.app.getSelected('page');
node=page?view.getNodeByPageId(page.getId()):null;
if(node){
view.getSelectionModel().select(node)
}
}
}
},this)
};
web.controllers.SiteMap.prototype={
getSelectedNode:function(){
return this.view.getSelectionModel().getSelectedNode()||this.view.root
},
save:function(operation,options){
options=options||{};
this.app.dal.set(this.app.site,function(opts,success){
if(!success){
this.app.fireEvent('save',this.app.site,{saveFailed:true});
if(options.failure){
options.failure();
return
}
one.error('Contact our support for further assistance if the problem persists.','Unable to save the site.')
}else{
this.app.fireEvent('save',this.app.site);
if(options.success){
options.success();
return
}
if(operation==='create-page'){
var site=this.app.site,pages=site.folder.getAllPages(),pageCount=pages.length;
if(pageCount===70||pageCount===80||pageCount===90){
Ext.Msg.show({
title:'Your page number is growing',
msg:'We appreciate that you are using Website Builder for your site!'+'<br/><br/>'+('Your site now has '+pageCount+' pages, and Website Builder is designed for sites up to 120 pages.'),
buttons:Ext.MessageBox.OK
})
}else if(pageCount===100||pageCount===105||pageCount===110||pageCount===115){
Ext.Msg.show({
title:'Your page number is high',
msg:'Website Builder is designed for sites up to 120 pages. You now have '+pageCount+' pages, and you are getting close to the recommended number of pages.'+'<br/><br/>'+'We recommend to delete existing pages before you add more pages.',
cls:'web-modal-warning',
iconCls:'web-warning-icon',
buttons:Ext.MessageBox.OK
})
}else if(pageCount>=120&&pageCount%3===0){
Ext.Msg.show({
title:'Your page number is too high',
msg:'Website Builder is designed for sites up to 120 pages. You now have '+pageCount+' pages and will experience that it takes longer time to publish.'+'<br/><br/>'+'We recommend deleting pages.',
cls:'web-modal-warning',
iconCls:'web-warning-icon',
buttons:Ext.MessageBox.OK
})
}
}
}
},this)
},
remove:function(node){
var item=node.attributes.item;
if(item instanceof web.data.links.LinkExternal){
Ext.Msg.show({
buttons:Ext.Msg.OKCANCEL,
cls:'web-modal-warning x-window-dlg',
iconCls:'web-warning-icon',
title:'Delete Link',
msg:'Delete this link?',
minWidth:240,
fn:function(buttonId){
if(buttonId==='ok'){
var parent=item.getParent();
parent.removeItem(item);
this.app.fireEvent('update',parent,{self:true});
this.view.getNodeById(node.id).remove()
}
},
scope:this
})
}
},
setHomePage:function(node){
var selected=node||this.getSelectedNode(),site=this.app.getSite(),homePageId=site.homePageId,linkId,homeLink;
if(homePageId){
homeLink=this.model.findLinkPage(homePageId);
if(homeLink){
linkId=homeLink.getId()
}
}
if(linkId){
this.view.getNodeById(linkId).setIconCls(web.ui.SiteMapTree.Icons.PAGE)
}
selected.setIconCls(web.ui.SiteMapTree.Icons.HOME);
site.set({homePageId:selected.attributes.item.getPageId()});
this.app.fireEvent('update',site);
if(this.app.windows.get('web.windows.PageProps')&&!this.app.windows.get('web.windows.PageProps').win.hidden){
this.app.windows.get('web.windows.PageProps').win.hide();
this.updatePageProperties()
}
},
unsetHomePage:function(){
var site=this.app.site,currentHomePageId=site.homePageId,currentHomePageNode;
if(currentHomePageId){
currentHomePageNode=this.view.getNodeByPageId(currentHomePageId);
if(currentHomePageNode){
currentHomePageNode.setIconCls(web.ui.SiteMapTree.Icons.PAGE)
}
}
site.set({homePageId:''});
this.app.fireEvent('update',site);
if(this.app.windows.get('web.windows.PageProps')&&!this.app.windows.get('web.windows.PageProps').win.hidden){
this.app.windows.get('web.windows.PageProps').win.hide();
this.updatePageProperties()
}
},
move:function(item,source,destination,index){
source.removeItem(item);
destination.addItem(item,index);
this.app.fireEvent('update',item,{self:true})
},
updatePageProperties:function(node){
node=node||this.getSelectedNode();
if(node.attributes.item instanceof web.data.links.LinkExternal){
return
}
this.app.windows.show({
type:'web.windows.PageProps',
values:{
selectedNode:node,
app:this.app,
controller:this
}
})
},
rename:function(text,selectedNode){
var data,treeNode=selectedNode||this.getSelectedNode(),node;
try{
data=this.app.dm.get(treeNode.id)
}catch(e){
one.warn('Unable to fetch node')
}
if(!data){
throw new Error('Unable to fetch node data')
}
data.set({'name':text});
node=this.view.getNodeById(treeNode.id);
this.view.suspendEvents();
node.setText(text);
this.view.resumeEvents()
},
toggleHidden:function(node){
var hidden,itemClasses=web.ui.SiteMapTree.Cls,iconClasses=web.ui.SiteMapTree.Icons,deselect=function(treeNode){
var selected=treeNode.attributes.item,linkId=selected.getId(),cls;
if(hidden===undefined){
hidden=!selected.isHidden()
}
selected.isHidden(hidden);
if(this.view.getActiveLink().getId()!==linkId){
this.view.getNodeById(linkId).getUI().removeClass(itemClasses.HIDDEN);
cls=hidden?itemClasses.HIDDEN:itemClasses.REGULAR
}else{
this.view.getNodeById(linkId).getUI().removeClass(web.ui.SiteMapTree.Cls.HIDDENACTIVE);
cls=hidden?web.ui.SiteMapTree.Cls.HIDDENACTIVE:web.ui.SiteMapTree.Cls.ACTIVE
}
treeNode.setCls(cls);
treeNode.setIconCls(hidden?iconClasses.PAGE_HIDDEN:iconClasses.PAGE)
},recursion=function(treeNode){
var i,len;
deselect.call(this,treeNode);
for(i=0,len=treeNode.childNodes.length;i<len;i+=1){
recursion.call(this,treeNode.childNodes[i])
}
};
recursion.call(this,node||this.getSelectedNode())
},
createExternalLink:function(node,sibling){
var treeNode=node||this.getSelectedNode(),sitemap;
if(sibling&&treeNode.parentNode){
treeNode=treeNode.parentNode
}
sitemap=treeNode.attributes.item;
this.app.windows.show({
type:'web.windows.NewPage',
values:{
newLink:true,
selectedNode:node
},
okFn:function(linkTitle,url,target,hideFromMenu,linkId){
var link=new web.data.links.LinkExternal({
id:Math.uuid(),
name:linkTitle,
url:url,
target:target?'_blank':'_self',
hidden:hideFromMenu,
linkId:linkId
});
sitemap.addItem(link);
treeNode.appendChild(new web.ui.tree.SiteMapNode({
id:link.getId(),
item:link,
leaf:true,
iconCls:hideFromMenu?web.ui.SiteMapTree.Icons.EXTERNAL_HIDDEN:web.ui.SiteMapTree.Icons.EXTERNAL,
text:linkTitle,
uiProvider:web.ui.tree.SiteMapNodeUI
}));
this.app.fireEvent('update',sitemap,{self:true})
},
scope:this
})
},
remapExternalLinks:function(node){
var linkPage='web.data.links.LinkPage';
if(linkPage===node.getType()){
var that=this,externalLinks=[],site=that.app.getSite(),domain=that.app.dal.getDomain();
externalLinks=site.getFolder().getItems().filter(function(item){
return'web.data.links.LinkExternal'===item.getType()
});
[node].concat(node.getAllItems().filter(function(subNode){
return linkPage===subNode.getType()
})).forEach(function(subNode){
externalLinks.forEach(function(externalLink){
if(externalLink.linkId&&externalLink.linkId===subNode.pageId){
externalLink.url='http://'+domain+subNode.getUrlpath()
}
})
})
}
},
updateExternalLink:function(node){
var link=node.attributes.item,sitemap=link.getParent(),url=link.getURL();
if(/^webspace:/.test(url)){
url='http://'+this.app.dal.getDomain()+url.replace(/^webspace:/,'')
}
this.app.windows.show({
type:'web.windows.NewPage',
values:{
name:link.getName(),
url:url,
newTab:link.getTarget()==='_blank',
linkId:link.getLinkId(),
hidden:link.isHidden(),
mode:'edit'
},
okFn:function(name,url,newTab,hidden,linkId){
link.set({
name:name,
url:url,
linkId:linkId,
target:newTab?'_blank':'_self',
hidden:hidden
});
node.setText(name);
this.app.fireEvent('update',sitemap)
},
scope:this
})
},
changeUrl:function(text,node){
var treeNode=node||this.getSelectedNode(),item=treeNode.attributes.item;
item.set({url:text})
},
togglePublish:function(node){
var link=node.attributes.item;
link.set({'public':!link.isPublic()})
},
changeMeta:function(node,change){
var treeNode=node||this.getSelectedNode(),item=treeNode.attributes.item;
item.set(change)
}
};
Ext.ns('web.ui.plugins.sitemap');
web.ui.plugins.sitemap.DragDrop=function(controller){
this.panel=null;
this.app=null;
this.controller=controller
};
web.ui.plugins.sitemap.DragDrop.prototype={
init:function(panel){
this.panel=panel;
this.app=panel.app;
this.initListeners()
},
initListeners:function(){
this.panel.mon(this.panel.tree,'movenode',function(tree,node,oldParent,newParent,index){
var link=node.attributes.item,source=oldParent.attributes.item,destination=newParent.attributes.item;
this.controller.move(link,source,destination,index);
this.controller.remapExternalLinks(link)
},this);
this.panel.mon(this.panel.tree,'nodedragover',function(ddEv){
var homePageId=this.app.getSite().homePageId,dropNode=ddEv.dropNode.attributes.item,target=ddEv.target.attributes.item;
var targetParent=target.getParent();
if(dropNode.getType()==='web.data.links.LinkExternal'){
return true
}else if(dropNode.getPageId()===homePageId){
if(ddEv.point==='append'){
return false
}else if(targetParent&&targetParent.name==='[root]'){
return true
}else{
return false
}
}else{
return true
}
},this)
}
};
web.utils.Array={
unique:function(array,key){
var cache={},uniques=[];
if(typeof key!=='undefined'){
return array.filter(function(item){
if(cache[item[key]]){
return false
}
cache[item[key]]=true;
return true
})
}else{
return array.filter(function(item){
if(uniques.indexOf(item)>-1){
return false
}
uniques.push(item);
return true
})
}
},
asyncProcessing:function(arr,scope,itemCallback,finalCallback,indexUnderExecution){
if(indexUnderExecution===undefined){
indexUnderExecution=-1
}
indexUnderExecution+=1;
if(indexUnderExecution===arr.length){
if(finalCallback){
finalCallback.call(scope,arr)
}
}else{
itemCallback.call(scope,arr[indexUnderExecution],indexUnderExecution,function(){
web.utils.Array.asyncProcessing(arr,scope,itemCallback,finalCallback,indexUnderExecution)
})
}
}
};
web.panels.SiteMap=Ext.extend(web.panels.Panel,{
title:'Pages',
xtype:'web-sitemap',
cls:'sitemap',
constructor:function(config){
this.tree=null;
this.lastMenu=null;
this.lastNode=null;
this.lastCheckedForMissingAssets=[];
web.panels.SiteMap.superclass.constructor.call(this,config)
},
initComponent:function(){
this.layout='fit';
this.tree=new web.ui.SiteMapTree(this.getTreeConfig());
this.items=[this.tree];
this.controller=new web.controllers.SiteMap(this.app.getSite().getFolder(),this.tree,this.app);
this.plugins=[new web.ui.plugins.sitemap.DragDrop(this.controller)];
web.panels.SiteMap.superclass.initComponent.apply(this,arguments)
},
refresh:function(){
this.tree.refresh()
},
initListeners:function(){
var currentPageId;
this.mon(this.app,'select',function(part){
var page,node,sm;
if(part instanceof web.data.components.Page){
this.app.googleWebFonts.initFonts(this.app.googleWebFonts.FONTS_LOADING_MODE.PAGE)
}
if(part instanceof web.data.Site||part instanceof web.data.components.Page){
page=this.app.getSelected('page');
if(page){
node=this.tree.getNodeByPageId(page.getId())
}
if(part instanceof web.data.Site||page&&!node){
this.refresh();
node=this.tree.getNodeByPageId(page.getId())
}
}else if(part instanceof web.data.links.LinkPage){
node=this.tree.getNodeById(part.getId())
}
if(node){
this.highlightActiveLink(node);
sm=this.tree.getSelectionModel();
sm.suspendEvents();
sm.select(node);
sm.resumeEvents();
if(node.attributes.pageId!==currentPageId){
currentPageId=node.attributes.pageId;
this.checkPageForMissingAssets(this.app.dm.get(currentPageId))
}
}
},this);
web.utils.Event.add(this.el.dom,'contextmenu',function(e){
e=e||window.event;
if(e.preventDefault){
e.preventDefault()
}
return false
});
web.utils.Event.add(window,'resize',function(){
if(this.app.windows.get('web.windows.PageProps')){
Ext.get(this.app.windows.get('web.windows.PageProps').win.el).center()
}
}.createDelegate(this))
},
getActivePageNode:function(){
var nodeId=this.tree.getPageMenu().el.dom.previousSibling.getAttribute('ext:tree-node-id');
return this.tree.getNodeById(nodeId)
},
getActiveLinkNode:function(){
var nodeId=this.tree.getLinkMenu().el.dom.previousSibling.getAttribute('ext:tree-node-id');
return this.tree.getNodeById(nodeId)
},
getTreeConfig:function(){
return{
app:this.app,
enableDD:true,
dropConfig:{
allowParentInsert:true,
allowContainerDrop:true
},
tbar:{
items:[{
app:this.app,
xtype:'button',
cls:'x-btn-text-icon newpage',
iconCls:'icon-newpage',
text:'New page',
handler:function(){
this.controller.createExternalLink(null,true)
},
scope:this
}]
},
listeners:{
click:function(node,event){
var link=node.attributes.item;
if(link.getPageId&&link!==this.tree.getActiveLink()){
this.app.request({
type:'page',
id:node.attributes.item.getPageId(),
incomplete:function(opts){
node.unselect()
},
scope:this
})
}
if(link instanceof web.data.links.LinkExternal){
this.controller.updateExternalLink(node)
}
},
afterrender:function(tree){
var sm=tree.getSelectionModel(),page=this.app.getSelected('page'),node=page?tree.getNodeByPageId(page.getId()):null;
if(node){
sm.suspendEvents();
sm.select(node);
sm.resumeEvents()
}
},
pagedatabtnclick:function(){
window.open(one.viewport.application.dal.defaultUrl+'/doc/web.data.components.Page/'+this.getActivePageNode().attributes.item.pageId+'?all=true')
},
infobtnclick:function(){
var node=this.getActivePageNode(),pageProp=this.app.windows.get('web.windows.PageProps');
if(pageProp&&pageProp.win.isVisible()&&pageProp.win.getSelectedNode()!==node){
pageProp.win.hide()
}
if(!pageProp||pageProp.win.hidden){
this.controller.updatePageProperties(node);
pageProp=this.app.windows.get('web.windows.PageProps');
pageProp.win.animate=true
}else{
pageProp.win.hide();
pageProp.win.animate=false
}
},
deletebtnclick:function(){
var node=this.getActivePageNode();
this.app.request({
type:'delete',
deleteLink:node.attributes.item
})
},
duppagebtnclick:function(){
var node=this.getActivePageNode();
this.app.request({
type:'newpage',
parent:node.parentNode.attributes.item
})
},
startpagebtnclick:function(){
var node=this.getActivePageNode();
if(node.attributes.item.getPageId()===this.app.site.homePageId){
this.controller.unsetHomePage()
}else{
this.controller.setHomePage(node)
}
},
linkinfobtnclick:function(){
var node=this.getActiveLinkNode(),pageProp=this.app.windows.get('web.windows.PageProps');
if(pageProp&&pageProp.win.isVisible()){
pageProp.win.hide()
}
this.controller.updateExternalLink(node)
},
linkdeletebtnclick:function(){
var node=this.getActiveLinkNode();
this.controller.remove(node)
},
scope:this
}
}
},
getTree:function(){
return this.tree
},
highlightActiveLink:function(node){
if(node){
var tree=this.tree,link=node.attributes.item,lastLink=tree.getActiveLink(),lastLinkUI,lastTreeNode=lastLink?tree.getNodeById(lastLink.getId()):null;
if(lastTreeNode){
lastLinkUI=lastTreeNode.getUI();
if(lastLink.isHidden()){
lastLinkUI.removeClass(web.ui.SiteMapTree.Cls.HIDDENACTIVE);
lastLinkUI.addClass(web.ui.SiteMapTree.Cls.HIDDEN)
}else{
lastLinkUI.removeClass(web.ui.SiteMapTree.Cls.HIDDEN);
lastLinkUI.removeClass(web.ui.SiteMapTree.Cls.ACTIVE)
}
}
if(node.attributes.item.isHidden()){
node.setCls(web.ui.SiteMapTree.Cls.HIDDENACTIVE)
}else{
node.setCls(web.ui.SiteMapTree.Cls.ACTIVE)
}
tree.setActiveLink(link)
}
},
filterRecentlyCheckedDirectories:function(directories){
var arrFiltered=[],currentTime=new Date().getTime(),i,entry,atTime;
for(i=0;i<directories.length;i+=1){
entry=this.lastCheckedForMissingAssets[directories[i]];
atTime=entry&&entry.atTime;
if(!(atTime&&currentTime-atTime<120000)){
arrFiltered.push(directories[i]);
this.lastCheckedForMissingAssets[directories[i]]={atTime:currentTime}
}
}
return arrFiltered
},
checkPageForMissingAssets:function(page){
if(!page){
return
}
var template=page.getTemplate(),assets=page.getAssets().concat(template.getAssets(),template.getStylesheet().getAssets()),dal=this.app.dal,directories={},missingAssets=[],error,domainServiceSuspended=false,progress;
assets=web.utils.Array.unique(assets,'url');
assets.forEach(function(asset){
var path=asset.url,components;
if(/^webspace:/.test(asset.url)){
components=path.split('/');
components.pop();
directories[components.join('/')+'/']=true
}
},this);
directories=web.utils.Object.keys(directories);
directories=this.filterRecentlyCheckedDirectories(directories);
progress=web.utils.Function.impede(directories.length,function(){
if(error){
if(error===502){
Ext.Msg.show({
title:'Server Error',
cls:'web-modal-warning x-window-dlg',
iconCls:'web-warning-icon',
msg:'The connection to your web space is currently down. We are working to fix it as soon as possible. Please try again later or contact our support for further assistance.',
buttons:Ext.Msg.OK
})
}else if(error===403&&domainServiceSuspended){
one.error('Access to the website\'s file system has been suspended for this domain.'+'<br /><br />'+'Please contact our support for further assistance.','Access suspended')
}
return
}
if(missingAssets.length){
this.app.windows.show({
type:'web.windows.MissingAssets',
persist:false,
values:{
pages:[{
pageId:page.id,
missingAssets:missingAssets
}]
}
});
this.app.track([
'MissingAssets',
'missing-'+missingAssets.length
])
}
},this);
directories.forEach(function(path){
var pathLength=path.length;
dal.getWebspaceContent(path.replace(/^webspace:/,''),function(opts,success,response){
var forgetDirectory=false;
var responseObject={};
try{
responseObject=Ext.decode(response.responseText)
}catch(e){
}
if(success){
var contents=responseObject.entries;
assets.forEach(function(asset){
if(path===asset.url.replace(/[^\/]+$/,'')){
var filename=asset.url.split('/').reverse()[0],numContents=contents.length,resource,i;
filename=filename.replace(/\?.*/,'');
for(i=0;i<numContents;i+=1){
if(web.DAL.decodeHref(contents[i].href)===web.DAL.decodeHref(filename)){
resource=contents[i];
break
}
}
if(!resource){
missingAssets.push({
url:asset.url,
statusCode:404
});
forgetDirectory=true
}
}
},this)
}else{
forgetDirectory=true;
if(response.status>=500){
error=response.status
}else if(response.status===404){
assets.forEach(function(asset){
if(path===asset.url.substr(0,pathLength)){
missingAssets.push({
url:asset.url,
statusCode:response.status
})
}
})
}else if(response.status===403){
if(responseObject.error==='Forbidden'&&responseObject.name==='ServiceSuspended'){
error=response.status;
domainServiceSuspended=true
}
}
}
if(forgetDirectory){
delete this.lastCheckedForMissingAssets[path]
}
progress()
},this)
},this)
}
});
Ext.ComponentMgr.registerType('web-sitemap',web.panels.SiteMap);
Ext.ns('web.ui.plugins.components');
Ext.ns('web.dd.creators');
web.dd.creators.Image=function(target,app){
this._initSize={
w:300,
h:200
};
this.ddel=target;
this.app=app;
this.component=this.app.dm.create({
type:'web.data.components.resources.Image',
width:this._initSize.w,
height:this._initSize.h
})
};
web.dd.creators.Image.prototype={
beforeDrop:function(cb,scope){
scope=scope||this;
this.app.windows.show({
type:'web.windows.Image',
values:{multiSelect:false},
okFn:function(win,selection){
var asset=selection.images[0],scale=1,w=asset.width||this._initSize.w,h=asset.height||this._initSize.h;
if(w>this._initSize.w||h>this._initSize.h){
if(w/this._initSize.w>h/this._initSize.h){
scale=this._initSize.w/w;
w=this._initSize.w;
h=h*scale
}else{
scale=this._initSize.h/h;
w=w*scale;
h=this._initSize.h
}
}
w=Math.min(Math.max(Math.round(w),1),this._initSize.w);
h=Math.min(Math.max(Math.round(h),1),this._initSize.h);
this.component.set({
asset:asset,
scale:scale,
dropWidth:w,
dropHeight:h
});
win.hide();
cb.call(scope)
},
cancelFn:function(win){
},
scope:this
})
}
};
web.dd.creators.ImageSlider=function(target,app){
this.ddel=target;
this.app=app;
this.component=this.app.dm.create({
type:'web.data.components.ImageSlider',
width:300,
height:200
})
};
web.dd.creators.ImageSlider.prototype={
beforeDrop:function(cb,scope){
scope=scope||this;
this.app.windows.show({
type:'web.windows.Image',
okFn:function(win,selection){
this.component.set({assets:selection.images});
win.hide();
cb.call(scope)
},
cancelFn:function(win){
},
values:{
multiSelect:true,
maxFiles:web.data.components.ImageSlider.MAX_IMAGES,
errorStrings:web.panels.props.ImageSlider.errorStrings
},
scope:this
})
}
};
web.dd.creators.Menu=function(target,app){
this.ddel=target;
this.app=app;
this.component=this.app.dm.create({
type:'web.data.components.Menu',
width:200,
height:80
})
};
web.dd.creators.Menu.prototype={
beforeDrop:function(cb,scope){
scope=scope||this;
var stylesheet=this.app.getSelected('stylesheet'),style=stylesheet.getClosestStyle('menu','menu');
this.component.set({
vertical:true,
level:1,
moreButtonEnabled:true,
moreText:'More',
horizontalAlign:'fit',
levelStyles:[{type:'web.data.styles.StyleMenu'}]
});
if(style){
this.component.getMenuStyle().set({globalId:style.getId()})
}
cb.call(scope)
}
};
web.dd.creators.Table=function(target,app){
var stylesheet=app.getSelected('stylesheet'),globalNormal=stylesheet.getStyleByRef('normal','StyleCell'),cfg={
type:'web.data.components.Table',
width:300,
height:200
};
this.ddel=target;
this.app=app;
cfg.table={
rows:10,
cols:3,
cellCfg:{style:{type:'web.data.styles.StyleCell'}}
};
if(globalNormal){
cfg.table.cellCfg.style.globalId=globalNormal.getId()
}
this.component=this.app.dm.create(cfg)
};
web.dd.creators.Video=function(target,app){
this.ddel=target;
this.app=app;
this.component=this.app.dm.create({
type:'web.data.components.Video',
width:300,
height:200
})
};
web.dd.creators.Video.prototype={
beforeDrop:function(cb,scope){
scope=scope||this;
this.app.windows.show({
type:'web.windows.video.Video',
okFn:function(videoProvider,url){
var result=this.component.initService(videoProvider,url);
if(result===true){
this.component.set({
href:'',
showInfo:true,
autoPlay:false,
repeat:false,
showControls:true
})
}
cb.call(scope);
if(result===true){
var comp=this.component;
if(comp.getWidth()){
comp.set({height:Math.max(comp.height,Math.ceil(comp.getWidth()*9/16))})
}
}
},
scope:this
})
}
};
web.panels.GoogleDocsWebSpace=Ext.extend(Ext.Container,{
xtype:'google-docs-web-space',
initComponent:function(){
this.selectedFile=null;
this.items=[{
xtype:'web-ui-corefile',
height:400,
width:740,
ref:'corefilecomp',
title:'Document list',
app:this.app,
fileUploadStatus:this.fileUploadStatus,
showImagePreviewPanel:false,
strings:{noFileSelected:'No file selected'},
listeners:{
fileselected:function(path){
this.selectedFile=path
},
fileconfirmed:function(path){
this.selectedFile=path;
this.ownerCt.ownerCt.ownerCt.onAddDocumentFromWebSpace()
},
fileuploaded:function(asset){
this.selectedFile=asset.url.replace(/^webspace:/,'');
this.ownerCt.ownerCt.ownerCt.onAddDocumentFromWebSpace()
},
directoryselected:function(path){
this.selectedFile=null
},
scope:this
}
}];
web.panels.GoogleDocsWebSpace.superclass.initComponent.call(this)
},
doNotCallShowDefaultPath:false,
setValues:function(values){
if(!values){
values={}
}
this.corefilecomp.enableMultiSelect(false);
var fileChooser=this.corefilecomp.fileChooser;
var props=Ext.apply({},values);
if(values.mode==='edit'){
fileChooser.showPath(props.url);
this.doNotCallShowDefaultPath=true
}else{
if(fileChooser.getCurrentPath()){
fileChooser.showPath(fileChooser.getCurrentPath())
}else if(fileChooser.el){
fileChooser.showDefaultPath()
}else{
var that=this;
fileChooser.on('afterrender',function(){
if(!that.doNotCallShowDefaultPath){
fileChooser.showDefaultPath()
}
})
}
}
},
onRefresh:function(paths){
this.corefilecomp.refreshFileChooser(paths)
}
});
Ext.reg('google-docs-web-space',web.panels.GoogleDocsWebSpace);
web.panels.GoogleDocsExternal=Ext.extend(Ext.Container,{
initComponent:function(){
this.layout='vflex';
this.modal=true;
this.items=[
{
cls:'tab-h1',
html:'Link to an external document'
},
{
xtype:'label',
style:'padding-left: 30px;',
html:'Link to an external URL:'
},
{
xtype:'textfield',
ref:'url',
name:'url',
width:440,
style:'margin:5px 0 0 30px;',
validator:function(value){
return web.data.links.LinkExternal.validate(value)
}
},
{
xtype:'spacer',
flex:1
}
];
web.panels.GoogleDocsExternal.superclass.initComponent.call(this)
},
setValues:function(values){
values=values||{};
this.url.setValue(values.url||'http://')
}
});
Ext.reg('google-docs-external',web.panels.GoogleDocsExternal);
web.windows.GoogleDocsViewer=Ext.extend(web.windows.Window,{
resizable:false,
initComponent:function(){
var that=this,component=this;
this.width=900;
this.height=608;
this.modal=true;
this.cls='web-window-link web-window-notitle';
this.bodyCssClass='vbox';
this.fileUploadStatus=new Ext.form.Label({
cls:'hbox cross-center',
style:'padding-top: 5px; padding-bottom: 1px;',
text:0+' of '+0+' uploaded'
});
this.items=[
{
xtype:'web-ui-tabpanel',
cls:'flex',
tabPosition:'west',
ref:'tabPanel',
defaults:{forceLayout:true},
activeTab:0,
autoHeight:true,
items:[
{
xtype:'google-docs-web-space',
ref:'tabWebSpace',
title:'File',
tabTip:'Link to any page or file on your web space.',
app:this.app,
fileUploadStatus:this.fileUploadStatus,
listeners:{
'added':function(){
var webspace=this;
component.on('refresh',function(event){
var paths=component.values.mode==='edit'?component.values:undefined;
if(event.tab!=='tabWebSpace'){
return
}
webspace.onRefresh(Ext.pluck(paths,'url'))
})
}
}
},
{
xtype:'google-docs-external',
ref:'tabExternal',
title:'External URL',
tabTip:'Link to an external URL.',
width:700
}
],
listeners:{
'tabchange':function(tabPanel,tab){
tab.doLayout();
that.app.windows.setWindowToCenter(that,{onlyIfOutsideView:true});
that.addDocumentButton.disable();
if(0===tabPanel.items.items.indexOf(tab)&&null!==that.tabPanel.tabWebSpace.selectedFile){
that.addDocumentButton.enable()
}else if(1===tabPanel.items.items.indexOf(tab)&&that.tabPanel.tabExternal.url.isValid()){
that.addDocumentButton.enable()
}
},
'added':function(){
var tabPanel=this;
component.on('refresh',function(event){
tabPanel.setActiveTab(tabPanel[event.tab])
})
}
}
},
{
xtype:'container',
cls:'web-window-footer hbox cross-center',
items:[
{
xtype:'container',
cls:'flex vbox',
items:[
{
xtype:'label',
html:'By inserting a document, you accept <a class="standard-link" href="https://support.google.com/docs/answer/2450387?hl=en&amp;ref_topic=2428743&amp;vid=1-635789438677039180-2442008254" target="_blank">Google Docs Viewer Terms of Service</a>.'
},
this.fileUploadStatus
]
},
{
xtype:'button',
cls:'x-btn-secondary large wide',
text:'Cancel',
ref:'../cancelButton',
listeners:{
click:function(btn,evt){
this.hide()
},
scope:this
}
},
{
xtype:'spacer',
width:14
},
{
xtype:'button',
cls:'x-btn-primary large wide',
style:{minWidth:'90px'},
ref:'../addDocumentButton',
text:'Save',
disabled:true,
listeners:{
click:function(btn,evt){
if(this.tabPanel.getActiveTabIndex()===0){
this.onAddDocumentFromWebSpace()
}else{
this.onAddDocumentFromURL()
}
},
scope:this
}
}
]
}
];
this.on('show',function(){
oneJQuery('[data-xtype=google-docs-web-space]')[0].style.height='';
this.fileUploadStatus.hide()
});
this.addEvents(['refresh']);
web.windows.GoogleDocsViewer.superclass.initComponent.call(this);
this.tabPanel.tabWebSpace.corefilecomp.on('fileselected',function(){
this.addDocumentButton.enable()
},this);
this.tabPanel.tabExternal.url.on('valid',function(){
this.addDocumentButton.enable()
},this);
this.tabPanel.tabExternal.url.on('inValid',function(){
this.addDocumentButton.disable()
},this)
},
docFrom:function(url){
if(this.values.newDocument){
return null
}
if(url.indexOf('webspace:/')===0){
return'webSpace'
}else{
return'externalLink'
}
},
setValues:function(values){
var tp=this.tabPanel;
this.values=values;
var docFrom=this.docFrom(values.url);
if(values.mode==='edit'){
if(docFrom==='webSpace'){
this.tabPanel.tabExternal.setValues({});
this.tabPanel.tabWebSpace.setValues(values);
tp.setActiveTab(tp.tabWebSpace)
}else{
this.tabPanel.tabWebSpace.setValues({});
this.tabPanel.tabExternal.setValues(values);
tp.setActiveTab(tp.tabExternal)
}
}else{
this.tabPanel.tabWebSpace.setValues({});
this.tabPanel.tabExternal.setValues({});
tp.setActiveTab(0)
}
},
onAddDocumentFromWebSpace:function(){
var that=this;
var tab=that.tabPanel.tabWebSpace;
var selectedFile=tab.selectedFile;
if(!selectedFile){
Ext.Msg.alert('No selected document','There was no document selected. Please select a document to be added.')
}else{
that.hide();
that.fireEvent('ok','webspace:'+selectedFile)
}
},
onAddDocumentFromURL:function(){
var that=this;
var tab=that.tabPanel.tabExternal;
tab.url.setValue(web.data.links.LinkExternal.clean(tab.url.getValue()));
if(!tab.url.isValid()){
Ext.MessageBox.show({
title:'Invalid URL',
msg:'Please enter a valid URL.',
cls:'web-modal-warning x-window-dlg',
iconCls:'web-warning-icon',
buttons:{ok:'OK'}
})
}else{
that.fireEvent('ok',tab.url.getValue());
that.hide()
}
},
listeners:{
show:function(){
var tab='tabWebSpace';
if(this.values.mode==='edit'&&this.docFrom(this.values.url)!=='webSpace'){
tab='tabExternal'
}
this.fireEvent('refresh',{tab:tab});
this.addDocumentButton.disable()
}
}
});
web.dd.creators.GoogleDocsViewer=function(target,app){
this.ddel=target;
this.app=app;
this.component=this.app.dm.create({
type:'web.data.components.GoogleDocsViewer',
width:300,
height:200
})
};
web.dd.creators.GoogleDocsViewer.prototype={
beforeDrop:function(cb,scope){
scope=scope||this;
this.app.windows.show({
type:'web.windows.GoogleDocsViewer',
values:{
newDocument:true,
mode:'create'
},
okFn:function(url){
var comp=this.component;
if(!comp.settings){
comp.settings={}
}
comp.settings.src=url;
cb.call(scope);
if(comp.getWidth()){
var height=Math.min(this.app.workspace.getHeight()*2/3,Math.ceil(comp.getWidth()*Math.sqrt(2)));
height=Math.max(height,comp.height);
comp.set({height:height})
}
},
scope:this
})
}
};
web.dd.creators.ShareButtons=function(target,app){
this.ddel=target;
this.app=app;
this.component=this.app.dm.create({
type:'web.data.components.ShareButtons',
width:160,
height:160
})
};
web.dd.creators.ShareButtons.prototype={
beforeDrop:function(cb,scope){
scope=scope||this;
cb.call(scope)
}
};
web.dd.creators.Buttons=function(target,app){
this.ddel=target;
this.app=app;
this.component=this.app.dm.create({
type:'web.data.components.Buttons',
width:130,
height:50
});
var buttonStyle=this.app.getSelected('stylesheet').getStylesByType('web.data.styles.StyleButton')[0];
if(buttonStyle){
this.component.getStyleButton().set({globalId:buttonStyle.getId()})
}
};
web.dd.creators.Buttons.prototype={
beforeDrop:function(cb,scope){
scope=scope||this;
cb.call(scope)
}
};
web.windows.FacebookPage=Ext.extend(web.windows.Window,{
type:'web.windows.FacebookPage',
initComponent:function(){
this.cls='web-windows-facebook';
Ext.apply(this,{
title:'Facebook Page',
resizable:false,
modal:true,
items:[
{
xtype:'container',
cls:'bold',
style:'padding: 5px 30px',
html:'Enter the URL of a Facebook Page below.'
},
{
xtype:'container',
style:'padding: 5px 30px',
html:'Please note: this will not work with your personal timeline / Facebook profile.'
},
{
xtype:'container',
cls:'hbox cross-center',
style:'padding: 5px 30px',
items:[
{
xtype:'label',
text:'www.facebook.com/'
},
{
xtype:'textfield',
width:250,
value:'Onecom',
ref:'../pageURL'
}
]
},
{
xtype:'spacer',
height:60
},
{
xtype:'container',
cls:'web-window-footer hbox cross-center',
items:[
{
xtype:'spacer',
cls:'flex'
},
{
xtype:'button',
cls:'x-btn-primary large wide',
text:'Add Facebook Page',
listeners:{
click:this.onClickAdd,
scope:this
}
}
]
}
],
listeners:{
show:function(){
this.pageURL.removeClass('x-form-invalid')
},
hide:function(){
this.pageURL.removeClass('x-form-invalid')
},
scope:this
}
});
web.windows.FacebookPage.superclass.initComponent.apply(this,arguments)
},
onClickAdd:function(){
var url=this.pageURL.getValue(),fbPageUrlRegex1=/^pages\/[a-zA-Z]+\/[0-9]+$/,fbPageUrlRegex2=/^[A-Za-z0-9][\u0000-\uFFFF]*[a-zA-Z0-9]$/;
this.pageURL.removeClass('x-form-invalid');
if(fbPageUrlRegex1.test(url)===false&&fbPageUrlRegex2.test(url)===false){
this.pageURL.addClass('x-form-invalid');
return false
}
this.hide();
this.fireEvent('ok',url)
}
});
web.dd.creators.FacebookPage=function(target,app){
this.ddel=target;
this.app=app;
this.component=this.app.dm.create({
type:'web.data.components.FacebookPage',
width:web.data.components.FacebookPage.START_WIDTH,
height:web.data.components.FacebookPage.START_HEIGHT
})
};
web.dd.creators.FacebookPage.prototype={
beforeDrop:function(cb,scope){
scope=scope||this;
this.app.windows.show({
type:'web.windows.FacebookPage',
okFn:function(url){
this.component.set({
href:'https://www.facebook.com/'+url,
width:web.data.components.FacebookPage.START_WIDTH,
height:web.data.components.FacebookPage.START_HEIGHT
});
cb.call(scope)
},
scope:this
})
}
};
web.dd.creators.Gallery=function(target,app){
this.ddel=target;
this.app=app;
this.component=this.app.dm.create({
type:'web.data.components.Gallery',
width:300,
height:200
})
};
web.dd.creators.Gallery.prototype={
beforeDrop:function(cb,scope){
scope=scope||window;
this.app.windows.show({
type:'web.windows.Image',
values:{
multiSelect:true,
maxFiles:web.data.components.Gallery.MAX_IMAGES,
errorStrings:web.panels.props.Gallery.errorStrings
},
okFn:function(win,selection){
var assets=selection.images;
this.component.set({
images:assets.map(function(asset){
return{
asset:asset,
caption:''
}
})
});
cb.call(scope)
},
scope:this
})
}
};
Ext.ns('web.windows.contactForm');
web.windows.contactForm.ContactFormAddEmail=Ext.extend(web.windows.Window,{
type:'web.windows.contactForm.ContactFormAddEmail',
modal:true,
resizable:false,
multiSelect:false,
cls:'web-modal-warning x-window-dlg',
iconCls:'web-warning-icon',
constructor:function(config){
this.selectedFile=null;
web.windows.contactForm.ContactFormAddEmail.superclass.constructor.call(this,config)
},
initComponent:function(){
this.title='Create email account';
this.width=500;
this.items=[
{
xtype:'label',
html:'It looks like you don\'t have an email account yet. Create one to receive the submitted form.'+'<br /><br />'+'<a href="https://www.one.com/admin/overview.do" target="_BLANK">'+'Create email account'+'</a>',
style:{
display:'block',
'padding-bottom':'10px'
}
},
{
xtype:'label',
style:'display:block; margin: 10px 0',
html:'<a href="https://www.one.com/en/support/guide/mail/creating-a-new-e-mail-account" target="_blank">'+'Guide to create a new email account'+'</a>'
}
];
this.buttons=[{
text:'OK',
cls:'x-btn-primary',
listeners:{
click:this.onCancel,
scope:this
}
}];
web.windows.contactForm.ContactFormAddEmail.superclass.initComponent.apply(this,arguments)
},
onCancel:function(){
this.hide();
this.fireEvent('cancel',this)
}
});
Ext.ComponentMgr.registerType('web-windows-contactForm-addEmail',web.windows.contactForm.ContactFormAddEmail);
web.windows.contactForm.ContactFormAlreadyExistsWarning=Ext.extend(web.windows.Window,{
type:'web.windows.contactForm.ContactFormAlreadyExistsWarning',
modal:true,
resizable:false,
multiSelect:false,
constructor:function(config){
this.selectedFile=null;
web.windows.contactForm.ContactFormAlreadyExistsWarning.superclass.constructor.call(this,config)
},
initComponent:function(){
this.title='Contact form already exists';
this.cls='x-window-dlg web-modal-warning';
this.iconCls='web-warning-icon';
this.width=500;
this.items=[{
xtype:'label',
html:'You cannot have more than one contact form on a page.',
style:{
display:'block',
'padding-bottom':'10px',
'line-height':'25px'
}
}];
this.buttons=[{
text:'OK',
cls:'x-btn-primary',
listeners:{
click:this.onCancel,
scope:this
}
}];
web.windows.contactForm.ContactFormAlreadyExistsWarning.superclass.initComponent.apply(this,arguments)
},
onCancel:function(){
this.hide();
this.fireEvent('cancel',this)
}
});
Ext.ComponentMgr.registerType('web-windows-contact-already-exists',web.windows.contactForm.ContactFormAlreadyExistsWarning);
web.dd.creators.ContactForm=function(target,app){
this.ddel=target;
this.app=app;
this.component=this.app.dm.create({
type:'web.data.components.ContactForm',
width:300,
height:360,
margin:window.newWay?[
10,
10,
10,
10
]:[
0,
0,
0,
0
]
})
};
web.dd.creators.ContactForm.prototype={
beforeDrop:function(cb,scope){
var emailData=[];
scope=scope||this;
if(this.app.inPageMode()){
this.app.dal.getEmailData(function(opts,success,response){
if(success){
emailData=JSON.parse(response.responseText).email||this.getTestMails()
}else if(response.status===500){
emailData=this.getTestMails();
one.fatal('Custom - getEmailData() request failed from server end with status 500')
}
if(this.component.canAddTo(this.app.getModeDoc())){
if(emailData.length>0&&emailData instanceof Array){
this.component.set({
domainEmails:emailData,
recipientEmail:emailData[0]
});
this.setFormStyleGlobalId();
cb.call(scope)
}else{
this.app.windows.show({type:'web.windows.contactForm.ContactFormAddEmail'})
}
}else{
this.app.windows.show({type:'web.windows.contactForm.ContactFormAlreadyExistsWarning'})
}
},this)
}
},
setFormStyleGlobalId:function(){
var buttonStyle=this.app.getSelected('stylesheet').getStylesByType('web.data.styles.StyleButton')[0];
if(buttonStyle){
this.component.getStyleButton().set({globalId:buttonStyle.getId()})
}
},
enableAddContactForm:function(){
this.devMode=true
},
getTestMails:function(){
return this.devMode||false?[
'abc@xyz.com',
'xyz@abc.com'
]:[]
}
};
web.dd.creators.WebShop=function(target,app){
var globalButtonStyles=app.getSelected('stylesheet').getStylesByType('web.data.styles.StyleButton'),globalTextNormal=app.getSelected('stylesheet').getStyleByRef('normal','StyleText'),cfg={
type:'web.data.components.WebShop',
style:{},
width:680,
height:550
},globalFieldBgColor;
this.ddel=target;
this.app=app;
if(globalTextNormal){
cfg.style.font=globalTextNormal.font?globalTextNormal.font.fontType:0;
cfg.style.fontColor=globalTextNormal.color
}
if(globalButtonStyles.length){
cfg.styleButtonId=globalButtonStyles[0].id;
if(globalButtonStyles[0].inactive&&globalButtonStyles[0].inactive.block&&globalButtonStyles[0].inactive.block.background&&globalButtonStyles[0].inactive.block.background.color&&globalButtonStyles[0].inactive.block.background.color.hex){
globalFieldBgColor=globalButtonStyles[0].inactive.block.background.color.hex();
if(globalFieldBgColor==='#000000'||globalFieldBgColor==='#bbbbbb'||globalFieldBgColor==='#ffffff'){
cfg.style.fieldBgColor=globalFieldBgColor
}else{
globalFieldBgColor=null
}
}
if(!globalFieldBgColor){
cfg.style.fieldBgColor=one.color('#ffffff')
}
}
this.component=this.app.dm.create(cfg)
};
web.dd.creators.WebShop.prototype={
beforeDrop:function(cb,scope){
scope=scope||this;
var win=this.app.windows.create({type:'web.windows.WarningMessage'});
if(this.app.inPageMode()){
if(this.component.canAddTo(this.app.getModeDoc())){
cb.call(scope)
}else{
win.setTitle('Only one webshop per page');
win.setMessage('You cannot have two webshops on the same page. Please remove the other webshop component first.');
win.show()
}
}else{
win.setTitle('Webshop cannot be placed on a template');
win.setMessage('You cannot place your webshop on the template. Please add it to a page instead.');
win.show()
}
}
};
web.utils.HtmlValidator=function(){
function unwrap(str){
var arr=str.split(','),val,o={};
while(val=arr.pop()){
o[val]=true
}
return o
}
var voidTags=unwrap('area,base,basefont,br,col,command,embed,frame,hr,img,input,keygen,link,meta,param,source,track,wbr'),singlelevel=unwrap('script,style'),regxstr={
tagname:'[\\-A-Za-z0-9_:]+',
attrname:'[\\w\\-]+',
attrvalue:/(?:(?:"[^"]*")|(?:'[^']*')|[^>\s]+)/.toString().slice(1,-1)
},regx={
opentag:new RegExp('^[^<]*?<('+regxstr.tagname+')'+'(?:\\s+'+regxstr.attrname+'(?:\\s*=\\s*'+regxstr.attrvalue+')?'+')*'+'([^>]*?)>'),
closetag:/^[^<]*?<([\-\[\]\/A-Za-z0-9_:]+)(\s*?)>/,
doctype:/^[^<]*?<([!\w]+)([^>]*?)>/,
comment:/^[^<]*?<(!--(?:.|\n)*?--)>/,
cdata:/^[^<]*?<(!\[CDATA\[(?:.|\n)*?\]\])>/
};
return function(html){
var str=html.replace(/[\r]/g,'').trim(),tag,rawTag,isCloseTag,matches,stack=[],lineNumber,tagStartLineNumber=1,tagEndLineNumber=1,last,broken='',level=0,replaceSingleLevel=function(m){
tagEndLineNumber=tagStartLineNumber+(m.match(/\n/g)||[]).length;
tagStartLineNumber=tagEndLineNumber;
return''
},pos;
while(str){
matches=str.match(regx.opentag)||str.match(regx.closetag)||str.match(regx.comment)||str.match(regx.cdata)||str.match(regx.doctype);
if(!matches){
pos=str.indexOf('<');
if(pos>=0){
tagStartLineNumber+=(str.substr(0,pos).match(/\n/g)||[]).length;
str=str.substr(pos+1);
continue
}
break
}
rawTag=matches[1];
tag=rawTag.toLowerCase();
tagStartLineNumber+=(str.substring(0,str.indexOf('<')).match(/\n/g)||[]).length;
tagEndLineNumber+=(str.substring(0,matches[0].length).match(/\n/g)||[]).length;
lineNumber=tagStartLineNumber;
str=str.substr(matches[0].length);
if(tag[0]==='/'){
isCloseTag=true;
tag=tag.substr(1)
}else{
isCloseTag=false
}
if(tag[0]==='!'){
if(tag.indexOf('![cdata[')===0){
if(!regx.cdata.test(matches[0])){
broken='Line '+lineNumber+': CDATA section not closed properly.';
break
}
tagEndLineNumber=tagStartLineNumber+(matches[0].substr(matches[0].indexOf('<')).match(/\n/g)||[]).length;
tagStartLineNumber=tagEndLineNumber
}else if(tag.indexOf('!--')===0){
if(!regx.comment.test(matches[0])){
broken='Line '+lineNumber+': HTML comment not closed properly.';
break
}
tagEndLineNumber=tagStartLineNumber+(matches[0].substr(matches[0].indexOf('<')).match(/\n/g)||[]).length;
tagStartLineNumber=tagEndLineNumber
}
continue
}else if(voidTags[tag]){
continue
}else if(singlelevel[tag]){
tagStartLineNumber=tagEndLineNumber;
var specialEndTagRegex=new RegExp('^((?:.|\\n)*?)</'+tag+'[^>]*>','i');
if(!specialEndTagRegex.test(str.toLowerCase())){
if(!isCloseTag){
broken='Line '+lineNumber+': '+('<'+tag+'>')+' start tag missing corresponding end tag.'
}else{
broken='Line '+lineNumber+': Extra end tag found: '+('<'+tag+'>')
}
break
}
str=str.replace(specialEndTagRegex,replaceSingleLevel);
continue
}
if(isCloseTag){
level-=1
}
if(level<0){
broken='Line '+lineNumber+': Extra end tag found: '+('<'+rawTag+'>');
break
}
if(!isCloseTag){
level+=1
}
if(!isCloseTag){
stack.push({
tag:tag,
line:lineNumber
})
}else{
last=stack[stack.length-1];
if(last.tag!==tag){
pos=-1;
stack.some(function(o,index){
if(o.tag===tag){
pos=index;
return true
}
});
if(pos<0){
broken='Line '+lineNumber+': Extra end tag found: '+('<'+rawTag+'>')
}else{
broken='Line '+lineNumber+': '+('<'+last.tag+'>')+' start tag from line '+last.line+' should be closed before '+('<'+rawTag+'>')+'.'
}
break
}
stack.pop()
}
}
if(!broken&&stack.length>0){
last=stack[stack.length-1];
broken='Line '+last.line+': '+('<'+last.tag+'>')+' start tag missing corresponding end tag.'
}
return broken?broken:true
}
}();
web.windows.Code=Ext.extend(web.windows.Window,{
xtype:'web-windows-code',
type:'web.windows.Code',
modal:true,
resizable:false,
headerHeight:29,
footerHeight:85,
repositionAndResize:function(){
var bodyBox=Ext.getBody().getSize(true),width=bodyBox.width*0.8,height=bodyBox.height*0.8+this.footerHeight;
this.setSize(width,height);
this.alignTo(Ext.getBody(),'c-c');
this.editor.container.style.width=this.getWidth()-this.getFrameWidth()+'px';
this.editor.container.style.height=this.getHeight()-this.footerHeight-this.headerHeight-this.getFrameHeight()-(this.message?this.message.getHeight():0)+'px';
this.editor.resize()
},
constructor:function(config){
this.defaultSize=config.defaultSize;
web.windows.Code.superclass.constructor.call(this,config)
},
initComponent:function(){
var invalidHtmlMessage='Your HTML code does not validate. Please make sure that your page looks okay before publishing.';
this.cls='code-editor-window';
this.title='Embed code';
this.modal=true;
this.items=[{
xtype:'container',
style:{position:'relative'},
items:[
{
xtype:'displayfield',
html:'<span>'+'Insert any HTML code including JavaScript.'+'</span>',
height:30
},
{
xtype:'box',
html:'<div class="ace-popped-out"></div>',
listeners:{
scope:this,
afterrender:function(ct){
var editDiv=Ext.DomQuery.selectNode('.ace-popped-out',ct.el.dom),that=this;
that.editor=ace.edit(editDiv);
that.editor.setValue(this.values.code);
that.editor.getSession().setMode('ace/mode/html');
that.editor.setDisplayIndentGuides(true);
that.editor.setSelectionStyle('text');
that.editor.setHighlightSelectedWord(true);
that.editor.setOption('scrollPastEnd',true);
that.editor.renderer.setShowPrintMargin(false);
that.editor.focus();
that.editor.gotoLine(1,0);
that.validate=function(){
var code=that.editor.getValue();
that.message=ct.ownerCt.invalidHtmlBox;
that.hideMessage=function(){
var msgHeight=that.message.getHeight();
if(msgHeight){
that.editor.container.style.height=that.editor.container.offsetHeight+msgHeight+'px';
that.editor.resize();
that.message.hide()
}
};
that.hideMessage();
if(code.length<10000){
var result=web.utils.HtmlValidator(code);
if(result!==true){
that.message.show();
that.message.update(invalidHtmlMessage+'<br/>'+Ext.util.Format.htmlEncode(result));
that.editor.container.style.height=that.editor.container.offsetHeight-that.message.getHeight()+'px';
that.editor.resize()
}
}
if(code.length>0){
that.save.enable()
}else{
that.save.disable()
}
};
var timer=setTimeout(that.validate,100);
that.editor.on('change',function(e){
clearTimeout(timer);
timer=setTimeout(that.validate,200)
})
}
}
},
{
ref:'invalidHtmlBox',
cls:'web-panels-props-code-invalidhtml',
html:invalidHtmlMessage,
hidden:true
},
{
xtype:'container',
cls:'web-window-footer hbox cross-center main-end',
items:[
{
xtype:'button',
cls:'x-btn-secondary large wide',
text:'Cancel',
listeners:{
click:this.onCancel,
scope:this
}
},
{
xtype:'spacer',
width:14
},
{
xtype:'button',
ref:'../../save',
cls:'x-btn-primary large wide',
text:'Save',
listeners:{
click:function(){
this.fireEvent('ok',this,this.editor.getValue());
this.editor.setValue('');
this.hideMessage();
this.editor.destroy()
},
scope:this
}
}
]
}
]
}];
this.listeners={
afterrender:function(w){
w.repositionAndResize();
w.mon(this.app,'resize',this.repositionAndResize.bind(this))
},
scope:this
};
web.windows.Code.superclass.initComponent.apply(this,arguments)
},
onCancel:function(){
this.hide();
this.fireEvent('cancel',this)
},
setValues:function(values){
if(this.editor){
this.editor.setValue(values.code);
this.editor.focus()
}
if(this.validate){
this.validate()
}
}
});
Ext.ComponentMgr.registerType('web-windows-code',web.windows.Code);
web.dd.creators.Code=function(target,app){
this.ddel=target;
this.app=app;
this.defaultSize={
width:200,
height:80
};
this.component=this.app.dm.create({
type:'web.data.components.Code',
width:this.defaultSize.width,
height:this.defaultSize.height
})
};
web.dd.creators.Code.prototype={
beforeDrop:function(cb,scope){
scope=scope||this;
this.app.windows.show({
type:'web.windows.Code',
defaultSize:this.defaultSize,
values:{code:''},
okFn:function(win,code){
this.component.set({code:code});
cb.call(scope);
win.hide()
},
scope:this
})
}
};
web.dd.ComponentsDrag=function(config){
this.app=config.app;
this.proxy=new Ext.dd.StatusProxy({
dropAllowed:this.dropAllowed,
dropNotAllowed:this.dropNotAllowed
})
};
web.dd.ComponentsDrag.prototype={
ddGroup:'components',
dropAllowed:'web-dd-ok',
dropNotAllowed:'web-dd-nodrop',
scroll:false,
getDragData:function(e){
var target=e.getTarget('div.enabledComponent'),dragData=null,componentType,component,orderIndex;
if(target){
componentType=target.getAttribute('data-type');
if(componentType){
if(web.dd.creators[componentType.split('.').reverse()[0]]){
componentType=componentType.split('.').reverse()[0];
dragData=new web.dd.creators[componentType](target,this.app);
component=dragData.component;
dragData.components=[component]
}else{
component=this.app.dm.create({
type:componentType,
id:Math.uuid(),
width:200,
height:80
});
dragData={
ddel:target,
components:[component]
}
}
orderIndex=this.app.workspace.getPage().getAllItems().reduce(function(zindex,item){
return Math.max(zindex,item.getIndex())
},0);
component.setIndex(orderIndex+1)
}
}
if(dragData){
dragData.isNewComponent=true;
var w=component.width,h=component.height,xy=e.getXY(),ox=Math.round(w/2),oy=Math.round(h/2),x=xy[0]-ox,y=xy[1]-oy;
dragData.region=new Ext.lib.Region(y,x+w,y+h,x);
dragData.regions=[dragData.region];
dragData.offsetX=ox;
dragData.offsetY=oy;
this.dragData=dragData
}
return dragData
},
onDrag:function(e){
var cmp=this.dragData.components[0],width=cmp.width,height=cmp.height,xy=e.getXY();
this.app.proxy.show({
x:Math.round(xy[0]-width/2),
y:Math.round(xy[1]-height/2),
width:width,
height:height,
valid:e.getTarget('.web-workspace-content')
})
},
onMouseDown:function(e){
this.app.fireEvent('dragstart','components')
},
onMouseUp:function(x,y){
var app=this.app;
setTimeout(function(){
app.workspace.dragging=false
},50);
app.fireEvent('dragend');
app.proxy.hide();
app.workspace.multiSelect.select([])
}
};
web.ui.plugins.components.DragDrop=function(config){
this.panel=null;
this.drag=null
};
web.ui.plugins.components.DragDrop.prototype={
init:function(panel){
this.panel=panel;
this.drag=new web.dd.ComponentsDrag({app:panel.app});
this.initListeners()
},
initListeners:function(){
this.panel.mon(this.panel,'afterrender',function(){
this.initDragDrop()
},this)
},
initDragDrop:function(){
this.panel.dragZone=new Ext.dd.DragZone(this.panel.el,this.drag)
}
};
web.data.components.widgets.List=[web.data.components.widgets.Youtube];
web.panels.Components=Ext.extend(web.panels.Panel,{
xtype:'web-components',
autoEl:{
tag:'div',
unselectable:'on'
},
addComponentCount:0,
constructor:function(config){
web.panels.Components.superclass.constructor.call(this,config)
},
initComponent:function(){
var components=[
{
type:'web.data.components.Block',
name:web.data.components.Block.NAME,
iconCls:'icon-block'
},
{
type:'web.data.components.Text',
name:web.data.components.Text.NAME,
iconCls:'icon-text'
},
{
type:'web.data.components.Buttons',
name:web.data.components.Buttons.NAME,
iconCls:'icon-buttons'
},
{
type:'web.data.components.Gallery',
name:web.data.components.Gallery.NAME,
iconCls:'icon-gallery'
},
{
type:'web.data.components.ImageSlider',
name:web.data.components.ImageSlider.NAME,
iconCls:'icon-imageslider'
},
{
type:'web.data.components.resources.Image',
name:web.data.components.resources.Image.NAME,
iconCls:'icon-image'
},
{
type:'web.data.components.Menu',
name:web.data.components.Menu.NAME,
iconCls:'icon-menu'
},
{
type:'web.data.components.Table',
name:web.data.components.Table.NAME,
iconCls:'icon-table'
},
{
type:'web.data.components.GoogleDocsViewer',
name:web.data.components.GoogleDocsViewer.NAME,
iconCls:'icon-googledocsviewer'
},
{
type:'web.data.components.Video',
name:web.data.components.Video.NAME,
iconCls:'icon-video'
},
{
type:'web.data.components.ShareButtons',
name:web.data.components.ShareButtons.NAME,
iconCls:'icon-sharebuttons'
},
{
type:'web.data.components.FacebookPage',
name:web.data.components.FacebookPage.NAME,
iconCls:'icon-facebooklikebox'
},
{
type:'web.data.components.Code',
name:web.data.components.Code.NAME,
iconCls:'icon-code'
},
{
type:'web.data.components.ContactForm',
name:web.data.components.ContactForm.NAME,
description:'Contact form',
iconCls:'icon-contactForm'
},
{
itemId:'webshop',
type:'web.data.components.WebShop',
name:web.data.components.WebShop.NAME,
iconCls:'icon-webshop'
}
],tpl=new Ext.XTemplate('<tpl for=".">'+'<div class=addComponentWrap>'+'<div class="addComponent enabledComponent" data-type="{type}" unselectable="on">'+'<div class="icon {iconCls}"></div>'+'<div class="description">{name}</div>'+'</div>'+'</div>'+'</tpl>');
this.layout='table';
this.layoutConfig={columns:3};
this.cls='componentsPanel x-unselectable';
this.title='Components';
this.items=components.map(function(cmp){
return{
itemId:cmp.itemId||undefined,
hidden:cmp.hidden,
xtype:'box',
html:tpl.apply(cmp)
}
});
this.plugins=[new web.ui.plugins.components.DragDrop];
this.listeners={
render:function(panel){
panel.tip=new Ext.ToolTip({
target:panel.getEl(),
delegate:'.enabledComponent',
html:'Drag or double click to add',
trackMouse:true
});
panel.tip2=new Ext.ToolTip({
target:panel.getEl(),
delegate:'.disabledComponent',
html:'Change editing mode to "Edit page" to use this component.',
trackMouse:true
});
this.app.on('update',function(e){
if(Date.now()-this.addComponentTime>50){
this.addComponentCount=0
}
},this);
panel.mon(panel.el,'dblclick',function(e,t,o){
var target=e.getTarget('[data-type].enabledComponent'),type=target?target.getAttribute('data-type'):null,app=this.app,Creator,creator;
if(type){
Creator=web.dd.creators[type.split('.').reverse()[0]];
if(Creator){
creator=new Creator(target,app);
if(creator.beforeDrop){
creator.beforeDrop(function(){
this.addComponent(creator.component)
},this)
}else{
this.addComponent(creator.component)
}
}else{
this.addComponent(app.dm.create({
type:type,
id:Math.uuid(),
width:200,
height:200
}))
}
}
},this)
},
scope:this
};
web.panels.Components.superclass.initComponent.call(this)
},
initListeners:function(){
this.on('modeChange',function(mode){
if(mode==='template'){
this.getComponent(this.items.length-1).disable();
this.getComponent(this.items.length-2).disable();
if(this.getComponent(this.items.length-1).el){
this.getComponent(this.items.length-1).el.select('.addComponent').removeClass('enabledComponent').addClass('disabledComponent')
}
if(this.getComponent(this.items.length-2).el){
this.getComponent(this.items.length-2).el.select('.addComponent').removeClass('enabledComponent').addClass('disabledComponent')
}
}else if(mode==='page'){
this.getComponent(this.items.length-1).enable();
this.getComponent(this.items.length-2).enable();
if(this.getComponent(this.items.length-1).el){
this.getComponent(this.items.length-1).el.select('.addComponent').removeClass('disabledComponent').addClass('enabledComponent')
}
if(this.getComponent(this.items.length-2).el){
this.getComponent(this.items.length-2).el.select('.addComponent').removeClass('disabledComponent').addClass('enabledComponent')
}
}
},this)
},
addComponent:function(component){
var app=this.app,workspace=app.workspace,offsetStep=30,scroll=workspace.el.getScroll(),templateRegion=workspace.upperEl.getRegion(),deskRegion=workspace.contentEl.getRegion(),multiplier=this.addComponentCount+1,offset=offsetStep*multiplier,top=Math.max(offset,offset+scroll.top+deskRegion.top-templateRegion.top),left=Math.max(offset,offset+scroll.left+deskRegion.left-templateRegion.left);
this.addComponentTime=Date.now();
this.addComponentCount+=1;
var changes={},target=app.getModeDoc();
changes[component.id]={
parentId:target.id,
bbox:{
top:top,
right:left+component.width,
bottom:top+component.height,
left:left
}
};
changes=workspace.calcRels(changes);
app.invoker.execute(new web.commands.components.ChangeMulti({
target:target,
components:[component],
changes:changes
}));
clearTimeout(this.addComponentTimer);
this.addComponentTimer=setTimeout(function(){
app.workspace.multiSelect.select([component])
},50)
},
enableWebshop:function(){
this.getComponent('webshop').show()
}
});
Ext.ComponentMgr.registerType('web-components',web.panels.Components);
Ext.ns('web.panels.props');
Ext.ns('web.commands.stylesheets');
web.commands.stylesheets.EditStyle=Ext.extend(web.commands.Command,{
constructor:function(config){
this.style=null;
this.newStyle=null;
web.commands.stylesheets.EditStyle.superclass.constructor.call(this,config)
},
execute:function(){
this.prevState=Ext.apply({
border:null,
background:null,
padding:null
},this.style.toJSON());
this.style.set(this.newStyle);
this.fireEvent('update',this.style)
},
undo:function(){
var currentState=Ext.apply({
border:null,
background:null,
padding:null
},this.style.toJSON());
this.style.set(this.prevState);
this.prevState=currentState;
this.fireEvent('update',this.style)
}
});
Ext.ns('web.commands.templates');
web.commands.templates.EditBlock=Ext.extend(web.commands.Command,{
constructor:function(config){
this.template=null;
this.align=null;
this.width=null;
web.commands.templates.EditBlock.superclass.constructor.call(this,config)
},
execute:function(){
var cfg={};
this.prevState={
width:this.template.getWidth(),
align:this.template.getAlign()
};
if(this.align!==null){
cfg.align=this.align
}
if(this.width!==null){
cfg.width=this.width
}
this.template.set(cfg);
this.fireEvent('select',this.template);
this.fireEvent('update',this.template)
},
undo:function(){
var cfg={
width:this.template.getWidth(),
align:this.template.getAlign()
};
this.template.set(this.prevState);
this.prevState=cfg;
this.fireEvent('select',this.template);
this.fireEvent('update',this.template)
}
});
web.commands.templates.ChangeFavicon=Ext.extend(web.commands.Command,{
constructor:function(config){
web.commands.templates.ChangeFavicon.superclass.constructor.call(this,config)
},
execute:function(){
this.prevState=this.part.getFavicon();
this.part.set({'favicon':this.favicon});
this.fireEvent('update',this.part)
},
undo:function(){
var val=this.part.getFavicon();
this.part.set({'favicon':this.prevState});
this.prevState=val;
this.fireEvent('update',this.part)
}
});
web.commands.templates.ChangeScroll=Ext.extend(web.commands.Command,{
constructor:function(config){
web.commands.templates.ChangeScroll.superclass.constructor.call(this,config)
},
execute:function(){
this.prevState=this.template.getVerticalScroll();
this.template.set({'verticalScroll':this.verticalScroll});
this.fireEvent('update',this.template)
},
undo:function(){
var val=this.template.getVerticalScroll();
this.template.set({'verticalScroll':this.prevState});
this.prevState=val;
this.fireEvent('update',this.template)
}
});
web.commands.templates.ChangeMobile=Ext.extend(web.commands.Command,{
constructor:function(config){
web.commands.templates.ChangeMobile.superclass.constructor.call(this,config)
},
execute:function(){
this.prevState=this.template.isMobile();
this.template.set({'mobile':this.mobile});
this.fireEvent('update',this.template,{calcOnly:true})
},
undo:function(){
var val=this.template.isMobile();
this.template.set({'mobile':this.prevState});
this.prevState=val;
this.fireEvent('update',this.template)
}
});
web.commands.templates.EditName=Ext.extend(web.commands.Command,{
constructor:function(config){
this.template=null;
this.name=null;
web.commands.templates.EditName.superclass.constructor.call(this,config)
},
execute:function(){
var cfg={};
this.prevState={name:this.template.getName()};
if(this.name!==null){
cfg.name=this.name
}
this.template.set(cfg);
this.fireEvent('update',this.template)
},
undo:function(){
var cfg={name:this.template.getName()};
this.template.set(this.prevState);
this.prevState=cfg;
this.fireEvent('update',this.template)
}
});
web.commands.templates.UpdateCategory=Ext.extend(web.commands.Command,{
constructor:function(config){
web.commands.templates.UpdateCategory.superclass.constructor.call(this,config)
},
execute:function(){
this.prevState=this.template.getCategories();
this.template.set({'categories':this.categories});
this.fireEvent('update',this.template)
},
undo:function(){
var val=this.template.getCategories();
this.template.set({'categories':this.prevState});
this.prevState=val;
this.fireEvent('update',this.template)
}
});
web.windows.TemplatePages=Ext.extend(web.windows.Window,{
type:'web.windows.TemplatePages',
pages:null,
initComponent:function(){
this.templateId=null;
this.lm=null;
this.title='Pages using this template';
this.width=300;
this.height=300;
this.modal=true;
this.layout='fit';
this.items=[{
ref:'tree',
xtype:'web-sitemaptree',
app:this.app,
nodeUiProvider:web.ui.tree.SiteLinksNodeUI
}];
this.listeners={
show:function(){
this.tree.refresh();
this.updateTree()
},
scope:this
};
web.windows.TemplatePages.superclass.initComponent.call(this)
},
setValues:function(values){
this.pages=null;
this.templateId=values.templateId||null;
if(values.pages){
this.pages=values.pages
}
if(this.pages!==null){
this.updateTree()
}else{
this.fetchPages()
}
},
fetchPages:function(){
if(this.lm){
this.lm.show()
}
this.app.dal.getList('web.data.components.Page',true,function(opts,success,result){
if(this.lm){
this.lm.hide()
}
if(success){
this.pages={};
Ext.decode(result.responseText).forEach(function(page){
this.pages[page.id]={
id:page.id,
templateId:page.templateId
}
},this);
this.updateTree()
}else{
one.error('<b>'+'Unable to retrieve list of pages.'+'</b>'+'<br />'+'Please try again later or contact our support for further assistance.')
}
},this)
},
updateTree:function(){
var root=this.tree.getRootNode(),templateId=this.templateId;
root.cascade(function(node){
var link=node.attributes.item,page;
if(link.getPageId){
page=this.pages[link.getPageId()];
if(page&&page.templateId===templateId){
node.enable()
}else{
node.disable()
}
}else{
node.disable()
}
},this)
}
});
web.panels.props.Template=Ext.extend(web.panels.Panel,{
constructor:function(config){
this.template=null;
this.lastTemplateId=null;
this.lastPageId=null;
this.pages={};
web.panels.props.Template.superclass.constructor.call(this,config)
},
initComponent:function(){
this.layout='vflex';
this.cls='web-props-panel web-panels-props-template';
this.defaults={
baseCls:'x-btn-group',
cls:'web-prop-btn-group',
frame:true
};
this.catList=web.ui.TemplateCategories.List.map(function(item){
return{
name:item.id,
boxLabel:item.text
}
});
this.verticalScrollCheck=new Ext.form.Checkbox({
xtype:'checkbox',
boxLabel:'Always show vertical scrollbar',
flex:1,
width:275,
listeners:{
check:function(checkbox,checked){
this.updateVerticalScrollValue(checked)
},
scope:this
}
});
this.mobileCheck=new Ext.form.Checkbox({
xtype:'checkbox',
boxLabel:'Activate mobile version',
flex:1,
width:275,
listeners:{
afterRender:function(checkbox){
new Ext.ToolTip({
target:checkbox.el.parent(),
html:'When activated, visitors on your site will see a mobile optimized version of your site'
})
},
check:function(checkbox,checked){
this.updateMobileValue(checked)
},
scope:this
}
});
this.boxStyleBackground=new web.ui.blockStyle.Background({
app:this.app,
width:275,
componentLabel:'Background:',
enableImageAttachment:true,
listeners:{
adjust:this.onAdjust,
scope:this
}
});
this.items=[{
region:'center',
xtype:'container',
style:{padding:'20px 0 20px 20px'},
defaults:{
margins:{
top:0,
bottom:0,
right:20,
left:0
},
style:{paddingBottom:'10px'},
width:275
},
flex:true,
items:[
{
layout:'hflex',
items:[
{
xtype:'displayfield',
value:'Template title:',
flex:1,
width:155
},
{
xtype:'textfield',
ref:'../../templateName',
width:120,
listeners:{
focus:function(field){
field.beforeEnter=field.getValue()
},
blur:function(field){
if(field.beforeEnter!==field.getValue()){
this.app.invoker.execute(new web.commands.templates.EditName({
template:this.template,
name:field.getValue()
}))
}
},
scope:this
}
}
]
},
{
layout:'hflex',
items:[
{
xtype:'displayfield',
value:'Template used by:',
width:150
},
{
xtype:'label',
ref:'../../usedByPages',
text:' ',
style:{
textAlign:'right',
padding:'0 5px'
},
margins:'0 8px 0 8px',
flex:1
},
{
xtype:'button',
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
handler:function(){
this.app.windows.show({
type:'web.windows.TemplatePages',
values:{
pages:this.pages,
templateId:this.template.getId()
}
})
},
scope:this
}
]
},
{
layout:'hauto',
items:[{
xtype:'container',
layout:'auto',
cls:'web-template-background',
items:[this.boxStyleBackground]
}]
},
{
layout:'hflex',
items:[
{
xtype:'displayfield',
value:'Alignment:',
flex:1,
width:155
},
{
xtype:'web-combobox',
ref:'../../alignmentCombo',
width:120,
store:[
[
'left',
'Left'
],
[
'center',
'Center'
],
[
'right',
'Right'
]
],
mode:'local',
editable:false,
forceSelection:true,
triggerAction:'all',
listeners:{
select:function(combo,record,index){
this.onAlignmentChange(null,true,combo.getValue())
},
scope:this
}
}
]
},
{
layout:'hflex',
hidden:false,
items:[
{
xtype:'displayfield',
value:'Favicon:',
flex:1
},
{
xtype:'label',
ref:'../../faviconLabel',
text:'None',
style:'overflow:hidden;white-space:nowrap;text-overflow:ellipsis;text-align:right;max-width:80px;',
isFormField:true
},
{
xtype:'spacer',
width:5
},
{
xtype:'button',
ref:'../../buttonRemoveFavicon',
tooltip:'Remove the selected image.',
cls:'props-panel-remove-button',
hidden:true,
listeners:{
click:function(){
this.setFavicon(null)
},
scope:this
}
},
{
xtype:'button',
ref:'../../buttonSelectFavicon',
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
tooltip:'Select an image on your web space.',
handler:this.selectFaviconClick,
scope:this
}
]
},
{
layout:'hauto',
style:{
paddingTop:'2px',
paddingBottom:'14px'
},
items:[this.verticalScrollCheck]
},
{
layout:'hauto',
items:[this.mobileCheck]
},
{
xtype:'container',
hidden:this.app.dal.domain!=='repository',
cls:'template-categories-selector',
items:[
{
xtype:'container',
html:'template categories:',
style:'padding-bottom: 10px;opacity: 0.5'
},
{
xtype:'checkboxgroup',
name:'category',
fieldLabel:'Category',
ref:'../../categories',
width:275,
columns:1,
items:this.catList,
listeners:{
change:function(obj,val){
this.app.invoker.execute(new web.commands.templates.UpdateCategory({
template:this.template,
categories:val.map(function(item){
return item.getName()
})
}))
},
scope:this
}
}
]
}
]
}];
web.panels.props.Template.superclass.initComponent.apply(this,arguments)
},
initListeners:function(){
var app=this.app;
app.on('update',function(part){
if(part===this.styleBlock&&part.getApplied('background')){
this.boxStyleBackground.updateHeaderStyleField(part.getApplied('background'))
}
},this)
},
setComponent:function(component){
if(component){
this.template=component;
this.component=component;
this.styleBlock=component.getStylesheet().getStyleByRef('body','StyleBlock');
this.refresh()
}
},
refresh:function(){
var template=this.template,templateId=template.getId(),currentPageId=this.app.getSelected('page').getId();
this.templateName.setValue(template.getName());
this.alignmentCombo.setValue(template.getAlign());
this.updateFaviconLabel(template.getFavicon());
this.verticalScrollCheck.suspendEvents();
this.verticalScrollCheck.setValue(template.getVerticalScroll()==='scroll');
this.verticalScrollCheck.resumeEvents();
this.mobileCheck.suspendEvents();
this.mobileCheck.setValue(template.isMobile());
this.mobileCheck.resumeEvents();
this.categories.suspendEvents();
var selectedCategories=template.getCategories();
this.categories.eachItem(function(item){
item.setValue(selectedCategories.indexOf(item.getName())>=0)
});
this.categories.resumeEvents();
this.boxStyleBackground.suspendEvents();
this.updateBoxStyle();
this.boxStyleBackground.resumeEvents();
if(this.lastTemplateId!==templateId||this.lastPageId!==currentPageId){
this.lastTemplateId=templateId;
this.lastPageId=currentPageId;
this.pages={};
this.app.dal.getList('web.data.components.Page',true,function(opts,success,response){
if(success){
var pages=Ext.decode(response.responseText).concat({
id:currentPageId,
templateId:templateId
}),total=0,pageId;
pages.forEach(function(page){
this.pages[page.id]={
id:page.id,
templateId:page.templateId
}
},this);
for(pageId in this.pages){
if(this.pages.hasOwnProperty(pageId)){
if(this.pages[pageId].templateId===templateId){
total+=1
}
}
}
this.usedByPages.setText(one.locale.trQuantity({
one:'{0} page',
other:'{0} pages'
},total));
this.usedByPages.ownerCt.doLayout()
}else{
one.warn('Could not fetch page list.')
}
},this)
}
},
onAlignmentChange:function(button,state,alignment){
if(state){
if(this.previousAlignment===alignment){
return
}
this.app.invoker.execute(new web.commands.templates.EditBlock({
template:this.template,
align:alignment
}));
this.previousAlignment=alignment
}
},
onPlacementFieldChange:function(field){
var form=this.placement.form,currentValue=field.getValue(),values;
if(typeof field.previousValue==='undefined'){
field.previousValue='center'
}
if(field.previousValue===field.getValue()){
field.previousValue=currentValue;
return
}
values=form.getValues();
this.app.invoker.execute(new web.commands.templates.EditBlock({
template:this.template,
align:values.align
}));
field.previousValue=currentValue
},
updateFaviconLabel:function(asset){
var filename,src,html;
if(asset){
asset=new web.data.assets.Image(asset);
filename=web.DAL.decodeHref(asset.getURL().replace(/.*\//,''));
src=asset.getURL().replace('webspace:','');
src=this.app.dal.getWebspacePath(src)+'?etag='+window.encodeURIComponent(asset.etag);
this.buttonRemoveFavicon.show();
if(asset.contentType==='image/vnd.microsoft.icon'){
src+='&png'
}
html='<img class="favicon" title="'+filename+'" src="'+src+'">'
}else{
this.buttonRemoveFavicon.hide();
html='None'
}
try{
this.faviconLabel.update(html);
this.faviconLabel.ownerCt.doLayout()
}catch(e){
}
},
setFavicon:function(asset){
this.app.invoker.execute(new web.commands.templates.ChangeFavicon({
part:this.template,
favicon:asset
}))
},
selectFaviconClick:function(){
var previousIcon=this.component.getFavicon(),paths=null;
if(previousIcon){
paths=[previousIcon.url]
}
this.app.windows.show({
type:'web.windows.Image',
okFn:function(win,selection){
var asset=selection.images[0];
this.setFavicon(asset)
},
values:{
paths:paths,
allowIcoFiles:true,
contentTypeFilter:/image\/(?:gif|png|jpg|jpeg|x-icon|vnd.microsoft.icon)/
},
scope:this
})
},
updateVerticalScrollValue:function(enabled){
this.app.invoker.execute(new web.commands.templates.ChangeScroll({
template:this.template,
verticalScroll:enabled?'scroll':'auto'
}))
},
updateMobileValue:function(enabled){
this.app.invoker.execute(new web.commands.templates.ChangeMobile({
template:this.template,
mobile:enabled
}))
},
onAdjust:function(){
var interval,oldStyle;
return function(opts){
var that=this;
if(oldStyle===undefined){
oldStyle={background:this.styleBlock.getApplied('background')}
}
this.styleBlock.set(opts);
if(opts.background){
this.boxStyleBackground.updateHeaderStyleField(opts.background)
}
this.fireEvent('adjust',this.styleBlock);
if(interval){
window.clearTimeout(interval)
}
interval=window.setTimeout(function(){
that.styleBlock.set(oldStyle);
var command=new web.commands.components.blocks.EditStyle({
style:that.styleBlock,
opts:opts
});
that.app.invoker.execute(command);
oldStyle=undefined
},500)
}
}(),
updateBoxStyle:function(){
var bgStyle=this.styleBlock.getApplied('background')||null;
if(bgStyle){
this.boxStyleBackground.updateHeaderStyleField(bgStyle);
this.boxStyleBackground.setValue(bgStyle)
}
}
});
web.commands.components.SetCodeData=Ext.extend(web.commands.Command,{
execute:function(){
var component=this.component;
this.prevState={
name:component.getName(),
code:component.getCode()
};
this.component.set({
name:this.name,
code:this.code
});
this.fireEvent('update',component)
},
undo:function(){
var component=this.component,prevState=this.prevState,tmp={
name:component.getName(),
code:component.getCode()
};
component.set({
name:prevState.name,
code:prevState.code
});
this.fireEvent('update',component);
this.prevState=tmp
}
});
web.panels.props.Code=Ext.extend(web.panels.Panel,{
initComponent:function(){
var sp10,sp30;
this.nameField=new Ext.form.TextField({
itemId:'name',
autoCreate:{
tag:'input',
type:'text',
maxlength:'128'
},
height:25,
listeners:{
change:this.updateComponent,
scope:this
}
});
this.codeField=new Ext.form.TextArea({
itemId:'code',
labelSeparator:'',
height:115,
style:'font-family: monospace;fill: #ffffff; border: #d1d1d1; color: #cccccc;',
readOnly:true,
listeners:{
change:this.updateComponent,
afterrender:function(c){
c.getEl().set({spellcheck:'false'})
},
scope:this
}
});
this.dropLocationField=new web.ui.ComboBox({
triggerAction:'all',
tpl:'<tpl for="."><div class="x-combo-list-item">{field2:htmlEncode}</div></tpl>',
allowBlank:false,
autoSelect:true,
editable:false,
forceSelection:true,
store:[
[
'',
'Normal'
],
[
'Head',
'Just before closing </head> tag (fixed)'
],
[
'BodyEnd',
'Just before closing </body> tag (fixed)'
]
],
height:25,
listeners:{
select:this.updateLocation,
scope:this
}
});
var invalidHtmlMessage='Your HTML code does not validate. Please make sure that your page looks okay before publishing.';
this.invalidHtmlField=new Ext.Container({
style:{paddingTop:'8px'},
html:'<span style="color: #bf9950">'+invalidHtmlMessage+'</span>',
hidden:true
});
sp30={
xtype:'spacer',
height:30
};
sp10={
xtype:'spacer',
height:7
};
var mainItems=[
{
xtype:'container',
style:{paddingBottom:'6px'},
html:'Title:'
},
this.nameField,
{
xtype:'container',
style:{
paddingTop:'29px',
paddingBottom:'6px'
},
html:'Placement:'
},
this.dropLocationField,
{
xtype:'container',
layout:'hflex',
style:{
paddingTop:'28px',
paddingBottom:'9px'
},
items:[
{
xtype:'container',
html:'Code:',
flex:1
},
{
xtype:'button',
scope:this,
handler:function(button){
var compSize={
width:this.component.width,
height:this.component.height
};
this.app.windows.show({
type:'web.windows.Code',
defaultSize:compSize,
values:{code:this.codeField.getValue()},
okFn:function(win,code){
this.codeField.setValue(code);
this.updateComponent();
win.hide()
},
cancelFn:function(win){
win.hide()
},
scope:this
})
},
text:'Edit'
}
]
},
this.codeField,
this.invalidHtmlField
];
this.cls='web-props-panel vbox';
this.items=[
{
xtype:'container',
defaults:{
xtype:'container',
width:267
},
style:{
padding:'20px 0 2px 20px',
overflow:'auto'
},
cls:'flex',
items:mainItems
},
{
xtype:'container',
cls:'props-panel-bottom-container',
layout:'column',
items:[{
xtype:'web-props-mobile',
app:this.app,
cmp:this.component
}]
}
];
web.panels.props.Code.superclass.initComponent.apply(this,arguments)
},
initListeners:function(){
var app=this.app;
app.on('update',function(part){
if(part===this.code){
this.refresh()
}
},this)
},
setComponent:function(code){
this.code=code;
this.refresh()
},
updateComponent:function(){
this.app.invoker.execute(new web.commands.components.SetCodeData({
component:this.code,
name:this.nameField.getValue(),
code:this.codeField.getValue()
}))
},
updateLocation:function(){
var changes={};
changes[this.code.id]={location:this.dropLocationField.getValue()};
changes=this.app.workspace.calcRels(changes);
this.app.invoker.execute(new web.commands.components.ChangeMulti({changes:changes}))
},
refresh:function(){
var code=this.code;
this.nameField.setValue(code.getName());
this.codeField.setValue(code.getCode());
this.dropLocationField.setValue(code.getLocation());
if(code.getCode().length<10000){
var result=web.utils.HtmlValidator(code.getCode());
if(result!==true){
this.invalidHtmlField.show()
}else{
this.invalidHtmlField.hide()
}
}else{
this.invalidHtmlField.hide()
}
}
});
Ext.ns('web.commands.components.blocks');
web.commands.components.blocks.EditStyle=Ext.extend(web.commands.Command,{
constructor:function(config){
this.style=null;
this.opts=null;
web.commands.components.blocks.EditStyle.superclass.constructor.call(this,config)
},
execute:function(){
this.prevState=Ext.apply({
background:null,
border:null,
padding:null,
shadow:null
},this.style.toJSON());
this.style.set(this.opts);
this.fireEvent('update',this.style)
},
undo:function(){
var currentState=Ext.apply({
background:null,
border:null,
padding:null,
shadow:null
},this.style.toJSON());
this.style.set(this.prevState);
this.prevState=currentState;
this.fireEvent('update',this.style)
}
});
web.ui.plugins.WindowButton=function(cfg){
this.windowCfg=cfg;
this.ignoreNextClick=null
};
web.ui.plugins.WindowButton.prototype={
constructor:web.ui.plugins.WindowButton,
init:function(button){
button.addEvents('winshow','winhide');
button.winPlugin=this;
this.button=button;
if(button instanceof Ext.SplitButton){
button.on('afterrender',function(){
button.mon(button.getEl(),'click',function(e){
if(!e.getTarget('.x-btn-text')){
this.onClick(button,this.windowCfg)
}
},this)
},this)
}else{
button.getMenuClass=this.getMenuClass;
button.on('click',function(btn,e){
this.onClick(button)
},this)
}
button.mon(Ext.getBody(),'mousedown',function(e){
this.onHide(button,e)
},this);
button.on('destroy',function(){
if(button.win&&button.win.destroy){
button.win.destroy();
delete button.win
}
})
},
getMenuClass:function(){
return this.arrowAlign!=='bottom'?'x-btn-arrow':'x-btn-arrow-bottom'
},
onHide:function(button,e){
if(button.pressed&&button.win&&!button.win.hidden){
if(!e.getTarget('#'+button.win.getEl().id)&&!e.getTarget('.web-windows-image')&&!e.getTarget('.ext-el-mask')&&!e.getTarget('.x-menu')&&!e.getTarget('.x-combo-list')){
if(!button.enableToggle){
button.toggle(false,true)
}
button.win.hide();
this.ignoreNextClick=true;
this.allowNextClick.defer(500,this)
}
}
},
showWindow:function(btn){
btn=btn||this.button;
var that=this,cfgListeners=Ext.apply({
beforeshow:function(win){
btn.fireEvent('winshow',btn,win);
that.alignWindowToButton(win,btn);
return true
},
hide:function(win){
btn.fireEvent('winhide',btn,win);
if(!btn.enableToggle){
btn.toggle(false,true)
}
}
},this.windowCfg.listeners),cfg=Ext.applyIf({listeners:cfgListeners},this.windowCfg),win=cfg.app?cfg.app.windows.create(cfg):new web.windows.Window(cfg);
btn.win=win;
win.show();
if(!btn.enableToggle){
btn.toggle(true,true)
}
},
onClick:function(btn){
if(!this.ignoreNextClick){
this.showWindow(btn)
}
this.ignoreNextClick=false
},
alignWindowToButton:function(win,btn){
var btnPosition=btn.getPosition(),btnSize=btn.getSize(),body=Ext.getBody(),marginLeft=8,marginBottom=8,x=btnPosition[0]+btnSize.width+marginLeft,y=btnPosition[1];
if(body.getHeight()<y+win.getHeight()+marginBottom){
y=body.getHeight()-win.getHeight()-marginBottom
}
if(body.getWidth()<x+win.getWidth()&&body.getWidth()/2<btnPosition[0]+btnSize.width/2){
x=btnPosition[0]-win.getWidth()
}
win.setPosition([
x,
y
])
},
allowNextClick:function(){
this.ignoreNextClick=false
}
};
Ext.ns('web.windows.blockProps');
Ext.override(Ext.Element,{
setOpacity:function(opacity,animate){
var me=this,s=me.dom.style,opacityRe=/alpha\(opacity=(.*)\)/i,trimRe=/^\s+|\s+$/g;
if(!animate||!me.anim){
if(Ext.isIE&&!Ext.isIE9&&!Ext.isIE10){
var opac=opacity<1?'alpha(opacity='+opacity*100+')':'',val=s.filter.replace(opacityRe,'').replace(trimRe,'');
s.zoom=1;
s.filter=val+(val.length>0?' ':'')+opac
}else{
s.opacity=opacity
}
}else{
me.anim({opacity:{to:opacity}},me.preanim(arguments,1),null,0.35,'easeIn')
}
return me
}
});
Ext.ns('one.color.area');
one.color.area.Base=Ext.extend(Ext.BoxComponent,{
width:256,
height:256,
xSubtraction:1,
ySubtraction:1,
tpl:new Ext.XTemplate('<tpl for="hues">'+'<div style="background-color: {.}"></div>'+'</tpl>',{disableFormats:true}),
initComponent:function(){
this.addEvents('change')
},
constructor:function(config){
one.color.area.Base.superclass.constructor.call(this,config);
this.value=this.value||new one.color.HSV(0.5,0.5,0.5,1)
},
onRender:function(){
this.autoEl={
cls:'one-color-area',
cn:{
cls:'inner',
cn:[
{cls:'cursor'},
{
cls:'alpha',
cn:[
{cls:'hue'},
{cls:'saturation'},
{cls:'value'}
]
}
]
}
};
one.color.area.Base.superclass.onRender.apply(this,arguments);
this.inner=this.el.first();
this.cursor=this.inner.first();
this.alpha=this.cursor.next();
this.hueEl=this.alpha.first();
this.satEl=this.hueEl.next();
this.valEl=this.satEl.next()
},
afterRender:function(){
one.color.area.Base.superclass.afterRender.apply(this,arguments);
this.updateCursorPosition(this.value);
this.updateChannelLayers(this.value);
var fn=this.onUserInteraction.createDelegate(this);
new Ext.dd.DragTracker({
onBeforeStart:Ext.emptyFn,
onStart:fn,
onDrag:fn,
onEnd:fn,
tolerance:0,
autoStart:300
}).initEl(this.inner);
this.mon(this.inner,{mousedown:fn})
},
onResize:function(){
one.color.area.Base.superclass.onResize.apply(this,arguments);
this.updateCursorPosition(this.value)
},
getValue:function(){
return this.value
},
setValue:function(color){
this.value=color;
if(this.rendered){
this.updateCursorPosition(color);
this.updateChannelLayers(color)
}
},
onUserInteraction:function(e){
var region=this.inner.getRegion(),mouse=new Ext.lib.Point(e.getXY()).constrainTo(region),width=region.right-this.xSubtraction-region.left,height=region.bottom-this.ySubtraction-region.top,x=Math.min(width-1+this.xSubtraction,mouse.left-region.left)/width,y=Math.min(height-1+this.ySubtraction,region.bottom-mouse.bottom)/height,color=this.value[this.xAxis](x)[this.yAxis](y);
if(!color.equals(this.value)){
if(this.fireEvent('change',color)){
this.setValue(color)
}
}
},
updateCursorPosition:function(color){
var left=Math.round(color[this.xAxis]()*(this.inner.getWidth()-this.xSubtraction)),top=Math.round((1-color[this.yAxis]())*(this.inner.getHeight()-this.ySubtraction));
this.cursor.setLeftTop(left,top)
},
updateChannelLayers:function(color){
this.alpha.setOpacity(color.alpha());
if(Ext.isIE){
this.alpha.setHeight(this.inner.getHeight())
}
}
});
one.color.area.HueSat=Ext.extend(one.color.area.Base,{
xAxis:'hue',
xSubtraction:0,
yAxis:'saturation',
baseChannel:'value',
cls:'valbased',
onRender:function(){
one.color.area.HueSat.superclass.onRender.apply(this,arguments);
if(Ext.isIE){
this.on({
scope:this,
resize:function(e,adjWidth,adjHeight,rawWidth,rawHeight){
this.valEl.setHeight(this.inner.getHeight());
var data={hues:[]},innerWidth=this.inner.getWidth();
if(!innerWidth){
innerWidth=this.width-5
}
for(var i=0;i<innerWidth;i=i+1){
data.hues.push(new one.color.HSV(i/ innerWidth,1,1).hex())
}
this.tpl.overwrite(this.hueEl,data)
}
})
}
},
updateChannelLayers:function(color){
one.color.area.HueSat.superclass.updateChannelLayers.apply(this,arguments);
this.valEl.setOpacity(1-color.value());
if(Ext.isIE){
this.valEl.setHeight(this.inner.getHeight())
}
}
});
Ext.reg('one-color-area-huesat',one.color.area.HueSat);
Ext.ns('one.color.slider');
one.color.installMethod('hexa',function(){
var alphaString=Math.round(this.alpha()*255).toString(16).toUpperCase();
return'#'+'00'.substr(0,2-alphaString.length)+alphaString+this.hex().substr(1,6)
});
one.color.slider.Base=Ext.extend(Ext.BoxComponent,{
vertical:true,
width:25,
height:256,
subtraction:1,
initComponent:function(){
this.addEvents('change')
},
constructor:function(config){
one.color.slider.Base.superclass.constructor.call(this,config);
this.value=this.value||new one.color.HSV(0.5,0.5,0.5,1);
this.autoEl={
cls:'one-color-slider',
cn:{
cls:'inner'+(this.vertical?' vertical':' horizontal'),
cn:[
{cls:'cursor'},
{cls:'alpha'}
]
}
}
},
onRender:function(){
one.color.slider.Base.superclass.onRender.apply(this,arguments);
this.inner=this.el.first();
this.cursor=this.inner.first();
this.alpha=this.cursor.next()
},
afterRender:function(){
one.color.slider.Base.superclass.afterRender.apply(this,arguments);
this.updateCursorPosition(this.value);
this.updateChannelLayers(this.value);
var fn=this.onUserInteraction.createDelegate(this);
new Ext.dd.DragTracker({
onBeforeStart:Ext.emptyFn,
onStart:fn,
onDrag:fn,
onEnd:fn,
tolerance:0,
autoStart:300
}).initEl(this.inner);
this.mon(this.inner,{mousedown:fn})
},
onResize:function(){
one.color.slider.Base.superclass.onResize.apply(this,arguments);
this.updateCursorPosition(this.value)
},
getValue:function(){
return this.value
},
setValue:function(color){
this.value=color;
if(this.rendered){
this.updateCursorPosition(color);
this.updateChannelLayers(color)
}
},
onUserInteraction:function(e){
var region=this.inner.getRegion(),mouse=new Ext.lib.Point(e.getXY()).constrainTo(region),width=region.right-this.subtraction-region.left,height=region.bottom-this.subtraction-region.top,x=Math.min(width-1+this.subtraction,mouse.left-region.left)/width,y=Math.min(height-1+this.subtraction,region.bottom-mouse.bottom)/height,color=this.value[this.baseChannel](this.vertical?y:x);
if(!color.equals(this.value)){
if(this.fireEvent('change',color)){
this.setValue(color)
}
}
},
updateCursorPosition:function(color){
var left,top;
if(this.vertical){
left=Math.floor(this.inner.getWidth()/2);
top=Math.round((1-color[this.baseChannel]())*(this.inner.getHeight()-this.subtraction))-1+this.subtraction
}else{
left=Math.round(color[this.baseChannel]()*(this.inner.getWidth()-this.subtraction));
top=Math.floor(this.inner.getHeight()/2)
}
this.cursor.setLeftTop(left,top)
},
updateChannelLayers:function(color){
var from=color[this.baseChannel](0),to=color[this.baseChannel](1);
this.gradient(from,to)
},
gradient:function(from,to){
var cssa=[
from.cssa(),
to.cssa()
];
if(this.vertical){
if(Ext.isIE6||Ext.isIE7||Ext.isIE8||Ext.isIE9){
this.alpha.setStyle('filter','progid:DXImageTransform.Microsoft.Gradient(GradientType=0, StartColorStr="'+to.hexa()+'", EndColorStr="'+from.hexa()+'")');
this.alpha.setStyle('-ms-filter','"progid:DXImageTransform.Microsoft.Gradient(GradientType=0, StartColorStr=\''+to.hexa()+'\', EndColorStr=\''+from.hexa()+'\')')
}else{
this.alpha.setStyle('background-image','linear-gradient(bottom, '+cssa[0]+', '+cssa[1]+')');
this.alpha.setStyle('background-image','-o-linear-gradient(bottom, '+cssa[0]+', '+cssa[1]+')');
this.alpha.setStyle('background-image','-moz-linear-gradient(bottom, '+cssa[0]+', '+cssa[1]+')');
this.alpha.setStyle('background-image','-webkit-linear-gradient(bottom, '+cssa[0]+', '+cssa[1]+')');
this.alpha.setStyle('background-image','-ms-linear-gradient(bottom, '+cssa[0]+', '+cssa[1]+')');
this.alpha.setStyle('background-image','-webkit-gradient(linear, left bottom,	left top, color-stop(0, '+cssa[0]+', color-stop(1, '+cssa[1]+'))')
}
}else{
if(Ext.isIE6||Ext.isIE7||Ext.isIE8||Ext.isIE9){
this.alpha.setStyle('filter','progid:DXImageTransform.Microsoft.Gradient(GradientType=1, StartColorStr="'+from.hexa()+'", EndColorStr="'+to.hexa()+'")');
this.alpha.setStyle('-ms-filter','"progid:DXImageTransform.Microsoft.Gradient(GradientType=1, StartColorStr=\''+from.hexa()+'\', EndColorStr=\''+to.hexa()+'\')')
}else{
this.alpha.setStyle('background-image','linear-gradient(left, '+cssa[0]+', '+cssa[1]+')');
this.alpha.setStyle('background-image','-o-linear-gradient(left, '+cssa[0]+', '+cssa[1]+')');
this.alpha.setStyle('background-image','-moz-linear-gradient(left, '+cssa[0]+', '+cssa[1]+')');
this.alpha.setStyle('background-image','-webkit-linear-gradient(left, '+cssa[0]+', '+cssa[1]+')');
this.alpha.setStyle('background-image','-ms-linear-gradient(left, '+cssa[0]+', '+cssa[1]+')');
this.alpha.setStyle('background-image','-webkit-gradient(linear, left top,	right top, color-stop(0, '+cssa[0]+', color-stop(1, '+cssa[1]+'))')
}
}
}
});
one.color.slider.Value=Ext.extend(one.color.slider.Base,{
baseChannel:'value',
cls:'value'
});
Ext.reg('one-color-slider-value',one.color.slider.Value);
web.ui.CoreColorPicker=Ext.extend(Ext.Container,{
constructor:function(config){
config=config||{};
var height=config.height||153,width=config.width||153,sliderWidth=25,hueSatWidth=width-sliderWidth-5;
Ext.apply(config,{
width:width,
height:height
});
this.layout={type:'vbox'};
this.items=[{
ref:'colorPickerPanels',
xtype:'container',
layout:'hbox',
width:width,
height:height,
defaults:{
height:height,
listeners:{
change:function(color){
this.setValue(color);
if(typeof color==='object'&&color.isColor){
this.onMousemove()
}
},
scope:this
}
},
items:[
{
ref:'../huesat',
xtype:'one-color-area-huesat',
width:hueSatWidth
},
{
ref:'../slider',
xtype:'one-color-slider-value',
width:sliderWidth
}
]
}];
this.events=[
'adjust',
'change'
];
web.ui.CoreColorPicker.superclass.constructor.call(this,config)
},
afterRender:function(){
web.ui.CoreColorPicker.superclass.afterRender.call(this);
this.colorPickerPanels.on('afterrender',function(){
this.colorPickerPanels.el.on('mousedown',this.onMousedown,this);
web.ui.onMouseup(this.onMouseup,this)
},this);
this.setValue(this.color)
},
onMousedown:function(){
this.active=true;
this.fireEvent('adjust',this,this.color)
},
onMousemove:function(){
if(this.active&&this.color){
this.fireEvent('adjust',this,this.color)
}
},
onMouseup:function(){
if(this.active&&this.color){
this.fireEvent('change',this,this.color);
this.active=false
}
},
setValue:function(color){
if(typeof color==='object'&&color.isColor){
this.color=color;
this.huesat.setValue(this.color);
this.slider.setValue(this.color)
}
}
});
Ext.ComponentMgr.registerType('web-corecolorpicker',web.ui.CoreColorPicker);
web.ui.DoubleColorPicker=Ext.extend(Ext.Container,{
constructor:function(cfg){
cfg=cfg||{};
var colorPickerHeight=cfg.height||153,colorPickerWidth=cfg.width||153;
Ext.apply(cfg,{
width:colorPickerWidth,
height:colorPickerHeight
});
cfg.colorPickerMode=cfg.colorPickerMode||'single';
this.layout={type:'vbox'};
this.items=[{
ref:'coreColorPicker',
xtype:'web-corecolorpicker',
width:colorPickerWidth,
height:colorPickerHeight,
listeners:{
change:function(context,color){
if(cfg.colorPickerMode==='double'){
var whichColor=this.focusedColorField.getName(),firstOrLastColor;
if(whichColor==='firstColor'){
firstOrLastColor='first'
}else{
firstOrLastColor='last'
}
this.fireEvent('change',this,color,firstOrLastColor)
}else{
this.fireEvent('change',context,color)
}
},
adjust:function(context,color){
},
scope:this
}
}];
this.events=[
'adjust',
'change'
];
web.ui.DoubleColorPicker.superclass.constructor.call(this,cfg)
},
afterRender:function(){
web.ui.DoubleColorPicker.superclass.afterRender.call(this);
this.focusedColorField=this.hex
},
setValue:function(color,dontFire){
if(color&&typeof color==='object'&&color.isColor){
this.coreColorPicker.setValue(color);
if(!dontFire){
this.fireEvent('adjust',this,color)
}
}
}
});
Ext.ComponentMgr.registerType('web-doublecolorpicker',web.ui.DoubleColorPicker);
Ext.ns('web.ui.colorPanel');
Ext.ns('web.ui.layout');
Ext.layout.FlexSpacer=Ext.extend(Ext.Component,{
xtype:'flexspacer',
autoEl:{
tag:'div',
html:'&nbsp;'
},
flex:1
});
Ext.reg(Ext.layout.FlexSpacer.prototype.xtype,Ext.layout.FlexSpacer);
Ext.layout.FlexLayout=Ext.extend(Ext.layout.ContainerLayout,{
defaultMargins:{
left:0,
top:0,
right:0,
bottom:0
},
padding:'0',
align:'',
monitorResize:true,
type:'flex',
scrollOffset:0,
extraCls:'',
targetCls:'',
innerCls:'',
constructor:function(config){
Ext.layout.FlexLayout.superclass.constructor.call(this,config);
if(Ext.isString(this.defaultMargins)){
this.defaultMargins=this.parseMargins(this.defaultMargins)
}
},
onLayout:function(container,target){
Ext.layout.FlexLayout.superclass.onLayout.call(this,container,target);
var items=this.getVisibleItems(container);
var i,visibleCount=items.length,child;
for(i=0;i<visibleCount;i+=1){
child=items[i];
if(this.type==='hflex'){
child.addClass(this.extraCls+(child.flex?'-flex':'-auto'))
}
if(this.align){
child.getEl().setStyle('vertical-align',this.align)
}
}
},
isValidParent:function(c,target){
return this.innerCt&&c.getPositionEl().dom.parentNode===this.innerCt.dom
},
getVisibleItems:function(ct){
ct=ct||this.container;
var t=ct.getLayoutTarget(),cti=ct.items.items,len=cti.length,i,c,items=[];
for(i=0;i<len;i+=1){
if((c=cti[i]).rendered&&this.isValidParent(c,t)&&c.hidden!==true&&c.collapsed!==true&&c.shouldLayout!==false){
items.push(c)
}
}
return items
},
renderAll:function(ct,target){
if(!this.innerCt){
this.innerCt=target.createChild({cls:this.innerCls})
}
Ext.layout.FlexLayout.superclass.renderAll.call(this,ct,this.innerCt)
},
renderItem:function(c){
if(Ext.isString(c.margins)){
c.margins=this.parseMargins(c.margins)
}else if(!c.margins){
c.margins=this.defaultMargins
}
Ext.layout.FlexLayout.superclass.renderItem.apply(this,arguments)
},
destroy:function(){
Ext.destroy(this.overflowHandler);
Ext.layout.FlexLayout.superclass.destroy.apply(this,arguments)
}
});
Ext.layout.HFlexLayout=Ext.extend(Ext.layout.FlexLayout,{
align:'',
type:'hflex',
targetCls:'hflex-ct',
extraCls:'hflex-item',
innerCls:'hflex-inner'
});
Ext.Container.LAYOUTS.hflex=Ext.layout.HFlexLayout;
web.ui.CustomSlider=Ext.extend(Ext.Container,{
constructor:function(config){
var height=config.height||'auto',width=config.width||150,sliderLabel=config.sliderLabel||' ',sliderLabelWidth=config.sliderLabelWidth||'auto',sliderMinValue=config.sliderMinValue||0,sliderMaxValue=config.sliderMaxValue||100,sliderIncrement=config.sliderIncrement||1;
config=config||{};
Ext.apply(config,{
width:width,
height:height
});
this.layout={type:'hflex'};
this.items=[
{
xtype:'label',
text:sliderLabel,
width:sliderLabelWidth
},
{
xtype:'slider',
ref:'slider',
cls:'x-slider-horz__custom',
width:100,
increment:sliderIncrement,
minValue:sliderMinValue,
maxValue:sliderMaxValue,
listeners:{
change:function(slider,newValue,thumb){
if(thumb.dragging===false){
this.onChange(slider.getValue())
}
},
dragend:function(context){
this.onChange(context.getValue())
},
scope:this
}
},
{
name:'sliderNumberField',
ref:'sliderNumberField',
cls:'customSliderNumberField',
xtype:'numberfield',
width:30,
enableKeyEvents:true,
validator:function(value){
return value>=0&&value<=255?true:this.invalidText
},
listeners:{
keyup:function(field,event){
var value=field.getValue();
if(value!==field.oldValue){
field.oldValue=value;
if(typeof parseInt(value,10)==='number'&&value>=0&&value<=255){
this.fieldValidate(field)
}
}
},
keydown:function(field){
field.oldValue=field.getValue()
},
scope:this
}
}
];
this.events=['change'];
web.ui.CustomSlider.superclass.constructor.call(this,config)
},
setValue:function(sliderValue,animate,supress){
if(typeof sliderValue==='number'){
this.sliderValue=sliderValue;
if(supress){
this.slider.suspendEvents();
this.sliderNumberField.suspendEvents()
}
this.slider.setValue(Math.round(sliderValue),animate);
this.sliderNumberField.setValue(sliderValue);
this.slider.syncThumb();
if(supress){
this.slider.resumeEvents();
this.sliderNumberField.resumeEvents()
}
}
},
onChange:function(value){
if(typeof value==='number'){
this.sliderNumberField.setValue(value);
this.fireEvent('change',this,value)
}
},
fieldValidate:function(field){
var value=this.sliderNumberField.getValue();
this.slider.setValue(value,true);
this.sliderNumberField.setValue(value);
this.fireEvent('change',this,value);
if(field){
field.focus()
}
}
});
Ext.ComponentMgr.registerType('web-CustomSlider',web.ui.CustomSlider);
Ext.layout.VFlexLayout=Ext.extend(Ext.layout.FlexLayout,{
align:'top',
type:'vflex',
targetCls:'vflex-ct',
extraCls:'vflex-item',
rowCls:'vflex-row',
innerCls:'vflex-inner',
isValidParent:function(c,target){
return this.innerCt&&c.getPositionEl().dom.parentNode.parentNode===this.innerCt.dom
},
renderAll:function(ct,target){
if(!this.innerCt){
this.innerCt=target.createChild({cls:this.innerCls});
this.padding=this.parseMargins(this.padding)
}
var items=ct.items.items;
this.wrappers=this.wrappers||[];
items.forEach(function(c,i){
var cls,temp,auto=this.rowCls+'-auto';
if(c&&(!c.rendered||!this.isValidParent(c,target))){
cls=c.flex?'':auto;
if(!this.wrappers[i]){
this.wrappers[i]=this.innerCt.createChild({cls:this.rowCls+' '+cls})
}else{
temp=this.wrappers[i];
temp.removeClass(auto);
if(cls){
temp.addClass(cls)
}
}
this.renderItem(c,i,this.wrappers[i])
}
},this)
}
});
Ext.Container.LAYOUTS.vflex=Ext.layout.VFlexLayout;
web.ui.colorPanel.RGBslider=Ext.extend(Ext.Container,{
constructor:function(cfg){
this.width=cfg.width||153;
this.height=cfg.height||153;
this.color=null;
delete cfg.width;
delete cfg.height;
this.invalidText='Invalid color';
this.layout={type:'vflex'};
this.items=[
{
xtype:'web-CustomSlider',
ref:'redSlider',
width:200,
sliderLabel:'Red',
sliderLabelWidth:72,
sliderMinValue:0,
sliderMaxValue:255,
sliderIncrement:1,
listeners:{
change:function(slider,sliderValue){
this.onChangeColor('red',sliderValue/slider.sliderMaxValue)
},
scope:this
}
},
{
xtype:'web-CustomSlider',
ref:'greenSlider',
width:200,
sliderLabel:'Green',
sliderLabelWidth:72,
sliderMinValue:0,
sliderMaxValue:255,
sliderIncrement:1,
listeners:{
change:function(slider,sliderValue){
this.onChangeColor('green',sliderValue/slider.sliderMaxValue)
},
scope:this
}
},
{
xtype:'web-CustomSlider',
ref:'blueSlider',
width:200,
sliderLabel:'Blue',
sliderLabelWidth:72,
sliderMinValue:0,
sliderMaxValue:255,
sliderIncrement:1,
listeners:{
change:function(slider,sliderValue){
this.onChangeColor('blue',sliderValue/slider.sliderMaxValue)
},
scope:this
}
}
];
this.events=[
'adjust',
'change'
];
web.ui.colorPanel.RGBslider.superclass.constructor.call(this,cfg)
},
setValue:function(color,dontFire){
if(color&&typeof color==='object'&&color.isColor){
this.color=color;
this.redSlider.setValue(Math.round(color.r()*255),false,dontFire);
this.greenSlider.setValue(Math.round(color.g()*255),false,dontFire);
this.blueSlider.setValue(Math.round(color.b()*255),false,dontFire);
if(!dontFire){
this.fireEvent('adjust',this,color)
}
}
},
onChangeColor:function(type,value){
var color;
if(!this.color){
this.redSlider.suspendEvents();
this.redSlider.setValue(0);
this.redSlider.resumeEvents();
this.greenSlider.suspendEvents();
this.greenSlider.setValue(0);
this.greenSlider.resumeEvents();
this.blueSlider.suspendEvents();
this.blueSlider.setValue(0);
this.blueSlider.resumeEvents();
this.doLayout();
this.color=new one.color.RGB(0,0,0)
}
color=this.color[type](value);
if(color&&typeof color==='object'&&color.isColor){
this.fireEvent('change',this,color)
}
}
});
Ext.ComponentMgr.registerType('web-RGBslider',web.ui.colorPanel.RGBslider);
web.ui.colorPanel.ColorPanel=Ext.extend(Ext.Container,{
constructor:function(cfg){
var colorPickerMode=cfg.colorPickerMode||'single',that=this;
this.width=cfg.width||265;
this.height='auto';
this.showTransparency=cfg.showTransparency||false;
this.style={padding:'3px'};
this.enablePanel=cfg.enablePanel||false;
this.color=null;
this.layout={type:'vflex'};
delete cfg.width;
delete cfg.height;
this.colorPanel=new Ext.TabPanel({
cls:'colorPanel',
activeTab:0,
listeners:{
'tabchange':function(context,value){
if(value.component==='colorPicker'){
this.colorPicker.setValue(this.color,true)
}else if(value.component==='rgbSlider'){
this.rgbSlider.setValue(this.color,true)
}
},
scope:this
},
items:[
{
header:true,
component:'colorPicker',
items:[{
layout:'vflex',
width:240,
border:false,
labelWidth:50,
items:[{
name:'color',
ref:'../../../colorPicker',
xtype:'web-doublecolorpicker',
width:235,
height:110,
disabled:true,
listeners:{
change:function(context,color){
this.setColor(color,'colorPicker');
this.updateTransparencySlider(color)
},
scope:this
}
}]
}]
},
{
header:true,
component:'rgbSlider',
items:[{
layout:'vflex',
width:230,
cls:'rgbSlider-tab',
border:false,
labelWidth:50,
items:[{
name:'rgbSlider',
ref:'../../../rgbSlider',
cls:'color-slider-tab',
xtype:'web-RGBslider',
width:230,
height:100,
disabled:true,
listeners:{
change:function(context,color){
this.setColor(color,'rgbSlider');
this.updateTransparencySlider(color)
},
scope:this
}
}]
}]
}
]
});
this.transparencySlider=new web.ui.CustomSlider({
style:{'padding':'10px 0 5px 2px'},
width:200,
hidden:true,
sliderLabel:'Color Transparency',
sliderLabelWidth:122,
sliderMinValue:0,
sliderMaxValue:100,
sliderIncrement:1,
listeners:{
change:function(slider,sliderValue){
this.onChangeTransparency(sliderValue/slider.sliderMaxValue)
},
scope:this
}
});
this.items=[
{
xtype:'container',
layout:'hauto',
items:function(){
var arr=[],item={
ref:'../hex',
name:'firstColor',
xtype:'textfield',
emptyText:'Select color',
invalidText:'Invalid color.',
hideLabel:true,
width:cfg.colorFieldWidth||65,
style:{
'float':'right',
fontFamily:'monospace'
},
enableKeyEvents:true,
listeners:{
keyup:function(field){
var value=field.getValue(),color=false;
if(value.length===7){
color=new one.color(value);
color=color.alpha(this.getAlphaTransparency()/100);
this.color=color;
if(color){
this.setColor(color,true);
this.updateTransparencySlider(color);
var whichColor=this.focusedColorField.getName(),firstOrLastColor;
if(whichColor==='firstColor'){
firstOrLastColor='first'
}else{
firstOrLastColor='last'
}
this.fireEvent('change',this,color,firstOrLastColor);
field.focus();
this.colorPicker.setValue(color,true)
}
}
},
focus:function(field){
this.focusedColorField=field;
var value=field.getValue(),color=false;
if(value.length===7){
color=new one.color(value);
color=color.alpha(this.getAlphaTransparency()/100);
this.color=color;
if(color){
this.setColor(color,'both',true);
this.updateTransparencySlider(color)
}
}
},
scope:that
},
validator:function(value){
return/#[a-fA-F\d]{6}/.test(value)?true:this.invalidText
}
};
if(colorPickerMode==='double'){
arr.push({
xtype:'displayfield',
cls:'x-form-item',
style:{
lineHeight:'18px',
marginBottom:'0',
fontSize:'11px'
},
value:'Hex Color:',
width:90
});
arr.push(Ext.apply({},{
ref:'../hexTo',
name:'lastColor',
style:{
fontFamily:'monospace',
'float':'right'
}
},item));
arr.push({
xtype:'displayfield',
style:'float:right;margin-top:4px',
cls:'icon icon-toArrow '
});
arr.push(item)
}else{
arr.push({
xtype:'displayfield',
cls:'x-form-item',
style:{
lineHeight:'18px',
marginBottom:'0',
fontSize:'11px',
'width':'auto',
'margin-right':'5px'
},
value:'Hex Color:'
});
arr.push(item)
}
return arr
}()
},
this.colorPanel,
this.transparencySlider
];
this.events=[
'adjust',
'change'
];
web.ui.colorPanel.ColorPanel.superclass.constructor.call(this,cfg);
this.colorFields=[
this.colorPicker,
this.rgbSlider
]
},
afterRender:function(){
var colorPanelHeaderTabs=null;
web.ui.colorPanel.ColorPanel.superclass.afterRender.call(this);
this.colorPicker.on('afterrender',function(){
colorPanelHeaderTabs=this.getEl().dom.querySelectorAll('.x-tab-strip-top li .x-tab-strip-text');
if(colorPanelHeaderTabs){
colorPanelHeaderTabs[0].innerHTML='<span class="icon tab-color-picker-icon">&nbsp</span>';
colorPanelHeaderTabs[1].innerHTML='<span class="icon slider-color-picker-icon">&nbsp</span>'
}
},this);
if(this.showTransparency){
this.transparencySlider.show()
}
if(this.enablePanel){
this.updateColorPanelVisibility(true)
}
},
setColor:function(color,component,suppress){
var relevantField=this.focusedColorField||this.hex;
if(this.colorPicker.disabled&&!suppress){
return
}
color=Ext.isArray(color)||Ext.isString(color)?one.color(color):color;
if(!this.showTransparency){
color=color.alpha(1)
}
this.color=color;
if(component==='colorPicker'||component==='both'){
this.colorPicker.setValue(color,true)
}
if(component==='rgbSlider'||component==='both'){
this.rgbSlider.setValue(color,true)
}
if(this.color){
this.updateColorPanelVisibility(true);
this.updateHexFieldColor(this.color);
relevantField.setValue(color.hex());
this.colorPicker.setValue(color,true)
}
if(!suppress){
if(this.colorPickerMode==='double'){
var whichColor=relevantField.getName(),firstOrLastColor;
if(whichColor==='firstColor'){
firstOrLastColor='first'
}else{
firstOrLastColor='last'
}
this.fireEvent('change',this,color,firstOrLastColor)
}else{
this.fireEvent('change',this,color)
}
}
},
updateColorPanelVisibility:function(removeBtnIsVisible){
if(removeBtnIsVisible){
this.colorFields.forEach(function(field){
field.enable()
})
}
},
getColor:function(){
return this.color
},
updateHexFieldColor:function(color){
var relevantField=this.focusedColorField||this.hex,el=relevantField.el,brightnessRating;
if(color&&el){
el.dom.style.background=color.css();
brightnessRating=(0.8*color.r()+1.6*color.g()+0.6*color.b())*256;
el.dom.style.color=brightnessRating>384?'#000':'#FFF'
}
},
onChangeTransparency:function(value){
var color;
if(!this.color){
this.setTransparencyToSlider(100);
this.doLayout();
this.color=new one.color.RGB(0,0,0)
}
color=this.color.alpha(value);
if(color&&typeof color==='object'&&color.isColor){
this.setColor(color,'both')
}
},
setTransparencyToSlider:function(transparency){
this.transparencySlider.suspendEvents();
this.transparencySlider.setValue(transparency,false,true);
this.transparencySlider.resumeEvents()
},
updateTransparencySlider:function(color){
if(this.showTransparency){
this.setTransparencyToSlider(color.alpha()*100)
}
},
getAlphaTransparency:function(){
return isNaN(parseInt(this.transparencySlider.sliderNumberField.getValue()))?100:this.transparencySlider.sliderNumberField.getValue()
},
setDefaults:function(){
var color=new one.color.HSV(0.5,0.5,0.5,1);
this.suspendEvents();
this.hex.setValue('');
this.hex.clearInvalid();
if(this.hex.getEl()){
this.hex.getEl().setStyle({
'background-color':'transparent',
color:'gray'
})
}
this.setColor(color,'both',true,true);
this.updateTransparencySlider(color);
this.resumeEvents()
}
});
Ext.ComponentMgr.registerType('web-colorpanel',web.ui.colorPanel.ColorPanel);
web.windows.blockProps.Background=Ext.extend(web.windows.Window,{
initComponent:function(){
var that=this;
this.type='web.windows.blockProps.Background';
this.title='Background';
this.resizable=false;
this.width=830;
this.layout='auto';
this.items=[
{
ref:'radios',
xtype:'radiogroup',
style:{marginBottom:'17px'},
listeners:{
change:this.onChangeRadioBtn,
scope:this
},
defaults:{name:'bg'},
items:[
{
itemId:'none',
boxLabel:'No Background',
ctCls:'styleblock-radio'
},
{
itemId:'image',
boxLabel:'Color/Image',
ctCls:'styleblock-radio'
},
{
itemId:'gradient',
boxLabel:'Gradient',
ctCls:'styleblock-radio'
}
]
},
{
xtype:'container',
layout:'hbox',
cls:'one-separator',
height:1,
style:{marginBottom:'20px'}
},
{
itemId:'cards',
ref:'cards',
border:false,
layout:'card',
layoutOnCardChange:true,
activeItem:0,
defaults:{
border:false,
hideMode:'offsets'
},
items:[
{
itemId:'none',
html:'No settings'
},
{
itemId:'image',
ref:'imageForm',
layout:'column',
items:[
{
name:'color',
ref:'bgcolor',
xtype:'web-colorpanel',
showTransparency:true,
enablePanel:true,
listeners:{
change:function(context,color){
this.onChangeBgColor(color)
},
scope:this
}
},
{
xtype:'spacer',
cls:'one-separator',
style:'margin: 0 0 0 19px',
width:1,
height:165
},
{
layout:'form',
columnWidth:1,
border:false,
labelWidth:120,
style:{paddingLeft:'20px'},
items:[
{
name:'imageId',
ref:'../imageField',
xtype:'label',
fieldLabel:'Image',
text:'None'
},
{
fieldLabel:'&nbsp;',
labelSeparator:'',
border:false,
layout:'hbox',
items:[
{
xtype:'button',
text:'Select image',
tooltip:'Select an image on your web space.',
handler:function(){
this.app.windows.show({
type:'web.windows.Image',
app:this.app,
okFn:function(win,selection){
this.cards.imageForm.removeImageBtn.enable();
this.onChangeImage(selection.images[0])
},
values:{paths:this.initialStyle.asset&&[this.initialStyle.asset.url]||[]},
scope:this
})
},
scope:this
},
{
xtype:'spacer',
width:5
},
{
ref:'../../removeImageBtn',
xtype:'button',
text:'Remove Image',
tooltip:'Remove the selected image.',
disabled:true,
handler:function(button){
button.disable();
this.onChangeImage(null,null)
},
scope:this
}
]
},
{
ref:'../repeat',
xtype:'checkboxgroup',
fieldLabel:'Repeat',
items:[
{
boxLabel:'Horizontally',
name:'horizontalRepeat'
},
{
boxLabel:'Vertically',
name:'verticalRepeat'
}
],
listeners:{
change:this.onChangeImageRepeat,
scope:this
}
},
{
xtype:'buttongroup',
fieldLabel:'Horizontal position',
ref:'../horizontalPosition',
cls:'web-panel-button-group',
items:[
{
xtype:'button',
ref:'left',
enableToggle:true,
toggleGroup:'horizontalPosition',
text:'Left',
toggleHandler:this.onChangeImagePosition.createDelegate(this,['0%'],true),
scope:this
},
{
xtype:'button',
ref:'center',
enableToggle:true,
toggleGroup:'horizontalPosition',
text:'Center',
toggleHandler:this.onChangeImagePosition.createDelegate(this,['50%'],true),
scope:this
},
{
xtype:'button',
ref:'right',
enableToggle:true,
toggleGroup:'horizontalPosition',
text:'Right',
toggleHandler:this.onChangeImagePosition.createDelegate(this,['100%'],true),
scope:this
}
]
},
{
xtype:'buttongroup',
fieldLabel:'Vertical position',
ref:'../verticalPosition',
cls:'web-panel-button-group',
items:[
{
xtype:'button',
ref:'top',
enableToggle:true,
toggleGroup:'verticalPosition',
text:'Top',
toggleHandler:this.onChangeImagePosition.createDelegate(this,['0%'],true),
scope:this
},
{
xtype:'button',
ref:'center',
enableToggle:true,
toggleGroup:'verticalPosition',
text:'Center',
toggleHandler:this.onChangeImagePosition.createDelegate(this,['50%'],true),
scope:this
},
{
xtype:'button',
ref:'bottom',
enableToggle:true,
toggleGroup:'verticalPosition',
text:'Bottom',
toggleHandler:this.onChangeImagePosition.createDelegate(this,['100%'],true),
scope:this
}
]
},
{
xtype:'buttongroup',
fieldLabel:'Size',
ref:'../backgroundSize',
cls:'web-panel-button-group',
items:[
{
xtype:'button',
ref:'fit',
enableToggle:true,
toggleGroup:'backgroundSize',
text:'Fit',
toggleHandler:function(button,pressed){
this.onChangeImageSize('fit',pressed)
},
scope:this
},
{
xtype:'button',
ref:'fill',
enableToggle:true,
toggleGroup:'backgroundSize',
text:'Fill',
toggleHandler:function(button,pressed){
this.onChangeImageSize('fill',pressed)
},
scope:this
},
{
xtype:'button',
ref:'zoom',
enableToggle:true,
toggleGroup:'backgroundSize',
text:'Zoom',
toggleHandler:function(button,pressed){
this.cards.imageForm.backgroundSize.zoomSlider.setVisible(pressed);
this.cards.imageForm.backgroundSize.doLayout();
this.onChangeImageSize('zoom',pressed)
},
scope:this
},
{
xtype:'spacer',
width:10
},
{
xtype:'sliderfield',
ref:'zoomSlider',
width:100,
increment:1,
minValue:1,
maxValue:100,
value:100,
hidden:true,
listeners:{
valid:function(slider){
var that=this;
if(this.zoomDelay){
clearTimeout(this.zoomDelay)
}
this.zoomDelay=setTimeout(function(){
that.zoomDelay=null;
that.onChangeImageSize('zoomSlider',slider.getValue())
},500)
},
scope:this
}
}
]
}
]
}
]
},
{
itemId:'gradient',
ref:'gradientForm',
layout:'column',
items:[
{
name:'color',
ref:'bgcolor',
xtype:'web-colorpanel',
colorPickerMode:'double',
listeners:{
change:function(gradientColorPicker,color,firstOrLastColor){
if(gradientColorPicker.colorPickerMode==='double'){
this.onChangeGradientColor(color,firstOrLastColor)
}else{
this.onChangeBgColor(color)
}
},
scope:this
}
},
{
xtype:'spacer',
cls:'one-separator',
style:'margin: 0 0 0 19px',
width:1,
height:142
},
{
layout:'form',
columnWidth:1,
labelWidth:150,
border:false,
padding:'0 0 0 20px',
listeners:{
beforerender:function(component){
if(Ext.isIE8||Ext.isIE9){
component.add({
xtype:'box',
cls:'web-browser-gradient-unsupported',
anchor:'bottom',
html:'<strong>'+'This feature is not supported by your browser (Internet Explorer 8 and 9).'+'</strong> '+'Please use the latest version of Google Chrome, Firefox, Safari, or Opera.'
})
}
}
},
items:[
{
ref:'../direction',
xtype:'radiogroup',
fieldLabel:'Direction',
defaults:{name:'direction'},
items:[
{
itemId:'horizontal',
boxLabel:'Horizontal',
checked:true
},
{
itemId:'vertical',
boxLabel:'Vertical'
}
],
listeners:{
change:this.onChangeGradientDirection,
scope:this
}
},
{
xtype:'compositefield',
items:[
{
ref:'../../fadePoint',
xtype:'trigger',
triggerClass:'x-form-arrow-trigger',
name:'fadepoint',
width:50,
fieldLabel:'Fade point',
onTriggerClick:function(e){
if(!this.menu){
this.menu=new Ext.menu.Menu({
allowOtherMenus:true,
cls:'air-slider',
items:[{
xtype:'slider',
width:100,
value:50,
listeners:{
change:function(slider,newValue,thumb){
if(thumb.dragging===false){
that.onSlideFadePoint(slider)
}
},
dragend:that.onSlideFadePoint,
scope:that
}
}]
});
this.menu.on('show',function(){
var slider=this.menu.items.items[0];
slider.suspendEvents();
slider.setValue(Number(this.getValue()));
slider.resumeEvents()
},this)
}
this.menu.show(this.el,'bl')
},
listeners:{
blur:this.onTextFadePoint,
scope:this
}
},
{
xtype:'displayfield',
value:'%'
}
]
}
]
}
]
}
]
}
];
this.addEvents('adjust');
web.windows.blockProps.Background.superclass.initComponent.apply(this)
},
defaultSettings:function(option){
var settings={
gradient:null,
imageId:null,
color:null,
repeat:[
true,
true
],
position:[
'0%',
'0%'
],
size:null
};
return{
gradient:function(){
var gradient=Ext.apply({},settings);
return Ext.apply(gradient,{
gradient:{
gradType:'linear',
size:'farthest-corner',
origin:'left',
stops:[
[
one.color('#FFF').toJSON(),
'0%'
],
[
one.color('#FFF').toJSON(),
'100%'
]
]
}
})
},
image:function(){
return Ext.apply({},settings)
},
none:function(){
return Ext.apply({},settings)
}
}
}(),
setValues:function(values){
var selected,style;
style=Ext.apply({},values);
if(style.forceBackground){
this.radios.items.items[0].disable()
}else{
this.radios.items.items[0].enable()
}
if(style.gradient){
selected='gradient'
}else if(style.asset||style.color){
selected='image'
}else{
selected='none'
}
this.initialStyle=style;
this.uiSetters[selected].call(this,style)
},
updateColorField:function(colorField,color){
var el=colorField.el;
if(color&&el){
el.dom.style.background=color.css();
el.dom.style.color=color.value()>0.5?'#000':'#FFF'
}
},
setBgColor:function(color){
var style=this.initialStyle,form=this.cards.imageForm;
style.color=color;
color=Ext.isArray(color)?one.color(color):color;
form.bgcolor.setColor(color,'both',true);
form.bgcolor.updateTransparencySlider(color);
return color
},
enableDisableButtonsInGroup:function(btnGroup,enableOrDisable){
btnGroup.cascade(function(){
if(this!==btnGroup){
if(enableOrDisable==='disable'){
this.disable()
}else{
this.enable()
}
}
})
},
uiSetters:{
none:function(){
this.radios.items.items[0].setValue(true)
},
image:function(style){
var imageForm=this.cards.imageForm,asset,x,y,xb,yb;
this.radios.items.items[1].setValue(true);
if(style.asset){
asset=new web.data.assets.Image(style.asset);
imageForm.imageField.update(this.formatFileName(asset.getFilename()));
imageForm.removeImageBtn.enable();
imageForm.repeat.enable();
this.enableDisableButtonsInGroup(imageForm.horizontalPosition,'enable');
this.enableDisableButtonsInGroup(imageForm.verticalPosition,'enable');
imageForm.backgroundSize.fit.enable();
imageForm.backgroundSize.fill.enable();
imageForm.backgroundSize.zoom.enable();
imageForm.backgroundSize.zoomSlider.enable()
}else{
imageForm.imageField.setText('None');
imageForm.removeImageBtn.disable();
imageForm.repeat.disable();
this.enableDisableButtonsInGroup(imageForm.horizontalPosition,'disable');
this.enableDisableButtonsInGroup(imageForm.verticalPosition,'disable');
imageForm.backgroundSize.fit.disable();
imageForm.backgroundSize.fill.disable();
imageForm.backgroundSize.zoom.disable();
imageForm.backgroundSize.zoomSlider.disable()
}
imageForm.repeat.suspendEvents();
if(Ext.isArray(style.repeat)){
imageForm.repeat.setValue([
style.repeat[0],
style.repeat[1]
])
}else{
imageForm.repeat.setValue([
true,
true
])
}
imageForm.repeat.resumeEvents();
imageForm.horizontalPosition.suspendEvents();
imageForm.verticalPosition.suspendEvents();
if(Ext.isArray(style.position)){
x=style.position[0];
y=style.position[1];
x=Ext.isNumber(x)?x:+x.replace('%','');
y=Ext.isNumber(y)?y:+y.replace('%','');
xb=x<25?'left':x>75?'right':'center';
yb=y<25?'top':y>75?'bottom':'center'
}else{
xb='left';
yb='top'
}
imageForm.horizontalPosition.left.toggle(xb==='left',true);
imageForm.horizontalPosition.center.toggle(xb==='center',true);
imageForm.horizontalPosition.right.toggle(xb==='right',true);
imageForm.verticalPosition.top.toggle(yb==='top',true);
imageForm.verticalPosition.center.toggle(yb==='center',true);
imageForm.verticalPosition.bottom.toggle(yb==='bottom',true);
imageForm.horizontalPosition.resumeEvents();
imageForm.verticalPosition.resumeEvents();
if(style.color){
this.setBgColor(one.color(style.color))
}
imageForm.backgroundSize.zoomSlider.suspendEvents();
imageForm.backgroundSize.fit.toggle(false,true);
imageForm.backgroundSize.fill.toggle(false,true);
imageForm.backgroundSize.zoom.toggle(false,true);
if(style.size!==null&&Ext.isNumber(style.size)){
imageForm.backgroundSize.zoom.toggle(true,true);
imageForm.backgroundSize.zoomSlider.setValue(style.size,false)
}else if(style.size==='fit'){
imageForm.backgroundSize.fit.toggle(true,true)
}else if(style.size==='fill'){
imageForm.backgroundSize.fill.toggle(true,true)
}
imageForm.backgroundSize.zoomSlider.setVisible(imageForm.backgroundSize.zoom.pressed);
imageForm.backgroundSize.doLayout();
imageForm.backgroundSize.zoomSlider.resumeEvents()
},
gradient:function(style){
var gradientForm=this.cards.gradientForm,gradient=style.gradient,originMap={
left:0,
top:1
},startColor=one.color(gradient.stops[0][0]),endColor=one.color(gradient.stops[1][0]),fadePoint,radioBtn;
this.radios.items.items[2].setValue(true);
gradientForm.bgcolor.hex.setValue(startColor.hex());
this.updateColorField(gradientForm.bgcolor.hex,startColor);
gradientForm.bgcolor.setColor(startColor,true,true);
gradientForm.bgcolor.updateTransparencySlider(startColor);
gradientForm.bgcolor.hexTo.setRawValue(endColor.hex());
this.updateColorField(gradientForm.bgcolor.hexTo,endColor);
radioBtn=gradientForm.direction.items.items[originMap[gradient.origin]];
radioBtn.checked=true;
radioBtn.setValue(true);
if(parseInt(gradient.stops[0][1],10)>0){
fadePoint=50+parseInt(gradient.stops[0][1],10)/2
}else{
fadePoint=parseInt(gradient.stops[1][1],10)/2
}
gradientForm.fadePoint.suspendEvents();
gradientForm.fadePoint.setValue(fadePoint);
gradientForm.fadePoint.resumeEvents()
}
},
onChangeRadioBtn:function(radiogroup,checked){
var style=this.initialStyle,selected,gradColor;
if(checked){
selected=checked.itemId;
this.cards.layout.setActiveItem(checked.itemId);
if(selected==='gradient'){
if(!style.gradient){
gradColor=style.color||'#FFF';
style.gradient=Ext.apply(this.defaultSettings.gradient().gradient,{
stops:[
[
one.color(gradColor).toJSON(),
'0%'
],
[
one.color(gradColor).toJSON(),
'100%'
]
]
})
}
}else if(selected==='image'){
if(!style.color){
style.color=style.gradient?style.gradient.stops[0][0]:null
}
style.imageId=style.imageId||null
}
this.uiSetters[selected].call(this,style);
switch(selected){
case'gradient':
if(style.gradient){
this.fireEvent('adjust',{
background:{
gradient:style.gradient,
color:null,
asset:null
}
})
}
break;
case'image':
if(style.color||style.asset){
this.fireEvent('adjust',{
background:{
color:style.color,
asset:style.asset,
gradient:null
}
})
}
break;
default:
if(style.asset||style.color||style.gradient){
this.fireEvent('adjust',{
background:{
asset:null,
color:null,
gradient:null
}
})
}
}
}
},
onChangeBgColor:function(color){
color=this.setBgColor(color);
this.fireEvent('adjust',{
background:{
color:color,
gradient:null
}
})
},
onChangeImage:function(image){
var style=this.initialStyle,background=this.defaultSettings.image(),imageForm=this.cards.imageForm;
if(image){
image=new web.data.assets.Image(image);
background.asset=image;
imageForm.imageField.update(this.formatFileName(image.getURL().replace(/.*\//,'')));
imageForm.repeat.enable();
this.enableDisableButtonsInGroup(imageForm.horizontalPosition,'enable');
this.enableDisableButtonsInGroup(imageForm.verticalPosition,'enable');
imageForm.backgroundSize.fit.enable();
imageForm.backgroundSize.fill.enable();
imageForm.backgroundSize.zoom.enable();
imageForm.backgroundSize.zoomSlider.enable();
background.repeat=this.initialStyle.repeat;
background.position=this.initialStyle.position;
background.size=this.initialStyle.size
}else{
background.asset=null;
imageForm.imageField.setText('None');
imageForm.repeat.disable();
imageForm.horizontalPosition.left.toggle();
imageForm.verticalPosition.top.toggle();
imageForm.backgroundSize.fit.toggle(false);
imageForm.backgroundSize.fill.toggle(false);
imageForm.backgroundSize.zoomSlider.setValue(100);
imageForm.backgroundSize.zoomSlider.slider.syncThumb();
imageForm.backgroundSize.zoom.toggle(false);
this.enableDisableButtonsInGroup(imageForm.horizontalPosition,'disable');
this.enableDisableButtonsInGroup(imageForm.verticalPosition,'disable');
imageForm.backgroundSize.fit.disable();
imageForm.backgroundSize.fill.disable();
imageForm.backgroundSize.zoom.disable();
imageForm.backgroundSize.zoomSlider.disable()
}
background.color=style.color||background.color;
this.fireEvent('adjust',{background:background})
},
onChangeImageRepeat:function(repeatGroup,checked){
var repeat=[
false,
false
],map={
horizontalRepeat:0,
verticalRepeat:1
};
checked.forEach(function(checkbox){
repeat[map[checkbox.getName()]]=true
});
this.initialStyle.repeat=repeat;
this.fireEvent('adjust',{background:{repeat:repeat}})
},
onChangeImagePosition:function(button,pressed,value){
if(pressed){
var map={
horizontalPosition:0,
verticalPosition:1
},position=this.initialStyle.position||[
'0%',
'0%'
];
position[map[button.toggleGroup]]=value;
this.initialStyle.position=position;
this.fireEvent('adjust',{background:{position:position}})
}else{
var bt=button,ow=bt.ownerCt;
if(bt.toggleGroup==='horizontalPosition'&&!ow.left.pressed&&!ow.center.pressed&&!ow.right.pressed){
bt.toggle(true,true)
}
if(bt.toggleGroup==='verticalPosition'&&!ow.top.pressed&&!ow.center.pressed&&!ow.bottom.pressed){
bt.toggle(true,true)
}
}
},
onChangeImageSize:function(button,value){
var size;
if(button==='fit'||button==='fill'){
size=value&&button||null
}
if(button==='zoom'){
if(value){
size=this.cards.imageForm.backgroundSize.zoomSlider.getValue()
}else{
size=null
}
}
if(button==='zoomSlider'){
size=value
}
this.initialStyle.size=size;
this.fireEvent('adjust',{background:{size:size}})
},
onGradientColorFocus:function(field){
this.onChangeGradientColor(one.color(field.getValue()))
},
onChangeGradientColor:function(color,firstOrLastColor){
var style=this.initialStyle,gradient=style.gradient,map={
first:0,
last:1
};
if(color){
gradient.stops[map[firstOrLastColor]][0]=color;
this.fireEvent('adjust',{background:{gradient:gradient}})
}
},
onChangeGradientDirection:function(radiogroup,checked){
if(!checked){
return
}
var itemId=checked.getItemId(),gradient=this.initialStyle.gradient,original=gradient.origin;
if(itemId==='horizontal'){
gradient.origin='left'
}else if(itemId==='vertical'){
gradient.origin='top'
}
if(gradient.origin!==original){
this.fireEvent('adjust',{background:{gradient:gradient}})
}
},
onSlideFadePoint:function(slider){
var form=this.cards.layout.activeItem,fadePoint=slider.getValue();
this.setFadePoint(fadePoint);
form.fadePoint.setRawValue(fadePoint)
},
onTextFadePoint:function(triggerField){
var fadePoint=triggerField.getValue(),slider;
this.setFadePoint(fadePoint);
if(triggerField.menu){
slider=triggerField.menu.items.items[0];
slider.suspendEvents();
slider.setValue(Number(fadePoint));
slider.resumeEvents()
}
},
setFadePoint:function(fadePoint){
var gradient=this.initialStyle.gradient;
if(fadePoint<50){
gradient.stops[0][1]='0%';
gradient.stops[1][1]=fadePoint*2+'%'
}else{
gradient.stops[0][1]=(fadePoint-50)*2+'%';
gradient.stops[1][1]='100%'
}
this.fireEvent('adjust',{background:{gradient:gradient}})
},
formatFileName:function(fileName){
fileName=web.DAL.decodeHref(fileName);
return'<div ext:qtip=\''+fileName+'\' style=\'width:225px;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;\'>'+fileName+'<div>'
}
});
Ext.ns('web.panels.props.styleBlock');
web.utils.BorderWidth={
getMaxWidth:function(width,height){
return Math.floor(Math.min(50,width/2,height/2))
}
};
web.panels.props.styleBlock.Border=Ext.extend(Ext.Container,{
initComponent:function(){
this.type='web.panels.props.styleBlock.Border';
this.color={};
this.items=[
{
ref:'colorPanel',
xtype:'web-colorpanel',
showTransparency:true,
listeners:{
change:function(context,color){
this.setBorderColor(color)
},
scope:this
}
},
{
layout:'column',
border:false,
style:{padding:'3px 0 0 5px'},
items:[{
layout:'form',
labelWidth:147,
width:260,
border:false,
cls:'boxBorderStyle',
items:[
{
ref:'../../styleField',
xtype:'combo',
disabled:true,
name:'style',
fieldLabel:'Style',
mode:'local',
editable:false,
triggerAction:'all',
forceSelection:true,
cls:'borderStyle',
style:{
width:'80px',
left:'120px'
},
store:new Ext.data.ArrayStore({
fields:[
'style',
'text'
],
data:[
[
'solid',
'Solid'
],
[
'dashed',
'Dashed'
],
[
'dotted',
'Dotted'
]
]
}),
valueField:'style',
displayField:'text',
getListParent:function(){
return this.el.up('.x-menu')
},
listeners:{
select:this.onChangeStyle,
scope:this
}
},
{
ref:'../../widthField',
xtype:'web-ui-fields-foursidesfield',
name:'spacingStyle',
width:259,
labelWidth:80,
componentType:'Width'+' (px)',
cls:'fourSidesfield boxStyle-border-width',
maxValue:50,
tooltip:'Provide different values for borders on each side',
fourFields:{
field1:{
iconCls:'spacing-top',
iconTooltip:'Top border',
dataKey:'top'
},
field2:{
iconCls:'spacing-right',
iconTooltip:'Right border',
dataKey:'right'
},
field3:{
iconCls:'spacing-bottom',
iconTooltip:'Bottom border',
dataKey:'bottom'
},
field4:{
iconCls:'spacing-left',
iconTooltip:'Left border',
dataKey:'left'
}
},
listeners:{
change:this.onChangeWidth,
scope:this
}
}
]
}]
}
];
web.panels.props.styleBlock.Border.superclass.initComponent.apply(this,arguments);
this.borderFields=[
this.styleField,
this.widthField
]
},
setValues:function(values){
var style=Ext.apply({},values),totalBorderWidth;
if(values){
if(style.width){
this.initialStyle=style;
totalBorderWidth=style.width[0]+style.width[1]+style.width[2]+style.width[3];
if(totalBorderWidth>0){
this.onRemoveBtnClick(true,true);
this.setBorderColor(style.color&&style.color[0]?style.color[0]:'#fff',true);
this.styleField.suspendEvents();
this.styleField.setValue(style.style[0]);
this.styleField.resumeEvents();
this.widthField.setValue({
top:style.width[0],
right:style.width[1],
bottom:style.width[2],
left:style.width[3],
maxValue:style.maxValue
}||null)
}else{
this.clearForm()
}
}else{
this.clearForm()
}
}else{
this.clearForm()
}
},
getDefaultStyle:function(){
var white=new one.color.RGB(1,1,1);
return{
color:[
white,
white,
white,
white
],
style:[
'solid',
'solid',
'solid',
'solid'
],
width:{
0:0,
1:0,
2:0,
3:0,
maxValue:50
}
}
},
setBorderColor:function(color,suppress){
var that=this,border;
if(this.colorPanel.disabled&&!suppress){
return
}
color=Ext.isArray(color)||Ext.isString(color)?one.color(color):color;
border=Ext.apply(this.initialStyle,{
color:[
color,
color,
color,
color
]
});
that.color=color;
this.colorPanel.setColor(color,'both',true);
this.colorPanel.updateTransparencySlider(color);
if(!this.getBorderWidth()){
this.widthField.setValue({
top:1,
right:1,
bottom:1,
left:1,
maxValue:50
});
border=Ext.apply(this.initialStyle,{
width:[
1,
1,
1,
1
]
})
}
this.changeColorDelay=window.setTimeout(function(){
if(!suppress){
that.fireEvent('adjust',{border:border})
}
},300)
},
onRemoveBtnClick:function(removeBtnIsVisible,stopFire){
var border;
this.colorPanel.updateColorPanelVisibility(removeBtnIsVisible);
if(removeBtnIsVisible){
this.borderFields.forEach(function(field){
field.enable()
})
}else{
this.clearForm()
}
if(!stopFire){
border=removeBtnIsVisible?this.initialStyle:{
color:null,
width:null,
style:null
};
this.fireEvent('adjust',{border:border})
}
},
onChangeStyle:function(combo,styleRecord){
var style=styleRecord.data.style,border=Ext.apply(this.initialStyle,{
style:[
style,
style,
style,
style
]
});
this.fireEvent('adjust',{border:border})
},
onChangeWidth:function(field,width){
var border=Ext.apply(this.initialStyle,{
width:[
parseInt(width.top,10),
parseInt(width.right,10),
parseInt(width.bottom,10),
parseInt(width.left,10)
]
});
this.fireEvent('adjust',{border:border})
},
clearForm:function(){
this.initialStyle=this.getDefaultStyle();
this.onRemoveBtnClick(true,true);
this.colorPanel.setDefaults();
this.styleField.suspendEvents();
this.styleField.setValue(this.initialStyle.style[0]);
this.styleField.resumeEvents();
this.widthField.setValue(this.initialStyle.width)
},
setDefaultColor:function(){
this.colorPanel.setDefaults()
},
getBorderStyle:function(borderStyleColor){
var border,borderStyle,borderColor=borderStyleColor||this.colorPanel.getColor()||this.findParentByType('web-props-styleblock').component.style.border.color.top;
if(borderColor){
borderColor=one.color(borderColor).cssa()
}
borderStyle=this.styleField.getValue()||'solid';
border='5px '+borderStyle+' '+borderColor;
return border
},
getBorderWidth:function(borderWidth){
var width=borderWidth||this.initialStyle.width||null;
if(width){
return width[0]+width[1]+width[2]+width[3]||null
}else{
if(this.findParentByType('web-props-styleblock')){
width=this.findParentByType('web-props-styleblock').styleBlock.border.width
}
if(width){
return width.top+width.bottom+width.right+width.left||null
}else{
return null
}
}
}
});
Ext.ComponentMgr.registerType('web-panels-props-styleBlock-border',web.panels.props.styleBlock.Border);
web.ui.fields.AlignmentField=Ext.extend(Ext.form.TriggerField,{
xtype:'web-ui-fields-alignmentfield',
triggerClass:'x-form-arrow-trigger',
selectOnFocus:true,
initComponent:function(){
this.editable=false;
this.listeners={
focus:function(){
this.expand()
},
scope:this
};
this.vlabels={
top:'Top',
middle:'Middle',
bottom:'Bottom'
};
this.vtips={
top:'Select top vertical alignment.',
middle:'Select middle vertical alignment.',
bottom:'Select bottom vertical alignment.'
};
this.hlabels={
left:'Left',
center:'Center',
right:'Right',
fit:'Fit'
};
this.htips={
left:'Select left horizontal alignment.',
center:'Select center horizontal alignment.',
right:'Select right horizontal alignment.',
fit:'Select fit horizontal alignment.'
};
web.ui.fields.AlignmentField.superclass.initComponent.call(this)
},
destroy:function(){
Ext.destroy(this.popup);
web.ui.fields.AlignmentField.superclass.destroy.call(this)
},
getValue:function(){
var value=this.lastValue,alignments,vertical,horizontal;
if(value){
alignments=value;
vertical=alignments[0].trim();
horizontal=alignments[1]?alignments[1].trim():'fit';
return[
vertical,
horizontal
]
}else{
return value
}
},
setValue:function(alignments){
var vertical=alignments[0],horizontal=alignments[1];
this.lastValue=alignments;
web.ui.fields.AlignmentField.superclass.setValue.call(this,this.vlabels[vertical]+', '+this.hlabels[horizontal])
},
isExpanded:function(){
return this.popup&&this.popup.isVisible()
},
onTriggerClick:function(){
if(this.isExpanded()){
this.collapse()
}else{
this.expand()
}
},
createPopup:function(){
this.popup=new Ext.Layer({dh:{html:'<div class="web-ui-fields-alignmentfield">'+'<table>'+'<tr>'+'<td class="topleft"></td>'+'<td class="topcenter"></td>'+'<td class="topright"></td>'+'</tr>'+'<tr>'+'<td class="middleleft"></td>'+'<td class="middlecenter"></td>'+'<td class="middleright"></td>'+'</tr>'+'<tr>'+'<td class="bottomleft"></td>'+'<td class="bottomcenter"></td>'+'<td class="bottomright"></td>'+'</tr>'+'<tr>'+'<td class="fit" colspan="3"></td>'+'</tr>'+'</table>'+'</div>'}});
this.mon(this.popup,'click',function(e){
this.handlePopupClick(e.target.className)
},this)
},
expand:function(){
if(!this.popup){
this.createPopup()
}
this.popup.show();
this.highlightSelectedAlignment();
this.popup.alignTo(this.el,'bl-tl');
this.mon(Ext.getBody(),'mousedown',this.collapseIf,this)
},
collapseIf:function(e){
if(!this.isDestroyed&&!e.within(this.wrap)&&!e.within(this.popup)){
this.collapse()
}
},
collapse:function(e){
if(!this.isExpanded()){
return
}
this.popup.hide();
Ext.getBody().un('mousedown',this.collapseIf,this)
},
highlightSelectedAlignment:function(){
var alignments=this.getValue(),currentSelected=this.popup.select('.selected'),selector;
currentSelected.each(function(el){
el.removeClass('selected')
});
if(alignments[1]==='fit'){
selector='.'+alignments[0]+'left'+', .'+alignments[0]+'center'+', .'+alignments[0]+'right'+', .fit'
}else{
selector='.'+alignments[0]+alignments[1]
}
this.popup.select(selector).each(function(el){
el.addClass('selected')
})
},
handlePopupClick:function(className){
var alignments=className.match(/fit/)||className.match(/(top|middle|bottom)(left|center|right)/),lastValue=this.lastValue,value;
if(alignments){
if(alignments[0]==='fit'){
if(lastValue[1]==='fit'){
value=[
lastValue[0]||'top',
'center'
]
}else{
value=[
lastValue[0]||'top',
'fit'
]
}
}else{
value=[
alignments[1],
alignments[2]
]
}
if(value&&value!==lastValue){
this.setValue(value);
this.highlightSelectedAlignment();
this.fireEvent('change',this,value,lastValue)
}
}
}
});
Ext.reg('web-ui-fields-alignmentfield',web.ui.fields.AlignmentField);
web.ui.fields.BgPositionAlignmentField=Ext.extend(Ext.form.TriggerField,{
xtype:'web-ui-bgPosition-alignmentfield',
triggerClass:'x-form-arrow-trigger',
selectOnFocus:true,
editable:false,
initComponent:function(){
this.editable=false;
this.listeners={
focus:function(){
this.expand()
},
scope:this
};
this.vlabels={
top:'Top',
middle:'Middle',
bottom:'Bottom'
};
this.vtips={
top:'Select top vertical alignment.',
middle:'Select middle vertical alignment.',
bottom:'Select bottom vertical alignment.'
};
this.hlabels={
left:'Left',
center:'Center',
right:'Right',
fit:'Fit'
};
this.htips={
left:'Select left horizontal alignment.',
center:'Select center horizontal alignment.',
right:'Select right horizontal alignment.',
fit:'Select fit horizontal alignment.'
};
web.ui.fields.AlignmentField.superclass.initComponent.call(this)
},
destroy:function(){
Ext.destroy(this.popup);
web.ui.fields.AlignmentField.superclass.destroy.call(this)
},
getValue:function(){
var value=this.lastValue,alignments,vertical,horizontal;
if(value){
alignments=value;
vertical=alignments[0].trim();
horizontal=alignments[1]?alignments[1].trim():'fit';
return[
vertical,
horizontal
]
}else{
return value
}
},
setValue:function(alignments){
var vertical=alignments[0],horizontal=alignments[1];
this.lastValue=alignments;
web.ui.fields.AlignmentField.superclass.setValue.call(this,this.vlabels[vertical]+', '+this.hlabels[horizontal])
},
isExpanded:function(){
return this.popup&&this.popup.isVisible()
},
onTriggerClick:function(){
if(this.isExpanded()){
this.collapse()
}else{
this.expand()
}
},
createPopup:function(){
this.popup=new Ext.Layer({dh:{html:'<div class="web-ui-fields-alignmentfield">'+'<table>'+'<tr>'+'<td class="topleft"></td>'+'<td class="topcenter"></td>'+'<td class="topright"></td>'+'</tr>'+'<tr>'+'<td class="middleleft"></td>'+'<td class="middlecenter"></td>'+'<td class="middleright"></td>'+'</tr>'+'<tr>'+'<td class="bottomleft"></td>'+'<td class="bottomcenter"></td>'+'<td class="bottomright"></td>'+'</tr>'+'</table>'+'</div>'}});
this.mon(this.popup,'click',function(e){
this.handlePopupClick(e.target.className)
},this)
},
expand:function(){
if(!this.popup){
this.createPopup()
}
this.popup.show();
this.highlightSelectedAlignment();
this.popup.alignTo(this.el,'bl-tl');
this.mon(Ext.getBody(),'mousedown',this.collapseIf,this)
},
collapseIf:function(e){
if(!this.isDestroyed&&!e.within(this.wrap)&&!e.within(this.popup)){
this.collapse()
}
},
collapse:function(e){
if(!this.isExpanded()){
return
}
this.popup.hide();
Ext.getBody().un('mousedown',this.collapseIf,this)
},
highlightSelectedAlignment:function(){
var alignments=this.getValue(),currentSelected=this.popup.select('.selected'),selector;
currentSelected.each(function(el){
el.removeClass('selected')
});
if(alignments[1]==='fit'){
selector='.'+alignments[0]+'left'+', .'+alignments[0]+'center'+', .'+alignments[0]+'right'+', .fit'
}else{
selector='.'+alignments[0]+alignments[1]
}
this.popup.select(selector).each(function(el){
el.addClass('selected')
})
},
handlePopupClick:function(className){
var alignments=className.match(/(top|middle|bottom)(left|center|right)/),lastValue=this.lastValue,value;
if(alignments){
value=[
alignments[1],
alignments[2]
];
if(value&&value!==lastValue){
this.setValue(value);
this.highlightSelectedAlignment();
this.fireEvent('change',this,value,lastValue)
}
}
}
});
Ext.reg('web-ui-bgPosition-alignmentfield',web.ui.fields.BgPositionAlignmentField);
web.panels.props.styleBlock.Background=Ext.extend(Ext.Container,{
positionKeyMaps:{
p2t:{
h:{
'0%':'left',
'50%':'center',
'100%':'right'
},
v:{
'0%':'top',
'50%':'middle',
'100%':'bottom'
}
},
t2p:{
h:{
'left':'0%',
'center':'50%',
'right':'100%'
},
v:{
'top':'0%',
'middle':'50%',
'bottom':'100%'
}
}
},
initComponent:function(){
var app=this.app||null,that=this;
this.type='web.panels.props.styleBlock.Background';
this.color=null;
this.bgImgPosStore=new Ext.data.ArrayStore({
fields:[
'position',
'text'
],
data:[
[
'0% 0%',
[
'Top',
'Left'
]
],
[
'0% 50%',
[
'Middle',
'Left'
]
],
[
'0% 100%',
[
'Bottom',
'Left'
]
],
[
'50% 0%',
[
'Top',
'Center'
]
],
[
'50% 50%',
[
'Middle',
'Center'
]
],
[
'50% 100%',
[
'Bottom',
'Center'
]
],
[
'100% 0%',
[
'Top',
'Right'
]
],
[
'100% 50%',
[
'Middle',
'Right'
]
],
[
'100% 100%',
[
'Bottom',
'Right'
]
]
]
});
this.items=[{
ref:'backgroundPanel',
xtype:'tabpanel',
layoutOnTabChange:true,
activeTab:0,
cls:'backgroundPanel',
initialUiSetupFlag:true,
listeners:{
'tabchange':function(context,selectedTab,stopFire){
this.onTabChange(context,selectedTab,stopFire)
},
scope:this
},
items:[
{
title:'Single Color',
ref:'../singleColorTab',
component:'singleColor',
cls:'flexibleHeightTabBody',
style:{height:'auto'},
items:[
{
ref:'../../colorPanel',
xtype:'web-colorpanel',
showTransparency:true,
height:195,
width:269,
style:{padding:'5px 4px 5px 6px'},
listeners:{
change:function(context,color){
var alphaVal=color.alpha()*100;
if(alphaVal!==this.gradientColorPanel.transparencySlider.sliderNumberField.getValue()){
this.gradientColorPanel.transparencySlider.sliderNumberField.setValue(alphaVal)
}
this.onChangeBgColor(color)
},
scope:this
}
},
{
xtype:'spacer',
style:'{background:#FFFFFF;border-top:1px solid #C1C1C1;margin: 5px 10px;}',
height:'1px'
},
{
xtype:'container',
layout:'hflex',
layoutConfig:{align:'middle'},
style:{
width:'255px',
paddingLeft:'10px'
},
items:[
{
ref:'../../../backgroundSImageStyleCheckboxLabel',
name:'backgroundSImageStyleCheckboxLabel',
xtype:'label',
text:'Image:',
flex:1
},
{
name:'imageId',
ref:'../../../imageField',
cls:'background-img-field-name',
xtype:'label',
fieldLabel:'Image',
text:'None'
},
{
ref:'../../../bgImgSelect',
xtype:'checkbox',
ctCls:'bgImg-checkbox',
cls:'props-panel-remove-button',
tabTip:'Remove background image',
hideLabel:true,
hidden:true,
handler:function(checkbox){
checkbox.hide();
this.onChangeImage(null)
},
scope:this
},
{
xtype:'button',
ref:'../../../bgImgSetting',
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
tooltip:'Edit background image',
handler:function(){
if(that.imageField.text==='None'&&!this.getEl().hasClass('bgImgPropsPanel')){
app.windows.show({
type:'web.windows.Image',
app:this.app,
okFn:function(win,selection){
var asset=new web.data.assets.Image(selection.images[0]);
that.onChangeImage(asset)
},
values:{paths:[]},
scope:that
})
}else{
that.bgImgSetting.getEl().toggleClass('bgImgPropsPanel');
that.backgroundImgProperties.getEl().toggleClass('backgroundImgProperties-toggle-expanded');
that.getEl().parent().toggleClass('backgroundTabToggle__bgImgExpand')
}
}
}
]
},
{
ref:'../../backgroundImgProperties',
itemId:'backgroundImgProperties',
name:'backgroundImgProperties',
layout:'column',
width:255,
style:{marginLeft:'10px'},
border:false,
cls:'bgImgproperties',
items:[{
layout:'form',
labelWidth:110,
width:250,
style:{padding:'5px'},
border:false,
items:[
{
layout:'hauto',
layoutConfig:{align:'middle'},
style:{paddingBottom:'5px'},
items:[
{
xtype:'label',
text:'File:',
width:203
},
{
xtype:'button',
ref:'../../../../../backgroundImgChooseBtn',
tooltip:'Select an Image on your workspace.',
iconCls:'icon icon-add-image',
width:30,
handler:function(){
app.windows.show({
type:'web.windows.Image',
app:this.app,
okFn:function(win,selection){
var asset=new web.data.assets.Image(selection.images[0]);
that.onChangeImage(asset)
},
values:{paths:[that.initialStyle.asset.url]},
scope:this
})
}
}
]
},
{
layout:'hflex',
layoutConfig:{align:'middle'},
style:{paddingBottom:'5px'},
items:[
{
xtype:'label',
text:'Repeat:',
width:122
},
new web.ui.ComboBox({
ref:'../../../../../backgroundimgRepeatField',
width:103,
disabled:true,
name:'repeat',
mode:'local',
triggerAction:'all',
forceSelection:true,
editable:false,
cls:'x-form-field__backgroundImgProperty',
store:new Ext.data.ArrayStore({
fields:[
'repeat',
'text'
],
data:[
[
JSON.stringify([
false,
false
]),
'None'
],
[
JSON.stringify([
true,
false
]),
'Horizontally'
],
[
JSON.stringify([
false,
true
]),
'Vertically'
],
[
JSON.stringify([
true,
true
]),
'Both'
]
]
}),
valueField:'repeat',
displayField:'text',
listeners:{
select:this.onChangeImageRepeat,
scope:this
}
})
]
},
{
layout:'hflex',
layoutConfig:{align:'middle'},
style:{paddingBottom:'5px'},
items:[
{
xtype:'label',
text:'Position:',
width:122
},
{
ref:'../../../../../backgroundImgPositionField',
xtype:'web-ui-bgPosition-alignmentfield',
width:103,
name:'level',
listeners:{
change:function(field,value){
this.onChangeImagePosition(value)
},
scope:this
}
}
]
},
function(scope,enabled){
if(!enabled){
return{}
}
return{
ref:'../../../../backgroundImageAttachment',
layout:'hflex',
layoutConfig:{align:'middle'},
style:{
paddingBottom:'5px',
paddingRight:'7px'
},
items:[
{
xtype:'label',
text:'Don\'t scroll with page:',
style:'white-space:nowrap',
width:122
},
{
ref:'../../../../../backgroundImageAttachmentField',
xtype:'checkbox',
width:103,
listeners:{
check:function(field,value){
this.updateImageAttachment(value)
},
scope:scope
}
}
]
}
}(this,this.enableImageAttachment),
{
layout:'hflex',
layoutConfig:{align:'middle'},
style:{paddingBottom:'5px'},
items:[
{
xtype:'label',
text:'Size:',
width:122
},
{
ref:'../../../../../backgroundImgSizeField',
xtype:'combo',
width:103,
disabled:true,
name:'size',
mode:'local',
editable:false,
triggerAction:'all',
forceSelection:true,
cls:'x-form-field__backgroundImgProperty',
store:new Ext.data.ArrayStore({
fields:[
'size',
'text'
],
data:[
[
'fit',
'Fit'
],
[
'fill',
'Fill'
],
[
'zoom',
'Zoom'
]
]
}),
valueField:'size',
displayField:'text',
listeners:{
select:this.onChangeImageSize,
scope:this
}
}
]
},
{
layout:'hflex',
layoutConfig:{align:'middle'},
style:{paddingBottom:'5px'},
items:[
{
xtype:'label',
text:'Zoom:',
style:'line-height:22px',
width:119
},
{
xtype:'sliderfield',
ref:'../../../../../backgroundImgSizeFieldZoomSlider',
width:100,
increment:1,
minValue:1,
maxValue:100,
value:100,
hidden:true,
listeners:{
valid:function(slider){
if(this.backgroundImgSizeField.getValue().toLowerCase()==='zoom'){
this.fireEvent('adjust',{background:{size:slider.getValue()}})
}
},
scope:this
}
}
]
}
]
}]
}
]
},
{
title:'Gradient',
component:'colorFade',
ref:'../colorFadeTab',
height:275,
style:{padding:'2px 3px 3px 3px'},
items:[
{
itemId:'gradient',
ref:'../../gradientForm',
xtype:'container',
layout:'vflex',
items:[{
hideLabel:true,
border:false,
layout:'column',
defaults:{
listeners:{
change:this.onChangeGradientColor,
scope:this
}
},
cls:'gradient-color',
items:[{
ref:'../../../../gradientColorPanel',
xtype:'web-colorpanel',
colorPickerMode:'double',
showTransparency:true,
height:190,
listeners:{
change:function(gradientColorPicker,color,firstOrLastColor){
var alphaVal=this.gradientColorPanel.transparencySlider.sliderNumberField.getValue();
if(alphaVal!==this.colorPanel.transparencySlider.sliderNumberField.getValue()){
this.colorPanel.transparencySlider.sliderNumberField.setValue(alphaVal)
}
color=color.alpha(alphaVal/100);
if(gradientColorPicker.colorPickerMode==='double'){
this.onChangeGradientColor(color,firstOrLastColor)
}else{
this.onChangeBgColor(color)
}
},
scope:this
}
}]
}]
},
{
xtype:'container',
layout:'hauto',
style:{padding:'5px 0 5px 5px'},
items:[
{
xtype:'label',
text:'Direction:',
width:155,
style:{padding:'0 45px 0 0 '}
},
{
ref:'../../../backgroundGradientDirection',
xtype:'combo',
mode:'local',
triggerAction:'all',
forceSelection:true,
ctCls:'bg-gradient-direction-container',
editable:false,
store:new Ext.data.ArrayStore({
fields:[
'bgGradientDirection',
'text'
],
data:[
[
'top',
'Vertical'
],
[
'left',
'Horizontal'
]
]
}),
valueField:'bgGradientDirection',
displayField:'text',
getListParent:function(){
return this.el.up('.x-menu')
},
listeners:{
select:this.onChangeGradientDirection,
afterrender:function(combo){
combo.setWidth(100)
},
scope:this
}
}
]
},
{
xtype:'container',
layout:'hauto',
cls:'bgGradientFadePointSliderContainer',
width:235,
style:{padding:'0 0 0 5px'},
items:[{
xtype:'web-CustomSlider',
ref:'../../../fadePointSlider',
width:255,
cls:'bg-gradient-fadepoint-container',
sliderLabel:'Fade point'+' (%): ',
sliderMinValue:0,
sliderMaxValue:100,
sliderIncrement:1,
listeners:{
change:function(slider,sliderValue){
this.setFadePoint(sliderValue)
},
scope:this
}
}]
}
]
}
]
}];
web.panels.props.styleBlock.Background.superclass.initComponent.apply(this,arguments);
this.backgroundFields=[
this.backgroundimgRepeatField,
this.backgroundImgPositionField,
this.backgroundImgSizeField
];
if(this.enableImageAttachment){
this.backgroundFields.push(this.backgroundImageAttachmentField)
}
},
setValues:function(values,options){
var selected,style;
style=Ext.apply({},values);
this.initialStyle=style;
this.onRemoveBtnClick(true,true);
if(options&&options.calledFrom==='setComponent'){
this.oldGradient=null
}
if(style.gradient){
selected='gradient';
this.backgroundPanel.fireEvent('tabChange',this.backgroundPanel,this.colorFadeTab,true);
this.backgroundPanel.activate(this.colorFadeTab)
}else if(style.asset||style.color){
selected='image';
this.backgroundPanel.fireEvent('tabChange',this.backgroundPanel,this.singleColorTab,true);
this.backgroundPanel.activate(this.singleColorTab)
}else{
selected='none';
this.backgroundPanel.fireEvent('tabChange',this.backgroundPanel,this.singleColorTab,true);
this.backgroundPanel.activate(this.singleColorTab)
}
if(!style.asset&&this.backgroundImgProperties.getEl()){
if(this.backgroundImgProperties.getEl().hasClass('backgroundImgProperties-toggle-expanded')){
this.bgImgSetting.getEl().removeClass('bgImgPropsPanel');
this.backgroundImgProperties.getEl().removeClass('backgroundImgProperties-toggle-expanded');
this.getEl().parent().removeClass('backgroundTabToggle__bgImgExpand')
}
}
if(this.enableImageAttachment){
this.backgroundImageAttachmentField.suspendEvents();
this.backgroundImageAttachmentField.setValue(style.fixed);
this.backgroundImageAttachmentField.resumeEvents()
}
},
uiSetters:{
none:function(){
},
image:function(style){
var asset,filename;
if(style.asset){
asset=new web.data.assets.Image(style.asset);
filename=asset.getURL().replace(/.*\//,'');
this.imageField.setText(filename);
Ext.QuickTips.register({
target:this.imageField.getEl(),
text:filename
});
this.bgImgSelect.show();
this.backgroundimgRepeatField.enable();
this.backgroundImgPositionField.enable();
this.backgroundImgSizeField.enable();
this.backgroundimgRepeatField.suspendEvents();
this.backgroundimgRepeatField.setValue(JSON.stringify(style.repeat||[
true,
true
]));
this.backgroundimgRepeatField.resumeEvents();
var maps=this.positionKeyMaps.p2t;
this.backgroundImgPositionField.suspendEvents();
style.position=style.position||[
'50%',
'50%'
];
this.backgroundImgPositionField.setValue([
maps.v[style.position[1]],
maps.h[style.position[0]]
]);
this.backgroundImgPositionField.resumeEvents();
if(this.enableImageAttachment){
this.backgroundImageAttachmentField.suspendEvents();
this.backgroundImageAttachmentField.setValue(style.fixed);
this.backgroundImageAttachmentField.resumeEvents()
}
var bgImgSize=(Ext.isNumber(style.size)?'zoom':style.size)||'zoom';
this.backgroundImgSizeField.suspendEvents();
this.backgroundImgSizeField.setValue(bgImgSize);
this.backgroundImgSizeField.resumeEvents();
if(bgImgSize==='zoom'){
if(Ext.isNumber(style.size)){
this.backgroundImgSizeFieldZoomSlider.suspendEvents();
this.backgroundImgSizeFieldZoomSlider.setValue(style.size);
this.backgroundImgSizeFieldZoomSlider.resumeEvents()
}
this.backgroundImgSizeFieldZoomSlider.show();
this.backgroundImgSizeFieldZoomSlider.setMaxValue(100)
}
}else{
this.imageField.setText('None');
this.bgImgSelect.hide();
this.backgroundimgRepeatField.disable();
this.backgroundImgPositionField.disable();
this.backgroundImgSizeField.disable()
}
if(style.color){
this.setBgColor(one.color(style.color))
}
},
gradient:function(style){
var gradientForm=this.gradientColorPanel,gradient=style.gradient,startColor=one.color(gradient.stops[0][0]),endColor=one.color(gradient.stops[1][0]),focusFieldColor,fadePoint,alphaVal=startColor.alpha()*100;
endColor=endColor.alpha(startColor.alpha());
focusFieldColor=gradientForm.hexTo!==gradientForm.focusedColorField?startColor:endColor;
style.gradient.stops[1][0]=endColor.toJSON();
this.gradientColorPanel.hex.setRawValue(startColor.hex());
this.updateColorField(this.gradientColorPanel.hex,startColor);
this.gradientColorPanel.suspendEvents();
this.gradientColorPanel.setColor(focusFieldColor,'both',false);
this.updateTransparencySliders(focusFieldColor);
this.gradientColorPanel.resumeEvents();
this.gradientColorPanel.hexTo.setRawValue(endColor.hex());
this.focusedColorField=focusFieldColor;
this.updateColorField(this.gradientColorPanel.hexTo,endColor);
this.gradientColorPanel.colorPicker.setValue(focusFieldColor);
this.backgroundGradientDirection.setValue(style.gradient.origin);
gradientForm.transparencySlider.sliderNumberField.setValue(alphaVal);
if(parseInt(gradient.stops[0][1],10)>0){
fadePoint=50+parseInt(gradient.stops[0][1],10)/2
}else{
fadePoint=parseInt(gradient.stops[1][1],10)/2
}
this.fadePointSlider.suspendEvents();
this.fadePointSlider.setValue(fadePoint,false);
this.fadePointSlider.resumeEvents()
}
},
toggleTemplateFields:function(component){
if(component instanceof web.data.components.Template){
this.backgroundImageAttachmentField.enable();
this.backgroundImageAttachment.show()
}else{
this.backgroundImageAttachmentField.disable();
this.backgroundImageAttachment.hide()
}
},
defaultSettings:function(option){
var settings={
gradient:null,
imageId:null,
color:null,
repeat:[
true,
true
],
position:[
'0%',
'0%'
],
size:100
};
return{
gradient:function(){
var gradient=Ext.apply({},settings);
return Ext.apply(gradient,{
gradient:{
gradType:'linear',
size:'farthest-corner',
origin:'top',
stops:[
[
one.color('#FFF').toJSON(),
'0%'
],
[
one.color('#FFF').toJSON(),
'100%'
]
]
}
})
},
image:function(){
return Ext.apply({},settings)
},
none:function(){
return Ext.apply({},settings)
}
}
}(),
setBackgroundColor:function(color,suppress){
var that=this,background;
if(this.colorPanel.disabled&&!suppress){
return
}
color=Ext.isArray(color)||Ext.isString(color)?one.color(color):color;
background=Ext.apply(this.initialStyle,{
color:[
color,
color,
color,
color
]
});
that.color=color;
this.colorPanel.setColor(color,'both',true);
this.updateTransparencySliders(color);
this.changeColorDelay=window.setTimeout(function(){
if(!suppress){
that.fireEvent('adjust',{background:background})
}
},300)
},
setBgColor:function(color){
var style=this.initialStyle;
style.color=color;
if(this.colorPanel.disabled){
return
}
this.colorPanel.setColor(color,'both',true);
this.updateTransparencySliders(color);
Ext.apply(this.initialStyle,{color:style.color});
return color
},
onChangeBgColor:function(color){
var style=this.initialStyle;
style.color=color;
Ext.apply(this.initialStyle,{color:style.color});
this.fireEvent('updateHeader',{
background:{
color:color,
gradient:null
}
});
this.fireEvent('adjust',{
background:{
color:color,
gradient:null
}
})
},
onRemoveBtnClick:function(removeBtnIsVisible,stopFire){
var background;
this.colorPanel.updateColorPanelVisibility(removeBtnIsVisible);
background=this.initialStyle;
if(removeBtnIsVisible){
this.backgroundFields.forEach(function(field){
field.enable()
});
background=this.initialStyle
}else{
if(background.gradient){
background.gradient=null;
background.color=null;
this.fireEvent('adjust',{background:background});
return false
}else if(this.imageField.text!=='None'){
this.onChangeImage(null,true);
return false
}
background=Ext.applyIf({color:null},this.initialStyle)
}
if(!stopFire){
this.fireEvent('adjust',{background:background})
}
},
onChangeImage:function(image,clearColor){
var style=this.initialStyle,background=this.defaultSettings.image(),bgImgName='';
if(image){
image=new web.data.assets.Image(image);
background.asset=image;
bgImgName=image.getURL().replace(/.*\//,'');
this.imageField.setText(web.utils.String.ellipsis(bgImgName));
this.bgImgSelect.show();
this.backgroundimgRepeatField.enable();
this.backgroundimgRepeatField.suspendEvents();
this.backgroundimgRepeatField.setValue(JSON.stringify([
true,
true
]));
this.backgroundimgRepeatField.resumeEvents();
this.backgroundImgPositionField.enable();
this.backgroundImgPositionField.suspendEvents();
this.backgroundImgPositionField.setValue([
'top',
'left'
]);
this.backgroundImgPositionField.resumeEvents();
this.backgroundImgSizeField.enable();
this.backgroundImgSizeField.suspendEvents();
this.backgroundImgSizeField.setValue('zoom');
this.backgroundImgSizeField.resumeEvents();
this.backgroundImgSizeFieldZoomSlider.suspendEvents();
this.backgroundImgSizeFieldZoomSlider.show();
this.backgroundImgSizeFieldZoomSlider.setValue(100);
this.backgroundImgSizeFieldZoomSlider.setMaxValue(100);
this.backgroundImgSizeFieldZoomSlider.resumeEvents();
this.bgImgSetting.getEl().addClass('bgImgPropsPanel');
this.backgroundImgProperties.getEl().addClass('backgroundImgProperties-toggle-expanded');
this.getEl().parent().addClass('backgroundTabToggle__bgImgExpand')
}else{
background.asset=null;
this.imageField.setText('None');
this.bgImgSelect.hide();
this.backgroundimgRepeatField.disable();
this.backgroundImgPositionField.disable();
this.backgroundImgSizeFieldZoomSlider.hide();
this.backgroundImgSizeField.disable();
this.bgImgSetting.getEl().removeClass('bgImgPropsPanel');
this.backgroundImgProperties.getEl().removeClass('backgroundImgProperties-toggle-expanded');
this.getEl().parent().removeClass('backgroundTabToggle__bgImgExpand')
}
if(clearColor){
background.color=null
}else{
background.color=style.color||background.color
}
Ext.apply(this.initialStyle,background);
this.fireEvent('adjust',{background:background})
},
onChangeImageRepeat:function(repeatGroup,select){
var repeat=JSON.parse(select.data.repeat)||[
false,
false
];
this.fireEvent('adjust',{background:{repeat:repeat}})
},
onChangeImagePosition:function(value){
var maps=this.positionKeyMaps.t2p;
this.fireEvent('adjust',{
background:{
position:[
maps.h[value[1]],
maps.v[value[0]]
]
}
})
},
onChangeImageSize:function(sizeGroup,select){
var size,selectText=select.data.size;
if(selectText==='fit'||selectText==='fill'){
size=select.data.size;
this.backgroundImgSizeFieldZoomSlider.hide()
}
if(selectText==='zoom'){
size=this.backgroundImgSizeFieldZoomSlider.getValue();
this.backgroundImgSizeFieldZoomSlider.show();
this.backgroundImgSizeFieldZoomSlider.setMaxValue(100);
if(!size){
size=null
}
}
this.fireEvent('adjust',{background:{size:size}})
},
onChangeImageSizeZoomSlider:function(button,value){
var size;
if(button==='zoomSlider'){
size=value
}
this.fireEvent('adjust',{background:{size:size}})
},
updateImageAttachment:function(fixed){
this.fireEvent('adjust',{background:{fixed:fixed}})
},
formatFileName:function(fileName){
fileName=web.DAL.decodeHref(fileName);
return'<div ext:qtip=\''+fileName+'\' style=\'width:225px;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;\'>'+fileName+'<div>'
},
onGradientColorFocus:function(field){
this.focusedColorField=field;
this.onChangeGradientColor(one.color(field.getValue()))
},
onChangeGradientColor:function(color,firstOrLastColor){
var style=this.initialStyle,gradient=style.gradient,map={
first:0,
last:1
},tmpColor;
if(color){
if(gradient){
gradient.stops[map[firstOrLastColor]][0]=color
}else if(firstOrLastColor){
gradient=this.defaultSettings.gradient().gradient;
gradient.stops[map[firstOrLastColor]][0]=color;
Ext.apply(this.initialStyle,{gradient:gradient})
}else{
gradient=this.defaultSettings.gradient().gradient;
gradient.stops[0][0]=color;
Ext.apply(this.initialStyle,{gradient:gradient})
}
if(firstOrLastColor==='first'){
tmpColor=one.color(gradient.stops[1][0]);
firstOrLastColor='last'
}else{
tmpColor=one.color(gradient.stops[0][0]);
firstOrLastColor='first'
}
tmpColor=tmpColor.alpha(color.alpha());
gradient.stops[map[firstOrLastColor]][0]=tmpColor;
this.fireEvent('adjust',{background:{gradient:gradient}});
var gradientForm=this.gradientColorPanel;
if(gradientForm.hexTo!==gradientForm.focusedColorField){
gradientForm.hex.focus()
}else{
gradientForm.hexTo.focus()
}
}
},
getDefaultGradient:function(){
var style=this.initialStyle,gradColor;
gradColor=style.color||'#FFF';
style.gradient=Ext.apply(this.defaultSettings.gradient().gradient,{
stops:[
[
one.color(gradColor).toJSON(),
'0%'
],
[
one.color(gradColor).toJSON(),
'100%'
]
]
});
return style.gradient
},
onChangeGradientDirection:function(gradientGroup,select){
var gradient=this.initialStyle.gradient,original=gradient.origin;
gradient.origin=select.data.bgGradientDirection||'top';
if(gradient.origin!==original){
this.fireEvent('adjust',{background:{gradient:gradient}})
}
},
onTabChange:function(context,selectedTab,stopFire){
var component=selectedTab.component,style=this.initialStyle,selected,gradColor;
if(!style){
return
}
if(context.initialUiSetupFlag){
window.setTimeout(function(){
context.initialUiSetupFlag=false
},300)
}
if(component==='colorFade'){
selected='gradient';
if(this.getEl()){
this.getEl().parent().removeClass('backgroundTabToggle__bgImgExpand');
this.getEl().parent().addClass('color-fade-tab')
}
if(this.backgroundImgProperties.getEl()){
this.bgImgSetting.getEl().removeClass('bgImgPropsPanel');
this.backgroundImgProperties.getEl().removeClass('backgroundImgProperties-toggle-expanded')
}
if(!style.gradient){
var oldGradient=this.oldGradient;
if(oldGradient&&oldGradient.stops){
style.gradient=oldGradient
}
}
if(!style.gradient){
gradColor=style.color||'#FFF';
style.gradient=Ext.apply(this.defaultSettings.gradient().gradient,{
stops:[
[
one.color(gradColor).toJSON(),
'0%'
],
[
one.color(gradColor).toJSON(),
'100%'
]
]
})
}
}else if(component==='singleColor'){
selected='image';
if(this.getEl()){
this.getEl().parent().removeClass('color-fade-tab')
}
if(!style.color&&style.gradient){
style.color=style.gradient?style.gradient.stops[0][0]:null
}
if(style.gradient){
this.oldGradient=style.gradient
}
}
this.uiSetters[selected].call(this,style);
if(!stopFire&&!context.initialUiSetupFlag){
switch(selected){
case'gradient':
if(style.gradient){
this.fireEvent('adjust',{
background:{
gradient:style.gradient,
color:null,
asset:null
}
})
}
break;
case'image':
if(style.color||style.asset){
this.fireEvent('adjust',{
background:{
color:style.color,
asset:style.asset,
gradient:null
}
})
}else if(style.color===null){
this.fireEvent('adjust',{
background:{
asset:null,
color:null,
gradient:null
}
})
}
break;
default:
if(style.asset||style.color||style.gradient){
this.fireEvent('adjust',{
background:{
asset:null,
color:null,
gradient:null
}
})
}
}
}
},
onSlideFadePoint:function(slider){
var fadePoint=slider.getValue();
this.setFadePoint(fadePoint);
this.fadePointSlider.setValue(fadePoint)
},
onTextFadePoint:function(triggerField){
var fadePoint=triggerField.getValue(),slider;
this.setFadePoint(fadePoint);
if(triggerField.menu){
slider=triggerField.menu.items.items[0];
slider.suspendEvents();
slider.setValue(Number(fadePoint));
slider.resumeEvents()
}
},
setFadePoint:function(fadePoint){
var gradient=this.initialStyle.gradient||this.getDefaultGradient();
if(fadePoint<50){
gradient.stops[0][1]='0%';
gradient.stops[1][1]=fadePoint*2+'%'
}else{
gradient.stops[0][1]=(fadePoint-50)*2+'%';
gradient.stops[1][1]='100%'
}
this.fireEvent('adjust',{background:{gradient:gradient}})
},
updateColorField:function(colorField,color){
var el=colorField.el;
if(color&&el){
el.dom.style.background=color.css();
el.dom.style.color=color.value()>0.5?'#000':'#FFF'
}
},
updateTransparencySliders:function(color){
this.gradientColorPanel.updateTransparencySlider(color);
this.colorPanel.updateTransparencySlider(color)
},
isBgImgPropExpanded:function(){
var bgImgpropDOM=this.backgroundImgProperties.getEl();
if(bgImgpropDOM){
return bgImgpropDOM.hasClass('backgroundImgProperties-toggle-expanded')
}else{
return false
}
},
getBackgroundStyle:function(backgroundStyle,headerDOM){
var isBgPresent=null,defaultUrl=this.app.dal.defaultUrl,backgroundImgUrl='',headerEl=headerDOM.el;
backgroundStyle=backgroundStyle||this.initialStyle||null;
if(backgroundStyle){
if(backgroundStyle.gradient){
this.getCSSgradient(backgroundStyle.gradient,headerDOM);
isBgPresent=true
}else if(backgroundStyle.asset){
if(!(backgroundStyle.asset instanceof web.data.assets.Image)){
backgroundStyle.asset=new web.data.assets.Image(backgroundStyle.asset)
}
backgroundImgUrl=backgroundStyle.asset.getRelativeUrl(defaultUrl);
window.setTimeout(function(){
headerDOM.el.dom.childNodes[0].innerHTML='<img height="23px" width="50px" src='+backgroundImgUrl+' />'
},500);
if(backgroundStyle.color&&headerEl){
headerEl.dom.childNodes[0].style.background=one.color(backgroundStyle.color).cssa()||'none'
}
isBgPresent=true
}else if(backgroundStyle.color&&headerEl){
headerEl.dom.childNodes[0].innerHTML='';
headerEl.dom.childNodes[0].style.background=one.color(backgroundStyle.color).cssa()||'none';
isBgPresent=true
}
}
return isBgPresent
},
getCSSgradient:function(gradientStyle,headerDOM){
var filterOrigin='0';
if(Ext.isChrome||Ext.isSafari){
window.setTimeout(function(){
headerDOM.el.dom.childNodes[0].innerHTML='';
headerDOM.el.dom.childNodes[0].style.backgroundImage='-webkit-linear-gradient('+gradientStyle.origin+', '+one.color(gradientStyle.stops[0][0]).cssa()+' '+gradientStyle.stops[0][1]+','+one.color(gradientStyle.stops[1][0]).cssa()+' '+gradientStyle.stops[1][1]+')'
},500)
}else if(Ext.isGecko){
window.setTimeout(function(){
headerDOM.el.dom.childNodes[0].innerHTML='';
headerDOM.el.dom.childNodes[0].style.backgroundImage='-moz-linear-gradient('+gradientStyle.origin+', '+one.color(gradientStyle.stops[0][0]).cssa()+' '+gradientStyle.stops[0][1]+','+one.color(gradientStyle.stops[1][0]).cssa()+' '+gradientStyle.stops[1][1]+')'
},500)
}else if(Ext.isIE9){
window.setTimeout(function(){
if(gradientStyle.origin==='left'){
filterOrigin=1
}
headerDOM.el.dom.childNodes[0].innerHTML='';
headerDOM.el.dom.childNodes[0].style.filter='progid:DXImageTransform.Microsoft.gradient( startColorstr='+one.color(gradientStyle.stops[0][0]).hex()+', endColorstr='+one.color(gradientStyle.stops[1][0]).hex()+',GradientType='+filterOrigin+' )'
},500)
}else if(Ext.isIE||Ext.isIE11){
window.setTimeout(function(){
headerDOM.el.dom.childNodes[0].innerHTML='';
headerDOM.el.dom.childNodes[0].style.background='-ms-linear-gradient('+gradientStyle.origin+', '+one.color(gradientStyle.stops[0][0]).cssa()+' '+gradientStyle.stops[0][1]+','+one.color(gradientStyle.stops[1][0]).cssa()+' '+gradientStyle.stops[1][1]+')'
},500)
}else{
window.setTimeout(function(){
headerDOM.el.dom.childNodes[0].innerHTML='';
headerDOM.el.dom.childNodes[0].style.backgroundImage='none'
},500)
}
},
setDefaultColor:function(){
this.colorPanel.setDefaults();
this.gradientColorPanel.setDefaults()
}
});
Ext.ComponentMgr.registerType('web-panels-props-styleBlock-background',web.panels.props.styleBlock.Background);
Ext.ux.Spinner=Ext.extend(Ext.util.Observable,{
incrementValue:1,
alternateIncrementValue:5,
triggerClass:'x-form-spinner-trigger',
splitterClass:'x-form-spinner-splitter',
alternateKey:Ext.EventObject.shiftKey,
defaultValue:0,
accelerate:false,
constructor:function(config){
Ext.ux.Spinner.superclass.constructor.call(this,config);
Ext.apply(this,config);
this.mimicing=false
},
init:function(field){
this.field=field;
field.afterMethod('onRender',this.doRender,this);
field.afterMethod('onEnable',this.doEnable,this);
field.afterMethod('onDisable',this.doDisable,this);
field.afterMethod('afterRender',this.doAfterRender,this);
field.afterMethod('onResize',this.doResize,this);
field.afterMethod('onFocus',this.doFocus,this);
field.beforeMethod('onDestroy',this.doDestroy,this)
},
doRender:function(ct,position){
var el=this.el=this.field.getEl();
var f=this.field;
if(!f.wrap){
f.wrap=this.wrap=el.wrap({cls:'x-form-field-wrap'})
}else{
this.wrap=f.wrap.addClass('x-form-field-wrap')
}
this.trigger=this.wrap.createChild({
tag:'img',
src:Ext.BLANK_IMAGE_URL,
cls:'x-form-trigger '+this.triggerClass
});
if(!f.width){
this.wrap.setWidth(el.getWidth()+this.trigger.getWidth())
}
this.splitter=this.wrap.createChild({
tag:'div',
cls:this.splitterClass,
style:'width:13px; height:2px;'
});
this.splitter.setRight(Ext.isIE?1:2).setTop(10).show();
this.proxy=this.trigger.createProxy('',this.splitter,true);
this.proxy.addClass('x-form-spinner-proxy');
this.proxy.setStyle('left','0px');
this.proxy.setSize(14,1);
this.proxy.hide();
this.dd=new Ext.dd.DDProxy(this.splitter.dom.id,'SpinnerDrag',{dragElId:this.proxy.id});
this.initTrigger();
this.initSpinner()
},
doAfterRender:function(){
var y;
if(Ext.isIE&&this.el.getY()!=(y=this.trigger.getY())){
this.el.position();
this.el.setY(y)
}
},
doEnable:function(){
if(this.wrap){
this.disabled=false;
this.wrap.removeClass(this.field.disabledClass)
}
},
doDisable:function(){
if(this.wrap){
this.disabled=true;
this.wrap.addClass(this.field.disabledClass);
this.el.removeClass(this.field.disabledClass)
}
},
doResize:function(w,h){
if(typeof w=='number'){
this.el.setWidth(w-this.trigger.getWidth())
}
this.wrap.setWidth(this.el.getWidth()+this.trigger.getWidth())
},
doFocus:function(){
if(!this.mimicing){
this.wrap.addClass('x-trigger-wrap-focus');
this.mimicing=true;
Ext.get(Ext.isIE?document.body:document).on('mousedown',this.mimicBlur,this,{delay:10});
this.el.on('keydown',this.checkTab,this)
}
},
checkTab:function(e){
if(e.getKey()==e.TAB){
this.triggerBlur()
}
},
mimicBlur:function(e){
if(!this.wrap.contains(e.target)&&this.field.validateBlur(e)){
this.triggerBlur()
}
},
triggerBlur:function(){
this.mimicing=false;
Ext.get(Ext.isIE?document.body:document).un('mousedown',this.mimicBlur,this);
this.el.un('keydown',this.checkTab,this);
this.field.beforeBlur();
this.wrap.removeClass('x-trigger-wrap-focus');
this.field.onBlur.call(this.field)
},
initTrigger:function(){
this.trigger.addClassOnOver('x-form-trigger-over');
this.trigger.addClassOnClick('x-form-trigger-click')
},
initSpinner:function(){
this.field.addEvents({
'spin':true,
'spinup':true,
'spindown':true
});
this.keyNav=new Ext.KeyNav(this.el,{
'up':function(e){
e.preventDefault();
this.onSpinUp()
},
'down':function(e){
e.preventDefault();
this.onSpinDown()
},
'pageUp':function(e){
e.preventDefault();
this.onSpinUpAlternate()
},
'pageDown':function(e){
e.preventDefault();
this.onSpinDownAlternate()
},
scope:this
});
this.repeater=new Ext.util.ClickRepeater(this.trigger,{accelerate:this.accelerate});
this.field.mon(this.repeater,'click',this.onTriggerClick,this,{preventDefault:true});
this.field.mon(this.trigger,{
mouseover:this.onMouseOver,
mouseout:this.onMouseOut,
mousemove:this.onMouseMove,
mousedown:this.onMouseDown,
mouseup:this.onMouseUp,
scope:this,
preventDefault:true
});
this.field.mon(this.wrap,'mousewheel',this.handleMouseWheel,this);
this.dd.setXConstraint(0,0,10);
this.dd.setYConstraint(1500,1500,10);
this.dd.endDrag=this.endDrag.createDelegate(this);
this.dd.startDrag=this.startDrag.createDelegate(this);
this.dd.onDrag=this.onDrag.createDelegate(this)
},
onMouseOver:function(){
if(this.disabled){
return
}
var middle=this.getMiddle();
this.tmpHoverClass=Ext.EventObject.getPageY()<middle?'x-form-spinner-overup':'x-form-spinner-overdown';
this.trigger.addClass(this.tmpHoverClass)
},
onMouseOut:function(){
this.trigger.removeClass(this.tmpHoverClass)
},
onMouseMove:function(){
if(this.disabled){
return
}
var middle=this.getMiddle();
if(Ext.EventObject.getPageY()>middle&&this.tmpHoverClass=='x-form-spinner-overup'||Ext.EventObject.getPageY()<middle&&this.tmpHoverClass=='x-form-spinner-overdown'){
}
},
onMouseDown:function(){
if(this.disabled){
return
}
var middle=this.getMiddle();
this.tmpClickClass=Ext.EventObject.getPageY()<middle?'x-form-spinner-clickup':'x-form-spinner-clickdown';
this.trigger.addClass(this.tmpClickClass)
},
onMouseUp:function(){
this.trigger.removeClass(this.tmpClickClass)
},
onTriggerClick:function(){
if(this.disabled||this.el.dom.readOnly){
return
}
var middle=this.getMiddle();
var ud=Ext.EventObject.getPageY()<middle?'Up':'Down';
this['onSpin'+ud]()
},
getMiddle:function(){
var t=this.trigger.getTop();
var h=this.trigger.getHeight();
var middle=t+h/2;
return middle
},
isSpinnable:function(){
if(this.disabled||this.el.dom.readOnly){
Ext.EventObject.preventDefault();
return false
}
return true
},
handleMouseWheel:function(e){
if(this.wrap.hasClass('x-trigger-wrap-focus')==false){
return
}
var delta=e.getWheelDelta();
if(delta>0){
this.onSpinUp();
e.stopEvent()
}else if(delta<0){
this.onSpinDown();
e.stopEvent()
}
},
startDrag:function(){
this.proxy.show();
this._previousY=Ext.fly(this.dd.getDragEl()).getTop()
},
endDrag:function(){
this.proxy.hide()
},
onDrag:function(){
if(this.disabled){
return
}
var y=Ext.fly(this.dd.getDragEl()).getTop();
var ud='';
if(this._previousY>y){
ud='Up'
}
if(this._previousY<y){
ud='Down'
}
if(ud!=''){
this['onSpin'+ud]()
}
this._previousY=y
},
onSpinUp:function(){
if(this.isSpinnable()==false){
return
}
if(Ext.EventObject.shiftKey==true){
this.onSpinUpAlternate();
return
}else{
this.spin(false,false)
}
this.field.fireEvent('spin',this);
this.field.fireEvent('spinup',this)
},
onSpinDown:function(){
if(this.isSpinnable()==false){
return
}
if(Ext.EventObject.shiftKey==true){
this.onSpinDownAlternate();
return
}else{
this.spin(true,false)
}
this.field.fireEvent('spin',this);
this.field.fireEvent('spindown',this)
},
onSpinUpAlternate:function(){
if(this.isSpinnable()==false){
return
}
this.spin(false,true);
this.field.fireEvent('spin',this);
this.field.fireEvent('spinup',this)
},
onSpinDownAlternate:function(){
if(this.isSpinnable()==false){
return
}
this.spin(true,true);
this.field.fireEvent('spin',this);
this.field.fireEvent('spindown',this)
},
spin:function(down,alternate){
var v=parseFloat(this.field.getValue());
var incr=alternate==true?this.alternateIncrementValue:this.incrementValue;
down==true?v-=incr:v+=incr;
v=isNaN(v)?this.defaultValue:v;
v=this.fixBoundries(v);
this.field.setRawValue(v)
},
fixBoundries:function(value){
var v=value;
if(this.field.minValue!=undefined&&v<this.field.minValue){
v=this.field.minValue
}
if(this.field.maxValue!=undefined&&v>this.field.maxValue){
v=this.field.maxValue
}
return this.fixPrecision(v)
},
fixPrecision:function(value){
var nan=isNaN(value);
if(!this.field.allowDecimals||this.field.decimalPrecision==-1||nan||!value){
return nan?'':value
}
return parseFloat(parseFloat(value).toFixed(this.field.decimalPrecision))
},
doDestroy:function(){
if(this.trigger){
this.trigger.remove()
}
if(this.wrap){
this.wrap.remove();
delete this.field.wrap
}
if(this.splitter){
this.splitter.remove()
}
if(this.dd){
this.dd.unreg();
this.dd=null
}
if(this.proxy){
this.proxy.remove()
}
if(this.repeater){
this.repeater.purgeListeners()
}
if(this.mimicing){
Ext.get(Ext.isIE?document.body:document).un('mousedown',this.mimicBlur,this)
}
}
});
Ext.form.Spinner=Ext.ux.Spinner;
Ext.ns('Ext.ux.form');
Ext.ux.form.SpinnerField=Ext.extend(Ext.form.NumberField,{
actionMode:'wrap',
deferHeight:true,
autoSize:Ext.emptyFn,
onBlur:function(){
if(this.focusClass){
this.el.removeClass(this.focusClass)
}
},
adjustSize:Ext.BoxComponent.prototype.adjustSize,
constructor:function(config){
var spinnerConfig=Ext.copyTo({},config,'incrementValue,alternateIncrementValue,accelerate,defaultValue,triggerClass,splitterClass');
var spl=this.spinner=new Ext.ux.Spinner(spinnerConfig);
var plugins=config.plugins?Ext.isArray(config.plugins)?config.plugins.push(spl):[
config.plugins,
spl
]:spl;
Ext.ux.form.SpinnerField.superclass.constructor.call(this,Ext.apply(config,{plugins:plugins}))
},
getResizeEl:function(){
return this.wrap
},
getPositionEl:function(){
return this.wrap
},
alignErrorIcon:function(){
if(this.wrap){
this.errorIcon.alignTo(this.wrap,'tl-tr',[
2,
0
])
}
},
validateBlur:function(){
return true
}
});
Ext.reg('spinnerfield',Ext.ux.form.SpinnerField);
Ext.form.SpinnerField=Ext.ux.form.SpinnerField;
web.ui.fields.CornerField=Ext.extend(Ext.Container,{
xtype:'web-ui-fields-cornerfield',
constructor:function(cfg){
this.maxValue=null;
this.value={
top:0,
right:0,
bottom:0,
left:0
};
web.ui.fields.CornerField.superclass.constructor.call(this,cfg)
},
initComponent:function(){
this.border=false;
this.layout='table';
this.layoutConfig={columns:5};
this.defaults={
xtype:'component',
minValue:0,
maxValue:this.maxValue||999,
style:{margin:'5px'}
};
this.items=[
{html:''},
{
html:'Top',
style:{
display:'block',
textAlign:'center',
margin:'5px'
}
},
{html:''},
{
html:'Top',
style:{
display:'block',
textAlign:'center',
margin:'5px'
}
},
{html:''},
{html:'Left'},
{
xtype:'container',
items:[{
ref:'../topLeftField',
xtype:'spinnerfield',
name:'tl',
width:45,
minValue:0,
style:{textAlign:'center'},
listeners:{
render:this.onFieldRender,
focus:this.onFieldFocus,
scope:this
}
}]
},
{html:''},
{
xtype:'container',
items:[{
ref:'../topRightField',
xtype:'spinnerfield',
name:'tr',
width:45,
minValue:0,
style:{textAlign:'center'},
listeners:{
render:this.onFieldRender,
focus:this.onFieldFocus,
scope:this
}
}]
},
{html:'Right'},
{html:''},
{html:''},
{
ref:'lockButton',
xtype:'button',
iconCls:'lock-icon',
width:35,
enableToggle:true,
listeners:{
toggle:this.onLockToggle,
scope:this
}
},
{html:''},
{html:''},
{html:'Left'},
{
xtype:'container',
items:[{
ref:'../bottomLeftField',
xtype:'spinnerfield',
name:'bl',
width:45,
minValue:0,
style:{textAlign:'center'},
listeners:{
render:this.onFieldRender,
focus:this.onFieldFocus,
scope:this
}
}]
},
{html:''},
{
xtype:'container',
items:[{
ref:'../bottomRightField',
xtype:'spinnerfield',
name:'br',
width:45,
minValue:0,
style:{textAlign:'center'},
listeners:{
render:this.onFieldRender,
focus:this.onFieldFocus,
scope:this
}
}]
},
{html:'Right'},
{html:''},
{
html:'Bottom',
style:{
display:'block',
textAlign:'center',
margin:'5px'
}
},
{html:''},
{
html:'Bottom',
style:{
display:'block',
textAlign:'center',
margin:'5px'
}
},
{html:''}
];
this.addEvents('change');
web.ui.fields.CornerField.superclass.initComponent.apply(this,arguments)
},
disable:function(){
if(this.rendered){
this.items.each(function(item){
item.disable()
},this)
}
this.disabled=true;
this.fireEvent('disable',this)
},
enable:function(){
if(this.rendered){
this.items.each(function(item){
item.enable()
},this)
}
this.disabled=false;
this.fireEvent('enable',this)
},
setValue:function(values){
this.topLeftField.setRawValue(values.topLeft);
this.topRightField.setRawValue(values.topRight);
this.bottomRightField.setRawValue(values.bottomRight);
this.bottomLeftField.setRawValue(values.bottomLeft);
if(values.topLeft===values.topRight&&values.topLeft===values.bottomRight&&values.topLeft===values.bottomLeft){
this.lockButton.toggle(true,false)
}else{
this.lockButton.toggle(false,false)
}
},
getValue:function(){
return{
topLeft:this.topLeftField.getValue(),
topRight:this.topRightField.getValue(),
bottomRight:this.bottomRightField.getValue(),
bottomLeft:this.bottomLeftField.getValue()
}
},
onFieldRender:function(field){
field.el.on('keyup',function(el){
this.onFieldValidate(field)
},this);
field.on('spin',function(){
this.onFieldValidate(field)
},this)
},
onFieldFocus:function(field){
this.lastFocusedField=field
},
onFieldValidate:function(){
var interval;
return function(field){
var that=this;
if(interval){
window.clearTimeout(interval);
interval=null
}
interval=window.setTimeout(function(){
var value=field.getValue();
if(that.lockButton.pressed){
that.topLeftField.setRawValue(value);
that.topRightField.setRawValue(value);
that.bottomRightField.setRawValue(value);
that.bottomLeftField.setRawValue(value)
}
that.fireEvent('change',this,that.getValue())
},250)
}
}(),
onLockToggle:function(button,pressed){
var value=this.lastFocusedField?this.lastFocusedField.getValue():this.topLeftField.getValue();
if(pressed){
if(value!==this.topLeftField.getValue()&&value!==this.topRightField.getValue()&&value!==this.bottomRightField.getValue()&&value!==this.bottomLeftField.getValue()){
this.topLeftField.setRawValue(value);
this.topRightField.setRawValue(value);
this.bottomRightField.setRawValue(value);
this.bottomLeftField.setRawValue(value);
this.onFieldValidate(this.topLeftField)
}
}
}
});
Ext.reg('web-ui-fields-cornerfield',web.ui.fields.CornerField);
web.windows.blockProps.Corners=Ext.extend(web.windows.Window,{
initComponent:function(){
this.type='web.windows.blockProps.Corners';
this.title='Corners';
this.resizable=false;
this.width=320;
this.items=[
{
ref:'checkbox',
xtype:'checkbox',
hideLabel:true,
boxLabel:'Corners',
ctCls:'styleblock-checkbox',
listeners:{
check:this.onCornersCheck,
scope:this
}
},
{
xtype:'container',
height:1,
cls:'one-separator',
style:{margin:'20px 0 15px 0'}
},
{
ref:'cornerField',
xtype:'web-ui-fields-cornerfield',
disabled:true,
listeners:{
change:this.onChangeCorners,
scope:this
}
}
];
if(Ext.isIE8){
this.height=330;
this.items.unshift({
xtype:'box',
cls:'web-browser-corners-unsupported',
html:'<strong>'+'This feature is not supported by your browser (Internet Explorer 8).'+'</strong> '+'Please upgrade to Internet Explorer 9 or use the latest version of Google Chrome, Firefox, Safari, or Opera.'
})
}
web.windows.blockProps.Corners.superclass.initComponent.apply(this,arguments)
},
setValues:function(style){
var totalCornerRadius;
this.checkbox.suspendEvents();
if(style){
totalCornerRadius=style.topLeft+style.topRight+style.bottomRight+style.bottomLeft;
if(totalCornerRadius>0){
this.checkbox.setValue(true);
this.cornerField.enable()
}else{
this.checkbox.setValue(false);
this.cornerField.disable()
}
}else{
this.checkbox.setValue(false);
this.cornerField.disable()
}
this.checkbox.resumeEvents();
var defaultStyle={
topLeft:0,
topRight:0,
bottomRight:0,
bottomLeft:0
};
if(!Ext.isNumber(style.topLeft)&&!Ext.isNumber(style.topRight)&&!Ext.isNumber(style.bottomLeft)&&!Ext.isNumber(style.bottomRight)){
style={
topLeft:8,
topRight:8,
bottomRight:8,
bottomLeft:8
}
}
this.initialStyle=Ext.apply(defaultStyle,style);
this.cornerField.setValue(this.initialStyle)
},
onCornersCheck:function(checkbox,checked){
if(checked){
this.cornerField.enable();
this.fireEvent('adjust',{border:{corners:this.cornerField.getValue()}})
}else{
this.cornerField.disable();
this.fireEvent('adjust',{
border:{
corners:{
topLeft:null,
topRight:null,
bottomRight:null,
bottomLeft:null
}
}
})
}
},
onChangeCorners:function(frameField,corners){
this.fireEvent('adjust',{border:{corners:corners}})
}
});
web.ui.fields.ColorField=Ext.extend(Ext.form.TextField,{
xtype:'web-colorfield',
constructor:function(config){
this.emptyText='Select color';
this.color=null;
web.ui.fields.ColorField.superclass.constructor.call(this,config)
},
initComponent:function(){
this.color=null;
web.ui.fields.ColorField.superclass.initComponent.apply(this,arguments)
},
validator:function(value){
if(value===''){
return true
}else{
if(one.color(value)){
return true
}else{
return'Invalid color.'
}
}
},
setValue:function(value){
if(value){
this.color=one.color(value);
web.ui.fields.ColorField.superclass.setValue.call(this,this.color.hex())
}else{
this.color=null;
web.ui.fields.ColorField.superclass.setValue.call(this,'')
}
}
});
Ext.reg('web-colorfield',web.ui.fields.ColorField);
web.ui.fields.FourSidesField=Ext.extend(Ext.Container,{
xtype:'web-ui-fields-foursidesfield',
constructor:function(cfg){
this.width=cfg.width||170;
this.height=cfg.height||'auto';
this.labelWidth=cfg.labelWidth||70;
this.maxValue=cfg.maxValue||999;
this.mainFieldLeftPadding=cfg.mainFieldLeftPadding?cfg.mainFieldLeftPadding+'px':null;
this.fields={};
this.iconClassName={};
this.iconTooltip={};
this.cls='fourSidesfield';
this.tooltip=cfg.tooltip;
this.componentName=cfg.name||' ';
this.lockIconClass=this.componentName==='Corners'?'corners-icon':'spacing-icon';
this.componentType=cfg.componentType||'';
delete cfg.width;
delete cfg.height;
this.fields.firstField=cfg.fourFields.field1.dataKey;
this.fields.secondField=cfg.fourFields.field2.dataKey;
this.fields.thirdField=cfg.fourFields.field3.dataKey;
this.fields.fourthField=cfg.fourFields.field4.dataKey;
this.iconClassName.firstField=cfg.fourFields.field1.iconCls;
this.iconClassName.secondField=cfg.fourFields.field2.iconCls;
this.iconClassName.thirdField=cfg.fourFields.field3.iconCls;
this.iconClassName.fourthField=cfg.fourFields.field4.iconCls;
this.iconTooltip.firstField=cfg.fourFields.field1.iconTooltip;
this.iconTooltip.secondField=cfg.fourFields.field2.iconTooltip;
this.iconTooltip.thirdField=cfg.fourFields.field3.iconTooltip;
this.iconTooltip.fourthField=cfg.fourFields.field4.iconTooltip;
this.layout={type:'auto'};
this.items=[
{
xtype:'container',
layout:'hflex',
cls:'fourSidesfieldHead',
layoutConfig:{align:'middle'},
items:[
{
xtype:'label',
text:this.componentType+':',
flex:1
},
{
ref:'../lockButton',
xtype:'button',
cls:this.lockIconClass,
iconCls:'lock-icon',
tooltip:this.tooltip,
width:16,
height:20,
enableToggle:true
},
{
xtype:'container',
colspan:3,
items:[{
ref:'../../mainField',
xtype:'numberfield',
allowNegative:false,
enableKeyEvents:true,
maxValue:this.maxValue||999,
allowDecimals:false,
name:'r',
width:38,
minValue:0,
style:{textAlign:'center'},
listeners:{
keyup:{
fn:this.setUniformField,
buffer:500
},
blur:this.checkUniformField,
scope:this
}
}]
}
]
},
{
ref:'styleEditContainer',
name:'styleEditContainer',
xtype:'container',
cls:'fourSidesfieldCornersBody',
layout:'hauto',
style:{textAlign:'right'},
listeners:{
render:function(p){
p.getEl().addClass('fourSidesField-toggle-hidden')
},
scop:this,
single:true
},
items:[
{
xtype:'button',
cls:'icon fake-button fourSideIconOuter '+this.iconClassName.fourthField,
tooltip:this.iconTooltip.fourthField
},
{
ref:'../fourthField',
xtype:'numberfield',
allowNegative:false,
enableKeyEvents:true,
maxValue:this.maxValue||999,
allowDecimals:false,
name:'bl',
width:38,
minValue:0,
style:{textAlign:'center'},
listeners:{
keyup:{
fn:this.onFieldValidate,
buffer:500
},
scope:this
}
},
{
xtype:'button',
cls:'icon fake-button fourSideIconOuter '+this.iconClassName.firstField,
tooltip:this.iconTooltip.firstField
},
{
ref:'../firstField',
xtype:'numberfield',
allowNegative:false,
enableKeyEvents:true,
name:'tl',
width:38,
minValue:0,
maxValue:this.maxValue||999,
allowDecimals:false,
style:{textAlign:'center'},
listeners:{
keyup:{
fn:this.onFieldValidate,
buffer:500
},
scope:this
}
},
{
xtype:'button',
cls:'icon fake-button fourSideIconOuter '+this.iconClassName.thirdField,
tooltip:this.iconTooltip.thirdField
},
{
ref:'../thirdField',
xtype:'numberfield',
name:'tr',
allowNegative:false,
enableKeyEvents:true,
width:38,
minValue:0,
maxValue:this.maxValue||999,
allowDecimals:false,
style:{textAlign:'center'},
listeners:{
keyup:{
fn:this.onFieldValidate,
buffer:500
},
scope:this
}
},
{
xtype:'button',
cls:'icon fake-button fourSideIconOuter '+this.iconClassName.secondField,
tooltip:this.iconTooltip.secondField
},
{
ref:'../secondField',
xtype:'numberfield',
allowNegative:false,
enableKeyEvents:true,
name:'br',
width:38,
minValue:0,
maxValue:this.maxValue||999,
allowDecimals:false,
style:{textAlign:'center'},
listeners:{
keyup:{
fn:this.onFieldValidate,
buffer:500
},
scope:this
}
}
]
}
];
this.addEvents('change');
web.ui.fields.FourSidesField.superclass.constructor.call(this,cfg)
},
afterRender:function(){
web.ui.fields.FourSidesField.superclass.afterRender.call(this);
this.lockButton.on('afterrender',function(){
this.isRendered=true;
this.lockButton.on('toggle',function(context,value){
this.onLockToggle(context,value)
},this)
},this)
},
disable:function(){
if(this.rendered){
this.items.each(function(item){
item.disable()
},this)
}
this.disabled=true;
this.fireEvent('disable',this)
},
enable:function(){
if(this.rendered){
this.items.each(function(item){
item.enable()
},this)
}
this.disabled=false;
this.fireEvent('enable',this)
},
setValue:function(values){
values=values||{};
this.firstField.setValue(values.top||values.topLeft||values[0]||0);
this.secondField.setValue(values.right||values.topRight||values[1]||0);
this.thirdField.setValue(values.bottom||values.bottomRight||values[2]||0);
this.fourthField.setValue(values.left||values.bottomLeft||values[3]||0);
if(values.maxValue){
this.firstField.setMaxValue(values.maxValue);
this.secondField.setMaxValue(values.maxValue);
this.thirdField.setMaxValue(values.maxValue);
this.fourthField.setMaxValue(values.maxValue);
this.mainField.setMaxValue(values.maxValue)
}
var areValuesEqual=this.areFieldValuesEqual();
if(areValuesEqual){
if(this.firstField.getValue()!==this.mainField.getValue()){
this.updateField(this.mainField,this.firstField.getValue())
}
}else{
this.updateField(this.mainField,'')
}
if(this.isRendered){
this.toggleUI(!areValuesEqual)
}
},
getValue:function(){
var fieldsJSON={},maxValue=this.mainField.maxValue,firstFieldValue=this.firstField.getValue(),secondFieldValue=this.secondField.getValue(),thirdFieldValue=this.thirdField.getValue(),fourthFieldValue=this.fourthField.getValue();
if(firstFieldValue<=maxValue){
fieldsJSON[this.fields.firstField]=this.firstField.getValue()
}else{
return
}
if(secondFieldValue<=maxValue){
fieldsJSON[this.fields.secondField]=this.secondField.getValue()
}else{
return
}
if(thirdFieldValue<=maxValue){
fieldsJSON[this.fields.thirdField]=this.thirdField.getValue()
}else{
return
}
if(fourthFieldValue<=maxValue){
fieldsJSON[this.fields.fourthField]=this.fourthField.getValue()
}else{
return
}
return fieldsJSON
},
onFieldRender:function(field){
field.el.on('blur',function(){
if(field.getValue()===''){
field.setValue(0)
}
},this)
},
onFieldValidate:function(){
return function(field){
var value=this.getValue();
if(field.getValue()===''){
return false
}else{
if(value){
if(field.getValue()!==field.getRawValue()){
this.updateField(field,field.getValue())
}
this.fireEvent('change',this,value);
var areValuesEqual=this.areFieldValuesEqual();
if(areValuesEqual){
if(this.firstField.getValue()!==this.mainField.getRawValue()){
this.updateField(this.mainField,this.firstField.getValue())
}
}else{
this.updateField(this.mainField,'')
}
}
}
}
}(),
onLockToggle:function(button,pressed){
this.toggleUI(pressed)
},
toggleUI:function(expand){
if(expand){
this.mainField.disable();
this.lockButton.getEl().addClass('x-btn-pressed');
if(this.styleEditContainer.getEl()){
this.styleEditContainer.getEl().removeClass('fourSidesField-toggle-hidden')
}
}else{
this.lockButton.getEl().removeClass('x-btn-pressed');
this.mainField.enable();
if(this.areFieldValuesEqual()){
this.mainField.setValue(this.firstField.getValue())
}
this.styleEditContainer.getEl().addClass('fourSidesField-toggle-hidden')
}
},
updateField:function(field,value){
if(value!==undefined){
field.suspendEvents();
field.setValue(value);
field.resumeEvents()
}
},
areFieldValuesEqual:function(values){
if(values){
return values.topLeft===values.topRight&&values.topLeft===values.bottomRight&&values.topLeft===values.bottomLeft
}else{
return this.firstField.getValue()===this.secondField.getValue()&&this.firstField.getValue()===this.thirdField.getValue()&&this.firstField.getValue()===this.fourthField.getValue()
}
},
setUniformField:function(mainField){
var mainFieldValue=mainField.getValue();
if(mainFieldValue!==''){
this.firstField.suspendEvents();
this.firstField.setValue(mainFieldValue);
this.firstField.resumeEvents();
this.secondField.suspendEvents();
this.secondField.setValue(mainFieldValue);
this.secondField.resumeEvents();
this.thirdField.suspendEvents();
this.thirdField.setValue(mainFieldValue);
this.thirdField.resumeEvents();
this.fourthField.suspendEvents();
this.fourthField.setValue(mainFieldValue);
this.fourthField.resumeEvents();
this.onFieldValidate(this.firstField)
}
},
checkUniformField:function(mainfield){
if(mainfield.getValue()===''){
this.firstField.suspendEvents();
this.firstField.setValue(0);
this.firstField.resumeEvents();
this.secondField.suspendEvents();
this.secondField.setValue(0);
this.secondField.resumeEvents();
this.thirdField.suspendEvents();
this.thirdField.setValue(0);
this.thirdField.resumeEvents();
this.fourthField.suspendEvents();
this.fourthField.setValue(0);
this.fourthField.resumeEvents();
this.onFieldValidate(this.firstField)
}
},
setFocus:function(field,styleProp,toggleBtn){
var prop,sides=this.fields,fieldSide='';
if(styleProp==='border'){
if(!toggleBtn.getEl().hasClass('borderStyle-toggle-hidden')){
toggleBtn.getEl().toggleClass('borderStyle-toggle-hidden')
}
}
for(prop in sides){
if(sides[prop]===field){
fieldSide=prop;
break
}
}
if(this.lockButton.pressed&&this.areFieldValuesEqual()){
this.mainField.enable();
this.mainField.focus()
}else{
this[fieldSide].focus()
}
}
});
Ext.reg('web-ui-fields-foursidesfield',web.ui.fields.FourSidesField);
Ext.ns('web.ui.blockStyle');
web.ui.blockStyle.Background=Ext.extend(Ext.Container,{
constructor:function(cfg){
this.app=cfg.app;
this.componentLabel=cfg.componentLabel;
this.width=275;
this.height='auto';
this.toggleHideClass='backgroundPanelBody-visible';
this.initialStyle={};
this.isBgRemoveBtnVisible=true;
this.layout={type:'auto'};
this.backgroundRemoveBtnVisible=false;
this.cls='background-panel-ui';
this.items=[
{
xtype:'container',
layout:'hflex',
layoutConfig:{align:'middle'},
height:25,
ctCls:'styleBlock-custom-panel',
style:{position:'relative'},
items:[
{
xtype:'label',
text:this.componentLabel,
flex:1
},
{
xtype:'button',
ref:'../placeholder',
cls:'background-preview',
style:{
width:'94px',
height:'23px',
position:'absolute',
left:'155px'
},
html:'<div style="width:100%;height:100%;filter:none;"></div>',
listeners:{
click:this.togglePanelBody,
scope:this
}
},
{
ref:'../backgroundRemoveBtn',
xtype:'button',
tooltip:'Remove background',
ctCls:'hflex-item__removeBtnContainer',
cls:'props-panel-remove-button styleBlock-remove-icon',
listeners:{
click:this.onRemoveBtnClick,
scope:this
}
},
{
xtype:'button',
ref:'../settingsGearBtn',
style:{position:'relative'},
cls:'custom-color-panel-gear-btn custom-bgPanel-btn color-chooser-panel',
enableToggle:true,
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
tooltip:'Edit background',
listeners:{
click:this.togglePanelBody,
scope:this
}
}
]
},
{
xtype:'spacer',
ref:'panelBodyPatch',
cls:'custom-panel-patch-holder style-block-patch custom-patch',
height:'2px',
html:'<div class="custom-panel-body-patch"></div>'
},
{
xtype:'container',
ref:'backgroundPanelBody',
layout:'auto',
cls:'custom-color-panel-body',
items:{
ref:'../backgroundPanel',
xtype:'web-panels-props-styleBlock-background',
app:this.app,
enableImageAttachment:cfg.enableImageAttachment,
listeners:{
adjust:this.onAdjust,
scope:this
}
}
}
];
this.addEvents('adjust');
web.ui.blockStyle.Background.superclass.constructor.call(this,cfg)
},
afterRender:function(){
web.ui.blockStyle.Background.superclass.afterRender.call(this);
this.placeholder.on('afterrender',function(){
this.updateHeaderStyleField()
},this)
},
setValue:function(value,options){
this.initialStyle=value||{};
this.backgroundPanelBody.items.items[0].setValues(this.initialStyle,options);
this.updateHeaderStyleField(this.initialStyle)
},
togglePanelBody:function(event){
var currentPanelBody=this.backgroundPanelBody.getEl();
if(!this.backgroundPanelBody.getEl().hasClass('backgroundPanelBody-visible')){
this.backgroundPanelBody.items.items[0].setValues(this.initialStyle)
}
if(this.settingsGearBtn.el.dom!==event.el.dom){
this.settingsGearBtn.suspendEvents();
this.settingsGearBtn.toggle();
this.settingsGearBtn.resumeEvents()
}
var that=this;
var panelBodyPatchEl=that.panelBodyPatch.getEl();
var step1=function(){
panelBodyPatchEl.toggleClass('custom-panel-patch-holder-visible')
};
var step2=function(){
currentPanelBody.toggleClass('custom-panel-isExpanded backgroundPanelBody-visible');
if(that.backgroundPanelBody.items.items[0].isBgImgPropExpanded()){
currentPanelBody.toggleClass('backgroundTabToggle__bgImgExpand')
}
};
if(!currentPanelBody.hasClass('custom-panel-isExpanded')){
step1();
step2()
}else{
step2();
setTimeout(function(){
step1()
},200)
}
},
onRemoveBtnClick:function(removeBtn){
this.backgroundPanel.onRemoveBtnClick(!removeBtn.isVisible());
this.updateHeaderStyleField()
},
updateHeader:function(){
this.updateHeaderRemoveBtn(true);
if(this.placeholder.el){
this.updateHeaderStyleField()
}
},
updateHeaderRemoveBtn:function(isVisible){
if(this.backgroundRemoveBtnVisible){
this.backgroundRemoveBtn.suspendEvents(false);
this.backgroundRemoveBtn.setVisible(isVisible);
this.backgroundRemoveBtn.resumeEvents()
}
},
updateHeaderStyleField:function(style){
var styleBackground=style||null,cssBackgroundStyle;
if(styleBackground){
cssBackgroundStyle=this.backgroundPanel.getBackgroundStyle(styleBackground,this.placeholder)
}
if(cssBackgroundStyle){
if(this.isBgRemoveBtnVisible){
this.backgroundRemoveBtnVisible=true;
this.backgroundRemoveBtn.show();
this.updateHeaderRemoveBtn(true)
}else{
this.backgroundRemoveBtn.hide()
}
}else{
if(style===null||style&&!style.color){
if(this.backgroundPanel.el){
this.setDefaultStyleFields()
}else{
this.mon(this.backgroundPanel,'render',function(){
this.setDefaultStyleFields()
},this,{single:true})
}
}
this.backgroundRemoveBtnVisible=false;
this.backgroundRemoveBtn.hide()
}
if(!this.backgroundRemoveBtn.isVisible()){
this.backgroundRemoveBtnVisible=false;
this.backgroundRemoveBtn.hide()
}
},
setDefaultStyleFields:function(){
this.backgroundPanel.setDefaultColor();
this.placeholder.el.dom.childNodes[0].style.background='none';
this.placeholder.el.dom.childNodes[0].innerHTML='<div class="backgroundHighlight_transparent"></div>'
},
onAdjust:function(opts){
this.initialStyle=Ext.apply(this.initialStyle,opts.background);
this.fireEvent('adjust',opts);
this.app.actionTips.pushMessage('actionTip-firstTimeChangeColor')
}
});
Ext.ComponentMgr.registerType('web-ui-blockstyle-background',web.ui.blockStyle.Background);
web.ui.blockStyle.Border=Ext.extend(Ext.Container,{
constructor:function(cfg){
this.app=cfg.app;
this.componentLabel=cfg.componentLabel;
this.width=275;
this.height='auto';
this.toggleHideClass='borderPanelBody-visible';
this.initialStyle=null;
this.borderRemoveBtnVisible=cfg.removable===undefined?true:cfg.removable;
this.layout={type:'auto'};
this.items=[
{
xtype:'container',
layout:'hflex',
layoutConfig:{align:'middle'},
height:25,
ctCls:'styleBlock-custom-panel',
style:{position:'relative'},
items:[
{
xtype:'label',
text:this.componentLabel,
flex:1
},
{
xtype:'button',
ref:'../placeholder',
cls:'custom-panel-header-input',
style:{
width:'95px',
height:'23px',
position:'absolute',
left:'154px'
},
html:'<div style="width:65px;height:100%;position:absolute;top:10px;left:5px;background:none;filter:none;box-shadow:none"></div>',
listeners:{
click:this.togglePanelBody,
scope:this
}
},
{
ref:'../borderRemoveBtn',
xtype:'button',
tooltip:'Remove border',
ctCls:'hflex-item__removeBtnContainer',
cls:'props-panel-remove-button styleBlock-remove-icon',
listeners:{
click:this.onRemoveBtnClick,
scope:this
}
},
{
xtype:'button',
ref:'../settingsGearBtn',
style:{position:'relative'},
cls:'custom-color-panel-gear-btn color-chooser-panel',
enableToggle:true,
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
tooltip:'Edit border',
listeners:{
click:this.togglePanelBody,
scope:this
}
}
]
},
{
xtype:'spacer',
ref:'panelBodyPatch',
cls:'custom-panel-patch-holder style-block-patch',
height:'2px',
html:'<div class="custom-panel-body-patch"></div>'
},
{
xtype:'container',
layout:'auto',
ref:'borderPanelBody',
cls:'custom-color-panel-body',
items:{
ref:'../borderPanel',
xtype:'web-panels-props-styleBlock-border',
app:this.app,
listeners:{
adjust:this.onAdjust,
scope:this
}
}
}
];
this.addEvents('adjust');
web.ui.blockStyle.Border.superclass.constructor.call(this,cfg)
},
afterRender:function(){
web.ui.blockStyle.Border.superclass.afterRender.call(this);
this.placeholder.on('afterrender',function(){
this.updateHeaderStyleField()
},this)
},
setValue:function(value){
this.initialStyle=value;
this.borderPanel.setValues(this.initialStyle);
this.updateHeaderStyleField(this.initialStyle)
},
togglePanelBody:function(event){
if(this.settingsGearBtn.el.dom!==event.el.dom){
this.settingsGearBtn.suspendEvents();
this.settingsGearBtn.toggle();
this.settingsGearBtn.resumeEvents()
}
var that=this,borderPanelBodyEl=that.borderPanelBody.getEl(),panelBodyPatchEl=that.panelBodyPatch.getEl(),step1=function(){
panelBodyPatchEl.toggleClass('custom-panel-patch-holder-visible')
},step2=function(){
borderPanelBodyEl.toggleClass('custom-panel-isExpanded borderPanelBody-visible')
};
if(!borderPanelBodyEl.hasClass('custom-panel-isExpanded')){
step1();
step2()
}else{
step2();
setTimeout(function(){
step1()
},200)
}
},
onRemoveBtnClick:function(removeBtn){
this.borderPanel.onRemoveBtnClick(!removeBtn.isVisible());
this.updateHeaderStyleField()
},
updateHeader:function(style){
this.updateHeaderRemoveBtn(true);
if(this.placeholder.el){
this.updateHeaderStyleField(style)
}
},
updateHeaderRemoveBtn:function(isVisible){
if(this.borderRemoveBtnVisible){
this.borderRemoveBtn.suspendEvents(false);
this.borderRemoveBtn.setVisible(isVisible);
if(isVisible){
this.borderRemoveBtn.show()
}else{
this.borderRemoveBtn.hide()
}
this.borderRemoveBtn.resumeEvents()
}
},
updateHeaderStyleField:function(style){
var borderStyle=style||null,borderStyleWidth=null,arrayBorderStyleWidth=null,that=this;
if(borderStyle){
if(borderStyle.color){
borderStyleWidth=borderStyle.width;
if(borderStyleWidth){
if(!borderStyleWidth.length){
arrayBorderStyleWidth=[
borderStyleWidth.top,
borderStyleWidth.right,
borderStyleWidth.bottom,
borderStyleWidth.left
]
}
}
if(this.borderPanel.getBorderWidth(arrayBorderStyleWidth||borderStyle.width)){
window.setTimeout(function(){
if(borderStyle.color){
that.placeholder.el.dom.childNodes[0].style.borderTop=that.borderPanel.getBorderStyle(borderStyle.color[0]);
that.placeholder.getEl().first('div').removeClass('borderHighlight_transparent')
}
},500);
this.updateHeaderRemoveBtn(true)
}else{
window.setTimeout(function(){
that.placeholder.getEl().first('div').addClass('borderHighlight_transparent')
},500);
this.updateHeaderRemoveBtn(false)
}
}else{
window.setTimeout(function(){
that.placeholder.getEl().first('div').addClass('borderHighlight_transparent')
},500);
this.updateHeaderRemoveBtn(false)
}
}else{
window.setTimeout(function(){
that.borderPanel.setDefaultColor();
that.placeholder.getEl().first('div').addClass('borderHighlight_transparent')
},500);
this.updateHeaderRemoveBtn(false)
}
if(!this.borderRemoveBtn.isVisible()){
this.updateHeaderRemoveBtn(false)
}
},
getBorderWidth:function(borderWidth){
var width=borderWidth||null;
if(width){
return width[0]+width[1]+width[2]+width[3]||null
}else{
if(this.initialStyle){
width=this.initialStyle
}
if(width){
return width.top+width.bottom+width.right+width.left||null
}else{
return null
}
}
},
onAdjust:function(opts){
this.fireEvent('adjust',opts);
this.app.actionTips.pushMessage('actionTip-firstTimeChangeColor')
}
});
Ext.ComponentMgr.registerType('web-ui-blockstyle-border',web.ui.blockStyle.Border);
web.panels.props.StyleBlock=Ext.extend(web.panels.Panel,{
xtype:'web-props-styleblock',
constructor:function(config){
this.styleBlock=null;
this.forceBackground=config.forceBackground?true:false;
this.fixedBorderWidth=config.fixedBorderWidth||null;
web.panels.props.StyleBlock.superclass.constructor.call(this,config)
},
initComponent:function(){
this.cls='web-prop-btn-group web-properties-styleBlock';
this.defaults={style:{marginBottom:'5px'}};
this.items={
xtype:'container',
itemId:'styleBlockHolder',
cls:'web-comp-styleBlock-holder',
style:{
padding:'0 20px 0 0',
float:'none',
height:'300px'
},
defaults:{width:275},
items:[
{
xtype:'web-ui-blockstyle-background',
componentLabel:'Background:',
ref:'../backgroundTab',
app:this.app,
listeners:{
adjust:this.onAdjust,
scope:this
}
},
{
xtype:'web-ui-blockstyle-border',
style:{paddingTop:'10px'},
componentLabel:'Border:',
ref:'../borderTab',
app:this.app,
listeners:{
adjust:this.onAdjust,
scope:this
}
},
{
xtype:'container',
layout:'vflex',
layoutConfig:{align:'middle'},
items:[{
ref:'../../cornerstab',
xtype:'web-ui-fields-foursidesfield',
tooltip:'Provide different values for corners on each side',
name:'Corners',
componentType:'Corners'+' (px)',
cls:'fourSidesfield boxStyle-fourSidesfield',
fourFields:{
field1:{
iconCls:'corner-topLeft',
iconTooltip:'Top left corner',
dataKey:'topLeft'
},
field2:{
iconCls:'corner-topRight',
iconTooltip:'Top right corner',
dataKey:'topRight'
},
field3:{
iconCls:'corner-bottomRight',
iconTooltip:'Bottom right corner',
dataKey:'bottomRight'
},
field4:{
iconCls:'corner-bottomLeft',
iconTooltip:'Bottom left corner',
dataKey:'bottomLeft'
}
},
listeners:{
change:this.onChangeCorners,
scope:this
}
}]
}
]
};
this.addEvents('adjust');
web.panels.props.StyleBlock.superclass.initComponent.apply(this,arguments);
this.app.on('activate',function(cfg){
if(cfg.component!==this.component){
return
}
},this)
},
initListeners:function(){
var app=this.app;
app.on('update',function(part){
if(part===this.styleBlock){
this.refresh()
}
},this)
},
defaultSettings:function(option){
var settings={
gradient:null,
imageId:null,
color:null,
repeat:[
true,
true
],
position:[
'0%',
'0%'
]
};
return{
gradient:function(){
var gradient=Ext.apply({},settings);
return Ext.apply(gradient,{
gradient:{
gradType:'linear',
size:'farthest-corner',
origin:'left',
stops:[
[
one.color('#FFF').toJSON(),
'0%'
],
[
one.color('#FFF').toJSON(),
'100%'
]
]
}
})
},
image:function(){
return Ext.apply({},settings)
},
none:function(){
return Ext.apply({},settings)
}
}
}(),
setComponent:function(component){
this.block=component;
this.component=component;
this.styleBlock=component.getStyle();
this.componentType=this.component.type.split('.').slice(-1)[0];
this.refresh({calledFrom:'setComponent'})
},
onAdjust:function(){
var interval,oldStyle;
return function(opts){
var that=this;
if(oldStyle===undefined){
oldStyle={
background:this.styleBlock.getApplied('background'),
border:this.styleBlock.getApplied('border')
}
}
this.styleBlock.set(opts);
this.fireEvent('adjust',this.styleBlock);
if(interval){
window.clearTimeout(interval)
}
interval=window.setTimeout(function(){
that.styleBlock.set(oldStyle);
var command=new web.commands.components.blocks.EditStyle({
style:that.styleBlock,
opts:opts
});
that.app.invoker.execute(command);
oldStyle=undefined
},300)
}
}(),
onChangeStyle:function(combo,styleRecord){
var style=styleRecord.data.style,border=Ext.apply(this.initialStyle,{
style:[
style,
style,
style,
style
]
});
this.fireEvent('adjust',{border:border})
},
onChangeCorners:function(frameField,corners){
var that=this;
that.onAdjust({border:{corners:corners}})
},
refresh:function(options){
options=options||{};
var bgStyle=this.styleBlock.getApplied('background'),borderStyle=this.styleBlock.getApplied('border'),cornersStyle=borderStyle?borderStyle.corners:null;
Ext.apply(borderStyle,{maxValue:web.utils.BorderWidth.getMaxWidth(this.component.getWidth(),this.component.getHeight())||50});
this.backgroundTab.setValue(bgStyle||null,options);
this.borderTab.setValue(borderStyle||null);
this.cornerstab.setValue(cornersStyle)
}
});
Ext.reg('web-props-styleblock',web.panels.props.StyleBlock);
web.panels.props.Block=Ext.extend(web.panels.Panel,{
title:'',
constructor:function(config){
this.component=null;
web.panels.props.Block.superclass.constructor.call(this,config);
this.setComponent(this.component)
},
initComponent:function(){
this.cls='web-props-panel';
this.items=[{
xtype:'container',
region:'center',
cls:'block-style-component',
style:{padding:'20px 0 0 20px'},
items:[{
ref:'../styleBlock',
makeBoxStyleFlex:true,
xtype:'web-props-styleblock',
app:this.app
}]
}];
web.panels.props.Block.superclass.initComponent.apply(this,arguments)
},
setComponent:function(component){
this.component=component;
this.styleBlock.setComponent(component)
},
refresh:function(){
this.styleBlock.refresh()
}
});
Ext.ns('web.panels.props.resources');
web.panels.props.Mobile=Ext.extend(web.panels.Panel,{
xtype:'web-props-mobile',
constructor:function(config){
this.component=config.cmp;
web.panels.props.Mobile.superclass.constructor.call(this,config)
},
initComponent:function(){
var cmp=this.component,cb=function(components){
var part=components.length===1?components[0]:null;
if(part instanceof web.data.components.Component&&part.type===this.component.type){
this.refresh()
}
};
this.width='100%';
this.layout='form';
this.cls='web-props-mobile';
this.labelWidth=200;
this.labelSeparator='';
this.items=[
{
xtype:'checkbox',
ref:'mobileDown',
value:cmp.getMobileDown(),
fieldLabel:'<div class="web-props-mobile-icon icon"></div>'+'Move to bottom in mobile view',
labelSeparator:'',
handler:this.onToggle,
scope:this
},
{
xtype:'checkbox',
ref:'mobileHide',
value:cmp.isMobileHide(),
fieldLabel:'<div class="web-props-mobile-icon icon"></div>'+'Hide in mobile view',
labelSeparator:'',
handler:this.onToggle,
scope:this
}
];
this.on('afterrender',function(){
this.refresh()
},this);
web.panels.props.Mobile.superclass.initComponent.apply(this,arguments);
this.app.workspace.multiSelect.on('multiselect',cb,this)
},
refresh:function(){
var hideCount=0,cmp=this.component=this.app.workspace.multiSelect.selected[0]||this.app.getSelected('component'),down=cmp.getMobileDown(),hide=cmp.isMobileHide(),originalHeight=this.originalHeight,diffHeight=Math.round(originalHeight/2)-4,height=originalHeight;
this.mobileDown.suspendEvents();
this.mobileDown.setValue(down);
this.mobileDown.resumeEvents();
if(!cmp.inPage()&&cmp.isMobileLeaf()&&!cmp.inText()){
this.mobileDown.show()
}else{
this.mobileDown.hide();
height-=diffHeight;
hideCount+=1
}
this.mobileHide.suspendEvents();
this.mobileHide.setValue(hide);
this.mobileHide.resumeEvents();
if(cmp.isMobileLeaf()&&!cmp.inText()){
this.mobileHide.show()
}else{
this.mobileHide.hide();
height-=diffHeight;
hideCount+=1
}
this.setHeight(height)
},
onToggle:function(button,state){
var cfg={};
if(!button.eventsSuspended){
cfg[button.ref]=state;
this.app.invoker.execute(new web.commands.components.SetConfig({
component:this.component,
config:cfg
}))
}
}
});
Ext.reg('web-props-mobile',web.panels.props.Mobile);
web.windows.Link=Ext.extend(web.windows.Window,{
initialHref:'http://',
resizable:false,
validation:{
'oneweb':{
validate:function(){
var action=this.values.action,link;
if(action){
link=this.app.dm.get(action.getLinkId());
if(link&&link.getPageId&&this.tree.getNodeByPageId(link.getPageId())&&!this.tree.getNodeByPageId(link.getPageId()).isSelected()){
this.fireEvent('validate:ok',1)
}
}else if(this.treeSelect.getSelectedNode()){
this.fireEvent('validate:ok',1)
}else{
this.fireEvent('validate:error',1)
}
}
},
'webspace':{
validate:function(){
}
},
'external':{
validate:function(){
this.hrefField.validate()
}
},
'mail':{
validate:function(){
this.mailField.validate()
}
},
bind:function(context){
for(var state in this){
if(this.hasOwnProperty(state)&&this[state].validate){
this[state].validate=this[state].validate.bind(context)
}
}
this.reset()
},
reset:function(){
for(var state in this){
if(this.hasOwnProperty(state)&&this[state].validate){
this[state].priorityError=1;
this[state].priorityOk=1
}
}
},
state:'',
setTabState:function(state){
this.state=state
},
getCurrentTabState:function(){
return this[this.state]
},
validate:function(){
this.getCurrentTabState().validate()
},
isValidated:function(){
return this.getCurrentTabState().validated
}
},
initComponent:function(config){
this.linkType=null;
this.validation.bind(this);
this.on('validate:ok',function(priority){
var state=this.validation.getCurrentTabState();
priority=priority||1;
if(state.priorityError<=priority){
state.validated=true;
if(priority>=3){
priority=state.priorityOk
}
state.priorityOk=priority;
state.priorityError=1;
this.addLinkButton.enable()
}
},this);
this.on('validate:error',function(priority){
var state=this.validation.getCurrentTabState();
priority=priority||1;
if(state.priorityOk<=priority){
state.validated=false;
state.priorityError=priority;
this.addLinkButton.disable()
}
},this);
this.tree=new web.ui.SiteMapTree({
app:this.app,
pagesOnly:true,
border:false,
cls:'tree-pages-list',
width:478,
height:366,
nodeUiProvider:web.ui.tree.SiteLinksNodeUI,
listeners:{
click:function(node,e){
this.pagePreview.loadPreview({node:node});
this.removeLinkAbortRequest();
if(this.values.action&&this.values.action.getLinkId()===node.id&&this.openInNewTab.checked===Boolean(this.values.action.getActionType())){
this.addLinkButton.disable()
}else{
this.addLinkButton.enable()
}
},
scope:this
}
});
this.pagePreview=new Ext.Container({
flex:1,
html:'',
loadPreview:function(cfg){
cfg=cfg||{};
var node=cfg.node,pageId=cfg.pageId||node&&node.attributes.pageId,url=pageId&&this.app.dal.getPagePreviewImageUrl(pageId)+'?width=240&height=333&zoom=0.22&cropw=240&croph=333';
this.update('<div style="padding: 20px 10px; height: 375px; border-left: 1px solid #eff1f0;">'+'<div style="'+[
'width: 240px',
'height: 100%',
'background-image: url('+(url||'')+')',
'background-size: contain',
'background-repeat: no-repeat',
'background-position: 50% 50%'
].join(';')+'">'+'</div>'+'</div>')
},
app:this.app,
scope:this
});
this.treeSelect=this.tree.getSelectionModel();
this.hrefField=new Ext.form.TextField({
value:this.initialHref,
width:440,
style:{marginTop:'5px'},
validator:function(value){
if(value===web.windows.Link.DUMMY_URL){
return true
}
return web.data.links.LinkExternal.validate(value)
},
listeners:{
blur:function(t){
if(t.getValue()===web.windows.Link.DUMMY_URL){
return true
}
t.setValue(web.data.links.LinkExternal.compatibleEncodeURL(t.getValue()))
},
invalid:function(t){
this.fireEvent('validate:error',3)
},
valid:function(t){
var action=this.values.action,link,url;
this.fireEvent('validate:ok',3);
this.removeLinkAbortRequest();
if(action){
link=this.app.dm.get(action.getLinkId());
url=link?link.getURL():'';
if(url!==''&&!link.getPageId){
if(url===t.getValue()){
this.fireEvent('validate:error',1)
}
}
}
},
scope:this
}
});
this.mailField=new Ext.form.ComboBox({
width:442,
store:[],
triggerAction:'all',
mode:'local',
validator:function(value){
return!!value.match(one.validation.email)
},
listeners:{
invalid:function(t){
this.fireEvent('validate:error',3)
},
valid:function(t){
var action=this.values.action,link,url;
this.fireEvent('validate:ok',3);
this.removeLinkAbortRequest();
if(action){
link=this.app.dm.get(action.getLinkId());
url=link?link.getURL():'';
if(url!==''&&!link.getPageId){
if(url.replace(/^mailto:/,'')===t.getEl().getValue()){
this.fireEvent('validate:error',1)
}
}
}
},
afterRender:function(mailField){
mailField.wrap.setLeft(1).setWidth(448)
},
scope:this
}
});
this.removeLinkLabel=new Ext.form.Label({
text:'Current link:',
cls:'footer-label',
style:'padding-right: 10px'
});
this.removeLinkFileName=new Ext.form.Label({
cls:'green-text',
text:'poster.jpg'
});
this.removeLinkButton=new Ext.Button({
text:'',
cls:'delete-button',
iconCls:'icon icon-remove-link',
style:'margin-left: 10px',
height:18,
handler:function(){
this.removeLinkRequest()
},
scope:this
});
this.actionBoxLabel=new Ext.form.Label({
text:'Open in new window/tab',
cls:'footer-label',
style:'padding-right: 10px'
});
this.openInNewTab=new Ext.form.Checkbox({
listeners:{
check:function(t,checked){
var link,action=this.values.action,activeTabIdx=this.tabs.getActiveTabIndex(),priority=action&&action.getActionType()!=checked?2:1;
this.fireEvent('validate:ok',priority);
this.validation.validate();
if(action){
link=this.app.dm.get(action.getLinkId());
if(0===activeTabIdx&&link instanceof web.data.links.Link){
if(this.tree.getSelectionModel().getSelectedNode()){
if(this.tree.getSelectionModel().getSelectedNode().id===link.id&&checked===Boolean(action.getActionType())){
this.addLinkButton.disable()
}else{
this.addLinkButton.enable()
}
}else{
this.addLinkButton.disable()
}
}else if(1===activeTabIdx&&/^webspace:/.test(link.getURL())&&link instanceof web.data.links.LinkExternal){
var selectedPaths=this.corefilecomp.fileChooser.getSelectedPaths();
if(selectedPaths.length){
if(selectedPaths[0].file===link.getURL().replace(/^webspace:/,'')&&checked===Boolean(action.getActionType())){
this.addLinkButton.disable()
}else{
this.addLinkButton.enable()
}
}else{
this.addLinkButton.disable()
}
}
}
},
scope:this
}
});
this.cancelButton=new Ext.Button({
text:'Cancel',
cls:'x-btn-secondary large wide',
listeners:{
click:function(){
this.hide()
},
scope:this
}
});
this.addLinkButton=new Ext.Button({
text:'Save',
cls:'x-btn-primary large wide',
disabled:true,
listeners:{
click:this.onOK,
scope:this
}
});
this.fileUploadStatus=new Ext.form.Label({
cls:'hbox cross-center',
style:'padding-top: 5px; padding-bottom: 1px;',
text:0+' of '+0+' uploaded'
});
Ext.apply(this,{
cls:'web-window-link web-window-notitle',
bodyCssClass:'vbox',
width:900,
height:600,
closeAction:'hide',
modal:true,
items:[
{
xtype:'web-ui-tabpanel',
cls:'flex',
tabPosition:'west',
ref:'tabs',
activeTab:0,
tabWidth:160,
listeners:{
tabchange:function(tabPanel,tab){
this.app.windows.setWindowToCenter(this,{onlyIfOutsideView:true});
if(3===this.tabs.getActiveTabIndex()){
this.actionBoxLabel.hide();
this.openInNewTab.disable()
}else{
this.actionBoxLabel.show();
this.openInNewTab.enable()
}
},
scope:this
},
items:[
{
xtype:'container',
itemId:'oneweb',
title:'Page in Website Builder',
tabTip:'Link to one of your Website Builder pages.',
cls:'vbox ',
height:473,
items:[
{
cls:'tab-h1 hbox cross-center',
style:'border-bottom: 1px solid #eff1f0;',
html:'Link to a page in Website Builder'
},
{
xtype:'container',
cls:'hbox flex',
items:[
this.tree,
this.pagePreview
]
}
],
listeners:{
show:function(container){
this.validation.setTabState(container.itemId);
this.validation.validate()
},
scope:this
}
},
{
itemId:'webspace',
title:'File',
tabTip:'Link to any file on your web space.',
border:false,
layout:'fit',
items:[{
xtype:'container',
layout:'fit',
items:[{
ref:'../../../corefilecomp',
xtype:'web-ui-corefile',
title:'Link to a file',
app:this.app,
fileUploadStatus:this.fileUploadStatus,
width:740,
height:388,
listeners:{
fileselected:function(path){
this.selectedFile='webspace:'+path;
this.fireEvent('validate:ok',3);
this.removeLinkAbortRequest();
if(this.values.action&&path===this.app.dm.get(this.values.action.getLinkId()).url.replace(/^webspace:/,'')&&Boolean(this.values.action.getActionType())===this.openInNewTab.checked){
this.addLinkButton.disable()
}
},
filedeselected:function(){
this.addLinkButton.disable()
},
fileconfirmed:function(path){
this.selectedFile='webspace:'+path;
this.onOK()
},
fileuploaded:function(asset){
this.selectedFile=asset.url;
this.onOK()
},
directoryselected:function(path){
this.selectedFile=null;
this.fireEvent('validate:error',3)
},
scope:this
}
}]
}],
listeners:{
show:function(container){
this.validation.setTabState(container.itemId);
if(this.selectedFile){
this.corefilecomp.refreshFileChooser([this.selectedFile])
}else{
this.corefilecomp.refreshFileChooser()
}
this.addLinkButton.disable();
this.corefilecomp.enableMultiSelect(false);
this.corefilecomp.doLayout();
this.corefilecomp.doLayout()
},
scope:this
}
},
{
itemId:'external',
title:'External URL',
tabTip:'Link to an external URL.',
ref:'hrefForm',
layout:'vbox',
height:473,
items:[
{
cls:'tab-h1 hbox cross-center',
html:'Link to an external URL'
},
{
xtype:'label',
style:'padding-left: 20px;',
html:'Link to an external URL:'
},
{
xtype:'container',
style:'padding-left: 20px;',
items:[this.hrefField]
}
],
listeners:{
show:function(container){
this.okPressedForExternal=false;
this.hrefField.removeClass('x-form-invalid');
this.validation.setTabState(container.itemId);
this.validation.validate()
},
scope:this
}
},
{
itemId:'mail',
title:'Email',
tabTip:'Link to an email address.',
ref:'mailForm',
layout:'vbox',
height:473,
items:[
{
cls:'tab-h1 hbox cross-center',
html:'Link to an email'
},
{
xtype:'label',
html:'Link to an email address:',
style:{
paddingBottom:'5px',
paddingLeft:'20px'
}
},
{
xtype:'container',
style:'padding-left: 20px;',
items:[this.mailField]
},
{
xtype:'label',
style:{
marginTop:'10px',
color:'#888',
fontSize:'11px',
padding:'0 20px'
},
text:'This generates a link on your website. When visitors click this link it will open a new email with their preferred email program.'
}
],
listeners:{
show:function(container){
this.validation.setTabState(container.itemId);
this.validation.validate()
},
scope:this
}
}
]
},
{
xtype:'container',
cls:'web-window-footer hbox cross-center',
items:[
{
xtype:'container',
cls:'vbox flex',
items:[
{
xtype:'container',
cls:'hbox cross-center',
style:'padding-bottom: 5px',
items:[
this.removeLinkLabel,
this.removeLinkFileName,
this.removeLinkButton
]
},
{
xtype:'container',
cls:'hbox cross-center',
items:[
this.actionBoxLabel,
this.openInNewTab
]
},
this.fileUploadStatus
]
},
{
xtype:'container',
cls:'hbox',
items:[
this.cancelButton,
{
xtype:'spacer',
width:14
},
this.addLinkButton
]
}
]
}
]
});
this.listeners={
show:function(){
this.tree.refresh();
this.fileUploadStatus.hide()
},
scope:this
};
this.addEvents('validate:error','validate:ok');
web.windows.Link.superclass.initComponent.call(this,config)
},
setValues:function(action){
this.values={action:action}
},
refresh:function(){
var action=this.values.action;
this.pagePreview.loadPreview();
this.validation.reset();
if(action){
var link=this.app.dm.get(action.getLinkId()),url=link?link.getURL():'';
this.openInNewTab.setValue(action.getActionType()===web.data.Action.types.open);
if(link instanceof web.data.links.LinkPage){
this.doUpdateUi('oneweb',link.getPageId())
}else if(link instanceof web.data.links.LinkExternal){
if(/^webspace:/.test(url)){
this.doUpdateUi('webspace',url.replace(/^webspace:/,''))
}else if(/^mailto:/.test(url)){
this.doUpdateUi('mail',url.replace(/^mailto:/,''))
}else{
this.doUpdateUi('external',url)
}
}else{
this.doUpdateUi()
}
}else{
this.openInNewTab.setValue(false);
this.doUpdateUi();
var fileChooser=this.corefilecomp.fileChooser;
if(fileChooser.getCurrentPath()){
fileChooser.showPath(fileChooser.getCurrentPath())
}else if(fileChooser.el){
fileChooser.showDefaultPath()
}else{
fileChooser.on('afterrender',function(){
if(!this.doNotCallShowDefaultPath){
fileChooser.showDefaultPath()
}
})
}
}
},
doUpdateUi:function(tab,value){
var fileName=null;
function selectOnewebPage(){
var that=this,node=that.tree.getNodeByPageId(value);
if(node){
that.tree.getSelectionModel().select(node);
that.pagePreview.loadPreview({pageId:value});
fileName=node.text
}
}
this.clearInputFields();
switch(tab){
case'oneweb':
this.linkType=tab;
this.tabs.setActiveTab(0);
if(this.tree.rendered){
selectOnewebPage.call(this)
}else{
this.mon(this.tree,'afterlayout',selectOnewebPage,this,{single:true})
}
break;
case'webspace':
this.linkType=tab;
this.tabs.setActiveTab(1);
this.corefilecomp.fileChooser.showPath(value);
break;
case'external':
this.linkType=tab;
this.tabs.setActiveTab(2);
this.hrefField.setValue(value);
break;
case'mail':
this.linkType=tab;
this.tabs.setActiveTab(3);
this.mailField.setValue(value);
this.openInNewTab.disable();
break;
default:
this.tabs.setActiveTab(0);
this.tree.getSelectionModel().clearSelections();
this.mailField.setValue('');
this.hrefField.setValue(this.initialHref);
this.addLinkButton.disable();
break
}
fileName=fileName||value||'';
this.previousFileName=fileName;
this.showCurrentLink(fileName)
},
clearInputFields:function(){
this.tree.getSelectionModel().clearSelections();
this.mailField.setValue('');
this.hrefField.setValue(this.initialHref)
},
showCurrentLink:function(fileName){
this.removeLinkLabel.setDisabled(!fileName);
this.removeLinkFileName.setText(fileName);
this.removeLinkButton.setVisible(!!fileName);
Ext.QuickTips.unregister(this.removeLinkFileName.getEl());
Ext.QuickTips.register({
target:this.removeLinkFileName.getEl(),
text:fileName
})
},
removeLinkRequest:function(){
this.clearInputFields();
this.removeLinkRequested=true;
this.addLinkButton.enable();
this.showCurrentLink('')
},
removeLinkAbortRequest:function(){
this.removeLinkRequested=false;
this.showCurrentLink(this.previousFileName)
},
onShow:function(){
this.refresh();
this.app.dal.getEmailData(function(opts,success,response){
var emailData=[];
if(success){
emailData=JSON.parse(response.responseText).email||[]
}
this.mailField.store.loadData(emailData)
},this);
this.removeLinkRequested=false;
this.fileUploadStatus.hide()
},
onOK:function(){
var node,value,type,isOpenInNewWindow,selectedTab=this.tabs.tabBox.items.itemAt(this.tabs.activeItem).itemId;
if(this.removeLinkRequested){
this.fireEvent('ok',this,null,null,null);
this.hide();
return
}
switch(selectedTab){
case'oneweb':
node=this.treeSelect.getSelectedNode();
type='linkId';
value=node?node.attributes.id:null;
break;
case'webspace':
type='href';
value=this.selectedFile;
break;
case'mail':
type='href';
value=this.mailField.getValue();
if(value&&value.match(one.validation.emailIdn)){
value='mailto:'+value
}else{
this.mailField.markInvalid();
value=''
}
break;
case'external':
this.okPressedForExternal=true;
if(this.hrefField.isValid()){
type='href';
value=this.hrefField.getValue()
}
break
}
isOpenInNewWindow=this.openInNewTab.getValue()?1:0;
if(type&&value){
this.fireEvent('ok',this,type,isOpenInNewWindow,value);
this.hide()
}else if(selectedTab==='mail'){
Ext.Msg.alert('Invalid email address','The entered email address was invalid. Please enter a valid email address.')
}else{
Ext.MessageBox.show({
title:'Invalid URL',
msg:'Please enter a valid URL.',
cls:'web-modal-warning x-window-dlg',
iconCls:'web-warning-icon',
buttons:{ok:'OK'}
})
}
}
});
web.windows.Link.DUMMY_URL='javascript:void(0);';
web.commands.components.ChangeImageProps=Ext.extend(web.commands.Command,{
constructor:function(config){
this.image=null;
this.json=null;
web.commands.components.ChangeImageProps.superclass.constructor.call(this,config)
},
execute:function(){
var image=this.image,parent=image.getParent(),json=this.json;
this.prevState=image.toJSON();
this.affectsParent=parent instanceof web.data.components.Text&&(json.width||json.height||json.align);
image.set(json);
if(this.affectsParent){
this.fireEvent('update',parent)
}
this.fireEvent('update',image)
},
undo:function(){
var image=this.image,currentState=image.toJSON();
image.set(this.prevState);
this.prevState=currentState;
if(this.affectsParent){
this.fireEvent('update',image.getParent())
}
this.fireEvent('update',image)
}
});
web.commands.components.ApplyLink=Ext.extend(web.commands.Command,{
constructor:function(cfg){
web.commands.components.ApplyLink.superclass.constructor.call(this,cfg)
},
execute:function(){
var target=this.target,link=this.link;
this.prevState=target.getAction();
target.set({action:link});
this.fireEvent('update',target)
},
undo:function(){
var target=this.target,link=this.link,undo=this.isUndo=!this.isUndo;
if(undo){
target.set({action:this.prevState})
}else{
target.set({action:link})
}
this.fireEvent('update',target)
}
});
web.commands.components.RemoveLink=Ext.extend(web.commands.Command,{
constructor:function(cfg){
web.commands.components.RemoveLink.superclass.constructor.call(this,cfg)
},
execute:function(){
var target=this.target;
this.prevState=target.getAction();
target.set({action:null});
this.fireEvent('update',target)
},
undo:function(){
var target=this.target,undo=this.isUndo=!this.isUndo;
if(undo){
target.set({action:this.prevState})
}else{
target.set({action:null})
}
this.fireEvent('update',target)
}
});
web.panels.props.resources.Image=Ext.extend(web.panels.Panel,{
initComponent:function(){
var that=this,lightboxCheckId=Ext.id();
this.cls='web-props-panel vbox';
this.select=new Ext.Button({
iconCls:'icon icon-add-image',
scale:'small',
tooltip:'Replace the selected image with another.',
handler:this.selectAnotherImage,
scope:this
});
this.link=new Ext.Button({
itemId:'link',
tooltip:'Add link.',
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-image-link\' />',
listeners:{
click:this.addLink,
scope:this
}
});
this.unlink=new Ext.Button({
itemId:'unlink',
tooltip:'Remove link.',
cls:'props-panel-remove-button',
listeners:{
click:this.removeLink,
scope:this
}
});
this.imageTitle=new Ext.form.TextField({
style:'min-width: 70px;',
width:60,
listeners:{
valid:function(e){
this.applyChanges({title:this.imageTitle.getValue()})
},
scope:this
}
});
this.imageScaleSetting=new web.ui.ComboBox({
store:new Ext.data.ArrayStore({
idIndex:0,
fields:[
'id',
'name'
],
data:[
[
web.data.components.resources.Image.SCALE_SETTING.CROP,
'Crop'
],
[
web.data.components.resources.Image.SCALE_SETTING.FIT,
'Fit'
],
[
web.data.components.resources.Image.SCALE_SETTING.STRETCH,
'Stretch'
]
]
}),
valueField:'id',
displayField:'name',
mode:'local',
triggerAction:'all',
editable:false,
value:web.data.components.resources.Image.SCALE_SETTING.CROP,
width:100,
listeners:{
select:function(combo){
this.applyChanges({scaleStrategy:combo.getValue()})
},
scope:this
}
});
this.anchorTop=new Ext.ux.form.SpinnerField({
xtype:'spinnerfield',
minValue:0,
maxValue:100,
width:60,
listeners:{
valid:function(e){
this.applyChanges({anchorTop:this.anchorTop.getValue()})
},
spin:function(e){
this.applyChanges({anchorTop:this.anchorTop.getValue()})
},
scope:this
}
});
this.anchorLeft=new Ext.ux.form.SpinnerField({
xtype:'spinnerfield',
minValue:0,
maxValue:100,
width:60,
listeners:{
valid:function(e){
this.applyChanges({anchorLeft:this.anchorLeft.getValue()})
},
spin:function(e){
this.applyChanges({anchorLeft:this.anchorLeft.getValue()})
},
scope:this
}
});
this.lightBox=new Ext.form.Checkbox({
id:lightboxCheckId,
xtype:'checkbox',
boxLabel:'Show large version on click:',
forId:lightboxCheckId,
flex:1,
listeners:{
check:function(checkbox,checked){
this.updateLightBoxValue(checked)
},
scope:this
}
});
this.boxStyleBorder=new web.ui.blockStyle.Border({
app:this.app,
componentLabel:'Border:',
listeners:{
adjust:this.onAdjust,
scope:this
}
});
this.boxStyleCorner=new web.ui.fields.FourSidesField({
componentType:'Corners'+' (px)',
cls:'fourSidesfield',
name:'Corners',
width:275,
labelWidth:99,
mainFieldLeftPadding:102,
tooltip:'Provide different values for corners on each side',
fourFields:{
field1:{
iconCls:'corner-topLeft',
iconTooltip:'Top left corner',
dataKey:'topLeft'
},
field2:{
iconCls:'corner-topRight',
iconTooltip:'Top right corner',
dataKey:'topRight'
},
field3:{
iconCls:'corner-bottomRight',
iconTooltip:'Bottom right corner',
dataKey:'bottomRight'
},
field4:{
iconCls:'corner-bottomLeft',
iconTooltip:'Bottom left corner',
dataKey:'bottomLeft'
}
},
listeners:{
change:this.onChangeCorners,
scope:this
}
});
this.items=[
{
xtype:'container',
region:'center',
cls:'comp-properties flex-properties-container flex',
style:{
padding:'20px 0px 20px 20px',
overflow:'auto'
},
defaults:{
xtype:'container',
layout:'hflex',
width:275
},
flex:true,
items:[
{
style:{paddingBottom:'10px'},
items:[
{
xtype:'label',
text:'Image:',
flex:1
},
{
xtype:'container',
ref:'../../imageName',
style:'white-space:nowrap;max-width:100px;padding-left:5px;',
cls:'web-panels-props-image-imagename'
},
{
xtype:'button',
listeners:{
click:this.openAviary,
scope:this
},
text:'Edit'
},
{
xtype:'spacer',
width:5
},
this.select
]
},
{
style:{paddingBottom:'10px'},
items:[
{
xtype:'label',
text:'Link:',
flex:1
},
{
xtype:'label',
ref:'../../linkName',
text:'None',
width:50,
style:'overflow:hidden;white-space:nowrap;text-overflow:ellipsis;text-align:right;',
isFormField:true
},
{
xtype:'spacer',
width:5
},
this.unlink,
this.link
]
},
{
style:{paddingBottom:'10px'},
items:[
{
xtype:'label',
text:'Scale'+' (%):',
flex:1
},
{
ref:'../../zoomSlider',
xtype:'sliderfield',
width:100,
minValue:50,
maxValue:100,
value:50,
decimalPrecision:false,
tipText:function(thumb){
var n=Math.round(thumb.value);
return String(n)+'%'
},
onChange:function(slider,newValue,oldValue){
this.scope.sliderChangedHandler.call(this.scope,slider,newValue,oldValue)
},
scope:this
}
]
},
{
style:{paddingBottom:'16px'},
items:[this.lightBox]
},
{
layout:'auto',
style:{paddingBottom:'10px'},
items:[this.boxStyleBorder]
},
{
layout:'auto',
items:[this.boxStyleCorner]
},
{
style:{paddingTop:'10px'},
items:[
{
xtype:'label',
text:'Image title (alt):',
style:'min-width: 139px',
flex:1
},
{
xtype:'container',
items:[this.imageTitle]
}
]
},
{
style:{paddingTop:'10px'},
items:[
{
xtype:'label',
text:'Image scale setting:',
style:'min-width: 139px',
flex:1
},
{
xtype:'container',
items:[this.imageScaleSetting]
}
]
},
{
ref:'../positionTopWrap',
style:{paddingBottom:'10px'},
items:[
{
xtype:'label',
text:'Position'+' '+'Top'.toLowerCase()+' (%):',
flex:1
},
this.anchorTop
]
},
{
ref:'../positionLeftWrap',
style:{paddingBottom:'10px'},
items:[
{
xtype:'label',
text:'Position'+' '+'Left'.toLowerCase()+' (%):',
flex:1
},
this.anchorLeft
]
}
]
},
{
xtype:'container',
cls:'props-panel-bottom-container',
layout:'column',
items:[{
xtype:'web-props-mobile',
app:this.app,
cmp:this.component
}]
}
];
web.panels.props.resources.Image.superclass.initComponent.apply(this,arguments);
this.setComponent(this.component);
this.app.on('select',function(part){
if(part instanceof web.data.components.resources.Image){
this.setComponent(part)
}
},this);
this.app.on('deselect',function(part){
if(this.component&&part&&part.id===this.component.id){
this.unsetComponent()
}
},this);
this.app.on('update',function(component,params){
if(component instanceof web.data.components.resources.Image){
if(params&&params.pos){
this.loadFields()
}
}
},this);
this.app.on('dragging',function(component,params){
if(params&&params.pos){
this.anchorTop.suspendEvents();
this.anchorLeft.suspendEvents();
this.anchorTop.setValue(params.pos.top);
this.anchorLeft.setValue(params.pos.left);
this.anchorTop.resumeEvents();
this.anchorLeft.resumeEvents()
}
},this);
web.panels.props.resources.Image.ShowPositionText=function(){
oneJQuery(that.positionTopWrap.el.dom).fadeIn();
oneJQuery(that.positionLeftWrap.el.dom).fadeIn()
};
web.panels.props.resources.Image.HidePositionText=function(){
oneJQuery(that.positionTopWrap.el.dom).fadeOut();
oneJQuery(that.positionLeftWrap.el.dom).fadeOut()
};
setTimeout(function(){
web.panels.props.resources.Image.HidePositionText()
},100)
},
initListeners:function(){
var app=this.app;
app.on('update',function(part){
if(part===this.styleBlock){
this.refresh()
}
},this)
},
setComponent:function(component){
if(component instanceof web.data.components.resources.Image){
this.component=component;
this.styleBlock=component.getStyle();
this.refresh()
}
},
unsetComponent:function(){
this.component=null
},
refresh:function(){
var component=this.component,action,linkName;
if(component){
var asset=component.getAsset();
var imageName=this.imageName;
if(asset&&imageName.rendered){
var htmlEncode=Ext.util.Format.htmlEncode;
var decodedFilename=web.DAL.decodeHref(asset.getFilename());
imageName.update(htmlEncode(decodedFilename));
imageName.el.set({title:decodedFilename})
}
action=component.getAction();
if(action){
if(action.linkId){
linkName=this.app.dm.get(action.getLinkId())?this.app.dm.get(action.getLinkId()).name:null
}else if(action.link&&action.link.name===web.windows.Link.DUMMY_URL){
linkName=''
}else{
linkName=action.link?action.link.getURL():null
}
if(linkName){
this.linkName.setText(web.utils.String.formatLink(linkName));
this.unlink.enable()
}else{
this.linkName.setText('Broken link');
this.unlink.enable()
}
}else{
this.linkName.setText('None');
this.unlink.disable()
}
this.updateBoxStyle();
this.loadFields()
}
},
loadFields:function(){
var formFields=[
this.zoomSlider,
this.zoomSlider.slider,
this.lightBox,
this.imageTitle,
this.anchorLeft,
this.anchorTop,
this.imageScaleSetting
];
if(this.component instanceof web.data.components.resources.Image){
formFields.forEach(function(f){
f.suspendEvents()
});
this.lightBox.setValue(this.component.lightBoxEnabled);
this.imageTitle.setValue(this.component.title);
this.imageScaleSetting.setValue(this.component.scaleStrategy);
this.anchorLeft.setValue(this.component.anchorLeft);
this.anchorTop.setValue(this.component.anchorTop);
if(this.component.scaleStrategyObj.features.zooming){
this.zoomSlider.enable();
this.zoomSlider.setMinValue(100*this.component.getMinZoom());
this.zoomSlider.setMaxValue(Number(100*this.component.getMaxZoom()).toFixed(2)-0);
this.zoomSlider.setValue(100*this.component.getScale())
}else{
this.zoomSlider.disable()
}
if(this.component.lightBoxEnabled){
this.link.disable()
}else{
this.link.enable()
}
formFields.forEach(function(f){
f.resumeEvents()
})
}
},
applyChanges:function(changes){
var command,newJSON;
if(this.component){
newJSON=Ext.apply(this.component.toJSON(),changes);
if(Ext.encode(newJSON)===Ext.encode(this.component.toJSON())){
return
}
command=new web.commands.components.ChangeImageProps({
image:this.component,
json:changes
});
this.app.invoker.execute(command)
}
},
sliderChangedHandler:function(slider,newValue,thumb){
var that=this,scope=that,scale=slider.getValue()/100;
this.resizePreview(scale);
this.app.fireEvent('dragging',this.component,{scale:scale});
if(this.timeout){
clearTimeout(this.timeout)
}
this.timeout=setTimeout(function(){
scope.applyChanges({scale:scope.zoomSlider.getValue()/100});
scope.timeout=null;
setTimeout(function(){
scope.app.fireEvent('update',scope.component)
},100)
},512)
},
resizePreview:function(scale){
var comp=this.component,x,y,w,h,el=Ext.get('image-'+comp.getId());
el=el&&el.dom;
if(el){
x=comp.cropLeft;
y=comp.cropTop;
w=scale*comp.asset.width;
h=scale*comp.asset.height;
if(comp.rotation%180===90){
if(-x+h<comp.getInnerWidth()){
x+=h-x-comp.getInnerWidth()
}
if(-y+w<comp.getInnerHeight()){
y+=w-y-comp.getInnerHeight()
}
}else{
if(-x+w<comp.getInnerWidth()){
x+=w-x-comp.getInnerWidth()
}
if(-y+h<comp.getInnerHeight()){
y+=h-y-comp.getInnerHeight()
}
}
if(comp.rotation%180===90){
y+=h/2-w/2;
x+=w/2-h/2
}
el.style.marginTop=String(-y)+'px';
el.style.marginLeft=String(-x)+'px';
el.style.width=w+'px';
el.style.height=h+'px'
}
return el
},
selectAnotherImage:function(b,e){
this.app.windows.show({
type:'web.windows.Image',
app:this.app,
listeners:{
ok:function(win,selection){
var comp=this.component,asset=selection.images[0];
this.applyChanges({
asset:asset,
rotation:0,
scale:Math.max(comp.getInnerWidth()/asset.width,comp.getInnerHeight()/asset.height)
})
},
scope:this
},
values:{paths:[this.component.getAsset().getURL()]}
})
},
openAviary:function(){
this.app.windows.show({
type:'web.windows.AviaryImageEditor',
app:this.app,
listeners:{
imagesaved:function(asset){
var comp=this.component;
this.applyChanges({
asset:asset,
rotation:0,
scale:Math.max(comp.getInnerWidth()/asset.width,comp.getInnerHeight()/asset.height)
})
},
scope:this
},
values:{asset:this.component.getAsset()}
})
},
addLink:function(){
this.app.windows.show({
type:'web.windows.Link',
values:this.component.getAction(),
okFn:function(wn,linkType,actionType,value){
var link,action;
if(linkType===null){
this.removeLink();
return
}else if(linkType==='linkId'){
link=this.app.dm.get(value);
action={linkId:link.getId()}
}else if(linkType==='href'){
action={
link:{
type:'web.data.links.LinkExternal',
name:value,
url:value
}
}
}
action.actionType=actionType;
this.app.invoker.execute(new web.commands.components.ApplyLink({
target:this.component,
link:action
}))
},
scope:this
})
},
removeLink:function(){
var app=this.app;
this.linkName.setText('None');
app.invoker.execute(new web.commands.components.RemoveLink({target:this.component}))
},
updateLightBoxValue:function(enabled){
if(enabled){
this.link.disable();
this.unlink.disable()
}else{
this.link.enable();
this.unlink.enable()
}
this.app.invoker.execute(new web.commands.components.ChangeImageProps({
image:this.component,
json:{lightBoxEnabled:enabled}
}))
},
onChangeCorners:function(frameField,corners){
var that=this;
that.onAdjust({border:{corners:corners}})
},
onAdjust:function(){
var interval,oldStyle;
return function(opts){
var that=this;
if(oldStyle===undefined){
oldStyle={border:this.styleBlock.getApplied('border')}
}
this.styleBlock.set(opts);
this.fireEvent('adjust',this.styleBlock);
if(interval){
window.clearTimeout(interval)
}
interval=window.setTimeout(function(){
that.styleBlock.set(oldStyle);
var command=new web.commands.components.blocks.EditStyle({
style:that.styleBlock,
opts:opts
});
that.app.invoker.execute(command);
oldStyle=undefined
},500)
}
}(),
updateBoxStyle:function(){
var borderStyle=this.styleBlock.getApplied('border')||null,cornersStyle=borderStyle?borderStyle.corners:null;
Ext.apply(borderStyle,{maxValue:web.utils.BorderWidth.getMaxWidth(this.component.getWidth(),this.component.getHeight())});
this.boxStyleBorder.setValue(borderStyle);
this.boxStyleCorner.setValue(cornersStyle)
}
});
Ext.ns('web.commands.menus');
web.commands.menus.Update=Ext.extend(web.commands.Command,{
component:null,
props:null,
execute:function(){
var props=this.previous||this.props;
this.previous=this.component.toJSON();
this.component.set(props);
this.fireEvent('update',this.component)
},
undo:function(){
this.execute()
}
});
Ext.ns('web.controllers.menus');
web.controllers.menus.MenuStyle=function(config){
Ext.apply(this,config)
};
web.controllers.menus.MenuStyle.prototype={
constructor:web.controllers.menus.MenuStyle,
app:null,
getMenuStyles:function(){
return this.app.getSelected('stylesheet').getStylesByType('web.data.styles.StyleMenu')
},
getMenuStylesDataStore:function(){
var menuFormat='Menu Style',data;
data=this.getMenuStyles().map(function(style){
return[
style.id,
menuFormat+' '+style.getRef().replace(/^menu\./,'')
]
});
return new Ext.data.ArrayStore({
fields:[
'id',
'text'
],
data:data
})
}
};
Ext.ns('web.panels.props.globalstyles.buttons');
web.panels.props.globalstyles.buttons.Preview=Ext.extend(Ext.Component,{
initComponent:function(){
this.autoEl={
tag:'div',
style:'display: flex;align-items: center;justify-content: center;',
children:[
{tag:'style'},
{
tag:'input',
type:'submit',
style:{'vertical-align':'middle'},
value:'Button'
}
]
};
web.panels.props.globalstyles.buttons.Preview.superclass.initComponent.call(this)
},
update:function(style){
if(!this.rendered){
this.on('afterrender',function(){
this.update(style)
},this,{single:true});
return
}
var currentClsPfx=style.clsPfx,styleEl=this.el.child('style'),css,cls='previewbutton previewbutton',doc;
style.set({clsPfx:'preview-'});
doc=new web.Document({domain:this.domain});
css=style.toCSS(doc);
cls+=style.ref?style.ref.split('.')[1]:'';
this.el.child('input').addClass(cls);
styleEl.dom.innerHTML=css;
style.set({clsPfx:currentClsPfx})
}
});
Ext.reg('web-panels-props-globalstyles-buttons-preview',web.panels.props.globalstyles.buttons.Preview);
/*! https://github.com/slindberg/jquery-scrollparent/blob/master/LICENSE */
(function($){
$.fn.scrollParent=function(){
var overflowRegex=/(auto|scroll)/,position=this.css('position'),excludeStaticParent=position==='absolute',scrollParent=this.parents().filter(function(){
var parent=$(this);
if(excludeStaticParent&&parent.css('position')==='static'){
return false
}
return overflowRegex.test(parent.css('overflow')+parent.css('overflow-y')+parent.css('overflow-x'))
}).eq(0);
return position==='fixed'||!scrollParent.length?$(this[0].ownerDocument||document):scrollParent
}
}(oneJQuery));
web.ui.ComboBox=Ext.extend(Ext.form.ComboBox,{
constructor:function(cfg){
cfg.shadow=false;
if(cfg.number||cfg.maxNumber||cfg.minNumber){
cfg.maskRe=/^[0-9]*$/
}
if(cfg.maxNumber&&Ext.isNumber(cfg.maxNumber)&&cfg.maxNumber>0||cfg.minNumber&&Ext.isNumber(cfg.minNumber)&&cfg.minNumber>0){
if(cfg.validator){
this.validatorFn=cfg.validator
}
cfg.validator=this.validator;
if(cfg.listeners.keyup){
this.keyupFn=cfg.listeners.keyup
}
cfg.listeners.keyup=this.keyup
}
web.ui.ComboBox.superclass.constructor.apply(this,arguments)
},
validator:function(value){
if(this.maxNumber&&value>this.maxNumber){
if(this.tip){
this.tip.disable()
}
return'The maximum value for this field is '+this.maxNumber
}
if(this.minNumber&&value<this.minNumber){
if(this.tip){
this.tip.disable()
}
return'The minimum value for this field is '+this.minNumber
}
if(this.tip){
this.tip.enable()
}
if(this.validatorFn){
return this.validatorFn(value)
}
return true
},
keyup:function(combo,e){
var num=parseInt(combo.getRawValue(),10);
if(Ext.isNumber(num)&&combo.keyupFn&&combo.isValid()){
combo.keyupFn.call(this,combo,e)
}
},
onViewClick:function(doFocus){
var index=this.view.getSelectedIndexes()[0],s=this.store,r=s.getAt(index);
if(doFocus!==false){
this.el.focus()
}
if(r){
this.onSelect(r,index)
}else{
this.collapse()
}
this.resetCaret()
},
resetCaret:function(){
if(!this.el.dom){
return
}
var el=this.el.dom;
if(el.createTextRange){
var range=el.createTextRange();
range.collapse(true);
range.moveEnd('character',0);
range.moveStart('character',0);
range.select()
}else{
if(el.selectionStart){
el.focus();
el.setSelectionRange(0,0)
}
}
},
onTriggerClick:function(){
var triggerClick=function(){
if(this.readOnly||this.disabled){
return
}
if(this.isExpanded()){
this.collapse();
this.el.focus()
}else{
this.onFocus({});
if(this.triggerAction==='all'){
this.doQuery(this.allQuery,true)
}else{
this.doQuery(this.getRawValue())
}
this.el.focus()
}
};
var that=this,$scrollParent=oneJQuery(that.el.dom).scrollParent(),oldPosition=that.getPosition(),oldScrollTop=$scrollParent.scrollTop(),oldScrollHeight=$scrollParent.get(0).scrollHeight;
setTimeout(function(){
var newPosition=that.getPosition(),newScrollTop=$scrollParent.scrollTop(),newScrollHeight=$scrollParent.get(0).scrollHeight;
if(newPosition[1]===oldPosition[1]&&newScrollTop===oldScrollTop&&oldScrollHeight===newScrollHeight){
triggerClick.call(that)
}else{
setTimeout(triggerClick.bind(that),200)
}
},100)
}
});
Ext.reg('web-combobox',web.ui.ComboBox);
web.ui.ComboBoxFonts=Ext.extend(web.ui.ComboBox,{
initComponent:function(config){
var fonts=this.loadFontList();
Ext.apply(this,{
itemId:'font',
tpl:'<tpl for="."><div class="x-combo-list-item" '+'style="font-family:{css}!important;">{name}</div></tpl>',
store:new Ext.data.ArrayStore({
idIndex:0,
fields:[
'id',
'css',
'name'
],
data:fonts
}),
valueField:'id',
displayField:'name',
mode:'local',
triggerAction:'all',
editable:false,
value:this.value,
width:this.width?this.width-23:120,
resetStyle:function(){
var el=this.el,width,css='',selected;
if(el){
selected=this.getValue();
if(typeof selected==='number'){
css=web.data.styles.Font.cssValues[selected]
}else if(/^google:\/\//.test(selected)){
css=selected.replace(/^google:\/\//,'');
el.dom.value=css
}
width=el.dom.style.width;
el.dom.setAttribute('style','font-family:'+css+'!important;');
el.dom.style.width=width
}
},
listeners:{
render:function(combo){
combo.resetStyle()
},
scope:this
}
});
web.ui.ComboBoxFonts.superclass.initComponent.apply(this,arguments);
this.mon(this.app.googleWebFonts,'update',function(newFont){
var fonts=this.loadFontList(),store=new Ext.data.ArrayStore({
idIndex:0,
fields:[
'id',
'css',
'name'
],
data:fonts
});
this.bindStore(store)
},this)
},
setValue:function(value){
var stylesheet,style,args=arguments;
if(!value&&value!==0){
stylesheet=this.app.getSelected('stylesheet');
style=stylesheet?stylesheet.getStyleByRef('text','StyleText'):null;
args[0]=style&&style.font?style.font.fontType:0
}
web.ui.ComboBoxFonts.superclass.setValue.apply(this,args);
this.resetStyle()
},
loadFontList:function(){
var n,id,css,display,fonts=[],fontTypes=web.data.styles.Font.types;
for(n in fontTypes){
if(fontTypes.hasOwnProperty(n)){
id=fontTypes[n];
css=web.data.styles.Font.cssValues[id];
fonts.push([
id,
css.replace(/"/g,'\''),
web.data.styles.Font.displayNameByType[n]
])
}
}
if(this.app.site.fonts){
for(n in this.app.site.fonts){
if(this.app.site.fonts.hasOwnProperty(n)){
id=this.app.site.fonts[n];
display=id.replace(/^google:\/\//,'');
css='\''+display+'\', cursive';
fonts.push([
id,
css.replace(/"/g,'\''),
display
])
}
}
}
return fonts.sort(function(a,b){
if(a[2]>b[2]){
return 1
}
if(a[2]<b[2]){
return-1
}
return 0
})
}
});
Ext.reg('web-combobox-fonts',web.ui.ComboBoxFonts);
web.panels.props.globalstyles.buttons.CommonStyle=Ext.extend(Ext.Container,{
fontId:null,
fontSize:null,
bold:null,
italic:null,
corners:null,
borders:null,
initComponent:function(){
this.layout='hauto';
this.layoutConfig={padding:'0 20 0 20'};
this.borderField=new web.ui.fields.FourSidesField({
componentType:'Border',
name:'spacingStyle',
width:255,
labelWidth:50,
mainFieldLeftPadding:20,
maxValue:50,
cls:'fourSidesfield boxStyle-border-width',
tooltip:'Provide different values for borders on each side',
fourFields:{
field1:{
iconCls:'spacing-top',
iconTooltip:'Top border',
dataKey:'top'
},
field2:{
iconCls:'spacing-right',
iconTooltip:'Right border',
dataKey:'right'
},
field3:{
iconCls:'spacing-bottom',
iconTooltip:'Bottom border',
dataKey:'bottom'
},
field4:{
iconCls:'spacing-left',
iconTooltip:'Left border',
dataKey:'left'
}
},
listeners:{
change:this.onChangeBorderWidth,
scope:this
}
});
this.borderField.setValue(this.borders);
this.fontSizeCombo=new web.ui.ComboBox({
xtype:'combo',
itemId:'size',
store:[
9,
10,
11,
12,
13,
14,
15,
16,
18,
20,
22,
24,
26,
28,
32,
36,
40,
44,
48,
54,
60,
66,
72,
80,
88,
96
],
triggerAction:'all',
value:this.fontSize,
width:50,
maxNumber:999,
minNumber:9,
listeners:{
select:this.onSelectSize,
render:function(combo){
combo.tip=new Ext.ToolTip({
target:combo.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:'Font size'
}
})
},
keyup:function(combo,e){
if(e.getCharCode()===13){
this.onSelectSize(combo)
}
},
scope:this
}
});
this.items=[{
xtype:'container',
items:[
{
xtype:'label',
text:this.title,
style:{
padding:'0 0 0 0',
display:'block'
}
},
{
xtype:'container',
style:{width:'405px'},
cls:'globalstyles-groupbox',
items:[
{
xtype:'container',
layout:'hflex',
items:[
{
xtype:'web-combobox-fonts',
ref:'../../../fontIdCombo',
value:this.fontId,
width:140,
app:this.app,
listeners:{
select:function(combo,record,index){
combo.resetStyle();
this.fontId=combo.getValue();
this.fireEvent('changed',this,'fontid',combo.getValue())
},
render:function(combo){
combo.tip=new Ext.ToolTip({
target:combo.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:'Font family.'
}
})
},
scope:this
}
},
{
itemId:'addFont',
xtype:'button',
text:'+',
tooltip:'Add font from Google Web Fonts.',
scale:'small',
handler:function(){
this.popupGoogleWebFonts()
},
scope:this
},
{xtype:'flexspacer'},
this.fontSizeCombo,
{xtype:'flexspacer'},
{
xtype:'container',
cls:'web-panel-button-group-new',
style:'white-space:nowrap',
items:[
{
xtype:'button',
ref:'../../../../boldButton',
iconCls:'icon icon-rte-bold',
tooltip:'Bold.',
enableToggle:true,
pressed:this.bold,
handler:function(b,e){
this.bold=b.pressed;
this.fireEvent('changed',this,'bold',b.pressed)
},
scope:this
},
{
xtype:'button',
ref:'../../../../italicButton',
iconCls:'icon icon-rte-italic',
tooltip:'Italic.',
enableToggle:true,
pressed:this.italic,
handler:function(b,e){
this.italic=b.pressed;
this.fireEvent('changed',this,'italic',b.pressed)
},
scope:this
}
]
},
{xtype:'flexspacer'},
{
xtype:'button',
ref:'../../cornersWidget',
width:80,
text:'Corners',
plugins:new web.ui.plugins.WindowButton({
type:'web.windows.blockProps.Corners',
app:this.app,
listeners:{
adjust:function(change){
this.fireEvent('changed',this,'corners',change)
},
scope:this
}
}),
listeners:{
winshow:function(button,win){
win.setValues(this.corners)
},
scope:this
}
}
]
},
{
xtype:'spacer',
width:5,
height:5
},
{
xtype:'container',
layout:'hauto',
layoutConfig:{padding:'5 0 0 0'},
items:[this.borderField]
}
]
}
]
}];
web.panels.props.globalstyles.buttons.CommonStyle.superclass.initComponent.apply(this,arguments);
this.addEvents('changed')
},
onSelectSize:function(combo){
this.fontSize=parseInt(combo.getRawValue(),10);
this.fireEvent('changed',this,'fontsize',this.fontSize)
},
setValues:function(values){
Ext.apply(this,values);
this.refresh()
},
refresh:function(){
this.fontIdCombo.setValue(this.fontId);
this.fontSizeCombo.setValue(this.fontSize);
this.boldButton.toggle(this.bold);
this.italicButton.toggle(this.italic);
this.borderField.setValue(this.borders)
},
popupGoogleWebFonts:function(){
this.app.windows.show({
type:'web.windows.GoogleWebFonts',
values:{
myOkHandler:function(selectedFont){
if(selectedFont!==null){
this.fontIdCombo.setValue(selectedFont);
this.fireEvent('changed',this,'fontid',this.fontIdCombo.getValue());
this.fontIdCombo.resetStyle()
}
},
scope:this
}
})
},
onChangeBorderWidth:function(field,value){
this.fireEvent('changed',this,'border-width',value)
}
});
Ext.reg('web-globalstyles-buttons-commonstyle',web.panels.props.globalstyles.buttons.CommonStyle);
web.ui.fields.FrameField=Ext.extend(Ext.Container,{
xtype:'web-ui-fields-framefield',
constructor:function(cfg){
this.maxValue=null;
this.value={
top:0,
right:0,
bottom:0,
left:0
};
web.ui.fields.FrameField.superclass.constructor.call(this,cfg)
},
initComponent:function(){
this.defaults={style:{margin:'4px'}};
Ext.apply(this,{
border:false,
layout:'table',
layoutConfig:{columns:5},
width:'auto',
height:'auto',
items:[
{
colspan:5,
xtype:'label',
text:'Top',
width:'auto',
style:{
display:'block',
textAlign:'center'
}
},
{html:''},
{html:''},
{
xtype:'container',
items:[{
ref:'../topField',
xtype:'spinnerfield',
name:'top',
width:50,
minValue:0,
style:{textAlign:'center'},
listeners:{
render:this.onFieldRender,
focus:this.onFieldFocus,
scope:this
}
}]
},
{html:''},
{html:''},
{
xtype:'label',
text:'Left',
width:'auto'
},
{
xtype:'container',
items:[{
ref:'../leftField',
xtype:'spinnerfield',
name:'left',
width:50,
minValue:0,
style:{textAlign:'center'},
listeners:{
render:this.onFieldRender,
focus:this.onFieldFocus,
scope:this
}
}]
},
{
xtype:'container',
style:{textAlign:'center'},
items:[{
ref:'../lockButton',
xtype:'button',
iconCls:'lock-icon',
width:31,
enableToggle:true,
listeners:{
toggle:this.onLockToggle,
scope:this
}
}]
},
{
xtype:'container',
items:[{
ref:'../rightField',
xtype:'spinnerfield',
name:'right',
width:50,
minValue:0,
style:{textAlign:'center'},
listeners:{
render:this.onFieldRender,
focus:this.onFieldFocus,
scope:this
}
}]
},
{
xtype:'label',
text:'Right'
},
{html:''},
{html:''},
{
xtype:'container',
items:[{
ref:'../bottomField',
xtype:'spinnerfield',
name:'bottom',
width:50,
minValue:0,
style:{textAlign:'center'},
listeners:{
render:this.onFieldRender,
focus:this.onFieldFocus,
scope:this
}
}]
},
{html:''},
{html:''},
{
colspan:5,
xtype:'label',
text:'Bottom',
width:'auto',
style:{
display:'block',
textAlign:'center'
}
}
]
});
this.addEvents('change','togglelock');
web.ui.fields.FrameField.superclass.initComponent.apply(this,arguments)
},
disable:function(){
if(this.rendered){
this.items.each(function(item){
item.disable()
},this)
}
this.disabled=true;
this.fireEvent('disable',this)
},
enable:function(){
if(this.rendered){
this.items.each(function(item){
item.enable()
},this)
}
this.disabled=false;
this.fireEvent('enable',this)
},
setValue:function(values){
var opts;
if(Ext.isArray(values)){
opts={
top:values[0],
right:values[1],
bottom:values[2],
left:values[3]
}
}else{
opts=values
}
this.value=opts;
this.topField.setRawValue(opts.top);
this.rightField.setRawValue(opts.right);
this.bottomField.setRawValue(opts.bottom);
this.leftField.setRawValue(opts.left);
if(opts.top===opts.right&&opts.top===opts.bottom&&opts.top===opts.left){
this.lockButton.toggle(true,false)
}else{
this.lockButton.toggle(false,false)
}
},
getValue:function(){
return{
top:this.topField.getValue(),
right:this.rightField.getValue(),
bottom:this.bottomField.getValue(),
left:this.leftField.getValue()
}
},
isLocked:function(){
return this.lockButton.pressed
},
isValid:function(){
return this.topField.isValid()&&this.bottomField.isValid()&&this.leftField.isValid()&&this.rightField.isValid()
},
onFieldRender:function(field){
var value=this.value;
field.mon(field.el,'keyup',function(el){
this.onFieldValidate(field)
},this);
field.on('spin',function(){
this.onFieldValidate(field)
},this);
this.topField.setRawValue(this.topField.getValue()||value.top);
this.rightField.setRawValue(this.rightField.getValue()||value.right);
this.bottomField.setRawValue(this.bottomField.getValue()||value.bottom);
this.leftField.setRawValue(this.leftField.getValue()||value.left)
},
onFieldFocus:function(field){
this.lastFocusedField=field
},
onFieldValidate:function(){
var interval;
return function(field){
var that=this;
if(interval){
window.clearTimeout(interval);
interval=null
}
interval=window.setTimeout(function(){
var value=field.getValue();
if(that.lockButton.pressed){
that.topField.setRawValue(value);
that.rightField.setRawValue(value);
that.bottomField.setRawValue(value);
that.leftField.setRawValue(value)
}
that.fireEvent('change',that,that.getValue(),that.lockButton.pressed?'all':field.name)
},250)
}
}(),
onLockToggle:function(button,pressed){
var value=this.lastFocusedField?this.lastFocusedField.getValue():this.topField.getValue();
if(pressed){
if(value!==this.topField.getValue()&&value!==this.rightField.getValue()&&value!==this.bottomField.getValue()&&value!==this.leftField.getValue()){
this.topField.setRawValue(value);
this.rightField.setRawValue(value);
this.bottomField.setRawValue(value);
this.leftField.setRawValue(value);
this.onFieldValidate(this.topField)
}
}
this.fireEvent('togglelock',this,pressed)
},
setMaxLimits:function(values){
if(values.top){
this.topField.maxValue=values.top
}
if(values.left){
this.leftField.maxValue=values.left
}
if(values.bottom){
this.bottomField.maxValue=values.bottom
}
if(values.right){
this.rightField.maxValue=values.right
}
}
});
Ext.ComponentMgr.registerType('web-ui-fields-framefield',web.ui.fields.FrameField);
web.windows.blockProps.Border=Ext.extend(web.windows.Window,{
initComponent:function(){
this.type='web.windows.blockProps.Border';
this.title='Border';
this.resizable=false;
this.styleField=new Ext.form.ComboBox({
xtype:'combo',
disabled:true,
name:'style',
fieldLabel:'Style',
mode:'local',
width:157,
editable:false,
triggerAction:'all',
forceSelection:true,
store:new Ext.data.ArrayStore({
fields:[
'style',
'text'
],
data:[
[
'solid',
'Solid'
],
[
'dashed',
'Dashed'
],
[
'dotted',
'Dotted'
]
]
}),
valueField:'style',
displayField:'text',
getListParent:function(){
return this.el.up('.x-menu')
},
listeners:{
select:this.onChangeStyle,
scope:this
}
});
this.items=[
{
ref:'borderCheckbox',
xtype:'checkbox',
boxLabel:'Border',
ctCls:'styleblock-checkbox',
hideLabel:true,
listeners:{
check:this.onBorderCheck,
scope:this
}
},
{
ref:'borderCheckboxSpacer',
xtype:'spacer',
height:1,
cls:'one-separator',
style:{margin:'20px 0'}
},
{
layout:'column',
border:false,
style:{paddingTop:'3px'},
ref:'firstColumnContainer',
items:[
{
layout:'form',
width:265,
border:false,
labelWidth:50,
items:[
{
ref:'../../styleContainer',
xtype:'container',
layout:'form',
hidden:true
},
{
name:'color',
ref:'../../bgcolor',
xtype:'web-colorpanel',
showTransparency:true,
disabled:true,
listeners:{
change:function(context,color){
this.setBorderColor(color)
},
scope:this
}
}
]
},
{
ref:'../colorPanelSpacer',
xtype:'container',
width:1,
height:150,
cls:'one-separator',
style:{margin:'0 20px'}
},
{
ref:'../styleWidthContainer',
layout:'form',
labelWidth:90,
width:400,
border:false,
items:[{
ref:'../../widthField',
xtype:'web-ui-fields-framefield',
name:'width',
fieldLabel:'Width',
maxValue:50,
listeners:{
change:this.onChangeWidth,
scope:this
}
}]
}
]
}
];
web.windows.blockProps.Border.superclass.initComponent.apply(this,arguments);
this.borderFields=[
this.bgcolor,
this.styleField,
this.widthField
]
},
setValues:function(values){
var style=Ext.apply({},values),totalBorderWidth;
var mode=style.mode;
if(mode){
if(mode==='color-and-style'){
this.borderCheckbox.hide();
this.borderCheckboxSpacer.hide();
this.widthField.setWidth(0);
this.widthField.hide();
this.colorPanelSpacer.hide();
if(!this.styleContainer.getComponent(this.styleField)){
this.styleContainer.add(this.styleField)
}
this.styleContainer.show();
this.setWidth(400);
this.firstColumnContainer.container.setStyle({paddingLeft:'109px'})
}
}else{
if(!this.styleWidthContainer.getComponent(this.styleField)){
this.styleWidthContainer.insert(0,this.styleField)
}
this.firstColumnContainer.container.setStyle({paddingLeft:'28px'});
this.colorPanelSpacer.show();
this.styleContainer.hide();
if(style.fixedWidth){
style.width=[
style.fixedWidth,
style.fixedWidth,
style.fixedWidth,
style.fixedWidth
];
this.borderCheckbox.hide();
this.borderCheckboxSpacer.hide();
this.widthField.hide();
this.styleWidthContainer.setWidth(254);
this.setWidth(660)
}else{
this.borderCheckbox.show();
this.borderCheckboxSpacer.show();
this.styleWidthContainer.show();
this.colorPanelSpacer.show();
this.widthField.show();
this.styleWidthContainer.setWidth(400);
this.setWidth(765)
}
}
this.doLayout();
if(values){
if(style.width){
this.initialStyle=style;
totalBorderWidth=style.width[0]+style.width[1]+style.width[2]+style.width[3];
if(totalBorderWidth>0){
this.borderCheckbox.setValue(true);
this.setBorderColor(style.color&&style.color[0]?style.color[0]:'#fff',true);
this.styleField.suspendEvents();
this.styleField.setValue(style.style[0]);
this.styleField.resumeEvents();
this.widthField.setValue({
top:style.width[0],
right:style.width[1],
bottom:style.width[2],
left:style.width[3]
})
}else{
this.clearForm()
}
}else{
this.clearForm()
}
}else{
this.clearForm()
}
},
updateColorField:function(colorField,color){
var el=colorField.el;
if(color&&el){
el.dom.style.background=color.css();
el.dom.style.color=color.value()>0.5?'#000':'#FFF'
}
},
setBorderColor:function(color,suppress){
var that=this,border;
if(this.bgcolor.disabled&&!suppress){
return
}
color=Ext.isArray(color)||Ext.isString(color)?one.color(color):color;
border=Ext.apply(this.initialStyle,{
color:[
color,
color,
color,
color
]
});
this.bgcolor.setColor(color,'both',true);
this.bgcolor.updateTransparencySlider(color);
this.changeColorDelay=window.setTimeout(function(){
if(!suppress){
that.fireEvent('adjust',{border:border})
}
},300)
},
onBorderCheck:function(checkbox,checked){
var border;
if(checked){
this.borderFields.forEach(function(field){
field.enable()
});
border=this.initialStyle
}else{
this.borderFields.forEach(function(field){
field.disable()
});
border=Ext.applyIf({
width:[
0,
0,
0,
0
]
},this.initialStyle)
}
this.fireEvent('adjust',{border:border})
},
onChangeStyle:function(combo,styleRecord){
var style=styleRecord.data.style,border=Ext.apply(this.initialStyle,{
style:[
style,
style,
style,
style
]
});
this.fireEvent('adjust',{border:border})
},
onChangeWidth:function(field,width){
var border=Ext.apply(this.initialStyle,{
width:[
width.top,
width.right,
width.bottom,
width.left
]
});
this.fireEvent('adjust',{border:border})
},
clearForm:function(){
var white=new one.color.RGB(1,1,1);
this.initialStyle={
color:[
white,
white,
white,
white
],
style:[
'solid',
'solid',
'solid',
'solid'
],
width:[
1,
1,
1,
1
]
};
this.borderCheckbox.setValue(false);
this.setBorderColor(this.initialStyle.color[0],true);
this.styleField.suspendEvents();
this.styleField.setValue(this.initialStyle.style[0]);
this.styleField.resumeEvents();
this.widthField.setValue(this.initialStyle.width)
}
});
web.panels.props.globalstyles.buttons.OverrideStyle=Ext.extend(Ext.Container,{
color:null,
background:null,
border:null,
initComponent:function(config){
if(!this.items){
this.initOverrideStyle()
}
web.panels.props.globalstyles.buttons.OverrideStyle.superclass.initComponent.apply(this,arguments);
this.addEvents('changed')
},
initOverrideStyle:function(config){
this.layout='hauto';
this.layoutConfig={align:'stretchmax'};
this.foreColorButton=new Ext.Button({
iconCls:'icon icon-rte-forecolor',
scale:'small',
tooltip:'Text color.',
color:this.color,
listeners:{
winshow:function(btn,win){
var picker=win.picker;
picker.suspendEvents();
picker.setColor(btn.color,true,true);
picker.resumeEvents()
},
scope:this
},
plugins:[
new web.ui.plugins.ColorButton,
new web.ui.plugins.WindowButton({
title:'Text Color',
width:285,
cls:'color-panel-window',
items:{
ref:'picker',
xtype:'web-colorpanel',
listeners:{
change:function(btn,color){
this.foreColorButton.setColor(color);
this.fireEvent('changed',this,'foreColor',color)
},
scope:this
}
}
})
]
});
this.textButtons={
xtype:'container',
layout:'hauto',
width:40,
height:22,
cls:'button-group',
items:[this.foreColorButton]
};
this.backgroundButton=new Ext.Button({
xtype:'button',
text:'Background',
plugins:new web.ui.plugins.WindowButton({
type:'web.windows.blockProps.Background',
app:this.app,
listeners:{
adjust:function(change){
this.fireEvent('changed',this,'background',change)
},
scope:this
}
}),
listeners:{
winshow:function(button,win){
win.setValues(this.background)
},
scope:this
}
});
this.items=[
{
xtype:'container',
width:35
},
{
xtype:'container',
layout:'vbox',
width:25,
height:120,
items:[
{
xtype:'container',
width:25,
height:80,
style:'border-left: 1px solid #CED7BD; border-bottom: 1px solid #CED7BD; '
},
{
xtype:'container',
width:25,
height:40,
style:this.last?'':'border-left: 1px solid #CED7BD; '
}
]
},
{
xtype:'container',
layout:'vbox',
height:120,
width:300,
items:[
{
xtype:'spacer',
height:5
},
{
xtype:'label',
text:this.title
},
{
xtype:'label',
text:this.description,
style:'color: #888; font-size: 10px; white-space: normal; '
},
{
xtype:'spacer',
height:5
},
{
xtype:'container',
cls:'globalstyles-groupbox',
style:'white-space:nowrap;',
width:300,
height:68,
items:[
{
xtype:'spacer',
height:5
},
{
xtype:'container',
layout:'hauto',
items:[
this.textButtons,
{
xtype:'spacer',
width:5
},
this.backgroundButton,
{
xtype:'spacer',
width:5
},
{
xtype:'button',
ref:'../../../borderWidget',
text:'Border style',
plugins:new web.ui.plugins.WindowButton({
type:'web.windows.blockProps.Border',
app:this.app,
listeners:{
adjust:function(cfg){
this.fireEvent('changed',this,'border',cfg)
},
scope:this
}
}),
styleType:'border',
listeners:{
winshow:function(button,win){
var c=this.border.color,w=this.border.width,s=this.border.style,dash={
mode:'color-and-style',
color:[
c.top,
c.right,
c.bottom,
c.left
],
style:[
s.top,
s.right,
s.bottom,
s.left
],
width:[
w.top,
w.right,
w.bottom,
w.left
]
};
win.setValues(dash)
},
scope:this
}
}
]
}
]
}
]
}
]
},
setValues:function(values){
Ext.apply(this,values);
this.refresh()
},
refresh:function(){
this.foreColorButton.color=this.color;
this.foreColorButton.setColor(this.color)
}
});
Ext.reg('web-globalstyles-buttons-overridestyle',web.panels.props.globalstyles.buttons.OverrideStyle);
web.panels.props.globalstyles.buttons.Panel=Ext.extend(Ext.Container,{
initComponent:function(){
var app=this.app;
this.stylesheet=app.getSelected('stylesheet');
this.buttonStyleId=this.buttonStyleId||this.stylesheet.getStylesByType('web.data.styles.StyleButton')[0].id;
this.addStyleButton=new Ext.Button({
text:'New button style (Duplicate)',
handler:this.onAddStyle,
scope:this
});
var style=this.buttonStyle=app.dm.get(this.buttonStyleId),defaultStyle=style.inactive,hoverStyle=style.hover;
this.cls='globalstyles-buttons-panel';
this.layout='vbox';
this.layoutConfig={align:'stretch'};
this.items=[
{
xtype:'container',
cls:'gray-background hbox cross-center',
style:'padding: 5px;',
height:40,
margins:'0 0 0 0',
items:[
{
xtype:'container',
cls:'flex',
html:'Select a button style to edit:'
},
{
xtype:'container',
width:10,
height:10
},
{
xtype:'combo',
margins:'0 10 0 0',
ref:'../buttonStyleCombo',
store:this.getButtonStylesDataStore(),
mode:'local',
valueField:'id',
displayField:'text',
triggerAction:'all',
width:135,
editable:false,
forceSelection:true,
listeners:{
select:function(combo){
this.setStyleButton(this.app.dm.get(combo.getValue()))
},
scope:this
}
},
{
xtype:'container',
width:10,
height:10
},
this.addStyleButton,
{
xtype:'container',
width:10,
height:10
},
{
ref:'../deleteStyleButton',
xtype:'button',
text:'Delete this button style',
tooltip:'Button style is in use',
disabled:true,
listeners:{
click:function(btn){
this.deleteSelectedButtonStyle()
},
enable:function(button){
button.setTooltip('')
},
disable:function(button){
button.setTooltip(button.initialConfig.tooltip)
},
scope:this
}
}
]
},
{
flex:1,
xtype:'container',
autoscroll:true,
cls:'autoscroll',
layout:'hflex',
layoutConfig:{align:'stretchmax'},
items:[
{
xtype:'container',
layout:'auto',
style:{
verticalAlign:'top',
paddingRight:'20px',
width:'415px'
},
defaults:{
app:app,
listeners:{
changed:function(comp,type,value){
this.updateStyleButtonState(comp.namespace,type,value)
},
scope:this
}
},
items:[
{
xtype:'spacer',
height:20
},
{
xtype:'web-globalstyles-buttons-commonstyle',
ref:'../../commonStyleWidget',
namespace:'inactive',
title:'Common styles',
fontId:defaultStyle.text.font?defaultStyle.text.font.fontType:null,
fontSize:defaultStyle.text.size,
bold:defaultStyle.text.bold,
italic:defaultStyle.text.italic,
corners:defaultStyle.block.border.corners,
borders:defaultStyle.block.border.width
},
{
xtype:'web-globalstyles-buttons-overridestyle',
ref:'../../normalOverrideWidget',
namespace:'inactive',
title:'Default',
description:'These additional styling options are applied to the default button state.',
color:defaultStyle.text.color,
background:defaultStyle.block.background,
border:defaultStyle.block.border
},
{
xtype:'web-globalstyles-buttons-overridestyle',
ref:'../../hoverOverrideWidget',
namespace:'hover',
last:true,
title:'Mouse over',
description:'These additional styling options are activated when you hover over a button.',
color:hoverStyle.text.color?hoverStyle.text.color:defaultStyle.text.color,
background:hoverStyle.block.background,
border:hoverStyle.block.border
}
]
},
{
xtype:'container',
style:{
borderLeft:'1px solid #CED7BD',
verticalAlign:'top',
width:'435px',
height:'100%'
},
items:[
{
xtype:'spacer',
height:20
},
{
xtype:'label',
text:'Preview',
style:'padding: 0 0 9px 21px; display: block;',
height:20
},
{
xtype:'spacer',
height:140
},
{
ref:'../../preview',
xtype:'web-panels-props-globalstyles-buttons-preview',
width:'50%',
style:{'text-align':'center'},
domain:this.app.dal.domain
}
]
}
]
}
];
web.panels.props.globalstyles.buttons.Panel.superclass.initComponent.apply(this,arguments)
},
onAddStyle:function(btn){
var styleButton=this.stylesheet.getStylesByType('web.data.styles.StyleButton'),ref,cfg;
ref=function(styles){
var firstAvailableIndex,refs=styles.map(function(style){
return parseInt(style.getRef().replace(/^button\./,''),10)
});
refs.sort(function(a,b){
return a-b
});
firstAvailableIndex=refs[0]-1;
refs.some(function(ref){
firstAvailableIndex+=1;
return ref!==firstAvailableIndex
});
if(firstAvailableIndex===refs[refs.length-1]){
firstAvailableIndex+=1
}
return firstAvailableIndex.toString()
}(styleButton);
cfg=new web.utils.Copier().copy(Ext.apply(this.buttonStyle.toJSON(),{
ref:'button.'+ref,
name:'[ button.'+ref+']'
}));
this.app.invoker.execute(new web.commands.stylesheets.AddStyle({
style:cfg,
stylesheet:this.stylesheet
}));
this.buttonStyleCombo.bindStore(this.getButtonStylesDataStore());
this.setValues({style:this.app.dm.get(cfg.id)})
},
getButtonStyles:function(){
return this.app.getSelected('stylesheet').getStylesByType('web.data.styles.StyleButton')
},
getButtonStylesDataStore:function(){
var data;
data=this.getButtonStyles().map(function(style){
return[
style.id,
'Button Style '+style.getRef().replace(/^button\./,'')
]
});
data=data.sort(function(x,y){
return web.utils.String.naturalCompare(x[1],y[1])
});
return new Ext.data.ArrayStore({
fields:[
'id',
'text'
],
data:data
})
},
setValues:function(values){
if(this.buttonStyle!==values.style){
this.setStyleButton(values.style)
}else{
this.updatePreview();
this.updateBorderWidgetsState(this.buttonStyle.inactive.block.border.width)
}
},
setStyleButton:function(style){
var uItem=style.inactive,uHover=style.hover;
this.buttonStyle=style;
this.buttonStyleId=style.id;
this.commonStyleWidget.setValues({
fontId:uItem.text.font?uItem.text.font.fontType:null,
fontSize:uItem.text.size,
bold:uItem.text.bold,
italic:uItem.text.italic,
underline:uItem.text.underline,
corners:uItem.block.border.corners,
borders:uItem.block.border.width
});
this.normalOverrideWidget.setValues({
color:uItem.text.color,
background:uItem.block.background,
border:uItem.block.border
});
this.hoverOverrideWidget.setValues({
color:uHover.text.color?uHover.text.color:uItem.text.color,
background:uHover.block.background,
border:uHover.block.border
});
this.updatePreview();
this.updateBorderWidgetsState(uItem.block.border.width)
},
updateStyleButtonState:function(state,type,value){
var styleConfig=this.convertToConfig(state,type,value),command;
var other=state==='inactive'?'hover':'inactive';
if(type==='border-width'){
var borderWidths=[
value.top,
value.right,
value.bottom,
value.left
];
[
'hover',
'inactive'
].forEach(function(borderType){
var border=this.buttonStyle[borderType].getBlock().getBorder().toJSON()||{};
border.width=borderWidths;
if(!border.style){
border.style=[
'solid',
'solid',
'solid',
'solid'
]
}
styleConfig=Ext.apply(styleConfig,this.convertToConfig(borderType,'border',{border:border}))
},this)
}
var otherStyle=this.buttonStyle[other];
if(type==='foreColor'&&otherStyle&&otherStyle.text&&!otherStyle.text.color){
styleConfig=Ext.apply(styleConfig,this.convertToConfig(other,type,new one.color.RGB(1,1,1)))
}
command=new web.commands.stylesheets.EditStyle({
style:this.buttonStyle,
newStyle:styleConfig
});
this.app.invoker.execute(command);
this.updatePreview();
this.updateBorderWidgetsState(this.buttonStyle.inactive.block.border.width)
},
convertToConfig:function(state,type,value){
var opts={};
if(state!=='inactive'&&state!=='hover'){
throw'Invalid button state'
}
opts[state]={};
if(type==='foreColor'){
opts[state]={text:{color:value}}
}else if(type==='fontsize'){
opts[state]={text:{size:value}}
}else if(type==='fontid'){
opts[state]={text:{font:value}}
}else if(type==='bold'){
opts[state]={text:{bold:value}}
}else if(type==='italic'){
opts[state]={text:{italic:value}}
}else if(type==='underline'){
opts[state]={text:{underline:value}}
}else if(type==='background'||type==='border'||type==='corners'){
opts[state]={block:value}
}
return opts
},
updatePreview:function(){
this.setDeleteStyleButtonState(this.buttonStyle);
this.buttonStyleCombo.bindStore(this.getButtonStylesDataStore());
this.buttonStyleCombo.setValue(this.buttonStyleId);
this.preview.update(this.buttonStyle)
},
setDeleteStyleButtonState:function(buttonStyle){
var currentDocTypesToCheck=[
'page',
'template'
],found=false;
if(this.stylesheet.getStylesByType('web.data.styles.StyleButton').length===1){
this.deleteStyleButton.disable();
return
}
currentDocTypesToCheck.forEach(function(type){
if(this.isDocUsingButtonStyle(this.app.getSelected(type),buttonStyle)){
found=true
}
},this);
if(found){
this.deleteStyleButton.disable();
return
}
this.app.dal.getDocsWithProperty('globalId',buttonStyle.id,function(opts,success,response){
if(success){
Ext.decode(response.responseText).forEach(function(doc){
var type=doc.type.split('.').reverse()[0].toLowerCase(),currentDoc;
if(!found&&type==='template'||type==='page'){
currentDoc=this.app.getSelected(type);
if(currentDoc.id===doc.id){
if(this.isDocUsingButtonStyle(currentDoc,buttonStyle)){
found=true;
return
}
}else{
found=true;
return
}
}
},this);
if(found){
this.deleteStyleButton.disable()
}else{
this.deleteStyleButton.enable()
}
}else{
this.deleteStyleButton.disable()
}
},this)
},
isDocUsingButtonStyle:function(doc,buttonStyle){
doc=doc.toJSON?doc.toJSON():doc;
function extractObjectsFromArray(array){
var objects=[];
array.forEach(function(obj){
if(Ext.isArray(obj)){
Array.prototype.push.apply(objects,extractObjectsFromArray(obj))
}else if(Ext.isObject(obj)){
objects.push(obj)
}
});
return objects
}
var styleId=buttonStyle.id,components=[doc],prop,obj;
while(components.length){
obj=components.shift();
if(obj.globalId===styleId){
return true
}
for(prop in obj){
if(obj.hasOwnProperty(prop)){
if(Ext.isObject(obj[prop])){
components.push(obj[prop])
}else if(Ext.isArray(obj[prop])){
Array.prototype.push.apply(components,extractObjectsFromArray(obj[prop]))
}
}
}
}
return false
},
setStylesheet:function(stylesheet){
if(this.stylesheet!==stylesheet){
this.stylesheet=stylesheet;
this.buttonStyleCombo.bindStore(this.getButtonStylesDataStore());
this.setValues({style:this.stylesheet.getStylesByType('web.data.styles.StyleButton')[0]})
}
},
deleteSelectedButtonStyle:function(){
var app=this.app;
app.invoker.execute(new web.commands.stylesheets.DeleteStyle({
style:this.buttonStyle,
stylesheet:this.stylesheet
}));
this.buttonStyleCombo.bindStore(this.getButtonStylesDataStore());
this.buttonStyleId=this.stylesheet.getStylesByType('web.data.styles.StyleButton')[0].id;
this.setStyleButton(app.dm.get(this.buttonStyleId))
},
updateBorderWidgetsState:function(width){
var displayOperation=width.top||width.right||width.bottom||width.left?'enable':'disable';
this.normalOverrideWidget.borderWidget[displayOperation]();
this.hoverOverrideWidget.borderWidget[displayOperation]()
}
});
Ext.reg('web-globalstyles-buttons',web.panels.props.globalstyles.buttons.Panel);
Ext.ns('web.panels.props.globalstyles.texts');
Ext.ns('web.panels.props.richtext');
web.windows.GoogleWebFonts=Ext.extend(web.windows.Window,{
xtype:'web-windows-googlewebfonts',
type:'web.windows.GoogleWebFonts',
cls:'web-windows-googlewebfonts',
initComponent:function(){
this.title='Add font';
this.width=500;
this.height=460;
this.modal=true;
this.layout='table';
this.layoutConfig={columns:1};
this.loadGoogleFontList();
this.fontList=new web.ui.ComboBox({
itemId:'font',
store:new Ext.data.ArrayStore({
idIndex:0,
fields:[
'id',
'name'
],
data:[]
}),
valueField:'id',
displayField:'name',
mode:'local',
triggerAction:'all',
forceSelection:true,
width:460,
emptyText:'Choose font...',
listeners:{
select:function(combo){
this.onSelect(combo)
},
scope:this
}
});
this.heading=new Ext.form.Label({
cls:'uppercase-heading-text',
text:'Add a font to your website'
});
this.description=new Ext.form.Label({text:'Choose from over 500 fonts on Google Web Fonts.'});
this.previewPaneWrapper=new Ext.Container({
width:460,
height:160,
layout:'vbox',
items:[{
xtype:'container',
ref:'../previewPane',
hidden:true,
width:460,
style:'border: 1px dashed #aaa; border-radius: 10px; padding: 20px;',
html:''
}]
});
this.externalLink=new Ext.Container({html:'<a href=\'http://www.google.com/webfonts\' target=\'_blank\'>'+'Search for fonts on Google Web Fonts'+'</a>'});
this.items=[
this.heading,
{
xtype:'spacer',
height:10
},
this.description,
{
xtype:'spacer',
height:10
},
this.fontList,
{
xtype:'spacer',
height:10
},
this.previewPaneWrapper,
{
xtype:'spacer',
height:10
},
this.externalLink
];
this.buttons=[{
ref:'../addFontButton',
cls:'x-btn-primary',
text:'Add Font',
listeners:{
click:this.onAddFont,
scope:this
}
}];
web.windows.GoogleWebFonts.superclass.initComponent.apply(this,arguments)
},
loadGoogleFontList:function(){
var fonts=[];
Ext.Ajax.request({
url:'static/googleWebFontsList.67ce06cbd6.json',
success:function(response,opts){
var data=Ext.decode(response.responseText),arr=data.items,i,id,display;
for(i=0;i<arr.length;i+=1){
id='google://'+arr[i].family;
display=arr[i].family;
fonts.push([
id,
display
])
}
this.fontList.bindStore(new Ext.data.ArrayStore({
idIndex:0,
fields:[
'id',
{
name:'name',
sortType:Ext.data.SortTypes.asUCString
}
],
sortInfo:{
field:'name',
direction:'ASC'
},
data:fonts
}))
},
failure:function(response,opts){
fonts=[];
this.fontList.bindStore(new Ext.data.ArrayStore({
idIndex:0,
fields:[
'id',
'name'
],
data:fonts
}))
},
scope:this
})
},
onSelect:function(combo){
var id=combo.getValue(),display=id.replace(/^google:\/\//,''),css='"'+display.replace(/ /g,' ')+'"',html='<span style=\'font-size: 36px; font-family: $fontFamily, sans-serif;\'>'+display+'</span>';
html=html.replace('$fontFamily',css);
this.previewPane.update(html);
this.previewPane.setVisible(true);
this.app.googleWebFonts.initFonts(this.app.googleWebFonts.FONTS_LOADING_MODE.PREVIEW,[display]);
this.app.track([
'GoogleWebFonts',
'preview',
display
])
},
setValues:function(values){
this.values=this.values||{};
Ext.apply(this.values,values)
},
onAddFont:function(){
this.hide();
var font=this.fontList.getValue();
if(font){
this.app.googleWebFonts.addFont(font);
this.values.myOkHandler.call(this.values.scope,font);
var totalFontsBeingUsed=null;
if(this.app.site&&this.app.site.fonts){
totalFontsBeingUsed=this.app.site.fonts.length
}
this.app.track([
'GoogleWebFonts',
'select',
font.replace('google://',''),
totalFontsBeingUsed
])
}
},
onShow:function(win){
this.app.track([
'GoogleWebFonts',
'open'
])
}
});
Ext.ComponentMgr.registerType('web-windows-googlewebfonts',web.windows.GoogleWebFonts);
web.ui.plugins.ColorButton=Ext.extend(Object,{
constructor:function(cfg){
Ext.apply(this,cfg)
},
init:function(button){
button.addEvents('change');
Ext.apply(button,{
setColor:function(color){
if(color){
var el=this.btnEl;
if(el){
if(!this.colorEl){
this.colorEl=Ext.get(Ext.DomHelper.insertAfter(el,{
tag:'span',
cls:'web-colorbutton-preview'
}));
this.colorEl.setWidth(el.getWidth())
}
this.colorEl.dom.style.backgroundColor=color.css()
}
this.color=color
}
button.fireEvent('change',this,color)
},
hideColor:function(){
if(this.colorEl){
this.colorEl.hide()
}
},
showColor:function(){
if(this.colorEl){
this.colorEl.show()
}
}
});
button.on('afterrender',function(){
if(button.color){
button.setColor(button.color)
}
},this)
}
});
Ext.ns('web.ui.buttons');
web.ui.SplitButton=Ext.extend(Ext.util.Observable,{
constructor:function(config){
this.toggleButton=Ext.create(Ext.apply(config.toggleButton,{
xtype:'button',
cls:'splitbutton-toggle',
enableToggle:true
}));
this.winButton=Ext.create(Ext.apply(config.winButton,{xtype:'button'}));
delete config.toggleButton;
delete config.winButton;
web.ui.SplitButton.superclass.constructor.call(this,config);
this.winButton.on('click',this.onClick,this)
},
toggle:function(state,suppress){
this.toggleButton.toggle(state,!!suppress)
},
disable:function(){
this.toggleButton.disable();
this.winButton.disable()
},
enable:function(){
this.toggleButton.enable();
this.winButton.enable()
},
suspendEvents:function(queueSuspended){
this.toggleButton.suspendEvents(queueSuspended);
this.winButton.suspendEvents(queueSuspended)
},
resumeEvents:function(){
this.toggleButton.resumeEvents();
this.winButton.resumeEvents()
},
onClick:function(){
this.toggle(true)
}
});
web.ui.buttons.Shadow=Ext.extend(web.ui.SplitButton,{
xtype:'web-btn-shadow',
constructor:function(config){
this.shadowBlurRadius=1;
this.shadowLeft=1;
this.shadowTop=1;
this.color=new one.color.RGB(0.5,0.5,0.5);
this.toggled=false;
this.addEvents({'change':true});
this.listeners=config.listeners;
Ext.apply(config,{
toggleButton:{
iconCls:'icon icon-rte-shadowcolor',
tooltip:config.tooltip,
color:this.color,
scale:'small',
listeners:{
toggle:function(btn,pressed){
this.toggled=pressed;
if(pressed){
this.fireEvent('change',this,this.getShadow())
}else{
this.fireEvent('change',this,null)
}
},
scope:this
},
plugins:[new web.ui.plugins.ColorButton]
},
winButton:{
tooltip:config.tooltip,
cls:'splitbutton-win',
width:12,
listeners:{
winshow:function(btn,win){
var picker=win.row.picker;
picker.suspendEvents();
picker.setColor(this.color,true,true);
picker.updateTransparencySlider(this.color);
picker.resumeEvents();
win.row.blurSpinner.setValue(this.shadowBlurRadius);
win.row.leftSpinner.setValue(this.shadowLeft);
win.row.topSpinner.setValue(this.shadowTop)
},
scope:this
},
plugins:[new web.ui.plugins.WindowButton({
app:this.app,
title:'Shadow Settings',
resizable:false,
width:285,
cls:'shadow-win-panel color-panel-window ',
items:{
ref:'row',
xtype:'container',
layout:'auto',
items:[
{
ref:'picker',
xtype:'web-colorpanel',
showTransparency:true,
listeners:{
change:function(btn,color){
this.color=color;
if(this.toggled){
this.toggleButton.setColor(color);
this.fireEvent('change',this,{color:color})
}
},
scope:this
}
},
{
xtype:'container',
layout:'hflex',
items:[
{
xtype:'label',
html:'Blur Radius',
width:100,
style:{marginRight:'5px'}
},
{
ref:'../blurSpinner',
xtype:'spinnerfield',
ctCls:'text-shadow-combobox',
enableKeyEvents:true,
listeners:{
change:function(btn,value){
this.shadowBlurRadius=value;
this.fireEvent('change',this,{blur:value})
},
spin:function(o){
var blur=o.field.getValue();
this.shadowBlurRadius=blur;
this.fireEvent('change',this,{blur:blur})
},
keyup:function(self){
var value=self.getValue();
if(this.shadowBlurRadius!==value){
if(value===''){
value=null
}
this.shadowBlurRadius=value;
this.fireEvent('change',this,{blur:value})
}
},
scope:this
},
width:50,
value:0,
minValue:0,
maxValue:web.data.styles.Shadow.MAXBLUR
}
]
},
{
xtype:'container',
layout:'hflex',
items:[
{
xtype:'label',
html:'Horizontal offset',
width:100,
style:{marginRight:'5px'}
},
{
ref:'../leftSpinner',
xtype:'spinnerfield',
ctCls:'text-shadow-combobox',
enableKeyEvents:true,
listeners:{
change:function(btn,value){
this.shadowLeft=value;
this.fireEvent('change',this,{left:value})
},
spin:function(o){
var left=o.field.getValue();
this.shadowLeft=left;
this.fireEvent('change',this,{left:left})
},
keyup:function(self){
var value=self.getValue();
if(this.shadowLeft!==value){
if(value===''){
value=null
}
this.shadowLeft=value;
this.fireEvent('change',this,{left:value})
}
},
scope:this
},
width:50,
value:0,
minValue:-500,
maxValue:500
}
]
},
{
xtype:'container',
layout:'hflex',
items:[
{
xtype:'label',
html:'Vertical offset',
width:100,
style:{marginRight:'5px'}
},
{
ref:'../topSpinner',
xtype:'spinnerfield',
ctCls:'text-shadow-combobox',
enableKeyEvents:true,
listeners:{
change:function(btn,value){
this.shadowTop=value;
this.fireEvent('change',this,{top:value})
},
spin:function(o){
var top=o.field.getValue();
this.shadowTop=top;
this.fireEvent('change',this,{top:top})
},
keyup:function(self){
var value=self.getValue();
if(this.shadowTop!==value){
if(value===''){
value=null
}
this.shadowTop=value;
if(this.toggled){
this.fireEvent('change',this,{top:value})
}
}
},
scope:this
},
width:50,
value:0,
minValue:-500,
maxValue:500
}
]
}
]
}
})]
}
});
web.ui.buttons.Shadow.superclass.constructor.call(this,config);
if(config.listeners.toggle){
this.toggleButton.on('toggle',config.listeners.toggle,config.listeners.scope)
}
},
onRender:function(){
web.ui.buttons.Shadow.superclass.onRender.apply(this,arguments)
},
setShadow:function(shadow){
if(!shadow){
return
}
this.color=shadow.getColor();
this.toggleButton.setColor(this.color);
this.toggleButton.toggle(true);
this.toggled=true;
this.shadowBlurRadius=shadow.getBlurRadius();
this.shadowTop=shadow.getTop();
this.shadowLeft=shadow.getLeft()
},
getShadow:function(){
return{
left:this.shadowLeft,
top:this.shadowTop,
blur:this.shadowBlurRadius,
color:this.color?this.color.toJSON():null
}
}
});
Ext.reg('web-btn-shadow',web.ui.buttons.Shadow);
web.ui.buttons.Highlight=Ext.extend(web.ui.SplitButton,{
xtype:'web-btn-highlight',
constructor:function(config){
this.app=config.app;
this.defaultColor=new one.color.RGB(1,1,0);
this.color=this.defaultColor;
this.width=270;
this.height=200;
this.toggled=false;
this.addEvents({'change':true});
this.listeners=config.listeners;
Ext.apply(config,{
toggleButton:{
iconCls:'icon icon-rte-hilitecolor',
scale:'small',
tooltip:'Text highlight color.',
color:this.color,
handler:this.toggleHighlight,
scope:this,
plugins:[new web.ui.plugins.ColorButton]
},
winButton:{
tooltip:'Text highlight color.',
cls:'splitbutton-win',
width:12,
listeners:{
winshow:function(btn,win){
win.picker.setColor(this.color,true,true)
},
scope:this
},
plugins:[new web.ui.plugins.WindowButton({
app:this.app,
title:'Highlight color',
width:285,
cls:'color-panel-window',
items:{
ref:'picker',
xtype:'web-colorpanel',
showTransparency:true,
listeners:{
change:function(btn,color){
this.toggleButton.setColor(color);
this.fireEvent('change',this,color)
},
scope:this
}
}
})]
}
});
web.ui.buttons.Highlight.superclass.constructor.call(this,config);
if(config.listeners.toggle){
this.toggleButton.on('toggle',config.listeners.toggle,config.listeners.scope)
}
},
setColor:function(color){
this.color=color?color:this.defaultColor;
this.toggleButton.setColor(this.color,true);
this.toggleButton.toggle(!!color,true)
},
getColor:function(){
return this.color
}
});
Ext.reg('web-btn-highlight',web.ui.buttons.Highlight);
Ext.ns('web.ui.textPanel');
web.ui.textPanel.TextFontFamilyStylePanel=Ext.extend(Ext.Container,{
constructor:function(cfg){
this.app=cfg.app;
this.values=cfg.values;
this.width=250;
this.height='auto';
this.toggleHideClass='text-font-style-panel-visible';
this.initialStyle=null;
delete cfg.width;
delete cfg.height;
this.style='position:relative;top:10px;left:-1px;padding-bottom: 5px';
this.layout={type:'auto'};
this.fontList=new web.ui.ComboBox({
itemId:'font',
store:new Ext.data.ArrayStore({
idIndex:0,
fields:[
'id',
'name'
],
data:[]
}),
ctCls:'google-font-dropdown-wrap',
valueField:'id',
displayField:'name',
mode:'local',
triggerAction:'all',
forceSelection:true,
width:172,
emptyText:'Choose font...',
listeners:{
select:function(combo){
this.onSelect(combo)
},
scope:this
}
});
this.nextBtn=new Ext.Button({
disabled:true,
iconCls:'fontFamily-right-arrow',
cls:'fontFamilySelection-btn',
tooltip:'Next',
listeners:{
click:function(){
this.onTriggerSelect(1)
},
scope:this
}
});
this.previousBtn=new Ext.Button({
cls:'fontFamilySelection-btn',
iconCls:'fontFamily-left-arrow',
disabled:true,
style:'margin-left: 16px',
tooltip:'Previous',
listeners:{
click:function(){
this.onTriggerSelect(-1)
},
scope:this
}
});
this.loadGoogleFontList();
this.previewPaneWrapper=new Ext.Container({
width:240,
height:70,
style:'margin-left:10px',
layout:'vbox',
cls:'google-font-family-preview',
items:[{
xtype:'container',
ref:'../../previewPane',
disabled:true,
style:'border: 1px solid #aaa; display: flex;align-items: center;justify-content: center;background:#FFF;height:70px;width:240px;box-sizing:border-box;font-size:20px;',
html:'Choose font above'
}]
});
this.externalLink=new Ext.Container({
style:'margin: 0 0 10px 10px;max-width: 240px',
html:'<a href=\'http://www.google.com/webfonts\' style=\'color:#676767\' target=\'_blank\'>'+'Search for fonts on Google Web Fonts'+'</a>'
});
this.addFontbtn=new Ext.Button({
ref:'../addFontButton',
cls:'web-button-fontFamilyPanel',
style:'margin: 0 0 0 10px;vertical-align:top',
text:'Add Font',
listeners:{
click:this.onAddFont,
scope:this
}
});
this.googlefontListPlaceholder=new Ext.Container({
layout:'auto',
items:[]
});
this.cls='fontFamilyPanel';
this.items=[{
xtype:'container',
ref:'textFontfamilyStylePanelBody',
layout:'auto',
items:[
{
xtype:'label',
style:'padding:10px 0 0 10px',
text:'Add a font to your website'
},
{
xtype:'spacer',
height:10
},
{
xtype:'container',
layout:'hauto',
items:[
this.fontList,
this.previousBtn,
this.nextBtn
]
},
{
xtype:'spacer',
height:10
},
this.previewPaneWrapper,
{
xtype:'spacer',
height:20
},
this.externalLink,
{
xtype:'spacer',
height:10
},
this.addFontbtn
]
}];
this.app.googleWebFonts.on('google-fonts-active',function(forPreview){
if(forPreview&&this.previewPane&&this.previewPane.el){
var fontPreview=oneJQuery(this.previewPane.el.dom);
fontPreview.find('.animated-loading-dots').remove();
fontPreview.find('span').show()
}
},this);
web.ui.textPanel.TextFontFamilyStylePanel.superclass.constructor.call(this,cfg)
},
setValue:function(font){
var googleFont=font.replace(/^google:\/\//,'');
if(!font){
return
}
if(this.fontList.getValue()!==font){
this.googlefontListPlaceholder.removeAll();
this.googlefontListPlaceholder.items.add(new Ext.Container({
layout:'hflex',
items:[
{
xtype:'label',
text:googleFont
},
{
xtype:'checkbox',
checked:true,
listeners:{
check:this.onRemoveFont,
scope:this
}
}
]
}));
this.googlefontListPlaceholder.doLayout()
}
},
loadGoogleFontList:function(){
var fonts=[];
Ext.Ajax.request({
url:'static/googleWebFontsList.67ce06cbd6.json',
success:function(response,opts){
var data=Ext.decode(response.responseText),arr=data.items,i,id,display;
for(i=0;i<arr.length;i+=1){
id='google://'+arr[i].family;
display=arr[i].family;
fonts.push([
id,
display
])
}
this.fontList.bindStore(new Ext.data.ArrayStore({
idIndex:0,
fields:[
'id',
{
name:'name',
sortType:Ext.data.SortTypes.asUCString
}
],
sortInfo:{
field:'name',
direction:'ASC'
},
data:fonts
}))
},
failure:function(response,opts){
fonts=[];
this.fontList.bindStore(new Ext.data.ArrayStore({
idIndex:0,
fields:[
'id',
'name'
],
data:fonts
}))
},
scope:this
})
},
onSelect:function(combo){
var id=combo.getValue(),display=id.replace(/^google:\/\//,''),css='"'+display.replace(/ /g,' ')+'"',html='<span style=\'font-family: $fontFamily, sans-serif;display: none;\'>'+display+'</span><div class=\'animated-loading-dots\'><div></div></div>';
html=html.replace('$fontFamily',css);
this.previewPane.update(html);
this.previewPane.setDisabled(false);
if(combo.getStore().indexOfId(combo.getValue())>-1){
this.previousBtn.setDisabled(false)
}else{
this.previousBtn.setDisabled(true)
}
if(combo.getStore().indexOfId(combo.getValue())<combo.getStore().getTotalCount()-1){
this.nextBtn.setDisabled(false)
}else{
this.nextBtn.setDisabled(true)
}
this.app.googleWebFonts.initFonts(this.app.googleWebFonts.FONTS_LOADING_MODE.PREVIEW,[display]);
this.app.track([
'GoogleWebFonts',
'preview',
display
])
},
onAddFont:function(){
var font=this.fontList.getValue();
if(font){
this.app.googleWebFonts.addFont(font);
this.values.myOkHandler.call(this.values.scope,font);
var totalFontsBeingUsed=null;
if(this.app.site&&this.app.site.fonts){
totalFontsBeingUsed=this.app.site.fonts.length
}
this.app.track([
'GoogleWebFonts',
'select',
font.replace('google://',''),
totalFontsBeingUsed
])
}
},
onRemoveFont:function(checkbox,checked){
var font=checkbox.previousSibling().text;
this.app.googleWebFonts.removeFont('google://'+font);
this.googlefontListPlaceholder.removeAll()
},
onTriggerSelect:function(changeCount){
var fontListCombo=this.fontList;
fontListCombo.setValue(fontListCombo.getStore().getAt(fontListCombo.getStore().indexOfId(fontListCombo.getValue())+changeCount).id);
fontListCombo.fireEvent('select',fontListCombo)
}
});
Ext.ComponentMgr.registerType('web-textfontfamilystylepanel',web.ui.textPanel.TextFontFamilyStylePanel);
web.ui.colorPanel.TextColorPanel=Ext.extend(Ext.Container,{
constructor:function(cfg){
this.width=275;
this.height='auto';
this.toggleHideClass='text-color-panel-visible';
this.initialStyle=null;
delete cfg.width;
delete cfg.height;
this.layout={type:'auto'};
this.headerCheckboxVisible=false;
this.items=[
{
xtype:'container',
cls:'text-color-panel-header',
layout:'hflex',
layoutConfig:{align:'middle'},
style:{
position:'relative',
'min-width':'267px'
},
items:[
{
ref:'../headerLabel',
name:'headerLabel',
xtype:'label',
text:'Text color:'
},
{
xtype:'container',
layout:'hflex',
cls:'web-panel-button-group-new',
items:[
{
xtype:'button',
ref:'../../placeholder',
cls:'panel-text-preview',
style:{paddingLeft:'10px'},
html:'<div style="background:none;box-shadow:none">Abc</div>',
listeners:{
click:this.toggleTextColorPanel,
scope:this
}
},
{
xtype:'button',
ref:'../../settingsGearBtn',
style:{position:'relative'},
cls:'custom-color-panel-gear-btn color-chooser-panel',
enableToggle:true,
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
tooltip:'Edit text color',
listeners:{
click:this.toggleTextColorPanel,
scope:this
}
}
]
}
]
},
{
xtype:'spacer',
ref:'panelBodyPatch',
cls:'custom-panel-patch-holder',
height:'2px',
html:'<div class="custom-panel-body-patch"></div>'
},
{
xtype:'container',
ref:'textColorPanelBody',
layout:'auto',
cls:'custom-color-panel-body',
items:{
xtype:'web-colorpanel',
ref:'../colorPanel',
listeners:{
change:this.onColorChange,
scope:this
}
}
}
];
web.ui.colorPanel.TextColorPanel.superclass.constructor.call(this,cfg)
},
setColor:function(color){
if(color){
this.colorPanel.setColor(color,'both',true);
this.colorPanel.updateColorPanelVisibility(true);
this.colorPanel.updateTransparencySlider(color);
this.setHeaderTextColor(color)
}
},
onColorChange:function(opt){
var textColor=opt.color;
this.setHeaderTextColor(textColor);
this.fireEvent('change',textColor)
},
toggleTextColorPanel:function(event){
if(this.settingsGearBtn.el.dom!==event.el.dom){
this.settingsGearBtn.suspendEvents();
this.settingsGearBtn.toggle();
this.settingsGearBtn.resumeEvents()
}
var that=this,panelBodyPatchEl=that.panelBodyPatch.getEl(),textColorPanelBodyEl=this.textColorPanelBody.getEl(),step1=function(){
panelBodyPatchEl.toggleClass('custom-panel-patch-holder-visible')
},step2=function(){
textColorPanelBodyEl.toggleClass('custom-panel-isExpanded text-color-panel-visible')
};
if(!textColorPanelBodyEl.hasClass('custom-panel-isExpanded')){
step1();
step2()
}else{
step2();
setTimeout(function(){
step1()
},200)
}
},
setHeaderTextColor:function(textColor){
var that=this;
window.setTimeout(function(){
if(that.placeholder.el){
that.placeholder.el.dom.style.color=one.color(textColor).cssa()
}
},500)
}
});
Ext.ComponentMgr.registerType('web-textcolorpanel',web.ui.colorPanel.TextColorPanel);
web.ui.colorPanel.HighlightColorPanel=Ext.extend(Ext.Container,{
constructor:function(cfg){
this.width=275;
this.height='auto';
this.label=cfg.label||'Highlight color';
this.previewText=cfg.hidePreviewText?'':'ABC';
this.layout={type:'auto'};
this.headerCheckboxVisible=false;
this.items=[
{
xtype:'container',
layout:'hflex',
style:{
position:'relative',
'min-width':'267px'
},
items:[
{
ref:'../headerLabel',
name:'headerLabel',
xtype:'label',
text:this.label+':'
},
{
xtype:'container',
layout:'hflex',
cls:'web-panel-button-group-new',
items:[
{
xtype:'button',
ref:'../../placeholder',
cls:'panel-text-preview',
html:'<div style="width:60px;height:100%;boxSizing:border-box;border:none;box-shadow:none;">'+this.previewText+'</div>',
listeners:{
click:this.toggleHighlightColorPanel,
scope:this
}
},
{
ref:'../../highlightColorRemoveBtn',
xtype:'button',
tooltip:'Remove highlight color',
ctCls:'hflex-item__highlight-color-checkboxContainer',
cls:'props-panel-remove-button',
style:{
position:'relative',
left:'0px'
},
listeners:{
click:this.onRemoveBtnClick,
scope:this
}
},
{
xtype:'button',
cls:'custom-color-panel-gear-btn color-chooser-panel',
style:{position:'relative'},
ref:'../../settingsGearBtn',
enableToggle:true,
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
tooltip:'Edit highlight color',
listeners:{
click:this.toggleHighlightColorPanel,
scope:this
}
}
]
}
]
},
{
xtype:'spacer',
ref:'panelBodyPatch',
cls:'custom-panel-patch-holder',
height:'2px',
html:'<div class="custom-panel-body-patch"></div>'
},
{
xtype:'container',
ref:'highlightColorPanelBody',
layout:'auto',
cls:'custom-color-panel-body',
items:{
xtype:'web-colorpanel',
ref:'../colorPanel',
showTransparency:true,
listeners:{
change:this.onHighlightColorChange,
scope:this
}
}
}
];
web.ui.colorPanel.HighlightColorPanel.superclass.constructor.call(this,cfg)
},
setColor:function(backgroundcolor,textColor){
if(backgroundcolor===null){
this.colorPanel.setColor(backgroundcolor,'both',true);
this.colorPanel.updateColorPanelVisibility(true);
this.setHeaderHighlightColor(backgroundcolor,textColor);
this.highlightColorRemoveBtn.hide();
return
}else if(backgroundcolor){
this.colorPanel.setColor(backgroundcolor,'both',true);
this.colorPanel.updateColorPanelVisibility(true);
this.setHeaderHighlightColor(backgroundcolor,textColor);
this.highlightColorRemoveBtn.show()
}
},
onHighlightColorChange:function(opt){
var highlightColor=opt.color;
this.setHeaderHighlightColor(highlightColor);
this.fireEvent('change',opt,highlightColor);
this.app.actionTips.pushMessage('actionTip-firstTimeChangeColor')
},
toggleHighlightColorPanel:function(event){
if(this.settingsGearBtn.el.dom!==event.el.dom){
this.settingsGearBtn.suspendEvents();
this.settingsGearBtn.toggle();
this.settingsGearBtn.resumeEvents()
}
var that=this,panelBodyPatchEl=that.panelBodyPatch.getEl(),highlightColorPanelBodyEl=this.highlightColorPanelBody.getEl(),step1=function(){
panelBodyPatchEl.toggleClass('custom-panel-patch-holder-visible')
},step2=function(){
highlightColorPanelBodyEl.toggleClass('custom-panel-isExpanded text-color-panel-visible')
};
if(!highlightColorPanelBodyEl.hasClass('custom-panel-isExpanded')){
step1();
step2()
}else{
step2();
setTimeout(function(){
step1()
},200)
}
},
onRemoveBtnClick:function(){
this.placeholder.el.dom.childNodes[0].style.background='none';
this.fireEvent('change',null)
},
setHeaderHighlightColor:function(backgroundcolor,textColor){
var that=this,headerTextColor=textColor||new one.color.RGB(0,0,0);
window.setTimeout(function(){
if(that.placeholder.el){
if(backgroundcolor){
that.placeholder.el.removeClass('highlight-header-transparent-background');
that.placeholder.el.dom.childNodes[0].style.background=one.color(backgroundcolor).cssa()
}else{
that.placeholder.el.addClass('highlight-header-transparent-background')
}
that.placeholder.el.dom.childNodes[0].style.color=one.color(headerTextColor).cssa()
}
},500)
},
hideHighlightColorRemoveButton:function(){
this.highlightColorRemoveBtn.hide()
},
showHighlightColorRemoveButton:function(){
this.highlightColorRemoveBtn.show()
}
});
Ext.ComponentMgr.registerType('web-highlightcolorpanel',web.ui.colorPanel.HighlightColorPanel);
web.ui.colorPanel.TextShadowPanel=Ext.extend(Ext.Container,{
constructor:function(cfg){
this.width=275;
this.height='auto';
this.layout={type:'auto'};
this.shadowBlurRadius=0;
this.shadowLeft=0;
this.shadowTop=0;
this.color=new one.color.RGB(0.5,0.5,0.5);
this.items=[
{
xtype:'container',
layout:'hflex',
layoutConfig:{align:'middle'},
style:{
position:'relative',
'min-width':'267px'
},
items:[
{
ref:'../headerLabel',
name:'headerLabel',
xtype:'label',
text:'Text shadow:'
},
{
xtype:'container',
layout:'hflex',
cls:'web-panel-button-group-new',
items:[
{
xtype:'button',
ref:'../../placeholder',
cls:'text-shadow-btn panel-text-preview',
style:'overflow:hidden',
html:'<div style="width:50px;height:100%;">Abc</div>',
listeners:{
click:this.toggleTextShadowPanel,
scope:this
}
},
{
ref:'../../textShadowRemoveBtn',
xtype:'button',
tooltip:'Remove text shadow',
ctCls:'hflex-item__text-shadow-checkboxContainer',
cls:'props-panel-remove-button',
style:{
position:'relative',
left:'0px'
},
listeners:{
click:this.onHeaderCheckboxCheck,
scope:this
}
},
{
xtype:'button',
ref:'../../settingsGearBtn',
cls:'custom-color-panel-gear-btn color-chooser-panel',
style:{position:'relative'},
enableToggle:true,
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
tooltip:'Edit text shadow',
listeners:{
click:this.toggleTextShadowPanel,
scope:this
}
}
]
}
]
},
{
xtype:'spacer',
ref:'panelBodyPatch',
cls:'custom-panel-patch-holder',
height:'2px',
html:'<div class="custom-panel-body-patch"></div>'
},
{
xtype:'container',
ref:'textShadowPanelBody',
layout:'auto',
cls:'custom-color-panel-body',
items:[
{
xtype:'web-colorpanel',
ref:'../colorPanel',
showTransparency:true,
listeners:{
change:this.onTextShadowColorChange,
scope:this
}
},
{
xtype:'container',
layout:'hflex',
items:[
{
xtype:'label',
html:'Blur Radius',
width:175,
style:{
marginRight:'5px',
width:'100px'
}
},
{
ref:'../../blurSpinner',
xtype:'spinnerfield',
ctCls:'text-shadow-combobox',
enableKeyEvents:true,
listeners:{
change:function(btn,value){
this.shadowBlurRadius=value;
this.fireEvent('change',this,{blur:value})
},
spin:function(o){
var blur=o.field.getValue();
this.shadowBlurRadius=blur;
this.fireEvent('change',this,{blur:blur})
},
keyup:function(self){
var value=self.getValue();
if(this.shadowBlurRadius!==value){
if(value===''){
value=null
}
this.shadowBlurRadius=value;
this.fireEvent('change',this,{blur:value})
}
},
scope:this
},
width:50,
value:0,
minValue:0,
maxValue:web.data.styles.Shadow.MAXBLUR
}
]
},
{
xtype:'container',
layout:'hflex',
items:[
{
xtype:'label',
width:175,
html:'Horizontal offset',
style:{
marginRight:'5px',
width:'100px'
}
},
{
ref:'../../leftSpinner',
xtype:'spinnerfield',
ctCls:'text-shadow-combobox',
enableKeyEvents:true,
listeners:{
change:function(btn,value){
this.shadowLeft=value;
this.fireEvent('change',this,{left:value})
},
spin:function(o){
var left=o.field.getValue();
this.shadowLeft=left;
this.fireEvent('change',this,{left:left})
},
keyup:function(self){
var value=self.getValue();
if(this.shadowLeft!==value){
if(value===''){
value=null
}
this.shadowLeft=value;
this.fireEvent('change',this,{left:value})
}
},
scope:this
},
width:50,
value:0,
minValue:-500,
maxValue:500
}
]
},
{
xtype:'container',
layout:'hflex',
items:[
{
xtype:'label',
width:175,
html:'Vertical offset',
style:{
marginRight:'5px',
width:'100px'
}
},
{
ref:'../../topSpinner',
xtype:'spinnerfield',
ctCls:'text-shadow-combobox',
enableKeyEvents:true,
listeners:{
change:function(btn,value){
this.shadowTop=value;
this.fireEvent('change',this,{top:value})
},
spin:function(o){
var top=o.field.getValue();
this.shadowTop=top;
this.fireEvent('change',this,{top:top})
},
keyup:function(self){
var value=self.getValue();
if(this.shadowTop!==value){
if(value===''){
value=null
}
this.shadowTop=value;
this.fireEvent('change',this,{top:value})
}
},
scope:this
},
width:50,
value:0,
minValue:-500,
maxValue:500
}
]
}
]
}
];
this.addEvents({'change':true});
web.ui.colorPanel.TextShadowPanel.superclass.constructor.call(this,cfg)
},
afterRender:function(){
web.ui.colorPanel.TextShadowPanel.superclass.afterRender.call(this,arguments);
this.colorPanel.on('afterrender',function(){
this.colorPanel.updateColorPanelVisibility(true)
},this)
},
onTextShadowColorChange:function(opt){
var textShadowColor=opt.color;
this.fireEvent('change',this,{color:textShadowColor});
this.app.actionTips.pushMessage('actionTip-firstTimeChangeColor')
},
toggleTextShadowPanel:function(event){
if(this.settingsGearBtn.el.dom!==event.el.dom){
this.settingsGearBtn.suspendEvents();
this.settingsGearBtn.toggle();
this.settingsGearBtn.resumeEvents()
}
var that=this,panelBodyPatchEl=that.panelBodyPatch.getEl(),textShadowPanelBodyEl=that.textShadowPanelBody.getEl(),step1=function(){
panelBodyPatchEl.toggleClass('custom-panel-patch-holder-visible')
},step2=function(){
textShadowPanelBodyEl.toggleClass('custom-panel-isExpanded text-shadow-panel-visible')
};
if(!textShadowPanelBodyEl.hasClass('custom-panel-isExpanded')){
step1();
step2()
}else{
step2();
setTimeout(function(){
step1()
},200)
}
},
onHeaderCheckboxCheck:function(){
this.placeholder.el.dom.childNodes[0].style.textShadow='none';
this.blurSpinner.suspendEvents();
this.blurSpinner.setValue(0);
this.blurSpinner.resumeEvents();
this.leftSpinner.suspendEvents();
this.leftSpinner.setValue(0);
this.leftSpinner.resumeEvents();
this.topSpinner.suspendEvents();
this.topSpinner.setValue(0);
this.topSpinner.resumeEvents();
this.fireEvent('change',this,null)
},
setHeaderTextShadow:function(){
var that=this;
window.setTimeout(function(){
if(that.placeholder.el){
if(that.color){
that.placeholder.el.dom.childNodes[0].style.textShadow=that.shadowLeft+'px '+that.shadowTop+'px '+that.shadowBlurRadius+'px '+one.color(that.color).cssa()
}else{
that.placeholder.el.dom.childNodes[0].style.textShadow='none'
}
}
},500)
},
setShadow:function(shadow){
if(!shadow){
this.textShadowRemoveBtn.hide();
this.colorPanel.setColor(this.color,'both',true);
this.colorPanel.updateTransparencySlider(this.color);
this.blurSpinner.suspendEvents();
this.blurSpinner.setValue(0);
this.blurSpinner.resumeEvents();
this.leftSpinner.suspendEvents();
this.leftSpinner.setValue(0);
this.leftSpinner.resumeEvents();
this.topSpinner.suspendEvents();
this.topSpinner.setValue(0);
this.topSpinner.resumeEvents();
return
}
this.color=shadow.getColor();
this.colorPanel.setColor(this.color,'both',true);
this.colorPanel.updateTransparencySlider(this.color);
this.shadowBlurRadius=shadow.getBlurRadius();
this.shadowLeft=shadow.getLeft();
this.shadowTop=shadow.getTop();
this.blurSpinner.suspendEvents();
this.blurSpinner.setValue(this.shadowBlurRadius);
this.blurSpinner.resumeEvents();
this.leftSpinner.suspendEvents();
this.leftSpinner.setValue(this.shadowLeft);
this.leftSpinner.resumeEvents();
this.topSpinner.suspendEvents();
this.topSpinner.setValue(this.shadowTop);
this.topSpinner.resumeEvents();
this.setHeaderTextShadow();
this.textShadowRemoveBtn.show()
},
getShadow:function(){
return{
left:this.shadowLeft,
top:this.shadowTop,
blur:this.shadowBlurRadius,
color:this.color?this.color.toJSON():null
}
}
});
Ext.ComponentMgr.registerType('web-textshadowpanel',web.ui.colorPanel.TextShadowPanel);
web.commands.text.RemoveStyles=Ext.extend(web.commands.text.Insert,{
constructor:function(cfg){
web.commands.text.RemoveStyles.superclass.constructor.call(this,cfg)
},
execute:function(){
var target=this.target;
this.oldJSON=target.toJSON();
target.removeStyles();
this.newJSON=target.toJSON();
this.fireEvent('update',target)
}
});
web.panels.props.richtext.Style=Ext.extend(web.panels.Panel,{
xtype:'web-props-font',
constructor:function(config){
if(config.style){
this.textStyle=config.style;
delete config.style
}
web.panels.props.richtext.Style.superclass.constructor.call(this,config)
},
initComponent:function(){
var app=this.app,fonts,sizes;
this.baseCls='x-btn-group';
this.cls='web-prop-btn-group';
this.frame=true;
this.layout='table';
sizes=[
9,
10,
11,
12,
13,
14,
15,
16,
18,
20,
22,
24,
26,
28,
32,
36,
40,
44,
48,
54,
60,
66,
72,
80,
88,
96
];
fonts=this.loadFontList();
this.font=new web.ui.ComboBox({
itemId:'font',
tpl:'<tpl for="."><div class="x-combo-list-item" '+'style="font-family:{css}!important;">{name}</div></tpl>',
store:new Ext.data.ArrayStore({
idIndex:0,
fields:[
'id',
'css',
'name'
],
data:fonts
}),
valueField:'id',
displayField:'name',
mode:'local',
triggerAction:'all',
editable:false,
value:0,
width:120,
resetStyle:function(){
var el=this.el,width,css='',selected;
selected=this.getValue();
if(typeof selected==='number'){
css=web.data.styles.Font.cssValues[selected]
}else if(/^google:\/\//.test(selected)){
css=selected.replace(/^google:\/\//,'');
if(el?/^google:\/\//.test(el.dom.value):false){
el.dom.value=css
}
}
if(el){
width=el.dom.style.width;
el.dom.setAttribute('style','font-family:'+css+'!important;');
el.dom.style.width=width
}
},
listeners:{
select:function(combo){
this.onSelect(combo);
combo.resetStyle()
},
render:function(combo){
combo.tip=new Ext.ToolTip({
target:combo.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:'Font family.'
}
});
combo.resetStyle()
},
scope:this
}
});
this.app.googleWebFonts.on('update',function(newFont){
var fonts=this.loadFontList(),store=new Ext.data.ArrayStore({
idIndex:0,
fields:[
'id',
'css',
'name'
],
data:fonts
});
this.font.bindStore(store)
},this);
this.addFont=new Ext.Button({
itemId:'addFont',
text:'+',
tooltip:'Add font from Google Web Fonts.',
scale:'small',
handler:function(){
this.popupGoogleWebFonts()
},
scope:this
});
this.fontFamily=new web.ui.textPanel.TextFontFamilyStylePanel({
app:app,
values:{
myOkHandler:function(selectedFont){
if(selectedFont!==null){
this.font.setValue(selectedFont);
this.onSelect(this.font);
this.font.resetStyle()
}
},
scope:this
}
});
this.bold=new Ext.Button({
itemId:'bold',
tooltip:'Bold.',
iconCls:'icon icon-rte-bold',
scale:'small',
width:26,
enableToggle:true,
handler:this.onClick,
scope:this
});
this.italic=new Ext.Button({
itemId:'italic',
tooltip:'Italic.',
iconCls:'icon icon-rte-italic',
scale:'small',
width:25,
enableToggle:true,
handler:this.onClick,
scope:this
});
this.underline=new Ext.Button({
itemId:'underline',
tooltip:'Underline.',
iconCls:'icon icon-rte-underline',
scale:'small',
width:25,
enableToggle:true,
handler:this.onClick,
scope:this
});
this.size=new web.ui.ComboBox({
itemId:'size',
store:sizes,
triggerAction:'all',
value:12,
width:43,
enableKeyEvents:true,
maxNumber:999,
minNumber:9,
listeners:{
render:function(combo){
combo.tip=new Ext.ToolTip({
target:combo.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:'Font size.'
}
})
},
keyup:function(combo,e){
if(e.getCharCode()===13){
var size=parseInt(combo.getRawValue(),10);
if(Ext.isNumber(size)&&size>0){
this.onSelectSize(combo)
}
}
},
select:this.onSelectSize,
scope:this
}
});
this.newColor=new web.ui.colorPanel.TextColorPanel({
listeners:{
change:this.onPick,
scope:this
}
});
this.color=new Ext.Button({
itemId:'textcolor',
tooltip:'Text color.',
iconCls:'icon icon-rte-forecolor',
scale:'small',
listeners:{
winshow:function(btn,win){
win.picker.setColor(btn.color,true,true);
win.picker.updateTransparencySlider(btn.color)
},
scope:this
},
plugins:[
new web.ui.plugins.ColorButton,
new web.ui.plugins.WindowButton({
app:this.app,
title:'Text color',
resizable:false,
width:285,
height:205,
cls:'color-panel-window',
items:{
ref:'picker',
xtype:'web-colorpanel',
enablePanel:true,
listeners:{
change:function(btn,color){
this.color.setColor(color);
this.onPick(color)
},
scope:this
}
}
})
]
});
this.newHighlight=new web.ui.colorPanel.HighlightColorPanel({
app:this.app,
listeners:{
change:this.changeHighlight,
toggle:this.toggleHighlight,
scope:this
}
});
this.highlight=new web.ui.buttons.Highlight({
app:this.app,
listeners:{
change:this.changeHighlight,
toggle:this.toggleHighlight,
scope:this
}
});
this.newShadow=new web.ui.colorPanel.TextShadowPanel({
app:this.app,
listeners:{
change:this.changeShadow,
scope:this
}
});
this.shadow=new web.ui.buttons.Shadow({
tooltip:'Text shadow settings.',
app:this.app,
listeners:{
change:this.changeShadow,
scope:this
}
});
this.letterSpacing=new web.ui.ComboBox({
itemId:'letterspacing',
store:[
0,
1,
2,
3,
4
],
triggerAction:'all',
value:0,
width:50,
enableKeyEvents:true,
maxNumber:500,
listeners:{
render:function(combo){
combo.tip=new Ext.ToolTip({
target:combo.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:'Character spacing'
}
})
},
keyup:function(combo,e){
if(e.getCharCode()===13){
this.onLetterSpacing(combo)
}
},
select:this.onLetterSpacing,
scope:this
}
});
this.initStylePanel();
web.panels.props.richtext.Style.superclass.initComponent.apply(this,arguments)
},
loadFontList:function(){
var n,id,css,display,fonts=[],fontTypes=web.data.styles.Font.types;
for(n in fontTypes){
if(fontTypes.hasOwnProperty(n)){
id=fontTypes[n];
css=web.data.styles.Font.cssValues[id];
fonts.push([
id,
css.replace(/"/g,'\''),
web.data.styles.Font.displayNameByType[n]
])
}
}
if(this.app.site.fonts){
for(n in this.app.site.fonts){
if(this.app.site.fonts.hasOwnProperty(n)){
id=this.app.site.fonts[n];
display=id.replace(/^google:\/\//,'');
css='\''+display+'\', cursive';
fonts.push([
id,
css.replace(/"/g,'\''),
display
])
}
}
}
return fonts.sort(function(a,b){
if(a[2]>b[2]){
return 1
}
if(a[2]<b[2]){
return-1
}
return 0
})
},
initStylePanel:function(){
this.layoutConfig={columns:1};
this.width=147;
this.items=[
{
layout:'table',
layoutConfig:{columns:2},
border:false,
items:[
{
xtype:'buttongroup',
width:89,
padding:1,
items:[this.size]
},
{
xtype:'buttongroup',
padding:1,
items:[
this.bold,
this.italic,
this.underline
]
}
]
},
{
itemId:'fontbuttongroup',
xtype:'buttongroup',
width:141,
padding:1,
items:[this.font]
},
{
xtype:'buttongroup',
padding:1,
items:[
this.newColor,
this.newShadow
]
}
]
},
setComponent:function(component){
this.resetStylesheet();
this.part=component;
this.refresh()
},
setStyle:function(style){
this.resetStylesheet();
this.textStyle=style;
this.refresh()
},
resetStylesheet:function(){
var stylesheet=this.app.getSelected('stylesheet');
if(stylesheet){
this.defaultStyle=stylesheet.getStyleByRef('normal','StyleText')
}
},
setup:function(){
this.initMyListeners()
},
afterRender:function(){
web.panels.props.richtext.Style.superclass.afterRender.call(this);
this.setup()
},
initMyListeners:function(){
this.on('afterlayout',function(){
var fontEl=this.font.el,sizeEl=this.size.el;
if(fontEl){
fontEl.dom.parentNode.style.width='120px'
}
if(sizeEl){
sizeEl.dom.parentNode.style.width='40px'
}
},this);
this.setStyle(this.textStyle)
},
getValues:function(){
var global,color,highlight,shadow,font=null,size,bold,italic,underline,letterSpacing,style=this.textStyle,globalNormalStyle=this.defaultStyle;
if(style){
font=style.getFont();
font=font?font.getFontType():null;
size=style.getSize();
bold=style.isBold();
italic=style.isItalic();
underline=style.isUnderline();
color=style.getColor();
highlight=style.getHighlight();
shadow=style.getShadow();
letterSpacing=style.getLetterSpacing()
}
global=style&&style.getGlobal()||globalNormalStyle;
if(global){
if(font===null){
font=global.getFont();
font=font?font.getFontType():null
}
size=size||global.getSize();
bold=bold!==null?bold:global.isBold();
italic=italic!==null?italic:global.isItalic();
underline=underline!==null?underline:global.isUnderline();
color=color||global.getColor();
highlight=highlight||global.getHighlight();
if(!Ext.isDefined(shadow)||shadow===null){
shadow=global.getShadow()
}
letterSpacing=Ext.isNumber(letterSpacing)?letterSpacing:global.getLetterSpacing()
}
return{
font:font||0,
size:size||12,
bold:!!bold,
italic:!!italic,
underline:!!underline,
color:color||new one.color.RGB(0,0,0),
highlight:highlight,
shadow:shadow,
letterSpacing:letterSpacing||0
}
},
refresh:function(){
var values=this.getValues(),highlight=values.highlight,shadow=values.shadow;
this.font.setValue(values.font);
if(typeof values.font==='string'){
if(values.font.indexOf('google://')!==-1){
this.fontFamily.setValue(values.font)
}
}
this.font.resetStyle();
this.size.setValue(values.size);
this.bold.toggle(values.bold);
this.italic.toggle(values.italic);
this.underline.toggle(values.underline);
this.newColor.setColor(values.color);
this.color.setColor(values.color);
this.newHighlight.setColor(highlight,values.color);
this.highlight.setColor(highlight);
this.newShadow.setShadow(shadow);
this.letterSpacing.setValue(values.letterSpacing)
},
onPick:function(color){
this.applyStyle({color:color})
},
onClick:function(button){
var style={};
style[button.itemId]=button.pressed;
this.applyStyle(style)
},
onSelectSize:function(combo){
var style={};
style[combo.itemId]=parseInt(combo.getRawValue(),10);
this.applyStyle(style);
this.focusOnEditor()
},
onLetterSpacing:function(combo){
var space=parseInt(combo.getRawValue(),10);
if(isNaN(space)){
space=null
}
var style={};
style[combo.itemId]=space;
this.applyStyle(style);
this.focusOnEditor()
},
onSelect:function(combo){
var style={};
style[combo.itemId]=combo.getValue();
this.applyStyle(style);
this.focusOnEditor()
},
toggleHighlight:function(button){
this.applyStyle({highlight:button.pressed?button.color:null})
},
changeHighlight:function(opts,color){
this.applyStyle({highlight:color})
},
changeShadow:function(btn,shadow){
this.applyStyle({shadow:shadow||false})
},
applyStyle:function(style){
this.app.invoker.execute(new web.commands.stylesheets.EditStyle({
style:this.textStyle,
newStyle:style
}))
},
focusOnEditor:function(){
this.app.workspace.rte.editor.focus()
},
popupGoogleWebFonts:function(){
this.app.windows.show({
type:'web.windows.GoogleWebFonts',
values:{
myOkHandler:function(selectedFont){
if(selectedFont!==null){
this.font.setValue(selectedFont);
this.onSelect(this.font);
this.font.resetStyle()
}
},
scope:this
}
})
}
});
Ext.ComponentMgr.registerType('web-props-style',web.panels.props.richtext.Style);
web.panels.props.globalstyles.texts.TextStyle=Ext.extend(web.panels.props.richtext.Style,{
xtype:'web-props-textstyle',
constructor:function(config){
web.panels.props.globalstyles.texts.TextStyle.superclass.constructor.call(this,config);
this.addEvents('changed')
},
initStylePanel:function(){
this.layoutConfig={columns:1};
this.baseCls='';
this.cls='';
this.padding=0;
this.spacingButton=new Ext.Button({
tooltip:'Character spacing',
text:'Spacing',
scale:'small',
width:100,
plugins:[new web.ui.plugins.WindowButton({
title:'Spacing',
resizable:false,
closeAction:'hide',
items:[{
xtype:'container',
cls:'hbox cross-center',
items:[
{
xtype:'label',
text:'Character spacing:',
width:120,
style:{paddingRight:'5px'}
},
this.letterSpacing
]
}]
})]
});
this.items=[
{
xtype:'label',
text:this.title,
height:15
},
{
xtype:'container',
cls:'globalstyles-groupbox',
items:[
{
xtype:'container',
layout:'hflex',
width:405,
items:[
{
xtype:'container',
layout:{
type:'table',
columns:2
},
items:[
this.font,
this.addFont
]
},
{xtype:'flexspacer'},
this.size,
{xtype:'flexspacer'},
{
xtype:'container',
cls:'web-panel-button-group-new',
style:'white-space:nowrap',
items:[
this.bold,
this.italic,
this.underline
]
},
{xtype:'flexspacer'},
{
xtype:'container',
cls:'web-panel-button-group-new',
width:75,
items:[
this.color,
this.shadow.toggleButton,
this.shadow.winButton
]
}
]
},
{
xtype:'spacer',
height:5
},
{
xtype:'container',
layout:'hauto',
layoutConfig:{align:'middle'},
items:[this.spacingButton]
}
]
},
{
xtype:'spacer',
height:5
}
]
},
applyStyle:function(style){
web.panels.props.globalstyles.texts.TextStyle.superclass.applyStyle.call(this,style);
this.fireEvent('change',style)
}
});
Ext.ComponentMgr.registerType('web-props-textstyle',web.panels.props.globalstyles.texts.TextStyle);
web.panels.props.globalstyles.texts.TextStyles=Ext.extend(Ext.Container,{
xtype:'web-props-textstyles',
initComponent:function(){
this.layout='auto';
this.layoutConfig={align:'stretch'};
this.margins='20';
this.defaults={margins:'5 0 0 0'};
web.panels.props.globalstyles.texts.TextStyles.superclass.initComponent.apply(this,arguments)
},
afterRender:function(){
web.panels.props.globalstyles.texts.TextStyles.superclass.afterRender.call(this);
this.setStylesheet(this.app.getSelected('stylesheet'))
},
setStylesheet:function(stylesheet){
this.stylesheet=stylesheet;
this.defaultStyle=stylesheet.getStyleByRef('normal','StyleText');
this.refresh()
},
refresh:function(){
var stylesheet=this.stylesheet,styles=stylesheet?stylesheet.getStylesByType('web.data.styles.StyleText'):[],types=web.data.styles.StyleText.types,ref,style,added;
this.removeAll();
var styleNormal,styleHeading1,styleHeading2,styleHeading3;
styles.forEach(function(style){
var ref=style.getRef();
if(ref==='normal'){
styleNormal=style
}else if(ref==='heading.1'){
styleHeading1=style
}else if(ref==='heading.2'){
styleHeading2=style
}else if(ref==='heading.3'){
styleHeading3=style
}
});
[
styleNormal,
styleHeading1,
styleHeading2,
styleHeading3
].filter(function(e){
return e!==undefined
}).forEach(function(style){
ref=style.getRef();
if(types[ref]){
this.add({
itemId:ref,
xtype:'web-props-textstyle',
title:types[ref].NAME,
app:this.app,
style:style
});
this.add({
xtype:'spacer',
height:10
});
added=true;
this.relayEvents(this.find('itemId',ref)[0],['change'])
}
},this);
if(!added){
ref='normal';
style=this.defaultStyle;
this.add({
itemId:ref,
xtype:'web-props-textstyle',
title:types[ref].NAME,
app:this.app,
style:style
});
this.relayEvents(this.find('itemId',ref)[0],['change'])
}
this.doLayout()
}
});
Ext.ComponentMgr.registerType('web-props-textstyles',web.panels.props.globalstyles.texts.TextStyles);
web.panels.props.globalstyles.texts.TextsTab=Ext.extend(Ext.Container,{
initComponent:function(){
this.layout='vbox';
this.layoutConfig={align:'stretch'};
this.items=[
{
xtype:'container',
cls:'gray-background hbox cross-center',
style:'padding: 5px;',
height:40,
items:[{
xtype:'container',
cls:'flex',
html:'Style the text on all your pages, by styling each text style:'
}]
},
{
flex:1,
xtype:'container',
autoScroll:true,
cls:'autoscroll',
layout:'hflex',
layoutConfig:{align:'stretchmax'},
items:[
{
xtype:'container',
layout:'auto',
style:{
verticalAlign:'top',
paddingRight:'20px',
width:'415px'
},
items:[
{
xtype:'spacer',
height:20
},
{
ref:'../../textStyles',
xtype:'web-props-textstyles',
app:this.app
}
]
},
{
xtype:'container',
layout:'auto',
layoutConfig:{align:'stretch'},
style:{
verticalAlign:'top',
borderLeft:'1px solid #CED7BD',
width:'435px'
},
items:[
{
xtype:'spacer',
height:20
},
{
xtype:'label',
text:'Preview',
height:20,
style:'padding: 0 0 9px 21px; display: block;'
},
{
ref:'../../previewDiv',
xtype:'label',
style:{
textAlign:'center',
display:'block'
},
text:'...'
}
]
}
]
}
];
web.panels.props.globalstyles.texts.TextsTab.superclass.initComponent.apply(this,arguments);
this.mon(this.previewDiv,'afterrender',this.refreshPreview,this)
},
afterRender:function(){
web.panels.props.globalstyles.texts.TextsTab.superclass.afterRender.apply(this,arguments);
this.initListeners()
},
initListeners:function(){
this.mon(this.app,'update',function(part){
if(part instanceof web.data.styles.Style){
var root=part.getRootStyle();
if(root instanceof web.data.styles.StyleText&&root.inStylesheet()){
this.refreshPreview()
}
}
},this)
},
setStylesheet:function(stylesheet){
this.stylesheet=stylesheet;
this.textStyles.setStylesheet(stylesheet);
this.refreshPreview()
},
refreshPreview:function(){
var stylesheet=this.app.getSelected('stylesheet'),ref,html='',element,css,gap='<div style=\'height: 25px; width: 1px;\'></div>',types=web.data.styles.StyleText.types,style,config={
currentBg:'#f1f7e2',
newBg:'#afbf8c'
},bgcolorCss;
for(ref in types){
if(types.hasOwnProperty(ref)){
style=stylesheet.getStyleByRef(ref,'StyleText');
if(style){
css=style.getCSSDeclarations()
}else{
css=''
}
if(style.color&&Math.abs(style.color.lightness()-one.color(config.currentBg).lightness())<Math.abs(style.color.lightness()-one.color(config.newBg).lightness())){
bgcolorCss='background-color:'+config.newBg+';'
}else{
bgcolorCss=''
}
element='<div style=\''+css+bgcolorCss+'display:table;height:69px;width:100%;\'>'+'<div style=\'display:table-cell; vertical-align:middle;\'>'+types[ref].NAME+'</div></div>';
html+=element+gap
}
}
if(this.previewDiv.el&&this.previewDiv.el.dom){
this.previewDiv.el.dom.innerHTML=html
}
}
});
Ext.reg('web-globalstyles-texts',web.panels.props.globalstyles.texts.TextsTab);
Ext.ns('web.panels.props.globalstyles.links');
web.panels.props.globalstyles.links.LinkState=Ext.extend(Ext.Container,{
xtype:'web-props-linkstate',
constructor:function(config){
web.panels.props.globalstyles.links.LinkState.superclass.constructor.call(this,config)
},
initComponent:function(){
this.baseCls='x-btn-group';
this.cls='web-prop-btn-group globalstyles-groupbox';
this.frame=true;
this.layout='table';
this.width=425;
this.height=42;
this.underline=new Ext.Button({
itemId:'underline',
tooltip:'Underline.',
iconCls:'icon icon-rte-underline',
scale:'small',
enableToggle:true,
handler:this.onClick,
scope:this
});
this.color=new Ext.Button({
itemId:'color',
tooltip:'Text color.',
iconCls:'icon icon-rte-forecolor',
scale:'small',
listeners:{
winshow:function(btn,win){
win.picker.setColor(btn.color,true,true);
win.picker.updateTransparencySlider(btn.color)
},
scope:this
},
plugins:[
new web.ui.plugins.ColorButton,
new web.ui.plugins.WindowButton({
app:this.app,
title:'Text Color',
width:285,
cls:'color-panel-window',
items:{
ref:'picker',
xtype:'web-colorpanel',
listeners:{
change:function(btn,color){
this.color.setColor(color);
this.onPick(btn,color)
},
scope:this
}
}
})
]
});
this.highlight=new web.ui.buttons.Highlight({
app:this.app,
listeners:{
change:this.changeHighlight,
toggle:this.toggleHighlight,
scope:this
}
});
this.shadow=new web.ui.buttons.Shadow({
tooltip:'Text shadow settings.',
app:this.app,
listeners:{
change:this.changeShadow,
toggle:this.toggleShadow,
scope:this
}
});
this.layoutConfig={columns:5};
this.items=[
this.underline,
{
xtype:'spacer',
width:30
},
{
xtype:'container',
layout:'hauto',
width:125,
height:22,
cls:'button-group',
items:[
this.highlight.toggleButton,
this.highlight.winButton,
this.color,
this.shadow.toggleButton,
this.shadow.winButton
]
}
];
web.panels.props.globalstyles.links.LinkState.superclass.initComponent.apply(this,arguments);
this.addEvents('refresh')
},
afterRender:function(){
web.panels.props.globalstyles.links.LinkState.superclass.afterRender.call(this);
this.initMyListeners()
},
initMyListeners:function(){
var stylesheet;
this.app.on('select',function(part,cfg){
if(part instanceof web.data.styles.Stylesheet){
this.setStylesheet(part)
}
},this);
this.app.on('update',function(part){
if(part.getRoot()instanceof web.data.styles.Stylesheet){
this.refresh()
}
},this);
stylesheet=this.app.getSelected('stylesheet');
if(stylesheet){
this.setStylesheet.defer(350,this,[stylesheet])
}
},
setStylesheet:function(stylesheet,ref){
if('undefined'===typeof ref){
ref=this.part&&this.part.ref?this.part.ref:'link.1'
}
this.stylesheet=stylesheet;
this.part=stylesheet.getStyleByRef(ref,'StyleLink');
this.defaultStyle=stylesheet.getStyleByRef('normal','StyleText');
this.refresh()
},
refresh:function(){
var color,highlight,shadow,underline,style,part=this.part;
if(!part){
return
}
style=part[this.itemId];
if(style){
underline=style.isUnderline();
color=style.getColor();
highlight=style.getHighlight();
shadow=style.getShadow()
}
this.underline.toggle(!!underline);
this.color.setColor(color?color:new one.color.RGB(0,0,0));
this.highlight.setColor(highlight);
this.shadow.suspendEvents();
this.shadow.toggle(!!shadow);
if(shadow){
this.shadow.setShadow(shadow)
}
this.shadow.resumeEvents();
this.fireEvent('refresh')
},
onPick:function(button,color){
this.applyStyle({color:color})
},
onClick:function(button){
var style={};
style[button.itemId]=button.pressed;
this.applyStyle(style)
},
toggleHighlight:function(button){
this.applyStyle({highlight:button.pressed?button.color:null})
},
changeHighlight:function(picker,color){
if(this.highlight.toggleButton.pressed){
this.applyStyle({highlight:color})
}
},
toggleShadow:function(button){
this.applyStyle({shadow:this.shadow.toggleButton.pressed?this.shadow.getShadow():null})
},
changeShadow:function(shadowBtn,shadow){
if(this.shadow.toggleButton.pressed){
this.app.invoker.execute(new web.commands.stylesheets.EditStyle({
style:this.part[this.itemId],
newStyle:{shadow:shadow}
}))
}
},
applyStyle:function(style){
this.app.invoker.execute(new web.commands.stylesheets.EditStyle({
style:this.part[this.itemId],
newStyle:style
}));
this.fireEvent('refresh')
}
});
Ext.ComponentMgr.registerType('web-props-linkstate',web.panels.props.globalstyles.links.LinkState);
web.panels.props.globalstyles.links.LeafDeco=Ext.extend(Ext.Container,{
xtype:'web-props-links-leafdeco',
initComponent:function(config){
this.layout='table';
this.layoutConfig={columns:2};
this.items=[{
xtype:'container',
layout:'table',
layoutConfig:{columns:1},
height:100,
items:[
{
xtype:'label',
text:this.title
},
{
xtype:'label',
text:this.description,
style:'color: #888; font-size: 9px; '
},
{
xtype:'spacer',
height:5
},
{
xtype:'container',
ref:'../plogsContainer',
height:20,
items:this.plogs
},
{
xtype:'spacer',
height:5
}
]
}];
web.panels.props.globalstyles.links.LeafDeco.superclass.initComponent.apply(this,arguments);
this.addEvents('refresh');
var i;
for(i=0;i<this.plogsContainer.items.items.length;i+=1){
this.plogsContainer.items.items[i].on('refresh',this.onRefresh,this)
}
},
setStylesheet:function(stylesheet,ref){
var i;
for(i=0;i<this.plogsContainer.items.items.length;i+=1){
this.plogsContainer.items.items[i].setStylesheet(stylesheet,ref)
}
},
onRefresh:function(){
this.fireEvent('refresh')
}
});
Ext.reg('web-props-links-leafdeco',web.panels.props.globalstyles.links.LeafDeco);
web.panels.props.globalstyles.links.LinksTab=Ext.extend(web.panels.Panel,{
xtype:'web-globalstyles-links',
initComponent:function(){
this.addStyleButton=new Ext.Button({
text:'New link style (Duplicate)',
handler:this.onAddStyle,
scope:this
});
this.stylesheet=this.app.getSelected('stylesheet');
this.selectedLinkStyle=this.getStyleLinks()[0];
this.links=[
{
item:'normalLink',
func:'getInactive',
label:'A normal link'
},
{
item:'hoverLink',
func:'getHover',
label:'Mouse Over'
},
{
item:'visitedLink',
func:'getVisited',
label:'Visited'
},
{
item:'activeLink',
func:'getPress',
label:'Active'
}
];
this.layout='vbox';
this.layoutConfig={align:'stretch'};
this.items=[
{
xtype:'container',
cls:'gray-background hbox cross-center',
style:'padding: 5px;',
height:40,
items:[
{
xtype:'container',
cls:'flex',
html:'Select a link style to edit:'
},
{
xtype:'spacer',
width:10,
height:10
},
{
xtype:'combo',
ref:'../linkStyleCombo',
store:this.getLinkStylesDataStore(),
margins:'0 10 0 0',
width:125,
mode:'local',
valueField:'id',
displayField:'text',
triggerAction:'all',
editable:false,
forceSelection:true,
listeners:{
select:function(combo){
this.setStyleLink(this.app.dm.get(combo.getValue()))
},
scope:this
}
},
{
xtype:'spacer',
width:10,
height:10
},
this.addStyleButton,
{
xtype:'spacer',
width:10,
height:10
},
{
xtype:'button',
ref:'../deleteLinkStyleButton',
text:'Delete this link style',
tooltip:'Link Style is in use',
disabled:true,
listeners:{
click:function(button){
this.deleteSelectedLinkStyle()
},
enable:function(button){
button.setTooltip('')
},
disable:function(button){
button.setTooltip(button.initialConfig.tooltip)
},
scope:this
}
}
]
},
{
flex:1,
xtype:'container',
autoScroll:true,
cls:'autoscroll',
layout:'hflex',
layoutConfig:{align:'stretchmax'},
items:[
{
xtype:'container',
layout:'auto',
style:{
verticalAlign:'top',
paddingRight:'20px',
width:'415px'
},
items:[
{
xtype:'spacer',
height:20
},
{
xtype:'web-props-links-leafdeco',
ref:'../../inactiveLinksWidget',
title:'Link State: Normal',
description:'Use these additional styling options to further style the normal links.',
app:this.app,
itemId:'inactive',
plogs:[{
itemId:'inactive',
xtype:'web-props-linkstate',
title:'Normal',
app:this.app
}]
},
{
xtype:'web-props-links-leafdeco',
ref:'../../hoverLinksWidget',
title:'Link State: Mouse over',
description:'These additional styling options are activated when you move your mouse over a link.',
app:this.app,
itemId:'hover',
plogs:[{
itemId:'hover',
xtype:'web-props-linkstate',
title:'Mouse Over',
app:this.app
}]
},
{
itemId:'visited',
xtype:'web-props-links-leafdeco',
ref:'../../visitedLinksWidget',
title:'Link State: Visited',
description:'These additional styling options are activated after your visitor has clicked the link.',
app:this.app,
plogs:[{
itemId:'visited',
xtype:'web-props-linkstate',
title:'Visited',
app:this.app
}]
},
{
itemId:'press',
ref:'../../pressLinksWidget',
xtype:'web-props-links-leafdeco',
title:'Link State: Active',
description:'These additional styling options are activated the moment you click a link.',
app:this.app,
plogs:[{
itemId:'press',
xtype:'web-props-linkstate',
title:'Active',
app:this.app
}],
last:true
}
]
},
{
xtype:'container',
layout:'auto',
layoutConfig:{align:'stretch'},
height:400,
style:{
verticalAlign:'top',
borderLeft:'1px solid #CED7BD',
width:'425px'
},
items:[
{
xtype:'spacer',
height:20
},
{
xtype:'label',
text:'Preview',
height:20,
style:'padding: 0 0 9px 21px; display: block;'
},
{
xtype:'container',
cls:'vbox cross-center',
items:[
{
xtype:'label',
ref:'../../../normalLink',
text:this.links[0].label,
style:'padding-top: 20px; min-height: 100px'
},
{
xtype:'label',
ref:'../../../hoverLink',
text:this.links[1].label,
style:'min-height: 100px'
},
{
xtype:'label',
ref:'../../../visitedLink',
text:this.links[2].label,
style:'min-height: 100px'
},
{
xtype:'label',
ref:'../../../activeLink',
text:this.links[3].label,
style:'min-height: 100px'
}
]
}
]
}
]
}
];
web.panels.props.globalstyles.links.LinksTab.superclass.initComponent.apply(this,arguments);
this.inactiveLinksWidget.on('refresh',this.preview,this);
this.hoverLinksWidget.on('refresh',this.preview,this);
this.visitedLinksWidget.on('refresh',this.preview,this);
this.pressLinksWidget.on('refresh',this.preview,this);
this.normalLink.on('afterrender',function(){
var that=this;
setTimeout(function(){
that.preview()
},1000)
},this);
this.addEvents('update');
this.textNormalStyle=this.stylesheet.getStyleByRef('normal','StyleText');
this.linkStyleCombo.bindStore(this.getLinkStylesDataStore());
this.linkStyleCombo.setValue(this.selectedLinkStyle.getId());
this.preview()
},
initListeners:function(){
var that=this;
this.app.on('update',function(part){
if(part instanceof web.data.styles.Stylesheet){
that.linkStyleCombo.bindStore(that.getLinkStylesDataStore());
that.stylesheet=that.app.getSelected('stylesheet');
that.selectedLinkStyle=that.getStyleLinks()[0];
that.linkStyleCombo.setValue(that.selectedLinkStyle.getId())
}
})
},
setStylesheet:function(stylesheet){
var that=this,ref;
that.stylesheet=stylesheet;
that.styleLink=that.getStyleLinks(stylesheet)[0];
that.setStyleLink(that.styleLink);
that.textNormalStyle=stylesheet.getStyleByRef('normal','StyleText');
that.linkStyleCombo.bindStore(that.getLinkStylesDataStore());
that.linkStyleCombo.setValue(that.styleLink.id);
ref=that.styleLink.getRef();
that.inactiveLinksWidget.setStylesheet(stylesheet,ref);
that.hoverLinksWidget.setStylesheet(stylesheet,ref);
that.visitedLinksWidget.setStylesheet(stylesheet,ref);
that.pressLinksWidget.setStylesheet(stylesheet,ref);
that.preview()
},
preview:function(){
var notRendered=0,afterRender=function(){
notRendered-=1;
if(notRendered===0){
this.preview()
}
},waitForRender=function(components,scope){
if(notRendered>0){
return true
}
var i;
for(i=0;i<components.length;i+=1){
if(!components[i].rendered){
notRendered+=1;
components[i].on('afterrender',afterRender,scope,{single:true})
}
}
if(notRendered>0){
return true
}
return false
};
return function(){
var that=this,components=[],i,comp,css,text;
for(i=0;i<that.links.length;i+=1){
comp=that[that.links[i].item];
components.push(comp)
}
if(waitForRender(components,that)){
return
}
var el,textNormalCss=that.textNormalStyle.getCSSDeclarations(),selectedLinkStyle=that.app.dm.get(that.selectedLinkStyle.getId());
if(typeof selectedLinkStyle==='undefined'){
that.selectedLinkStyle=that.getStyleLinks()[0]
}
for(i=0;i<that.links.length;i+=1){
comp=that[that.links[i].item];
text=that.links[i].label;
comp.update('<span style=\''+textNormalCss+'\'>'+text+'</span>');
el=comp.getEl().dom.firstChild;
css=that.selectedLinkStyle[that.links[i].func]().getCSSDeclarations();
web.utils.Dom.applyCSS(el,css)
}
}
}(),
getStyleLinks:function(stylesheet){
return this.app.getSelected('stylesheet').getStylesByType('web.data.styles.StyleLink')
},
getLinkStylesDataStore:function(){
var data=this.getStyleLinks().map(function(style){
return[
style.getId(),
'Link Style '+style.getRef().replace(/^link\./,'')
]
});
return new Ext.data.ArrayStore({
fields:[
'id',
'text'
],
data:data
})
},
onAddStyle:function(btn){
var styleLinks=this.stylesheet.getStylesByType('web.data.styles.StyleLink'),ref,cfg;
ref=function(styles){
var firstAvailableIndex,refs=styles.map(function(style){
var idx=parseInt(style.getRef().replace(/^link\./,''),10);
return isNaN(idx)?0:idx
});
refs.sort(function(a,b){
return a-b
});
firstAvailableIndex=refs[0]-1;
refs.some(function(ref){
firstAvailableIndex+=1;
return ref!==firstAvailableIndex
});
if(firstAvailableIndex===refs[refs.length-1]){
firstAvailableIndex+=1
}
return firstAvailableIndex.toString()
}(styleLinks);
var json=this.selectedLinkStyle.toJSON();
json.ref='link.'+ref;
json.name='[ link '+ref+']';
delete json.id;
cfg=this.app.dm.create(json);
this.app.invoker.execute(new web.commands.stylesheets.AddStyle({
style:cfg,
stylesheet:this.stylesheet
}));
this.setValues({style:cfg},true)
},
setValues:function(values,isNewStyle){
var that=this;
if(values.style!==undefined){
that.linkStyleCombo.bindStore(that.getLinkStylesDataStore());
that.setStyleLink(values.style,isNewStyle);
that.preview()
}
},
setStyleLink:function(style,isNewStyle){
var that=this;
that.selectedLinkStyle=style;
that.selectedLinkStyleId=style.getId();
that.linkStyleCombo.setValue(style.getId());
if(isNewStyle){
that.deleteLinkStyleButton.enable()
}else{
that.setDeleteStyleButtonState(style)
}
that.inactiveLinksWidget.setStylesheet(that.stylesheet,style.getRef());
that.hoverLinksWidget.setStylesheet(that.stylesheet,style.getRef());
that.visitedLinksWidget.setStylesheet(that.stylesheet,style.getRef());
that.pressLinksWidget.setStylesheet(that.stylesheet,style.getRef())
},
setDeleteStyleButtonState:function(linkStyle){
var that=this;
that.deleteLinkStyleButton.disable();
if(that.stylesheet.getStylesByType('web.data.styles.StyleLink').length===1){
return
}
that.app.dal.getDocsWithProperty('globalId',linkStyle.getId(),function(opts,success,response){
if(success){
var currentDocTypesToCheck=[
'page',
'template'
],found=false;
Ext.decode(response.responseText).forEach(function(doc){
var type=doc.type.split('.').reverse()[0].toLowerCase(),currentDoc;
if(!found&&type==='template'||type==='page'){
currentDoc=that.app.getSelected(type);
if(currentDoc.id===doc.id){
if(that.isDocUsingLinkStyle(currentDoc,linkStyle)){
found=true
}else{
currentDocTypesToCheck.remove(type)
}
}else{
found=true
}
}
},that);
if(!found){
currentDocTypesToCheck.forEach(function(type){
if(that.isDocUsingLinkStyle(that.app.getSelected(type),linkStyle)){
found=true
}
},that)
}
if(!found){
that.deleteLinkStyleButton.enable()
}
}
},that)
},
isDocUsingLinkStyle:function(doc,linkStyle){
doc=doc.toJSON?doc.toJSON():doc;
function extractObjectsFromArray(array){
var objects=[];
array.forEach(function(obj){
if(Ext.isArray(obj)){
Array.prototype.push.apply(objects,extractObjectsFromArray(obj))
}else if(Ext.isObject(obj)){
objects.push(obj)
}
});
return objects
}
var styleId=linkStyle.getId(),components=[doc],prop,obj;
while(components.length){
obj=components.shift();
if(obj.globalId===styleId){
return true
}
for(prop in obj){
if(obj.hasOwnProperty(prop)){
if(Ext.isObject(obj[prop])){
components.push(obj[prop])
}else if(Ext.isArray(obj[prop])){
Array.prototype.push.apply(components,extractObjectsFromArray(obj[prop]))
}
}
}
}
return false
},
deleteSelectedLinkStyle:function(){
var that=this;
that.app.invoker.execute(new web.commands.stylesheets.DeleteStyle({
style:that.selectedLinkStyle,
stylesheet:that.stylesheet
}));
that.selectedLinkStyle=that.getStyleLinks()[0];
that.linkStyleCombo.bindStore(that.getLinkStylesDataStore());
this.setStyleLink(this.app.dm.get(that.selectedLinkStyle.getId()))
}
});
Ext.ComponentMgr.registerType('web-globalstyles-links',web.panels.props.globalstyles.links.LinksTab);
Ext.ns('web.panels.props.globalstyles.menus');
web.windows.blockProps.Padding=Ext.extend(web.windows.Window,{
type:'web.windows.blockProps.Padding',
title:'Spacing',
initComponent:function(){
this.resizable=false;
var spacing={
ref:'frameField',
xtype:'web-ui-fields-framefield',
listeners:{
change:this.onChangePadding,
togglelock:this.onToggleLock,
scope:this
}
};
this.items=this.items||[];
if(this.items[2]){
spacing.ref='../frameField';
this.items[2].items.push(spacing)
}else{
this.items.push(spacing)
}
this.addEvents('change','toggle');
web.windows.blockProps.Padding.superclass.initComponent.apply(this,arguments)
},
setValues:function(style){
if(!style){
style=[
0,
0,
0,
0
]
}
this.initialStyle=style;
this.frameField.setValue({
top:style[0]||0,
right:style[1]||0,
bottom:style[2]||0,
left:style[3]||0
})
},
getValue:function(){
return this.frameField.getValue()
},
setMaxLimits:function(values){
this.frameField.setMaxLimits(values)
},
isLocked:function(){
return this.frameField.isLocked()
},
isValid:function(){
return this.frameField.isValid()
},
onChangePadding:function(frameField,padding,changed){
var val={};
if(changed==='all'){
val=padding
}else{
val[changed]=padding[changed]
}
this.fireEvent('change',{padding:val})
},
onToggleLock:function(frameField,pressed){
this.fireEvent('toggle',pressed)
}
});
web.panels.props.globalstyles.menus.CommonStyle=Ext.extend(Ext.Container,{
fontId:null,
fontSize:null,
bold:null,
italic:null,
horizontalAlign:null,
border:null,
spacing:null,
initComponent:function(){
var noNullToggle=function(button,state){
if(state){
button.disable()
}else{
button.enable()
}
},spacingTitle;
this.layout='hauto';
this.layoutConfig={padding:'0 20 0 20'};
this.left=new Ext.Button({
itemId:'left',
iconCls:'icon icon-rte-justifyleft',
tooltip:'Align left.',
scale:'small',
enableToggle:true,
pressed:!this.horizontalAlign||this.horizontalAlign==='left',
toggleGroup:'align',
toggleHandler:noNullToggle,
handler:this.onJustifyClick,
scope:this
});
this.center=new Ext.Button({
itemId:'center',
iconCls:'icon icon-rte-justifycenter',
tooltip:'Align center.',
scale:'small',
enableToggle:true,
pressed:this.horizontalAlign==='center',
toggleGroup:'align',
toggleHandler:noNullToggle,
handler:this.onJustifyClick,
scope:this
});
this.right=new Ext.Button({
itemId:'right',
iconCls:'icon icon-rte-justifyright',
tooltip:'Align right.',
scale:'small',
enableToggle:true,
pressed:this.horizontalAlign==='right',
toggleGroup:'align',
toggleHandler:noNullToggle,
handler:this.onJustifyClick,
scope:this
});
this.lowercase=new Ext.Button({
itemId:'lowercase',
iconCls:'icon icon-rte-lowercase',
scale:'small',
enableToggle:true,
pressed:this.textTransform==='lowercase',
toggleGroup:'textTransform',
toggleHandler:this.onTransformClick,
scope:this
});
this.uppercase=new Ext.Button({
itemId:'uppercase',
iconCls:'icon icon-rte-uppercase',
scale:'small',
enableToggle:true,
pressed:this.textTransform==='uppercase',
toggleGroup:'textTransform',
toggleHandler:this.onTransformClick,
scope:this
});
this.fontSizeCombo=new web.ui.ComboBox({
xtype:'combo',
itemId:'size',
store:[
9,
10,
11,
12,
13,
14,
15,
16,
18,
20,
22,
24,
26,
28,
32,
36,
40,
44,
48,
54,
60,
66,
72,
80,
88,
96
],
triggerAction:'all',
value:this.fontSize,
width:50,
maxNumber:999,
minNumber:9,
listeners:{
select:this.onSelectSize,
render:function(combo){
combo.tip=new Ext.ToolTip({
target:combo.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:'Font size'
}
})
},
keyup:function(combo,e){
if(e.getCharCode()===13){
this.onSelectSize(combo)
}
},
scope:this
}
});
this.spacingFrame=new web.ui.fields.FrameField({
listeners:{
change:this.onPaddingChange,
scope:this
}
});
spacingTitle='Spacing';
this.spacingWidget=new Ext.Button({
xtype:'button',
text:spacingTitle,
width:100,
plugins:new web.ui.plugins.WindowButton({
title:spacingTitle,
closeAction:'hide',
items:[this.spacingFrame]
})
});
this.items=[{
xtype:'container',
items:[
{
xtype:'label',
text:this.title,
style:{
padding:'0 0 9px 0',
display:'block'
}
},
{
xtype:'container',
width:420,
cls:'globalstyles-groupbox',
items:[
{
xtype:'container',
layout:'hflex',
items:[
{
xtype:'web-combobox-fonts',
ref:'../../../fontIdCombo',
value:this.fontId,
width:143,
app:this.app,
listeners:{
select:function(combo,record,index){
combo.resetStyle();
this.fontId=combo.getValue();
this.fireEvent('changed',this,'fontid',combo.getValue())
},
render:function(combo){
combo.tip=new Ext.ToolTip({
target:combo.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:'Font family.'
}
})
},
scope:this
}
},
{
itemId:'addFont',
xtype:'button',
text:'+',
tooltip:'Add font from Google Web Fonts.',
scale:'small',
handler:function(){
this.popupGoogleWebFonts()
},
scope:this
},
{xtype:'flexspacer'},
this.fontSizeCombo,
{xtype:'flexspacer'},
{
xtype:'container',
cls:'web-panel-button-group-new',
style:'white-space:nowrap',
items:[
{
xtype:'button',
ref:'../../../../boldButton',
iconCls:'icon icon-rte-bold',
tooltip:'Bold.',
enableToggle:true,
pressed:this.bold,
handler:function(b,e){
this.bold=b.pressed;
this.fireEvent('changed',this,'bold',b.pressed)
},
scope:this
},
{
xtype:'button',
ref:'../../../../italicButton',
iconCls:'icon icon-rte-italic',
tooltip:'Italic.',
enableToggle:true,
pressed:this.italic,
handler:function(b,e){
this.italic=b.pressed;
this.fireEvent('changed',this,'italic',b.pressed)
},
scope:this
}
]
}
]
},
{
xtype:'spacer',
width:5,
height:5
},
{
xtype:'container',
layout:'hauto',
layoutConfig:{padding:'5 0 0 0'},
items:[
{
xtype:'container',
cls:'web-panel-button-group-new',
items:[
this.left,
this.center,
this.right
]
},
{
xtype:'spacer',
width:12
},
{
xtype:'container',
cls:'web-panel-button-group-new',
items:[
this.lowercase,
this.uppercase
]
},
{
xtype:'spacer',
width:12
},
{
xtype:'button',
ref:'../../../borderWidget',
text:'Border',
plugins:new web.ui.plugins.WindowButton({
type:'web.windows.blockProps.Border',
app:this.app,
listeners:{
adjust:function(cfg){
this.fireEvent('changed',this,'border',cfg)
},
scope:this
}
}),
styleType:'border',
listeners:{
winshow:function(button,win){
var c=this.border.color,w=this.border.width,s=this.border.style,dash={
color:[
c.top,
c.right,
c.bottom,
c.left
],
style:[
s.top,
s.right,
s.bottom,
s.left
],
width:[
w.top,
w.right,
w.bottom,
w.left
]
};
win.setValues(dash)
},
scope:this
}
}
]
},
{
xtype:'spacer',
width:5,
height:5
},
{
xtype:'container',
layout:'hflex',
layoutConfig:{padding:'5 0 0 0'},
items:[
this.spacingWidget,
{
xtype:'spacer',
width:100,
height:1
}
]
}
]
}
]
}];
web.panels.props.globalstyles.menus.CommonStyle.superclass.initComponent.apply(this,arguments);
this.addEvents('changed')
},
onSelectSize:function(combo){
this.fontSize=parseInt(combo.getRawValue(),10);
this.fireEvent('changed',this,'fontsize',this.fontSize)
},
onJustifyClick:function(button){
this.horizontalAlign=button.itemId;
this.fireEvent('changed',this,'horizontalAlign',button.itemId)
},
onTransformClick:function(button,toggle){
var value=toggle?button.itemId:null;
this.textTransform=value;
this.fireEvent('changed',this,'transform',value)
},
onPaddingChange:function(frameField,padding,changed){
this.spacing=padding;
this.fireEvent('changed',this,'spacing',{padding:padding})
},
setValues:function(values){
Ext.apply(this,values);
this.refresh()
},
refresh:function(){
this.fontIdCombo.setValue(this.fontId);
this.fontSizeCombo.setValue(this.fontSize);
this.boldButton.toggle(this.bold);
this.italicButton.toggle(this.italic);
switch(this.horizontalAlign){
case'left':
this.left.toggle(true);
break;
case'center':
this.center.toggle(true);
break;
case'right':
this.right.toggle(true);
break
}
switch(this.textTransform){
case'lowercase':
this.lowercase.toggle(true,true);
break;
case'uppercase':
this.uppercase.toggle(true,true);
break;
default:
this.lowercase.toggle(false,true);
this.uppercase.toggle(false,true);
break
}
this.spacingFrame.setValue([
this.spacing.top,
this.spacing.right,
this.spacing.bottom,
this.spacing.left
])
},
popupGoogleWebFonts:function(){
this.app.windows.show({
type:'web.windows.GoogleWebFonts',
values:{
myOkHandler:function(selectedFont){
if(selectedFont!==null){
this.fontIdCombo.setValue(selectedFont);
this.fireEvent('changed',this,'fontid',this.fontIdCombo.getValue());
this.fontIdCombo.resetStyle()
}
},
scope:this
}
})
}
});
Ext.reg('web-globalstyles-menus-commonstyle',web.panels.props.globalstyles.menus.CommonStyle);
web.panels.props.globalstyles.menus.OverrideStyle=Ext.extend(Ext.Container,{
underline:null,
color:null,
shadow:null,
background:null,
corners:null,
initComponent:function(config){
if(!this.items){
this.initOverrideStyle()
}
web.panels.props.globalstyles.menus.OverrideStyle.superclass.initComponent.apply(this,arguments);
this.addEvents('changed')
},
initOverrideStyle:function(config){
this.highlightColor=new one.color.RGB(1,1,0);
this.layout='hauto';
this.layoutConfig={align:'stretchmax'};
this.underlineButton=new Ext.Button({
iconCls:'icon icon-rte-underline',
enableToggle:true,
tooltip:'Underline.',
pressed:this.underline,
handler:function(b,e){
this.underline=b.pressed;
this.fireEvent('changed',this,'underline',b.pressed)
},
scope:this
});
this.foreColorButton=new Ext.Button({
iconCls:'icon icon-rte-forecolor',
scale:'small',
tooltip:'Text color.',
color:this.color,
listeners:{
winshow:function(btn,win){
var picker=win.picker;
picker.suspendEvents();
picker.setColor(btn.color,true,true);
picker.updateTransparencySlider(btn.color);
picker.resumeEvents()
},
scope:this
},
plugins:[
new web.ui.plugins.ColorButton,
new web.ui.plugins.WindowButton({
title:'Text Color',
width:285,
cls:'color-panel-window',
items:{
ref:'picker',
xtype:'web-colorpanel',
listeners:{
change:function(btn,color){
this.foreColorButton.setColor(color);
this.fireEvent('changed',this,'foreColor',color)
},
scope:this
}
}
})
]
});
this.shadowButton=new web.ui.buttons.Shadow({
tooltip:'Text shadow settings.',
listeners:{
change:function(button,change){
if(change===null){
change=false
}
this.fireEvent('changed',this,'shadow',change)
},
scope:this
}
});
this.textButtons=[
this.underlineButton,
{
xtype:'spacer',
width:73
},
{
xtype:'container',
layout:'hauto',
height:22,
cls:'button-group',
items:[
this.foreColorButton,
this.shadowButton.toggleButton,
this.shadowButton.winButton
]
}
];
this.backgroundButton=new Ext.Button({
xtype:'button',
width:80,
text:'Background',
plugins:new web.ui.plugins.WindowButton({
type:'web.windows.blockProps.Background',
app:this.app,
listeners:{
adjust:function(change){
this.fireEvent('changed',this,'background',change)
},
scope:this
}
}),
listeners:{
winshow:function(button,win){
win.setValues(this.background)
},
scope:this
}
});
this.items=[
{
xtype:'container',
width:310,
layout:'auto',
style:'display:table;',
items:[
{
xtype:'container',
width:35,
style:'display:table-cell;'
},
{
xtype:'container',
width:275,
layout:'auto',
style:'padding-left: 25px;border-left: 1px solid #CED7BD;display:table-cell;',
items:[
{
xtype:'spacer',
height:5
},
{
xtype:'label',
style:'display:block;',
text:this.title
},
{
xtype:'label',
text:this.description,
style:'color: #888; font-size: 10px; white-space: normal; '
},
{
xtype:'spacer',
height:5
}
]
}
]
},
{
xtype:'container',
width:310,
layout:'auto',
style:'display:table;',
items:[
{
xtype:'container',
width:35,
style:'display:table-cell;'
},
{
xtype:'container',
width:25,
style:'display:table-cell;',
items:[
{
xtype:'container',
height:34,
style:'border-left:1px solid #CED7BD;border-bottom:1px solid #CED7BD;'
},
{
xtype:'container',
height:34,
style:this.last?'':'border-left: 1px solid #CED7BD;'
}
]
},
{
xtype:'container',
cls:'globalstyles-groupbox',
style:'white-space:nowrap;display:table-cell;float:left;',
width:192,
height:68,
items:[
{
xtype:'container',
layout:'hauto',
items:this.textButtons
},
{
xtype:'spacer',
height:5
},
{
xtype:'container',
layout:'hauto',
items:[
this.backgroundButton,
{
xtype:'spacer',
width:12
},
{
xtype:'button',
ref:'../../../cornersWidget',
width:80,
text:'Corners',
plugins:new web.ui.plugins.WindowButton({
type:'web.windows.blockProps.Corners',
app:this.app,
listeners:{
adjust:function(change){
this.fireEvent('changed',this,'corners',change)
},
scope:this
}
}),
listeners:{
winshow:function(button,win){
win.setValues(this.corners)
},
scope:this
}
}
]
}
]
}
]
}
]
},
setValues:function(values){
Ext.apply(this,values);
this.refresh()
},
refresh:function(){
this.underlineButton.toggle(this.underline);
this.foreColorButton.color=this.color;
this.foreColorButton.setColor(this.color);
this.shadowButton.setShadow(this.shadow)
}
});
Ext.reg('web-globalstyles-menus-overridestyle',web.panels.props.globalstyles.menus.OverrideStyle);
web.panels.props.globalstyles.menus.ExpandableStyle=Ext.extend(web.panels.props.globalstyles.menus.OverrideStyle,{
padding:null,
initComponent:function(){
var buttons;
this.initOverrideStyle();
buttons=[this.backgroundButton];
if(this.namespace==='expandable'){
buttons=buttons.concat([
{
xtype:'spacer',
width:12
},
{
xtype:'button',
ref:'../../../spacingWidget',
width:80,
text:'Spacing',
plugins:new web.ui.plugins.WindowButton({
type:'web.windows.blockProps.Padding',
app:this.app,
listeners:{
change:function(value){
var spacing=this.spacingWidget.win.getValue();
this.fireEvent('changed',this,'spacing',{padding:spacing})
},
scope:this
}
}),
listeners:{
winshow:function(button,win){
win.setValues(this.padding.toJSON())
},
scope:this
}
}
])
}
this.items=[
{
xtype:'container',
width:420,
layout:'auto',
style:'display:table;',
items:[
{
xtype:'container',
width:34,
style:'display:table-cell;'
},
{
xtype:'container',
width:372,
layout:'auto',
style:'padding-left: 25px;border-left: 1px solid #CED7BD;display:table-cell;',
items:[
{
xtype:'spacer',
height:5
},
{
xtype:'label',
style:'display:block;',
text:this.title
},
{
xtype:'label',
text:this.description,
style:'color: #888; font-size: 10px; white-space: normal; '
},
{
xtype:'spacer',
height:5
}
]
}
]
},
{
xtype:'container',
width:430,
layout:'auto',
style:'display:table;',
items:[
{
xtype:'container',
width:35,
style:'display:table-cell;'
},
{
xtype:'container',
width:25,
style:'display:table-cell;',
items:[
{
xtype:'container',
height:34,
style:'border-left:1px solid #CED7BD;border-bottom:1px solid #CED7BD;'
},
{
xtype:'container',
height:34,
style:this.last?'':'border-left: 1px solid #CED7BD;'
}
]
},
{
xtype:'container',
cls:'globalstyles-groupbox',
style:'white-space:nowrap;display:table-cell;float:left;',
width:350,
height:68,
items:[
{
xtype:'container',
layout:'hauto',
items:this.textButtons
},
{
xtype:'spacer',
height:5
},
{
xtype:'container',
layout:'hauto',
items:buttons
}
]
}
]
}
];
web.panels.props.globalstyles.menus.ExpandableStyle.superclass.initComponent.apply(this,arguments);
this.addEvents('changed')
},
setValues:function(values){
Ext.apply(this,values);
this.refresh()
},
refresh:function(){
web.panels.props.globalstyles.menus.ExpandableStyle.superclass.refresh.call(this)
}
});
Ext.reg('web-globalstyles-menus-expandablestyle',web.panels.props.globalstyles.menus.ExpandableStyle);
web.panels.props.globalstyles.menus.BlockStyle=Ext.extend(Ext.Container,{
background:null,
spacing:null,
border:null,
corners:null,
initComponent:function(){
this.layout='hauto';
this.items=[
{
xtype:'spacer',
width:20
},
{
xtype:'container',
items:[
{
xtype:'label',
text:this.title,
style:{display:'block'}
},
{
xtype:'label',
text:this.description,
style:{
width:'260px',
color:'#888',
fontSize:'10px',
padding:'0 0 5px 0',
display:'block',
whiteSpace:'normal'
}
},
{
xtype:'container',
width:400,
cls:'globalstyles-groupbox',
items:[{
xtype:'container',
layout:'hauto',
layoutConfig:{padding:'0 0 0 0'},
items:[
{
xtype:'button',
ref:'../../../borderWidget',
width:90,
text:'Border',
plugins:new web.ui.plugins.WindowButton({
type:'web.windows.blockProps.Border',
app:this.app,
listeners:{
adjust:function(cfg){
this.fireEvent('changed',this,'border',cfg)
},
scope:this
}
}),
styleType:'border',
listeners:{
winshow:function(button,win){
var c=this.border.color,w=this.border.width,s=this.border.style,dash={
color:[
c.top,
c.right,
c.bottom,
c.left
],
style:[
s.top,
s.right,
s.bottom,
s.left
],
width:[
w.top,
w.right,
w.bottom,
w.left
]
};
win.setValues(dash)
},
scope:this
}
},
{
xtype:'spacer',
width:7
},
{
xtype:'button',
ref:'../../../spacingWidget',
text:'Spacing',
width:90,
plugins:new web.ui.plugins.WindowButton(this.app.windows.create({type:'web.windows.blockProps.Padding'})),
styleType:'padding',
listeners:{
winshow:function(button,win){
win.setValues([
this.spacing.top,
this.spacing.right,
this.spacing.bottom,
this.spacing.left
]);
win.on('change',this.onPaddingChange,this)
},
winhide:function(button,win){
win.un('change',this.onPaddingChange,this)
},
scope:this
}
},
{
xtype:'spacer',
width:7
},
{
xtype:'button',
width:90,
text:'Background',
plugins:new web.ui.plugins.WindowButton({
type:'web.windows.blockProps.Background',
app:this.app,
listeners:{
adjust:function(change){
this.fireEvent('changed',this,'background',change)
},
scope:this
}
}),
listeners:{
winshow:function(button,win){
win.setValues(this.background)
},
scope:this
}
},
{
xtype:'spacer',
width:7
},
{
xtype:'button',
ref:'../../../cornersWidget',
width:88,
text:'Corners',
plugins:new web.ui.plugins.WindowButton({
type:'web.windows.blockProps.Corners',
app:this.app,
listeners:{
adjust:function(change){
this.fireEvent('changed',this,'corners',change)
},
scope:this
}
}),
listeners:{
winshow:function(button,win){
win.setValues(this.corners)
},
scope:this
}
}
]
}]
}
]
}
];
web.panels.props.globalstyles.menus.BlockStyle.superclass.initComponent.apply(this,arguments);
this.addEvents('changed')
},
onPaddingChange:function(val){
this.spacing=this.spacingWidget.win.getValue();
this.fireEvent('changed',this,'spacing',{padding:this.spacing})
},
setValues:function(values){
Ext.apply(this,values);
this.refresh()
},
refresh:function(){
}
});
Ext.reg('web-globalstyles-menus-blockstyle',web.panels.props.globalstyles.menus.BlockStyle);
web.panels.props.globalstyles.menus.MultiLevelStyle=Ext.extend(Ext.Container,{
accordionTextIndent:null,
cascadeWidth:null,
initComponent:function(){
this.layout='hauto';
this.accordionTextIndentField=new Ext.ux.form.SpinnerField({
width:50,
minValue:0,
maxValue:100,
onFieldValidate:function(){
var that=this;
if(this.validateInterval){
window.clearTimeout(this.validateInterval);
this.validateInterval=null
}
this.validateInterval=window.setTimeout(function(){
var value=that.getValue();
that.fireEvent('change',that,value)
},250)
},
listeners:{
change:this.onAccordionTextIndentChange,
render:function(field){
field.mon(field.el,'keyup',function(el){
field.onFieldValidate()
},this);
field.on('spin',function(){
field.onFieldValidate()
},this)
},
scope:this
}
});
this.cascadeWidthField=new Ext.ux.form.SpinnerField({
width:50,
minValue:50,
maxValue:500,
onFieldValidate:function(){
var that=this;
if(this.validateInterval){
window.clearTimeout(this.validateInterval);
this.validateInterval=null
}
this.validateInterval=window.setTimeout(function(){
var value=that.getValue();
that.fireEvent('change',that,value)
},250)
},
listeners:{
change:this.onCascadeWidthChange,
render:function(field){
field.mon(field.el,'keyup',function(el){
field.onFieldValidate()
},this);
field.on('spin',function(){
field.onFieldValidate()
},this)
},
scope:this
}
});
this.items=[
{
xtype:'spacer',
width:20
},
{
xtype:'container',
items:[
{
xtype:'label',
text:this.title,
style:{display:'block'}
},
{
xtype:'label',
text:this.description,
style:{
width:'260px',
color:'#888',
fontSize:'10px',
padding:'0 0 5px 0',
display:'block',
whiteSpace:'normal'
}
},
{
xtype:'container',
width:400,
cls:'globalstyles-groupbox',
items:[
{
xtype:'container',
layout:'hauto',
layoutConfig:{padding:'0 0 0 0'},
items:[
{
xtype:'label',
width:165,
text:'Tree Menu Text Indent:'
},
{
xtype:'spacer',
width:12
},
this.accordionTextIndentField
]
},
{
xtype:'spacer',
height:5
},
{
xtype:'container',
layout:'hauto',
items:[
{
xtype:'label',
width:165,
text:'Drop-down Width:'
},
{
xtype:'spacer',
width:12
},
this.cascadeWidthField
]
}
]
}
]
}
];
web.panels.props.globalstyles.menus.MultiLevelStyle.superclass.initComponent.apply(this,arguments);
this.addEvents('changed')
},
onAccordionTextIndentChange:function(field,value,changed){
this.accordionTextIndent=value;
this.fireEvent('changed',this,'accordionTextIndent',value)
},
onCascadeWidthChange:function(field,value,changed){
this.cascadeWidth=value;
this.fireEvent('changed',this,'cascadeWidth',value)
},
setValues:function(values){
Ext.apply(this,values);
this.refresh()
},
refresh:function(){
this.accordionTextIndentField.setValue(this.accordionTextIndent);
this.cascadeWidthField.setValue(this.cascadeWidth)
}
});
Ext.reg('web-globalstyles-menus-multilevelstyle',web.panels.props.globalstyles.menus.MultiLevelStyle);
web.commands.menus.UpdateStyle=Ext.extend(web.commands.Command,{
style:null,
ptype:null,
pvalue:null,
group:null,
previous:null,
execute:function(){
this.apply(this.pvalue);
if(this.style){
this.fireEvent('update',this.style);
this.app.panels.workspace.updateMenus()
}
},
undo:function(){
this.apply(this.previous);
if(this.style){
this.fireEvent('update',this.style);
this.app.panels.workspace.updateMenus()
}
},
runTo:function(fn,buttons,views){
var style=this.style;
buttons=buttons||[
'item',
'selected',
'expandable',
'expanded'
];
views=views||[
'inactive',
'visited',
'hover',
'press',
'disabled'
];
buttons.forEach(function(button){
views.forEach(function(view){
fn(style[button][view],button,view)
})
})
},
apply:function(value){
var namespace=this.group,l,arrAll,arri,type=this.ptype,c,w,s,that=this,runTo=function(){
that.runTo.apply(that,arguments)
},ns=namespace==='normal'?'item':namespace;
l=this.style;
arrAll=[
l.item.inactive,
l.item.visited,
l.item.hover,
l.item.press,
l.item.disabled,
l.selected.inactive,
l.selected.visited,
l.selected.hover,
l.selected.press,
l.selected.disabled
];
if(type==='bold'){
if(!this.previous){
this.previous=l.item.inactive.text.bold
}
runTo(function(obj){
obj.text.bold=value
})
}else if(type==='italic'){
if(!this.previous){
this.previous=l.item.inactive.text.italic
}
runTo(function(obj){
obj.text.italic=value
})
}else if(type==='fontid'){
if(!this.previous){
this.previous=l.item.inactive.text.font?l.item.inactive.text.font.fontType:null
}
runTo(function(obj){
obj.text.set({font:value})
})
}else if(type==='fontsize'){
if(!this.previous){
this.previous=l.item.inactive.text.size
}
runTo(function(obj){
obj.text.size=value
})
}else if(type==='horizontalAlign'){
if(!this.previous){
this.previous=l.item.inactive.horizontalAlign
}
runTo(function(obj,button,view){
l[button][view].horizontalAlign=value
})
}else if(type==='transform'){
if(!this.previous){
this.previous=l.item.inactive.text.transform
}
runTo(function(obj){
obj.text.transform=value
})
}else if(type==='border'){
if([
'divider',
'block'
].indexOf(ns)===-1){
if(!this.previous){
this.previous={
border:{
color:arrAll[0].block.border.color,
width:arrAll[0].block.border.width,
style:arrAll[0].block.border.style
}
}
}
c=value.border.color;
w=value.border.width;
s=value.border.style;
runTo(function(obj){
arri=obj.block.border;
Ext.apply(arri.color,{
top:c[0],
right:c[1],
bottom:c[2],
left:c[3]
});
Ext.apply(arri.width,{
top:w[0],
right:w[1],
bottom:w[2],
left:w[3]
});
Ext.apply(arri.style,{
top:s[0],
right:s[1],
bottom:s[2],
left:s[3]
})
})
}else{
c=value.border.color;
w=value.border.width;
s=value.border.style;
arri=l[ns].border;
if(!this.previous){
this.previous={
border:{
color:c,
width:w,
style:s
}
}
}
Ext.apply(arri.color,{
top:c[0],
right:c[1],
bottom:c[2],
left:c[3]
});
Ext.apply(arri.width,{
top:w[0],
right:w[1],
bottom:w[2],
left:w[3]
});
Ext.apply(arri.style,{
top:s[0],
right:s[1],
bottom:s[2],
left:s[3]
})
}
}else if(type==='spacing'){
if(ns==='item'||ns==='expandable'){
if(!this.previous){
this.previous={
padding:{
top:arrAll[0].block.padding.top,
right:arrAll[0].block.padding.right,
bottom:arrAll[0].block.padding.bottom,
left:arrAll[0].block.padding.left
}
}
}
runTo(function(obj){
if(!obj.block.padding){
obj.block.padding={}
}
Ext.apply(obj.block.padding,value.padding)
},ns==='item'?[
ns,
'selected'
]:ns==='expandable'?[
ns,
'expanded'
]:[ns])
}else if(ns==='block'||ns==='divider'){
if(!this.previous){
this.previous=Ext.apply({},l[ns].padding)
}
Ext.apply(l[ns].padding,value.padding)
}
}else if(type==='underline'){
if(ns!=='hover'){
if(!this.previous){
this.previous=l[ns].inactive.text.underline
}
runTo(function(obj){
obj.text.underline=value
},[ns],[
'inactive',
'visited',
'press',
'disabled'
]);
if(ns==='expanded'){
runTo(function(obj){
obj.text.underline=value
},[
'expandable',
'expanded'
],['hover'])
}
}else{
if(!this.previous){
this.previous=l.item.hover.text.underline
}
runTo(function(obj){
obj.text.underline=value
},[
'item',
'selected'
],['hover'])
}
}else if(type==='foreColor'){
if(ns!=='hover'){
if(!this.previous){
this.previous=l[ns].inactive.text.color
}
runTo(function(obj){
obj.text.color=value
},[ns],[
'inactive',
'visited',
'press',
'disabled'
]);
if(ns==='expanded'){
runTo(function(obj){
obj.text.color=value
},[
'expandable',
'expanded'
],['hover'])
}
}else{
if(!this.previous){
this.previous=l.item.hover.text.color
}
runTo(function(obj){
obj.text.color=value
},[
'item',
'selected'
],['hover'])
}
}else if(type==='shadow'){
if(ns!=='hover'){
if(!this.previous){
this.previous=Ext.apply({},l[ns].inactive.text.shadow)
}
runTo(function(obj){
obj.text.set({shadow:value})
},[ns],[
'inactive',
'visited',
'press',
'disabled'
]);
if(ns==='expanded'){
runTo(function(obj){
obj.text.set({shadow:value})
},[
'expandable',
'expanded'
],['hover'])
}
}else{
if(!this.previous){
this.previous=Ext.apply({},l.item.hover.text.shadow)
}
runTo(function(obj){
obj.text.set({shadow:value})
},[
'item',
'selected'
],['hover'])
}
}else if(type==='highlightColor'){
if(ns!=='hover'){
if(!this.previous){
this.previous=l[ns].inactive.text.highlight
}
runTo(function(obj){
obj.text.highlight=value
},[ns],[
'inactive',
'visited',
'press',
'disabled'
]);
if(ns==='expanded'){
runTo(function(obj){
obj.text.highlight=value
},[
'expandable',
'expanded'
],['hover'])
}
}else{
if(!this.previous){
this.previous=l.item.hover.text.highlight
}
runTo(function(obj){
obj.text.highlight=value
},[
'item',
'selected'
],['hover'])
}
}else if(type==='background'){
if([
'divider',
'block'
].indexOf(ns)!==-1){
if(!this.previous){
this.previous=Ext.apply({},l[ns].background)
}
Ext.apply(l[ns].background,value.background)
}else if(ns!=='hover'){
if(!this.previous){
this.previous=Ext.apply({},l[ns].inactive.block.background)
}
runTo(function(obj){
Ext.apply(obj.block.background,value.background)
},[ns],[
'inactive',
'visited',
'press',
'disabled'
]);
if(ns==='expanded'){
runTo(function(obj){
Ext.apply(obj.block.background,value.background)
},[
'expandable',
'expanded'
],['hover'])
}
}else{
if(!this.previous){
this.previous=Ext.apply({},l.item.hover.block.background)
}
runTo(function(obj){
Ext.apply(obj.block.background,value.background)
},[
'item',
'selected'
],['hover'])
}
}else if(type==='corners'){
if([
'divider',
'block'
].indexOf(ns)!==-1){
if(!this.previous){
this.previous=Ext.apply({},l[ns].border.corners)
}
Ext.apply(l[ns].border.corners,value.border.corners)
}else if(ns!=='hover'){
if(!this.previous){
this.previous=Ext.apply({},l[ns].inactive.block.border.corners)
}
runTo(function(obj){
Ext.apply(obj.block.border.corners,value.border.corners)
},[ns],[
'inactive',
'visited',
'press',
'disabled'
])
}else{
if(!this.previous){
this.previous=Ext.apply({},l.item.hover.block.border.corners)
}
runTo(function(obj){
Ext.apply(obj.block.border.corners,value.border.corners)
},null,['hover'])
}
}else if(type==='accordionTextIndent'){
if(!this.previous){
this.previous=this.style.accordionTextIndent
}
this.style.accordionTextIndent=value
}else if(type==='cascadeWidth'){
if(!this.previous){
this.previous=this.style.cascadeWidth
}
this.style.cascadeWidth=value
}
}
});
web.commands.stylesheets.AddStyle=Ext.extend(web.commands.Command,{
constructor:function(config){
this.style=null;
this.stylesheet=null;
web.commands.stylesheets.AddStyle.superclass.constructor.call(this,config)
},
execute:function(){
this.style=this.stylesheet.addStyle(this.style);
this.prevState=null;
this.fireEvent('update',this.stylesheet)
},
undo:function(){
if(this.prevState){
this.execute()
}else{
this.prevState=this.style.toJSON();
this.stylesheet.removeStyle(this.style);
this.style.destroy();
this.fireEvent('update',this.stylesheet)
}
}
});
web.commands.stylesheets.DeleteStyle=Ext.extend(web.commands.Command,{
constructor:function(config){
this.style=null;
this.stylesheet=null;
web.commands.stylesheets.DeleteStyle.superclass.constructor.call(this,config);
this.stylesheet=this.style.getParent()
},
execute:function(){
this.prevState=this.style.toJSON();
this.stylesheet.removeStyle(this.style);
this.style.destroy();
this.fireEvent('update',this.stylesheet)
},
undo:function(){
if(this.prevState){
this.style=this.stylesheet.addStyle(this.prevState);
this.prevState=null;
this.fireEvent('update',this.stylesheet)
}else{
this.execute()
}
}
});
web.panels.props.globalstyles.menus.MenusTab=Ext.extend(Ext.Container,{
affectedDocsCache:{},
initComponent:function(){
var app=this.app;
this.selectedMenuStyleId=this.selectedMenuStyleId||app.getSelected('stylesheet').getStylesByType('web.data.styles.StyleMenu')[0].id;
var style=this.selectedMenuStyle=app.dm.get(this.selectedMenuStyleId),uItem=style.item.inactive,uSelected=style.selected.inactive,uExpandable=style.expandable.inactive,uExpanded=style.expanded.inactive,uHover=style.item.hover,uDivider=style.divider,uBlock=style.block;
this.menuc=new web.controllers.menus.MenuStyle({app:app});
this.layout='vbox';
this.layoutConfig={align:'stretch'};
this.addStyleButton=new Ext.Button({
text:'New menu style (Duplicate)',
handler:this.onAddStyle,
scope:this
});
this.items=[
{
xtype:'container',
cls:'gray-background hbox cross-center',
style:'padding: 5px;',
height:40,
margins:'0 0 0 0',
items:[
{
xtype:'container',
cls:'flex',
html:'Select a menu style to edit it:'
},
{
xtype:'container',
width:10,
height:10
},
{
xtype:'combo',
margins:'0 10 0 0',
ref:'../menuStyleCombo',
store:this.menuc.getMenuStylesDataStore(),
mode:'local',
selectedIndex:0,
valueField:'id',
displayField:'text',
triggerAction:'all',
width:150,
editable:false,
forceSelection:true,
listeners:{
select:function(combo){
this.setStyleMenu(this.app.dm.get(combo.getValue()))
},
scope:this
}
},
{
xtype:'container',
width:10,
height:10
},
this.addStyleButton,
{
xtype:'container',
width:10,
height:10
},
{
ref:'../deleteMenuStyleButton',
xtype:'button',
text:'Delete this menu style',
tooltip:'Menu style is in use',
disabled:true,
listeners:{
click:function(btn){
this.deleteSelectedMenuStyle()
},
enable:function(button){
button.setTooltip('')
},
disable:function(button){
button.setTooltip(button.initialConfig.tooltip)
},
scope:this
}
}
]
},
{
flex:1,
xtype:'container',
autoScroll:true,
cls:'autoscroll',
style:'overflow: hidden;',
layout:'hflex',
layoutConfig:{align:'stretchmax'},
name:'mainContainer',
ref:'mainContainer',
items:[
{
xtype:'spacer',
height:20
},
{
xtype:'container',
name:'propertiesPanel',
layout:'auto',
width:440,
style:'overflow-y: auto;position: absolute;height: 100%;',
items:[
{
xtype:'web-globalstyles-menus-commonstyle',
ref:'../../commonStyleWidget',
namespace:'normal',
title:'All menu items',
app:app,
fontId:uItem.text.font?uItem.text.font.fontType:null,
fontSize:uItem.text.size,
bold:uItem.text.bold,
italic:uItem.text.italic,
horizontalAlign:uItem.horizontalAlign,
textTransform:uItem.text.transform,
border:uItem.block.border,
spacing:uItem.block.padding,
listeners:{
changed:this.update,
scope:this
}
},
{
xtype:'web-globalstyles-menus-overridestyle',
ref:'../../normalOverrideWidget',
namespace:'normal',
title:'Menu items: Normal',
app:app,
description:'These additional styling options are applied to normal menu items.',
underline:uItem.text.underline,
color:uItem.text.color,
shadow:uItem.text.shadow,
background:uItem.block.background,
corners:uItem.block.border.corners,
listeners:{
changed:this.update,
scope:this
}
},
{
xtype:'web-globalstyles-menus-overridestyle',
ref:'../../hoverOverrideWidget',
namespace:'hover',
title:'Menu items: Mouse over',
app:app,
description:'These additional styling options are activated when you move your mouse over an item in the menu.',
underline:uHover.text.underline,
color:uHover.text.color,
shadow:uHover.text.shadow,
background:uHover.block.background,
corners:uHover.block.border.corners,
listeners:{
changed:this.update,
scope:this
}
},
{
xtype:'web-globalstyles-menus-overridestyle',
ref:'../../selectedOverrideWidget',
namespace:'selected',
title:'Menu items: Selected',
app:app,
description:'These additional styling options are activated when an item is selected in the menu.',
underline:uSelected.text.underline,
color:uSelected.text.color,
shadow:uSelected.text.shadow,
background:uSelected.block.background,
corners:uSelected.block.border.corners,
listeners:{
changed:this.update,
scope:this
}
},
{
xtype:'web-globalstyles-menus-expandablestyle',
ref:'../../expandableOverrideWidget',
namespace:'expandable',
title:'Menu items: Expandable',
app:app,
description:'These additional styling options are activated when an item has subitems.',
underline:uExpandable.text.underline,
color:uExpandable.text.color,
shadow:uExpandable.text.shadow,
background:uExpandable.block.background,
padding:uExpandable.block.padding,
listeners:{
changed:this.update,
scope:this
}
},
{
xtype:'web-globalstyles-menus-expandablestyle',
ref:'../../expandedOverrideWidget',
namespace:'expanded',
title:'Menu items: Expanded',
app:app,
description:'These additional styling options are activated when an item has its subitems shown.',
underline:uExpanded.text.underline,
color:uExpanded.text.color,
shadow:uExpanded.text.shadow,
background:uExpanded.block.background,
padding:uExpanded.block.padding,
last:true,
listeners:{
changed:this.update,
scope:this
}
},
{
xtype:'web-globalstyles-menus-blockstyle',
ref:'../../dividerStyleWidget',
namespace:'divider',
title:'Menu divider',
description:'These additional styling options create a box between each menu item.',
style:{paddingTop:'10px'},
padding:'10 0 0 0',
app:app,
background:uDivider.background,
spacing:uDivider.padding,
border:uDivider.border,
corners:uDivider.border.corners,
listeners:{
changed:this.update,
scope:this
}
},
{
xtype:'web-globalstyles-menus-blockstyle',
ref:'../../blockStyleWidget',
namespace:'block',
title:'Menu Level Container',
description:'These additional styling options create a box around menu items at each level.',
style:{paddingTop:'10px'},
padding:'10 0 0 0',
app:app,
background:uBlock.background,
spacing:uBlock.padding,
border:uBlock.border,
corners:uBlock.border.corners,
listeners:{
changed:this.update,
scope:this
}
},
{
xtype:'web-globalstyles-menus-multilevelstyle',
ref:'../../multiLevelStyleWidget',
namespace:'block',
title:'Multiple Levels',
description:'These additional styling options apply under specific conditions when there are multiple levels showing.',
style:{paddingTop:'10px'},
padding:'10 0 0 0',
app:app,
accordionTextIndent:style.accordionTextIndent,
cascadeWidth:style.cascadeWidth,
listeners:{
changed:this.update,
scope:this
}
},
{
xtype:'spacer',
height:20
}
]
},
{
width:425,
xtype:'container',
name:'previewPanel',
ref:'../previewPanel',
forceLayout:true,
layout:'vbox',
cls:'menu-preview-container',
layoutConfig:{align:'stretch'},
margins:'0 20 0 0',
items:[{
flex:1,
xtype:'container',
style:{
borderLeft:'1px solid #CED7BD',
paddingLeft:'20px'
},
items:[
{
xtype:'spacer',
height:20
},
{
xtype:'label',
text:'Preview',
height:20,
style:'padding: 0 0 9px 21px; display: block;'
},
{
xtype:'label',
text:'Horizontal Menu',
style:{
padding:'10px 0',
display:'block'
}
},
{
xtype:'container',
ref:'../../../previewHorizonal',
cls:'globalstyles-groupbox globalstyles-menu-horizontal',
items:[]
},
{
xtype:'label',
text:'Vertical Menu',
style:{
padding:'20px 0 10px 0',
display:'block'
}
},
{
xtype:'container',
ref:'../../../previewVertical',
cls:'globalstyles-groupbox globalstyles-menu-vertical',
items:[]
},
{
xtype:'spacer',
height:20
}
]
}]
}
]
}
];
web.panels.props.globalstyles.menus.MenusTab.superclass.initComponent.apply(this,arguments);
this.mon(this.app,'update',function(part){
if(part instanceof web.data.styles.Stylesheet){
this.refreshStyles()
}
this.affectedDocsCache={}
},this);
this.on('show',function(){
this.preview()
});
this.setStylesheet(app.getSelected('stylesheet'))
},
refreshStyles:function(){
this.menuStyleCombo.bindStore(this.menuc.getMenuStylesDataStore());
this.setStyleMenu(this.stylesheet.getStylesByType('web.data.styles.StyleMenu')[0])
},
setStylesheet:function(stylesheet){
if(stylesheet!==this.stylesheet){
this.stylesheet=stylesheet;
this.refreshStyles()
}
},
setValues:function(values){
if(values.selectedMenuStyleId!==undefined){
var id=values.selectedMenuStyleId,style=this.app.dm.get(id);
if(style!==this.selectedMenuStyle){
this.setStyleMenu(style)
}else{
this.preview()
}
}
},
setStyleMenu:function(style){
var uItem=style.item.inactive,uSelected=style.selected.inactive,uExpandable=style.expandable.inactive,uExpanded=style.expanded.inactive,uHover=style.item.hover,uDivider=style.divider,uBlock=style.block;
this.selectedMenuStyle=style;
this.selectedMenuStyleId=style.id;
this.menuStyleCombo.setValue(this.selectedMenuStyleId);
this.setDeleteStyleButtonState(style);
this.commonStyleWidget.setValues({
fontId:uItem.text.font?uItem.text.font.fontType:null,
fontSize:uItem.text.size,
bold:uItem.text.bold,
italic:uItem.text.italic,
horizontalAlign:uItem.horizontalAlign,
textTransform:uItem.text.transform,
border:uItem.block.border,
spacing:uItem.block.padding
});
this.normalOverrideWidget.setValues({
underline:uItem.text.underline,
color:uItem.text.color,
shadow:uItem.text.shadow,
background:uItem.block.background,
corners:uItem.block.border.corners
});
this.hoverOverrideWidget.setValues({
underline:uHover.text.underline,
color:uHover.text.color,
shadow:uHover.text.shadow,
background:uHover.block.background,
corners:uHover.block.border.corners
});
this.selectedOverrideWidget.setValues({
underline:uSelected.text.underline,
color:uSelected.text.color,
shadow:uSelected.text.shadow,
background:uSelected.block.background,
corners:uSelected.block.border.corners
});
this.expandableOverrideWidget.setValues({
underline:uExpandable.text.underline,
color:uExpandable.text.color,
shadow:uExpandable.text.shadow,
background:uExpandable.block.background,
padding:uExpandable.block.padding
});
this.expandedOverrideWidget.setValues({
underline:uExpanded.text.underline,
color:uExpanded.text.color,
shadow:uExpanded.text.shadow,
background:uExpanded.block.background,
padding:uExpanded.block.padding
});
this.dividerStyleWidget.setValues({
background:uDivider.background,
spacing:uDivider.padding,
border:uDivider.border,
corners:uDivider.border.corners
});
this.blockStyleWidget.setValues({
background:uBlock.background,
spacing:uBlock.padding,
border:uBlock.border,
corners:uBlock.border.corners
});
this.multiLevelStyleWidget.setValues({
accordionTextIndent:style.accordionTextIndent,
cascadeWidth:style.cascadeWidth
});
this.preview()
},
preview:function(){
var notRendered=0,afterRender=function(){
notRendered-=1;
if(notRendered===0){
this.preview()
}
},waitForRender=function(components,scope){
if(notRendered>0){
return true
}
var i;
for(i=0;i<components.length;i+=1){
if(!components[i].rendered){
notRendered+=1;
components[i].on('afterrender',afterRender,scope,{single:true})
}
}
if(notRendered>0){
return true
}
return false
},generate=function(cfg){
var site,stylesheet,template,page,doc,dm=new web.DM;
site=dm.create({
'homePageId':Math.uuid(),
'id':'site',
'locale':'en_US',
'location':'universal.oneweb',
'name':'universal',
'type':'web.data.Site',
'folder':cfg.folder
});
stylesheet=dm.create({
'id':Math.uuid(),
'type':'web.data.styles.Stylesheet',
'name':'a style sheet',
'styles':[cfg.selectedMenuStyle]
});
template=dm.create({
'id':Math.uuid(),
'minHeight':10,
'name':'Preview Stub',
'stylesheetId':stylesheet.id,
'type':'web.data.components.Template',
'width':250,
'align':'center',
'items':[{
'id':Math.uuid(),
'type':'web.data.components.Menu',
'menuStyle':{
id:Math.uuid(),
'globalId':cfg.selectedMenuStyle.id,
'type':'web.data.styles.StyleMenu'
},
'bbox':{
'left':0,
'top':0,
'right':250,
'bottom':10
},
'vertical':cfg.vertical,
'verticalAlign':'top',
'level':1,
'accordion':9,
'cascade':0,
'cascadeStyles':[]
}]
});
page=dm.create({
'description':'a page',
'id':cfg.selectedPageId,
'name':'Preview Stub',
'templateId':template.id,
'type':'web.data.components.Page',
'items':[]
});
doc=new web.Document({
dm:dm,
domain:cfg.domain,
editMode:true
});
page.render(doc);
template.renderBody(doc);
return'<style>'+cfg.selectedMenuStyle.toCSS()+'</style>'+doc.toBodyHTML()
};
return function(){
if(waitForRender([
this.previewHorizonal,
this.previewVertical
],this)){
return
}
var selectedPageId=Math.uuid(),horizontalHtml1,horizontalHtml2,verticalHtml1,verticalHtml2,verticalSeparator='<li class="divider menu1divider"></li>'+'<li style="height:1px"></li>',horizontalSeparator='<li style="width:1px"></li>';
horizontalHtml1=generate({
vertical:false,
selectedMenuStyle:this.selectedMenuStyle,
selectedPageId:selectedPageId,
domain:this.app.dal.domain,
folder:{
'id':Math.uuid(),
'type':'web.data.links.LinkPage',
'name':'[root]',
'pageId':'',
'public':true,
'url':'root',
'items':[
{
'id':Math.uuid(),
'name':'Normal',
'pageId':null,
'public':true,
'type':'web.data.links.LinkPage',
'url':'normal1'
},
{
'id':Math.uuid(),
'name':'Selected',
'pageId':selectedPageId,
'public':true,
'type':'web.data.links.LinkPage',
'url':'selected'
}
]
}
});
horizontalHtml2=generate({
vertical:false,
selectedMenuStyle:this.selectedMenuStyle,
selectedPageId:selectedPageId,
domain:this.app.dal.domain,
folder:{
'id':Math.uuid(),
'type':'web.data.links.LinkPage',
'name':'[root]',
'pageId':'',
'public':true,
'url':'root',
'items':[
{
'id':Math.uuid(),
'name':'Expandable',
'pageId':null,
'public':true,
'type':'web.data.links.LinkPage',
'url':'expandable',
'items':[{
'id':Math.uuid(),
'name':'Normal',
'pageId':null,
'public':true,
'type':'web.data.links.LinkPage',
'url':'normal2'
}]
},
{
'id':Math.uuid(),
'name':'Expanded',
'pageId':selectedPageId,
'public':true,
'type':'web.data.links.LinkPage',
'url':'expanded',
'items':[{
'id':Math.uuid(),
'name':'Selected',
'pageId':null,
'public':true,
'type':'web.data.links.LinkPage',
'url':'selected'
}]
}
]
}
});
horizontalHtml2=horizontalHtml2.replace(/<ul[^>]*>\s?<li><a[^>]*><div[^>]*>Selected<\/div><\/a><\/li><div[^>]*><\/div>\s?<\/ul>/,'');
horizontalHtml2=horizontalHtml2.split(/<\/?ul[^>]*>/)[1];
horizontalHtml2=(horizontalHtml2||'').replace(/<li>/,'<li>'+'<div class="divider menu1divider"></div>');
horizontalHtml1=horizontalHtml1.replace(/<\/ul>/,horizontalSeparator+horizontalHtml2+'</ul>');
horizontalHtml1=horizontalHtml1.replace(/<div class="end"><\/div>/g,'');
verticalHtml1=generate({
vertical:true,
selectedMenuStyle:this.selectedMenuStyle,
selectedPageId:selectedPageId,
domain:this.app.dal.domain,
folder:{
'id':Math.uuid(),
'type':'web.data.links.LinkPage',
'name':'[root]',
'pageId':'',
'public':true,
'items':[
{
'id':Math.uuid(),
'type':'web.data.links.LinkPage',
'name':'Normal',
'pageId':null,
'public':true,
'url':'normal1'
},
{
'id':Math.uuid(),
'name':'Selected',
'pageId':selectedPageId,
'public':true,
'type':'web.data.links.LinkPage',
'url':'expanded',
'items':[]
}
]
}
});
verticalHtml2=generate({
vertical:true,
selectedMenuStyle:this.selectedMenuStyle,
selectedPageId:selectedPageId,
domain:this.app.dal.domain,
folder:{
'id':Math.uuid(),
'type':'web.data.links.LinkPage',
'name':'[root]',
'pageId':'',
'public':true,
'items':[
{
'id':Math.uuid(),
'name':'Expandable',
'pageId':null,
'public':true,
'type':'web.data.links.LinkPage',
'url':'expandable',
'items':[{
'id':Math.uuid(),
'name':'Normal',
'pageId':null,
'public':true,
'type':'web.data.links.LinkPage',
'url':'normal2'
}]
},
{
'id':Math.uuid(),
'name':'Expanded',
'pageId':selectedPageId,
'public':true,
'type':'web.data.links.LinkPage',
'url':'expanded',
'items':[{
'id':Math.uuid(),
'name':'Selected',
'pageId':null,
'public':true,
'type':'web.data.links.LinkPage',
'url':'normal2'
}]
}
]
}
});
verticalHtml2=verticalHtml2.replace(/<ul[^>]*>\s?<li><a[^>]*><div[^>]*>Selected<\/div><\/a><\/li><div[^>]*><\/div>\s?<\/ul>/,'');
verticalHtml2=verticalHtml2.split(/<\/?ul[^>]*>/)[1];
verticalHtml1=verticalHtml1.replace(/<\/ul>/,verticalSeparator+verticalHtml2+'</ul>');
verticalHtml1=verticalHtml1.replace(/<div class="end"><\/div>/g,'');
horizontalHtml1=horizontalHtml1.replace(/min-height:500px/g,'min-height:150px');
verticalHtml1=verticalHtml1.replace(/min-height:500px/g,'min-height:400px');
try{
this.previewHorizonal.update(horizontalHtml1);
this.previewVertical.update(verticalHtml1)
}catch(err){
}
}
}(),
update:function(comp,type,value){
value=this.createTypes(type,value);
var command,group;
group=comp.namespace;
command=new web.commands.menus.UpdateStyle({
style:this.selectedMenuStyle,
ptype:type,
pvalue:value,
group:group
});
this.app.invoker.execute(command);
this.preview();
this.app.panels.workspace.updateMenus()
},
createTypes:function(type,value){
if(type==='background'&&value.background.gradient){
value.background.type='web.data.styles.Background';
value.background=this.app.dm.create(value.background)
}
return value
},
clearCSSClasses:function(){
if(this.previewHorizonal&&this.previewVertical){
try{
this.previewHorizonal.update('');
this.previewVertical.update('')
}catch(err){
}
}
},
onAddStyle:function(btn){
var styleMenus=this.stylesheet.getStylesByType('web.data.styles.StyleMenu'),ref,cfg;
ref=function(styles){
var firstAvailableIndex,refs=styles.map(function(style){
return parseInt(style.getRef().replace(/^menu\./,''),10)
});
refs.sort(function(a,b){
return a-b
});
firstAvailableIndex=refs[0]-1;
refs.some(function(ref){
firstAvailableIndex+=1;
return ref!==firstAvailableIndex
});
if(firstAvailableIndex===refs[refs.length-1]){
firstAvailableIndex+=1
}
return firstAvailableIndex.toString()
}(styleMenus);
cfg=new web.utils.Copier().copy(Ext.apply(this.selectedMenuStyle.toJSON(),{
ref:'menu.'+ref,
name:'[ menu '+ref+']'
}));
this.app.invoker.execute(new web.commands.stylesheets.AddStyle({
style:cfg,
stylesheet:this.stylesheet
}));
this.setValues({selectedMenuStyleId:cfg.id})
},
setDeleteStyleButtonState:function(menuStyle){
if(this.stylesheet.getStylesByType('web.data.styles.StyleMenu').length===1){
this.deleteMenuStyleButton.disable();
return
}else if(this.affectedDocsCache[menuStyle.id]){
this.deleteMenuStyleButton[this.affectedDocsCache[menuStyle.id]]();
return
}
this.app.dal.getDocsWithProperty('globalId',menuStyle.id,function(opts,success,response){
if(success){
var currentDocTypesToCheck=[
'page',
'template'
],found=false;
Ext.decode(response.responseText).forEach(function(doc){
var type=doc.type.split('.').reverse()[0].toLowerCase(),currentDoc;
if(!found&&type==='template'||type==='page'){
currentDoc=this.app.getSelected(type);
if(currentDoc.id===doc.id){
if(this.isDocUsingMenuStyle(currentDoc,menuStyle)){
found=true
}else{
currentDocTypesToCheck.remove(type)
}
}else{
found=true
}
}
},this);
if(!found){
currentDocTypesToCheck.forEach(function(type){
if(this.isDocUsingMenuStyle(this.app.getSelected(type),menuStyle)){
found=true
}
},this)
}
if(found){
this.deleteMenuStyleButton.disable();
this.cacheButtonStateResult(menuStyle.id,'disable')
}else{
this.deleteMenuStyleButton.enable();
this.cacheButtonStateResult(menuStyle.id,'enable')
}
}else{
this.deleteMenuStyleButton.disable();
this.cacheButtonStateResult(menuStyle.id,'disable')
}
},this)
},
isDocUsingMenuStyle:function(doc,menuStyle){
doc=doc.toJSON?doc.toJSON():doc;
function extractObjectsFromArray(array){
var objects=[];
array.forEach(function(obj){
if(Ext.isArray(obj)){
Array.prototype.push.apply(objects,extractObjectsFromArray(obj))
}else if(Ext.isObject(obj)){
objects.push(obj)
}
});
return objects
}
var styleId=menuStyle.id,components=[doc],prop,obj;
while(components.length){
obj=components.shift();
if(obj.globalId===styleId){
return true
}
for(prop in obj){
if(obj.hasOwnProperty(prop)){
if(Ext.isObject(obj[prop])){
components.push(obj[prop])
}else if(Ext.isArray(obj[prop])){
Array.prototype.push.apply(components,extractObjectsFromArray(obj[prop]))
}
}
}
}
return false
},
deleteSelectedMenuStyle:function(){
this.app.invoker.execute(new web.commands.stylesheets.DeleteStyle({
style:this.selectedMenuStyle,
stylesheet:this.stylesheet
}))
},
cacheButtonStateResult:function(id,result){
var affectedDocsCache=this.affectedDocsCache;
affectedDocsCache[id]=result;
setTimeout(function(){
delete affectedDocsCache[id]
},300000)
}
});
Ext.reg('web-globalstyles-menus',web.panels.props.globalstyles.menus.MenusTab);
Ext.ns('web.panels.props.globalstyles.tables');
web.panels.props.globalstyles.tables.Cell=Ext.extend(web.panels.props.richtext.Style,{
xtype:'web-props-cell',
initStylePanel:function(){
this.layout='auto';
this.baseCls='';
this.cls='';
this.height=126;
this.style='padding: 0 0 0 0; ';
var groupPostfix=this.title.toLowerCase().replace(/ /g,'-');
this.backgroundBtn=new Ext.Button({
text:'Background',
width:90,
plugins:new web.ui.plugins.WindowButton({
type:'web.windows.blockProps.Background',
app:this.app,
listeners:{
adjust:this.onAdjust,
scope:this
}
}),
styleType:'background',
listeners:{
winshow:this.onStyleClick,
scope:this
}
});
this.borderBtn=new Ext.Button({
text:'Border',
width:91,
plugins:new web.ui.plugins.WindowButton({
type:'web.windows.blockProps.Border',
app:this.app,
persist:false,
listeners:{
adjust:this.onAdjust,
scope:this
}
}),
styleType:'border',
listeners:{
winshow:this.onStyleClick,
scope:this
}
});
this.paddingBtn=new Ext.Button({
text:'Spacing',
width:90,
plugins:new web.ui.plugins.WindowButton({
type:'web.windows.blockProps.Padding',
app:this.app,
listeners:{
change:this.onAdjust,
scope:this
}
}),
styleType:'padding',
listeners:{
winshow:this.onStyleClick,
scope:this
}
});
this.top=new Ext.Button({
itemId:'top',
iconCls:'icon icon-rte-aligntop',
tooltip:'Align top.',
scale:'small',
enableToggle:true,
toggleGroup:'valign-'+groupPostfix,
toggleHandler:this.unclickPreventionHack,
handler:this.onVerticalAlign,
scope:this
});
this.middle=new Ext.Button({
itemId:'middle',
iconCls:'icon icon-rte-alignmiddle',
tooltip:'Align middle.',
scale:'small',
enableToggle:true,
toggleGroup:'valign-'+groupPostfix,
toggleHandler:this.unclickPreventionHack,
handler:this.onVerticalAlign,
scope:this
});
this.bottom=new Ext.Button({
itemId:'bottom',
iconCls:'icon icon-rte-alignbottom',
tooltip:'Align bottom.',
scale:'small',
enableToggle:true,
toggleGroup:'valign-'+groupPostfix,
toggleHandler:this.unclickPreventionHack,
handler:this.onVerticalAlign,
scope:this
});
this.left=new Ext.Button({
itemId:'left',
iconCls:'icon icon-rte-justifyleft',
tooltip:'Align left.',
scale:'small',
enableToggle:true,
toggleGroup:'halign-'+groupPostfix,
toggleHandler:this.unclickPreventionHack,
handler:this.onHorizontalAlign,
scope:this
});
this.center=new Ext.Button({
itemId:'center',
iconCls:'icon icon-rte-justifycenter',
tooltip:'Align center.',
scale:'small',
enableToggle:true,
toggleGroup:'halign-'+groupPostfix,
toggleHandler:this.unclickPreventionHack,
handler:this.onHorizontalAlign,
scope:this
});
this.right=new Ext.Button({
itemId:'right',
iconCls:'icon icon-rte-justifyright',
tooltip:'Align right.',
scale:'small',
enableToggle:true,
toggleGroup:'halign-'+groupPostfix,
toggleHandler:this.unclickPreventionHack,
handler:this.onHorizontalAlign,
scope:this
});
this.justify=new Ext.Button({
itemId:'justify',
iconCls:'icon icon-rte-justifyfull',
tooltip:'Justify.',
scale:'small',
enableToggle:true,
toggleGroup:'halign-'+groupPostfix,
toggleHandler:this.unclickPreventionHack,
handler:this.onHorizontalAlign,
scope:this
});
this.items=[
{
xtype:'label',
text:this.title,
height:15
},
{
xtype:'container',
layout:'auto',
height:106,
cls:'globalstyles-groupbox',
items:[
{
xtype:'container',
layout:'hauto',
width:405,
items:[
this.font,
this.addFont,
{
xtype:'spacer',
width:25
},
this.size,
{
xtype:'spacer',
width:25
},
{
xtype:'container',
cls:'web-panel-button-group-new',
items:[
this.bold,
this.italic,
this.underline
]
}
]
},
{
xtype:'spacer',
height:10
},
{
xtype:'container',
layout:'hauto',
items:[
{
xtype:'container',
layout:'hauto',
width:113,
height:22,
cls:'button-group',
items:[
this.highlight.toggleButton,
this.highlight.winButton,
this.color,
this.shadow.toggleButton,
this.shadow.winButton
]
},
{
xtype:'spacer',
width:7
},
{
xtype:'container',
cls:'web-panel-button-group-new',
items:[
this.left,
this.center,
this.right,
this.justify
]
},
{
xtype:'spacer',
width:8
},
{
xtype:'container',
cls:'web-panel-button-group-new',
items:[
this.top,
this.middle,
this.bottom
]
}
]
},
{
xtype:'spacer',
height:10
},
{
xtype:'container',
layout:'hauto',
items:[
this.backgroundBtn,
{
xtype:'spacer',
width:17
},
this.borderBtn,
{
xtype:'spacer',
width:17
},
this.paddingBtn
]
}
]
}
]
},
initMyListeners:function(){
var stylesheet;
this.addEvents({'change':true});
this.app.on('update',function(part){
if(part.getRoot()instanceof web.data.styles.Stylesheet){
this.refresh()
}
},this);
stylesheet=this.app.getSelected('stylesheet');
if(stylesheet){
this.setStylesheet.defer(350,this,[stylesheet])
}
},
setStylesheet:function(stylesheet){
var cell;
this.stylesheet=stylesheet;
this.cell=cell=stylesheet.getStyleByRef(this.itemId,'StyleCell');
this.cellTextStyle=cell?cell.getText():null;
this.defaultTextStyle=stylesheet.getStyleByRef('normal','StyleText');
this.cellBlockStyle=cell?cell.getBlock():null;
this.refresh()
},
getValues:function(){
var font,size,bold,italic,underline,color,shadow,highlight,cellTextStyle=this.cellTextStyle,defaultTextStyle=this.defaultTextStyle;
if(cellTextStyle){
font=cellTextStyle.getFont();
size=cellTextStyle.getSize();
bold=cellTextStyle.isBold();
italic=cellTextStyle.isItalic();
underline=cellTextStyle.isUnderline();
color=cellTextStyle.getColor();
highlight=cellTextStyle.getHighlight();
shadow=cellTextStyle.getShadow()
}
if(defaultTextStyle){
font=font||defaultTextStyle.getFont();
size=size||defaultTextStyle.getSize();
bold=bold!==null?bold:defaultTextStyle.isBold();
italic=italic!==null?italic:defaultTextStyle.isItalic();
underline=underline!==null?underline:defaultTextStyle.isUnderline();
color=color||defaultTextStyle.getColor();
highlight=highlight||defaultTextStyle.getHighlight();
shadow=shadow||defaultTextStyle.getShadow()
}
font=font?font.getFontType():null;
return{
font:font||0,
size:size||12,
bold:!!bold,
italic:!!italic,
underline:!!underline,
color:color||new one.color.RGB(0,0,0),
highlight:highlight,
shadow:shadow
}
},
applyCellStyle:function(style){
this.app.invoker.execute(new web.commands.stylesheets.EditStyle({
style:this.cell,
newStyle:style
}));
this.fireEvent('change')
},
applyStyle:function(style){
this.app.invoker.execute(new web.commands.stylesheets.EditStyle({
style:this.cellTextStyle,
newStyle:style
}));
this.fireEvent('change')
},
applyBlockStyle:function(style){
this.app.invoker.execute(new web.commands.stylesheets.EditStyle({
style:this.cellBlockStyle,
newStyle:style
}))
},
onAdjust:function(){
var interval;
return function(opts){
var that=this;
this.cellBlockStyle.set(opts);
this.fireEvent('adjust',this.cellBlockStyle);
if(interval){
window.clearTimeout(interval)
}
interval=window.setTimeout(function(){
that.applyBlockStyle(opts)
},500)
}
}(),
onStyleClick:function(button,win){
var styleCfg=this.cellBlockStyle[button.styleType];
styleCfg=styleCfg?styleCfg.toJSON():null;
styleCfg=styleCfg||{};
if(button.styleType==='border'){
styleCfg.fixedWidth=1;
styleCfg.width=[
1,
1,
1,
1
];
styleCfg.style=styleCfg.style||[
'solid',
'solid',
'solid',
'solid'
];
styleCfg.color=styleCfg.color||[[
'RGB',
0,
0,
0
]]
}
win.setValues(styleCfg)
},
onVerticalAlign:function(button){
var style={verticalAlign:button.itemId};
this.applyCellStyle(style)
},
onHorizontalAlign:function(button){
var style={horizontalAlign:button.itemId};
this.applyCellStyle(style)
},
unclickPreventionHack:function(button,state){
if(state){
button.disable()
}else{
button.enable()
}
}
});
Ext.ComponentMgr.registerType('web-props-cell',web.panels.props.globalstyles.tables.Cell);
web.panels.props.globalstyles.tables.StyleTable=Ext.extend(Ext.Container,{
xtype:'web-props-styletable',
initComponent:function(){
var o,types=web.data.styles.StyleCell.types,name,first=true;
this.layout='auto';
this.layoutConfig={align:'stretch'};
this.items=[];
for(name in types){
if(types.hasOwnProperty(name)){
if(!first){
this.items.push({
xtype:'spacer',
height:10
})
}else{
first=false
}
o=new web.panels.props.globalstyles.tables.Cell({
itemId:name,
xtype:'web-props-cell',
title:types[name].NAME,
app:this.app
});
this[name]=o;
this.items.push(o);
this.relayEvents(o,[
'change',
'adjust'
])
}
}
web.panels.props.globalstyles.tables.StyleTable.superclass.initComponent.apply(this,arguments)
},
setStylesheet:function(stylesheet){
var styles=stylesheet.getStylesByType('web.data.styles.StyleCell');
this.fixData(styles);
Ext.each(styles,function(style,index){
this[style.ref].setStylesheet(stylesheet)
},this)
},
fixData:function(styles){
var types=web.data.styles.StyleCell.types;
Ext.each(styles,function(style,index){
if(!style.ref){
if(!types[style.getName()]){
one.error('StyleCell with an unidentified name found')
}else{
style.ref=style.getName().substring(1,style.getName().length-1)
}
}
},this)
}
});
Ext.ComponentMgr.registerType('web-props-styletable',web.panels.props.globalstyles.tables.StyleTable);
web.panels.props.globalstyles.tables.TablesTab=Ext.extend(Ext.Container,{
initComponent:function(){
this.doc=new web.Document({domain:this.app.dal.domain});
this.layout='vbox';
this.layoutConfig={align:'stretch'};
this.previewDiv=new Ext.Container({
html:'...',
style:{
paddingLeft:'10px',
paddingBottom:'10px',
overflowX:'auto'
}
});
this.tr={
heading:'Select a table cell style to edit it',
previewTitle:'Preview'
};
this.items=[
{
xtype:'container',
cls:'gray-background hbox cross-center',
style:'padding: 5px;',
height:40,
items:[{
xtype:'label',
cls:'flex',
text:this.tr.heading+':'
}]
},
{
flex:1,
xtype:'container',
layout:'hflex',
layoutConfig:{align:'stretchmax'},
ref:'mainContainer',
style:'position: absolute;',
items:[
{
xtype:'container',
layout:'auto',
style:{
verticalAlign:'top',
paddingRight:'20px',
width:'415px',
position:'absolute',
height:'100%',
'overflow-y':'auto'
},
items:[
{
xtype:'spacer',
height:20
},
{
xtype:'web-props-styletable',
ref:'../../styleTable',
itemId:'tableStyles',
app:this.app
},
{
xtype:'spacer',
height:20
}
]
},
{
xtype:'container',
style:{
verticalAlign:'top',
borderLeft:'1px solid #CED7BD',
position:'absolute',
left:'435px',
height:'100%'
},
ref:'../previewPanel',
width:405,
items:[
{
xtype:'spacer',
height:20
},
{
xtype:'label',
text:this.tr.previewTitle,
height:20,
style:'padding: 0 0 9px 21px; display: block;'
},
this.previewDiv
]
}
]
}
];
web.panels.props.globalstyles.tables.TablesTab.superclass.initComponent.apply(this,arguments);
this.on('afterrender',function(){
this.previewDiv.on('afterrender',function(){
var mel=this.mainContainer.el,pel=this.previewPanel.el,fel=pel?pel.first():null;
if(mel&&fel){
fel.insertBefore(mel);
fel.dom.style.width='273px';
fel.dom.style.zIndex=100
}
},this)
},this);
this.preview();
this.find('itemId','tableStyles')[0].on('change',this.preview,this);
this.find('itemId','tableStyles')[0].on('adjust',this.preview,this)
},
setStylesheet:function(stylesheet){
this.styleTable.setStylesheet(stylesheet);
this.preview()
},
preview:function(){
if(!this.previewDiv.rendered){
var func=function(){
var that=this;
setTimeout(function(){
that.preview()
},1000)
};
this.previewDiv.on('afterrender',func,this,{single:true});
return
}
var stylesheet=this.app.getSelected('stylesheet'),styles=stylesheet.getStylesByType('web.data.styles.StyleCell'),tr={
normal:'Normal',
alternate:'Alternate',
heading:'Heading 1',
subHeading:'Heading 2'
},arrText=[
[
tr.heading,
tr.heading,
tr.heading
],
[
tr.subHeading,
tr.normal,
tr.normal
],
[
tr.subHeading,
tr.alternate,
tr.alternate
],
[
tr.subHeading,
tr.normal,
tr.normal
]
],htmlTable,css,textCss,row,col,i,styleMap;
styleMap={};
for(i=0;i<styles.length;i+=1){
styleMap[styles[i].ref]=styles[i]
}
htmlTable='<table>\n';
for(row=0;row<4;row+=1){
htmlTable+='<tr>\n';
for(col=0;col<3;col+=1){
if(row===0){
css=styleMap['heading.1'].getCellCSSDeclarations(this.doc);
textCss=styleMap['heading.1'].getCellTextCSSDeclarations(this.doc)
}else if(col===0){
css=styleMap['heading.2'].getCellCSSDeclarations(this.doc);
textCss=styleMap['heading.2'].getCellTextCSSDeclarations(this.doc)
}else if(row%2===0){
css=styleMap.alternate.getCellCSSDeclarations(this.doc);
textCss=styleMap.alternate.getCellTextCSSDeclarations(this.doc)
}else{
css=styleMap.normal.getCellCSSDeclarations(this.doc);
textCss=styleMap.normal.getCellTextCSSDeclarations(this.doc)
}
css=css.replace(/\'/g,'"');
textCss=textCss.replace(/\'/g,'"');
htmlTable+='  <td style=\'white-space:nowrap;'+css+'\'><span style = \''+textCss+'\'>'+arrText[row][col]+'</span></td>\n'
}
htmlTable+='</tr>\n'
}
htmlTable+='</table>';
this.previewDiv.update(htmlTable)
}
});
Ext.reg('web-globalstyles-tables',web.panels.props.globalstyles.tables.TablesTab);
Ext.ns('web.panels.props.globalstyles.contactForm');
web.panels.props.globalstyles.contactForm.FormStyles=Ext.extend(Ext.Container,{
xtype:'web-props-formstyles',
initComponent:function(){
this.layout='vbox';
this.layoutConfig={align:'stretch'};
this.margins='20';
this.defaults={margins:'5 0 0 0'};
this.highlightColorButton=new web.ui.buttons.Highlight({
app:this.app,
listeners:{
change:function(btn,color){
var opts={block:{background:{color:color}}};
this.fireEvent('changed','buttonStyle',opts)
},
scope:this
}
});
this.foreColorButton=new Ext.Button({
iconCls:'icon icon-rte-forecolor',
scale:'small',
tooltip:'Text color.',
color:this.color,
listeners:{
winshow:function(btn,win){
var picker=win.picker;
picker.suspendEvents();
picker.setColor(btn.color,true,true);
picker.resumeEvents()
},
scope:this
},
plugins:[
new web.ui.plugins.ColorButton,
new web.ui.plugins.WindowButton({
title:'Text Color',
width:285,
cls:'color-panel-window',
items:{
ref:'picker',
xtype:'web-colorpanel',
listeners:{
change:function(btn,color){
this.foreColorButton.setColor(color);
this.fireEvent('changed','buttonTextColor',color)
},
scope:this
}
}
})
]
});
this.items=[{
xtype:'container',
layout:'hauto',
width:116,
height:22,
cls:'button-group',
items:[
this.highlightColorButton.toggleButton,
this.highlightColorButton.winButton,
this.foreColorButton
]
}];
web.panels.props.globalstyles.contactForm.FormStyles.superclass.initComponent.apply(this,arguments)
},
afterRender:function(){
web.panels.props.globalstyles.contactForm.FormStyles.superclass.afterRender.call(this);
this.setStylesheet(this.app.getSelected('stylesheet'))
},
setStylesheet:function(stylesheet){
this.stylesheet=stylesheet;
this.refresh()
},
refresh:function(){
var stylesheet=this.stylesheet,styles=stylesheet?stylesheet.getStylesByType('web.data.styles.StyleForm')[0]:null;
this.foreColorButton.setColor(styles.getColor());
this.highlightColorButton.setColor(styles.getHighlight())
}
});
Ext.ComponentMgr.registerType('web-props-formstyles',web.panels.props.globalstyles.contactForm.FormStyles);
web.panels.props.globalstyles.contactForm.ContactFormTab=Ext.extend(Ext.Container,{
xtype:'web-globalstyles-contactForm',
initComponent:function(){
var app=this.app;
this.layout='vbox';
this.layoutConfig={align:'stretch'};
this.styleForm=app.getSelected('stylesheet').getStylesByType('web.data.styles.StyleForm')[0];
this.items=[
{
xtype:'label',
margins:'20 0 0 0',
text:'Changing Global Styles affects all pages using the template ('+this.app.getSelected('template').name+')'
},
{
xtype:'container',
layout:'hbox',
cls:'green-background',
layoutConfig:{
padding:5,
align:'middle'
},
height:34,
margins:'20 0 17 0',
items:[{
xtype:'label',
text:'Style the form on all your pages'
}]
},
{
flex:1,
xtype:'container',
autoScroll:true,
cls:'autoscroll',
name:'mainContainer',
ref:'mainContainer',
layout:'hbox',
layoutConfig:{align:'stretchmax'},
items:[
{
xtype:'container',
layout:'vbox',
width:340,
height:250,
items:[{
ref:'../../formStyleContainer',
xtype:'web-props-formstyles',
app:this.app,
width:300,
height:395,
listeners:{
changed:this.update,
scope:this
}
}]
},
{
xtype:'container',
layout:'auto',
layoutConfig:{align:'stretch'},
style:'vertical-align: top;',
width:337,
items:[
{
xtype:'label',
text:'Preview',
height:20,
style:'padding: 0 0 9px 21px; display: block;'
},
{
ref:'../../previewDiv',
xtype:'label',
style:{
borderLeft:'1px solid #CED7BD',
textAlign:'center',
display:'block'
},
text:'...'
}
]
}
]
}
];
web.panels.props.globalstyles.contactForm.ContactFormTab.superclass.initComponent.apply(this,arguments);
this.mon(this.previewDiv,'afterrender',this.refreshPreview,this)
},
afterRender:function(){
web.panels.props.globalstyles.contactForm.ContactFormTab.superclass.afterRender.apply(this,arguments);
this.initListeners()
},
initListeners:function(){
this.mon(this.app,'update',function(part){
if(part instanceof web.data.styles.Style){
var root=part.getRootStyle();
if(root instanceof web.data.styles.StyleForm&&root.inStylesheet()){
this.refreshPreview()
}
}
},this)
},
setStylesheet:function(stylesheet){
this.formStyleContainer.setStylesheet(stylesheet);
this.styleForm=stylesheet.getStylesByType('web.data.styles.StyleForm')[0];
this.refreshPreview()
},
update:function(type,value){
var formStyle={};
formStyle[type]=value;
var command=new web.commands.stylesheets.EditStyle({
style:this.styleForm,
newStyle:formStyle
});
this.app.invoker.execute(command)
},
refreshPreview:function(){
if(this.previewDiv.el&&this.previewDiv.el.dom){
this.previewDiv.el.dom.innerHTML=this.getButtonHtmlWithStyle()
}
},
getButtonHtmlWithStyle:function(){
var cssStyle=this.getButtonCssStyle(),html='<div style=\'background-color:#f1f7e2;display:table;height:69px;width:100%;\'>'+'<input type=\'submit\'  style=\''+cssStyle+'\' value=\''+'Send'+'\'></div>';
return html
},
getButtonCssStyle:function(){
var style=this.styleForm;
return style?style.getButtonCSSDeclaration():''
}
});
Ext.ComponentMgr.registerType('web-globalstyles-contactForm',web.panels.props.globalstyles.contactForm.ContactFormTab);
web.windows.GlobalStyles=Ext.extend(web.windows.Window,{
type:'web.windows.GlobalStyles',
cls:'web-window-notitle',
initComponent:function(){
var that=this;
that.width=900;
that.shadow=false;
that.resizable=false;
that.modal=true;
that.items=[
{
xtype:'container',
html:'Global Styles',
cls:'globalstyles-title'
},
{
xtype:'container',
cls:'globalstyles-subtitle',
html:'Changing Global Styles affects all pages using the template "'+this.app.getSelected('template').name+'"'+'.'
},
{
xtype:'spacer',
width:that.width,
height:15
},
{
xtype:'container',
items:[{
xtype:'tabpanel',
ref:'../tabPanel',
defaults:{
height:450,
forceLayout:true,
app:this.app
},
items:[
{
ref:'../../textTab',
xtype:'web-globalstyles-texts',
title:'Text'
},
{
ref:'../../linksTab',
xtype:'web-globalstyles-links',
title:'Links'
},
{
ref:'../../menuTab',
xtype:'web-globalstyles-menus',
title:'Menus',
selectedMenuStyleId:this.selectedMenuStyleId,
component:this.component
},
{
ref:'../../cellTab',
xtype:'web-globalstyles-tables',
title:'Tables'
},
{
ref:'../../formTab',
xtype:'web-globalstyles-contactForm',
title:'Forms'
},
{
ref:'../../buttonsTab',
xtype:'web-globalstyles-buttons',
title:'Buttons'
}
]
}]
}
];
this.listeners={
beforeshow:function(){
this.resizeAndReposition();
this.app.on('resize',function(){
this.resizeAndReposition()
},this)
},
scope:this
};
web.windows.GlobalStyles.superclass.initComponent.call(this);
this.stylesheet=this.app.getSelected('stylesheet');
this.mon(this.tabPanel,'tabchange',function(tabPanel,tab){
tab.doLayout()
},this)
},
resizeAndReposition:function(){
var position,width=900,height=Math.max(Ext.getBody().getHeight()*0.9,400);
this.setSize(width,height);
if(this.textTab){
height-=126;
[
'textTab',
'linksTab',
'menuTab',
'cellTab',
'buttonsTab'
].forEach(function(tab){
this[tab].setHeight(height)
},this)
}
position=this.el.getAlignToXY(this.container,'c-c');
this.setPosition(position[0],position[1])
},
initListeners:function(){
var mousedown=function(e){
var el=e.getTarget('.ext-el-mask');
if(el&&!e.within(this.getEl())){
if(this.getEl().dom.previousSibling===el){
this.hide()
}
}
};
this.on('afterrender',function(argument){
this.tabPanel.hideTabStripItem(this.formTab)
},this);
this.on('show',function(){
var stylesheet=this.app.getSelected('stylesheet');
if(stylesheet){
this.setStylesheet(stylesheet)
}
this.mon(Ext.getBody(),'mousedown',mousedown,this)
},this);
this.on('hide',function(){
this.app.windows.hideAll();
this.mun(Ext.getBody(),'mousedown',mousedown,this);
this.menuTab.clearCSSClasses()
},this)
},
setStylesheet:function(stylesheet){
if(stylesheet!==this.stylesheet){
this.stylesheet=stylesheet;
this.textTab.setStylesheet(stylesheet);
this.linksTab.setStylesheet(stylesheet);
this.menuTab.setStylesheet(stylesheet);
this.cellTab.setStylesheet(stylesheet);
this.buttonsTab.setStylesheet(stylesheet)
}
},
setValues:function(values){
var activeTab;
if(values.activeItem!==undefined){
this.tabPanel.setActiveTab(values.activeItem)
}
activeTab=this.tabPanel.getActiveTab();
if(activeTab&&activeTab.setValues){
activeTab.setValues(values)
}
},
onShow:function(win){
var t=this.tabPanel.activeTab.refName;
t=t&&t.replace(/tab/i,'')||'';
this.app.track([
'GlobalStyles',
'open',
t
])
},
enableGlobalStyleFormTab:function(){
this.tabPanel.unhideTabStripItem(this.formTab)
}
});
web.panels.props.Menu=Ext.extend(web.panels.Panel,{
title:'',
initComponent:function(){
var styleComboCfg,styleEditCfg,mainmenutxt='Main menu',submenutxt='Submenu';
this.isMoreEnabled=this.component.getMoreButtonEnabled();
this.menuc=new web.controllers.menus.MenuStyle({app:this.app});
this.typeCombo=new web.ui.ComboBox({
name:'level',
mode:'local',
triggerAction:'all',
forceSelection:true,
editable:false,
store:this.typeDataStore(),
valueField:'id',
displayField:'text',
width:150,
listeners:{
render:function(combo){
combo.tip=new Ext.ToolTip({
target:combo.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:'Select how you would like the menu to behave.'
},
constrainPosition:true
})
}
}
});
this.itemsLevelCombo=new web.ui.ComboBox({
name:'level',
mode:'local',
triggerAction:'all',
forceSelection:true,
editable:false,
store:this.itemLevelsDataStore(),
valueField:'id',
displayField:'text',
width:150,
listeners:{
render:function(combo){
combo.tip=new Ext.ToolTip({
target:combo.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:'Select which level to start at in the menu.'
},
constrainPosition:true
})
}
}
});
this.orientationCombo=new web.ui.ComboBox({
name:'level',
mode:'local',
triggerAction:'all',
forceSelection:true,
editable:false,
store:new Ext.data.ArrayStore({
fields:[
'id',
'text'
],
data:[
[
'h',
'Horizontal'
],
[
'v',
'Vertical'
]
]
}),
valueField:'id',
displayField:'text',
width:150,
listeners:{
render:function(combo){
combo.tip=new Ext.ToolTip({
target:combo.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:'Select horizontal or vertical orientation.'
},
constrainPosition:true
})
}
}
});
this.alignCombo=new web.ui.fields.AlignmentField({
width:150,
name:'level'
});
styleComboCfg={
width:126,
name:'menuStyleNumber',
mode:'local',
triggerAction:'all',
forceSelection:true,
editable:false,
store:this.menuc.getMenuStylesDataStore(),
valueField:'id',
displayField:'text'
};
styleEditCfg={
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
tooltip:'Edit menu styles.',
style:'border-left: 0 none;'
};
this.styleCombo=new web.ui.ComboBox(styleComboCfg);
this.styleEdit=new Ext.Button(styleEditCfg);
this.subStyleCombo=new web.ui.ComboBox(styleComboCfg);
this.subStyleEdit=new Ext.Button(styleEditCfg);
this.moreText='More';
this.layout='border';
this.cls='web-props-panel';
this.items=[{
xtype:'container',
region:'center',
style:{
padding:'20px 0 20px 20px',
'overflow-y':'auto'
},
defaults:{
xtype:'container',
width:267
},
items:[
{
layout:'hflex',
layoutConfig:{align:'middle'},
style:{paddingBottom:'10px'},
items:[
{
xtype:'label',
text:'Menu type:',
flex:1
},
this.typeCombo
]
},
{
layout:'hflex',
layoutConfig:{align:'middle'},
style:{paddingBottom:'10px'},
items:[
{
xtype:'label',
text:'Start level:',
flex:1
},
this.itemsLevelCombo
]
},
{
layout:'hflex',
layoutConfig:{align:'middle'},
style:{paddingBottom:'10px'},
items:[
{
xtype:'label',
text:'Orientation:',
flex:1
},
this.orientationCombo
]
},
{
layout:'hflex',
layoutConfig:{align:'middle'},
style:{paddingBottom:'10px'},
items:[
{
xtype:'label',
text:'Alignment:',
flex:1
},
this.alignCombo
]
},
{
style:{paddingBottom:'10px'},
items:[
{
xtype:'label',
text:'Preview:'
},
{
xtype:'container',
ref:'../../stylingLayout',
style:'border: 1px solid #ccc; padding: 10px;position:relative;width:auto',
height:120,
html:{
cn:[
{
cls:'web-menu-mainmenu',
cn:[
{html:mainmenutxt},
{html:mainmenutxt},
{
html:mainmenutxt,
cls:'web-menu-mainmenu-last'
}
]
},
{
cls:'web-menu-submenu',
cn:[
{html:submenutxt},
{html:submenutxt}
]
}
]
}
}
]
},
{
layout:'hauto',
style:{paddingBottom:'10px'},
items:[
{
xtype:'label',
width:117,
style:'padding-right:5px;',
text:'Main menu styling:'
},
{
xtype:'container',
layout:'hauto',
cls:'web-panel-button-group-new',
items:[
this.styleCombo,
this.styleEdit
]
}
]
},
{
layout:'hauto',
style:{paddingBottom:'10px'},
items:[
{
xtype:'label',
width:117,
style:'padding-right:5px;',
ref:'../../subStyleLabel',
text:'Submenus styling:'
},
{
xtype:'container',
layout:'hauto',
cls:'web-panel-button-group-new',
items:[
this.subStyleCombo,
this.subStyleEdit
]
}
]
},
{
ref:'../moreButton',
xtype:'checkbox',
boxLabel:'Enable "'+this.moreText+'" button',
id:'enableMoreButton',
handler:function(){
var checkbox=Ext.getCmp('enableMoreButton'),checked=checkbox.getValue();
if(this.component.getMoreButtonEnabled()!==checked){
this.updateMenuComponent({moreButtonEnabled:checked})
}
},
scope:this
},
{
ref:'../moreButtonTip',
xtype:'label',
cls:'helptext',
text:'If your pages don\'t all fit in the menu, they will list themselves under this button.'
},
{
xtype:'container',
ref:'../moreTextCntnr',
cls:'hbox cross-center',
style:{paddingTop:'10px'},
items:[
{
xtype:'container',
cls:'flex',
html:'Button text'+':'
},
{
xtype:'textfield',
ref:'../../moreTextField',
maxLengthText:'The maximum length for this field is '+20,
maxLength:20,
enableKeyEvents:true,
autoCreate:{
tag:'input',
type:'text'
},
width:145,
style:{padding:'2px 5px'},
validateOnBlur:false,
listeners:{
valid:function(field){
var currentValue=field.getValue();
if(currentValue!==this.component.getMoreText()){
this.updateMenuComponent({moreText:currentValue})
}
},
afterrender:function(field){
Ext.QuickTips.register({
target:field.getEl(),
text:'The text that appears in the menu.'
})
},
scope:this
}
},
{
xtype:'spacer',
width:1
}
]
}
]
}];
web.panels.props.Menu.superclass.initComponent.apply(this,arguments);
this.styleCombo.on('select',function(){
this.updateMenuComponent({menuStyle:{globalId:this.styleCombo.getValue()}})
},this);
this.styleEdit.on('click',function(){
this.app.windows.show({
type:'web.windows.GlobalStyles',
values:{
activeItem:2,
selectedMenuStyleId:this.styleCombo.getValue()
}
})
},this);
this.subStyleCombo.on('select',function(){
var cfg=this.component.getAccordion()?{
accordionStyles:[{globalId:this.subStyleCombo.getValue()}],
cascadeStyles:[]
}:{
cascadeStyles:[{globalId:this.subStyleCombo.getValue()}],
accordionStyles:[]
};
this.updateMenuComponent(cfg)
},this);
this.subStyleEdit.on('click',function(){
this.app.windows.show({
type:'web.windows.GlobalStyles',
values:{
activeItem:2,
selectedMenuStyleId:this.subStyleCombo.getValue()
}
})
},this);
this.orientationCombo.on('select',function(combo,record,index){
var isVertical=record.data.id==='v';
this.refreshLayout();
var cfg={vertical:isVertical};
if(isVertical){
this.isMoreEnabled=this.component.getMoreButtonEnabled()
}else{
cfg.accordion=0;
cfg.cascade=9;
cfg.verticalAlign='middle';
cfg.horizontalAlign='left'
}
cfg.moreButtonEnabled=!isVertical&&(this.isMoreEnabled||this.component.getMoreButtonEnabled());
this.updateMenuComponent(cfg)
},this);
this.itemsLevelCombo.on('select',function(){
this.updateMenuComponent({level:this.itemsLevelCombo.value})
},this);
this.alignCombo.on('change',function(field,value,oldValue){
this.updateMenuComponent({
verticalAlign:value[0]||undefined,
horizontalAlign:value[1]
})
},this);
this.typeCombo.on('select',function(){
var value=this.typeCombo.value,cfg=value==='accordion'?{
accordion:9,
cascade:0,
vertical:true
}:value==='cascade'?{
accordion:0,
cascade:9
}:{
accordion:0,
cascade:0
};
this.updateMenuComponent(cfg);
this.refreshLayout()
},this);
this.app.on('update',function(part){
if(part instanceof web.data.styles.Stylesheet){
this.refreshStyles()
}
},this)
},
setComponent:function(component){
this.component=component;
this.refresh()
},
refreshLayout:function(){
var component=this.component,isVertical=component.isVertical(),accordion=component.getAccordion(),cascade=component.getCascade(),cls='web-menu-stylinglayout web-menu-stylinglayout-'+(isVertical?'vertical':'horizontal')+(accordion?'accordion':'')+(cascade?'cascade':'');
this.stylingLayout.getEl().dom.className=cls+' x-box-item'
},
refreshStyles:function(){
var component=this.component,accordion=component.getAccordion(),cascade=component.getCascade(),style=component.getMenuStyle();
this.styleCombo.bindStore(this.menuc.getMenuStylesDataStore());
this.styleCombo.setValue(style.globalId);
if(accordion||cascade){
this.subStyleCombo.bindStore(this.menuc.getMenuStylesDataStore());
this.subStyleCombo.setValue(((accordion?component.getAccordionStyles()[0]:component.getCascadeStyles()[0])||style).globalId);
this.subStyleLabel.show();
this.subStyleCombo.show();
this.subStyleEdit.show()
}else{
this.subStyleLabel.hide();
this.subStyleCombo.hide();
this.subStyleEdit.hide()
}
},
refresh:function(){
var component=this.component,horizontalAlign=component.getHorizontalAlign(),verticalAlign=component.getVerticalAlign(),accordion=component.getAccordion(),cascade=component.getCascade(),moreButtonEnabled=component.getMoreButtonEnabled()&&!component.isVertical(),moreText=component.getMoreText();
this.allComponents('suspendEvents');
this.moreButton.setValue(moreButtonEnabled);
this.moreTextField.setValue(moreText);
this.typeCombo.bindStore(this.typeDataStore());
this.typeCombo.setValue(accordion?'accordion':cascade?'cascade':'single');
if(!accordion){
if(component.isVertical()){
this.orientationCombo.setValue('v');
this.moreButton.disable();
this.moreButtonTip.hide();
this.moreTextCntnr.hide()
}else{
this.orientationCombo.setValue('h');
if(horizontalAlign!=='fit'&&cascade){
this.moreButton.enable();
this.moreButtonTip.show();
this.moreTextCntnr.setVisible(this.moreButton.getValue())
}else{
this.moreButton.disable();
this.moreButtonTip.hide();
this.moreTextCntnr.hide()
}
}
this.orientationCombo.enable()
}else{
this.orientationCombo.disable();
this.moreButton.disable();
this.moreButtonTip.hide();
this.moreTextCntnr.hide()
}
this.alignCombo.setValue([
verticalAlign||'top',
horizontalAlign
]);
this.refreshStyles();
this.itemsLevelCombo.bindStore(this.itemLevelsDataStore());
this.itemsLevelCombo.setValue(component.getLevel());
this.allComponents('resumeEvents');
this.refreshLayout()
},
allComponents:function(funcName){
var formFields=[
this.styleCombo,
this.subStyleCombo,
this.orientationCombo,
this.itemsLevelCombo,
this.alignCombo,
this.moreButton,
this.moreTextField
],i;
for(i in formFields){
if(formFields.hasOwnProperty(i)){
formFields[i][funcName]()
}
}
},
typeDataStore:function(){
var types={
accordion:'Tree',
cascade:'Drop-down',
single:'Single level'
},arr=[],name;
arr=[];
for(name in types){
if(types.hasOwnProperty(name)){
arr.push([
name,
types[name]
])
}
}
return new Ext.data.ArrayStore({
fields:[
'id',
'text'
],
data:arr
})
},
itemLevelsDataStore:function(){
var i,fnFindDepth,depth,root=this.app.site.folder,numbers,arr;
fnFindDepth=function(node){
var i,d,max;
if(node.type!=='web.data.links.LinkPage'){
return 1
}
for(i=0,max=0;i<node.items.length;i+=1){
d=fnFindDepth(node.items[i]);
max=Math.max(d,max)
}
return 1+max
};
depth=fnFindDepth(root)-1;
numbers=[
'',
'Pages on first level',
'Pages on second level',
'Pages on third level',
'Pages on fourth level',
'Pages on fifth level',
'Pages on sixth level',
'Pages on seventh level',
'Pages on eighth level',
'Pages on ninth level'
];
arr=[];
for(i=1;i<=depth;i+=1){
arr.push([
i,
numbers[i]
])
}
return new Ext.data.ArrayStore({
fields:[
'id',
'text'
],
data:arr
})
},
updateMenuComponent:function(props){
var command=new web.commands.menus.Update({
component:this.component,
props:props
});
this.app.invoker.execute(command)
}
});
web.panels.props.Page=Ext.extend(web.panels.Panel,{
initComponent:function(){
this.cls='web-props-panel';
this.style={padding:'20px 0 20px 20px'};
this.defaults={
xtype:'container',
cls:'hbox cross-center',
width:267,
style:{paddingBottom:'10px'}
};
this.items=[
{
items:[
{
xtype:'container',
cls:'flex',
html:'Title:'
},
{
xtype:'label',
ref:'../pageTitle',
text:'.',
style:'overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 180px; max-width: 180px; text-align: right;'
},
{
xtype:'spacer',
width:10
},
{
xtype:'button',
tooltip:'Page Info.',
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
labelSeparator:'',
fieldLabel:' ',
listeners:{
click:function(btn,e){
this.app.panels.sitemap.controller.updatePageProperties();
e.stopPropagation()
},
scope:this
}
}
]
},
{
items:[
{
xtype:'container',
cls:'flex',
html:'Current template:'
},
{
xtype:'label',
ref:'../templateTitle',
style:'text-align: right; max-width: 125px; word-break: break-all;',
width:125,
text:''
},
{
xtype:'spacer',
width:10
},
{
xtype:'button',
tooltip:'Switch template for this page.',
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-change-template\' />',
labelSeparator:'',
fieldLabel:' ',
handler:function(){
var templateWindow=this.app.windows.get('web.windows.TemplateList');
if(templateWindow){
templateWindow.win.parent=null;
templateWindow.win.show()
}else{
this.app.windows.show({
type:'web.windows.TemplateList',
app:this.app
})
}
},
scope:this
}
]
}
];
web.panels.props.Page.superclass.initComponent.call(this);
this.setComponent(this.app.getSelected('page'))
},
initListeners:function(){
this.mon(this.app,'update',function(part){
if(this.page&&part.getPageId&&part.getPageId()===this.page.getId()){
this.refresh()
}
},this)
},
setComponent:function(page){
this.page=page;
this.refresh()
},
refresh:function(){
var linkPage=this.page?this.app.site.getFolder().findLinkPage(this.page.getId()):null,title=linkPage?linkPage.getName():'',templateName;
Ext.QuickTips.init();
this.template=this.page.getTemplate()||this.app.getSelected('template');
this.pageTitle.setText(title||'.');
Ext.QuickTips.register({
target:this.pageTitle,
text:title
});
templateName=this.template&&this.template.name||'';
this.templateTitle.setText(templateName);
Ext.QuickTips.register({
target:this.templateTitle,
text:templateName
})
}
});
web.commands.text.ApplyLink=Ext.extend(web.commands.text.Insert,{
constructor:function(cfg){
web.commands.text.ApplyLink.superclass.constructor.call(this,cfg)
},
execute:function(){
var target=this.target,link=this.link,start=this.start,end=this.end;
this.oldJSON=target.toJSON();
target.removeLinks(start,end);
target.applyLink(link,start,end);
this.newJSON=target.toJSON();
this.fireEvent('update',target)
}
});
web.commands.text.RemoveLinks=Ext.extend(web.commands.text.Insert,{
constructor:function(cfg){
web.commands.text.RemoveLinks.superclass.constructor.call(this,cfg)
},
execute:function(){
var target=this.target;
this.oldJSON=target.toJSON();
target.removeLinks(this.start,this.end);
this.newJSON=target.toJSON();
this.fireEvent('update',target)
}
});
web.panels.props.richtext.Font=Ext.extend(web.panels.props.richtext.Style,{
xtype:'web-props-font',
initComponent:function(){
this.selection={
start:0,
end:0
};
this.title='';
this.global=new web.ui.ComboBox({
itemId:'globalId',
tpl:'<tpl for=".">'+'<tpl if="cls == null">'+'<hr />'+'</tpl>'+'<div class="x-combo-list-item" style="{style}">{name}</div>'+'</tpl>',
store:new Ext.data.ArrayStore({
idIndex:0,
fields:[
'id',
'cls',
'style',
'name'
],
data:[]
}),
valueField:'id',
displayField:'name',
mode:'local',
triggerAction:'all',
editable:false,
value:0,
width:120,
listWidth:'auto',
lazyInit:false,
listeners:{
render:function(combo){
combo.tip=new Ext.ToolTip({
target:combo.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:'Text style'
}
})
},
select:function(combo){
if(combo.getValue()==='call-onClear()'){
this.onClear()
}else{
this.onTextStyleSelect(combo)
}
},
afterrender:function(){
this.global.list.setStyle('min-width','118px')
},
scope:this
}
});
var that=this;
this.linkSelectorCombo=new web.ui.ComboBox({
itemId:'globalId',
store:this.getLinkStylesDataStore(),
valueField:'id',
displayField:'text',
mode:'local',
triggerAction:'all',
editable:false,
width:125,
listWidth:'auto',
lazyInit:false,
listeners:{
select:function(combo){
this.onLinkStyleSelect(combo)
},
afterrender:function(){
this.linkSelectorCombo.list.setStyle('min-width','120px')
},
scope:this
}
});
this.linkSelectorCombo.setValue(that.linkSelectorCombo.getStore().getAt(0).json[0]);
this.clear=new Ext.Button({
itemId:'clear',
hidden:true,
text:'Clear Styling',
tooltip:'Clear the styling of the highlighted text.',
scale:'small',
handler:this.onClear,
scope:this
});
this.editTextStyles=new Ext.Button({
itemId:'editStyles',
tooltip:'Edit Text Styles',
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
handler:function(){
this.popupGlobalStyles(0)
},
scope:this
});
this.superscript=new Ext.Button({
itemId:'superscript',
tooltip:'Superscript.',
iconCls:'icon icon-rte-superscript',
scale:'small',
enableToggle:true,
handler:this.onClick,
scope:this
});
this.subscript=new Ext.Button({
itemId:'subscript',
tooltip:'Subscript.',
iconCls:'icon icon-rte-subscript',
scale:'small',
enableToggle:true,
handler:this.onClick,
scope:this
});
this.link=new Ext.Button({
itemId:'link',
tooltip:'Add Link.',
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-text-link\' />',
listeners:{
click:this.addLink,
scope:this
}
});
this.linkName=new Ext.form.Label({style:{paddingRight:'5px'}});
this.unlink=new Ext.Button({
itemId:'unlink',
tooltip:'Remove link.',
cls:'props-panel-remove-button',
listeners:{
click:this.removeLink,
scope:this
}
});
this.editLinkStyles=new Ext.Button({
itemId:'editStyles',
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
tooltip:'Edit Link Styles',
disabled:true,
handler:function(){
this.toggleLinkStyleSelector()
},
scope:this
});
this.linkStyleSelector=new Ext.Container({
items:[
{
xtype:'container',
cls:'hbox cross-center',
items:[
{
xtype:'container',
cls:'flex',
html:'Link:'
},
this.linkName,
this.unlink,
{
xtype:'container',
cls:'web-panel-button-group-new',
items:[
this.link,
this.editLinkStyles
]
}
]
},
{
xtype:'spacer',
ref:'panelBodyPatch',
cls:'custom-panel-patch-holder',
height:'2px',
html:'<div class="custom-panel-body-patch"></div>'
},
{
xtype:'container',
ref:'linkSelectorPanelBody',
style:'max-width: 270px',
layout:'auto',
ctCls:'custom-linkselector-panel',
cls:'custom-linkselector-body',
items:[
{
xtype:'label',
html:'Choose a link style'
},
{
xtype:'spacer',
height:10
},
this.linkSelectorCombo,
{
xtype:'spacer',
height:10
},
{
xtype:'button',
cls:'one-link-btn ',
ref:'EditGlobalLinkStyles',
html:'<a href="#">'+'Edit global link styles'+'</a>',
listeners:{
click:function(){
this.popupGlobalStyles(1,this.linkSelectorCombo.getValue())
},
scope:this
}
}
]
}
]
});
web.panels.props.richtext.Font.superclass.initComponent.apply(this,arguments)
},
getLinkStylesDataStore:function(){
var styles=[],stylesheet=this.app.getSelected('stylesheet');
for(var i=0;i<stylesheet.styles.length;i++){
if(stylesheet.styles[i].type==='web.data.styles.StyleLink'){
styles.push(stylesheet.styles[i])
}
}
var data=styles.map(function(style){
return[
style.id,
'Link Style '+style.getRef().replace(/^link\./,''),
style
]
});
var dataStore=new Ext.data.ArrayStore({
fields:[
'id',
'text',
'style'
],
data:data
});
return dataStore
},
initStylePanel:function(){
this.layout='vbox';
this.layoutConfig={align:'stretch'};
this.width=315;
this.height=150;
this.font.setWidth(102)
},
setAction:function(action){
this.action=action;
this.refresh()
},
resetLinkStyleSelector:function(){
var that=this,styleLinks=that.app.getSelected('stylesheet').getStylesByType('web.data.styles.StyleLink'),data=[];
data=styleLinks.map(function(styleLink){
return[
styleLink.id,
'Link Style '+styleLink.getRef().replace(/^link\./,''),
styleLink
]
});
that.linkSelectorCombo.getStore().removeAll();
that.linkSelectorCombo.getStore().loadData(data)
},
resetStylesheet:function(){
var global=this.global,stylesheet,styles,style,store,globals=[],types=web.data.styles.StyleText.types;
web.panels.props.richtext.Font.superclass.resetStylesheet.call(this);
var limitFontSize=function(css){
return css.replace(/(^|;)[ ]*font-size[ ]*:[ ]*([^;]+|$)/i,function(m,p1,p2){
var size=parseInt(p2,10);
return p1+'font-size: '+(size>24?24:size)+'px'
}).replace(/"/g,'&quot;')
};
if(global){
stylesheet=this.app.getSelected('stylesheet');
if(stylesheet){
styles=stylesheet.getStylesByType('web.data.styles.StyleText');
store=global.getStore();
store.removeAll();
styles.forEach(function(style){
var ref=style.getRef();
if(types[ref]){
globals.push([
style.getId(),
style.getCSSClass(),
limitFontSize(style.getCSSDeclarations().replace(/\n/g,' ')),
types[ref].NAME
])
}
},this);
if(!globals.length){
style=this.defaultStyle;
globals.push([
style.getId(),
style.getCSSClass(),
limitFontSize(style.getCSSDeclarations().replace(/\n/g,' ')),
types.normal.NAME
])
}
globals.push([
'call-onClear()',
null,
'',
'Clear Styling'
]);
store.loadData(globals)
}
}
},
setPart:function(part){
if(part instanceof web.data.components.Text&&!this.part){
this.part=part;
return part
}
},
initMyListeners:function(){
this.app.on('select',function(part){
if(this.setPart(part)){
this.part=part;
var currentLinks=part.getCurrentLinks(this.getSelStart(),this.getSelEnd());
if(currentLinks&&currentLinks.length){
this.linkSelectorCombo.bindStore(this.getLinkStylesDataStore());
this.linkSelectorCombo.setValue(currentLinks[0].style.globalId);
this.editLinkStyles.enable()
}else{
this.disableAndResetLinkStyleSelector()
}
}
},this);
this.app.on('deselect',function(part){
if(part===this.part){
this.part=null
}
},this);
this.app.properties.on('select',function(part,cfg){
if(cfg&&cfg.aspectType==='style'){
this.part=part.getParent();
this.refresh()
}
},this);
this.app.properties.on('deselect',function(part){
if(part===this.textStyle||part===this.action){
this.refresh()
}
},this);
this.app.workspace.rte.on('select',function(cfg){
var that=this,currentLinks;
this.setPart(cfg.component);
that.setSelection(cfg.start,cfg.end);
if(that.part){
currentLinks=that.part.getCurrentLinks(that.getSelStart(),that.getSelEnd());
if(currentLinks&&currentLinks.length){
that.linkSelectorCombo.setValue(currentLinks[0].style.globalId);
that.editLinkStyles.enable()
}else{
that.disableAndResetLinkStyleSelector()
}
}
that.refresh()
},this);
this.app.workspace.multiSelect.on('multiselect',function(components){
var part=components.length===1?components[0]:null,len;
if(part instanceof web.data.components.Text){
len=part.richtext.text.length;
this.part=part;
part.position(0,len);
this.setSelection(0,len);
this.refresh()
}
},this);
this.app.on('update',function(part){
if(part instanceof web.data.components.Text||part===this.action){
this.refresh()
}
if(part instanceof web.data.styles.StyleText&&part.inStylesheet()){
this.resetStylesheet()
}
if(part instanceof web.data.styles.Stylesheet){
this.resetLinkStyleSelector()
}
},this)
},
setSelection:function(start,end){
this.selection.start=start;
this.selection.end=end
},
getSelStart:function(){
return this.selection.start
},
getSelEnd:function(){
return this.selection.end
},
refresh:function(){
var global,subscript,superscript,style=this.textStyle,action,isRange,defaultStyle=this.defaultStyle,part=this.part||this.app.getSelected('component'),linkName='None',brokenLinkName='Broken link';
if(part&&part instanceof web.data.components.Text){
style=part.getCurrentStyles(this.getSelStart(),this.getSelEnd())[0];
action=part.getCurrentLinks(this.getSelStart(),this.getSelEnd())[0];
isRange=this.getSelStart()<this.getSelEnd();
this.textStyle=style;
this.action=action
}
if(style){
subscript=style.isSubscript();
superscript=style.isSuperscript();
global=style.getGlobal();
if(global){
subscript=subscript!==null?subscript:global.isSubscript();
superscript=superscript!==null?superscript:global.isSuperscript()
}
}
if(defaultStyle){
subscript=subscript!==null?subscript:defaultStyle.isSubscript();
superscript=superscript!==null?superscript:defaultStyle.isSuperscript()
}
this.global.setValue(global&&global.getRef()?global.getId():defaultStyle.getId());
this.link.setDisabled(!action&&!isRange);
this.unlink.setDisabled(!action);
this.clear.setDisabled(!isRange||!style);
if(action){
linkName=action.linkId&&this.app.dm.get(action.linkId)?this.app.dm.get(action.linkId).name:action.link?action.link.name:linkName;
linkName=web.utils.String.formatLink(linkName);
if(action.link&&action.link.name===web.windows.Link.DUMMY_URL||action.linkId&&this.app.dm.get(action.linkId)===undefined){
linkName=brokenLinkName
}
}
this.linkName.setText(linkName);
this.subscript.toggle(!!subscript&&!superscript);
this.superscript.toggle(!!superscript&&!subscript);
var currentLinks=this.part?this.part.getCurrentLinks(this.getSelStart(),this.getSelEnd()):[];
if(currentLinks&&currentLinks.length){
this.linkSelectorCombo.bindStore(this.getLinkStylesDataStore());
this.linkSelectorCombo.setValue(currentLinks[0].style.globalId);
this.editLinkStyles.enable()
}else{
this.disableAndResetLinkStyleSelector()
}
web.panels.props.richtext.Font.superclass.refresh.call(this)
},
onTextStyleSelect:function(combo){
var style={};
style[combo.itemId]=combo.getValue();
this.applyStyle(style,true);
this.focusOnEditor()
},
onLinkStyleSelect:function(combo){
var that=this,part=that.part,start=that.getSelStart(),end=that.getSelEnd(),action=that.part.getCurrentLinks(start,end)[0];
action.style.globalId=combo.getValue();
that.app.invoker.execute(new web.commands.text.ApplyLink({
target:part,
link:action.toJSON(),
start:start,
end:end
}))
},
onClear:function(){
this.app.invoker.execute(new web.commands.text.RemoveStyles({target:this.part}))
},
toggleLinkStyleSelector:function(hideForcefully){
if(hideForcefully){
if(this.linkStyleSelector.panelBodyPatch&&this.linkStyleSelector.panelBodyPatch.el){
this.linkStyleSelector.panelBodyPatch.el.removeClass('custom-panel-patch-holder-visible')
}
if(this.linkStyleSelector.linkSelectorPanelBody&&this.linkStyleSelector.linkSelectorPanelBody.el){
this.linkStyleSelector.linkSelectorPanelBody.el.removeClass('custom-panel-isExpanded linkselector-panel-visible')
}
}else{
this.linkStyleSelector.panelBodyPatch.el.toggleClass('custom-panel-patch-holder-visible');
this.linkStyleSelector.linkSelectorPanelBody.el.toggleClass('custom-panel-isExpanded linkselector-panel-visible')
}
},
popupGlobalStyles:function(tabIndex,comboValue){
this.app.windows.show({
type:'web.windows.GlobalStyles',
values:{
activeItem:tabIndex,
style:this.app.dm.get(comboValue)
}
})
},
applyStyle:function(style,replace){
var app=this.app;
if(this.getSelStart()===this.getSelEnd()){
if(replace){
app.workspace.rte.clearPreselectedStyles()
}
app.workspace.rte.setPreselectedStyles({style:style})
}else{
var part=this.part||this.app.getSelected('component');
if(part instanceof web.data.components.Text){
app.invoker.execute(new web.commands.text.ApplyStyle({
target:part,
style:style,
replace:replace
}))
}
}
},
addLink:function(){
var part=this.part,start=this.getSelStart(),end=this.getSelEnd(),currentLink,win;
if(part.richtext.paras.isStart(start+1)){
start+=1
}
currentLink=part.getCurrentLinks(start,end)[0];
win=this.app.windows.show({
type:'web.windows.Link',
values:currentLink,
okFn:function(wn,linkType,actionType,value){
var link,action,stylesheet=this.app.getSelected('stylesheet'),style=stylesheet.getStyleByRef('link.'+this.linkSelectorCombo.getRawValue().match(/\d+/),'StyleLink');
if(linkType===null){
this.removeLink();
return
}else if(linkType==='linkId'){
link=this.app.dm.get(value);
action={
linkId:link.getId(),
style:{type:'web.data.styles.StyleLink'}
}
}else if(linkType==='href'){
action={
link:{
type:'web.data.links.LinkExternal',
name:value,
url:value
},
style:{type:'web.data.styles.StyleLink'}
}
}
link=link||action.link;
if(link){
if(link.name){
this.linkName.setText(web.utils.String.formatLink(link.name));
this.unlink.enable();
this.editLinkStyles.enable()
}
}else{
this.linkName.setText('None');
this.unlink.disable()
}
action.actionType=actionType;
if(style){
action.style.globalId=style.getId()
}
this.app.invoker.execute(new web.commands.text.ApplyLink({
target:part,
link:action,
start:currentLink?Math.min(start,currentLink.start):start,
end:currentLink?Math.max(end,currentLink.end):end
}))
},
scope:this
});
win.setValues(currentLink)
},
enableAndChooseLinkStyleSelector:function(){
},
disableAndResetLinkStyleSelector:function(){
var that=this;
that.editLinkStyles.disable();
that.toggleLinkStyleSelector(true);
that.linkSelectorCombo.setValue(that.linkSelectorCombo.getStore().getAt(0).json[0])
},
removeLink:function(){
var that=this,app=that.app,part=that.part,start=that.getSelStart(),end=that.getSelEnd(),link=part.getCurrentLinks(start,end)[0];
that.linkName.setText('None');
that.unlink.disable();
that.disableAndResetLinkStyleSelector();
app.invoker.execute(new web.commands.text.RemoveLinks({
target:part,
start:start===end?link.start:start,
end:start===end?link.end:end
}))
}
});
Ext.ComponentMgr.registerType('web-props-font',web.panels.props.richtext.Font);
web.ui.textPanel.ListPanel=Ext.extend(Ext.Container,{
constructor:function(cfg){
var that=this;
this.layout={type:'auto'};
this.getAlphaIndex=function(value,listType){
var charCode=value.charCodeAt(0),result=!isNaN(value)&&value>0&&Math.round(value)===+value?value:null;
if(result===null){
if(listType==='lower-alpha'&&charCode>=97&&charCode<=122){
result=charCode-96
}
if(listType==='upper-alpha'&&charCode>=65&&charCode<=90){
result=charCode-64
}
}
return result
};
this.orderedListSplitButton=new web.ui.SplitButton({
toggleButton:{
tooltip:'Ordered List.',
iconCls:'icon icon-rte-insertorderedlist'
},
winButton:{
itemId:'ordered',
scope:this,
ref:'../settingsGearBtn',
cls:'splitbutton-win custom-color-panel-gear-btn',
enableToggle:true,
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
tooltip:'Edit list style',
width:26,
bullet:'decimal',
setBullet:function(bullet){
this.bullet=bullet;
that.orderedList.suspendEvents();
that.orderedList.setValue(this.bullet);
that.orderedList.resumeEvents()
},
listeners:{
click:function(){
var textListPanelConatiner=this.getEl().findParent('.listTextPanelContainer',10);
if(!this.propertiesPanelBody.getEl().hasClass('text-unOrderedListPanel-visible')){
Ext.get(textListPanelConatiner.id).toggleClass('listTextPanelContainer-isExpanded')
}else if(this.unorderedListSplitButton.winButton.pressed){
this.unorderedListSplitButton.winButton.toggle();
this.panelBodyPatch.getEl().removeClass('custom-panel-patch-holder-visible')
}
this.panelBodyPatch.getEl().toggleClass('custom-panel-patch-holder-visible');
this.panelBodyPatch.getEl().removeClass('custom-panel-patch-holder-visible-unOrderedList');
if(this.panelBodyPatch.getEl().hasClass('custom-panel-patch-holder-visible')){
this.orderedListSplitButton.winButton.addClass('x-btn-pressed')
}
this.propertiesPanelBody.getEl().removeClass('text-unOrderedListPanel-visible');
this.propertiesPanelBody.getEl().toggleClass('custom-panel-isExpanded text-orderedListPanel-visible')
},
scope:this
}
},
items:[]
});
this.orderedStart=new Ext.form.TextField({
xtype:'textfield',
fieldLabel:'Start at',
emptyText:'Only integers',
itemCls:'web-panels-para-startat',
width:150,
enableKeyEvents:true,
listeners:{
keyup:function(field){
var value=field.getRawValue();
if(value.trim()!==''){
that.orderedListSplitButton.winButton.order=that.getAlphaIndex(value,that.orderedList.getValue())
}else{
that.orderedListSplitButton.winButton.order=null;
field.setValue('')
}
if(that.orderedListSplitButton.toggleButton.pressed&&field.value!==value){
this.fireEvent('change',this.orderedListSplitButton)
}
},
focus:function(field){
if(that.getAlphaIndex(field.getRawValue(),that.orderedList.getValue())===null){
field.setValue('')
}
},
scope:this
},
value:''
});
this.orderedList=new web.ui.ComboBox({
disabled:false,
editable:false,
width:150,
name:'repeat',
tpl:'<tpl for="."><div class="x-combo-list-item"><ol class="list-ui" style="list-style-type:{listType};"><li>{text}</li></ol></div></tpl>',
mode:'local',
triggerAction:'all',
forceSelection:true,
store:new Ext.data.ArrayStore({
fields:[
'listType',
'text'
],
data:[
[
'decimal',
'Decimal'
],
[
'lower-alpha',
'Lower Alphabetical'
],
[
'upper-alpha',
'Upper Alphabetical'
],
[
'lower-roman',
'Lower Roman Numerals'
],
[
'upper-roman',
'Upper Roman Numerals'
]
]
}),
valueField:'listType',
displayField:'text',
listeners:{
select:function(unorderedListGroup,selected){
this.orderedListSplitButton.winButton.bullet=selected.data.listType||'circle';
if(this.orderedListSplitButton.toggleButton.pressed){
this.fireEvent('change',this.orderedListSplitButton)
}
},
scope:this
}
});
this.unorderedListSplitButton=new web.ui.SplitButton({
toggleButton:{
tooltip:'Unordered List.',
iconCls:'icon icon-rte-insertunorderedlist'
},
winButton:{
itemId:'unordered',
scope:this,
ref:'../settingsGearBtn',
cls:'splitbutton-win custom-color-panel-gear-btn',
enableToggle:true,
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
tooltip:'Edit list style',
width:26,
bullet:'disc',
setBullet:function(bullet){
this.bullet=bullet;
that.unorderedList.suspendEvents();
that.unorderedList.setValue(this.bullet);
that.unorderedList.resumeEvents()
},
listeners:{
click:function(){
var textListPanelConatiner=this.getEl().findParent('.listTextPanelContainer',10);
if(!this.propertiesPanelBody.getEl().hasClass('text-orderedListPanel-visible')){
Ext.get(textListPanelConatiner.id).toggleClass('listTextPanelContainer-isExpanded')
}else if(this.orderedListSplitButton.winButton.pressed){
this.orderedListSplitButton.winButton.toggle();
this.panelBodyPatch.getEl().removeClass('custom-panel-patch-holder-visible ')
}
this.panelBodyPatch.getEl().toggleClass('custom-panel-patch-holder-visible');
this.panelBodyPatch.getEl().removeClass('custom-panel-patch-holder-visible-orderedList');
if(this.panelBodyPatch.getEl().hasClass('custom-panel-patch-holder-visible')){
this.unorderedListSplitButton.winButton.addClass('x-btn-pressed');
this.panelBodyPatch.getEl().addClass('custom-panel-patch-holder-visible-unOrderedList')
}
this.propertiesPanelBody.getEl().removeClass('text-orderedListPanel-visible');
this.propertiesPanelBody.getEl().toggleClass('custom-panel-isExpanded text-unOrderedListPanel-visible')
},
scope:this
}
},
items:[]
});
this.unorderedList=new web.ui.ComboBox({
disabled:false,
editable:false,
width:150,
name:'repeat',
tpl:'<tpl for="."><div class="x-combo-list-item"><ul class="list-ui" style="list-style-type:{listType};"><li>{text}</li></ul></div></tpl>',
mode:'local',
triggerAction:'all',
forceSelection:true,
store:new Ext.data.ArrayStore({
fields:[
'listType',
'text'
],
data:[
[
'circle',
'Circle'
],
[
'disc',
'Disc'
],
[
'square',
'Square'
]
]
}),
valueField:'listType',
displayField:'text',
listeners:{
select:function(unorderedListGroup,selected){
this.unorderedListSplitButton.winButton.bullet=selected.data.listType||'circle';
if(this.unorderedListSplitButton.toggleButton.pressed){
this.fireEvent('change',this.unorderedListSplitButton)
}
},
scope:this
}
});
this.outdent=new Ext.Button({
itemId:'outdent',
tooltip:'Outdent text.',
cls:'text-panel-indent-ui',
iconCls:'icon icon-rte-outdent',
width:26,
handler:function(){
this.fireEvent('changeOutdent',this)
},
scope:this
});
this.indent=new Ext.Button({
itemId:'indent',
tooltip:'Indent text.',
cls:'text-panel-indent-ui',
iconCls:'icon icon-rte-indent',
width:26,
handler:function(){
this.fireEvent('changeIndent',this)
},
scope:this
});
this.items=[
{
xtype:'container',
cls:'text-fontfamilystyle-panel-header has-custom-toggleBtn',
layout:'hauto',
items:[
{
xtype:'container',
layout:'hauto',
cls:'web-panel-button-group-new',
items:[
this.orderedListSplitButton.toggleButton,
this.orderedListSplitButton.winButton
]
},
{
xtype:'spacer',
width:15
},
{
xtype:'container',
layout:'hauto',
cls:'web-panel-button-group-new',
items:[
this.unorderedListSplitButton.toggleButton,
this.unorderedListSplitButton.winButton
]
},
{
xtype:'spacer',
width:15
},
{
xtype:'container',
layout:'hauto',
cls:'web-panel-button-group-new',
items:[
this.outdent,
this.indent
]
}
]
},
{
xtype:'spacer',
ref:'panelBodyPatch',
cls:'custom-panel-patch-holder',
height:'2px',
style:{
position:'relative',
left:'54px'
},
html:'<div class="custom-panel-body-patch text-list-panel-body-patch "></div>'
},
{
xtype:'container',
ref:'propertiesPanelBody',
layout:'auto',
cls:'custom-color-panel-body',
items:[
{
xtype:'container',
layout:'hflex',
cls:'orderListProperties',
items:[{
xtype:'container',
layout:'vflex',
style:{paddingBottom:'5px'},
items:[
{
xtype:'container',
layout:'hauto',
style:{paddingBottom:'5px'},
items:[
{
xtype:'label',
text:'List type:',
width:100
},
this.orderedList
]
},
{
xtype:'container',
layout:'hauto',
style:{paddingBottom:'5px'},
items:[
{
xtype:'label',
text:'Start at:',
width:100
},
this.orderedStart
]
}
]
}]
},
{
xtype:'container',
layout:'hauto',
cls:'unOrderListProperties',
items:[
{
xtype:'label',
text:'List type:',
width:100
},
this.unorderedList
]
}
]
}
];
this.addEvents('change','changeIndent','changeOutdent');
web.ui.textPanel.ListPanel.superclass.constructor.call(this,cfg)
}
});
Ext.ComponentMgr.registerType('web-textListPanel',web.ui.textPanel.ListPanel);
web.panels.props.richtext.Para=Ext.extend(Object,{
xtype:'web-props-para',
constructor:function(config){
Ext.apply(this,config);
this.paraStyle=null;
this.selection={
start:0,
end:0
};
var noNullToggle=function(button,state){
if(state){
button.disable()
}else{
button.enable()
}
};
this.width=315;
this.height=70;
this.maxIndent=10;
this.indentIncrement=40;
this.baseCls='x-btn-group';
this.cls='web-prop-btn-group';
this.frame=true;
this.title='';
this.layout='vbox';
this.layoutConfig={align:'stretch'};
this.left=new Ext.Button({
itemId:'left',
tooltip:'Align left.',
iconCls:'icon icon-rte-justifyleft',
scale:'small',
width:25,
enableToggle:true,
toggleGroup:'align',
toggleHandler:noNullToggle,
handler:this.onAlign,
scope:this
});
this.center=new Ext.Button({
itemId:'center',
tooltip:'Align center.',
iconCls:'icon icon-rte-justifycenter',
scale:'small',
width:25,
enableToggle:true,
toggleGroup:'align',
toggleHandler:noNullToggle,
handler:this.onAlign,
scope:this
});
this.right=new Ext.Button({
itemId:'right',
tooltip:'Align right.',
iconCls:'icon icon-rte-justifyright',
scale:'small',
width:25,
enableToggle:true,
toggleGroup:'align',
toggleHandler:noNullToggle,
handler:this.onAlign,
scope:this
});
this.justify=new Ext.Button({
itemId:'justify',
tooltip:'Justify.',
iconCls:'icon icon-rte-justifyfull',
scale:'small',
width:25,
enableToggle:true,
toggleGroup:'align',
toggleHandler:noNullToggle,
handler:this.onAlign,
scope:this
});
this.textListPanel=new web.ui.textPanel.ListPanel({
listeners:{
change:this.updateNewList,
changeOutdent:this.onOutdent,
changeIndent:this.onIndent,
scope:this
}
});
this.textListPanel.orderedListSplitButton.toggleButton.addListener('toggle',this.updateNewList.createDelegate(this,[this.textListPanel.orderedListSplitButton]));
this.textListPanel.unorderedListSplitButton.toggleButton.addListener('toggle',this.updateNewList.createDelegate(this,[this.textListPanel.unorderedListSplitButton]));
this.lineHeight=new web.ui.ComboBox({
itemId:'lineHeight',
store:new Ext.data.ArrayStore({
idIndex:0,
fields:[
'id',
'name'
],
data:function(){
var arr=[];
for(var i=10;i<=24;i+=1){
arr.push([
i/10,
(i/10).toFixed(1)
])
}
return arr
}()
}),
valueField:'id',
displayField:'name',
mode:'local',
triggerAction:'all',
editable:false,
value:1.2,
width:50,
listeners:{
render:function(combo){
combo.tip=new Ext.ToolTip({
target:combo.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:'Line spacing'
}
})
},
select:this.updateHeight,
scope:this
}
});
this.newParaPadding=new web.ui.fields.FourSidesField({
width:275,
labelWidth:115,
mainFieldLeftPadding:'86px',
componentType:'Paragraph spacing',
tooltip:'Provide different values for spacing on each side',
fourFields:{
field1:{
iconCls:'spacing-top',
iconTooltip:'Top spacing',
dataKey:'top'
},
field2:{
iconCls:'spacing-right',
iconTooltip:'Right spacing',
dataKey:'right'
},
field3:{
iconCls:'spacing-bottom',
iconTooltip:'Bottom spacing',
dataKey:'bottom'
},
field4:{
iconCls:'spacing-left',
iconTooltip:'Left spacing',
dataKey:'left'
}
},
listeners:{
change:this.updatePadding,
scope:this
}
});
this.paraPadding=new web.ui.fields.FrameField({
listeners:{
change:this.updatePadding,
scope:this
}
});
this.paddingButton=new Ext.Button({
itemId:'padding',
tooltip:'Line spacing & Paragraph spacing.',
text:'Spacing',
scale:'small',
width:120,
cls:'no-arrow'
})
},
setComponent:function(part){
this.part=part;
this.initial()
},
setup:function(){
this.initMyListeners();
this.refresh()
},
initMyListeners:function(){
var app=this.app;
app.on('select',function(part){
if(part instanceof web.data.components.Text){
this.refresh()
}
},this);
app.properties.on('select',function(part,cfg){
if(cfg&&cfg.aspectType==='para'){
this.setComponent(part.getParent());
this.refresh()
}
},this);
app.workspace.rte.on('select',function(cfg){
this.setSelection(cfg.start,cfg.end);
this.refresh()
},this);
app.workspace.multiSelect.on('multiselect',function(components){
var part=components.length===1?components[0]:null,len;
if(part instanceof web.data.components.Text){
len=part.richtext.text.length;
this.part=part;
part.position(0,len);
this.setSelection(0,len);
this.refresh()
}
},this);
app.on('update',function(part){
if(part===this.paraStyle){
this.refresh()
}
},this);
app.workspace.on('reflow',function(){
var text=app.getSelected('component'),indent,increment;
if(text){
indent=text.getInnerWidth();
increment=this.indentIncrement;
this.maxIndent=Math.floor(indent/ increment)*increment
}
},this)
},
setSelection:function(start,end){
this.selection.start=start;
this.selection.end=end
},
getSelStart:function(){
return this.selection.start
},
getSelEnd:function(){
return this.selection.end
},
refresh:function(){
var part=this.part,style,global,align,indent,maxIndent,bullet=null,order=null,isOrdered,padding,height;
if(part){
style=part.getCurrentParas(this.getSelStart(),this.getSelEnd())[0];
this.paraStyle=style
}
if(style){
align=style.getAlign();
bullet=style.getBullet();
order=style.getOrder();
padding=style.getPadding();
height=style.getHeight();
global=style.getGlobal();
if(global){
align=align?align:global.getAlign();
bullet=bullet?bullet:global.getBullet();
order=order?order:global.getOrder();
padding=padding?padding:global.getPadding();
height=height?height:global.getHeight()
}
}
align=align?align:'left';
if(align!=='left'){
this.textListPanel.indent.disable();
this.textListPanel.outdent.disable()
}else{
indent=style?style.getIndent():0;
if(indent<=0){
this.textListPanel.outdent.disable()
}else{
this.textListPanel.outdent.enable()
}
maxIndent=this.getMaxIndent();
if(indent>=maxIndent){
this.textListPanel.indent.disable()
}else{
this.textListPanel.indent.enable()
}
}
this.left.toggle(align==='left');
this.center.toggle(align==='center');
this.right.toggle(align==='right');
this.justify.toggle(align==='justify');
this.textListPanel.orderedStart.setValue('');
if(bullet!==null){
isOrdered=[
'circle',
'disc',
'square'
].indexOf(bullet)===-1;
if(isOrdered){
this.textListPanel.orderedListSplitButton.winButton.setBullet(bullet);
this.textListPanel.orderedStart.setValue(order||'')
}else{
this.textListPanel.unorderedListSplitButton.winButton.setBullet(bullet)
}
}
this.textListPanel.orderedListSplitButton.toggleButton.toggle(bullet&&isOrdered,true);
this.textListPanel.unorderedListSplitButton.toggleButton.toggle(bullet&&!isOrdered,true);
this.lineHeight.setValue(height?height:1.2)
},
onAlign:function(button){
this.applyPara({align:button.itemId})
},
getMaxIndent:function(){
return this.maxIndent
},
onOutdent:function(){
var style=this.paraStyle,indent=0,bullet=null,order=null;
if(style){
indent=style.getIndent();
bullet=style.getBullet();
order=style.getOrder()
}
if(indent>0){
indent-=1;
if(indent<1){
bullet=null;
order=null
}
this.applyPara({
indent:indent,
bullet:bullet,
order:order
})
}
},
onIndent:function(){
var indent=this.paraStyle?this.paraStyle.getIndent():0;
if(indent<this.getMaxIndent()){
this.applyPara({indent:indent+1})
}
},
updateNewList:function(button){
var style=this.paraStyle,indent=0,bullet=null,order=null;
if(style){
indent=style.getIndent();
bullet=style.getBullet();
order=style.getOrder()
}
if(button.toggleButton.pressed){
if(!bullet){
indent=indent?indent+1:1
}
if(button.winButton.itemId==='ordered'){
this.textListPanel.unorderedListSplitButton.toggleButton.toggle(false,true)
}else{
this.textListPanel.orderedListSplitButton.toggleButton.toggle(false,true)
}
bullet=button.winButton.bullet;
order=button.winButton.order||null;
delete button.winButton.order;
this.applyPara({
indent:indent,
bullet:bullet,
order:order
})
}else{
if(bullet){
indent=indent>0?indent-1:0
}
this.applyPara({
indent:indent,
bullet:null,
order:null
})
}
},
updateList:function(button){
var style=this.paraStyle,indent=0,bullet=null,order=null;
if(style){
indent=style.getIndent();
bullet=style.getBullet();
order=style.getOrder()
}
if(button.toggleButton.pressed){
if(!bullet){
indent=indent?indent+1:1
}
if(button.winButton.itemId==='ordered'){
this.unordered.toggleButton.toggle(false,true)
}else{
this.ordered.toggleButton.toggle(false,true)
}
bullet=button.winButton.bullet;
order=button.winButton.order||null;
delete button.winButton.order;
this.applyPara({
indent:indent,
bullet:bullet,
order:order
})
}else{
if(bullet){
indent=indent>0?indent-1:0
}
this.applyPara({
indent:indent,
bullet:null,
order:null
})
}
},
updateHeight:function(button){
this.applyPara({height:button.getValue()});
this.app.workspace.rte.editor.focus()
},
updatePadding:function(field,value){
this.applyPara({
padding:[
value.top,
value.right,
value.bottom,
value.left
]
})
},
applyPara:function(style){
var app=this.app,text=this.part;
if(!text){
one.fatal('Target has no value before invoking apply para command in paragraph properties panel.');
return
}
app.invoker.execute(new web.commands.text.ApplyPara({
target:text,
style:style
}))
},
initial:function(){
var part=this.part,style,global,padding;
if(part){
style=part.getCurrentParas(this.getSelStart(),this.getSelEnd())[0]
}
if(style){
padding=style.getPadding();
global=style.getGlobal();
if(global){
padding=padding?padding:global.getPadding()
}
}
padding=padding?padding.toJSON():[
0,
0,
0,
0
];
this.newParaPadding.setValue({
top:padding[0],
right:padding[1],
bottom:padding[2],
left:padding[3]
})
}
});
Ext.ComponentMgr.registerType('web-props-para',web.panels.props.richtext.Para);
web.commands.text.ApplyTableFormat=Ext.extend(web.commands.text.Insert,{
constructor:function(cfg){
web.commands.text.ApplyTableFormat.superclass.constructor.call(this,cfg)
},
execute:function(){
var target=this.target;
this.oldJSON=target.toJSON();
this.applyFormat([
{
type:'row',
frequency:2,
start:1,
cfg:{ref:'normal'}
},
{
type:'row',
frequency:2,
start:2,
cfg:{ref:'alternate'}
},
{
type:'col',
start:0,
cfg:{ref:'heading.2'}
},
{
type:'row',
start:0,
cfg:{ref:'heading.1'}
}
]);
this.newJSON=target.toJSON();
this.executeCommand(new web.commands.text.BBoxAdjust({target:target}));
this.fireEvent('update',target)
},
applyFormat:function(format){
var richtext=this.target.richtext,rows,cols;
richtext.next(0,richtext.text.length);
rows=richtext.cells.getTableRows();
cols=richtext.cells.getTableCols();
richtext.prev();
format.forEach(function(strip){
var i,cells=strip.type==='row'?rows:cols;
if(cells[strip.start]){
strip.end=strip.end?strip.end:strip.frequency?cells.length-1:strip.start;
strip.frequency=strip.frequency>0?strip.frequency:1;
for(i=strip.start;i<=strip.end;i+=strip.frequency){
this.applyCfgToCells(strip.cfg,cells[i])
}
}
},this)
},
applyCfgToCells:function(cfg,cells){
var stylesheet=this.stylesheet,style,styleCfg;
if(cfg.ref){
style=stylesheet.getStyleByRef(cfg.ref,'StyleCell');
styleCfg={
globalId:style.getId(),
block:{
background:null,
border:null
}
}
}
cells.forEach(function(cell){
cell.set(cfg);
cell.getStyleCell().set(styleCfg)
},this)
}
});
web.commands.text.ApplyCell=Ext.extend(web.commands.text.Insert,{
constructor:function(cfg){
web.commands.text.ApplyCell.superclass.constructor.call(this,cfg)
},
execute:function(){
var target=this.target,cell=this.cell;
this.oldJSON=target.toJSON();
target.applyCell(cell);
this.newJSON=target.toJSON();
this.executeCommand(new web.commands.text.BBoxAdjust({target:target}));
this.fireEvent('update',target)
}
});
web.commands.text.ApplyStyleCell=Ext.extend(web.commands.text.Insert,{
constructor:function(cfg){
web.commands.text.ApplyStyleCell.superclass.constructor.call(this,cfg)
},
execute:function(){
var target=this.target,style=this.style;
this.oldJSON=target.toJSON();
target.applyStyleCell(style);
this.newJSON=target.toJSON();
this.executeCommand(new web.commands.text.BBoxAdjust({target:target}));
this.fireEvent('update',target)
}
});
web.commands.text.InsertRow=Ext.extend(web.commands.text.Insert,{
constructor:function(cfg){
web.commands.text.InsertRow.superclass.constructor.call(this,cfg)
},
execute:function(){
var target=this.target,cell=target.getCurrentCells()[0];
this.oldJSON=target.toJSON();
target.insertRow();
this.newJSON=target.toJSON();
this.executeCommand(new web.commands.text.ShiftRelPara({
target:target,
rowShift:1,
afterRowIndex:cell.getRowIndex()
}));
this.executeCommand(new web.commands.text.BBoxAdjust({target:target}));
this.fireEvent('update',target)
}
});
web.commands.text.InsertCol=Ext.extend(web.commands.text.Insert,{
constructor:function(cfg){
web.commands.text.InsertCol.superclass.constructor.call(this,cfg)
},
execute:function(){
var target=this.target;
this.oldJSON=target.toJSON();
target.insertCol();
this.newJSON=target.toJSON();
this.executeCommand(new web.commands.text.BBoxAdjust({target:target}));
this.fireEvent('update',target)
}
});
web.commands.text.DeleteRow=Ext.extend(web.commands.text.Insert,{
constructor:function(cfg){
web.commands.text.DeleteRow.superclass.constructor.call(this,cfg)
},
execute:function(){
var target=this.target,cell=target.getCurrentCells()[0];
this.executeCommand(new web.commands.text.ShiftRelPara({
target:target,
rowShift:-1,
afterRowIndex:cell.getRowIndex()
}));
this.oldJSON=target.toJSON();
target.deleteRow();
this.newJSON=target.toJSON();
this.fireEvent('update',target)
}
});
web.commands.text.DeleteCol=Ext.extend(web.commands.text.Insert,{
constructor:function(cfg){
web.commands.text.DeleteCol.superclass.constructor.call(this,cfg)
},
execute:function(){
var target=this.target;
this.oldJSON=target.toJSON();
target.deleteCol();
this.newJSON=target.toJSON();
this.fireEvent('update',target)
}
});
web.panels.props.richtext.Table=Ext.extend(Object,{
xtype:'web-props-table',
constructor:function(config){
Ext.apply(this,config);
var noNullToggle=function(button,state){
if(state){
button.disable()
}else{
button.enable()
}
};
this.selection={
start:0,
end:0
};
this.indentIncrement=40;
this.title='';
this.layout='vbox';
this.layoutConfig={align:'stretch'};
this.style={padding:'20px 20px 0px 20px'};
this.width=315;
this.height=175;
this.insertRow=new Ext.Button({
itemId:'insertrow',
tooltip:'Insert new row.',
iconCls:'icon icon-rte-insertrow',
width:26,
scale:'small',
handler:this.onClick,
scope:this
});
this.insertCol=new Ext.Button({
itemId:'insertcol',
tooltip:'Insert new column.',
iconCls:'icon icon-rte-insertcolumn',
width:25,
scale:'small',
handler:this.onClick,
scope:this
});
this.deleteRow=new Ext.Button({
itemId:'deleterow',
tooltip:'Delete row.',
iconCls:'icon icon-rte-deleterow',
width:25,
scale:'small',
handler:this.onClick,
scope:this
});
this.deleteCol=new Ext.Button({
itemId:'deletecol',
tooltip:'Delete column.',
iconCls:'icon icon-rte-deletecolumn',
width:25,
scale:'small',
handler:this.onClick,
scope:this
});
this.cell=new web.ui.ComboBox({
itemId:'cell',
tpl:'<tpl for="."><div class="x-combo-list-item" style="{style}">{name}</div></tpl>',
store:new Ext.data.ArrayStore({
idIndex:0,
fields:[
'id',
'cls',
'style',
'name'
],
data:[]
}),
valueField:'id',
displayField:'name',
mode:'local',
triggerAction:'all',
editable:false,
value:0,
width:90,
listWidth:'auto',
lazyInit:false,
listeners:{
select:this.onSelect,
afterrender:function(){
this.cell.list.setStyle('min-width','98px')
},
scope:this
}
});
this.manual=new Ext.Button({
itemId:'manual',
tooltip:'Edit table styles.',
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
handler:this.onManual,
scope:this
});
this.auto=new Ext.Button({
itemId:'auto',
tooltip:'Apply automatic styling',
iconCls:'icon icon-rte-autoformat',
width:24,
scale:'small',
handler:this.onAuto,
scope:this
});
this.top=new Ext.Button({
itemId:'top',
tooltip:'Align top.',
iconCls:'icon icon-rte-aligntop',
scale:'small',
enableToggle:true,
toggleGroup:'valign',
toggleHandler:noNullToggle,
handler:this.onToggle,
scope:this
});
this.middle=new Ext.Button({
itemId:'middle',
tooltip:'Align middle.',
iconCls:'icon icon-rte-alignmiddle',
scale:'small',
enableToggle:true,
toggleGroup:'valign',
toggleHandler:noNullToggle,
handler:this.onToggle,
scope:this
});
this.bottom=new Ext.Button({
itemId:'bottom',
tooltip:'Align bottom.',
iconCls:'icon icon-rte-alignbottom',
scale:'small',
enableToggle:true,
toggleGroup:'valign',
toggleHandler:noNullToggle,
handler:this.onToggle,
scope:this
});
this.newBorder=new web.ui.blockStyle.Border({
app:this.app,
componentLabel:'Cell border:',
listeners:{
adjust:this.onAdjust,
scope:this
}
});
this.newBackground=new web.ui.blockStyle.Background({
app:this.app,
componentLabel:'Cell background:',
listeners:{
adjust:this.onAdjust,
scope:this
}
});
this.borderBtn=new Ext.Button({
iconCls:'icon icon-rte-bordercolor',
tooltip:'Cell border.',
columnWidth:0.5,
plugins:new web.ui.plugins.WindowButton({
type:'web.windows.blockProps.Border',
app:this.app,
listeners:{
adjust:this.onAdjust,
scope:this
}
}),
styleType:'border',
listeners:{
winshow:this.onStyleClick,
scope:this
}
});
this.backgroundBtn=new Ext.Button({
tooltip:'Cell background.',
iconCls:'icon icon-rte-backgroundcolor',
columnWidth:0.5,
plugins:new web.ui.plugins.WindowButton({
type:'web.windows.blockProps.Background',
app:this.app,
listeners:{
adjust:this.onAdjust,
scope:this
}
}),
styleType:'background',
listeners:{
winshow:this.onStyleClick,
scope:this
}
});
this.cellWidth=new Ext.form.NumberField({
itemId:'cellWidth',
width:40,
style:{textAlign:'center'},
enableKeyEvents:true,
listeners:{
keyup:function(){
var timer;
return function(field){
clearTimeout(timer);
timer=setTimeout(this.onCellWidth.createDelegate(this,[
field,
field.getValue()
]),800)
}
}(),
scope:this
}
});
this.cellHeight=new Ext.form.NumberField({
itemId:'cellHeight',
width:40,
style:{textAlign:'center'},
enableKeyEvents:true,
validator:function(value){
return parseInt(value,10)>=20?true:this.invalidText
},
listeners:{
keyup:function(){
var timer;
return function(field){
clearTimeout(timer);
timer=setTimeout(this.onCellHeight.createDelegate(this,[
field,
field.getValue()
]),800)
}
}(),
change:this.onCellHeight,
scope:this
}
});
this.cellPadding=new web.ui.fields.FrameField({
listeners:{
change:this.onCellPadding,
scope:this
}
});
this.newPaddingBtn=new web.ui.fields.FourSidesField({
componentType:'Cell spacing'+' (px)',
name:'padding',
width:275,
labelWidth:99,
tooltip:'Provide different values for spacing on each side',
fourFields:{
field1:{
iconCls:'spacing-top',
iconTooltip:'Top spacing',
dataKey:'top'
},
field2:{
iconCls:'spacing-right',
iconTooltip:'Right spacing',
dataKey:'right'
},
field3:{
iconCls:'spacing-bottom',
iconTooltip:'Bottom spacing',
dataKey:'bottom'
},
field4:{
iconCls:'spacing-left',
iconTooltip:'Left spacing',
dataKey:'left'
}
},
listeners:{
change:this.onCellPadding,
scope:this
}
});
this.paddingBtn=new Ext.Button({
itemId:'padding',
tooltip:'Cell size & Cell spacing.',
iconCls:'icon icon-rte-spacing',
scale:'small',
plugins:new web.ui.plugins.WindowButton({
title:'Spacing',
closeAction:'hide',
resizable:false,
width:320,
height:270,
items:[
{
xtype:'label',
html:'<b style="line-height:1.5;">'+'Size'+'</b>'
},
{
xtype:'container',
layout:'hbox',
items:[
{
xtype:'label',
html:'Width',
width:50
},
this.cellWidth,
{
xtype:'label',
html:'&nbsp;',
width:20
},
{
xtype:'label',
html:'Height',
width:50
},
this.cellHeight
]
},
{
xtype:'label',
html:'<hr>'
},
{
xtype:'label',
html:'<b>'+'Cell Spacing'+'</b><br/><br/>'
},
this.cellPadding
]
}),
listeners:{
winshow:function(){
if(this.part){
var cell=this.part.getCurrentCells(this.getSelStart(),this.getSelEnd())[0],height=this.part.getRows()[cell.rowIndex][0].getMinHeight(),width=cell.getWidth();
this.cellHeight.setValue(height);
this.cellWidth.setValue(width)
}
},
scope:this
}
})
},
setComponent:function(component){
this.part=component;
this.resetStylesheet();
this.refresh()
},
setup:function(){
this.initMyListeners();
this.resetStylesheet();
this.refresh()
},
initMyListeners:function(){
this.app.on('select',function(part){
if(part instanceof web.data.styles.Stylesheet){
this.resetStylesheet(part)
}else if(part instanceof web.data.components.Table){
this.refresh()
}
},this);
this.app.on('deselect',function(part){
if(part===this.part){
this.part=null
}
});
this.app.properties.on('select',function(part,cfg){
if(cfg&&cfg.aspectType==='cell'){
this.part=part.parent;
this.refresh()
}
},this);
this.app.properties.on('deselect',function(part,cfg){
if(cfg&&cfg.aspectType==='cell'){
this.refresh()
}
},this);
this.app.workspace.rte.on('select',function(cfg){
this.setSelection(cfg.start,cfg.end);
this.refresh()
},this);
this.app.workspace.multiSelect.on('multiselect',function(components){
var part=components.length===1?components[0]:null,len;
if(part instanceof web.data.components.Text){
len=part.richtext.text.length;
this.part=part;
part.position(0,len);
this.setSelection(0,len);
this.refresh()
}
},this);
this.app.on('update',function(part){
if(part===this.part){
this.refresh()
}
if(part instanceof web.data.styles.StyleText&&part.parent&&part.parent instanceof web.data.styles.StyleCell&&part.parent.inStylesheet()){
this.resetStylesheet()
}
},this)
},
resetStylesheet:function(stylesheet){
var cell=this.cell,store,styles,cells=[];
this.stylesheet=stylesheet=stylesheet?stylesheet:this.app.getSelected('stylesheet');
styles=stylesheet?stylesheet.getStylesByType('web.data.styles.StyleCell'):[];
this.defaultTextStyle=stylesheet.getStyleByRef('normal','StyleText');
var limitFontSize=function(css){
return css.replace(/(^|;)[ ]*font-size[ ]*:[ ]*([^;]+|$)/i,function(m,p1,p2){
var size=parseInt(p2,10);
return p1+'font-size: '+(size>24?24:size)+'px'
}).replace(/"/g,'&quot;')
};
store=cell.getStore();
store.removeAll();
styles.forEach(function(style){
var ref=style.getRef();
cells.push([
style.getId(),
style.getCSSClass(),
limitFontSize(style.getText().getCSSDeclarations().replace(/\n/g,' ')),
web.data.styles.StyleCell.types[ref].NAME
])
},this);
store.loadData(cells)
},
setSelection:function(start,end){
this.selection.start=start;
this.selection.end=end
},
getSelStart:function(){
return this.selection.start
},
getSelEnd:function(){
return this.selection.end
},
refresh:function(){
var part=this.part,align,cell=part?part.getCurrentCells(this.getSelStart(),this.getSelEnd())[0]:null,styleCell=this.styleCell=cell?cell.getStyleCell():null,global=styleCell?styleCell.getGlobal():null,globalBlock=global?global.getBlock():null,border=styleCell?styleCell.block.getApplied('border'):{},hasBorder=true,height=null,width=null;
if(cell){
height=this.part.getRows()[cell.rowIndex][0].getMinHeight();
width=cell.getWidth()
}
if(border===null||border.width===null){
hasBorder=false
}
align='top';
if(cell&&part.getRows){
align=styleCell.getVerticalAlign();
this.insertRow.enable();
this.insertCol.enable();
if(part.getRows().length>1){
this.deleteRow.enable()
}else{
this.deleteRow.disable()
}
if(part.getCols().length>1){
this.deleteCol.enable()
}else{
this.deleteCol.disable()
}
this.cell.enable();
this.auto.enable();
if(align!=='top'){
this.top.enable()
}
if(align!=='middle'){
this.middle.enable()
}
if(align!=='bottom'){
this.bottom.enable()
}
this.borderBtn.enable();
this.newBorder.setValue(border||globalBlock.getApplied('border')||null);
this.newBorder.updateHeaderRemoveBtn(hasBorder);
this.backgroundBtn.enable();
this.newBackground.isBgRemoveBtnVisible=!!styleCell.block.getApplied('background')||false;
this.newBackground.suspendEvents();
this.newBackground.setValue(styleCell.block.getApplied('background')||globalBlock.getApplied('background')||null);
this.newBackground.resumeEvents();
this.newPaddingBtn.setValue(styleCell.block.getApplied('padding')||globalBlock.getApplied('padding')||null);
this.paddingBtn.enable();
this.cell.setValue(styleCell.getGlobalId());
this.refreshPaddingBtn();
this.cellHeight.enable();
this.cellWidth.enable();
this.cellHeight.setValue(height);
this.cellWidth.setValue(width)
}else{
this.insertRow.disable();
this.insertCol.disable();
this.deleteRow.disable();
this.deleteCol.disable();
this.cell.disable();
this.auto.disable();
this.top.disable();
this.middle.disable();
this.bottom.disable();
this.borderBtn.disable();
this.backgroundBtn.disable();
this.paddingBtn.disable();
this.cellHeight.disable();
this.cellWidth.disable();
this.cell.setValue('normal')
}
this.top.toggle(align==='top');
this.middle.toggle(align==='middle');
this.bottom.toggle(align==='bottom')
},
onClick:function(button){
var app=this.app,invoker=app.invoker,ns=web.commands.text,text=this.part,cfg={
target:text,
start:this.getSelStart()
};
switch(button.itemId){
case'insertrow':
invoker.execute(new ns.InsertRow(cfg));
break;
case'insertcol':
invoker.execute(new ns.InsertCol(cfg));
break;
case'deleterow':
invoker.execute(new ns.DeleteRow(cfg));
break;
case'deletecol':
invoker.execute(new ns.DeleteCol(cfg));
break
}
},
onToggle:function(button){
this.applyStyleCell({verticalAlign:button.itemId})
},
onManual:function(){
this.app.windows.show({
type:'web.windows.GlobalStyles',
values:{activeItem:3}
})
},
onAuto:function(){
this.app.invoker.execute(new web.commands.text.ApplyTableFormat({
target:this.part,
stylesheet:this.stylesheet
}));
this.app.track([
'Table',
'magic-hat'
])
},
onSelect:function(button){
this.applyStyleCell({globalId:button.getValue()});
this.app.workspace.rte.editor.focus()
},
applyStyleCell:function(cfg){
this.app.invoker.execute(new web.commands.text.ApplyStyleCell({
target:this.part,
style:cfg
}))
},
applyCell:function(cfg){
this.app.invoker.execute(new web.commands.text.ApplyCell({
target:this.part,
cell:cfg
}))
},
onAdjust:function(){
var interval;
return function(opts){
if(opts.background){
this.newBackground.updateHeader()
}
if(opts.border){
this.newBorder.updateHeader(opts.border)
}
this.app.fireEvent('adjust',this.part);
if(interval){
window.clearTimeout(interval)
}
interval=window.setTimeout(function(){
this.applyStyleCell({block:opts})
}.createDelegate(this),500)
}
}(),
onStyleClick:function(button,win){
var style=this.part.getCurrentCells(this.getSelStart(),this.getSelEnd())[0].getStyleCell(),global=style.getGlobal(),globalBlock=global?global.getBlock():null,styleBlock=(style.getBlock()||globalBlock).toJSON(),styleCfg=styleBlock[button.styleType];
styleCfg=styleCfg||{};
if(button.styleType==='border'){
styleCfg.fixedWidth=1;
styleCfg.width=[
1,
1,
1,
1
];
styleCfg.style=[
'solid',
'solid',
'solid',
'solid'
];
styleCfg.color=styleCfg.color?styleCfg.color:[
[
'RGB',
0,
0,
0,
1
],
[
'RGB',
0,
0,
0,
1
],
[
'RGB',
0,
0,
0,
1
],
[
'RGB',
0,
0,
0,
1
]
]
}
win.setValues(styleCfg)
},
refreshPaddingBtn:function(){
var part=this.part,cell=part?part.getCurrentCells(this.getSelStart(),this.getSelEnd())[0]:null,style=cell?cell.getStyleCell():null,global=style.getGlobal(),stylePadding=style.getBlock().getPadding().toJSON(),padding=stylePadding?stylePadding:global?global.getBlock().getPadding().toJSON():null;
padding=padding?padding:[
0,
0,
0,
0
];
this.cellPadding.setValue({
top:padding[0],
right:padding[1],
bottom:padding[2],
left:padding[3]
})
},
onCellWidth:function(field,widthNew){
if(!widthNew){
return
}
var part=this.part,cell=part?part.getCurrentCells(this.getSelStart(),this.getSelEnd())[0]:null,colIndex=cell.getColIndex(),widthTotal=part.getInnerWidth(),newPercent=widthNew/widthTotal;
if(widthNew!==cell.getWidth()){
var rows=part.getRows(),flexWidths=[],totalPercent=0;
rows[0].forEach(function(col,index){
var percent=index===colIndex?newPercent:col.getPercentWidth()/100;
flexWidths.push(percent);
totalPercent+=percent
});
var error=false;
if(totalPercent!==1){
var minPercent=1/widthTotal;
if(colIndex<flexWidths.length-1){
flexWidths[flexWidths.length-1]+=1-totalPercent;
if(flexWidths[flexWidths.length-1]<minPercent){
error=true
}
}else{
flexWidths[0]+=1-totalPercent;
if(flexWidths[0]<minPercent){
error=true
}
}
}
if(!error){
this.applyCell({flexWidths:flexWidths})
}else{
field.markInvalid()
}
}
},
onCellHeight:function(button,value){
if(!value||value<20){
return
}
this.applyCell({minHeight:parseInt(value,10)})
},
onCellPadding:function(button,value){
this.applyStyleCell({
block:{
padding:[
value.top,
value.right,
value.bottom,
value.left
]
}
})
}
});
Ext.ComponentMgr.registerType('web-props-table',web.panels.props.richtext.Table);
Ext.layout.HAutoLayout=Ext.extend(Ext.layout.ContainerLayout,{
type:'hauto',
targetCls:'hauto-ct'
});
Ext.Container.LAYOUTS.hauto=Ext.layout.HAutoLayout;
web.panels.props.richtext.FontStyleLayout=Ext.extend(Object,{
constructor:function(cfg){
Ext.apply(this,cfg);
this.font=new web.panels.props.richtext.Font({app:this.app});
this.fontFamilybtn=new Ext.Button({})
},
afterRender:function(){
this.font.setup()
},
getLayout:function(){
var layout=[];
layout=layout.concat(this.getFontLayout());
return layout
},
getFontLayout:function(){
var fontOpts=this.font;
return[
{
xtype:'container',
layout:'hauto',
border:false,
items:[
{
xtype:'container',
layout:'hflex',
cls:'web-panel-button-group-new text-font-style',
style:'padding: 0 10px 0 0;',
items:[
fontOpts.font,
{
xtype:'button',
ref:'../../settingsGearBtn',
style:{position:'relative'},
cls:'custom-color-panel-gear-btn',
enableToggle:true,
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
tooltip:'Edit text color',
listeners:{
click:this.toggleTextColorPanel,
scope:this
}
}
]
},
{xtype:'flexspacer'},
{
xtype:'container',
layout:'hflex',
cls:'web-panel-button-group-new',
style:'position: relative; left: 7px;padding: 0 10px 0 0;',
items:[fontOpts.size]
},
{xtype:'flexspacer'},
{
xtype:'container',
layout:'hflex',
cls:'web-panel-button-group-new',
items:[
fontOpts.bold,
fontOpts.italic,
fontOpts.underline
]
}
]
},
{
xtype:'spacer',
ref:'panelBodyPatch',
cls:'custom-panel-patch-holder',
height:'2px',
html:'<div class="custom-panel-body-patch"></div>'
},
{
xtype:'container',
ref:'textColorPanelBody',
layout:'auto',
cls:'custom-color-panel-body',
items:{
xtype:'web-colorpanel',
ref:'../colorPanel',
listeners:{
change:fontOpts.fontFamily,
scope:this
}
}
}
]
}
});
web.panels.props.richtext.Layout=Ext.extend(Object,{
constructor:function(cfg){
var isTable=cfg.table;
delete cfg.table;
Ext.apply(this,cfg);
this.font=new web.panels.props.richtext.Font({app:this.app});
this.para=new web.panels.props.richtext.Para({app:this.app});
if(isTable){
this.table=new web.panels.props.richtext.Table({app:this.app})
}
},
afterRender:function(){
if(this.table){
this.table.setup()
}
this.font.setup();
this.para.setup()
},
getLayout:function(){
var layout=[];
if(this.table){
layout=layout.concat(this.getTableProperties())
}
layout=layout.concat(this.getCommonProperties());
if(!this.table){
layout=layout.concat(this.getTextProperties())
}
return layout
},
getCommonProperties:function(){
var fontOpts=this.font,paraOpts=this.para;
var props=[
{
xtype:'container',
cls:'web-panel-button-group-new button-group-text-style',
layout:'hauto',
layoutConfig:{align:'middle'},
style:'padding-top:10px;padding-bottom:10px;',
items:[
{
xtype:'label',
text:'Text style:',
flex:true,
width:130
},
fontOpts.global,
fontOpts.clear,
fontOpts.editTextStyles
]
},
{
xtype:'container',
style:{
paddingBottom:'10px',
height:25
},
items:[fontOpts.linkStyleSelector]
},
{
xtype:'container',
layout:'auto',
style:'paddingBottom: 10px;',
items:[{
xtype:'label',
text:'Formatting:'
}]
},
{
xtype:'container',
style:{padding:'2px 0 6px 0'},
items:[
{
xtype:'container',
cls:'text-font-style',
layout:'hauto',
items:[
{
xtype:'container',
layout:'hauto',
cls:'custom-color-panel-gear-btn web-panel-button-group-new',
items:[
fontOpts.font,
{
xtype:'button',
ref:'../../settingsGearBtn',
style:{position:'relative'},
cls:'custom-color-panel-gear-btn',
enableToggle:true,
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
tooltip:'Add more fonts',
listeners:{
click:function(event){
var patchHolder=event.getEl().parent('.text-font-style').next();
patchHolder.toggleClass('custom-panel-patch-holder-visible');
var container=patchHolder.next().dom;
container.style.height=(patchHolder.hasClass('custom-panel-patch-holder-visible')?container.firstChild.clientHeight:0)+'px';
patchHolder.next().toggleClass('custom-panel-isExpanded text-color-panel-visible')
},
scope:this
}
}
]
},
{
xtype:'spacer',
width:15
},
{
xtype:'container',
layout:'hauto',
cls:'web-panel-button-group-new',
items:[fontOpts.size]
},
{
xtype:'spacer',
width:14
},
{
xtype:'container',
layout:'hauto',
cls:'web-panel-button-group-new',
items:[
fontOpts.bold,
fontOpts.italic,
fontOpts.underline
]
}
]
},
{
xtype:'spacer',
ref:'panelBodyPatch',
cls:'custom-panel-patch-holder',
height:'2px',
html:'<div class="custom-panel-body-patch" style="left:101px;"></div>'
},
{
xtype:'container',
ref:'textColorPanelBody',
style:'max-width: 270px',
layout:'auto',
ctCls:'custom-color-panel-fontFamily',
cls:'custom-color-panel-body',
items:fontOpts.fontFamily
}
]
},
{
xtype:'container',
layout:'hauto',
style:{padding:'0 0 5px 1px'},
items:[
{
xtype:'container',
layout:'hauto',
cls:'web-panel-button-group-new',
items:[
paraOpts.left,
paraOpts.center,
paraOpts.right,
paraOpts.justify
]
},
{
xtype:'spacer',
width:15
},
{
xtype:'container',
layout:'hauto',
cls:'web-panel-button-group-new',
items:[
fontOpts.subscript,
fontOpts.superscript
]
}
]
}
];
if(!this.table){
props.push({
xtype:'container',
layout:'hauto',
style:{paddingBottom:'5px'},
cls:'listTextPanelContainer',
items:[paraOpts.textListPanel]
})
}
props=props.concat([
{
xtype:'container',
layout:'hauto',
style:{paddingBottom:'10px'},
items:[fontOpts.newColor]
},
{
xtype:'container',
layout:'hauto',
style:{paddingBottom:'10px'},
items:[fontOpts.newShadow]
},
{
xtype:'container',
layout:'hauto',
cls:'text-highlight-panel',
style:{paddingBottom:'10px'},
items:[fontOpts.newHighlight]
}
]);
return props
},
getTextProperties:function(){
var paraOpts=this.para,fontOpts=this.font;
return[
{
xtype:'container',
layout:'hauto',
items:[paraOpts.newParaPadding]
},
{
xtype:'container',
layout:'hauto',
style:{
paddingTop:'10px',
paddingBottom:'10px'
},
items:[{
xtype:'container',
layout:'hauto',
flex:true,
style:{'min-width':'275px'},
items:[
{
xtype:'label',
html:'Line spacing:',
style:{
minWidth:'120px',
paddingTop:'5px'
}
},
{
xtype:'container',
layout:'hauto',
style:{float:'right'},
items:[paraOpts.lineHeight]
}
]
}]
},
{
xtype:'container',
layout:'hauto',
style:{paddingBottom:'10px'},
items:[{
xtype:'container',
layout:'hauto',
flex:true,
style:{'min-width':'275px'},
items:[
{
xtype:'label',
html:'Character spacing:',
style:{
minWidth:'120px',
paddingTop:'5px'
}
},
{
xtype:'container',
layout:'hauto',
style:{float:'right'},
items:[fontOpts.letterSpacing]
}
]
}]
}
]
},
getTableProperties:function(){
var tableOpts=this.table;
return[
{
layout:'hauto',
layoutConfig:{align:'middle'},
items:[
{
xtype:'label',
text:'Add/Remove cells:',
flex:true,
width:173
},
{
xtype:'container',
layout:'hflex',
cls:'web-panel-button-group-new',
items:[
tableOpts.insertRow,
tableOpts.insertCol,
tableOpts.deleteRow,
tableOpts.deleteCol
]
}
]
},
{
layout:'hauto',
layoutConfig:{align:'middle'},
style:{paddingTop:'10px'},
items:[
{
xtype:'label',
text:'Table style:',
flex:true,
width:135
},
{
xtype:'container',
layout:'hflex',
cls:'web-panel-button-group-new',
items:[
tableOpts.cell,
tableOpts.manual,
tableOpts.auto
]
}
]
},
{
layout:'hauto',
layoutConfig:{align:'middle'},
style:{paddingTop:'10px'},
items:[
{
xtype:'label',
text:'Cell alignment:',
width:199
},
{
xtype:'container',
layout:'hflex',
cls:'web-panel-button-group-new',
items:[
tableOpts.top,
tableOpts.middle,
tableOpts.bottom
]
}
]
},
{
layout:'hauto',
layoutConfig:{align:'middle'},
style:{paddingTop:'10px'},
items:[{
xtype:'container',
layout:'auto',
items:[tableOpts.newBackground]
}]
},
{
layout:'hauto',
layoutConfig:{align:'middle'},
style:{paddingTop:'10px'},
items:[{
xtype:'container',
layout:'auto',
items:[tableOpts.newBorder]
}]
},
{
layout:'hauto',
layoutConfig:{align:'middle'},
style:{paddingTop:'10px'},
items:[
{
xtype:'label',
text:'Cell width:',
width:235
},
tableOpts.cellWidth
]
},
{
layout:'hauto',
layoutConfig:{align:'middle'},
style:{paddingTop:'10px'},
items:[
{
xtype:'label',
text:'Cell height:',
width:235
},
tableOpts.cellHeight
]
},
{
layout:'hauto',
layoutConfig:{align:'middle'},
items:[tableOpts.newPaddingBtn]
}
]
}
});
web.panels.props.Text=Ext.extend(web.panels.Panel,{
title:'',
constructor:function(config){
web.panels.props.Text.superclass.constructor.call(this,config)
},
initComponent:function(){
this.layoutHelper=new web.panels.props.richtext.Layout({app:this.app});
this.cls='web-props-panel vbox';
this.items=[
{
xtype:'container',
style:'padding: 20px 0 20px 20px;overflow-y: auto;overflow-x: hidden;',
defaults:{width:275},
cls:'flex',
items:this.layoutHelper.getLayout()
},
{
xtype:'container',
cls:'props-panel-bottom-container',
layout:'column',
items:[{
xtype:'web-props-mobile',
app:this.app,
cmp:this.component
}]
}
];
web.panels.props.Text.superclass.initComponent.apply(this,arguments);
this.setComponent(this.component);
if(this.component){
var len=this.component.richtext.text.length;
this.component.richtext.position(0,len);
this.layoutHelper.font.setSelection(0,len);
this.layoutHelper.para.setSelection(0,len)
}
},
setComponent:function(component){
if(component){
this.component=component;
this.layoutHelper.font.setComponent(component);
this.layoutHelper.para.setComponent(component)
}
},
refresh:function(){
},
afterRender:function(){
web.panels.props.Text.superclass.afterRender.apply(this,arguments);
this.layoutHelper.afterRender()
}
});
web.panels.props.Table=Ext.extend(web.panels.Panel,{
title:'',
constructor:function(config){
web.panels.props.Table.superclass.constructor.call(this,config)
},
initComponent:function(){
this.layoutHelper=new web.panels.props.richtext.Layout({
app:this.app,
table:true
});
this.cls='web-props-panel vbox';
this.items=[
{
xtype:'container',
style:{
padding:'20px 0px 20px 20px',
overflow:'auto'
},
defaults:{width:275},
cls:'flex',
items:this.layoutHelper.getLayout()
},
{
xtype:'container',
cls:'props-panel-bottom-container',
layout:'column',
items:[{
xtype:'web-props-mobile',
app:this.app,
cmp:this.component
}]
}
];
web.panels.props.Table.superclass.initComponent.apply(this,arguments);
this.setComponent(this.component);
if(this.component){
var len=this.component.richtext.text.length;
this.component.richtext.position(0,len);
this.layoutHelper.font.setSelection(0,len);
this.layoutHelper.para.setSelection(0,len);
this.layoutHelper.table.setSelection(0,len)
}
},
setComponent:function(component){
if(component){
this.component=component;
this.layoutHelper.font.setComponent(component);
this.layoutHelper.table.setComponent(component);
this.layoutHelper.para.setComponent(component)
}
},
refresh:function(){
},
afterRender:function(){
web.panels.props.Text.superclass.afterRender.apply(this,arguments);
this.layoutHelper.afterRender()
}
});
Ext.ns('web.panels.props.widgets');
web.commands.components.SetWidgetSettingValue=Ext.extend(web.commands.Command,{
execute:function(){
this.prevState=this.setting.getValue();
this.setting.set({value:this.value});
this.fireEvent('update',this.setting.getWidget())
},
undo:function(){
var tmp=this.setting.getValue();
this.setting.set({value:this.prevState});
this.fireEvent('update',this.setting.getWidget());
this.prevState=tmp
}
});
Ext.ns('web.ui.widgetFields');
web.ui.widgetFields.Boolean=Ext.extend(Ext.form.Checkbox,{
constructor:function(config){
if(typeof config.value==='boolean'){
config.checked=config.value
}else{
config.checked=false
}
config.hideLabel=true;
config.boxLabel=config.fieldLabel;
delete config.fieldLabel;
web.ui.widgetFields.Boolean.superclass.constructor.call(this,config)
},
setFieldValue:function(value){
this.setValue(value)
},
getFieldValue:function(){
return this.getValue()
}
});
Ext.reg('web-widget-ui-boolean',web.ui.widgetFields.Boolean);
web.ui.widgetFields.DropDown=Ext.extend(Ext.form.ComboBox,{
constructor:function(config){
if(config.param&&config.param.options){
config.store=config.param.options
}
config.listeners=config.listeners||{};
if(config.listeners.change){
this.onChange=config.listeners.change;
delete config.listeners.change
}
config.listeners.select=this.selectHandler;
config.listeners.beforeselect=this.beforeSelectHandler;
Ext.apply(this,{
mode:'local',
triggerAction:'all',
editable:false,
forceSelection:true
});
web.ui.widgetFields.DropDown.superclass.constructor.call(this,config)
},
setFieldValue:function(value){
this.setValue(value)
},
getFieldValue:function(){
return this.getValue()
},
selectHandler:function(combo,record,index){
var newVal=combo.getValue();
if(this.oldVal!==newVal){
this.onChange.call(this,combo,newVal,this.oldVal)
}
this.oldVal=null
},
beforeSelectHandler:function(combo,record,index){
this.oldVal=combo.getValue()
}
});
Ext.reg('web-widget-ui-dropdown',web.ui.widgetFields.DropDown);
web.ui.widgetFields.TextTransform=Ext.extend(Ext.form.TextField,{
validator:function(value){
if(this.param&&this.param.regex){
var regexObj=new RegExp(this.param.regex,'');
if(!regexObj.test(value)){
return'Text must follow format'
}
}
return true
},
transform:function(){
var text=this.getValue(),regex,output,matches,len,i,regexObj;
if(!text){
return''
}
if(this.param){
regex=this.param.regex;
output=this.param.transform;
if(typeof regex!=='undefined'&&typeof output!=='undefined'){
matches=text.match(new RegExp(regex,''));
if(matches!==null){
len=matches.length;
for(i=1;i<len;i+=1){
regexObj=new RegExp('{\\\\'+i+'}','g');
output=output.replace(regexObj,matches[i])
}
return output
}
}
}
return text
},
setFieldValue:function(value){
if(value&&Ext.isString(value.input)){
this.setValue(value.input)
}
},
getFieldValue:function(){
return{
'input':this.getValue(),
'output':this.transform()
}
}
});
Ext.reg('web-widget-ui-texttransform',web.ui.widgetFields.TextTransform);
web.ui.widgetFields.Text=Ext.extend(Ext.form.TextField,{
setFieldValue:function(value){
this.setValue(value)
},
getFieldValue:function(){
return this.getValue()
}
});
Ext.reg('web-widget-ui-text',web.ui.widgetFields.Text);
web.panels.props.widgets.Widget=Ext.extend(web.panels.Panel,{
initComponent:function(){
this.cls='vbox';
this.items=[
{
ref:'form',
border:false,
xtype:'form',
cls:this.widgetClass+'flex'||'',
padding:'20px 20px 0px 20px',
labelWidth:150
},
{
xtype:'container',
cls:'props-panel-bottom-container',
layout:'column',
items:[{
xtype:'web-props-mobile',
app:this.app,
cmp:this.component
}]
}
];
web.panels.props.widgets.Widget.superclass.initComponent.apply(this,arguments)
},
setComponent:function(widget){
this.widget=widget;
this.refresh()
},
refresh:function(){
this.form.removeAll();
this.settings=this.widget.getSettings().getItems();
this.settings.forEach(function(setting,index){
if(Ext.ComponentMgr.isRegistered(setting.getXType())){
var config={
index:index,
ref:setting.getRef(),
fieldLabel:setting.getName(),
listeners:{
change:this.onChange,
scope:this
},
param:setting.getParam(),
xtype:setting.getXType(),
width:setting.getWidth()
};
if(setting.getXType()==='web-widget-ui-boolean'){
config.listeners.check=this.onChange
}
var field=Ext.create(config);
field.suspendEvents();
field.setFieldValue(setting.getValue());
field.resumeEvents();
var controls=[field];
if(setting.getNote().length>0){
controls=[
field,
new Ext.form.Label({
text:setting.getNote(),
autoWidth:true,
cls:'x-form-item '
})
]
}
this.form.add(controls)
}else{
one.debug('Widget name: '+this.widget.name+', Setting name: '+setting.getName()+'\nThe xtype used for the widget field UI has not been registered.')
}
},this);
this.form.doLayout()
},
onChange:function(field){
this.setSettingValue(this.settings[field.index],field.getFieldValue())
},
setSettingValue:function(setting,value){
this.app.invoker.execute(new web.commands.components.SetWidgetSettingValue({
setting:setting,
value:value
}))
}
});
web.commands.components.UpdateVideo=Ext.extend(web.commands.Command,{
execute:function(){
this.prevState={ref:this.ref};
if(this.ref==='href'){
this.prevState.provider=this.component.getProvider();
this.prevState.value=this.component.getURL();
this.component.initService(this.opts,this.value)
}else{
this.prevState.value=this.component.getState().getSetting(this.ref).value;
this.component.getState().setSetting(this.ref,this.value)
}
this.fireEvent('update',this.component)
},
undo:function(){
var ref=this.prevState.ref,value=this.prevState.value,component=this.component;
if(this.ref==='href'){
this.prevState.value=this.component.getURL();
this.component.initService(this.prevState.provider,value)
}else{
this.prevState.value=component.getState().getSetting(ref).value;
component.getState().setSetting(ref,value)
}
this.fireEvent('update',this.component)
}
});
web.panels.props.Video=Ext.extend(web.panels.Panel,{
initComponent:function(){
var mainItems=[
{
margins:'0 0 13px 0',
xtype:'container',
layout:'hflex',
items:[
{
xtype:'label',
text:web.data.components.Video.NAME,
flex:1
},
{
xtype:'button',
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-add-video\'>',
tooltip:'Replace this video with another YouTube video.',
ref:'../../selectBtn',
listeners:{
click:this.selectVideo,
scope:this
}
}
]
},
{
xtype:'checkbox',
boxLabel:'Show information about video',
ref:'../showInfo',
value:'true',
listeners:{
check:this.selectShowInfo,
scope:this
}
},
{
xtype:'checkbox',
boxLabel:'Show controls',
ref:'../showControls',
listeners:{
check:this.selectControl,
scope:this
}
},
{
xtype:'checkbox',
boxLabel:'Start playing automatically',
ref:'../autoPlay',
listeners:{
check:this.selectAutoPlay,
scope:this
}
},
{
xtype:'checkbox',
boxLabel:'Play video again when it ends',
height:35,
ref:'../repeat',
listeners:{
check:this.selectRepeat,
scope:this
}
}
];
this.cls='web-props-panel vbox';
this.items=[
{
xtype:'container',
layout:'vbox',
layoutConfig:{align:'stretch'},
defaults:{margins:'0 0 17px 0'},
style:{padding:'20px'},
cls:'flex',
items:mainItems
},
{
xtype:'container',
cls:'props-panel-bottom-container',
layout:'column',
items:[{
xtype:'web-props-mobile',
app:this.app,
cmp:this.component
}]
}
];
web.panels.props.Video.superclass.initComponent.apply(this,arguments);
this.initSettings={
href:'',
showInfo:true,
autoPlay:false,
repeat:false,
controls:true
};
this.href=this.initSettings.href
},
setComponent:function(video){
this.component=video;
this.refresh()
},
setField:function(field,value){
field.suspendEvents();
field.setValue(value);
field.resumeEvents()
},
refresh:function(){
if(this.component.getState()){
var settings=this.component.getState().getSettings().getItemRefs();
this.setField(this.showInfo,settings.showInfo.value);
this.setField(this.autoPlay,settings.autoPlay.value);
this.setField(this.repeat,settings.repeat.value);
this.setField(this.showControls,settings.showControls.value)
}
},
selectVideo:function(){
this.app.windows.show({
type:'web.windows.video.Video',
okFn:function(videoProvider,url){
this.fireUpdate('href',url,videoProvider)
},
scope:this
})
},
selectShowInfo:function(){
this.fireUpdate('showInfo',this.showInfo.getValue())
},
selectAutoPlay:function(){
this.fireUpdate('autoPlay',this.autoPlay.getValue())
},
selectRepeat:function(){
this.fireUpdate('repeat',this.repeat.getValue())
},
selectControl:function(){
this.fireUpdate('showControls',this.showControls.getValue())
},
fireUpdate:function(ref,value,opts){
if(ref==='href'||this.component.getState()){
this.app.invoker.execute(new web.commands.components.UpdateVideo({
ref:ref,
value:value,
opts:opts||undefined,
component:this.component
}))
}
}
});
web.commands.components.GoogleDocsViewer=Ext.extend(web.commands.Command,{
constructor:function(config){
web.commands.components.GoogleDocsViewer.superclass.constructor.call(this,config)
},
execute:function(){
var googleDoc=this.googleDoc,json=this.json;
this.prevState=googleDoc.toJSON();
googleDoc.set(json);
this.fireEvent('update',googleDoc)
},
undo:function(){
var googleDoc=this.googleDoc,currentState=googleDoc.toJSON();
googleDoc.set(this.prevState);
this.prevState=currentState;
this.fireEvent('update',googleDoc)
}
});
web.panels.props.GoogleDocsViewer=Ext.extend(web.panels.Panel,{
initComponent:function(){
this.cls='web-props-panel vbox';
this.items=[
{
xtype:'container',
cls:'flex',
style:{padding:'20px'},
items:[{
xtype:'container',
layout:'hflex',
items:[
{
xtype:'label',
text:'Document:',
flex:1,
style:{paddingTop:'5px'}
},
{
xtype:'label',
ref:'../../displayFileName',
style:'white-space:nowrap',
cls:'web-panels-props-document-filename'
},
{
xtype:'button',
tooltip:'Page Information',
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-add-document\'>',
labelSeparator:'',
fieldLabel:' ',
handler:function(){
this.app.windows.show({
type:'web.windows.GoogleDocsViewer',
values:{
newDocument:false,
url:this.component.settings.src,
mode:'edit'
},
okFn:function(url){
this.updateComponent({settings:{src:url}})
},
scope:this
})
},
scope:this
}
]
}]
},
{
xtype:'container',
cls:'props-panel-bottom-container',
layout:'column',
items:[{
xtype:'web-props-mobile',
app:this.app,
cmp:this.component
}]
}
];
web.panels.props.GoogleDocsViewer.superclass.initComponent.apply(this,arguments)
},
setComponent:function(component){
if(component){
this.component=component;
this.refresh()
}
},
refresh:function(){
this.loadFields()
},
updateComponent:function(changes){
var command,newJSON;
if(this.component){
newJSON=Ext.apply(this.component.toJSON(),changes);
if(Ext.encode(newJSON)===Ext.encode(this.component.toJSON())){
return
}
command=new web.commands.components.GoogleDocsViewer({
googleDoc:this.component,
json:changes
});
this.app.invoker.execute(command)
}
},
loadFields:function(){
if(this.component instanceof web.data.components.GoogleDocsViewer){
if(this.component.settings&&this.component.settings.src){
var src=web.DAL.decodeHref(this.component.settings.src);
if(!/\/$/.test(src)){
src=src.replace(/.*\//,'')
}
this.displayFileName.setText(Ext.util.Format.ellipsis(src,20))
}
}
},
setSettingValue:function(setting,value){
this.app.invoker.execute(new web.commands.components.GoogleDocsViewer({
component:this.widget,
setting:setting,
value:value
}))
}
});
web.commands.templates.EditLocale=Ext.extend(web.commands.CompoundCommand,{
constructor:function(config){
web.commands.templates.EditLocale.superclass.constructor.call(this,config)
},
execute:function(){
var that=this,cfg={locale:this.locale},ns=web.commands.components,components=this.components||[];
this.prevState={locale:this.template.getLocale()};
this.template.set(cfg);
this.fireEvent('update',this.template);
components.forEach(function(component){
var target,parentType=component.getParent().getType();
if('web.data.components.Page'===parentType){
target=that.page
}else if('web.data.components.Template'===parentType){
target=that.template
}
that.executeCommand(new ns.InsertSimple({
component:component,
target:target,
config:cfg
}))
})
},
undo:function(){
var that=this,components=this.components||[],cfg={locale:this.template.getLocale()};
this.template.set(this.prevState);
this.fireEvent('update',this.template);
components.forEach(function(component){
component.set(that.prevState);
that.fireEvent('update',component)
});
this.prevState=cfg
}
});
web.commands.components.FacebookPage=Ext.extend(web.commands.Command,{
execute:function(){
var component=this.component;
this.prevStats=component.toJSON();
component.set(this.props);
this.fireEvent('update',component)
},
undo:function(){
var component=this.component,prevState=this.prevState,currentState=component.toJSON();
component.set(prevState);
this.prevStatus=currentState;
this.fireEvent('update',component)
}
});
web.commands.components.ShareButtons=Ext.extend(web.commands.Command,{
execute:function(){
var component=this.component;
this.prevState=component.toJSON();
component.set(this.props);
this.fireEvent('update',component)
},
undo:function(){
var component=this.component,prevState=this.prevState,currentState=component.toJSON();
component.set(prevState);
this.prevState=currentState;
this.fireEvent('update',component)
}
});
web.windows.ThirdPartyLocales=Ext.extend(web.windows.Window,{
type:'web.windows.ThirdPartyLocales',
modal:true,
resizable:false,
constructor:function(config){
web.windows.ThirdPartyLocales.superclass.constructor.call(this,config)
},
initComponent:function(){
this.localeCombo=new web.ui.ComboBox({
itemId:'fbLocale',
store:new Ext.data.ArrayStore({
fields:[
'id',
'text'
],
data:[
[
'cs',
'etina'
],
[
'da',
'Dansk'
],
[
'de',
'Deutsch'
],
[
'en_gb',
'English (UK)'
],
[
'en_us',
'English (US)'
],
[
'es',
'Espaol'
],
[
'fr',
'Franais'
],
[
'it',
'Italiano'
],
[
'nl',
'Nederlands'
],
[
'nb',
'Norsk bokml'
],
[
'pl',
'Polski'
],
[
'pt',
'Portugus'
],
[
'fi',
'Suomi'
],
[
'sv',
'Svenska'
]
]
}),
valueField:'id',
displayField:'text',
mode:'local',
triggerAction:'all',
editable:false,
value:'en_us',
width:250,
listWidth:253,
lazyInit:false
});
this.title='Select language';
this.cls='web-windows-thirdpartylocales';
this.items=[
{
xtype:'container',
cls:'hbox cross-center',
items:[
{
xtype:'spacer',
width:30
},
{
xtype:'label',
cls:'flex',
text:'Select language'
},
this.localeCombo,
{
xtype:'spacer',
width:30
}
]
},
{
xtype:'spacer',
height:75
},
{
xtype:'container',
cls:'web-window-footer hbox cross-center',
items:[
{
xtype:'spacer',
cls:'flex'
},
{
xtype:'button',
cls:'x-btn-secondary large wide',
text:'Cancel',
listeners:{
click:function(btn){
this.hide()
},
scope:this
}
},
{
xtype:'spacer',
width:20
},
{
xtype:'button',
cls:'x-btn-primary large wide',
text:'OK',
listeners:{
click:function(btn){
var that=this,page=that.app.getSelected('page'),template=that.app.getSelected('template'),socialType=[
'web.data.components.FacebookPage',
'web.data.components.ShareButtons'
],components=[];
components=template.getAllItems().filter(function(item){
return socialType.indexOf(item.getType())>-1
});
that.app.invoker.execute(new web.commands.templates.EditLocale({
template:template,
page:page,
components:components,
locale:that.localeCombo.getValue()
}));
that.hide()
},
scope:this
}
}
]
}
];
web.windows.ThirdPartyLocales.superclass.initComponent.apply(this,arguments)
},
setValues:function(config){
this.locale=config.locale;
this.localeCombo.setValue(this.locale)
}
});
web.panels.props.ShareButtons=Ext.extend(web.panels.Panel,{
isHiddenStyledd:true,
isHiddenFbverb:true,
componentList:[
'selectedStyle',
'verbToDisplay',
'facebook',
'fbShare',
'showFriends',
'twitter',
'linkedIn',
'gPlus',
'alignBtnCntnr'
],
availableTypes:{
horizontalcount:'Horizontal count',
verticalcount:'Vertical count',
withoutcount:'Without count',
extrainfo:'Extra Info',
simple1:'Round',
simple2:'Square'
},
initComponent:function(){
var noNullToggle=function(button,state){
if(state){
button.disable()
}else{
button.enable()
}
};
this.onAlign=function(button){
if(!this.alignBtnCntnr.disabled){
this.updateComponent({align:button.itemId})
}else{
button.toggle(false)
}
};
this.styleListDrpdwn=new Ext.Button({
cls:'dropdown-gear custom-color-panel-gear-btn',
tooltip:'Settings',
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
labelSeparator:'',
fieldLabel:' ',
enableToggle:true,
pressed:false,
handler:function(){
this.fbSettings.toggle(false,true);
this.fbStyleSettingsBodyPatch.getEl().removeClass('custom-panel-patch-holder-visible');
this.fbStyleSettingsCntnr.getEl().removeClass('custom-panel-isExpanded text-color-panel-visible');
this.panelBodyPatch.getEl().toggleClass('custom-panel-patch-holder-visible');
this.shareButtonStylesCntnr.getEl().toggleClass('custom-panel-isExpanded text-color-panel-visible')
},
scope:this
});
this.fbSettings=new Ext.Button({
cls:'dropdown-gear custom-color-panel-gear-btn',
tooltip:'Settings',
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
labelSeparator:'',
fieldLabel:' ',
enableToggle:true,
pressed:false,
handler:function(){
this.styleListDrpdwn.toggle(false,true);
this.panelBodyPatch.getEl().removeClass('custom-panel-patch-holder-visible');
this.shareButtonStylesCntnr.getEl().removeClass('custom-panel-isExpanded text-color-panel-visible');
this.fbStyleSettingsBodyPatch.getEl().toggleClass('custom-panel-patch-holder-visible');
this.fbStyleSettingsCntnr.getEl().toggleClass('custom-panel-isExpanded text-color-panel-visible')
},
scope:this
});
this.verbToDisplay=new web.ui.ComboBox({
name:'level',
mode:'local',
triggerAction:'all',
forceSelection:true,
editable:false,
store:this.verbDataStore(),
valueField:'id',
displayField:'text',
width:150,
listeners:{
render:function(combo){
combo.tip=new Ext.ToolTip({
target:combo.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:'Verb to display'
},
constrainPosition:true
})
}
}
});
this.cls='web-props-panel vbox';
this.items=[
{
xtype:'container',
flex:1,
cls:'shareButtonsProps flex',
style:{
padding:'17px 0 20px 20px',
overflow:'auto'
},
defaults:{width:275},
items:[
{
xtype:'container',
layout:'hflex',
layoutConfig:{align:'middle'},
items:[
{
xtype:'label',
text:'Style',
flex:1
},
{
ref:'../../selectedStyle',
xtype:'label',
style:{
whiteSpace:'nowrap',
paddingRight:'7px'
},
text:''
},
this.styleListDrpdwn
]
},
{
xtype:'spacer',
ref:'../panelBodyPatch',
cls:'shareButtonStyles custom-panel-patch-holder',
height:'2px',
html:'<div class="custom-panel-body-patch"></div>'
},
{
ref:'../shareButtonStylesCntnr',
xtype:'container',
layout:'vflex',
cls:'shareButtonStylesCntnr custom-sharebutton-panel-body',
style:{marginBottom:'13px'},
items:[
{
ref:'../../verticalcountBtn',
xtype:'button',
cls:'sharebuttoncls verticalcountcls',
handler:function(){
var cfg={styleInfo:'verticalcount'};
this.updateComponent(cfg);
this.hideShareButtonStylesCntnr()
},
scope:this,
iconCls:'icon icon-vertical-count',
iconAlign:'top',
text:'<span class="sb-style-text">'+this.availableTypes.verticalcount+'</span>'
},
{
ref:'../../horizontalcountBtn',
xtype:'button',
cls:'sharebuttoncls horizontalcountcls',
handler:function(){
var cfg={styleInfo:'horizontalcount'};
this.updateComponent(cfg);
this.hideShareButtonStylesCntnr()
},
scope:this,
iconCls:'icon icon-horizontal-count',
iconAlign:'top',
text:'<span class="sb-style-text">'+this.availableTypes.horizontalcount+'</span>'
},
{
ref:'../../withoutcountBtn',
xtype:'button',
cls:'sharebuttonWithoutCountcls',
handler:function(){
var cfg={styleInfo:'withoutcount'};
this.updateComponent(cfg);
this.hideShareButtonStylesCntnr()
},
scope:this,
iconCls:'icon icon-without-count',
iconAlign:'top',
height:'72px',
text:'<span class="sb-style-text">'+this.availableTypes.withoutcount+'</span>'
},
{
ref:'../../extrainfoBtn',
xtype:'button',
cls:'sharebuttonExtraInfocls',
handler:function(){
var cfg={styleInfo:'extrainfo'};
this.updateComponent(cfg);
this.hideShareButtonStylesCntnr()
},
scope:this,
iconCls:'icon icon-extra-info',
iconAlign:'top',
text:'<span class="sb-style-text">'+this.availableTypes.extrainfo+'</span>'
},
{
ref:'../../simple1',
xtype:'button',
cls:'sharebuttoncls simple1cls',
handler:function(){
var cfg={styleInfo:'simple1'};
this.updateComponent(cfg);
this.hideShareButtonStylesCntnr()
},
scope:this,
iconCls:'icon icon-simple1',
iconAlign:'top',
height:'93px',
text:'<span class="sb-style-text">'+this.availableTypes.simple1+'</span>'
},
{
ref:'../../simple2',
xtype:'button',
cls:'sharebuttoncls',
handler:function(){
var cfg={styleInfo:'simple2'};
this.updateComponent(cfg);
this.hideShareButtonStylesCntnr()
},
scope:this,
iconCls:'icon icon-simple2',
iconAlign:'top',
height:'93px',
text:'<span class="sb-style-text">'+this.availableTypes.simple2+'</span>'
}
]
},
{
xtype:'container',
layout:'hflex',
layoutConfig:{align:'middle'},
style:{marginBottom:'13px'},
items:[
{
xtype:'label',
text:'Alignment:',
flex:1
},
{
ref:'../../alignBtnCntnr',
xtype:'container',
cls:'web-panel-button-group-new',
style:'white-space:nowrap',
items:[
{
xtype:'button',
itemId:'left',
tooltip:'Align left.',
iconCls:'icon icon-rte-justifyleft',
scale:'small',
width:35,
enableToggle:true,
toggleGroup:'align',
toggleHandler:noNullToggle,
handler:this.onAlign,
scope:this
},
{
xtype:'button',
itemId:'center',
tooltip:'Align center.',
iconCls:'icon icon-rte-justifycenter',
scale:'small',
width:35,
enableToggle:true,
toggleGroup:'align',
toggleHandler:noNullToggle,
handler:this.onAlign,
scope:this
},
{
xtype:'button',
itemId:'right',
tooltip:'Align right.',
iconCls:'icon icon-rte-justifyright',
scale:'small',
width:35,
enableToggle:true,
toggleGroup:'align',
toggleHandler:noNullToggle,
handler:this.onAlign,
scope:this
}
]
}
]
},
{
xtype:'container',
layout:'hflex',
items:[
{
ref:'../../facebook',
xtype:'checkbox',
flex:1,
boxLabel:'Facebook Like:',
checked:true,
listeners:{
check:function(checkbox,checked){
this.updateComponent({showFacebook:checked})
},
scope:this
}
},
this.fbSettings
]
},
{
xtype:'spacer',
ref:'../fbStyleSettingsBodyPatch',
cls:'fbStyleSettings custom-panel-patch-holder',
height:'2px',
html:'<div class="custom-panel-body-patch"></div>'
},
{
ref:'../fbStyleSettingsCntnr',
xtype:'container',
layout:'vflex',
cls:'fbStyleSettingsCntnr custom-sharebutton-panel-body',
style:{marginBottom:'15px'},
items:[
{
xtype:'container',
layout:'hflex',
style:{
'padding-top':'5px',
'padding-bottom':'5px'
},
items:[
{
xtype:'label',
text:'Verb to display',
flex:1
},
{
xtype:'container',
items:[this.verbToDisplay]
}
]
},
{
ref:'../../showFriends',
xtype:'checkbox',
boxLabel:'Show friends (Extra Info style only)',
checked:true,
listeners:{
check:function(checkbox,checked){
this.updateComponent({showFriends:checked})
},
scope:this
}
}
]
},
{
ref:'../fbShare',
xtype:'checkbox',
cls:'fbShare',
boxLabel:'Facebook Share:',
checked:false,
width:250,
listeners:{
check:function(checkbox,checked){
this.updateComponent({showFacebookShare:checked})
},
scope:this
}
},
{
ref:'../gPlus',
xtype:'checkbox',
cls:'googlePlus',
boxLabel:'Google+:',
checked:true,
width:250,
listeners:{
check:function(checkbox,checked){
this.updateComponent({showGplus:checked})
},
scope:this
}
},
{
ref:'../linkedIn',
xtype:'checkbox',
boxLabel:'LinkedIn:',
checked:true,
width:250,
listeners:{
check:function(checkbox,checked){
this.updateComponent({showLinkedIn:checked})
},
scope:this
}
},
{
ref:'../twitter',
xtype:'checkbox',
boxLabel:'Twitter:',
checked:true,
width:250,
listeners:{
check:function(checkbox,checked){
this.updateComponent({showTwitter:checked})
},
scope:this
}
},
{
xtype:'container',
cls:'hbox cross-center',
items:[
{
xtype:'label',
text:'Select language',
cls:'flex'
},
{
xtype:'button',
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
listeners:{
click:function(btn){
var locale=this.app.getSelected('template').getLocale();
this.app.windows.show({
type:'web.windows.ThirdPartyLocales',
values:{locale:locale}
})
},
scope:this
}
}
]
}
]
},
{
xtype:'container',
cls:'props-panel-bottom-container',
layout:'column',
items:[{
xtype:'web-props-mobile',
app:this.app,
cmp:this.component
}]
}
];
this.verbToDisplay.on('select',function(){
var value=this.verbToDisplay.value,cfg;
cfg={verbToDisplay:value};
this.updateComponent(cfg)
},this);
this.app.on('update',function(part){
if(part===this.component){
this.refresh()
}
},this);
web.panels.props.ShareButtons.superclass.initComponent.apply(this,arguments)
},
setComponent:function(component){
if(component){
this.component=component;
this.refresh()
}
},
updateComponent:function(changes){
var command;
if(this.component){
command=new web.commands.components.ShareButtons({
component:this.component,
props:changes
});
this.app.invoker.execute(command)
}
},
verbDataStore:function(){
var types={
like:'Like',
recommend:'Recommend'
},arr=[],name;
arr=[];
for(name in types){
if(types.hasOwnProperty(name)){
arr.push([
name,
types[name]
])
}
}
return new Ext.data.ArrayStore({
fields:[
'id',
'text'
],
data:arr
})
},
fontDataStore:function(){
var types={
'arial':'Arial',
'lucida grande':'Lucida grande',
'segoe ui':'Segoe UI',
'tahoma':'Tahoma',
'trebuchet ms':'Trebuchet MS',
'verdana':'Verdana'
},arr=[],name;
arr=[];
for(name in types){
if(types.hasOwnProperty(name)){
arr.push([
name,
types[name]
])
}
}
return new Ext.data.ArrayStore({
fields:[
'id',
'text'
],
data:arr
})
},
refresh:function(){
this.allComponentsEventHandler('suspendEvents');
this.selectedStyle.setText(this.availableTypes[this.component.styleInfo]);
this.verbToDisplay.setValue(this.component.verbToDisplay);
this.facebook.setValue(this.component.showFacebook);
this.fbShare.setValue(this.component.showFacebookShare);
this.showFriends.setValue(this.component.showFriends);
this.twitter.setValue(this.component.showTwitter);
this.linkedIn.setValue(this.component.showLinkedIn);
this.gPlus.setValue(this.component.showGplus);
this.alignBtnCntnr.setDisabled(this.component.styleInfo==='extrainfo');
this.alignBtnCntnr.find('itemId',this.component.align)[0].toggle(this.component.styleInfo==='extrainfo'?false:true);
this.allComponentsEventHandler('resumeEvents')
},
allComponentsEventHandler:function(handler){
Ext.each(this.componentList,function(componentRef){
this[componentRef][handler]()
},this)
},
hideShareButtonStylesCntnr:function(){
this.panelBodyPatch.getEl().removeClass('custom-panel-patch-holder-visible');
this.shareButtonStylesCntnr.getEl().removeClass('custom-panel-isExpanded text-color-panel-visible');
this.styleListDrpdwn.toggle(false,true)
}
});
web.commands.components.Buttons=Ext.extend(web.commands.CompoundCommand,{
execute:function(){
var component=this.component;
this.prevState=component.toJSON();
component.set(this.props);
this.fireEvent('update',component)
},
undo:function(){
var component=this.component,prevState=this.prevState,currentState=component.toJSON();
component.set(prevState);
this.prevState=currentState;
this.fireEvent('update',component)
}
});
web.panels.props.Buttons=Ext.extend(web.panels.Panel,{
initComponent:function(){
var sizes=[
9,
10,
11,
12,
13,
14,
15,
16,
18,
20,
22,
24,
26,
28,
32,
36,
40,
44,
48,
54,
60,
66,
72,
80,
88,
96
];
this.cls='web-props-panel vbox';
this.link=new Ext.Button({
itemId:'link',
tooltip:'Add Link.',
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-text-link\' />',
listeners:{
click:this.addLink,
scope:this
}
});
this.linkName=new Ext.form.Label({style:{paddingRight:'5px'}});
this.unlink=new Ext.Button({
itemId:'unlink',
tooltip:'Remove link.',
cls:'props-panel-remove-button',
listeners:{
click:this.removeLink,
scope:this
}
});
this.size=new web.ui.ComboBox({
itemId:'size',
store:sizes,
triggerAction:'all',
value:12,
width:43,
enableKeyEvents:true,
maxNumber:999,
minNumber:9,
listeners:{
render:function(combo){
combo.tip=new Ext.ToolTip({
target:combo.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:'Font size.'
}
})
},
keyup:function(combo,e){
if(e.getCharCode()===13){
var size=parseInt(combo.getRawValue(),10);
if(Ext.isNumber(size)&&size>0){
this.onSelectSize(combo)
}
}
},
select:this.onSelectSize,
scope:this
}
});
this.items=[
{
xtype:'container',
cls:'ButtonsProps flex',
style:{
padding:'17px 0 20px 20px',
overflow:'auto'
},
defaults:{width:275},
items:[
{
xtype:'container',
cls:'hbox cross-center',
items:[
{
xtype:'container',
cls:'flex',
html:'Button style'+':'
},
{
xtype:'web-ui-fields-buttonstyleselector',
ref:'../../buttonStyleSelector',
cls:'buttonStyleSelector',
width:185,
app:this.app,
component:this.component,
listeners:{
change:function(styleId){
var styleButton=this.component.getStyleButton();
styleButton.globalId=styleId;
this.updateComponent({styleButton:styleButton.toJSON()})
},
scope:this
}
}
]
},
{
xtype:'spacer',
width:5,
height:15
},
{
xtype:'container',
cls:'hbox cross-center button-font-size',
items:[
{
xtype:'container',
cls:'flex',
html:'Button text'+':'
},
{
xtype:'textfield',
ref:'../../btnTextField',
enableKeyEvents:true,
autoCreate:{
tag:'input',
type:'text'
},
width:120,
style:{padding:'2px 6px'},
validateOnBlur:false,
listeners:{
valid:function(field){
var currentValue=field.getValue();
if(currentValue!==this.component.getBtnText()){
this.updateComponent({btnText:currentValue})
}
},
scope:this
}
},
{
xtype:'spacer',
width:5
},
this.size
]
},
{
xtype:'spacer',
width:5,
height:15
},
{
xtype:'container',
cls:'hbox cross-center',
items:[
{
xtype:'container',
cls:'flex',
html:'Link:'
},
{
xtype:'container',
cls:'hbox cross-center',
items:[
this.linkName,
this.unlink,
{
xtype:'container',
layout:'hauto',
cls:'web-panel-button-group-new',
items:[this.link]
}
]
}
]
}
]
},
{
xtype:'container',
cls:'props-panel-bottom-container',
layout:'column',
items:[{
xtype:'web-props-mobile',
app:this.app,
cmp:this.component
}]
}
];
this.app.on('update',function(part){
if(part===this.component){
this.refresh()
}
},this);
web.panels.props.Buttons.superclass.initComponent.apply(this,arguments)
},
onSelectSize:function(combo){
this.updateComponent({localFontSize:parseInt(combo.getRawValue(),10)})
},
setComponent:function(component){
if(component){
this.component=component;
this.refresh()
}
},
updateComponent:function(changes){
var command;
if(this.component){
command=new web.commands.components.Buttons({
component:this.component,
props:changes
});
this.app.invoker.execute(command)
}
},
refresh:function(){
var cmp=this.component,linkName='None',brokenLinkName='Broken link',action=cmp.getAction(),btnText,styleButton=cmp.getStyleButton(),size=styleButton.inactive.text.size?styleButton.inactive.text.size:cmp.dm.get(styleButton.globalId).inactive.text.size;
this.buttonStyleSelector.setValue(cmp.getGlobalStyleId());
btnText=cmp.getBtnText();
if(this.size.getValue()!==size){
this.size.setValue(size)
}
if(this.btnTextField.getValue()!==btnText){
this.btnTextField.suspendEvents();
this.btnTextField.setValue(btnText);
this.btnTextField.resumeEvents()
}
this.unlink.setVisible(!!action);
if(action){
linkName=action.linkId&&this.app.dm.get(action.linkId)?this.app.dm.get(action.linkId).name:action.link?action.link.name:linkName;
linkName=web.utils.String.formatLink(linkName);
if(action.link&&action.link.name===web.windows.Link.DUMMY_URL||action.linkId&&this.app.dm.get(action.linkId)===undefined){
linkName=brokenLinkName
}
}
this.linkName.setText(linkName)
},
addLink:function(){
this.app.windows.show({
type:'web.windows.Link',
values:this.component.getAction(),
okFn:function(wn,linkType,actionType,value){
var link,action;
if(linkType===null){
this.removeLink();
return
}else if(linkType==='linkId'){
link=this.app.dm.get(value);
action={linkId:link.getId()}
}else if(linkType==='href'){
action={
link:{
type:'web.data.links.LinkExternal',
name:value,
url:value
}
}
}
action.actionType=actionType;
this.app.invoker.execute(new web.commands.components.ApplyLink({
target:this.component,
link:action
}))
},
scope:this
})
},
removeLink:function(){
var app=this.app;
this.linkName.setText('None');
app.invoker.execute(new web.commands.components.RemoveLink({target:this.component}))
},
popupGlobalStyles:function(tabIndex){
this.app.windows.show({
type:'web.windows.GlobalStyles',
values:{activeItem:tabIndex}
})
}
});
web.panels.props.FacebookPage=Ext.extend(web.panels.Panel,{
initComponent:function(){
this.urlPrefix='http://www.facebook.com/';
this.cls='web-props-panel web-panels-props-facebook';
this.items=[{
xtype:'container',
region:'center',
width:280,
style:{padding:'20px 0 20px 20px'},
items:[
{
xtype:'label',
text:'Facebook Page URL:',
tootlitp:'',
style:{
width:'100%',
marginBottom:'15px'
}
},
{
xtype:'container',
width:270,
items:[
{
xtype:'textfield',
ref:'../../href',
allowBlank:false,
enableKeyEvents:true,
style:{
width:'40%',
float:'right',
marginBottom:'5px'
},
validator:function(url){
if(/^pages\/[a-zA-Z]+\/[0-9]+$/.test(url)){
return true
}else if(/^[A-Za-z0-9][\u0000-\uFFFF]*[a-zA-Z0-9]$/.test(url)){
return true
}
return false
},
listeners:{
blur:function(href){
if(href.isValid()){
this.updateComponent({href:this.urlPrefix+href.getEl().getValue()})
}
},
keyup:function(href,evt){
if(href.isValid()&&evt.keyCode===13){
this.updateComponent({href:this.urlPrefix+href.getEl().getValue()})
}
},
scope:this
}
},
{
xtype:'label',
text:'www.facebook.com/',
style:{
width:'44%',
float:'right',
marginTop:'2px',
marginBottom:'5px'
}
}
]
},
{
xtype:'checkbox',
ref:'../showFriendsFaces',
height:35,
width:270,
tooltip:'Show profile photos when friends like this',
boxLabel:'Show friend\'s faces:',
checked:false,
listeners:{
check:function(checkbox,checked){
this.updateComponent({showFriendsFaces:checked})
},
scope:this
}
},
{
xtype:'checkbox',
ref:'../useSmallHeader',
height:35,
width:270,
tooltip:'Use a small version of the header',
boxLabel:'Use small header:',
checked:false,
listeners:{
check:function(checkbox,checked){
this.updateComponent({useSmallHeader:checked})
},
scope:this
}
},
{
xtype:'checkbox',
ref:'../hideCoverPhoto',
height:35,
width:270,
tooltip:'Hide the cover photo inside the header',
boxLabel:'Hide cover photo:',
checked:false,
listeners:{
check:function(checkbox,checked){
this.updateComponent({hideCoverPhoto:checked})
},
scope:this
}
},
{
xtype:'checkbox',
ref:'../showPagePosts',
height:35,
width:270,
tooltip:'Show posts from the page\'s timeline',
boxLabel:'Show page posts:',
checked:false,
listeners:{
check:function(checkbox,checked){
this.updateComponent({showPagePosts:checked})
},
scope:this
}
},
{
xtype:'container',
cls:'hbox cross-center',
width:270,
items:[
{
xtype:'label',
text:'Select language',
cls:'flex'
},
{
xtype:'button',
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
listeners:{
click:function(btn){
var locale=this.app.getSelected('template').getLocale();
this.app.windows.show({
type:'web.windows.ThirdPartyLocales',
values:{locale:locale}
})
},
scope:this
}
}
]
}
]
}];
this.app.on('update',function(part){
if(part===this.component){
this.refresh()
}
},this);
web.panels.props.FacebookPage.superclass.initComponent.apply(this,arguments);
this.on('afterrender',function(){
var quicktip=new Ext.QuickTip({target:this.getEl()});
this.findByType('checkbox').forEach(function(checkbox){
if(checkbox.tooltip){
checkbox.on('afterrender',function(){
quicktip.register({
target:checkbox.wrap.dom,
text:checkbox.tooltip
})
},this)
}
},this)
},this)
},
setComponent:function(component){
if(component){
this.component=component;
this.refresh()
}
},
updateComponent:function(changes){
var command;
if(this.component){
command=new web.commands.components.FacebookPage({
component:this.component,
props:changes
});
this.app.invoker.execute(command)
}
},
refresh:function(){
this.href.setValue(this.component.href.replace(/^http[s]?:\/\/www\.facebook\.com\//,''));
this.showFriendsFaces.setValue(this.component.showFriendsFaces);
this.useSmallHeader.setValue(this.component.useSmallHeader);
this.hideCoverPhoto.setValue(this.component.hideCoverPhoto);
this.showPagePosts.setValue(this.component.showPagePosts)
}
});
web.panels.props.MoreSettingsWidget=Ext.extend(web.panels.Panel,{
initComponent:function(){
this.style={
padding:'10px 10px 10px 10px',
border:'1px solid #888',
background:'#ddd'
};
web.panels.props.MoreSettingsWidget.superclass.initComponent.apply(this,arguments)
},
show:function(){
},
hide:function(){
}
});
web.panels.props.ImageSlider=Ext.extend(web.panels.Panel,{
initComponent:function(){
var noNullToggle=function(button,state){
if(state){
button.disable()
}else{
button.enable()
}
};
this.cls='web-props-panel vbox';
this.settingsCombo=new web.ui.ComboBox({
name:'settings',
mode:'local',
triggerAction:'all',
forceSelection:true,
editable:false,
store:new Ext.data.ArrayStore({
fields:[
'id',
'text'
],
data:[
[
'noaction',
'Do nothing'
],
[
'lightbox',
'Show large images'
],
[
'links',
'Open links'
]
]
}),
valueField:'id',
displayField:'text',
width:150,
listeners:{
scope:this,
render:function(combo){
combo.tip=new Ext.ToolTip({
target:combo.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:'Select what should happen when clicking an image in the slider.'
},
constrainPosition:true
})
},
select:function(combo){
this.onSelectAction(combo.value)
}
}
});
this.forwardBackCombo=new web.ui.ComboBox({
store:new Ext.data.ArrayStore({
idIndex:0,
fields:[
'id',
'name'
],
data:[
[
web.data.components.ImageSlider.Options.ALWAYS,
'Show always'
],
[
web.data.components.ImageSlider.Options.MOUSEOVER,
'Show on mouse over'
],
[
web.data.components.ImageSlider.Options.NEVER,
'Don\'t show'
]
]
}),
valueField:'id',
displayField:'name',
mode:'local',
triggerAction:'all',
editable:false,
value:web.data.components.ImageSlider.Options.NEVER,
width:150,
minListWidth:150,
listWidth:'auto',
listeners:{
select:function(combo){
this.updateComponent({navigator:combo.getValue()})
},
scope:this
}
});
this.indicatorCombo=new web.ui.ComboBox({
store:new Ext.data.ArrayStore({
idIndex:0,
fields:[
'id',
'name'
],
data:[
[
web.data.components.ImageSlider.Options.ALWAYS,
'Show always'
],
[
web.data.components.ImageSlider.Options.MOUSEOVER,
'Show on mouse over'
],
[
web.data.components.ImageSlider.Options.NEVER,
'Don\'t show'
]
]
}),
valueField:'id',
displayField:'name',
mode:'local',
triggerAction:'all',
editable:false,
value:web.data.components.ImageSlider.Options.ALWAYS,
width:150,
listeners:{
select:function(combo){
this.updateComponent({indicator:combo.getValue()})
},
scope:this
}
});
this.autoNextCombo=new web.ui.ComboBox({
store:new Ext.data.ArrayStore({
idIndex:0,
fields:[
'id',
'name'
],
data:[
[
true,
'Auto'
],
[
false,
'Manual'
]
]
}),
valueField:'id',
displayField:'name',
mode:'local',
triggerAction:'all',
editable:false,
value:0,
width:75,
listeners:{
select:function(combo){
this.updateComponent({autoNext:combo.getValue()});
this.transitionSettingsVisible(this.autoNextCombo.getValue())
},
scope:this
}
});
this.autoNextGear=new Ext.Button({
cls:'dropdown-gear',
tooltip:'Settings',
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
labelSeparator:'',
fieldLabel:' ',
handler:function(){
this.transitionSettingsVisible(!this.autoNextGear.getEl().hasClass('active'))
},
scope:this
});
this.transitionCombo=new web.ui.ComboBox({
store:new Ext.data.ArrayStore({
idIndex:0,
fields:[
'id',
'name'
],
data:[
[
'slide',
'Slide'
],
[
'fade',
'Fade'
]
]
}),
valueField:'id',
displayField:'name',
mode:'local',
triggerAction:'all',
editable:false,
value:'slide',
width:150,
listeners:{
select:function(combo){
this.updateComponent({transition:combo.getValue()})
},
scope:this
}
});
this.placementCombo=new web.ui.ComboBox({
store:new Ext.data.ArrayStore({
idIndex:0,
fields:[
'id',
'name'
],
data:[
[
'top',
'Top'
],
[
'middle',
'Middle'
],
[
'bottom',
'Bottom'
]
]
}),
valueField:'id',
displayField:'name',
mode:'local',
triggerAction:'all',
editable:false,
value:'bottom',
width:150,
listeners:{
select:function(combo){
this.updateComponent({captionsPlacement:combo.getValue()})
},
scope:this
}
});
this.delaySpinner=new Ext.ux.form.SpinnerField({
xtype:'spinnerfield',
allowBlank:false,
minValue:1,
maxValue:15,
value:3,
width:60,
onBlur:function(){
if(this.getValue()<1){
this.setValue(1)
}
if(this.getValue()>15){
this.setValue(15)
}
},
listeners:{
valid:function(e){
if(this.imageSlider){
var delay=this.delaySpinner.getValue(),pDelay=this.imageSlider.delay;
if(Ext.isNumber(delay)&&delay!==pDelay){
this.updateComponent({delay:delay})
}
}
},
spin:function(e){
this.updateComponent({delay:this.delaySpinner.getValue()})
},
scope:this
}
});
this.items=[
{
ref:'props',
xtype:'container',
style:{
padding:'20px 0px 20px 20px',
overflow:'auto'
},
cls:'flex',
defaults:{
xtype:'container',
layout:'hflex',
width:267
},
items:[
{
style:{paddingBottom:'10px'},
items:[
{
xtype:'label',
text:'Images:',
flex:1
},
{
xtype:'container',
ref:'../../imageCountBox',
style:{paddingRight:'10px'}
},
{
xtype:'button',
scale:'small',
text:'Change images',
style:'margin-right:5px;',
width:'60px',
handler:this.sortImages,
scope:this
}
]
},
{
style:{paddingBottom:'10px'},
items:[
{
xtype:'label',
text:'Forward/back:',
flex:1
},
this.forwardBackCombo
]
},
{
style:{paddingBottom:'10px'},
items:[
{
xtype:'label',
text:'Indicator:',
flex:1
},
this.indicatorCombo
]
},
{
style:{paddingBottom:'10px'},
items:[
{
xtype:'label',
text:'Transition:',
flex:1
},
this.transitionCombo
]
},
{
items:[
{
xtype:'label',
text:'Show next image:',
flex:1
},
{
xtype:'container',
cls:'web-panel-button-group-new',
style:'white-space:nowrap',
layout:'hauto',
items:[
this.autoNextCombo,
this.autoNextGear
]
}
]
},
{
ref:'../transitionSettingsTopBorder',
layout:'hbox',
height:2,
cls:'dropdown-panel-top-border',
items:[
{
xtype:'container',
cls:'ddp-topborder',
width:242,
height:2
},
{
xtype:'container',
cls:'ddp-joiner',
width:25,
height:2
}
]
},
{
ref:'../transitionSettings',
cls:'dropdown-panel',
items:[
{
xtype:'label',
text:'Seconds to show image:',
flex:1
},
this.delaySpinner
]
},
{
xtype:'container',
layout:'hflex',
style:{paddingTop:'10px'},
items:[
{
xtype:'container',
html:'Crop Images',
flex:1
},
{
ref:'../crop',
xtype:'checkbox',
width:15,
listeners:{
check:function(checkbox,checked){
this.onSetCrop(checked)
},
scope:this
}
}
]
},
{
xtype:'container',
layout:'hflex',
style:{
paddingTop:'10px',
paddingBottom:'10px'
},
items:[
{
xtype:'label',
text:'On click:',
flex:1
},
this.settingsCombo
]
},
{
xtype:'container',
height:23,
layout:'hflex',
items:[
{
xtype:'label',
cls:'x-form-item-label',
text:'Captions:',
flex:1
},
{
ref:'../captions',
xtype:'checkbox',
width:15,
listeners:{
check:function(checkbox,checked){
this.onEnableCaptions(checked)
},
scope:this
}
},
{
xtype:'spacer',
width:5,
height:5
},
{
xtype:'button',
ref:'../alignmentGear',
cls:'dropdown-gear',
disabled:!this.component.isCaptionEnabled(),
tooltip:'Settings',
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
handler:function(){
this.captionSettingsVisible(!this.props.alignmentGear.getEl().hasClass('active'))
},
scope:this
}
]
},
{
ref:'captionSettingsTopBorder',
layout:'hbox',
height:2,
cls:'dropdown-panel-top-border',
items:[
{
xtype:'container',
cls:'ddp-topborder',
width:242,
height:2
},
{
xtype:'container',
cls:'ddp-joiner',
width:25,
height:2
}
]
},
{
xtype:'container',
cls:'dropdown-panel',
layout:'vflex',
ref:'captionSettings',
items:[
{
xtype:'container',
layout:'hbox',
layoutConfig:{align:'middle'},
items:[
{
xtype:'label',
text:'Alignment:',
style:{paddingTop:'5px'},
flex:1
},
{
ref:'../../captionsAlignment',
xtype:'container',
cls:'web-panel-button-group-new',
width:105,
items:[
{
xtype:'button',
itemId:'left',
tooltip:'Align left.',
iconCls:'icon icon-rte-justifyleft',
scale:'small',
width:35,
enableToggle:true,
toggleGroup:'align',
toggleHandler:noNullToggle,
handler:this.onAlignCaptions,
scope:this
},
{
xtype:'button',
itemId:'center',
tooltip:'Align center.',
iconCls:'icon icon-rte-justifycenter',
scale:'small',
width:35,
enableToggle:true,
toggleGroup:'align',
toggleHandler:noNullToggle,
handler:this.onAlignCaptions,
scope:this
},
{
xtype:'button',
itemId:'right',
tooltip:'Align right.',
iconCls:'icon icon-rte-justifyright',
scale:'small',
width:35,
enableToggle:true,
toggleGroup:'align',
toggleHandler:noNullToggle,
handler:this.onAlignCaptions,
scope:this
}
]
}
]
},
{
xtype:'container',
layout:'hbox',
style:{paddingTop:'10px'},
layoutConfig:{align:'middle'},
items:[
{
xtype:'label',
text:'Placement:',
style:{paddingTop:'5px'},
flex:1
},
{
ref:'../../captionsPlacement',
xtype:'container',
cls:'web-panel-button-group-new',
width:150,
items:[this.placementCombo]
}
]
}
]
}
]
},
{
xtype:'container',
cls:'props-panel-bottom-container',
layout:'column',
items:[{
xtype:'web-props-mobile',
app:this.app,
cmp:this.component
}]
}
];
web.panels.props.ImageSlider.superclass.initComponent.apply(this,arguments);
this.delaySpinner.on('render',function(){
var that=this;
setTimeout(function(){
that.setWidth(59)
},100)
});
this.app.on('adjust',function(arg){
if(arg instanceof web.workspace.plugins.SelectImageSlider){
this.setDisabled()
}
},this)
},
initListeners:function(){
var app=this.app;
app.on('update',function(part){
if(part===this.imageSlider){
this.refresh()
}
},this)
},
sortImages:function(){
this.app.windows.show({
type:'web.windows.Sorting',
listeners:{
'ok':function(win,data){
this.updateComponent({slides:data.images})
},
'scope':this
},
values:this.imageSlider.getSlides()
})
},
onAlignCaptions:function(button){
if(this.imageSlider.getCaptionsAlignment()!==button.itemId){
this.updateComponent({captionsAlignment:button.itemId})
}
},
onSetCrop:function(crop){
this.updateComponent({crop:crop})
},
setComponent:function(imageSlider){
if(imageSlider instanceof web.data.components.ImageSlider){
this.imageSlider=imageSlider;
this.refresh()
}
},
updateComponent:function(cfg){
this.app.invoker.execute(new web.commands.components.UpdateImageSlider({
component:this.imageSlider,
json:cfg
}))
},
onEnableCaptions:function(caption){
this.props.alignmentGear.setDisabled(!caption);
this.updateComponent({captionsEnabled:caption})
},
refresh:function(){
var c=this.imageSlider;
this.imageCountBox.update(c.getSlides().length||'');
if(this.indicatorCombo.getValue()!==c.indicator){
this.indicatorCombo.setValue(c.indicator)
}
if(this.forwardBackCombo.getValue()!==c.navigator){
this.forwardBackCombo.setValue(c.navigator)
}
if(this.autoNextCombo.getValue()!==c.autoNext){
this.autoNextCombo.setValue(c.autoNext);
this.transitionSettingsVisible(this.autoNextCombo.getValue())
}
if(this.transitionCombo.getValue()!==c.transition){
this.transitionCombo.setValue(c.transition)
}
if(this.delaySpinner.getValue()!==c.delay){
this.delaySpinner.setValue(c.delay)
}
if(this.autoNextCombo.getValue()){
this.delaySpinner.enable()
}else{
this.delaySpinner.disable()
}
this.settingsCombo.suspendEvents();
this.settingsCombo.setValue(c.isLightboxEnabled()?'lightbox':c.isLinksEnabled()?'links':'noaction');
this.settingsCombo.resumeEvents();
this.props.captions.suspendEvents();
this.props.captions.setValue(c.isCaptionEnabled());
this.props.captions.resumeEvents();
this.props.captionsAlignment.setDisabled(!c.isCaptionEnabled());
this.props.captionsAlignment.find('itemId',c.getCaptionsAlignment())[0].toggle(true);
this.captionSettingsVisible(c.isCaptionEnabled());
if(this.placementCombo.getValue()!==c.getCaptionsPlacement()){
this.placementCombo.setValue(c.getCaptionsPlacement())
}
this.props.crop.suspendEvents();
this.props.crop.setValue(c.getCrop());
this.props.crop.resumeEvents()
},
onSelectAction:function(action){
var cfg={};
if(action==='lightbox'){
cfg.lightbox=true;
cfg.links=false
}else if(action==='links'){
cfg.lightbox=false;
cfg.links=true
}else{
cfg.lightbox=false;
cfg.links=false
}
this.app.invoker.execute(new web.commands.components.UpdateImageSlider({
component:this.imageSlider,
json:cfg
}))
},
transitionSettingsVisible:function(visible){
this.delaySpinner.suspendEvents();
if(visible){
this.autoNextGear.addClass('active');
this.transitionSettingsTopBorder.addClass('active');
this.transitionSettings.addClass('active')
}else{
this.autoNextGear.removeClass('active');
this.transitionSettingsTopBorder.removeClass('active');
this.transitionSettings.removeClass('active')
}
this.transitionSettingsTopBorder.doLayout();
this.transitionSettings.doLayout();
this.delaySpinner.resumeEvents()
},
captionSettingsVisible:function(visible){
if(visible){
this.props.alignmentGear.addClass('active');
this.props.captionSettingsTopBorder.addClass('active');
this.props.captionSettingsTopBorder.doLayout();
this.props.captionSettings.addClass('active')
}else{
this.props.alignmentGear.removeClass('active');
this.props.captionSettingsTopBorder.removeClass('active');
this.props.captionSettings.removeClass('active')
}
this.props.captionSettings.doLayout()
}
});
web.panels.props.ImageSlider.errorStrings={
tooManyFilesSingleSelect:[
'The Image Slider component only supports 100 images. Deselect other images before selecting new images.',
'You have reached maximum number of images'
],
tooManyFilesMultipleSelect:[
'All images were not selected. The Image Slider component only supports 100 images.',
'You have reached maximum number of images'
],
tooManyFilesHeaderSelect:[
'Image Slider doesn\'t support more than 100 images. Please select again.',
'You have reached maximum number of images'
]
};
web.commands.components.gallery.AddImages=Ext.extend(web.commands.Command,{
constructor:function(cfg){
this.executed=false;
this.gallery=null;
web.commands.components.gallery.AddImages.superclass.constructor.call(this,cfg)
},
execute:function(){
if(this.executed){
this.gallery.removeImages(this.images)
}else{
this.gallery.addImages(this.images)
}
this.executed=!this.executed;
this.fireEvent('update',this.gallery)
},
undo:function(){
this.execute()
}
});
web.commands.components.gallery.UseImages=Ext.extend(web.commands.Command,{
execute:function(){
this.prevState=this.gallery.getImages(true);
this.gallery.set({images:this.images});
this.fireEvent('update',this.gallery)
},
undo:function(){
this.images=this.prevState.slice();
this.execute()
}
});
web.commands.components.gallery.EditGalleryProperties=Ext.extend(web.commands.Command,{
execute:function(){
var gallery=this.gallery,images=gallery.getImages(true);
this.prevState={
scale:gallery.getScale(),
crop:gallery.getCrop(),
captionsEnabled:gallery.isCaptionEnabled(),
captionsAlignment:gallery.getCaptionsAlignment(),
lightbox:gallery.isLightboxEnabled(),
links:gallery.isLinksEnabled()
};
if(!(this.config.links||gallery.links)){
Ext.each(images,function(image,index){
image.action=null;
images[index]=image
});
this.config.images=images
}
gallery.set(this.config);
this.app.fireEvent('update',gallery)
},
undo:function(){
this.config=this.prevState;
this.execute()
}
});
web.ui.AutoScroll=Ext.extend(web.workspace.plugins.AutoScrollAbstract,{
constructor:function(config){
Ext.apply(this,config);
this.addEvents('start','end','mousemove');
web.ui.AutoScroll.superclass.constructor.call(this,config);
this.initListeners();
clearTimeout(this.animateTimer)
},
deactivate:function(){
clearTimeout(this.animateTimer)
},
getScrollEl:function(){
return this.el
},
getScrollViewEl:function(){
return this.el
},
start:function(){
this.fireEvent('start')
},
stop:function(){
this.fireEvent('end')
},
onMove:function(e,el){
this.fireEvent('mousemove',e,el)
},
initListeners:function(){
var isDown=false,onStart=function(){
isDown=true
},onMove=function(e,t){
if(isDown){
this.onMousemove(e,t,e.getXY())
}
},onStop=function(e,t){
setTimeout(function(){
isDown=false;
this.downSpeed=0;
this.rightSpeed=0
}.createDelegate(this),50)
};
this.on('start',onStart);
this.on('mousemove',onMove,this);
this.on('end',onStop,this)
}
});
web.workspace.plugins.SortDragDrop=Ext.extend(Ext.util.Observable,{
draggingState:null,
classForDragging:'classList'in document.documentElement?'dragging':'dragging ie9',
isDropped:false,
$widerElement:null,
draggable:'.draggable',
classForWiderLeft:'image-grid-sort__item_drag-wider',
classForWiderRight:'image-grid-sort__item_drag-wider-small',
isEdgeApplied:false,
unlockTimeout:null,
dragState:{},
spacerClassName:'image-grid-sort__spacer',
disableSpacer:false,
constructor:function(){
this.addEvents('dragstart','dragend','dragging')
},
initDragDropHandler:function(config){
var $window=oneJQuery(window),$container=config.container,itemHeight=$container.find(this.draggable+':eq(0)').outerHeight(),spacer=oneJQuery('<div class="'+this.spacerClassName+'"/>');
this.dragOverOutsideBound=this.onDragOverOutside.bind(this);
Ext.apply(this,config);
$container.on('dragstart',this.draggable,this.startDrag.bind(this));
$container.on('selectstart',this.draggable,this.fixIE9.bind(this));
$container.on('dragenter',this.draggable,this.onDragEnter.bind(this));
$container.on('dragleave',this.draggable,this.onDragLeave.bind(this));
$container.on('dragend',this.draggable,this.endDrag.bind(this));
$container.on('dragover',this.draggable,this.onDragOver.bind(this));
$container.on('dragover',this.dragOverOutsideBound);
$container.on('drop',this.onDropToEdge.bind(this));
$container.on('drop','.'+this.spacerClassName,this.onDropToEdge.bind(this));
$window.on('dragover',this.dragOverOutsideBound);
$container.on('drop',this.draggable,this.onDropCallback.bind(this));
this.elemsPerRow=this.getElementsInRow();
if(!this.disableSpacer){
spacer.height(itemHeight);
$container.append(spacer)
}
},
removeDragDropHandler:function(){
oneJQuery(window).off('dragover',this.dragOverOutsideBound);
this.container.off('mouseenter mouseleave dragstart selectstart dragenter dragleave dragend dragover drop')
},
getElementsInRow:function(){
return Math.floor(this.container.width()/this.container.find(this.draggable+':eq(0)').width())
},
startDrag:function(e){
var el=e.currentTarget,$elem=oneJQuery(el),$container=this.container,dataTransfer=e.originalEvent.dataTransfer,positionInRow=this.getPositionInRow($elem),isEdge=this.isEdgePosition(positionInRow,false);
this.isDropped=false;
if(window.requestAnimationFrame){
window.requestAnimationFrame(function(){
$elem.addClass(this.classForDragging);
if(isEdge){
this.$widerElement.addClass(this.classForWiderRight)
}
$container.children().addClass('animation')
}.bind(this))
}else{
$elem.addClass(this.classForDragging);
$container.children().addClass('animation')
}
if(isEdge){
this.$widerElement=$elem.prev();
this.isEdgeApplied=true
}else{
this.$widerElement=$elem.next();
this.$widerElement.addClass(this.classForWiderLeft);
this.isEdgeApplied=false
}
this.draggingState={
el:$elem,
i:$container.find(this.draggable).index($elem)
};
try{
dataTransfer.setData('text/html',el.outerHTML)
}catch(er){
dataTransfer.setData('text',el.outerHTML)
}
dataTransfer.effectAllowed='move';
this.fireEvent('dragstart')
},
fixIE9:function(e){
if(this.dragDrop){
this.dragDrop()
}
e.preventDefault()
},
endDrag:function(e){
if(!this.isDropped){
this.restoreImages()
}
e.preventDefault();
e.stopPropagation();
this.fireEvent('dragend')
},
isWider:function($elem){
if(!$elem){
return false
}
return $elem.hasClass(this.classForWiderLeft)||$elem.hasClass(this.classForWiderRight)
},
isSameRow:function($elem){
if(!this.$widerElement.length){
return true
}
var topEl=$elem[0].getBoundingClientRect().top,topWider=this.$widerElement[0].getBoundingClientRect().top;
return this.sameRowDecision(topEl,topWider)
},
isToBelowRow:function($elem){
if(!this.$widerElement.length){
return false
}
var topEl=$elem[0].getBoundingClientRect().top,topWider=this.$widerElement[0].getBoundingClientRect().top;
return topEl>topWider
},
sameRowDecision:function(topEl,topWider){
return Math.abs(topEl-topWider)<50
},
getPositionInRow:function($elem){
var prevElems=$elem.prevAll(this.draggable+':not(.dragging)');
return(prevElems.length+1)%this.elemsPerRow||this.elemsPerRow
},
isEdgePosition:function(positionInRow,isSameRow,isToBelowRow){
if(isSameRow){
return positionInRow>=this.elemsPerRow-1
}else{
if(isToBelowRow){
return false
}
return positionInRow>=this.elemsPerRow
}
},
getPositionOnElement:function($elem,offsetX,isEdge,isWider){
var el=$elem[0],width=el.offsetWidth,halfWidth=width/2;
if(!isEdge){
if(!isWider){
return offsetX>halfWidth?1:0
}else{
return offsetX>width*3/4?1:0
}
}
if(isEdge){
if(!isWider){
return offsetX>halfWidth?1:0
}else{
if(this.isEdgeApplied){
return offsetX>width/4?1:0
}else{
return offsetX>width*3/4?1:0
}
}
}
},
getWiderElement:function($elem,isEdge,positionInRow,positionOnElement){
if(isEdge){
if(positionInRow>=this.elemsPerRow){
return $elem.prev()
}else{
return $elem
}
}
if(!isEdge){
if(positionOnElement===1){
return $elem.next()
}else{
if(positionInRow===6){
return $elem.next()
}
return $elem
}
}
},
getClassName:function(isEdge,positionOnElement,isSameRow){
if(!isEdge){
return this.classForWiderLeft
}
if(!isSameRow){
return this.classForWiderRight
}
if(positionOnElement===1){
return this.classForWiderRight
}
return this.classForWiderLeft
},
applyToWider:function(wider,className){
wider.removeClass(this.classForWiderRight).removeClass(this.classForWiderLeft);
wider.addClass(className);
this.isEdgeApplied=false;
this.$widerElement=wider;
if(className===this.classForWiderRight){
this.isEdgeApplied=true
}
},
lockAnimation:function(){
this._isAnimationLocked=true
},
isAnimationLocked:function(){
return this._isAnimationLocked
},
unlockAnimation:function(){
this._isAnimationLocked=false
},
onDragOver:function(e){
if(!this.draggingState){
return
}
var el=e.currentTarget,$elem=oneJQuery(el),offsetX=this.getOffsetX(e),isWider,wider,isSameRow=this.isSameRow($elem),positionInRow,isEdge,positionOnElement,isToBelowRow,className;
if(!$elem.hasClass('dragging')){
positionInRow=this.getPositionInRow($elem);
isToBelowRow=this.isToBelowRow($elem);
isEdge=this.isEdgePosition(positionInRow,isSameRow,isToBelowRow);
isWider=this.isWider($elem);
positionOnElement=this.getPositionOnElement($elem,offsetX,isEdge,isWider);
className=this.getClassName(isEdge,positionOnElement,isSameRow);
this.restoreWiderElement();
wider=this.getWiderElement($elem,isEdge,positionInRow,positionOnElement);
this.applyToWider(wider,className);
this.lockAnimation();
clearTimeout(this.unlockTimeout);
this.unlockTimeout=setTimeout(this.unlockAnimation.bind(this),300);
Ext.apply(this.dragState,{
isSameRow:isSameRow,
positionInRow:positionInRow,
isWider:isWider,
isEdge:isEdge,
positionOnElement:positionOnElement,
className:className
})
}
e.originalEvent.dataTransfer.dropEffect='move';
e.preventDefault();
e.stopPropagation();
this.fireEvent('dragging',e,el)
},
getOffsetX:function(e){
var el=e.currentTarget,eve=e.originalEvent,offsetX=eve.offsetX||eve.layerX;
return el===e.target||this.isEdgeApplied?offsetX:offsetX+el.offsetWidth-e.target.offsetWidth
},
onDragOverOutside:function(e){
if(this.draggingState){
this.restoreWiderElement();
e.originalEvent.dataTransfer.dropEffect='move';
e.preventDefault();
e.stopPropagation()
}
},
restoreWiderElement:function(){
if(this.isWider(this.$widerElement)){
this.$widerElement.removeClass(this.classForWiderLeft).removeClass(this.classForWiderRight)
}
},
onDragEnter:function(e){
e.preventDefault();
e.stopPropagation()
},
onDragLeave:function(e){
e.preventDefault();
e.stopPropagation()
},
restoreImages:function(){
if(window.requestAnimationFrame){
window.requestAnimationFrame(function(){
this.restoreDraggedImage()
}.bind(this))
}else{
this.restoreDraggedImage()
}
this.container.children().removeClass('animation')
},
restoreDraggedImage:function(){
this.draggingState.el.removeClass(this.classForDragging);
this.restoreWiderElement();
this.draggingState=null
},
onDropCallback:function(e){
if(!this.draggingState){
return
}
var target=e.currentTarget,offsetX=this.getOffsetX(e),positionOnElement=this.getPositionOnElement(oneJQuery(target),offsetX,this.dragState.isEdge,this.dragState.isWider),parent=target.parentNode,targetInd=Array.prototype.indexOf.call(parent.children,target);
this.isDropped=true;
if(this.draggingState.i<targetInd){
targetInd-=1
}
if(positionOnElement){
targetInd+=1
}
if(this.onDrop){
this.onDrop(this.draggingState.i,targetInd)
}
this.restoreImages();
e.preventDefault();
e.stopPropagation()
},
onDropToEdge:function(e){
if(!this.draggingState){
return
}
var list=this.container.find(this.draggable),eve=e.originalEvent,offsetY=this.container[0].scrollTop+(eve.offsetY||eve.layerY),lastIndex=list.length-1,first=list.eq(0),last=list.eq(lastIndex),to=null;
this.isDropped=true;
if(offsetY<first[0].offsetTop){
to=0
}else if(offsetY>last[0].offsetTop||oneJQuery(eve.target).is('.'+this.spacerClassName)){
to=lastIndex+1
}
if(this.onDrop){
this.onDrop(this.draggingState.i,to)
}
this.restoreImages();
e.stopPropagation()
}
});
web.ui.ImageGridPanel=Ext.extend(Ext.Container,{
xtype:'web-imagegridpanel',
cls:'image-grid-sort__container',
sortable:true,
images:[],
imageWidth:160,
imageHeight:160,
selectedItemClass:'image-grid-sort__item_state-selected',
itemsContainerClass:'image-grid-sort',
itemClass:'image-grid-sort__item',
itemEditClass:'image-grid-sort__item-edit-image',
itemDeleteClass:'image-grid-sort__item-delete-image',
itemsContainer:undefined,
panelTemplate:new Ext.Template('<div class="image-grid-sort">'+'{images}</div>',{compiled:true}),
imageTemplate:new Ext.Template('<div data-assetId="{assetId}" class="image-grid-sort__item draggable{selected}" draggable="true">'+'<div class="image-grid-sort__item-wrapper" style="background-image: url(&quot;{url}&quot;)">'+'<span class="image-grid-sort__item-index">{index}</span>'+'<div class="image-grid-sort__item-overlay show-on-item-hover"></div>'+'<div class="image-grid-sort__item-filename show-on-item-hover">{filename}</div>'+'<div class="image-grid-sort__item-edit-image show-on-item-hover"><span>'+'Edit'+'</span></div>'+'<div class="image-grid-sort__item-delete-image show-on-item-hover"></div>'+'</div>'+'</div>',{compiled:true}),
initComponent:function(){
this.listeners={
'afterrender':function(){
this.renderPanel();
if(this.sortable){
this.ddPlugin=new web.workspace.plugins.SortDragDrop;
this.ddPlugin.on('dragstart',function(){
this.asPlugin.start()
}.bind(this));
this.ddPlugin.on('dragend',function(){
this.asPlugin.stop()
}.bind(this));
this.ddPlugin.on('dragging',function(e,el){
e.getXY=function(){
return[
this.originalEvent.pageX,
this.originalEvent.pageY
]
};
this.asPlugin.onMove(e,el)
}.bind(this));
this.asPlugin=new web.ui.AutoScroll({
el:new Ext.Element(this.itemsContainer[0]),
acceleration:0.8
})
}
},
scope:this
};
web.ui.ImageGridPanel.superclass.initComponent.apply(this,arguments)
},
initListeners:function(){
this.itemsContainer.on('mousedown','.draggable',function(e){
this.itemsContainer.find('.draggable').removeClass(this.selectedItemClass);
oneJQuery(e.target).parents('.'+this.itemClass).addClass(this.selectedItemClass)
}.bind(this));
this.itemsContainer.on('click',function(e){
var target=oneJQuery(e.target);
var eventToFire='';
if(target.hasClass(this.itemEditClass)||oneJQuery(target.parent()).hasClass(this.itemEditClass)){
eventToFire='editimage';
target=target.hasClass(this.itemEditClass)?target:oneJQuery(target.parent())
}else if(target.hasClass(this.itemDeleteClass)){
eventToFire='deleteimage'
}
if(eventToFire){
this.deactivate();
var itemIdx=this.getItemIndex(target);
if(itemIdx>0){
this.fireEvent(eventToFire,e,itemIdx-1)
}
}
}.bind(this))
},
getItemIndex:function(ele){
return parseInt(ele.parent().find('.image-grid-sort__item-index').html())
},
removeListeners:function(){
this.itemsContainer.off('mousedown');
this.itemsContainer.off('click')
},
setImages:function(images){
this.images=images
},
adaptToImages:function(currentImages,imagesToMerge,changedAssetIdx){
var initialAssetUrls=Ext.pluck(Ext.pluck(currentImages,'asset'),'url');
return imagesToMerge.reduce(function(newImages,image,index){
var currentImageIndex=initialAssetUrls.indexOf(image.asset.url);
if(currentImageIndex>=0){
newImages.push(currentImages[currentImageIndex])
}else if(changedAssetIdx>=0&&changedAssetIdx===index){
image.caption=currentImages[changedAssetIdx].caption;
newImages.push(image)
}else{
newImages.push(image)
}
return newImages
},[])
},
createImagesFromAssets:function(assets){
return assets.map(function(asset){
return{
asset:asset,
filename:''
}
})
},
setIndexesToImages:function(images){
images.forEach(function(image,index){
image.index=index;
image.caption=image.caption||''
});
return images
},
getAssets:function(){
var assets=[];
this.itemsContainer.find('.'+this.itemClass).each(function(index,dom){
assets.push(this.app.dm.get(dom.getAttribute('data-assetId')))
}.bind(this));
return assets
},
getImages:function(){
return this.adaptToImages(this.images,this.createImagesFromAssets(this.getAssets()))
},
useImages:function(images){
this.setImages(this.setIndexesToImages(images));
this.initialize()
},
updateImages:function(images,changedAssetIdx){
this.images=this.setIndexesToImages(this.adaptToImages(this.images,images,changedAssetIdx));
this.initialize()
},
updateImagesByAssets:function(assets,changedAssetIdx){
var images=this.createImagesFromAssets(assets);
this.updateImages(images,changedAssetIdx)
},
setSelected:function(idx){
var items=this.itemsContainer.find('.'+this.itemClass);
if(items[idx]){
var item=oneJQuery(items[idx]);
item.addClass(this.selectedItemClass);
if(idx>9){
this.itemsContainer.animate({scrollTop:item.offset().top},1000)
}
}
},
initialize:function(){
this.renderImages();
this.initListeners();
if(this.sortable){
this.ddPlugin.initDragDropHandler({
container:this.itemsContainer,
onDrop:this.onDrop.bind(this)
});
this.asPlugin.animate()
}
},
onDrop:function(dragIndex,dropIndex){
var $items=this.itemsContainer.find('.draggable');
if(dragIndex===dropIndex){
return
}
if(dragIndex>dropIndex){
$items.eq(dropIndex).before($items.eq(dragIndex))
}else{
dropIndex=$items.eq(dropIndex).length?dropIndex:dropIndex-1;
if(dropIndex===dragIndex){
return
}
$items.eq(dropIndex).after($items.eq(dragIndex))
}
this.itemsContainer.find('.image-grid-sort__item-index').each(function(index,dom){
dom.innerHTML=index+1
})
},
renderPanel:function(){
this.panelTemplate.overwrite(this.el,{images:''});
this.itemsContainer=oneJQuery(this.el.dom).find('.'+this.itemsContainerClass)
},
renderImages:function(templateProps){
var imagesString,props=templateProps||{};
if(!this.images){
this.itemsContainer.html('');
return
}
imagesString=this.images.reduce(function(imagesString,image,index){
var filename=image.asset.getFilename();
var params=[];
var path=image.asset.getRelativeUrl('/api/v1/'+this.app.workspace.app.dal.domain);
var resize='resize='+this.imageWidth+','+this.imageHeight;
params.push(resize,'crop=center');
path+='?'+params.join('&');
var data=Ext.apply(Object.create(props),{
url:path,
index:image.index>=0?image.index+1:'',
assetId:image.asset.id,
filename:filename&&filename.length>49?filename.substring(0,49)+'...':filename,
selected:props.selected===index?' '+this.selectedItemClass:''
});
return imagesString+this.imageTemplate.apply(data)
}.bind(this),'');
this.itemsContainer.html(imagesString)
},
initPaper:function(){
this.paper=new Raphael(this.el.dom);
Ext.apply(this.paper.canvas.style,{
pointerEvents:'none',
position:'absolute',
zIndex:'1001',
left:'0px',
top:'0px'
});
this.paper.setSize(this.itemsContainer.width(),this.itemsContainer.innerHeight())
},
deactivate:function(){
this.removeListeners();
if(this.sortable){
this.ddPlugin.removeDragDropHandler();
this.asPlugin.deactivate()
}
}
});
Ext.reg(web.ui.ImageGridPanel.prototype.xtype,web.ui.ImageGridPanel);
web.windows.Sorting=Ext.extend(web.windows.Window,{
images:[],
initComponent:function(){
this.type='web.windows.Sorting';
this.width=900;
this.modal=true;
this.resizable=false;
this.cls='w-sorting web-window-notitle';
this.items=[
{
xtype:'container',
cls:'hbox cross-center',
height:60,
items:[
{
xtype:'label',
cls:'tab-h1',
text:'Change images'
},
{
xtype:'spacer',
cls:'flex'
},
{
xtype:'button',
cls:'x-btn-secondary wide',
text:'Add images',
listeners:{
click:function(){
var currentAssets=this.sortpanel.getAssets();
this.hide();
this.app.windows.show({
type:'web.windows.Image',
listeners:{
'ok':function(win,selection){
var assets;
win.hide();
this.show(true);
assets=currentAssets.concat(selection.images);
this.sortpanel.updateImagesByAssets(assets);
this.setValues(this.sortpanel.images);
this.sortpanel.setSelected(assets.length-1)
},
'cancel':function(win){
this.show()
},
scope:this
},
values:{
multiSelect:true,
paths:[],
maxFiles:web.data.components.Gallery.MAX_IMAGES,
errorStrings:web.panels.props.Gallery.errorStrings
}
})
},
scope:this
}
},
{
xtype:'spacer',
width:28
}
]
},
{
xtype:'container',
cls:'subtitle',
html:'Drag to change the order. Click to edit images.'
},
{
app:this.app,
xtype:'web-imagegridpanel',
cls:'flex image-grid-sort__container',
height:396,
ref:'sortpanel',
listeners:{
editimage:this.editImage,
deleteimage:this.deleteImage,
scope:this
}
},
{
xtype:'container',
cls:'web-window-footer hbox cross-center',
items:[
{
xtype:'spacer',
cls:'flex'
},
{
xtype:'button',
cls:'x-btn-secondary large wide',
text:'Cancel',
listeners:{
click:function(){
this.onCancel()
},
scope:this
}
},
{
xtype:'spacer',
width:14
},
{
xtype:'button',
cls:'x-btn-primary large wide',
text:'Save',
ref:'../saveImageButton',
disabled:false,
listeners:{
scope:this,
click:function(){
this.hide();
this.fireEvent('ok',this,{images:this.sortpanel.getImages()})
}
}
}
]
}
];
web.windows.Sorting.superclass.initComponent.apply(this,arguments)
},
setValues:function(images){
this.images=images
},
show:function(comeBack){
web.windows.Sorting.superclass.show.apply(this,arguments);
if(!comeBack){
this.sortpanel.useImages(this.images);
this.app.track([
'Sorting',
'window.open'
])
}
},
hide:function(win){
this.sortpanel.deactivate();
web.windows.Sorting.superclass.hide.apply(this,arguments);
this.app.track([
'Sorting',
'window.close'
])
},
onCancel:function(){
this.hide();
this.fireEvent('cancel',this)
},
editImage:function(e,assetIdx){
this.hide();
var assets=this.sortpanel.getAssets();
this.app.windows.show({
type:'web.windows.AviaryImageEditor',
app:this.app,
listeners:{
imagesaved:function(asset){
assets[assetIdx]=asset;
this.sortpanel.updateImagesByAssets(assets,assetIdx);
this.setValues(this.sortpanel.images)
},
cancel:function(){
this.show()
},
close:function(){
this.show(true);
this.sortpanel.setSelected(assetIdx)
},
scope:this
},
values:{asset:assets[assetIdx]},
scope:this
})
},
deleteImage:function(e,assetIdx){
var assets=this.sortpanel.getAssets();
assets.splice(assetIdx,1);
this.sortpanel.updateImagesByAssets(assets);
this.setValues(this.sortpanel.images)
}
});
web.panels.props.Gallery=Ext.extend(web.panels.Panel,{
cls:'web-props-panel web-panels-props-gallery',
initComponent:function(){
var noNullToggle=function(button,state){
if(state){
button.disable()
}else{
button.enable()
}
};
this.settingsCombo=new web.ui.ComboBox({
name:'settings',
mode:'local',
triggerAction:'all',
forceSelection:true,
editable:false,
store:new Ext.data.ArrayStore({
fields:[
'id',
'text'
],
data:[
[
'noaction',
'Do nothing'
],
[
'lightbox',
'Show large images'
],
[
'links',
'Open links'
]
]
}),
valueField:'id',
displayField:'text',
width:150,
listeners:{
scope:this,
render:function(combo){
combo.tip=new Ext.ToolTip({
target:combo.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:'Select what should happen when clicking an image in the Gallery.'
},
constrainPosition:true
})
},
select:function(combo){
this.onSelectAction(combo.value)
}
}
});
this.cls='vbox';
this.items=[
{
ref:'props',
layout:'form',
style:{
padding:'20px',
overflow:'auto'
},
cls:'flex',
items:[
{
xtype:'container',
cls:'x-form-item',
height:25,
layout:'hflex',
items:[
{
xtype:'label',
cls:'x-form-item-label',
text:'Images:',
flex:1
},
{
xtype:'container',
ref:'../imageCountBox',
style:{paddingRight:'10px'}
},
{
xtype:'button',
scale:'small',
text:'Change images',
style:'margin-right:5px;',
width:'60px',
handler:this.sortImages,
scope:this
}
]
},
{
xtype:'container',
layout:'hflex',
style:'padding: 1px 0 12px',
items:[
{
xtype:'container',
html:'Thumbnail size',
flex:1
},
{
ref:'../scale',
xtype:'sliderfield',
width:144,
validationDelay:500,
useTips:false,
listeners:{
valid:function(slider){
this.onAdjustThumbnailSize(slider.getValue())
},
scope:this
}
}
]
},
{
xtype:'container',
layout:'hflex',
style:{padding:'3px 0 14px 0'},
items:[
{
xtype:'container',
flex:1,
html:'Crop thumbnails'
},
{
ref:'../crop',
xtype:'checkbox',
width:15,
listeners:{
check:function(checkbox,checked){
this.onSetCrop(checked)
},
scope:this
}
}
]
},
{
xtype:'container',
layout:'hflex',
style:{paddingBottom:'10px'},
items:[
{
xtype:'label',
text:'On click:',
flex:1
},
this.settingsCombo
]
},
{
xtype:'container',
height:25,
layout:'hflex',
items:[
{
xtype:'label',
cls:'x-form-item-label',
text:'Captions:',
flex:1
},
{
ref:'../captions',
xtype:'checkbox',
width:15,
listeners:{
check:function(checkbox,checked){
this.onEnableCaptions(checked)
},
scope:this
}
},
{
xtype:'spacer',
width:5,
height:5
},
{
xtype:'button',
ref:'../alignmentGear',
cls:'dropdown-gear',
tooltip:'Settings',
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
handler:function(){
this.captionSettingsVisible(!this.props.alignmentGear.getEl().hasClass('active'))
},
scope:this
}
]
},
{
xtype:'container',
cls:'x-form-item dropdown-panel-top-border',
ref:'captionSettingsTopBorder',
height:2,
layout:'hbox',
style:'margin: 0',
items:[
{
xtype:'container',
cls:'ddp-topborder',
width:250,
height:2
},
{
xtype:'container',
cls:'ddp-joiner',
width:25,
height:2
}
]
},
{
xtype:'container',
cls:'x-form-item dropdown-panel',
ref:'captionSettings',
height:48,
layout:'vbox',
layoutConfig:{align:'stretch'},
items:[{
xtype:'container',
layout:'hbox',
layoutConfig:{align:'middle'},
items:[
{
xtype:'label',
text:'Alignment:',
flex:1
},
{
ref:'../../captionsAlignment',
xtype:'container',
cls:'web-panel-button-group-new',
width:105,
items:[
{
xtype:'button',
itemId:'left',
tooltip:'Align left.',
iconCls:'icon icon-rte-justifyleft',
scale:'small',
width:35,
enableToggle:true,
toggleGroup:'align',
toggleHandler:noNullToggle,
handler:this.onAlignCaptions,
scope:this
},
{
xtype:'button',
itemId:'center',
tooltip:'Align center.',
iconCls:'icon icon-rte-justifycenter',
scale:'small',
width:35,
enableToggle:true,
toggleGroup:'align',
toggleHandler:noNullToggle,
handler:this.onAlignCaptions,
scope:this
},
{
xtype:'button',
itemId:'right',
tooltip:'Align right.',
iconCls:'icon icon-rte-justifyright',
scale:'small',
width:35,
enableToggle:true,
toggleGroup:'align',
toggleHandler:noNullToggle,
handler:this.onAlignCaptions,
scope:this
}
]
}
]
}]
}
]
},
{
xtype:'container',
cls:'props-panel-bottom-container',
layout:'column',
items:[{
xtype:'web-props-mobile',
app:this.app,
cmp:this.component
}]
}
];
web.panels.props.Gallery.superclass.initComponent.call(this)
},
setComponent:function(component){
this.gallery=component;
this.refresh()
},
refresh:function(){
var props=this.props;
props.imageCountBox.update(this.gallery.images.length||'');
props.scale.suspendEvents();
props.scale.setValue((this.gallery.getScale()-0.1)/0.009,false);
props.scale.resumeEvents();
props.crop.suspendEvents();
props.crop.setValue(this.gallery.getCrop());
props.crop.resumeEvents();
props.captions.suspendEvents();
props.captions.setValue(this.gallery.isCaptionEnabled());
props.captions.resumeEvents();
props.captionsAlignment.setDisabled(!this.gallery.isCaptionEnabled());
props.captionsAlignment.find('itemId',this.gallery.getCaptionsAlignment())[0].toggle(true);
this.settingsCombo.suspendEvents();
this.settingsCombo.setValue(this.gallery.isLightboxEnabled()?'lightbox':this.gallery.isLinksEnabled()?'links':'noaction');
this.settingsCombo.resumeEvents();
this.captionSettingsVisible(this.gallery.isCaptionEnabled())
},
sortImages:function(){
this.app.windows.show({
type:'web.windows.Sorting',
listeners:{
'ok':function(win,data){
this.app.invoker.execute(new web.commands.components.gallery.UseImages({
gallery:this.gallery,
images:data.images
}))
},
'scope':this
},
values:this.gallery.getImages(true)
})
},
onAdjustThumbnailSize:function(scale){
scale=0.009*scale+0.1;
this.app.invoker.execute(new web.commands.components.gallery.EditGalleryProperties({
gallery:this.gallery,
config:{scale:scale}
}))
},
onSetCrop:function(crop){
this.app.invoker.execute(new web.commands.components.gallery.EditGalleryProperties({
gallery:this.gallery,
config:{crop:crop}
}))
},
onSelectAction:function(action){
var cfg={};
if(action==='lightbox'){
cfg.lightbox=true;
cfg.links=false
}else if(action==='links'){
cfg.lightbox=false;
cfg.links=true
}else{
cfg.lightbox=false;
cfg.links=false
}
this.app.invoker.execute(new web.commands.components.gallery.EditGalleryProperties({
gallery:this.gallery,
config:cfg
}))
},
onEnableCaptions:function(caption){
this.app.invoker.execute(new web.commands.components.gallery.EditGalleryProperties({
gallery:this.gallery,
config:{captionsEnabled:caption}
}))
},
onAlignCaptions:function(button){
if(this.gallery.getCaptionsAlignment()!==button.itemId){
this.app.invoker.execute(new web.commands.components.gallery.EditGalleryProperties({
gallery:this.gallery,
config:{captionsAlignment:button.itemId}
}))
}
},
captionSettingsVisible:function(visible){
if(visible){
this.props.alignmentGear.addClass('active');
this.props.captionSettingsTopBorder.addClass('active');
this.props.captionSettings.addClass('active')
}else{
this.props.alignmentGear.removeClass('active');
this.props.captionSettingsTopBorder.removeClass('active');
this.props.captionSettings.removeClass('active')
}
this.props.captionSettings.doLayout()
}
});
web.panels.props.Gallery.errorStrings={
tooManyFilesSingleSelect:[
'The Gallery component only supports 100 images. Deselect other images before selecting new images.',
'You have reached maximum number of images'
],
tooManyFilesMultipleSelect:[
'All images were not selected. The Gallery component only supports 100 images.',
'You have reached maximum number of images'
],
tooManyFilesHeaderSelect:[
'Gallery doesn\'t support more than 100 images. Please select again.',
'You have reached maximum number of images'
]
};
web.panels.props.MultiSelect=Ext.extend(web.panels.Panel,{
initComponent:function(){
this.layout='border';
this.cls='web-props-panel';
this.items=[{
region:'center',
xtype:'container',
layout:'vbox',
layoutConfig:{align:'stretch'},
defaults:{margins:'0 0 20px 0'},
style:{padding:'15px 20px 20px 20px'},
flex:true,
items:[{
xtype:'label',
text:'You have selected more than one component. Properties can only be changed for one component at a time.'
}]
}];
web.panels.props.MultiSelect.superclass.initComponent.apply(this,arguments)
},
refresh:function(){
}
});
web.commands.components.SetContactForm=Ext.extend(web.commands.Command,{
execute:function(){
var component=this.component,opts=this.opts;
this.prevState=component.toJSON();
component.set(opts);
this.fireEvent('update',this.component)
},
undo:function(){
var tmp=this.component.toJSON();
this.component.set(this.prevState);
this.fireEvent('update',this.component);
this.prevState=tmp
}
});
web.commands.contactForm.ChangeStyleForm=Ext.extend(web.commands.Command,{
execute:function(){
this.prevState=this.style.parent.toJSON();
this.style.set(this.config);
this.fireEvent('update',this.style)
},
undo:function(){
var currentState=this.style.parent.toJSON();
this.style.parent.set(this.prevState);
this.prevState=currentState;
this.fireEvent('update',this.style)
}
});
Ext.ns('web.ui.contactForm');
web.ui.contactForm.FormElementPanel=Ext.extend(Ext.Container,{
constructor:function(cfg){
var sp10={
xtype:'spacer',
width:10,
height:10
};
this.width='auto';
this.height='auto';
this.formElement=cfg.formElement;
delete cfg.width;
delete cfg.height;
this.app=cfg.app;
this.pageId=this.app.getSelected('page').getId();
this.cls='form-element-edit-panel';
this.items=[
{
xtype:'container',
cls:'text-color-panel-header hbox cross-center',
style:{
position:'relative',
'min-width':'267px',
marginTop:'10px'
},
items:[
{
xtype:'label',
ref:'../headerLabel',
name:'headerLabel',
cls:'flex',
style:'display:block',
text:'Properties for selected field:'
},
{
xtype:'button',
cls:'custom-color-panel-gear-btn',
tooltip:'Edit properties for the selected field',
ref:'../settingsGearBtn',
style:'border-left-width:1px;position:relative',
enableToggle:true,
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
listeners:{
click:this.toggleFormElementsPropertiesPanel,
scope:this
}
}
]
},
{
xtype:'spacer',
ref:'panelBodyPatch',
cls:'custom-panel-patch-holder',
height:'2px',
html:'<div class="custom-panel-body-patch"></div>'
},
{
xtype:'container',
ref:'textColorPanelBody',
layout:'auto',
cls:'custom-color-panel-body',
items:[{
xtype:'container',
ref:'../fieldsSettingsPanelBody',
layout:'auto',
style:{'padding':'5px 5px 5px 0px'},
items:[
{
layout:'hauto',
style:{'padding':'15px 0px 5px 10px'},
items:[
{
xtype:'displayfield',
value:'Title:',
cls:'form-element-label'
},
{
xtype:'textfield',
ref:'../../../formElementName',
width:120,
enableKeyEvents:true,
listeners:{
valid:function(field){
var currentValue=field.getValue();
field.beforeValue=field.value?field.value:'';
if(currentValue.match(/(<([^>]+)>)/gi)===null&&field.beforeValue!==currentValue&&currentValue!==''&&field.beforeValue!==undefined){
this.updateComponent({name:currentValue});
field.beforeValue=currentValue
}else{
field.markInvalid()
}
},
scope:this
}
},
{
xtype:'container',
ref:'../../../multipleOptions',
cls:'multipleOptions',
layout:'auto',
hidden:true,
items:[
{
xtype:'container',
layout:'hauto',
items:[
{
xtype:'label',
text:'Options:'+' ',
style:{
padding:'5px 5px 5px 0px',
display:'inline-block'
}
},
{
xtype:'label',
ref:'../../../../../multipleOptionsWarning',
hidden:true,
text:'You cannot have less than 2 options.',
style:{
padding:'5px 5px 5px 0px',
color:'red'
}
}
]
},
{
xtype:'spacer',
height:'1',
width:'250',
style:{
background:'#D5D6D7',
margin:'0 0 10px 0'
}
},
{
xtype:'container',
layout:'auto',
ref:'../../../../multipleInputsContainer',
style:{padding:'0 0 0 10px'},
items:[]
},
sp10,
{
xtype:'button',
text:'Add option',
style:{marginLeft:'120px'},
listeners:{
click:this._addItem,
scope:this
}
}
]
}
]
},
sp10,
{
xtype:'container',
layout:'auto',
items:[{
layout:'vflex',
style:{padding:'0 0 10px 10px'},
items:[
{
layout:'hauto',
items:[
{
xtype:'label',
text:'Required',
style:{'padding-right':'5px'}
},
{
xtype:'checkbox',
ref:'../../../../../formElementRequired',
cls:'form-element-required-checkbox ',
listeners:{
afterRender:function(checkbox){
},
check:function(checkbox,checked){
this.updateComponent({isRequired:checked})
},
scope:this
}
}
]
},
{
xtype:'displayfield',
value:'Error message shown when the input field is empty:',
width:270,
style:{
fontSize:'11px',
lineHeight:'20px',
color:'#8e8f90'
}
},
{
xtype:'textarea',
ref:'../../../../formElementErrorMessage',
emptyText:'Please enter a valid message:',
width:240,
enableKeyEvents:true,
listeners:{
valid:function(field){
var currentValue=field.getValue();
field.beforeValue=field.value?field.value:'';
if(field.beforeValue!==currentValue&&currentValue!==''&&field.beforeValue!==undefined){
this.updateComponent({errorMessage:currentValue});
field.beforeValue=currentValue
}
},
scope:this
}
}
]
}]
}
]
}]
}
];
web.ui.contactForm.FormElementPanel.superclass.constructor.call(this,cfg)
},
setValue:function(value){
var multipleInputValues=[];
if(value){
multipleInputValues=value.values;
if(this.formElement!==value.formElement&&!multipleInputValues){
this.formElement=value.formElement;
this.multipleOptions.hide()
}
if(this.formElementName.getValue()!==value.name){
this.formElementName.suspendEvents();
this.formElementName.setValue(value.name);
this.formElementName.resumeEvents()
}
this.formElementRequired.suspendEvents();
this.formElementRequired.setValue(value.isRequired);
this.formElementRequired.resumeEvents();
this.formElementErrorMessage.suspendEvents();
this.formElementErrorMessage.setValue(value.errorMessage);
this.formElementErrorMessage.resumeEvents();
this.doLayout()
}
if(multipleInputValues){
var pageId=this.app.getSelected('page').getId();
this.formElement=this.pageId===pageId?this.formElement:null;
this.pageId=pageId;
if(multipleInputValues.length>0&&this.formElement!==value.formElement){
this.formElement=value.formElement;
this.multipleOptions.show();
this.multipleInputsContainer.removeAll();
multipleInputValues.forEach(function(itemName,index){
this.multipleInputsContainer.add({
xtype:'container',
layout:'hauto',
style:{'padding':'0px 0px 10px 0px'},
cls:'multiple-input-option-container',
items:[
new Ext.form.TextField({
cls:'multiple-input-option',
width:120,
enableKeyEvents:true,
value:itemName,
validator:function(value){
if(value.trim()===''){
return false
}
},
listeners:{
focus:function(field){
field.beforeValue=field.getValue()
},
keyup:this.updateOption,
scope:this
}
}),
new Ext.Button({
tooltip:'Remove option',
cls:'props-panel-remove-button',
listeners:{
click:this._removeOption,
scope:this
}
})
]
})
}.bind(this));
this.multipleOptionsWarning.hide();
this.doLayout()
}
}
this.textColorPanelBody.setHeight(this.fieldsSettingsPanelBody.getHeight()+24)
},
updateOption:function(field){
var currentValue=field.getValue();
if(field.beforeValue!==currentValue&&field.beforeValue!==undefined&&currentValue.trim()!==''){
this._editOption(field);
field.beforeValue=currentValue
}
},
_addItem:function(){
var component=this.app.workspace.getSelected()[0],activeElement=component?component.getSelectedFormElement():null,data=component?component.getFormElementByName(activeElement):null,optionsLength=data?data.values.length:null,lastOptionName=optionsLength?data.values[optionsLength-1]:null,newOptionName;
if(lastOptionName){
newOptionName=this._getNextDynamicOptionName(lastOptionName);
this._addItemToMultipleInputsContainer(newOptionName);
this._hideMultipleOptionsWarning();
this._updateComponentAfterItemInsert(data,newOptionName)
}
},
_getNextDynamicOptionName:function(optionName){
var newOptionName,optionNameLastCharacter=parseInt(optionName[optionName.length-1],10),optionNameLastButOneCharacter=parseInt(optionName[optionName.length-2],10),isOptionNameLastCharacterIsNumber=!isNaN(optionNameLastCharacter),isOptionNameLastButOneCharacterIsNumber=!isNaN(optionNameLastButOneCharacter);
if(isOptionNameLastCharacterIsNumber&&isOptionNameLastButOneCharacterIsNumber){
newOptionName=optionName.substr(0,optionName.length-2)+(parseInt(optionName.slice(-2),10)+1)
}else if(isOptionNameLastCharacterIsNumber&&!isOptionNameLastButOneCharacterIsNumber){
newOptionName=optionName.substr(0,optionName.length-1)+(parseInt(optionName.slice(-1),10)+1)
}else{
newOptionName=optionName+2
}
return newOptionName
},
_addItemToMultipleInputsContainer:function(newOptionName){
this.multipleInputsContainer.add({
xtype:'container',
layout:'hauto',
style:{'padding':'0px 0px 10px 0px'},
cls:'multiple-input-option-container',
items:[
new Ext.form.TextField({
cls:'multiple-input-option',
width:120,
value:newOptionName,
enableKeyEvents:true,
validator:function(value){
if(value.trim()===''){
return false
}
},
listeners:{
focus:function(field){
field.beforeValue=field.getValue()
},
keyup:this.updateOption,
scope:this
}
}),
new Ext.Button({
tooltip:'Remove option',
cls:'props-panel-remove-button',
listeners:{
click:this._removeOption,
scope:this
}
})
]
})
},
_hideMultipleOptionsWarning:function(){
this.multipleOptionsWarning.hide()
},
_updateComponentAfterItemInsert:function(data,newOptionName){
data.values.push(newOptionName);
this.updateComponent({values:data.values})
},
_removeOption:function(button,event){
var component=this.app.workspace.getSelected()[0],name=component?component.getSelectedFormElement():null,data=component?component.getFormElementByName(name):null,optionsArray,index=oneJQuery(button.el.dom.parentElement).index(),numOfOptions=Ext.get(this.getId()).select('.multiple-input-option').elements.length;
event.stopEvent();
optionsArray=data?data.values.slice(0):null;
if(index!==-1){
if(data.inputType==='checkbox'){
if(numOfOptions>1){
optionsArray.splice(index,1);
this.updateComponent({values:optionsArray});
this.multipleOptionsWarning.hide();
this.multipleInputsContainer.remove(button.el.findParent('.multiple-input-option-container').id)
}else{
this.multipleOptionsWarning.suspendEvents();
this.multipleOptionsWarning.setText('You cannot have less than 1 option.');
this.multipleOptionsWarning.resumeEvents();
this.multipleOptionsWarning.show()
}
}else{
if(numOfOptions>2){
optionsArray.splice(index,1);
this.updateComponent({values:optionsArray});
this.multipleOptionsWarning.hide();
this.multipleInputsContainer.remove(button.el.findParent('.multiple-input-option-container').id)
}else{
this.multipleOptionsWarning.suspendEvents();
this.multipleOptionsWarning.setText('You cannot have less than 2 options.');
this.multipleOptionsWarning.resumeEvents();
this.multipleOptionsWarning.show()
}
}
}
},
_editOption:function(field){
var component=this.app.workspace.getSelected()[0],name=component?component.getSelectedFormElement():null,data=component?component.getFormElementByName(name):null,optionsArray=data?data.values.slice(0):null,index=oneJQuery(field.el.dom.parentElement).index(),value=field.getValue();
if(field.beforeValue!==value&&optionsArray&&index!==-1){
optionsArray.splice(index,1,value);
this.updateComponent({values:optionsArray});
field.beforeEnter=value
}
},
updateComponent:function(value){
var component=this.app.workspace.getSelected()[0],selectedFormElement=component?component.getSelectedFormElement():null,options={activeElement:selectedFormElement},formElements={};
formElements[selectedFormElement]=value;
Ext.apply(options,{formElements:formElements});
this.fireEvent('change',options)
},
toggleFormElementsPropertiesPanel:function(event){
if(!event){
this.settingsGearBtn.suspendEvents();
this.settingsGearBtn.toggle();
this.settingsGearBtn.resumeEvents()
}else if(this.settingsGearBtn.el.dom!==event.el.dom){
this.settingsGearBtn.suspendEvents();
this.settingsGearBtn.toggle();
this.settingsGearBtn.resumeEvents()
}
this.doLayout();
var that=this,textColorPanelBodyEl=that.textColorPanelBody.getEl(),panelBodyPatchEl=that.panelBodyPatch.getEl(),step1=function(){
panelBodyPatchEl.toggleClass('custom-panel-patch-holder-visible')
},step2=function(){
textColorPanelBodyEl.toggleClass('custom-panel-isExpanded form-element-properties-panel-visible')
};
if(!textColorPanelBodyEl.hasClass('custom-panel-isExpanded')){
that.textColorPanelBody.setHeight(that.fieldsSettingsPanelBody.getHeight()+24);
step1();
step2()
}else{
that.textColorPanelBody.setHeight(0);
step2();
setTimeout(function(){
step1()
},200)
}
},
expandPanel:function(){
var textColorPanelBody=this.textColorPanelBody.getEl();
if(textColorPanelBody){
if(!textColorPanelBody.hasClass('custom-panel-isExpanded')){
this.toggleFormElementsPropertiesPanel()
}
}
},
collapsePanel:function(){
var textColorPanelBody=this.textColorPanelBody.getEl();
if(textColorPanelBody){
if(textColorPanelBody.hasClass('custom-panel-isExpanded')){
this.toggleFormElementsPropertiesPanel()
}
}
}
});
Ext.ComponentMgr.registerType('web-formElementPanel',web.ui.contactForm.FormElementPanel);
web.ui.fields.ButtonStyleSelector=Ext.extend(Ext.Container,{
initComponent:function(){
this.ButtonStyleRecord=Ext.data.Record.create([
'id',
'name'
]);
this.buttonStyles=new Ext.data.ArrayStore({});
this.combo=new web.ui.ComboBox({
flex:true,
xtype:'combo',
triggerAction:'all',
mode:'local',
editable:false,
forceSelection:true,
value:this.selectedButtonStyleId,
store:this.buttonStyles,
valueField:'id',
displayField:'name',
listeners:{
select:function(combo,record,index){
this.selectedButtonStyleId=record.get('id');
this.fireEvent('change',this.selectedButtonStyleId)
},
render:function(combo){
if(this.tooltip){
combo.tip=new Ext.ToolTip({
target:combo.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:this.tooltip
}
})
}
},
scope:this
}
});
this.selectedButtonStyleId=this.component.getGlobalStyleId();
this.layout='hbox';
this.items=[
this.combo,
{
xtype:'button',
tooltip:'Edit button styles',
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;border-left:none\'>',
handler:function(){
this.showGlobalStyles()
},
scope:this
}
];
this.addEvents('change');
this.initListeners();
web.ui.fields.ButtonStyleSelector.superclass.initComponent.apply(this,arguments)
},
setValue:function(id){
var style=this.app.dm.get(id),store=this.combo.getStore(),firstRecord=store.getAt(0);
if(style&&style.ref){
this.selectedButtonStyleId=id;
this.updateButtonStyles();
this.combo.setValue('Button Style '+style.ref.split('.')[1])
}else{
this.combo.setValue(firstRecord.get('name'));
this.selectedButtonStyleId=firstRecord.get('id')
}
},
initListeners:function(){
this.on('afterrender',function(){
this.updateButtonStyles()
},this);
this.app.on('update',function(part){
if(part instanceof web.data.styles.Stylesheet){
this.updateButtonStyles();
this.combo.setValue(this.selectedButtonStyleId)
}
},this)
},
updateButtonStyles:function(){
var buttonStyles=this.app.getSelected('stylesheet').getStylesByType('web.data.styles.StyleButton'),ButtonStyleRecord=this.ButtonStyleRecord;
this.buttonStyles.removeAll();
buttonStyles.forEach(function(style,i){
if(style.ref){
this.buttonStyles.add(new ButtonStyleRecord({
id:style.id,
name:'Button Style '+style.ref.split('.')[1]
}))
}
},this)
},
showGlobalStyles:function(){
this.app.windows.show({
type:'web.windows.GlobalStyles',
values:{
activeItem:5,
style:this.app.dm.get(this.selectedButtonStyleId)
}
})
}
});
Ext.reg('web-ui-fields-buttonstyleselector',web.ui.fields.ButtonStyleSelector);
web.windows.contactForm.ContactFormFields=Ext.extend(web.windows.Window,{
xtype:'web-windows-contact-form-fields',
type:'web.windows.ContactFormFields',
cls:'web-windows-form-fields',
modal:true,
resizable:false,
multiSelect:false,
constructor:function(cfg){
this.selectedInputFieldproperties={};
web.windows.contactForm.ContactFormFields.superclass.constructor.call(this,cfg)
},
initComponent:function(){
var sp10={
xtype:'spacer',
width:10,
height:10
};
this.title='Add fields';
this.width=480;
this.items=[
{
xtype:'container',
layout:'hauto',
cls:'form-field-element',
items:[
{
xtype:'checkbox',
ref:'../formElementSubject',
inputFieldType:'subject',
width:30,
listeners:{
check:this.onCheckboxSelect,
scope:this
}
},
{
xtype:'label',
text:'Subject',
width:90
}
]
},
sp10,
{
xtype:'container',
layout:'hauto',
cls:'form-field-element',
items:[
{
xtype:'checkbox',
ref:'../formElementPhone',
inputFieldType:'phone',
width:30,
listeners:{
check:this.onCheckboxSelect,
scope:this
}
},
{
xtype:'label',
text:'Phone',
width:90
}
]
},
sp10,
{
xtype:'container',
layout:'hauto',
cls:'form-field-element',
items:[
{
xtype:'checkbox',
ref:'../formElementMessage',
inputFieldType:'message',
width:30,
listeners:{
check:this.onCheckboxSelect,
scope:this
}
},
{
xtype:'label',
text:'Message',
width:90
}
]
},
sp10,
{
xtype:'container',
layout:'hauto',
cls:'form-field-element',
items:[
{
xtype:'checkbox',
ref:'../formElementCompany',
inputFieldType:'company',
width:30,
listeners:{
check:this.onCheckboxSelect,
scope:this
}
},
{
xtype:'label',
text:'Company',
width:90
}
]
},
sp10,
{
xtype:'container',
layout:'hauto',
cls:'form-field-element',
items:[
{
xtype:'checkbox',
ref:'../formElementWebsite',
inputFieldType:'website',
width:30,
listeners:{
check:this.onCheckboxSelect,
scope:this
}
},
{
xtype:'label',
text:'Website',
width:90
}
]
},
sp10,
{
xtype:'container',
layout:'hauto',
cls:'form-field-element',
items:[
{
xtype:'checkbox',
ref:'../formElementText',
inputFieldType:'text',
width:30,
listeners:{
check:this.onCheckboxSelect,
scope:this
}
},
{
xtype:'label',
text:'Text',
width:90
}
]
},
sp10,
{
xtype:'container',
layout:'hauto',
cls:'form-field-element',
items:[
{
xtype:'checkbox',
ref:'../formElementNumber',
inputFieldType:'number',
width:30,
listeners:{
check:this.onCheckboxSelect,
scope:this
}
},
{
xtype:'label',
text:'Number',
width:90
}
]
},
sp10,
{
xtype:'container',
layout:'hauto',
cls:'form-field-element',
items:[
{
xtype:'checkbox',
ref:'../formElementCheckbox',
inputFieldType:'checkbox',
width:30,
listeners:{
check:this.onCheckboxSelect,
scope:this
}
},
{
xtype:'label',
text:'Checkboxes',
width:90
}
]
},
sp10,
{
xtype:'container',
layout:'hauto',
cls:'form-field-element',
items:[
{
xtype:'checkbox',
ref:'../formElementRadioBtn',
inputFieldType:'radio',
width:30,
listeners:{
check:this.onCheckboxSelect,
scope:this
}
},
{
xtype:'label',
text:'Radio buttons',
width:90
}
]
},
sp10,
{
xtype:'container',
layout:'hauto',
cls:'form-field-element',
items:[
{
xtype:'checkbox',
ref:'../formElementDropdown',
inputFieldType:'dropdown',
width:30,
listeners:{
check:this.onCheckboxSelect,
scope:this
}
},
{
xtype:'label',
text:'Dropdown',
width:90
}
]
},
sp10,
{
xtype:'container',
layout:'hauto',
cls:'form-field-element',
items:[
{
xtype:'checkbox',
ref:'../formElementEmail',
inputFieldType:'email',
width:30,
listeners:{
check:this.onCheckboxSelect,
scope:this
}
},
{
xtype:'label',
text:'Email',
width:90
}
]
}
];
this.buttons=[
{
text:'Cancel',
cls:'x-btn-secondary',
listeners:{
click:this.onCancel,
scope:this
}
},
{
ref:'../insertFieldButton',
text:'Insert fields',
cls:'x-btn-primary',
disabled:true,
listeners:{
click:this.onInsertFields,
scope:this
}
}
];
web.windows.contactForm.ContactFormFields.superclass.initComponent.apply(this,arguments)
},
onInsertFields:function(){
this.hide();
this.fireEvent('ok',this,{formElements:this.selectedInputFieldproperties})
},
onCheckboxSelect:function(checkbox,checked){
var options={},name=checkbox?checkbox.getEl().parent().next().dom.textContent:null,inputLabel,inputType=checkbox.inputFieldType,properties;
if(checked){
inputLabel=this.getFormElementsNameByType(inputType);
properties=this.getDefaultPropertiesByType(inputType);
Ext.apply(properties,{
name:name,
trackingName:inputLabel
});
this.insertFieldButton.enable();
options[inputLabel]=properties;
Ext.apply(this.selectedInputFieldproperties,options)
}else{
inputLabel=this.getFormElementsNameByType(inputType);
delete this.selectedInputFieldproperties[inputLabel];
if(Object.keys(this.selectedInputFieldproperties).length===0){
this.insertFieldButton.disable()
}
}
},
getFormElementsNameByType:function(type){
var formElementsOrder=this.component.getFormElementsOrder(),filteredSelectedInputFieldArray=[],selectedInputFieldArray=[];
if(formElementsOrder){
filteredSelectedInputFieldArray=formElementsOrder.filter(function(element){
return element.indexOf(type)!==-1
});
selectedInputFieldArray=filteredSelectedInputFieldArray.map(function(element){
var number=element.match(/\d+$/);
return number?parseInt(number.toString(),10):0
});
if(selectedInputFieldArray.length>=1){
return type+(Math.max.apply(Math,selectedInputFieldArray)+1)
}else{
return type+1
}
}else{
return null
}
},
getDefaultPropertiesByType:function(type){
var props={};
switch(type){
case'subject':
props={
name:'Subject',
inputType:'text',
errorMessage:'Please enter a valid subject'
};
break;
case'phone':
props={
name:'Phone',
inputType:'tel',
errorMessage:'Please enter a valid phone number'
};
break;
case'message':
props={
name:'Message',
inputType:'textarea',
errorMessage:'Please enter a valid message'
};
break;
case'company':
props={
name:'Company',
inputType:'text',
errorMessage:'Please enter a valid company name'
};
break;
case'website':
props={
name:'Website',
inputType:'url',
errorMessage:'Please enter a valid website'
};
break;
case'text':
props={
name:'Text',
inputType:'text',
errorMessage:'Please enter a valid text'
};
break;
case'number':
props={
name:'Number',
inputType:'number',
errorMessage:'Please enter a valid number'
};
break;
case'checkbox':
props={
name:'Checkbox',
values:[
'Option'+' 1',
'Option'+' 2',
'Option'+' 3'
],
inputType:'checkbox',
errorMessage:'Please select at least 1 option'
};
break;
case'dropdown':
props={
name:'Dropdown',
values:[
'Option'+' 1',
'Option'+' 2',
'Option'+' 3'
],
inputType:'dropdown',
errorMessage:'Please select an option'
};
break;
case'radio':
props={
name:'Radio',
values:[
'Option'+' 1',
'Option'+' 2'
],
inputType:'radio',
errorMessage:'Please select an option'
};
break;
case'email':
props={
name:'Email',
inputType:'email',
errorMessage:'Please enter a valid email address.'
};
break
}
return props
},
onCancel:function(){
this.hide();
this.fireEvent('cancel',this)
}
});
Ext.ComponentMgr.registerType('web-windows-contact-form-fields',web.windows.contactForm.ContactFormFields);
web.windows.contactForm.ContactFormEmailMissingWarning=Ext.extend(web.windows.Window,{
type:'web.windows.contactForm.ContactFormEmailMissingWarning',
modal:true,
resizable:false,
multiSelect:false,
cls:'web-modal-warning x-window-dlg',
iconCls:'web-warning-icon',
constructor:function(config){
this.recipientEmail=config.recipientEmail||null;
web.windows.contactForm.ContactFormEmailMissingWarning.superclass.constructor.call(this,config)
},
initComponent:function(){
this.title='Missing email';
this.width=500;
this.items=[{
xtype:'container',
layout:'auto',
items:[
{
xtype:'container',
layout:'hauto',
style:{'padding-bottom':'20px'},
items:[
{
xtype:'label',
text:'Email'
},
{
xtype:'label',
text:this.recipientEmail,
style:{
'font-weight':'bold',
'padding':' 0 5px'
}
},
{
xtype:'label',
text:' '+'could not be found on your web space account.'
}
]
},
{
xtype:'container',
layout:'auto',
items:[{
xtype:'label',
text:'This email has most likely been deleted. You can choose to delete the contact form on your page, and then insert it again or add another email.'
}]
}
]
}];
this.buttons=[{
text:'Create email account',
cls:'x-btn-primary',
listeners:{
click:function(btn,evt){
window.open('https://www.one.com/admin/overview.do','_blank')
},
scope:this
}
}];
web.windows.contactForm.ContactFormEmailMissingWarning.superclass.initComponent.apply(this,arguments)
}
});
Ext.ComponentMgr.registerType('web-windows-contactForm-emailMissingWarning',web.windows.contactForm.ContactFormEmailMissingWarning);
web.panels.props.ContactForm=Ext.extend(web.panels.Panel,{
initComponent:function(){
var app=this.app,domainEmailsStore=new Ext.data.ArrayStore({
fields:['email'],
idIndex:0
}),fonts,sizes,isLast=function(value){
return value===this.domainEmailList[this.domainEmailList.length-1][0]
}.bind(this);
this.formFiledsList=[
'name',
'email',
'message',
'company'
];
this.domainEmailList=[];
this.recipientEmailField=new web.ui.ComboBox({
tpl:'<tpl for="."><div class="x-combo-list-item">{email}</div></tpl>',
itemId:'email',
store:domainEmailsStore,
mode:'local',
valueField:'email',
displayField:'email',
triggerAction:'all',
editable:false,
listeners:{
select:function(combo){
if(isLast(combo.getValue())){
this.setRecipientEmailField(this.component.getRecipientEmail()||'Select email');
window.open('https://www.one.com/admin/overview.do','_blank');
if(!this.isRecipientEmailInDomainEmailList(this.domainEmailList)){
this.recipientEmailField.markInvalid()
}
}else{
this.updateComponent({recipientEmail:combo.getValue()})
}
},
keyup:function(combo){
},
blur:function(combo){
if(!this.isRecipientEmailInDomainEmailList(this.domainEmailList)){
this.recipientEmailField.markInvalid()
}
},
expand:function(){
if(this.app.inPageMode()){
this.recipientEmailField.innerList.update('<div class="loading-indicator">'+this.recipientEmailField.loadingText+'</div>');
this.app.dal.getEmailData(this.handleEmailData,this)
}
},
scope:this
}
});
sizes=[
9,
10,
11,
12,
13,
14,
15,
16,
18,
20,
22,
24,
26,
28,
32,
36,
40,
44,
48,
54,
60,
66,
72,
80,
88,
96
];
this.size=new web.ui.ComboBox({
itemId:'size',
store:sizes,
triggerAction:'all',
value:12,
width:43,
enableKeyEvents:true,
maxNumber:999,
minNumber:9,
listeners:{
render:function(combo){
combo.tip=new Ext.ToolTip({
target:combo.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:'Font size.'
}
})
},
keyup:function(combo,e){
if(e.getCharCode()===13){
var size=parseInt(combo.getRawValue(),10);
if(Ext.isNumber(size)&&size>0){
this.onSelectSize(combo)
}
}
},
select:this.onSelectSize,
scope:this
}
});
this.submitButtonFontSize=new web.ui.ComboBox({
itemId:'size',
store:sizes,
triggerAction:'all',
value:12,
width:50,
enableKeyEvents:true,
maxNumber:999,
minNumber:9,
listeners:{
render:function(combo){
combo.tip=new Ext.ToolTip({
target:combo.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:'Font size.'
}
})
},
keyup:function(combo,e){
if(e.getCharCode()===13){
var size=parseInt(combo.getRawValue(),10);
if(Ext.isNumber(size)&&size>0){
this.onSelectBtnTextSize(combo)
}
}
},
select:this.onSelectBtnTextSize,
scope:this
}
});
fonts=this.loadFontList();
this.font=new web.ui.ComboBox({
itemId:'font',
tpl:'<tpl for="."><div class="x-combo-list-item" '+'style="font-family:{css}!important;">{name}</div></tpl>',
store:new Ext.data.ArrayStore({
idIndex:0,
fields:[
'id',
'css',
'name'
],
data:fonts
}),
valueField:'id',
displayField:'name',
mode:'local',
triggerAction:'all',
editable:false,
value:0,
width:107,
resetStyle:function(){
var el=this.el,width,css='',selected;
selected=this.getValue();
if(typeof selected==='number'){
css=web.data.styles.Font.cssValues[selected]
}else if(/^google:\/\//.test(selected)){
css=selected.replace(/^google:\/\//,'');
if(el?/^google:\/\//.test(el.dom.value):false){
el.dom.value=css
}
}
if(el){
width=el.dom.style.width;
el.dom.setAttribute('style','font-family:'+css+'!important;');
el.dom.style.width=width
}
},
listeners:{
select:function(combo){
this.onFontSelect(combo);
combo.resetStyle()
},
render:function(combo){
combo.tip=new Ext.ToolTip({
target:combo.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:'Font family.'
}
});
combo.resetStyle()
},
scope:this
}
});
this.app.googleWebFonts.on('update',function(){
var fonts=this.loadFontList(),store=new Ext.data.ArrayStore({
idIndex:0,
fields:[
'id',
'css',
'name'
],
data:fonts
});
this.font.bindStore(store)
},this);
this.mon(this.app,'update',function(part){
if(part&&part.parent&&part.parent.type===this.component.type){
this.refresh()
}
},this);
this.fontFamily=new web.ui.textPanel.TextFontFamilyStylePanel({
app:app,
values:{
myOkHandler:function(selectedFont){
if(selectedFont!==null){
this.font.setValue(selectedFont);
this.onFontSelect(this.font);
this.refresh()
}
},
scope:this
}
});
this.addFont={
xtype:'button',
ref:'settingsGearBtn',
style:{position:'relative'},
cls:'custom-color-panel-gear-btn',
enableToggle:true,
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
tooltip:'Edit text color'+':',
listeners:{
click:function(event){
var parent=event.getEl().parent(),patchHolder=parent.next();
patchHolder.toggleClass('custom-panel-patch-holder-visible');
var container=patchHolder.next().dom;
container.style.height=(patchHolder.hasClass('custom-panel-patch-holder-visible')?container.firstChild.clientHeight:0)+'px';
patchHolder.next().toggleClass('custom-panel-isExpanded text-color-panel-visible');
parent.setStyle('margin-bottom',0);
if(parent.next('.custom-panel-patch-holder-visible')){
event.getEl().addClass('x-btn-pressed')
}
},
scope:this
}
};
this.sendButtonBackgroundColor=new web.ui.colorPanel.HighlightColorPanel({
app:this.app,
hidePreviewText:true,
label:'Button',
listeners:{
change:this.onFocusColorPick,
scope:this
}
});
this.cls='web-props-panel web-panels-props-contactForm';
this.width=315;
this.style={width:'100%'};
this.defaults={margins:'0 20px 0 0'};
this.items=[
{
xtype:'container',
cls:'hbox cross-center',
items:[
{
xtype:'container',
cls:'flex',
html:'Fields'+':'
},
{
xtype:'label',
ref:'../formFieldsCountBox',
cls:'fields-count flex'
},
{
xtype:'button',
tooltip:'Add fields',
iconCls:'icon icon-addField',
scale:'small',
width:28,
handler:function(){
this.app.windows.show({
type:'web.windows.contactForm.ContactFormFields',
app:this.app,
component:this.component,
persist:false,
enableCheckbox:true,
listeners:{
ok:function(win,properties){
this.updateComponent(properties)
},
scope:this
}
})
},
scope:this
}
]
},
{
xtype:'spacer',
height:10
},
{
xtype:'container',
cls:'hbox cross-center',
items:[{
xtype:'container',
cls:'flex',
html:'Send form to'+':'
}]
},
{
xtype:'spacer',
height:5
},
this.recipientEmailField,
{
xtype:'spacer',
height:15
},
{
xtype:'container',
cls:'flex',
html:'Button text'+':'
},
{
xtype:'spacer',
height:5
},
{
xtype:'container',
cls:'hbox cross-center button-font-size',
items:[
{
xtype:'textfield',
ref:'../submitBtnTextField',
enableKeyEvents:true,
autoCreate:{
tag:'input',
type:'text',
maxlength:60
},
width:230,
style:{padding:'2px 6px'},
listeners:{
focus:function(){
this._deactivateSelectedFormElement()
},
keyup:function(field){
var currentValue=field.getValue();
if(currentValue!==''){
this.updateComponent({submitBtn:currentValue})
}
},
scope:this
}
},
{
xtype:'spacer',
width:5
},
this.submitButtonFontSize
]
},
{
xtype:'spacer',
height:15
},
{
xtype:'label',
text:'Success message'+':'
},
{
xtype:'textarea',
ref:'successMessageTextField',
enableKeyEvents:true,
height:70,
style:{
'box-sizing':'border-box',
'margin':'4px 0 0',
'padding':'4px'
},
width:'100%',
listeners:{
focus:function(){
this._deactivateSelectedFormElement()
},
keyup:function(field){
var currentValue=field.getValue();
if(currentValue!==''){
this.updateComponent({successMessage:this.successMessageTextField.getValue()})
}
},
scope:this
}
},
{
xtype:'label',
style:{
fontSize:'11px',
lineHeight:'15px',
color:'#8e8f90'
},
text:'This message appears when the form is successfully sent.'
},
{
xtype:'spacer',
height:25
},
{
xtype:'label',
text:'Contact form style'+':'
},
{
xtype:'spacer',
height:10
},
{
xtype:'container',
cls:'hbox cross-center contact-form-prop-panel-font',
items:[
{
xtype:'container',
cls:'flex',
html:'Font'+':'
},
this.font,
this.addFont,
{
xtype:'spacer',
width:10
},
this.size
]
},
{
xtype:'spacer',
ref:'panelBodyPatch',
cls:'custom-panel-patch-holder',
height:'2px',
html:'<div class="custom-panel-body-patch" style="left:197px;width:23px"></div>'
},
{
xtype:'container',
ref:'textColorPanelBody',
style:'max-width: 273px',
layout:'auto',
ctCls:'custom-color-panel-fontFamily',
cls:'custom-color-panel-body',
items:this.fontFamily
},
{
xtype:'spacer',
height:15
},
{
xtype:'container',
layout:'form',
items:[{
ref:'../textColor',
xtype:'web-textcolorpanel',
cls:'contact-form-style-text-color',
listeners:{
change:this.onPick,
scope:this
}
}]
},
{
xtype:'spacer',
height:10
},
{
xtype:'container',
cls:'hbox cross-center',
items:[
{
xtype:'container',
cls:'flex',
html:'Button'+':'
},
{
xtype:'web-ui-fields-buttonstyleselector',
ref:'../buttonStyleSelector',
cls:'buttonStyleSelector',
width:185,
app:this.app,
component:this.component,
listeners:{
change:function(styleId){
var styleButton=Ext.apply({},this.component.getStyleButton());
styleButton.globalId=styleId;
this.updateComponent({styleButton:styleButton.toJSON()})
},
scope:this
}
}
]
},
{
xtype:'web-formElementPanel',
ref:'contactFormSelectedFormFieldPropertiesPanel',
hidden:true,
app:this.app,
listeners:{
change:this.updateComponent,
scope:this
}
},
{
xtype:'spacer',
height:10
}
];
web.panels.props.ContactForm.superclass.initComponent.apply(this,arguments)
},
initListeners:function(){
var app=this.app;
app.on('updateFieldProperties',function(part,index){
if(part===this.component){
this.updateFieldProperties(index)
}
},this)
},
afterRender:function(){
if(this.app.inPageMode()){
this.app.dal.getEmailData(this.handleEmailData,this)
}
web.panels.props.ContactForm.superclass.afterRender.call(this);
this.submitBtnTextField.on('afterrender',function(){
this.submitBtnTextField.el.on('mousedown',this._deactivateSelectedFormElement,this)
},this)
},
handleEmailData:function(opts,success,response){
var emailData=[],emailDataArray=[];
if(success){
emailData=JSON.parse(response.responseText).email||[]
}
emailData.push('<a href=\'javascript:void(0)\'>'+'Create email address'+'</a>');
emailDataArray=this.getDomainEmailsArray(emailData);
this.recipientEmailField.store.loadData(emailDataArray);
this.domainEmailList=emailDataArray;
this.setRecipientEmailField(this.component.getRecipientEmail()||'Select email');
if(!this.isRecipientEmailInDomainEmailList(emailDataArray)){
this.recipientEmailField.markInvalid();
if(!emailDataArray.length){
this.showMissingEmailWarningPopup()
}
this.recipientEmailField.setEditable(false?true:false)
}
},
showMissingEmailWarningPopup:function(){
this.app.windows.show({
type:'web.windows.contactForm.ContactFormEmailMissingWarning',
app:this.app,
recipientEmail:this.component.getRecipientEmail()
})
},
isRecipientEmailInDomainEmailList:function(domainEmailList){
var recipientEid=this.component.getRecipientEmail();
return domainEmailList.some(function(eId){
return recipientEid===eId[0]
})
},
setComponent:function(component){
if(component){
this.component=component;
this.refresh()
}
},
updateComponent:function(opts){
this.app.invoker.execute(new web.commands.components.SetContactForm({
component:this.component,
opts:opts
}))
},
updateFormElement:function(opts,formElement){
var options={};
options[formElement]=opts;
this.updateComponent({
activeElement:formElement,
formElements:options
})
},
loadFontList:function(){
var n,id,css,display,fonts=[],fontTypes=web.data.styles.Font.types;
for(n in fontTypes){
if(fontTypes.hasOwnProperty(n)){
id=fontTypes[n];
css=web.data.styles.Font.cssValues[id];
fonts.push([
id,
css.replace(/"/g,'\''),
web.data.styles.Font.displayNameByType[n]
])
}
}
if(this.app.site.fonts){
for(n in this.app.site.fonts){
if(this.app.site.fonts.hasOwnProperty(n)){
id=this.app.site.fonts[n];
display=id.replace(/^google:\/\//,'');
css='\''+display+'\', cursive';
fonts.push([
id,
css.replace(/"/g,'\''),
display
])
}
}
}
return fonts.sort(function(a,b){
if(a[2]>b[2]){
return 1
}
if(a[2]<b[2]){
return-1
}
return 0
})
},
onFontSelect:function(combo){
var style={};
style[combo.itemId]=combo.getValue();
this.updateStyle({font:combo.getValue()})
},
onPick:function(color){
this.updateStyle({fontColor:color})
},
onFocusColorPick:function(color){
if(color){
this.sendButtonBackgroundColor.showHighlightColorRemoveButton()
}else{
this.updateFormSendButtonBackgroundColor(null);
this.sendButtonBackgroundColor.hideHighlightColorRemoveButton()
}
this.updateStyle({highlight:color})
},
onSelectSize:function(combo){
this.updateStyle({fontSize:parseInt(combo.getRawValue(),10)})
},
onSelectBtnTextSize:function(combo){
var buttonInactive={text:Ext.apply({},this.component.getStyleButton().inactive.text)};
buttonInactive.text.size=parseInt(combo.getRawValue(),10);
this.updateButtonStyle({inactive:buttonInactive})
},
updateStyle:function(opts){
this.app.invoker.execute(new web.commands.contactForm.ChangeStyleForm({
style:this.component.styleForm,
config:opts
}))
},
updateButtonStyle:function(opts){
this.app.invoker.execute(new web.commands.contactForm.ChangeStyleForm({
style:this.component.styleButton,
config:opts
}))
},
_deactivateSelectedFormElement:function(){
var component=this.component,activeElement=component?component.getSelectedFormElement():null,activeElementDOM=Ext.select('.web-component-select .selected-contact-form-element-container').elements[0];
if(activeElement&&activeElementDOM){
component.activeElement=null;
Ext.get(activeElementDOM).removeClass('selected-contact-form-element-container');
this.hideContactFormSelectedFormFieldPropertiesPanel()
}
},
refresh:function(){
var component=this.component,defaultFormTextStyle=this.app.getSelected('stylesheet').getStyleByRef('normal','StyleText'),styleForm=component.getStyleForm()||null,styleButton=component.getStyleButton();
this.updateFormFieldsCountBox();
this.updateRecipientEmailField();
this.updateSubmitBtnTextField();
this.updateSuccessMessageTextField();
this.updateFormFontFamily(styleForm,defaultFormTextStyle);
this.updateFormFontSize(styleForm,defaultFormTextStyle);
this.updateSubmitButtonFontSize(styleButton,component.dm.get(styleButton.globalId));
this.updateFormTextColor(styleForm,defaultFormTextStyle);
this.updateSelectedFormFieldPropertiesPanel();
this.buttonStyleSelector.setValue(component.getGlobalStyleId())
},
updateFormFieldsCountBox:function(){
var contactFormElements=this.component.getFormElementsOrder()||null;
this.formFieldsCountBox.update(contactFormElements.length||'')
},
updateRecipientEmailField:function(){
var component=this.component,domainEmails=this.domainEmailList,recipientEmail=component?component.getRecipientEmail():domainEmails.length?domainEmails[0]:null;
if(this.isRecipientEmailInDomainEmailList(domainEmails)){
this.setRecipientEmailField(recipientEmail)
}else{
this.setRecipientEmailField(recipientEmail||'Select email');
this.recipientEmailField.markInvalid()
}
},
setRecipientEmailField:function(email){
this.recipientEmailField.suspendEvents();
this.recipientEmailField.setValue(email);
this.recipientEmailField.resumeEvents()
},
updateSubmitBtnTextField:function(){
var component=this.component,submitBtnTxtValue=component.getSubmitBtnText()||'Send';
if(this.submitBtnTextField.getValue()!==submitBtnTxtValue){
this.submitBtnTextField.suspendEvents();
this.submitBtnTextField.setValue(submitBtnTxtValue);
this.submitBtnTextField.resumeEvents()
}
},
updateSuccessMessageTextField:function(){
var component=this.component,successMessageValue=component.getSuccessMessage()||'Thank you for your message';
this.successMessageTextField.suspendEvents();
this.successMessageTextField.setValue(successMessageValue);
this.successMessageTextField.resumeEvents()
},
updateFormFontFamily:function(styleForm,defaultFormTextStyle){
var fontValue=styleForm.font?styleForm.font.getFontType():null;
if(fontValue===null){
fontValue=defaultFormTextStyle.getFont().getFontType()
}
this.font.suspendEvents();
this.font.setValue(fontValue);
this.font.resumeEvents();
this.font.resetStyle()
},
updateFormFontSize:function(styleForm,defaultFormTextStyle){
this.size.suspendEvents();
this.size.setValue(styleForm.fontSize||defaultFormTextStyle.getSize());
this.size.resumeEvents()
},
updateSubmitButtonFontSize:function(styleButton,defaultFormButtonStyle){
var size=styleButton.inactive.text.size?styleButton.inactive.text.size:defaultFormButtonStyle.inactive.text.size;
this.submitButtonFontSize.suspendEvents();
if(this.submitButtonFontSize.getValue()!==size){
this.submitButtonFontSize.setValue(size)
}
this.submitButtonFontSize.resumeEvents()
},
updateFormTextColor:function(styleForm,defaultFormTextStyle){
this.textColor.suspendEvents();
this.textColor.setColor(styleForm.fontColor||defaultFormTextStyle.getColor());
this.textColor.resumeEvents()
},
updateFormSendButtonBackgroundColor:function(backgroundColor){
var globalStyleForm=this.app.getSelected('stylesheet').getStyleByRef('form','StyleForm');
this.sendButtonBackgroundColor.suspendEvents();
this.sendButtonBackgroundColor.setColor(backgroundColor||globalStyleForm.getHighlight());
this.sendButtonBackgroundColor.resumeEvents();
this.updateFormSendButtonBackgroundColorRemoveBtnVisibility()
},
updateFormSendButtonBackgroundColorRemoveBtnVisibility:function(){
var component=this.component,styleForm=component.getStyleForm()||null;
if(this.isSendButtonBackgroundColorIsLocal(styleForm)){
this.sendButtonBackgroundColor.showHighlightColorRemoveButton()
}else{
this.sendButtonBackgroundColor.hideHighlightColorRemoveButton()
}
},
isSendButtonBackgroundColorIsLocal:function(styleForm){
return!!styleForm.getHighlight()
},
updateSelectedFormFieldPropertiesPanel:function(){
var selectedFormField=this.getSelectedFormField(),selectedFormFieldProperties=this.getSelectedFormFieldProperties();
if(this.app.workspace.isActive()&&selectedFormField){
this.showContactFormSelectedFormFieldPropertiesPanel(Ext.apply(selectedFormFieldProperties,{formElement:selectedFormField}))
}else{
this.hideContactFormSelectedFormFieldPropertiesPanel()
}
},
showContactFormSelectedFormFieldPropertiesPanel:function(formFieldProperties){
this.contactFormSelectedFormFieldPropertiesPanel.setValue(formFieldProperties);
this.contactFormSelectedFormFieldPropertiesPanel.show();
this.contactFormSelectedFormFieldPropertiesPanel.expandPanel()
},
hideContactFormSelectedFormFieldPropertiesPanel:function(){
this.contactFormSelectedFormFieldPropertiesPanel.hide();
this.contactFormSelectedFormFieldPropertiesPanel.collapsePanel()
},
getSelectedFormField:function(){
var component=this.component;
return component?component.getSelectedFormElement():null
},
getSelectedFormFieldProperties:function(){
var component=this.component,contactFormElements=component?component.getFormElementsOrder():null,selectedFormField=this.getSelectedFormField(),selectedElementIndex=selectedFormField?contactFormElements.indexOf(selectedFormField):0;
if(selectedElementIndex!==-1){
return component.getFormElementByIndex(selectedElementIndex)
}else{
return component.getFormElementByIndex(0)
}
},
updateFieldProperties:function(index){
var component=this.component,formField=component?component.getFormElementsOrder():null,formFieldProperties=formField?component.getFormElementByIndex(index):null;
Ext.apply(formFieldProperties,{formElement:formField[index]});
if(formFieldProperties){
this.showContactFormSelectedFormFieldPropertiesPanel(formFieldProperties)
}
},
getDomainEmailsArray:function(emailData){
return emailData.map(function(item){
return[item]
})
}
});
web.commands.components.UpdateWebShopProperties=Ext.extend(web.commands.Command,{
execute:function(){
var component=this.component,newState={};
this.prevState={
cropImages:component.cropImages,
imageRatio:component.imageRatio,
labelPosition:component.labelPosition,
productsPerPage:component.productsPerPage,
productsPerRow:component.productsPerRow,
showCategory:component.showCategory,
showWelcomeMessage:component.showWelcomeMessage,
sortProducts:component.sortProducts,
userCanSortProducts:component.userCanSortProducts
};
Object.keys(this.prevState).forEach(function(key){
if(key in this){
newState[key]=this[key]
}
},this);
component.set(newState);
this.fireEvent('update',component)
},
undo:function(){
var component=this.component,currentState={
cropImages:component.cropImages,
imageRatio:component.imageRatio,
labelPosition:component.labelPosition,
productsPerPage:component.productsPerPage,
productsPerRow:component.productsPerRow,
showCategory:component.showCategory,
showWelcomeMessage:component.showWelcomeMessage,
sortProducts:component.sortProducts,
userCanSortProducts:component.userCanSortProducts
};
component.set(this.prevState);
this.cropImages=this.prevState.cropImages;
this.imageRatio=this.prevState.imageRatio;
this.labelPosition=this.prevState.labelPosition;
this.productsPerPage=this.prevState.productsPerPage;
this.productsPerRow=this.prevState.productsPerRow;
this.showCategory=this.prevState.showCategory;
this.showWelcomeMessage=this.prevState.showWelcomeMessage;
this.sortProducts=this.prevState.sortProducts;
this.userCanSortProducts=this.prevState.userCanSortProducts;
this.prevState=currentState;
this.fireEvent('update',component)
}
});
web.commands.components.EditWebShopStyle=Ext.extend(web.commands.Command,{
execute:function(){
this.prevState=this.style.toJSON();
this.style.set(this.config);
this.fireEvent('update',this.style)
},
undo:function(){
var currentState=this.style.toJSON();
this.style.set(this.prevState);
this.prevState=currentState;
this.fireEvent('update',this.style)
}
});
web.ui.FontSelector=Ext.extend(Ext.Container,{
initComponent:function(config){
this.value=null;
this.cls='vbox web-ui-fontselector';
this.items=[
{
xtype:'container',
cls:'hbox',
width:this.width,
height:25,
items:[
{
ref:'../font',
cls:'flex',
xtype:'web-combobox-fonts',
width:this.width||100,
app:this.app,
listeners:{
select:function(combo,record,index){
this.onSelectFont(combo.getValue())
},
render:function(combo){
if(this.tooltip){
combo.tip=new Ext.ToolTip({
target:combo.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:this.tooltip
}
})
}
},
scope:this
}
},
{
ref:'../addFontButton',
xtype:'button',
cls:'custom-color-panel-gear-btn',
width:24,
text:'<img src="'+Ext.BLANK_IMAGE_URL+'" class="icon icon-gear">',
tooltip:'Add more fonts',
scale:'small',
handler:function(){
this.toggleGoogleWebFonts()
},
scope:this
}
]
},
{
ref:'panelBodyPatch',
xtype:'spacer',
cls:'custom-panel-patch-holder',
html:'<div class="custom-panel-body-patch"></div>'
},
{
ref:'webFontsContainer',
xtype:'container',
cls:'custom-color-panel-body',
width:265,
items:[{
ref:'../webFonts',
cls:'flex webfont-dropdown',
xtype:'web-textfontfamilystylepanel',
values:{
myOkHandler:function(selectedFont){
this.onSelectFont(selectedFont)
},
scope:this
},
app:this.app
}]
}
];
this.addEvents('selected');
web.ui.FontSelector.superclass.initComponent.call(this)
},
setValue:function(value){
this.value=value;
this.font.setValue(value)
},
onSelectFont:function(font){
this.setValue(font);
this.fireEvent('select',font)
},
toggleGoogleWebFonts:function(){
this.panelBodyPatch.getEl().toggleClass('custom-panel-patch-holder-visible');
var container=this.webFontsContainer.getEl().dom;
container.style.height=(this.panelBodyPatch.getEl().hasClass('custom-panel-patch-holder-visible')?container.firstChild.clientHeight:0)+'px';
this.webFontsContainer.getEl().toggleClass('custom-panel-isExpanded text-color-panel-visible')
}
});
Ext.reg('web-ui-fontselector',web.ui.FontSelector);
web.ui.colorPanel.NoLabelColorPanel=Ext.extend(web.ui.colorPanel.TextColorPanel,{
cls:'web-ui-colorpanel-nolabel',
constructor:function(cfg){
delete cfg.width;
delete cfg.height;
var previewTypeHtml;
this.width=275;
this.height='auto';
this.toggleHideClass='text-color-panel-visible';
this.tooltip=cfg.tooltip||'Edit text color';
this.initialStyle=null;
if(cfg.previewType==='background'){
this.previewType=cfg.previewType;
previewTypeHtml='<div style="width:100%;height:100%;filter:none;"></div>'
}else if(cfg.previewType==='border'){
this.previewType=cfg.previewType;
previewTypeHtml='<div style="height:3px;position:absolute;top:10px;left:5px;right:5px;background:none;filter:none;box-shadow:none"></div>'
}else{
this.previewType='text';
previewTypeHtml='<div style="background:none;box-shadow:none">Abc</div>'
}
this.layout={type:'auto'};
this.headerCheckboxVisible=false;
this.items=[
{
xtype:'container',
cls:'text-color-panel-header',
layout:'hflex',
layoutConfig:{align:'middle'},
style:{
position:'relative',
'min-width':'267px'
},
items:[
{
ref:'../headerLabel',
name:'headerLabel',
xtype:'label',
text:cfg.label
},
{
xtype:'container',
layout:'hflex',
cls:'web-panel-button-group-new',
items:[
{
xtype:'button',
ref:'../../placeholder',
cls:'panel-text-preview',
style:{paddingLeft:'10px'},
html:previewTypeHtml,
listeners:{
click:this.toggleTextColorPanel,
scope:this
}
},
{
xtype:'button',
ref:'../../settingsGearBtn',
style:{position:'relative'},
cls:'custom-color-panel-gear-btn color-chooser-panel',
enableToggle:true,
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
listeners:{
click:this.toggleTextColorPanel,
scope:this
}
}
],
listeners:{
render:function(btnGroup){
btnGroup.tip=new Ext.ToolTip({
target:btnGroup.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:this.tooltip
}
})
},
scope:this
}
}
]
},
{
xtype:'spacer',
ref:'panelBodyPatch',
cls:'custom-panel-patch-holder',
height:'2px',
html:'<div class="custom-panel-body-patch"></div>'
},
{
xtype:'container',
ref:'textColorPanelBody',
layout:'auto',
cls:'custom-color-panel-body',
items:{
xtype:'web-colorpanel',
ref:'../colorPanel',
enablePanel:true,
showTransparency:cfg.showTransparency,
listeners:{
change:this.onColorChange,
scope:this
}
}
}
];
web.ui.colorPanel.TextColorPanel.superclass.constructor.call(this,cfg)
},
setHeaderTextColor:function(textColor){
if(this.placeholder.el){
if(this.previewType==='text'){
this.placeholder.el.dom.style.color=one.color(textColor).cssa()
}else{
this.placeholder.el.child('div').setStyle('background-color',one.color(textColor).cssa())
}
}
}
});
Ext.ComponentMgr.registerType('web-ui-colorpanel-nolabel',web.ui.colorPanel.NoLabelColorPanel);
web.panels.props.WebShop=Ext.extend(web.panels.Panel,{
cls:'web-props-panel web-props-panels-webshop',
initComponent:function(){
var addTipCb=function(tip){
this.tip=new Ext.ToolTip({
target:this.getEl().parent(),
bodyCfg:{
cls:'x-tip-body',
html:tip
}
})
};
this.layout='form';
this.labelWidth=100;
this.hexaBtnMap={
'#ffffff':'whiteBtn',
'#e4e5e7':'greyBtn',
'#26000000':'greyBtn',
'#bbbbbb':'greyBtn',
'#000000':'blackBtn'
};
this.mon(this.app,'update',function(part){
if(part&&part.parent&&part.parent.type===this.component.type){
this.refresh()
}
},this);
this.defaults={width:275};
this.items=[
{
ref:'font',
xtype:'web-ui-fontselector',
tooltip:'Choose a font for your shop',
fieldLabel:'Font',
width:169,
listeners:{
select:function(font){
this.updateStyle('font',font)
},
scope:this
},
app:this.app
},
{
ref:'fontColor',
xtype:'web-ui-colorpanel-nolabel',
label:'Text color:',
tooltip:'Edit color of texts, except prices',
previewType:'text',
listeners:{
change:function(value){
this.updateStyle('fontColor',value)
},
scope:this
}
},
{
ref:'focusColor',
xtype:'web-ui-colorpanel-nolabel',
label:'Accent color:',
tooltip:'Edit color of prices and cart',
previewType:'background',
listeners:{
change:function(value){
this.updateStyle('focusColor',value)
},
scope:this
}
},
{
ref:'hoverColor',
xtype:'web-ui-colorpanel-nolabel',
label:'Image hover color:',
tooltip:'Edit hover color for product images',
previewType:'background',
showTransparency:true,
listeners:{
change:function(value){
this.updateStyle('hoverColor',value)
},
scope:this
}
},
{
ref:'buttonStyleSelector',
xtype:'web-ui-fields-buttonstyleselector',
cls:'buttonStyleSelector',
width:170,
fieldLabel:'Button',
tooltip:'Choose a style for buttons inside your shop',
app:this.app,
component:this.component,
listeners:{
change:function(value){
this.updateStyle('buttonId',value)
},
scope:this
}
},
{
fieldLabel:'Image style:',
labelSeparator:'',
width:170,
ref:'imageRatio',
xtype:'web-combobox',
mode:'local',
triggerAction:'all',
editable:false,
store:new Ext.data.ArrayStore({
fields:[
'value',
'text'
],
data:[
[
'square',
'Square'
],
[
'landscape',
'Landscape'
],
[
'portrait',
'Portrait'
],
[
'actual',
'Actual ratio'
]
]
}),
valueField:'value',
displayField:'text',
value:'square',
listeners:{
select:function(combo,record){
var value=record.get('value');
this.updateProperties('imageRatio',record.get('value'));
if(value==='actual'){
this.cropImages.disable()
}else{
this.cropImages.enable()
}
},
scope:this
}
},
{
width:275,
layout:'hflex',
cls:'x-form-item',
items:[
{
xtype:'label',
text:'Crop images:',
flex:1,
listeners:{
render:function(cmp){
addTipCb.call(cmp,'When enabled, your images will be cropped to have the same ratio.')
}
}
},
{
ref:'../cropImages',
xtype:'checkbox',
width:50,
listeners:{
check:function(checkbox,value){
this.updateProperties('cropImages',value)
},
scope:this
}
}
]
},
{
width:275,
layout:'hflex',
cls:'x-form-item',
items:[
{
xtype:'label',
text:'Products per row:',
flex:1,
listeners:{
render:function(cmp){
addTipCb.call(cmp,'Choose how many products you want to show in each row of your Webshop.')
}
}
},
{
ref:'../productsPerRow',
xtype:'web-combobox',
mode:'local',
width:50,
triggerAction:'all',
editable:false,
store:new Ext.data.ArrayStore({
fields:['value'],
data:[
[2],
[3],
[4],
[5],
[6],
[7],
[8]
]
}),
valueField:'value',
displayField:'value',
value:4,
listeners:{
select:function(combo,record){
this.updateProperties('productsPerRow',record.get('value'))
},
scope:this
}
}
]
},
{
width:275,
layout:'hflex',
cls:'x-form-item',
items:[
{
xtype:'label',
text:'Products per page:',
width:225,
listeners:{
render:function(cmp){
addTipCb.call(cmp,'Number of products before "Show more" is shown.')
}
}
},
{
ref:'../productsPerPage',
xtype:'numberfield',
width:50,
style:'text-align: right',
minValue:2,
maxValue:100,
value:24,
listeners:{
change:function(cmp,value){
if(value>=2&&value<=100){
this.updateProperties('productsPerPage',value)
}
},
scope:this
}
}
]
},
{
fieldLabel:'Sort by:',
labelSeparator:'',
ref:'sortProducts',
xtype:'web-combobox',
width:170,
mode:'local',
triggerAction:'all',
editable:false,
store:new Ext.data.ArrayStore({
fields:[
'value',
'text'
],
data:[
[
'name-ascending',
'Alphabetical'
],
[
'age-ascending',
'Newest'
],
[
'price-ascending',
'Price: Low to high'
],
[
'price-descending',
'Price: High to low'
],
[
'most-popular',
'Most popular'
]
]
}),
valueField:'value',
displayField:'text',
value:'name-ascending',
listeners:{
select:function(combo,record){
this.updateProperties('sortProducts',record.get('value'))
},
scope:this
}
},
{
layout:'hflex',
width:275,
height:25,
items:[
{
xtype:'label',
cls:'x-form-item-label',
text:'Navigation:',
flex:1
},
{
xtype:'spacer',
width:5,
height:5
},
{
xtype:'button',
ref:'../alignmentGear',
cls:'dropdown-gear',
tooltip:'Settings',
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'position: relative; top: 1px; width: 15px; height: 15px;\'>',
handler:function(){
this.categorySettingsVisible(!this.alignmentGear.getEl().hasClass('active'))
},
scope:this
}
]
},
{
ref:'categorySettingsTopBorder',
xtype:'spacer',
cls:'custom-panel-patch-holder',
height:'2px',
html:'<div class="custom-panel-body-patch"></div>'
},
{
cls:'dropdown-panel navigation',
width:273,
ref:'categorySettings',
defaults:{
layout:'hflex',
style:{
'margin-bottom':'10px',
'padding-top':'10px'
}
},
items:[
{
items:[
{
xtype:'label',
text:'Show category selector:',
width:200
},
{
ref:'../showCategory',
xtype:'checkbox',
listeners:{
check:function(checkbox,checked){
this.updateProperties('showCategory',checked)
},
render:function(checkbox){
addTipCb.call(checkbox,'Allow customers to switch between product categories')
},
scope:this
}
}
]
},
{
items:[
{
xtype:'label',
text:'Show "sort by" selector:',
width:200
},
{
ref:'../userCanSortProducts',
xtype:'checkbox',
listeners:{
check:function(checkbox,checked){
this.updateProperties('userCanSortProducts',checked)
},
scope:this
}
}
]
},
{
items:[
{
xtype:'label',
text:'Background color:',
width:200
},
{
ref:'../../categoryBg',
cls:'webshop-panel-button-group',
width:80,
items:[{
xtype:'buttongroup',
columns:3,
items:[
{
ref:'../whiteBtn',
xtype:'button',
cls:'whiteBtn',
handler:function(){
this.updateStyle('fieldBgColor','#fff');
this.refreshBtnSelector()
},
scope:this
},
{
ref:'../greyBtn',
xtype:'button',
cls:'greyBtn',
handler:function(){
this.updateStyle('fieldBgColor','#bbbbbb');
this.refreshBtnSelector()
},
scope:this
},
{
ref:'../blackBtn',
xtype:'button',
cls:'blackBtn',
handler:function(){
this.updateStyle('fieldBgColor','#000');
this.refreshBtnSelector()
},
scope:this
}
],
listeners:{
render:function(buttonGroup){
addTipCb.call(buttonGroup,'Set a background color')
},
scope:this
}
}]
}
]
},
{
items:[
{
xtype:'label',
text:'Border color:',
width:200
},
{
ref:'../../categoryBorder',
xtype:'container',
cls:'webshop-panel-button-group',
width:80,
items:[{
xtype:'buttongroup',
columns:3,
items:[
{
ref:'../whiteBtn',
xtype:'button',
cls:'whiteBtn',
handler:function(){
this.updateStyle('fieldBorderColor','#fff');
this.refreshBtnSelector()
},
scope:this
},
{
ref:'../greyBtn',
xtype:'button',
cls:'greyBtn',
handler:function(){
this.updateStyle('fieldBorderColor','#bbbbbb');
this.refreshBtnSelector()
},
scope:this
},
{
ref:'../blackBtn',
xtype:'button',
cls:'blackBtn',
handler:function(){
this.updateStyle('fieldBorderColor','#000');
this.refreshBtnSelector()
},
scope:this
}
]
}],
listeners:{
render:function(buttonGroup){
addTipCb.call(buttonGroup,'Choose a border color')
},
scope:this
}
}
]
}
]
},
{
xtype:'spacer',
height:10
},
{
xtype:'label',
text:'Promotion labels:'
},
{
xtype:'spacer',
height:10
},
{
ref:'labelBgColor',
xtype:'web-ui-colorpanel-nolabel',
label:'Label color:',
tooltip:'Edit promotion label background color',
previewType:'background',
listeners:{
change:function(value){
this.updateStyle('labelBgColor',value)
},
scope:this
}
},
{
ref:'labelTextColor',
xtype:'web-ui-colorpanel-nolabel',
label:'Label text color:',
tooltip:'Edit promotion label text color',
previewType:'text',
listeners:{
change:function(value){
this.updateStyle('labelTextColor',value)
},
scope:this
}
},
{
fieldLabel:'Label position:',
labelSeparator:'',
width:170,
ref:'labelPosition',
xtype:'web-combobox',
mode:'local',
triggerAction:'all',
editable:false,
store:new Ext.data.ArrayStore({
fields:[
'value',
'text'
],
data:[
[
'topLeft',
'Top left'
],
[
'topRight',
'Top right'
],
[
'bottomLeft',
'Bottom left'
],
[
'bottomRight',
'Bottom right'
]
]
}),
valueField:'value',
displayField:'text',
value:'topRight',
listeners:{
select:function(combo,record){
this.updateProperties('labelPosition',record.get('value'))
},
scope:this
}
},
{
xtype:'button',
cls:'link-to-webshop',
text:'Manage webshop',
tooltip:'Add products and prices',
listeners:{
click:function(){
var url='https://www.one.com/admin/webapp-login.do',authenticationData=one.boneAuth.parseCookieValue()||{},mailId=authenticationData.originallyAuthenticatedEmailAddress,domain=this.app.dal.domain;
url+='?loginTarget='+'webshop.one.com'+'&targetDomain='+domain;
if(mailId){
url+='&username='+mailId
}
window.open(url)
},
scope:this
}
}
];
web.panels.props.WebShop.superclass.initComponent.call(this)
},
categorySettingsVisible:function(visible){
if(visible){
this.alignmentGear.addClass('active');
this.categorySettingsTopBorder.addClass('active');
this.categorySettingsTopBorder.getEl().addClass('custom-panel-patch-holder-visible');
this.categorySettings.addClass('active')
}else{
this.alignmentGear.removeClass('active');
this.categorySettingsTopBorder.getEl().removeClass('custom-panel-patch-holder-visible');
this.categorySettings.removeClass('active')
}
this.categorySettings.doLayout()
},
setComponent:function(component){
this.component=component;
this.refresh()
},
refresh:function(){
var component=this.component,style=component.style;
this.blockUpdates=true;
this.font.setValue(style.font.fontType||null);
this.fontColor.setColor(style.fontColor);
this.focusColor.setColor(style.focusColor);
this.hoverColor.setColor(style.hoverColor);
this.buttonStyleSelector.setValue(style.buttonId);
this.imageRatio.suspendEvents();
this.imageRatio.setValue(component.imageRatio||'square');
this.imageRatio.resumeEvents();
if(component.imageRatio==='actual'){
this.cropImages.disable()
}else{
this.cropImages.enable();
this.cropImages.setValue(!!component.cropImages)
}
this.productsPerRow.setValue(component.productsPerRow||4);
this.productsPerPage.setValue(component.productsPerPage||24);
this.sortProducts.setValue(component.sortProducts||'name-ascending');
this.categorySettings.showCategory.setValue(component.showCategory);
this.categorySettings.userCanSortProducts.setValue(component.userCanSortProducts);
this.refreshBtnSelector();
this.labelBgColor.setColor(style.labelBgColor);
this.labelTextColor.setColor(style.labelTextColor);
this.labelPosition.suspendEvents();
this.labelPosition.setValue(component.labelPosition||'topRight');
this.labelPosition.resumeEvents();
this.blockUpdates=false;
this.doLayout()
},
refreshBtnSelector:function(){
this.clearSelected();
var style=this.component.style,bgBtnName=this.hexaBtnMap[style.fieldBgColor.hex()],borderBtnName=this.hexaBtnMap[style.fieldBorderColor.hexa()]||this.hexaBtnMap[style.fieldBorderColor.hex()];
if(this.categoryBg[bgBtnName]){
this.categoryBg[bgBtnName].addClass('selected')
}else{
this.categoryBg.whiteBtn.addClass('selected')
}
if(this.categoryBorder[borderBtnName]){
this.categoryBorder[borderBtnName].addClass('selected')
}else{
this.categoryBorder.greyBtn.addClass('selected')
}
},
clearSelected:function(){
this.categoryBg.whiteBtn.removeClass('selected');
this.categoryBg.greyBtn.removeClass('selected');
this.categoryBg.blackBtn.removeClass('selected');
this.categoryBorder.whiteBtn.removeClass('selected');
this.categoryBorder.greyBtn.removeClass('selected');
this.categoryBorder.blackBtn.removeClass('selected')
},
updateProperties:function(command,value){
if(this.blockUpdates){
return
}
var validCommands={
'cropImages':true,
'imageRatio':true,
'language':true,
'productsPerPage':true,
'productsPerRow':true,
'showCategory':true,
'sortProducts':true,
'userCanSortProducts':true,
'labelPosition':true
};
if(!validCommands[command]){
throw new Error('UnrecognizedCommand')
}
var cfg={component:this.component};
cfg[command]=value;
this.app.invoker.execute(new web.commands.components.UpdateWebShopProperties(cfg))
},
updateStyle:function(prop,value){
if(prop!=='font'&&prop!=='fontColor'&&prop!=='focusColor'&&prop!=='buttonId'&&prop!=='fieldBgColor'&&prop!=='fieldBorderColor'&&prop!=='hoverColor'&&prop!=='labelBgColor'&&prop!=='labelTextColor'){
throw new Error('UnrecognizedCommand')
}
var config={};
config[prop]=value;
this.app.invoker.execute(new web.commands.components.EditWebShopStyle({
style:this.component.style,
config:config
}))
}
});
web.panels.Properties=Ext.extend(web.panels.Panel,{
xtype:'web-properties',
constructor:function(config){
this.component=null;
web.panels.Properties.superclass.constructor.call(this,config)
},
initComponent:function(){
var component=this.app.getSelected('component'),type,Panel;
this.cls='web-properties';
this.title='Properties';
this.border=false;
this.layout='card';
if(component){
type=component.type;
Panel=this.getPanelConstructor(type)
}
if(Panel){
this.items=[new Panel({
app:this.app,
component:component,
itemId:type
})];
this.activeItem=type;
this.component=component
}else{
this.items=[{html:'No component selected.'}]
}
web.panels.Properties.superclass.initComponent.apply(this,arguments)
},
initListeners:function(){
this.mon(this.app,'mode',function(mode){
var layout=this.layout;
if(this.lastType){
layout.setActiveItem(this.lastType);
layout.activeItem.setComponent(this.component);
this.ownerCt.doLayout()
}
},this);
this.mon(this.app,'select',function(part){
if(part instanceof web.data.components.Component){
this.onSelect(part)
}
},this);
this.mon(this.app.workspace.multiSelect,'multiselect',function(components){
var len=components.length;
if(len===1){
this.onSelect(components[0])
}else{
this.onMultiSelect()
}
},this);
this.mon(this.app,'update',function(part){
if(part===this.component){
this.layout.activeItem.refresh()
}
},this)
},
onSelect:function(part){
var layout=this.layout,isMobileMode=this.app.getMode()==='mobile',Panel,type;
if(part instanceof web.data.components.Page&&this.app.mode==='template'){
part=part.getTemplate()
}
if(part!==this.part&&part instanceof web.data.components.Component){
type=part.getType();
Panel=this.getPanelConstructor(type);
if(!(part instanceof web.data.components.Page)&&!(part instanceof web.data.components.Template)){
this.app.getSidebar().setActiveTab(2)
}
if(Panel){
if(!this.getComponent(type)){
this.add(new Panel({
itemId:type,
app:this.app,
component:part
}))
}
if(!isMobileMode){
layout.setActiveItem(type);
layout.activeItem.setComponent(part)
}
this.component=part;
this.lastType=type;
if(isMobileMode){
this.ownerCt.doLayout()
}
if(part instanceof web.data.components.Page&&!isMobileMode){
this.ownerCt.doLayout()
}
}
}
this.part=part
},
onMultiSelect:function(){
var type='web.panels.props.MultiSelect';
if(!this.getComponent(type)){
this.add(new web.panels.props.MultiSelect({
itemId:type,
app:this.app
}))
}
this.layout.setActiveItem(type);
this.part=null
},
getPanelConstructor:function(type){
var temp,specialWidgets,panelConstructor;
if(type.indexOf('web.data.components.widgets')===0){
temp='web.data.components.widgets.';
specialWidgets='web.data.components.'+type.substr(temp.length);
panelConstructor=this.getConstructorFromType(specialWidgets);
if(panelConstructor!==false){
return panelConstructor
}else{
type='web.data.components.widgets.Widget'
}
}
return this.getConstructorFromType(type)
},
getConstructorFromType:function(type){
var typeNamespace=type.replace(/^web\.data\.components\./,''),Panel=web.panels.props;
typeNamespace.split('.').forEach(function(ns){
Panel=Panel[ns]||Panel
});
if(Ext.isFunction(Panel)){
return Panel
}else{
return false
}
}
});
Ext.ComponentMgr.registerType('web-properties',web.panels.Properties);
(function($){
$.fn.dropDownTree=function(options){
options=options||{};
var emptyFn=function(){
};
var onError=options.onError||emptyFn,selectedValueRenderer=options.selectedValueRenderer||null,beforeFileSelect=options.beforeFileSelect||emptyFn,beforeSelectOption=options.beforeSelectOption||emptyFn,onSelect=options.onSelect||emptyFn;
var baseLeftPadding=options.baseLeftPadding||25,levelLeftPadding=options.levelLeftPadding||15,basebackgroundPositionX=options.basebackgroundPositionX||5,skipLeftPositioning=options.skipLeftPositioning||false,skipTopPositioning=options.skipTopPositioning||false,doNotHideOptions=options.doNotHideOptions||false,optionsUICls=options.optionsUICls||'';
var that=this;
var $this=$(this);
var alreadyRendered=false;
if($this.hasClass('ddtree-select')){
alreadyRendered=true
}
if(alreadyRendered){
$this.unbind();
$this.removeClass('ddtree-select');
$this.html('');
$('.'+optionsUICls).remove()
}
var $expandCollapseUI=$('<button class="button" value=""></button>');
var $selectUI=$('<div class="select-ui"></div>');
$selectUI.append($expandCollapseUI);
$this.addClass('ddtree-select');
$this.append($selectUI);
var $optionsUI=$('<div class="ddtree-options-ui '+optionsUICls+'"></div>');
this.$optionsUI=$optionsUI;
var $optionsHeader=options.treeHeader?$('<div class="ddtree-options-header">'+options.treeHeader+'</div>'):null;
var $optionsFooter=options.treeFooter?$('<div class="ddtree-options-footer">'+options.treeFooter+'</div>'):null;
var extraHtml=options.extraHtml;
var $optionsExtraHtml=$('<div class="ddtree-options-extra-html">'+function(){
var str='';
(Array.isArray(extraHtml)&&extraHtml||extraHtml&&[extraHtml]||[]).forEach(function(item){
str+=item
});
return str
}()+'</div>');
var $optionsContainer=$('<div class="ddtree-options-container"></div>');
this.$optionsContainer=$optionsContainer;
if($optionsHeader){
$optionsUI.append($optionsHeader)
}
$optionsUI.append($optionsContainer);
if($optionsFooter){
$optionsUI.append($optionsFooter)
}
$optionsUI.append($optionsExtraHtml);
$('body').append($optionsUI);
var renderDirectory=function(directory,$parent,level){
var leftPadding=baseLeftPadding+level*levelLeftPadding,backgroundPositionX=basebackgroundPositionX+leftPadding-baseLeftPadding+'px',style='padding-left:'+leftPadding+'px;'+'background-position-x:'+backgroundPositionX+';';
var $directory=$('<button class="directory button collapsed" value="'+(directory.value||directory.text||'')+'"'+(directory.title?' title="'+directory.title+'"':'')+' style="'+style+'">'+(directory.html||directory.text||directory.value||'')+'</button>');
var $directoryContents=$('<div class="directory-contents"></div>');
var $element=$('<div></div>');
$element.append($directory);
$element.append($directoryContents);
$parent.append($element);
directory.files.forEach(function(item){
if(item.type==='directory'){
renderDirectory(item,$directoryContents,level+1)
}else if(item.type==='file'){
renderFile(item,$directoryContents,level+1)
}else{
onError('An unexpected value for item.type')
}
})
};
var renderFile=function(file,$parent,level){
var leftPadding=baseLeftPadding+level*levelLeftPadding,backgroundPosition='left '+(leftPadding-baseLeftPadding)+'px top 0',style='padding-left:'+leftPadding+'px;'+'background-position:'+backgroundPosition+';';
$parent.append('<button class="button file" value="'+(file.value||file.text||'')+'"'+(file.title?' title="'+file.title+'"':'')+' style="'+style+'">'+(file.html||file.text||file.value||'')+'</button>')
};
var optionsActivated=false;
var clickedWithinDdtree=false;
var bringOptionElementIntoView=function($optionEl){
var $ddtreeOptionsContainer=$optionEl.parents('.ddtree-options-container'),isAbovePanel=$optionEl.offset().top-$ddtreeOptionsContainer.offset().top<0,isBelowPanel=$optionEl.offset().top-$ddtreeOptionsContainer.offset().top+$optionEl.outerHeight()>$ddtreeOptionsContainer.outerHeight();
var customScrollIntoView=function(atTop){
var targetScrollPosition;
if(atTop){
targetScrollPosition=$ddtreeOptionsContainer.scrollTop()+$optionEl.position().top-$ddtreeOptionsContainer.position().top
}else{
targetScrollPosition=$ddtreeOptionsContainer.scrollTop()+$optionEl.position().top-$ddtreeOptionsContainer.position().top+$optionEl.outerHeight()-$ddtreeOptionsContainer.outerHeight()
}
$ddtreeOptionsContainer.animate({scrollTop:targetScrollPosition},300)
};
if(isAbovePanel){
customScrollIntoView(true)
}else if(isBelowPanel){
if($optionEl.outerHeight()>$ddtreeOptionsContainer.outerHeight()){
customScrollIntoView(true)
}else{
customScrollIntoView(false)
}
}
};
var expandToCurrentSelection=function(){
var selectedElement=getSelectionStatus().selectedElement;
if(selectedElement){
var $selectedElement=$(selectedElement);
$selectedElement.parents('.directory-contents').each(function(index,item){
$(this).css('display','block');
$(this).prev().removeClass('collapsed').addClass('expanded')
});
bringOptionElementIntoView($selectedElement)
}
};
var showOptionsUI=function(){
if(!skipLeftPositioning){
$optionsUI.css('left',$this.offset().left)
}
if(!skipTopPositioning){
$optionsUI.css('top',$this.offset().top+$this.outerHeight())
}
$optionsUI.outerWidth($this.width());
$optionsUI.show();
expandToCurrentSelection()
};
var hideOptionsUI=function(){
if(!doNotHideOptions){
$optionsUI.hide()
}
};
var showHideOptionsUI=function(operation){
if(operation==='show'){
showOptionsUI()
}else if(operation==='hide'){
hideOptionsUI()
}else{
if($optionsUI.is(':visible')){
hideOptionsUI()
}else{
showOptionsUI()
}
}
};
$expandCollapseUI.on('click',function(){
showHideOptionsUI();
if($optionsUI.is(':visible')){
optionsActivated=true
}else{
optionsActivated=false
}
});
var getSelectionStatus=function(selectedElement){
selectedElement=selectedElement||$optionsContainer.find('.button.selected').get(0);
var $allFiles=$optionsContainer.find('.button.file'),selectedIndex=null;
$allFiles.each(function(index,item){
if(selectedElement===item){
selectedIndex=index
}
});
var selectionStatus={
selectedIndex:selectedIndex,
selectedElement:selectedElement,
firstItemSelected:selectedIndex===0?true:false,
lastItemSelected:selectedIndex===$allFiles.length-1?true:false
};
return selectionStatus
};
var selectOption=function(optionEl,doFocus,config){
var doNotProceed=beforeSelectOption()===false;
if(doNotProceed){
return
}
if(optionEl){
var $option=$(optionEl);
that.valueSelected=$option.val();
$expandCollapseUI.val($option.val());
if(selectedValueRenderer){
$expandCollapseUI.html(selectedValueRenderer(that.valueSelected))
}else{
$expandCollapseUI.html($option.html())
}
$optionsContainer.find('.button').removeClass('selected');
$option.addClass('selected');
expandToCurrentSelection();
if(doFocus){
$expandCollapseUI.focus()
}
onSelect(getSelectionStatus(optionEl),config)
}
};
this.selectOption=selectOption;
$this.on('render-tree',function(evt,items,cb){
items.forEach(function(item){
if(item.type==='directory'){
renderDirectory(item,$optionsContainer,0)
}else if(item.type==='file'){
renderFile(item,$optionsContainer,0)
}else{
onError('callback: An unexpected value for item.type')
}
});
$expandCollapseUI.add($optionsUI.find('.button')).on('blur',function(){
setTimeout(function(){
if(!clickedWithinDdtree){
hideOptionsUI()
}
clickedWithinDdtree=false
},0)
});
$expandCollapseUI.add($optionsUI.find('.button')).on('focusin',function(){
clickedWithinDdtree=true;
setTimeout(function(){
clickedWithinDdtree=false
},0)
});
$optionsContainer.find('.button').on('click',function(){
var $this=$(this);
if($this.hasClass('directory')){
$this.toggleClass('collapsed').toggleClass('expanded');
$this.next().slideToggle(function(){
if($this.hasClass('expanded')){
bringOptionElementIntoView($this.parent())
}
})
}else if($this.hasClass('file')){
var doNotProceed=beforeFileSelect()===false;
if(doNotProceed){
return
}
selectOption(this,true);
showHideOptionsUI('hide')
}
});
cb()
});
$this.on('select-next',function(evt,fnSuccess,fnFailure,options){
var currentlySelectedOptionEl=$optionsContainer.find('.button.selected');
options=options||{};
var $allFiles=$optionsContainer.find('.button.file');
var failed=false;
if(currentlySelectedOptionEl.length){
var selectNextItem=false;
$allFiles.each(function(index,item){
if(selectNextItem){
selectOption(item);
return false
}else if(currentlySelectedOptionEl.get(0)===item){
selectNextItem=true
}
})
}else{
if($allFiles.get(0)){
selectOption($allFiles.get(0),null,{doNotActivateTransparency:options.doNotActivateTransparency})
}else{
failed=true
}
}
if(failed){
if(fnFailure){
fnFailure()
}
}else{
if(fnSuccess){
fnSuccess()
}
}
});
$this.on('select-previous',function(evt,cb){
var currentlySelectedOptionEl=$optionsContainer.find('.button.selected');
var $allFiles=$optionsContainer.find('.button.file');
if(currentlySelectedOptionEl.length){
var selectPreviousItem=false;
var previousElement=null,previousElementIndex=null;
$allFiles.each(function(index,item){
if(selectPreviousItem){
return false
}else if(currentlySelectedOptionEl.get(0)===item){
selectPreviousItem=true
}else{
previousElement=item;
previousElementIndex=index
}
});
if(previousElement){
selectOption(previousElement)
}
}else{
selectOption($allFiles.get(0))
}
if(cb){
cb()
}
});
$this.on('get-value',function(evt,cb){
cb(that.valueSelected)
});
return this
}
}(oneJQuery));
web.panels.PreviewMode=Ext.extend(Ext.Container,{
initComponent:function(){
this.buttonAlign='right';
this.defaults={
enableToggle:true,
toggleGroup:'previewmode',
handler:this.onChangeMode,
scope:this,
height:50
};
this.layout='table';
this.layoutConfig={align:'middle'};
this.items=[
{
xtype:'button',
itemId:'desktopView',
ref:'btnDesktopView',
cls:'mode-btn-tab preview-btn-tab',
text:'<img class="icon icon-mode-desktop-preview" src="'+Ext.BLANK_IMAGE_URL+'"/>'+'Desktop',
tooltip:'Preview what the site will look like on a normal screen size like a desktop computer.'
},
{
xtype:'spacer',
width:2
},
{
xtype:'button',
itemId:'mobileView',
ref:'btnMobileView',
cls:'mode-btn-tab preview-btn-tab',
text:'<img class="icon icon-mode-mobile-preview" src="'+Ext.BLANK_IMAGE_URL+'"/>'+'Mobile',
tooltip:'Preview what the site will look like on a small screen size like a mobile phone.'
}
];
web.panels.PreviewMode.superclass.initComponent.apply(this,arguments);
this.initListeners()
},
initListeners:function(){
},
onChangeMode:function(btn){
var mobileOrDesktop=btn.itemId==='mobileView'?'mobile':'desktop';
this.previewPanel.setView(mobileOrDesktop);
this.pauseYoutubeVideos(mobileOrDesktop)
},
pauseYoutubeVideos:function(mobileOrDesktop){
var that=this;
var fn=function(){
oneJQuery(mobileOrDesktop==='mobile'?that.previewPanel.previewDesktop.el.dom:that.previewPanel.previewMobile.el.dom).find('iframe').each(function(idx,frame){
oneJQuery(frame.contentDocument.documentElement).find('iframe.youtube-player').each(function(idx,ytframe){
var player=oneJQuery(ytframe).data('player');
if(player){
player.pauseVideo()
}else{
player=new YT.Player(ytframe,{
events:{
'onReady':function(){
player.pauseVideo();
oneJQuery(ytframe).data('player',player)
}
}
})
}
})
})
};
if(window.YT){
fn()
}else{
var tag=document.createElement('script');
tag.src='https://www.youtube.com/iframe_api';
document.body.appendChild(tag);
window.onYouTubeIframeAPIReady=function(){
fn()
}
}
}
});
web.ui.MobileCheckbox=Ext.extend(Ext.Container,{
constructor:function(config){
this.cls='cb-activate-mobile-version';
config.items=[
{
xtype:'checkbox',
ref:'checkbox',
boxLabel:'Activate mobile version',
listeners:{
check:function(cb,enabled){
var template=this.app.getSelected('page').getTemplate();
this.app.invoker.execute(new web.commands.templates.ChangeMobile({
template:template,
mobile:enabled
}))
},
scope:this
}
},
{
html:'When active, visitors on mobile devices will see this special version.'+'<br /><br />'+'You can also activate this special mobile version, by selecting <b>Activate mobile version</b> under <b>Edit Template</b>.',
cls:'desc-activate-mobile',
style:{
width:200,
'margin-top':10
}
}
];
web.ui.MobileCheckbox.superclass.constructor.call(this,config)
},
onRender:function(){
web.ui.MobileCheckbox.superclass.onRender.apply(this,arguments);
this.update(this.app.getSelected('template'));
this.app.on('update',this.update,this);
this.app.on('select',this.update,this)
},
update:function(part){
var checkbox=this.checkbox;
if(checkbox&&part instanceof web.data.components.Template){
checkbox.suspendEvents();
checkbox.setValue(part.isMobile());
checkbox.resumeEvents()
}
}
});
Ext.reg('web-mobilecheckbox',web.ui.MobileCheckbox);
web.ui.MobileContainer=Ext.extend(Ext.Container,{
constructor:function(config){
var app=config.app,items=config.items;
config.height='100%';
config.layout='fit';
config.items=[{
ref:'main',
cls:'preview-mobile',
bodyCfg:{cls:'preview-mobile-x-panel-body'},
layout:'vbox',
layoutConfig:{align:'center'},
height:app.getWorkspaceUsableHeight(),
listeners:{
afterrender:function(c){
this.app.on('resize',function(){
if(c.isVisible()&&c.getHeight()){
c.setHeight(app.getWorkspaceUsableHeight())
}
})
},
afterlayout:function(c){
this.verticallyMiddleAlign()
},
scope:this
},
items:[
{
layout:'absolute',
cls:'mobile-phone',
ref:'mobilePhone',
bodyCfg:{cls:'mobile-phone-x-panel-body'},
items:[
{
html:'',
style:{
width:377,
height:739
},
cls:'phone-body',
ref:'phoneBody'
},
{
x:31,
y:151,
cls:'phone-screen',
ref:'phoneScreen',
anchor:'-23',
items:items
}
]
},
{
style:{position:'fixed'},
height:40,
width:40,
cls:'btn-rotate-mobile icon',
xtype:'button',
tooltip:'Rotate mobile phone between vertical and horizontal view.',
handler:function(){
this.rotateMobile()
},
scope:this
},
config.checkbox?{
cls:'cb-activate-mobile-version-float',
layout:'anchor',
items:[{
xtype:'web-mobilecheckbox',
app:config.app,
anchor:'left'
}]
}:{}
]
}];
web.ui.MobileContainer.superclass.constructor.call(this,config)
},
getOrientation:function(){
return this.main.el.hasClass('horizontal')?'horizontal':'vertical'
},
rotateMobile:function(){
if(this.main.el.hasClass('horizontal')){
this.rotateMobileVertical()
}else{
this.rotateMobileHorizontal()
}
},
rotateMobileHorizontal:function(){
this.main.el.addClass('horizontal');
this.main.doLayout();
this.autoScrollForMobile();
this.targetPreviewMode='mobile-horizontal';
this.lastPreviewMobileMode='horizontal'
},
rotateMobileVertical:function(){
this.main.el.removeClass('horizontal');
this.main.doLayout();
this.autoScrollForMobile();
this.targetPreviewMode='mobile-vertical';
this.lastPreviewMobileMode='vertical'
},
verticallyMiddleAlign:function(){
var mobilePhoneEl=this.main.mobilePhone.el,requiredHeight=mobilePhoneEl.getHeight(),availableHeight=mobilePhoneEl.parent().getHeight(),marginTop=parseInt((availableHeight-requiredHeight)/2,10),minMarginTop=0;
if(marginTop>minMarginTop){
mobilePhoneEl.setStyle('margin-top',marginTop+'px')
}else{
mobilePhoneEl.setStyle('margin-top','')
}
},
autoScrollForMobile:function(){
var hasVerticalScrollBar=function(el){
return el.offsetHeight<el.scrollHeight
};
var containerDiv=this.main.el.query('.x-box-inner')[0];
if(containerDiv){
var needToScroll=hasVerticalScrollBar(containerDiv);
if(needToScroll){
var mobilePhone=this.main.mobilePhone,scrollableEl=mobilePhone.el.parent(),phoneScreen=mobilePhone.phoneScreen,contentBeginsAt=phoneScreen.el.getOffsetsTo(mobilePhone.el)[1]-21,scrollValueForCenterAligning=(mobilePhone.getHeight()-scrollableEl.getHeight())/2;
scrollableEl.scrollTo('top',Math.min(scrollValueForCenterAligning,contentBeginsAt))
}
}
},
refresh:function(){
var panel=this.main;
if(!panel){
return
}
if(this.lastPreviewMobileMode==='horizontal'){
if(panel.el){
this.rotateMobileHorizontal()
}else{
panel.on('afterrender',function(){
this.rotateMobileHorizontal()
},this)
}
}else{
if(panel.el){
this.rotateMobileVertical()
}else{
panel.on('afterrender',function(){
this.rotateMobileVertical()
},this)
}
}
panel.ownerCt.setWidth(Ext.getBody().getWidth());
panel.setHeight(this.app.getWorkspaceUsableHeight())
}
});
Ext.reg('web-mobilecontainer',web.ui.MobileContainer);
web.windows.BackupAndRestoreIntroduction=Ext.extend(web.windows.Window,{
type:'web.windows.BackupAndRestoreIntroduction',
modal:true,
resizable:false,
constructor:function(config){
this.cls='backup-and-restore-introduction web-modal-info x-window-dlg';
web.windows.BackupAndRestoreIntroduction.superclass.constructor.call(this,config)
},
setValues:function(values){
if(values.hideDoNotShowAgainCheckbox){
this.doNotShowAgain.hide()
}else{
this.doNotShowAgain.show()
}
},
initComponent:function(){
var that=this;
that.title='Backups';
var doNotShowAgainCheckedStatus=that.app.dal.uiState.get('backupRestoreIntroductionDoNotShowAgain')==='yes';
that.items=[{
xtype:'container',
items:[
{
xtype:'container',
style:'padding-left:55px;padding-right:55px',
html:[
'<div class="backup-restore-logo"></div>',
'<div style="font-weight:bold;padding-bottom:10px">'+'Restore your website project to a previous version:'+'</div>',
'<div class="checkmark">'+'Backups when you save'+'</div>',
'<div class="checkmark">'+'Preview backups'+'</div>',
'<div class="checkmark">'+'Restore your website from up to 200 saved versions'+'</div>',
'<div style="margin-top:20px">'+'Backup &amp; Restore is included in Website Builder Premium.'+'</div>',
'<div><a target="_blank" class="green-color-link" href="'+'https://www.one.com/en/support/guide/using-backups-in-website-builder'+'">'+'Learn more'+'</a></div>'
].join('')
},
{
xtype:'container',
cls:'web-window-footer hbox cross-center',
items:[
{
ref:'../../doNotShowAgain',
xtype:'checkbox',
checked:doNotShowAgainCheckedStatus,
boxLabel:'Don\'t show this again'
},
{
xtype:'spacer',
cls:'flex'
},
{
xtype:'button',
cls:'x-btn-primary large wide',
text:'Got it',
handler:function(){
that.hide()
}
}
]
}
]
}];
this.listeners={
scope:this,
hide:function(){
that.onHide()
},
show:function(){
that.center()
}
};
web.windows.BackupAndRestoreIntroduction.superclass.initComponent.apply(this,arguments)
},
onHide:function(){
if(this.doNotShowAgain.checked){
this.app.dal.uiState.set('backupRestoreIntroductionDoNotShowAgain','yes')
}else{
this.app.dal.uiState.delete('backupRestoreIntroductionDoNotShowAgain')
}
}
});
Ext.ComponentMgr.registerType('web-windows-backup-and-restore-introduction',web.windows.BackupAndRestoreIntroduction);
web.windows.BackupAndRestorePremiumFeature=Ext.extend(web.windows.Window,{
type:'web.windows.BackupAndRestorePremiumFeature',
modal:true,
resizable:false,
constructor:function(config){
this.cls='backup-and-restore-premium-feature web-modal-premium x-window-dlg';
this.width=500;
web.windows.BackupAndRestorePremiumFeature.superclass.constructor.call(this,config)
},
initComponent:function(){
var that=this;
that.title='Premium feature';
that.items=[{
xtype:'container',
items:[
{
xtype:'container',
style:'padding-left:55px;padding-right:55px',
html:[
'<div class="backup-restore-logo"></div>',
'<div style="font-weight:bold;padding-bottom:10px">'+'Upgrade to Premium today to unlock backups and access other great features.'+'</div>',
'<div class="checkmark">'+'Backups when you save'+'</div>',
'<div class="checkmark">'+'Preview backups'+'</div>',
'<div class="checkmark">'+'Restore your website from up to 200 saved versions'+'</div>',
'<div style="margin-top:20px">'+'Backup &amp; Restore is included in Website Builder Premium.'+'</div>',
'<div><a target="_blank" class="green-color-link" href="'+'https://www.one.com/en/support/guide/using-backups-in-website-builder'+'">'+'Learn more'+'</a></div>'
].join('')
},
{
xtype:'container',
cls:'web-window-footer hbox cross-center',
items:[{
xtype:'button',
cls:'x-btn-primary large wide',
text:'<span class="no-free-upgrade-offer">Upgrade</span><span class="free-upgrade-offer">Free Upgrade</span>',
handler:function(){
web.upgradeToPremiumViaPopup({
app:that.app,
source:'BackupAndRestore:UpgradePopup'
})
}
}]
}
]
}];
this.listeners={
scope:this,
hide:function(){
that.onHide()
},
show:function(){
that.center()
}
};
web.windows.BackupAndRestorePremiumFeature.superclass.initComponent.apply(this,arguments)
}
});
Ext.ComponentMgr.registerType('web-windows-backup-and-restore-premium-feature',web.windows.BackupAndRestorePremiumFeature);
web.panels.Preview=Ext.extend(Ext.Container,{
showHideBackupOptions:'hide',
NO_PAGES_HTML:[
'<head>',
'<style>',
'*{margin:0;padding:0}',
'html,body{height:100%}',
'html{display:table;width:100%}',
'body{display:table-cell;text-align:center;vertical-align:middle;font-family:"Helvetica Neue",Helvetica,sans-serif;font-size:20px;color:#999}',
'</style>',
'</head>',
'<body>',
'You didn\'t have any pages at this point.<br/>Please select another saved backup.',
'</body>'
].join(''),
_currentlySelectedUrlForPreview:null,
syncIframes:function(){
var that=this;
if(this._currentlySelectedUrlForPreview==='_no_pages'){
setTimeout(function(){
var newSelectedIFrame=that.cards.layout.activeItem.el.query('iframe')[0];
newSelectedIFrame.contentWindow.document.documentElement.innerHTML=that.NO_PAGES_HTML
},100);
return true
}else if(this._currentlySelectedUrlForPreview){
if(this.cards.layout.activeItem.refName==='previewDesktop'){
this.previewMobile.el.query('iframe')[0].src=this._currentlySelectedUrlForPreview
}else{
this.previewDesktop.el.query('iframe')[0].src=this._currentlySelectedUrlForPreview
}
return true
}
return false
},
initComponent:function(config){
var that=this;
var previewMode=new web.panels.PreviewMode({previewPanel:that});
this.previewMode=previewMode;
this.layout='form';
this.height='100%';
this.items=[
{
cls:'preview-mode-header',
height:53,
layout:'hbox',
style:{height:'53px'},
items:[
{
xtype:'spacer',
width:9
},
{
xtype:'button',
style:{'margin-top':'15px'},
cls:'large wide x-btn-secondary no-border',
text:'Back to Editor',
tooltip:'Continue editing your website.',
listeners:{
click:this.close,
scope:this
}
},
{
xtype:'spacer',
width:9
},
{
xtype:'button',
ref:'../publishButton',
style:{'margin-top':'15px'},
cls:'x-btn-primary-ws large wide',
text:'Publish',
tooltip:'Update your live website with your changes.',
listeners:{
click:function(b,e){
that.onPublish(function(success){
if(success){
b.disable()
}
})
}
}
},
{
xtype:'container',
flex:1,
height:53,
layout:'column',
items:[
{
columnWidth:0.5,
html:'&nbsp;'
},
{
xtype:'container',
ref:'../../restoreBackupUI',
listeners:{
scope:this,
show:function(){
var $=oneJQuery;
var that=this;
if(that.syncIframes()){
return
}
var beforeSelectOptionCalled=false;
var ddtree=$('.preview-history-ddtree').dropDownTree({
treeHeader:'<table style="width:100%;margin-top:3px">'+'<tr>'+'<td style="width:35px"></td>'+'<td style="padding: 7px 3px 7px 3px">'+'Saved backups'+'</td>'+'<td style="width:35px"><div class="restore-backup-help"></div></td>'+'</tr>'+'</table>',
treeFooter:function(){
if(that.app.userHasFullBackupRestoreAccess()||that.app.userBackupRestoreAccessStatusUnknown()){
return null
}else{
return[
'<div>',
'<div class="backups-icon"></div>',
'<div class="title">'+'Need backups?'+'</div>',
'<div class="message">'+'Upgrade to Premium and get access to saved versions of your website.'+'</div>',
'<div class="action">',
'<button class="upgrade-to-premium">',
'<span class="no-free-upgrade-offer">Upgrade</span><span class="free-upgrade-offer">Free Upgrade</span>',
'</button>',
'</div>',
'<div class="learn-more"><a class="green-color-link" onclick="javascript:void(0)">'+'Learn more'+'</a></div>',
'</div>'
].join('')
}
}(),
extraHtml:['<div class="show-hide panel-shown"></div>'],
baseLeftPadding:30,
levelLeftPadding:15,
basebackgroundPositionX:12,
skipLeftPositioning:true,
skipTopPositioning:true,
doNotHideOptions:true,
optionsUICls:'preview-history-options-ui panel-shown',
selectedValueRenderer:function(value){
return that.renderRelativeDateTime(parseInt(value,10),'dateTime',that.backupsViewLoadedAt)
},
onError:function(err){
one.fatal('Unexpected error in dropdowntree: '+err)
},
beforeSelectOption:function(){
if(!that.app.userHasFullBackupRestoreAccess()&&beforeSelectOptionCalled){
that.app.windows.show({type:'web.windows.BackupAndRestorePremiumFeature'});
return false
}
beforeSelectOptionCalled=true
},
onSelect:function(selectionStatus,options){
updateButtons(selectionStatus);
that.loadSelectedPageFromTime(parseInt(selectionStatus.selectedElement.value,10))
}
});
ddtree.removeClass('rendered');
ddtree.$optionsContainer.append('<div class="animated-loading-dots"><div></div></div>');
that.ddtree=ddtree;
that.doLayout();
var mask=Ext.getBody().mask('','full-webeditor-mask-behind-window',true,true);
mask.dom.style.zIndex='8900';
var $thatEl=oneJQuery(that.el.dom);
var $newer=$thatEl.find('.newer'),$older=$thatEl.find('.older');
if(that.toolTipOlder){
that.toolTipOlder.destroy()
}
if(that.toolTipNewer){
that.toolTipNewer.destroy()
}
that.toolTipOlder=new Ext.ToolTip({
target:$older[0],
bodyCfg:{
cls:'x-tip-body',
html:'Preview previous saved version'
}
});
that.toolTipNewer=new Ext.ToolTip({
target:$newer[0],
bodyCfg:{
cls:'x-tip-body',
html:'Preview next saved version'
}
});
$newer.unbind();
$older.unbind();
var $previewHistoryOptionsUI=$('.preview-history-options-ui');
$previewHistoryOptionsUI.unbind();
var updateButtons=function(selectionStatus){
selectionStatus=selectionStatus||{};
if(selectionStatus.selectedIndex===null){
$newer.prop('disabled',true);
$older.prop('disabled',true)
}else{
if(selectionStatus.firstItemSelected){
$newer.prop('disabled',true)
}else{
$newer.prop('disabled',false)
}
if(selectionStatus.lastItemSelected){
$older.prop('disabled',true)
}else{
$older.prop('disabled',false)
}
}
};
$newer.on('click',function(){
ddtree.trigger('select-previous')
});
$older.on('click',function(){
ddtree.trigger('select-next')
});
var $showHideBtn=$('.preview-history-options-ui .show-hide');
$showHideBtn.unbind();
$showHideBtn.on('click',function(){
if($showHideBtn.hasClass('panel-hidden')){
$showHideBtn.add('.preview-history-options-ui').removeClass('panel-hidden').addClass('panel-shown')
}else{
$showHideBtn.add('.preview-history-options-ui').removeClass('panel-shown').addClass('panel-hidden')
}
});
that.getTimeline(null,function(opts,success,snapshots,latestSnapshotTime){
if(!success){
Ext.getBody().unmask();
that.close();
return
}
ddtree.trigger('render-tree',[
snapshots,
function(){
ddtree.addClass('rendered');
ddtree.$optionsContainer.addClass('rendered');
ddtree.trigger('select-next',[
function success(){
that.doLayout()
},
function failure(){
if(latestSnapshotTime){
ddtree.selectOption($('<button value="'+latestSnapshotTime+'"></button>').get(0))
}
that.doLayout();
Ext.getBody().unmask()
}
]);
var $restoreBackupHelpIcon=ddtree.$optionsUI.find('.restore-backup-help');
$restoreBackupHelpIcon.on('click',function(){
that.app.windows.show({
type:'web.windows.BackupAndRestoreIntroduction',
values:{hideDoNotShowAgainCheckbox:true}
})
});
new Ext.ToolTip({
target:$restoreBackupHelpIcon[0],
bodyCfg:{
cls:'x-tip-body',
html:'What are saved backups?'
}
});
var $buttonUpgrade=ddtree.$optionsUI.find('.ddtree-options-footer button.upgrade-to-premium');
$buttonUpgrade.on('click',function(){
web.upgradeToPremiumViaPopup({
app:that.app,
source:'BackupAndRestore:NeedBackups'
})
});
var $linkLearnMore=ddtree.$optionsUI.find('.ddtree-options-footer .learn-more a');
$linkLearnMore.on('click',function(){
that.app.windows.show({type:'web.windows.BackupAndRestorePremiumFeature'})
})
}
])
})
}
},
items:[
{
xtype:'container',
style:'float:left',
html:[
'<div class="preview-history-ddtree-parent">',
'<div style="margin-top:5px;margin-right:12px">'+'Select version:'+'</div>',
'<button class="older"></button>',
'<div class="preview-history-ddtree"></div>',
'<div class="animated-loading-dots"><div></div></div>',
'<button class="newer" disabled></button>',
'</div>'
].join('')
},
{
xtype:'button',
ref:'../../../btnRestoreBackup',
cls:'x-btn-primary-ws large wide btn-restore-backup',
text:'Restore backup',
tooltip:'Restore your website to the selected backup version.',
listeners:{
mouseover:function(btn){
if(btn.el.hasClass('disable-on-mouseover')){
btn.disable()
}
},
click:function(b,e){
if(!that.app.userHasFullBackupRestoreAccess()){
that.app.windows.show({type:'web.windows.BackupAndRestorePremiumFeature'});
return
}
that.ddtree.trigger('get-value',function(valueSelected){
var timestamp=parseInt(valueSelected,10),datetime=new Date(timestamp);
Ext.Msg.show({
title:'Do you want to restore your website?',
msg:'<div>'+'Your website will be restored back to how it looked at:'+'</div>'+'<div style="font-weight:bold;text-transform:uppercase;margin-top:10px">'+one.locale.renderDate(datetime,'mediumDateTime')+'</div>'+function(){
var warnUserPreferredNewWsbAtThatTime='';
if(that.app.dal.getPagePreviewUrl.userPreferredNewWsbAtThatSavePoint){
warnUserPreferredNewWsbAtThatTime+='<br/><br/><b>'+'Note:'+'</b> '+'You will be redirected to the new Website Builder when your website is restored. You were working on that version at the time mentioned above.'
}
return warnUserPreferredNewWsbAtThatTime
}(),
buttons:{
ok:'Restore',
cancel:'Cancel'
},
closable:true,
fn:function(b){
if(b==='ok'){
var generateFullScreenCover=function(text){
var $=oneJQuery,$coverFullScreen=$('<div class="cover-full-screen">'+'<div>'+'<div class="animated-loading-dots"><div></div></div>'+'<div class="subtext">'+text+'</div>'+'</div>'+'</div>');
$('body').append($coverFullScreen);
return $coverFullScreen
};
var proceed=function(){
var $coverFullScreen=generateFullScreenCover('Restoring...');
var app=one.viewport.application,domain=app.dal.getDomain();
that.rollbackAPI(domain,datetime,function(options,success,xhr){
if(success){
that.app.dal.uiState.set('restoreStatus','success');
window.onbeforeunload=function(){
};
document.location.reload()
}else{
$coverFullScreen.remove();
Ext.Msg.show({
cls:'web-modal-warning',
iconCls:'web-warning-icon',
title:'Restoring failed',
msg:'Sorry, we could not restore your website. Please select another version and try again.',
buttons:{ok:'OK'}
})
}
},this)
};
if(that.app.hasUnsavedChanges()){
Ext.Msg.show({
buttons:{
yes:'Save',
no:'Don\'t Save',
cancel:'Cancel'
},
cls:'hide-secondary-button-from-ext-modal',
title:'Do you want to save recent changes?',
msg:'You have unsaved changes. Do you want to save your recent changes, before restoring to the selected version?',
fn:function(buttonId,evt){
if(buttonId==='yes'){
var $coverFullScreen=generateFullScreenCover('Saving...');
that.app.save(function(){
$coverFullScreen.remove();
$coverFullScreen=generateFullScreenCover('Restoring...');
setTimeout(function(){
$coverFullScreen.remove();
proceed()
},1000+(10000||10000))
},{
failure:function(){
$coverFullScreen.remove()
}
})
}else if(buttonId==='no'){
proceed()
}
},
scope:this
})
}else{
proceed()
}
}
},
scope:this
})
})
}
}
}
]
}
]
},
{
style:{'margin-top':'10px'},
items:[previewMode]
}
]
},
{
xtype:'container',
width:'100%',
layout:'hbox',
layoutConfig:{align:'stretch'},
height:7,
items:[{
xtype:'container',
flex:1,
style:'background-color: #ececec;'
}]
},
{
layout:'card',
ref:'cards',
activeItem:0,
width:'100%',
items:[
{
ref:'../previewDesktop',
cls:'preview-desktop',
height:that.app.getWorkspaceUsableHeight(),
bodyCfg:{
tag:'iframe',
style:{
border:0,
width:'100%'
}
},
listeners:{
afterrender:function(c){
c.setHeight(that.app.getWorkspaceUsableHeight());
that.app.on('resize',function(){
c.el.query('iframe')[0].style.height=that.app.getWorkspaceUsableHeight()+'px'
})
}
}
},
{
xtype:'web-mobilecontainer',
ref:'../previewMobile',
app:this.app,
checkbox:true,
items:[{
bodyCfg:{
tag:'iframe',
style:{
border:0,
width:'268px',
height:'457px'
}
}
}]
}
],
listeners:{
afterrender:function(cards){
that.app.on('resize',function(){
cards.setHeight(that.app.getWorkspaceUsableHeight())
})
}
}
}
];
web.panels.Preview.superclass.initComponent.apply(this,arguments)
},
close:function(){
var app=this.app;
app.fireEvent('activate','workspace');
if(document.activeElement){
document.activeElement.blur()
}
setTimeout(function(){
if(document.activeElement){
document.activeElement.blur()
}
},0);
oneJQuery('.preview-history-options-ui').remove();
app.showHideShadow('vertical','show');
app.workspace.fireEvent('redraw');
this.doNotAutoShowBackupAndRestoreIntroduction=null;
this.cleanup()
},
rollbackAPI:function(domainName,time,callback,scope){
scope=scope||this;
if(Object.prototype.toString.call(time)==='[object Date]'){
time=time.getTime()
}
Ext.Ajax.request({
url:'/api/v1/'+domainName+'/doc',
method:'POST',
jsonData:{
command:'rollback',
time:time
},
callback:callback,
scope:scope
})
},
loadSelectedPageFromTime:function(time){
var that=this,app=that.app,dal=app.dal;
that.btnRestoreBackup.addClass('disable-on-mouseover');
var getHomePageIdOrFirstPageIdFromSiteMapForTime=function(siteMap,time,cb){
var getItems=function(folder){
if(folder.items){
return folder.items.concat()
}
return null
};
var getAllItems=function(folder){
var result=[],items=getItems(folder);
if(items){
items.forEach(function(item){
result.push(item);
result=result.concat(getAllItems(item))
},folder)
}
return result
};
var getAllPages=function(folder){
var result=[],items=getAllItems(folder);
items.forEach(function(item){
if(item.type==='web.data.links.LinkPage'){
result.push(item)
}
},folder);
return result
};
var allPages=getAllPages(siteMap.folder);
var homePageId=siteMap.homePageId,homePageIdExistsInSiteMap=false;
if(homePageId){
homePageIdExistsInSiteMap=allPages.some(function(page){
return homePageId===page.pageId
})
}
var pagesToCheckInOrder=[];
if(homePageIdExistsInSiteMap){
pagesToCheckInOrder.push(homePageId)
}
allPages.forEach(function(page){
if(page.pageId!==homePageId){
pagesToCheckInOrder.push(page.pageId)
}
});
if(pagesToCheckInOrder.length){
var i=0;
var fn=function(){
that.app.dal.getWithDependentsAtTime(pagesToCheckInOrder[i],'web.data.components.Page',time,function(options,success,response){
var responseJSON=null;
if(success&&response.responseText){
responseJSON=JSON.parse(response.responseText)
}
if(responseJSON&&responseJSON.page&&responseJSON.page.id){
cb(pagesToCheckInOrder[i])
}else if(i<pagesToCheckInOrder.length-1){
i++;
fn()
}else{
cb(null)
}
})
};
fn()
}else{
cb(null)
}
};
dal.getSitemapAtTime(time,function(opts,success,response){
that.btnRestoreBackup.removeClass('disable-on-mouseover');
if(success&&response.responseText){
var rawSiteMap=Ext.decode(response.responseText);
getHomePageIdOrFirstPageIdFromSiteMapForTime(rawSiteMap,time,function(pageToLoadId){
Ext.getBody().unmask();
var iframe=that.cards.layout.activeItem.el.query('iframe')[0];
if(pageToLoadId){
that.btnRestoreBackup.enable();
var url=dal.getPagePreviewUrl(pageToLoadId,{prefersNewWSB:rawSiteMap.prefersNewWSB});
that._currentlySelectedUrlForPreview=url+'?previewbackup=true&time='+time;
iframe.src=that._currentlySelectedUrlForPreview
}else{
that.btnRestoreBackup.disable();
that._currentlySelectedUrlForPreview='_no_pages';
iframe.contentWindow.document.documentElement.innerHTML=that.NO_PAGES_HTML
}
})
}else{
Ext.getBody().unmask();
that.btnRestoreBackup.disable();
one.fatal('Custom - Could not get sitemap for selected saved backup');
one.error('Something went wrong. Please try again later.','An error occurred')
}
})
},
setView:function(mobileOrDesktop,refreshFrame,options){
var isMobile;
this.targetPreviewMode=mobileOrDesktop=mobileOrDesktop||this.targetPreviewMode;
this.showHideBackupOptions=options&&options.showHideBackupOptions||this.showHideBackupOptions;
isMobile=mobileOrDesktop==='mobile';
if(isMobile){
this.previewMobile.doLayout();
this.previewMobile.refresh()
}
if(refreshFrame){
this.previewMobile.previewRendered=false;
this.previewDesktop.previewRendered=false
}
if(this.showHideBackupOptions==='show'){
if(this.app.dal.uiState.get('backupRestoreIntroductionDoNotShowAgain')!=='yes'&&!this.doNotAutoShowBackupAndRestoreIntroduction){
this.doNotAutoShowBackupAndRestoreIntroduction=true;
this.app.windows.show({
type:'web.windows.BackupAndRestoreIntroduction',
values:{hideDoNotShowAgainCheckbox:false}
})
}
this.adjustUI('backups')
}else{
this.adjustUI('preview');
this.refreshFrame(isMobile?this.previewMobile:this.previewDesktop)
}
this.cards.layout.setActiveItem(isMobile?1:0);
this.previewMode.btnDesktopView.toggle(!isMobile,true);
this.previewMode.btnMobileView.toggle(isMobile,true)
},
refresh:function(options){
this._currentlySelectedUrlForPreview=null;
this.publishButton.setDisabled(this.isPublishButtonDisabled());
this.setView(null,true,options)
},
adjustUI:function(mode){
if(mode==='backups'){
this.publishButton.hide();
this.restoreBackupUI.show();
oneJQuery('.preview-history-options-ui').show();
oneJQuery('.cb-activate-mobile-version-float').hide()
}else{
this.restoreBackupUI.hide();
this.publishButton.show();
oneJQuery('.cb-activate-mobile-version-float').show()
}
this.doLayout()
},
refreshFrame:function(panel,options){
var app=this.app,page=app.getSelected('page'),doc,displayPreview;
function writeFrame(frame){
var frameDocument=frame.contentWindow.document;
if(Ext.get(frameDocument.body)){
Ext.get(frameDocument.body).remove()
}
frameDocument.open();
setTimeout(function(){
frameDocument.write(doc.toHTML());
frameDocument.close()
},0)
}
displayPreview=function(frame,pageId){
app.loadPage(pageId,function(success,page){
if(success){
page.render(doc);
writeFrame(frame)
}
},this)
};
function initFrame(panel,page){
panel.setHeight(app.getWorkspaceUsableHeight());
if(Ext.isIE){
var parentDoc=Ext.get(document.body);
parentDoc.mask('','animated-loading-dots',true,true)
}
var frame=panel.el.query('iframe')[0],frameLoad=function(){
if(Ext.isIE){
parentDoc.unmask()
}
var frameDocument=frame.contentWindow.document;
Ext.get(frameDocument.body).on('click',function(event,el){
var pageId,href=el.href;
href=!href&&el.parentNode?el.parentNode.href:href;
if(!href){
href=el.getAttribute('href')
}
if(href&&href.split('preview/').length>1&&href.indexOf('previewbackup=true')===-1){
pageId=href.split('preview/')[1].replace('.html','');
event.preventDefault();
displayPreview(frame,pageId)
}
if(web.utils.String.isExternal(href)||/^mailto:/i.test(href)){
event.preventDefault()
}
},this)
},parent=frame.parentNode,newFrame=document.createElement('iframe');
newFrame.className=frame.className;
newFrame.style.height=frame.style.height;
newFrame.style.display='block';
parent.removeChild(frame);
parent.appendChild(newFrame);
frame=newFrame;
frame.onload=frameLoad;
frame.setAttribute('allowfullscreen','true');
writeFrame(frame)
}
if(!panel.previewRendered){
panel.previewRendered=true;
doc=new web.Document({
dm:app.dm,
domain:app.dal.domain,
forceMobile:true,
previewMode:true,
previewTarget:panel instanceof web.ui.MobileContainer?'mobile':'desktop',
targetPreviewMode:this.previewMobile.targetPreviewMode,
hdImages:app.user.subscriptionStatus===web.UserSubscriptionStatus.PREMIUM
});
page.render(doc);
if(panel.el){
initFrame(panel,page)
}else{
panel.on('render',function(){
initFrame(panel,page)
})
}
}
},
getTimeline:function(threshold,cb){
var that=this;
var limit=that.app.userHasFullBackupRestoreAccess()?null:21;
this.app.dal.getTimeline(threshold||10000||10000,limit,function(opts,success,response){
if(success&&response.responseText){
var data=Ext.decode(response.responseText),timeline=data.timeline||[];
if(timeline.length){
var compareObjects=function(a,b){
if(a.time>b.time){
return-1
}
if(a.time<b.time){
return 1
}
return 0
};
timeline=timeline.sort(compareObjects);
var snapshots=that.timelineToSnapshots(timeline),latestSnapshotTime=timeline[0]&&timeline[0].time;
cb(opts,true,snapshots,latestSnapshotTime)
}else{
one.fatal('Custom - Timeline was empty');
one.error('Something went wrong. Please try again later.','An error occurred');
cb(opts,false,null)
}
}else{
one.fatal('Custom - Could not get timeline with saved backups');
one.error('Something went wrong. Please try again later.','An error occurred');
cb(opts,false,null)
}
})
},
getDate:function(whichDay,now){
now=now||new Date;
var today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
if(whichDay==='yesterday'){
return new Date(new Date(today).setDate(today.getDate()-1))
}else if(whichDay==='tomorrow'){
return new Date(new Date(today).setDate(today.getDate()+1))
}else{
return today
}
},
renderRelativeDateTime:function(timestamp,mode,now){
var d=new Date(timestamp);
mode=mode||'dateTime';
now=now||new Date;
var today=this.getDate('today',now),tomorrow=this.getDate('tomorrow',now),yesterday=this.getDate('yesterday',now);
var response;
if(yesterday<=d&&d<tomorrow){
if(d>=today){
response='Today'
}else{
response='Yesterday'
}
response=mode==='date'?response:response+' '+one.locale.renderDate(d,'mediumTime')
}else{
response=mode==='date'?one.locale.renderDate(d,'mediumDate'):one.locale.renderDate(d,'mediumDateTime')
}
return response
},
timelineToSnapshots:function(timeline){
var that=this;
if(timeline.length>=2){
timeline=timeline.slice(0,-1)
}
that.backupsViewLoadedAt=new Date;
var now=that.backupsViewLoadedAt,today=this.getDate('today',now);
var onlyToday=that.app.userHasFullBackupRestoreAccess()?false:true;
if(onlyToday){
timeline=timeline.filter(function(entry){
if(entry.time>=today){
return true
}
return false
})
}
var timelineEntries=[];
timeline.forEach(function(entry){
var d=new Date(entry.time);
timelineEntries.push({
time:entry.time,
ISODate:Ext.util.Format.date(d,'Y-m-d'),
localeDate:one.locale.renderDate(d,'mediumDate'),
formattedDate:that.renderRelativeDateTime(entry.time,'date',that.backupsViewLoadedAt),
published:entry.published
})
});
var timelineEntriesGroups={};
timelineEntries.forEach(function(timelineEntry){
var ISODate=timelineEntry.ISODate;
timelineEntriesGroups[ISODate]=timelineEntriesGroups[ISODate]||[];
timelineEntriesGroups[ISODate].push(timelineEntry)
});
var snapshots=[];
Object.keys(timelineEntriesGroups).sort().reverse().forEach(function(key,index,arr){
var timelineEntriesGroup=timelineEntriesGroups[key];
var ob={
type:'directory',
text:timelineEntriesGroup[0].formattedDate,
title:timelineEntriesGroup[0].localeDate.toUpperCase(),
files:[]
};
timelineEntriesGroup.forEach(function(timelineEntry){
var mediumTime=one.locale.renderDate(new Date(timelineEntry.time),'mediumTime');
ob.files.push({
type:'file',
text:mediumTime,
html:mediumTime+(timelineEntry.published?'<span style="color:#aaa"> - '+'Published'+'</div>':''),
title:one.locale.renderDate(new Date(timelineEntry.time),'mediumDateTime').toUpperCase(),
value:timelineEntry.time
})
});
snapshots.push(ob)
});
return snapshots
},
cleanup:function(){
oneJQuery(this.el.dom).find('iframe').attr('src','about:blank')
}
});
web.ui.WelcomeMessageBanner=Ext.extend(Ext.Container,{
constructor:function(config){
this.layout={type:'vflex'};
this.bannerText=new Ext.Container({html:'<div><div class=title>Welcome to Website Builder!</div><div class="para old-users">Join thousands of other people that have made awesome websites using Website Builder.</div><div class="para new-users">Select a template and get started.</div><div class="para old-users">Remember you can always change to another template later on.</div><div class="para new-users">You can upgrade to Website Builder Premium if you need more than 5 pages and other great features.</div><div class="premium-link para new-users"><a href=# onclick=web.upgradeToPremiumViaPopup({app:one.viewport.application});>Read more about Premium</a></div></div>'});
this.closeButton=new Ext.Button({
text:'<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-close\' style=\'position: relative; width: 12px; height: 12px;\'>',
tooltip:'Close',
cls:'round-button',
handler:function(){
oneJQuery(this.el.dom).fadeOut()
},
scope:this
});
this.items=[
this.closeButton,
this.bannerText
];
web.ui.WelcomeMessageBanner.superclass.constructor.call(this,config)
}
});
Ext.ComponentMgr.registerType('web-ui-welcome-message-banner',web.ui.WelcomeMessageBanner);
web.ui.TemplateCategories=Ext.extend(Ext.Container,{
constructor:function(config){
var that=this;
this.buttonArray=[];
[{
'id':'all',
'text':'All',
'cls':'selected'
}].concat(web.ui.TemplateCategories.List).filter(function(item){
return!item.hidden
}).forEach(function(item){
that.buttonArray.push({
xtype:'spacer',
width:5
});
that.buttonArray.push({
xtype:'button',
id:item.id,
text:item.text,
cls:'category '+(item.cls?item.cls:''),
handler:function(btn,evt){
this.fireEvent('selected',btn.id)
},
scope:that
});
that.buttonArray.push({
xtype:'spacer',
width:20
})
});
this.items=[{
xtype:'container',
layout:'hbox',
layoutConfig:{pack:'end'},
items:this.buttonArray
}];
web.ui.TemplateCategories.superclass.constructor.call(this,config);
this.bindListeners()
},
bindListeners:function(){
this.on('selected',this.hilightSelection,this)
},
hilightSelection:function(id){
Ext.query('[data-xtype=web-ui-template-categories] .category').forEach(function(b){
if(b.id===id){
Ext.fly(b).addClass('selected')
}else{
Ext.fly(b).removeClass('selected')
}
})
},
setSelected:function(id,suppressEvent){
this.hilightSelection(id);
if(!suppressEvent){
this.fireEvent('selected',id)
}
}
});
web.ui.TemplateCategories.List=[
{
'id':'business_and_services',
'text':'Business & Services'
},
{
'id':'portfolios',
'text':'Portfolio & CV'
},
{
'id':'family_and_recreation',
'text':'Family & Recreation'
},
{
'id':'food_and_hospitality',
'text':'Food & Hospitality'
},
{
'id':'events',
'text':'Events'
},
{
'id':'music',
'text':'Music & Art'
},
{
'id':'online_store',
'text':'Webshop'
},
{
'id':'premium',
'text':'Premium',
'hidden':true
}
];
Ext.ComponentMgr.registerType('web-ui-template-categories',web.ui.TemplateCategories);
Ext.ns('web');
web.upgradeToPremiumViaPopup=function(cfg){
var app=cfg.app,source=cfg.source;
var location=window.location,origin=location.origin||location.protocol+'//'+location.hostname+(location.port?':'+location.port:''),domain=app.dal.domain,basePath=origin+'/api/v1/'+domain+'/upgradeToPremium/',url=basePath+'initiate'+'?successUrl='+encodeURIComponent(basePath+'complete')+'&'+new Date().getTime();
window.open(url,'Initiate upgrade to premium','height=935,width=1045,scrollbars=yes,resizable=yes',true).focus();
var freePrefix=app.user.freeUpgradeAvailable?'free':'';
app.trackEvent({
eventCategory:'UpgradeToPremium',
eventAction:freePrefix+'upgrade.init',
eventLabel:source
});
if(!web.upgradeToPremiumViaPopup.listeningToMessage){
window.addEventListener('message',function(event){
web.upgradeToPremiumViaPopup.upgradeComplete(event,app)
},false)
}
web.upgradeToPremiumViaPopup.listeningToMessage=true
};
web.upgradeToPremiumViaPopup.upgradeComplete=function(event,app){
if(event.origin!==web.utils.Dom.getWindowOrigin(window)){
return
}
var data=event.data;
var freePrefix=app.user.freeUpgradeAvailable?'free':'';
if(data.purpose!=='upgrade-to-premium'){
return
}
if(data.status===200){
app.user.subscriptionStatus=web.UserSubscriptionStatus.PREMIUM;
app.updatePremiumUI();
oneJQuery('body').addClass('hide-upgrade-options');
app.trackEvent({
eventCategory:'UpgradeToPremium',
eventAction:freePrefix+'upgrade.complete',
eventLabel:data.status
})
}else{
one.fatal('Unexpected status for upgrade to premium: ',data);
app.trackEvent({
eventCategory:'UpgradeToPremium',
eventAction:freePrefix+'upgrade.unexpectedStatus',
eventLabel:data.status
})
}
};
(function(factory){
'use strict';
if(typeof define==='function'&&define.amd){
define(['jquery'],factory)
}else if(typeof exports==='object'){
factory(require('jquery'))
}else{
factory(oneJQuery)
}
}(function($){
'use strict';
function int(x){
if(typeof x==='string'){
return parseInt(x,10)
}else{
return~~x
}
}
var defaultSettings={
wheelSpeed:1,
wheelPropagation:false,
minScrollbarLength:null,
maxScrollbarLength:null,
useBothWheelAxes:false,
useKeyboard:true,
suppressScrollX:false,
suppressScrollY:false,
scrollXMarginOffset:0,
scrollYMarginOffset:0,
includePadding:false
};
var incrementingId=0;
var eventClassFactory=function(){
var id=incrementingId++;
return function(eventName){
var className='.perfect-scrollbar-'+id;
if(typeof eventName==='undefined'){
return className
}else{
return eventName+className
}
}
};
$.fn.perfectScrollbar=function(suppliedSettings,option){
return this.each(function(){
var settings=$.extend(true,{},defaultSettings);
var $this=$(this);
var isPluginAlive=function(){
return!!$this
};
if(typeof suppliedSettings==='object'){
$.extend(true,settings,suppliedSettings)
}else{
option=suppliedSettings
}
if(option==='update'){
if($this.data('perfect-scrollbar-update')){
$this.data('perfect-scrollbar-update')()
}
return $this
}else if(option==='destroy'){
if($this.data('perfect-scrollbar-destroy')){
$this.data('perfect-scrollbar-destroy')()
}
return $this
}
if($this.data('perfect-scrollbar')){
return $this.data('perfect-scrollbar')
}
$this.addClass('ps-container');
var containerWidth;
var containerHeight;
var contentWidth;
var contentHeight;
var isRtl=$this.css('direction')==='rtl';
var eventClass=eventClassFactory();
var ownerDocument=this.ownerDocument||document;
var $scrollbarXRail=$('<div class=\'ps-scrollbar-x-rail\'>').appendTo($this);
var $scrollbarX=$('<div class=\'ps-scrollbar-x\'>').appendTo($scrollbarXRail);
var scrollbarXActive;
var scrollbarXWidth;
var scrollbarXLeft;
var scrollbarXBottom=int($scrollbarXRail.css('bottom'));
var isScrollbarXUsingBottom=scrollbarXBottom===scrollbarXBottom;
var scrollbarXTop=isScrollbarXUsingBottom?null:int($scrollbarXRail.css('top'));
var railBorderXWidth=int($scrollbarXRail.css('borderLeftWidth'))+int($scrollbarXRail.css('borderRightWidth'));
var $scrollbarYRail=$('<div class=\'ps-scrollbar-y-rail\'>').appendTo($this);
var $scrollbarY=$('<div class=\'ps-scrollbar-y\'>').appendTo($scrollbarYRail);
var scrollbarYActive;
var scrollbarYHeight;
var scrollbarYTop;
var scrollbarYRight=int($scrollbarYRail.css('right'));
var isScrollbarYUsingRight=scrollbarYRight===scrollbarYRight;
var scrollbarYLeft=isScrollbarYUsingRight?null:int($scrollbarYRail.css('left'));
var railBorderYWidth=int($scrollbarYRail.css('borderTopWidth'))+int($scrollbarYRail.css('borderBottomWidth'));
function updateScrollTop(currentTop,deltaY){
var newTop=currentTop+deltaY;
var maxTop=containerHeight-scrollbarYHeight;
if(newTop<0){
scrollbarYTop=0
}else if(newTop>maxTop){
scrollbarYTop=maxTop
}else{
scrollbarYTop=newTop
}
var scrollTop=int(scrollbarYTop*(contentHeight-containerHeight)/(containerHeight-scrollbarYHeight));
$this.scrollTop(scrollTop)
}
function updateScrollLeft(currentLeft,deltaX){
var newLeft=currentLeft+deltaX;
var maxLeft=containerWidth-scrollbarXWidth;
if(newLeft<0){
scrollbarXLeft=0
}else if(newLeft>maxLeft){
scrollbarXLeft=maxLeft
}else{
scrollbarXLeft=newLeft
}
var scrollLeft=int(scrollbarXLeft*(contentWidth-containerWidth)/(containerWidth-scrollbarXWidth));
$this.scrollLeft(scrollLeft)
}
function getThumbSize(thumbSize){
if(settings.minScrollbarLength){
thumbSize=Math.max(thumbSize,settings.minScrollbarLength)
}
if(settings.maxScrollbarLength){
thumbSize=Math.min(thumbSize,settings.maxScrollbarLength)
}
return thumbSize
}
function updateCss(){
var xRailOffset={
width:containerWidth,
display:scrollbarXActive?'inherit':'none'
};
if(isRtl){
xRailOffset.left=$this.scrollLeft()+containerWidth-contentWidth
}else{
xRailOffset.left=$this.scrollLeft()
}
if(isScrollbarXUsingBottom){
xRailOffset.bottom=scrollbarXBottom-$this.scrollTop()
}else{
xRailOffset.top=scrollbarXTop+$this.scrollTop()
}
$scrollbarXRail.css(xRailOffset);
var railYOffset={
top:$this.scrollTop(),
height:containerHeight,
display:scrollbarYActive?'inherit':'none'
};
if(isScrollbarYUsingRight){
if(isRtl){
railYOffset.right=contentWidth-$this.scrollLeft()-scrollbarYRight-$scrollbarY.outerWidth()
}else{
railYOffset.right=scrollbarYRight-$this.scrollLeft()
}
}else{
if(isRtl){
railYOffset.left=$this.scrollLeft()+containerWidth*2-contentWidth-scrollbarYLeft-$scrollbarY.outerWidth()
}else{
railYOffset.left=scrollbarYLeft+$this.scrollLeft()
}
}
$scrollbarYRail.css(railYOffset);
$scrollbarX.css({
left:scrollbarXLeft,
width:scrollbarXWidth-railBorderXWidth
});
$scrollbarY.css({
top:scrollbarYTop,
height:scrollbarYHeight-railBorderYWidth
})
}
function updateGeometry(){
$this.removeClass('ps-active-x');
$this.removeClass('ps-active-y');
containerWidth=settings.includePadding?$this.innerWidth():$this.width();
containerHeight=settings.includePadding?$this.innerHeight():$this.height();
contentWidth=$this.prop('scrollWidth');
contentHeight=$this.prop('scrollHeight');
if(!settings.suppressScrollX&&containerWidth+settings.scrollXMarginOffset<contentWidth){
scrollbarXActive=true;
scrollbarXWidth=getThumbSize(int(containerWidth*containerWidth/contentWidth));
scrollbarXLeft=int($this.scrollLeft()*(containerWidth-scrollbarXWidth)/(contentWidth-containerWidth))
}else{
scrollbarXActive=false;
scrollbarXWidth=0;
scrollbarXLeft=0;
$this.scrollLeft(0)
}
if(!settings.suppressScrollY&&containerHeight+settings.scrollYMarginOffset<contentHeight){
scrollbarYActive=true;
scrollbarYHeight=getThumbSize(int(containerHeight*containerHeight/contentHeight));
scrollbarYTop=int($this.scrollTop()*(containerHeight-scrollbarYHeight)/(contentHeight-containerHeight))
}else{
scrollbarYActive=false;
scrollbarYHeight=0;
scrollbarYTop=0;
$this.scrollTop(0)
}
if(scrollbarXLeft>=containerWidth-scrollbarXWidth){
scrollbarXLeft=containerWidth-scrollbarXWidth
}
if(scrollbarYTop>=containerHeight-scrollbarYHeight){
scrollbarYTop=containerHeight-scrollbarYHeight
}
updateCss();
if(scrollbarXActive){
$this.addClass('ps-active-x')
}
if(scrollbarYActive){
$this.addClass('ps-active-y')
}
}
function bindMouseScrollXHandler(){
var currentLeft;
var currentPageX;
var inScrolling=false;
$scrollbarX.bind(eventClass('mousedown'),function(e){
currentPageX=e.pageX;
currentLeft=$scrollbarX.position().left;
$scrollbarXRail.addClass('in-scrolling');
inScrolling=true;
e.stopPropagation();
e.preventDefault()
});
$(ownerDocument).bind(eventClass('mousemove'),function(e){
if(inScrolling){
updateScrollLeft(currentLeft,e.pageX-currentPageX);
updateGeometry();
e.stopPropagation();
e.preventDefault()
}
});
$(ownerDocument).bind(eventClass('mouseup'),function(e){
if(inScrolling){
inScrolling=false;
$scrollbarXRail.removeClass('in-scrolling')
}
});
currentLeft=currentPageX=null
}
function bindMouseScrollYHandler(){
var currentTop;
var currentPageY;
var inScrolling=false;
$scrollbarY.bind(eventClass('mousedown'),function(e){
currentPageY=e.pageY;
currentTop=$scrollbarY.position().top;
inScrolling=true;
$scrollbarYRail.addClass('in-scrolling');
e.stopPropagation();
e.preventDefault()
});
$(ownerDocument).bind(eventClass('mousemove'),function(e){
if(inScrolling){
updateScrollTop(currentTop,e.pageY-currentPageY);
updateGeometry();
e.stopPropagation();
e.preventDefault()
}
});
$(ownerDocument).bind(eventClass('mouseup'),function(e){
if(inScrolling){
inScrolling=false;
$scrollbarYRail.removeClass('in-scrolling')
}
});
currentTop=currentPageY=null
}
function shouldPreventDefault(deltaX,deltaY){
var scrollTop=$this.scrollTop();
if(deltaX===0){
if(!scrollbarYActive){
return false
}
if(scrollTop===0&&deltaY>0||scrollTop>=contentHeight-containerHeight&&deltaY<0){
return!settings.wheelPropagation
}
}
var scrollLeft=$this.scrollLeft();
if(deltaY===0){
if(!scrollbarXActive){
return false
}
if(scrollLeft===0&&deltaX<0||scrollLeft>=contentWidth-containerWidth&&deltaX>0){
return!settings.wheelPropagation
}
}
return true
}
function bindMouseWheelHandler(){
var shouldPrevent=false;
function getDeltaFromEvent(e){
var deltaX=e.originalEvent.deltaX;
var deltaY=-1*e.originalEvent.deltaY;
if(typeof deltaX==='undefined'||typeof deltaY==='undefined'){
deltaX=-1*e.originalEvent.wheelDeltaX/6;
deltaY=e.originalEvent.wheelDeltaY/6
}
if(e.originalEvent.deltaMode&&e.originalEvent.deltaMode===1){
deltaX*=10;
deltaY*=10
}
if(deltaX!==deltaX&&deltaY!==deltaY){
deltaX=0;
deltaY=e.originalEvent.wheelDelta
}
return[
deltaX,
deltaY
]
}
function mousewheelHandler(e){
var delta=getDeltaFromEvent(e);
var deltaX=delta[0];
var deltaY=delta[1];
shouldPrevent=false;
if(!settings.useBothWheelAxes){
$this.scrollTop($this.scrollTop()-deltaY*settings.wheelSpeed);
$this.scrollLeft($this.scrollLeft()+deltaX*settings.wheelSpeed)
}else if(scrollbarYActive&&!scrollbarXActive){
if(deltaY){
$this.scrollTop($this.scrollTop()-deltaY*settings.wheelSpeed)
}else{
$this.scrollTop($this.scrollTop()+deltaX*settings.wheelSpeed)
}
shouldPrevent=true
}else if(scrollbarXActive&&!scrollbarYActive){
if(deltaX){
$this.scrollLeft($this.scrollLeft()+deltaX*settings.wheelSpeed)
}else{
$this.scrollLeft($this.scrollLeft()-deltaY*settings.wheelSpeed)
}
shouldPrevent=true
}
updateGeometry();
shouldPrevent=shouldPrevent||shouldPreventDefault(deltaX,deltaY);
if(shouldPrevent){
e.stopPropagation();
e.preventDefault()
}
}
if(typeof window.onwheel!=='undefined'){
$this.bind(eventClass('wheel'),mousewheelHandler)
}else if(typeof window.onmousewheel!=='undefined'){
$this.bind(eventClass('mousewheel'),mousewheelHandler)
}
}
function bindKeyboardHandler(){
var hovered=false;
$this.bind(eventClass('mouseenter'),function(e){
hovered=true
});
$this.bind(eventClass('mouseleave'),function(e){
hovered=false
});
var shouldPrevent=false;
$(ownerDocument).bind(eventClass('keydown'),function(e){
if(e.isDefaultPrevented&&e.isDefaultPrevented()){
return
}
if(!hovered){
return
}
var activeElement=document.activeElement?document.activeElement:ownerDocument.activeElement;
while(activeElement.shadowRoot){
activeElement=activeElement.shadowRoot.activeElement
}
if($(activeElement).is(':input,[contenteditable]')){
return
}
var deltaX=0;
var deltaY=0;
switch(e.which){
case 37:
deltaX=-30;
break;
case 38:
deltaY=30;
break;
case 39:
deltaX=30;
break;
case 40:
deltaY=-30;
break;
case 33:
deltaY=90;
break;
case 32:
case 34:
deltaY=-90;
break;
case 35:
if(e.ctrlKey){
deltaY=-contentHeight
}else{
deltaY=-containerHeight
}
break;
case 36:
if(e.ctrlKey){
deltaY=$this.scrollTop()
}else{
deltaY=containerHeight
}
break;
default:
return
}
$this.scrollTop($this.scrollTop()-deltaY);
$this.scrollLeft($this.scrollLeft()+deltaX);
shouldPrevent=shouldPreventDefault(deltaX,deltaY);
if(shouldPrevent){
e.preventDefault()
}
})
}
function bindRailClickHandler(){
function stopPropagation(e){
e.stopPropagation()
}
$scrollbarY.bind(eventClass('click'),stopPropagation);
$scrollbarYRail.bind(eventClass('click'),function(e){
var halfOfScrollbarLength=int(scrollbarYHeight/2);
var positionTop=e.pageY-$scrollbarYRail.offset().top-halfOfScrollbarLength;
var maxPositionTop=containerHeight-scrollbarYHeight;
var positionRatio=positionTop/maxPositionTop;
if(positionRatio<0){
positionRatio=0
}else if(positionRatio>1){
positionRatio=1
}
$this.scrollTop((contentHeight-containerHeight)*positionRatio)
});
$scrollbarX.bind(eventClass('click'),stopPropagation);
$scrollbarXRail.bind(eventClass('click'),function(e){
var halfOfScrollbarLength=int(scrollbarXWidth/2);
var positionLeft=e.pageX-$scrollbarXRail.offset().left-halfOfScrollbarLength;
var maxPositionLeft=containerWidth-scrollbarXWidth;
var positionRatio=positionLeft/maxPositionLeft;
if(positionRatio<0){
positionRatio=0
}else if(positionRatio>1){
positionRatio=1
}
$this.scrollLeft((contentWidth-containerWidth)*positionRatio)
})
}
function bindSelectionHandler(){
function getRangeNode(){
var selection=window.getSelection?window.getSelection():document.getSlection?document.getSlection():{rangeCount:0};
if(selection.rangeCount===0){
return null
}else{
return selection.getRangeAt(0).commonAncestorContainer
}
}
var scrollingLoop=null;
var scrollDiff={
top:0,
left:0
};
function startScrolling(){
if(!scrollingLoop){
scrollingLoop=setInterval(function(){
if(!isPluginAlive()){
clearInterval(scrollingLoop);
return
}
$this.scrollTop($this.scrollTop()+scrollDiff.top);
$this.scrollLeft($this.scrollLeft()+scrollDiff.left);
updateGeometry()
},50)
}
}
function stopScrolling(){
if(scrollingLoop){
clearInterval(scrollingLoop);
scrollingLoop=null
}
$scrollbarXRail.removeClass('in-scrolling');
$scrollbarYRail.removeClass('in-scrolling')
}
var isSelected=false;
$(ownerDocument).bind(eventClass('selectionchange'),function(e){
if($.contains($this[0],getRangeNode())){
isSelected=true
}else{
isSelected=false;
stopScrolling()
}
});
$(window).bind(eventClass('mouseup'),function(e){
if(isSelected){
isSelected=false;
stopScrolling()
}
});
$(window).bind(eventClass('mousemove'),function(e){
if(isSelected){
var mousePosition={
x:e.pageX,
y:e.pageY
};
var containerOffset=$this.offset();
var containerGeometry={
left:containerOffset.left,
right:containerOffset.left+$this.outerWidth(),
top:containerOffset.top,
bottom:containerOffset.top+$this.outerHeight()
};
if(mousePosition.x<containerGeometry.left+3){
scrollDiff.left=-5;
$scrollbarXRail.addClass('in-scrolling')
}else if(mousePosition.x>containerGeometry.right-3){
scrollDiff.left=5;
$scrollbarXRail.addClass('in-scrolling')
}else{
scrollDiff.left=0
}
if(mousePosition.y<containerGeometry.top+3){
if(containerGeometry.top+3-mousePosition.y<5){
scrollDiff.top=-5
}else{
scrollDiff.top=-20
}
$scrollbarYRail.addClass('in-scrolling')
}else if(mousePosition.y>containerGeometry.bottom-3){
if(mousePosition.y-containerGeometry.bottom+3<5){
scrollDiff.top=5
}else{
scrollDiff.top=20
}
$scrollbarYRail.addClass('in-scrolling')
}else{
scrollDiff.top=0
}
if(scrollDiff.top===0&&scrollDiff.left===0){
stopScrolling()
}else{
startScrolling()
}
}
})
}
function bindTouchHandler(supportsTouch,supportsIePointer){
function applyTouchMove(differenceX,differenceY){
$this.scrollTop($this.scrollTop()-differenceY);
$this.scrollLeft($this.scrollLeft()-differenceX);
updateGeometry()
}
var startOffset={};
var startTime=0;
var speed={};
var easingLoop=null;
var inGlobalTouch=false;
var inLocalTouch=false;
function globalTouchStart(e){
inGlobalTouch=true
}
function globalTouchEnd(e){
inGlobalTouch=false
}
function getTouch(e){
if(e.originalEvent.targetTouches){
return e.originalEvent.targetTouches[0]
}else{
return e.originalEvent
}
}
function shouldHandle(e){
var event=e.originalEvent;
if(event.targetTouches&&event.targetTouches.length===1){
return true
}
if(event.pointerType&&event.pointerType!=='mouse'&&event.pointerType!==event.MSPOINTER_TYPE_MOUSE){
return true
}
return false
}
function touchStart(e){
if(shouldHandle(e)){
inLocalTouch=true;
var touch=getTouch(e);
startOffset.pageX=touch.pageX;
startOffset.pageY=touch.pageY;
startTime=new Date().getTime();
if(easingLoop!==null){
clearInterval(easingLoop)
}
e.stopPropagation()
}
}
function touchMove(e){
if(!inGlobalTouch&&inLocalTouch&&shouldHandle(e)){
var touch=getTouch(e);
var currentOffset={
pageX:touch.pageX,
pageY:touch.pageY
};
var differenceX=currentOffset.pageX-startOffset.pageX;
var differenceY=currentOffset.pageY-startOffset.pageY;
applyTouchMove(differenceX,differenceY);
startOffset=currentOffset;
var currentTime=new Date().getTime();
var timeGap=currentTime-startTime;
if(timeGap>0){
speed.x=differenceX/timeGap;
speed.y=differenceY/timeGap;
startTime=currentTime
}
e.stopPropagation();
e.preventDefault()
}
}
function touchEnd(e){
if(!inGlobalTouch&&inLocalTouch){
inLocalTouch=false;
clearInterval(easingLoop);
easingLoop=setInterval(function(){
if(!isPluginAlive()){
clearInterval(easingLoop);
return
}
if(Math.abs(speed.x)<0.01&&Math.abs(speed.y)<0.01){
clearInterval(easingLoop);
return
}
applyTouchMove(speed.x*30,speed.y*30);
speed.x*=0.8;
speed.y*=0.8
},10)
}
}
if(supportsTouch){
$(window).bind(eventClass('touchstart'),globalTouchStart);
$(window).bind(eventClass('touchend'),globalTouchEnd);
$this.bind(eventClass('touchstart'),touchStart);
$this.bind(eventClass('touchmove'),touchMove);
$this.bind(eventClass('touchend'),touchEnd)
}
if(supportsIePointer){
if(window.PointerEvent){
$(window).bind(eventClass('pointerdown'),globalTouchStart);
$(window).bind(eventClass('pointerup'),globalTouchEnd);
$this.bind(eventClass('pointerdown'),touchStart);
$this.bind(eventClass('pointermove'),touchMove);
$this.bind(eventClass('pointerup'),touchEnd)
}else if(window.MSPointerEvent){
$(window).bind(eventClass('MSPointerDown'),globalTouchStart);
$(window).bind(eventClass('MSPointerUp'),globalTouchEnd);
$this.bind(eventClass('MSPointerDown'),touchStart);
$this.bind(eventClass('MSPointerMove'),touchMove);
$this.bind(eventClass('MSPointerUp'),touchEnd)
}
}
}
function bindScrollHandler(){
$this.bind(eventClass('scroll'),function(e){
updateGeometry()
})
}
function destroy(){
$this.unbind(eventClass());
$(window).unbind(eventClass());
$(ownerDocument).unbind(eventClass());
$this.data('perfect-scrollbar',null);
$this.data('perfect-scrollbar-update',null);
$this.data('perfect-scrollbar-destroy',null);
$scrollbarX.remove();
$scrollbarY.remove();
$scrollbarXRail.remove();
$scrollbarYRail.remove();
$this=$scrollbarXRail=$scrollbarYRail=$scrollbarX=$scrollbarY=scrollbarXActive=scrollbarYActive=containerWidth=containerHeight=contentWidth=contentHeight=scrollbarXWidth=scrollbarXLeft=scrollbarXBottom=isScrollbarXUsingBottom=scrollbarXTop=scrollbarYHeight=scrollbarYTop=scrollbarYRight=isScrollbarYUsingRight=scrollbarYLeft=isRtl=eventClass=null
}
var supportsTouch='ontouchstart'in window||window.DocumentTouch&&document instanceof window.DocumentTouch;
var supportsIePointer=window.navigator.msMaxTouchPoints!==null;
function initialize(){
updateGeometry();
bindScrollHandler();
bindMouseScrollXHandler();
bindMouseScrollYHandler();
bindRailClickHandler();
bindSelectionHandler();
bindMouseWheelHandler();
if(supportsTouch||supportsIePointer){
bindTouchHandler(supportsTouch,supportsIePointer)
}
if(settings.useKeyboard){
bindKeyboardHandler()
}
$this.data('perfect-scrollbar',$this);
$this.data('perfect-scrollbar-update',updateGeometry);
$this.data('perfect-scrollbar-destroy',destroy)
}
initialize();
return $this
})
}
}));
window.PAGEINDEX_HOME=0;
window.PAGEINDEX_ABOUT=1;
web.panels.TemplateSelector=Ext.extend(Ext.Container,{
initComponent:function(config){
var that=this;
this.withModified=true;
this.height='100%';
this.imageObj=null;
this.cls='web-panels-templateselector';
this.layout='vbox';
this.layoutConfig={align:'stretch'};
this.tmplListListeners={
selectionchange:this.onSelectionChange,
scope:this
};
this.btnDesktopView=new Ext.Button({
text:'<img class="icon icon-mode-desktop-preview" src="'+Ext.BLANK_IMAGE_URL+'"/>'+'Desktop',
tooltip:'Preview what the site will look like on a normal screen size like a desktop computer.',
cls:'preview-btn-tab',
itemId:'desktopView',
toggleHandler:function(b,pressed){
if(pressed){
that.setPreviewMode('desktop');
that.updatePreviewByMode()
}
},
listeners:{
afterrender:function(btn){
btn.toggle(true,true)
}
},
scope:this,
enableToggle:true,
allowDepress:false,
toggleGroup:'templatePreviewMode',
height:44
});
this.btnMobileView=new Ext.Button({
text:'<img class="icon icon-mode-mobile-preview" src="'+Ext.BLANK_IMAGE_URL+'"/>'+'Mobile',
tooltip:'Preview what the site will look like on a small screen size like a mobile phone.',
cls:'preview-btn-tab',
itemId:'mobileView',
toggleHandler:function(b,pressed){
if(pressed){
that.setPreviewMode(that.getLastPreviewMobileMode());
that.updatePreviewByMode()
}
},
scope:this,
enableToggle:true,
allowDepress:false,
toggleGroup:'templatePreviewMode',
height:44
});
this.btnBackFromPreview=new Ext.Button({
text:'<img class="icon icon-back" src="'+Ext.BLANK_IMAGE_URL+'"/>',
cls:'back-button x-btn-secondary large wide',
handler:function(){
this.switchCard(0)
},
scope:this
});
this.btnSelectThisTemplate=new Ext.Button({
text:'',
textImportTemplate:'Import template',
textStartWith:'Start with this design',
cls:'template-selector-button x-btn-primary large wide',
handler:function(){
this.handleSelectTemplate()
},
scope:this
});
this.linkThisIsPremium=new Ext.Container({
cls:'helptext-premium-template premium-link upgrade-option-visibility',
html:'This is a Premium template. <a href="#" onclick="web.upgradeToPremiumViaPopup({app:one.viewport.application,source:\'TemplateSelector:ReadMoreLink\'});">Read more about Premium</a>'
});
this.btnBackMain=new Ext.Button({
text:'<img class="icon icon-back" src="'+Ext.BLANK_IMAGE_URL+'"/>',
cls:'back-button x-btn-secondary large wide',
handler:function(){
this.templateSelectorList.fireEvent('cancel');
this.app.fireEvent('activate','workspace')
},
scope:this
});
this.btnUpgradeToPremium=new Ext.Button({
text:'<span class="no-free-upgrade-offer">Upgrade to Premium</span><span class="free-upgrade-offer">Upgrade to Premium for free</span>',
cls:'x-btn-premium outline large upgrade-option',
handler:function(){
web.upgradeToPremiumViaPopup({
app:this.app,
source:'TemplateSelector:UpgradeBtn'
})
},
scope:this
});
this.previewHolder=new Ext.Container({
xtype:'container',
flex:1,
cls:'template-preview-body desktop-view vbox',
autoScroll:true,
items:[{
ref:'../../preview',
xtype:'container',
cls:'web-templateImagePreview',
html:'<div class="mobile-scroller"><div class="image-preview"><img></div></div>',
listeners:{
scope:this,
afterlayout:function(c){
this.verticallyMiddleAlign()
}
}
}]
});
this.textTemplatesHeading=new Ext.Container({
html:'Select a template',
cls:'themes-title'
});
this.textBrowseThe=new Ext.Container({
html:'Browse the categories and select the perfect look for your website.',
cls:'themes-desc'
});
this.items=[
{
id:'live-preview-card',
ref:'cardLivePreview',
xtype:'container',
style:{height:'100%'},
items:[
{
xtype:'container',
cls:'ts-preview-header-container',
layout:'hbox',
items:[
this.btnBackFromPreview,
{
xtype:'spacer',
width:20
},
this.btnSelectThisTemplate,
this.linkThisIsPremium,
{
xtype:'spacer',
flex:1,
height:51
},
this.btnDesktopView,
{
xtype:'spacer',
width:15
},
this.btnMobileView
]
},
{
xtype:'container',
cls:'thick',
html:'<hr />'
},
this.previewHolder,
{
style:{position:'fixed'},
height:40,
width:40,
cls:'btn-rotate-mobile icon',
ref:'../rotateMobile',
hidden:true,
xtype:'button',
tooltip:'Rotate mobile phone between vertical and horizontal view.',
handler:function(){
if(this.getPreviewMode()==='mobile-vertical'){
this.setPreviewMode('mobile-horizontal')
}else{
this.setPreviewMode('mobile-vertical')
}
this.updatePreviewByMode()
},
scope:this
}
]
},
{
id:'list-card',
cls:'list-card',
ref:'cardList',
xtype:'container',
listeners:{
afterrender:this.handleScroll,
scope:this
},
items:[{
xtype:'container',
items:[
{
ref:'../../welcomeMessageBanner',
xtype:'web-ui-welcome-message-banner'
},
{
xtype:'container',
layout:'hflex',
cls:'ts-header-container',
items:[
{
xtype:'container',
ref:'../../../backButtonPanel',
items:[this.btnBackMain]
},
{
xtype:'container',
items:[
this.textTemplatesHeading,
this.textBrowseThe
],
flex:1
},
{
xtype:'container',
items:[this.btnUpgradeToPremium]
}
]
},
{
xtype:'web-ui-template-categories',
ref:'../../templateCategories',
listeners:{
selected:function(categoryId){
this.templateSelectorList.fetchData({categoryId:categoryId});
this.cardList.el.scrollTo('top',0)
},
scope:this
}
},
{
ref:'../../templateSelectorList',
xtype:'web-ui-templateselectorlist',
app:this.app,
repository:this.app.rep,
dal:this.app.dal,
category:'standard',
multiPageDownload:true,
showMultiPage:true,
templateSelector:this,
listeners:{
templateselected:this.handleSelectTemplate,
templateclickpreview:this.handlePreviewBtn,
scope:this
}
}
]
}]
}
];
this.listeners={
mobilepreviewvisibilitychange:function(hideOrShow){
if(hideOrShow==='hide'){
this.btnMobileView.hide();
this.btnDesktopView.toggle(true)
}else{
this.btnMobileView.show()
}
},
scope:this
};
web.panels.TemplateSelector.superclass.initComponent.apply(this,arguments);
this.templateSelectorList.on('selectionchange',this.onSelectionChange);
oneJQuery(window).resize(function(){
that.hackFixExtJSHeight();
that.verticallyMiddleAlign()
});
setTimeout(function(){
oneJQuery(window).trigger('resize')
},100)
},
resetUi:function(){
var ts=this.templateSelectorList;
ts.clearSelections();
ts.showMultiPage=false;
ts.multiPageDownload=true;
ts.addingPage=false;
this.switchCard(0);
var startingCategory='all';
if(/#\/category\//.test(document.location.href)){
startingCategory=document.location.href.replace(/\/$/,'').split('/').pop();
if(!web.ui.TemplateCategories.List.some(function(c){
return c.id===startingCategory
})){
startingCategory='all'
}
document.location.href=document.location.href.replace(/#[^$]+/,'#')
}
this.templateCategories.setSelected(startingCategory);
var firstTimeUser=this.app.site.folder.getItems().length===0;
var text=firstTimeUser?this.btnSelectThisTemplate.textStartWith:this.btnSelectThisTemplate.textImportTemplate;
this.btnSelectThisTemplate.setText(text);
this.handleWelcomeMessageVisibility(firstTimeUser);
if(navigator.userAgent.match(/Edge\/13\.10586/)){
if(oneJQuery('#msEdgeFix').length===0){
oneJQuery('body').append('<input id="msEdgeFix" tabindex="-1" style="position: absolute; top: -100px; left: -100px;">')
}
oneJQuery('body').append('');
oneJQuery('#msEdgeFix').click();
oneJQuery('#msEdgeFix')[0].focus();
setTimeout(function(){
oneJQuery('#msEdgeFix').remove()
},500)
}
},
switchCard:function(index){
if(index===0){
this.cardList.setVisible(true);
this.cardLivePreview.setVisible(false)
}else{
this.cardList.setVisible(false);
this.cardLivePreview.setVisible(true)
}
this.doLayout();
var that=this;
setTimeout(function(){
that.hackFixExtJSHeight()
},100)
},
handlePreviewBtn:function(selector,nodes){
var record=nodes.length?selector.getRecord(nodes[0]):null;
if(record){
this.displayPreview({
contentType:'page',
contentId:record.data.pageId,
subPageIds:record.data.subPageIds,
name:record.data.name
});
this.switchCard(1);
this.showHidePremiumControls();
this.btnDesktopView.toggle(true)
}
},
showHidePremiumControls:function(){
var ts=this.templateSelectorList;
var record=ts.getSelectedData();
var isPremiumTemplate=(record||{}).isPremium||false;
if(isPremiumTemplate){
this.cardLivePreview.addClass('premium')
}else{
this.cardLivePreview.removeClass('premium')
}
},
handleScroll:function(){
var banner=this.welcomeMessageBanner;
var cardList=this.cardList;
cardList.el.dom.addEventListener('scroll',function(){
if(cardList.el.dom.scrollTop>banner.getHeight()){
cardList.addClass('page-scrolled')
}else{
cardList.removeClass('page-scrolled')
}
})
},
setValues:function(values){
this.withModified=values.withModified===false?false:true
},
onSelectionChange:function(category,selector,record){
if(category==='standard'&&record&&record.json){
if(!selector.repositorySiteMap){
return
}
var sitemap=selector.repositorySiteMap,selectedPage=sitemap.getFolder().items[0].items.filter(function(link){
return link.pageId===record.json.pageId
})[0],pageNames=selectedPage.getLinkPages().filter(function(page){
return page.isPublic()
}).map(function(page){
return[
page.pageId,
page.name
]
});
this._pageNames=pageNames
}
},
removeOldListeners:function(listeners){
if(listeners){
var events=this.templateSelectorList.events,eventName;
for(eventName in listeners){
if(eventName!=='scope'&&events.hasOwnProperty(eventName)){
if(events[eventName].listeners&&events[eventName].listeners[0]){
var listener=events[eventName].listeners[0];
this.templateSelectorList.un(eventName,listener.fn,listener.scope)
}
}
}
}
this.addPassedListeners(this.tmplListListeners)
},
addPassedListeners:function(listeners){
if(listeners){
var that=this;
Ext.iterate(listeners,function(key,value){
if(key!=='scope'){
that.templateSelectorList.on(key,value,listeners.scope);
that.templateSelectorList.addEvents(key)
}
})
}
},
getPreviewComponent:function(){
return this.preview
},
getSelectPageContainer:function(){
return this.selectPageContainer
},
getSelectedPageId:function(){
return this._pageNames[0][0]
},
showHideSelectPage:function(showHide){
var spc=this.getSelectPageContainer();
if(showHide==='hide'){
spc.hide()
}else{
spc.show()
}
},
setPageActionLabelByContext:function(context){
var label=this.getSelectPageContainer().pageActionLabel;
if(context==='view-page'){
label.setText('View page')
}else{
label.setText('Select page')
}
},
updatePreview:function(html){
if(!html){
html='<div class="mobile-scroller"><div class="image-preview"><img></div></div>'
}
if(this.getPreviewComponent().getContentTarget()){
this.getPreviewComponent().update(html)
}
},
getPreviewHolder:function(){
return this.previewHolder
},
getLastPreviewMobileMode:function(){
return this.lastPreviewMobileMode||'mobile-vertical'
},
setLastPreviewMobileMode:function(mode){
this.lastPreviewMobileMode=mode
},
getPreviewMode:function(){
return this.previewMode
},
setPreviewMode:function(previewMode){
this.previewMode=previewMode;
if(previewMode==='mobile-vertical'||previewMode==='mobile-horizontal'){
this.setLastPreviewMobileMode(previewMode)
}
},
getCurrentContent:function(){
return this.currentContent
},
setCurrentContent:function(templateOrPage,contentId,subPageIds,name){
this.currentContent={
templateOrPage:templateOrPage,
contentId:contentId,
subPageIds:subPageIds,
name:name
}
},
verticallyMiddleAlign:function(){
var previewCompEl=this.getPreviewComponent().el;
if(!previewCompEl){
return
}
previewCompEl.setStyle('margin-top','');
var requiredHeight=previewCompEl.dom.scrollHeight,availableHeight=window.innerHeight-130,marginTop=(availableHeight-requiredHeight)/2||0,minMarginTop=15;
if(marginTop>minMarginTop){
previewCompEl.setStyle('margin-top',marginTop+'px')
}
},
scrollForBestMobileView:function(){
var hasVerticalScrollBar=function(el){
return el.offsetHeight<el.scrollHeight
},scrollableEl=this.getPreviewHolder(),preview=this.getPreviewComponent(),div=scrollableEl.el.dom;
if(div){
var needToScroll=hasVerticalScrollBar(div);
if(needToScroll){
var scrollValueForCenterAligning=17+(preview.getHeight()-scrollableEl.getHeight())/2,contentBeginsAt=145;
if(this.getPreviewMode()==='mobile-horizontal'){
contentBeginsAt=47
}
scrollableEl.el.scrollTo('top',Math.min(scrollValueForCenterAligning,contentBeginsAt))
}
}
},
scrollIntoView:function(where){
if(where==='best-mobile-view'){
this.scrollForBestMobileView()
}else{
if(this.getPreviewHolder().el){
this.getPreviewHolder().el.scrollTo('top',0)
}
}
},
updatePreviewByMode:function(){
var mode=this.previewMode,previewHolder=this.getPreviewHolder(),classToAdd='';
previewHolder.removeClass('mobile-vertical').removeClass('mobile-horizontal').removeClass('desktop-view');
if(mode==='mobile-vertical'){
classToAdd='mobile-vertical';
this.rotateMobile.show()
}else if(mode==='mobile-horizontal'){
classToAdd='mobile-horizontal';
this.rotateMobile.show()
}else{
classToAdd='desktop-view';
this.rotateMobile.hide()
}
previewHolder.addClass(classToAdd);
if(classToAdd==='desktop-view'){
this.scrollIntoView('top')
}else{
this.scrollIntoView('best-mobile-view')
}
this.displayPreview()
},
getStaticPreviewUrl:function(id,width,height){
return{
'193':{
'193':{
'0002F0CF-FFCC-48D2-A9E4-1914AB4DC1CF':'//webeditor-static.cdn-one.com/0002F0CF-FFCC-48D2-A9E4-1914AB4DC1CF.7cebfb68cd.png',
'00030EC2-BA43-431D-AA22-D0039A2A089A':'//webeditor-static.cdn-one.com/00030EC2-BA43-431D-AA22-D0039A2A089A.cd946d4c56.png',
'0003EA23-32AC-4F79-B1F4-C3E35A37763F':'//webeditor-static.cdn-one.com/0003EA23-32AC-4F79-B1F4-C3E35A37763F.b4178f98b7.png',
'00047E4B-4FBE-4D84-AD0E-6E90C3F5AF0E':'//webeditor-static.cdn-one.com/00047E4B-4FBE-4D84-AD0E-6E90C3F5AF0E.0e0c86c307.png',
'000485CB-BCA8-4131-8E2F-86F91C88DC55':'//webeditor-static.cdn-one.com/000485CB-BCA8-4131-8E2F-86F91C88DC55.ba116bc8c5.png',
'00049ABB-2008-44A4-BC15-157FE89BA34F':'//webeditor-static.cdn-one.com/00049ABB-2008-44A4-BC15-157FE89BA34F.83a8ae8bf1.png',
'00050173-F15F-4682-A552-6AA0ED9F192F':'//webeditor-static.cdn-one.com/00050173-F15F-4682-A552-6AA0ED9F192F.be89a7359d.png',
'00051CAB-9B31-4F73-A089-8A585C5E4B62':'//webeditor-static.cdn-one.com/00051CAB-9B31-4F73-A089-8A585C5E4B62.8d9f757737.png',
'000589E2-CE21-499A-8DC4-71964CC9F4A0':'//webeditor-static.cdn-one.com/000589E2-CE21-499A-8DC4-71964CC9F4A0.64c31e7cc8.png',
'0006F00F-CCE8-4D55-8A97-7B421ED8CDCA':'//webeditor-static.cdn-one.com/0006F00F-CCE8-4D55-8A97-7B421ED8CDCA.7769bdafa4.png',
'0007008A-7BD8-403D-A7AA-F6456781A38E':'//webeditor-static.cdn-one.com/0007008A-7BD8-403D-A7AA-F6456781A38E.9868c87b6e.png',
'00070730-9978-479E-9FBA-92FC6749B783':'//webeditor-static.cdn-one.com/00070730-9978-479E-9FBA-92FC6749B783.d3ea9311f8.png',
'00070748-CD5C-46BB-91C1-D070B317D79C':'//webeditor-static.cdn-one.com/00070748-CD5C-46BB-91C1-D070B317D79C.d4b4968860.png',
'00070754-94C2-46F1-B465-9C47870B71FE':'//webeditor-static.cdn-one.com/00070754-94C2-46F1-B465-9C47870B71FE.7168f88752.png',
'00070766-F60B-457F-B397-A3673344B990':'//webeditor-static.cdn-one.com/00070766-F60B-457F-B397-A3673344B990.058f5a8978.png',
'00070777-F6E6-4017-B303-5B9292C5B193':'//webeditor-static.cdn-one.com/00070777-F6E6-4017-B303-5B9292C5B193.8fce0c0f8e.png',
'00070834-62D1-461B-BF85-CFC4F85DE88A':'//webeditor-static.cdn-one.com/00070834-62D1-461B-BF85-CFC4F85DE88A.76b10f8f95.png',
'00080021-E0DB-4216-B08F-EC7F81E56703':'//webeditor-static.cdn-one.com/00080021-E0DB-4216-B08F-EC7F81E56703.2f9452bd03.png',
'00080101-2DBA-4BD7-93C2-200ACB39A363':'//webeditor-static.cdn-one.com/00080101-2DBA-4BD7-93C2-200ACB39A363.ba2ff4198f.png',
'00081BC7-E018-4D15-B747-6D52FDA7AB8C':'//webeditor-static.cdn-one.com/00081BC7-E018-4D15-B747-6D52FDA7AB8C.39d0d52b85.png',
'000823A3-063F-4E5C-9676-F209B360BC51':'//webeditor-static.cdn-one.com/000823A3-063F-4E5C-9676-F209B360BC51.bf694fdd65.png',
'001731EA-BAF4-426D-ABBB-89356CC12BF2':'//webeditor-static.cdn-one.com/001731EA-BAF4-426D-ABBB-89356CC12BF2.5f3567a7dd.png',
'001C63DB-8AFA-4381-B313-9264DDF02508':'//webeditor-static.cdn-one.com/001C63DB-8AFA-4381-B313-9264DDF02508.4be23b8ae9.png',
'013DB8BA-39E8-486B-AF3A-A48D903DCDBD':'//webeditor-static.cdn-one.com/013DB8BA-39E8-486B-AF3A-A48D903DCDBD.5bb637a396.png',
'0224F05C-E435-4733-A672-FE547D9FB33F':'//webeditor-static.cdn-one.com/0224F05C-E435-4733-A672-FE547D9FB33F.518dfabd63.png',
'03782AF4-B732-44D4-9B17-2B352438A8F7':'//webeditor-static.cdn-one.com/03782AF4-B732-44D4-9B17-2B352438A8F7.5e862cb176.png',
'0539D130-3B66-4115-B6B7-BEF0843229FC':'//webeditor-static.cdn-one.com/0539D130-3B66-4115-B6B7-BEF0843229FC.f98dba8c00.png',
'084AA085-3E96-4BB7-AF97-52B6841485F2':'//webeditor-static.cdn-one.com/084AA085-3E96-4BB7-AF97-52B6841485F2.783442d79b.png',
'1A508E91-3007-4FD8-8BAA-24ACA61AAA68':'//webeditor-static.cdn-one.com/1A508E91-3007-4FD8-8BAA-24ACA61AAA68.5bc17b8ecb.png',
'1C4669D4-606A-43B8-B5EA-6C3BFCC9171A':'//webeditor-static.cdn-one.com/1C4669D4-606A-43B8-B5EA-6C3BFCC9171A.6b37b94844.png',
'1D5A5942-512F-4899-ABD3-4CCDD4D2EEA6':'//webeditor-static.cdn-one.com/1D5A5942-512F-4899-ABD3-4CCDD4D2EEA6.3bdd3fc892.png',
'1EAEF3EB-411E-4EAA-9FDE-5468F5B5754C':'//webeditor-static.cdn-one.com/1EAEF3EB-411E-4EAA-9FDE-5468F5B5754C.1140fb88f4.png',
'204B64BE-2F2D-444D-879E-FC46D800B95A':'//webeditor-static.cdn-one.com/204B64BE-2F2D-444D-879E-FC46D800B95A.f27537e71d.png',
'23E5F695-A336-415F-8EDE-86F727E54ACE':'//webeditor-static.cdn-one.com/23E5F695-A336-415F-8EDE-86F727E54ACE.b798b75109.png',
'25F00AC7-18E9-4525-A670-4351CEF8FDA8':'//webeditor-static.cdn-one.com/25F00AC7-18E9-4525-A670-4351CEF8FDA8.9cd7070270.png',
'2685289B-22DA-4B34-A683-55E9AFC22105':'//webeditor-static.cdn-one.com/2685289B-22DA-4B34-A683-55E9AFC22105.4e9344c09e.png',
'2AEAE987-A2B8-4EAA-A47A-819314099BF2':'//webeditor-static.cdn-one.com/2AEAE987-A2B8-4EAA-A47A-819314099BF2.bf0a2372c0.png',
'2C44F84E-A6E1-413F-A3F3-5644138137A3':'//webeditor-static.cdn-one.com/2C44F84E-A6E1-413F-A3F3-5644138137A3.0a4d892308.png',
'2E30034F-1AF6-4230-997D-6F48AF1B0011':'//webeditor-static.cdn-one.com/2E30034F-1AF6-4230-997D-6F48AF1B0011.116103fd30.png',
'3043CD74-B431-4AAE-8C0F-A4D93A82AE72':'//webeditor-static.cdn-one.com/3043CD74-B431-4AAE-8C0F-A4D93A82AE72.114564aba7.png',
'311EB8FA-A458-478B-AB21-FD2F7F4FD396':'//webeditor-static.cdn-one.com/311EB8FA-A458-478B-AB21-FD2F7F4FD396.50b1492ec5.png',
'334BBBC7-4FA8-446C-B74D-05735EAA1097':'//webeditor-static.cdn-one.com/334BBBC7-4FA8-446C-B74D-05735EAA1097.972794d94f.png',
'34061178-2E48-4F01-AF05-799E56AC9835':'//webeditor-static.cdn-one.com/34061178-2E48-4F01-AF05-799E56AC9835.06a60fd05f.png',
'34AA3CB7-85D6-4EEB-BA1C-59BE944196FF':'//webeditor-static.cdn-one.com/34AA3CB7-85D6-4EEB-BA1C-59BE944196FF.cdd2787a0c.png',
'3DA86168-AE0B-4931-A922-505298DBD838':'//webeditor-static.cdn-one.com/3DA86168-AE0B-4931-A922-505298DBD838.37fec071e7.png',
'3FD90757-BE66-472E-8101-39727602F40A':'//webeditor-static.cdn-one.com/3FD90757-BE66-472E-8101-39727602F40A.c6046359bc.png',
'42AD43FA-86AC-40EC-817A-D902EB5A2646':'//webeditor-static.cdn-one.com/42AD43FA-86AC-40EC-817A-D902EB5A2646.ae4ab07e8c.png',
'4B88778E-0844-4F29-8C48-25ADD979BE07':'//webeditor-static.cdn-one.com/4B88778E-0844-4F29-8C48-25ADD979BE07.2da4d74817.png',
'4F069106-1AFB-44A0-932C-23AC4E48D717':'//webeditor-static.cdn-one.com/4F069106-1AFB-44A0-932C-23AC4E48D717.1e0fe05891.png',
'54800989-B457-4B9C-83F1-65F53E137C6E':'//webeditor-static.cdn-one.com/54800989-B457-4B9C-83F1-65F53E137C6E.4a7940d1c5.png',
'5658EEBA-488C-463E-A7FE-668EF0C19874':'//webeditor-static.cdn-one.com/5658EEBA-488C-463E-A7FE-668EF0C19874.de8a68c5bd.png',
'56F81F12-2D3C-40E2-9663-C737ED560687':'//webeditor-static.cdn-one.com/56F81F12-2D3C-40E2-9663-C737ED560687.f01a150d6e.png',
'58896882-CB5A-4CC1-992E-31E2B90BF944':'//webeditor-static.cdn-one.com/58896882-CB5A-4CC1-992E-31E2B90BF944.b24416c7e5.png',
'5973DB30-E0E9-4B79-9B01-A6A4803A5B06':'//webeditor-static.cdn-one.com/5973DB30-E0E9-4B79-9B01-A6A4803A5B06.c632cfc816.png',
'5B0B340F-9400-4984-9F75-313A054FCD1E':'//webeditor-static.cdn-one.com/5B0B340F-9400-4984-9F75-313A054FCD1E.aba3cf9a2a.png',
'5E510A6D-585F-4578-89B5-F62FCCB3F9B7':'//webeditor-static.cdn-one.com/5E510A6D-585F-4578-89B5-F62FCCB3F9B7.9a3d456c40.png',
'607B35C9-EF6E-4608-B895-2C48E5604BED':'//webeditor-static.cdn-one.com/607B35C9-EF6E-4608-B895-2C48E5604BED.943fb71ca2.png',
'61B045BC-A215-4DAF-B009-CABD03BB162E':'//webeditor-static.cdn-one.com/61B045BC-A215-4DAF-B009-CABD03BB162E.8f3e03877f.png',
'6462FADC-98D5-4B29-A7DA-2103F9DE5E9B':'//webeditor-static.cdn-one.com/6462FADC-98D5-4B29-A7DA-2103F9DE5E9B.f58e602280.png',
'6483B0E7-059E-4314-8363-C7FB1F3A6CB6':'//webeditor-static.cdn-one.com/6483B0E7-059E-4314-8363-C7FB1F3A6CB6.2a57d7c497.png',
'672EAAD3-66D9-41DB-AA81-1C0EFA461195':'//webeditor-static.cdn-one.com/672EAAD3-66D9-41DB-AA81-1C0EFA461195.6a6e2f4425.png',
'68A1CEC5-8443-49DA-A69E-10FD4EC1158A':'//webeditor-static.cdn-one.com/68A1CEC5-8443-49DA-A69E-10FD4EC1158A.9abad7631a.png',
'6945C55A-DB8F-4511-93EA-0AA6330D841C':'//webeditor-static.cdn-one.com/6945C55A-DB8F-4511-93EA-0AA6330D841C.069d8bd1de.png',
'6A590330-67C5-4CEC-A873-5AFB5D6A5B03':'//webeditor-static.cdn-one.com/6A590330-67C5-4CEC-A873-5AFB5D6A5B03.4b383cf1ad.png',
'6A89F07A-DA86-4645-8D7C-C569598B0570':'//webeditor-static.cdn-one.com/6A89F07A-DA86-4645-8D7C-C569598B0570.aee01dd996.png',
'6FBD0F95-644B-4366-9EA7-9A2D230AFEB7':'//webeditor-static.cdn-one.com/6FBD0F95-644B-4366-9EA7-9A2D230AFEB7.ba0a1afad4.png',
'724DC003-F351-4D99-B050-CA77A7F813AF':'//webeditor-static.cdn-one.com/724DC003-F351-4D99-B050-CA77A7F813AF.9a49ec590c.png',
'73F9B328-08DC-46B8-A2B8-00A9EDFD23F1':'//webeditor-static.cdn-one.com/73F9B328-08DC-46B8-A2B8-00A9EDFD23F1.ce587262c0.png',
'7434549F-3501-4637-B58C-028A7282733E':'//webeditor-static.cdn-one.com/7434549F-3501-4637-B58C-028A7282733E.82708e3c96.png',
'788775F0-0568-458E-AA05-1FF98F9D16AC':'//webeditor-static.cdn-one.com/788775F0-0568-458E-AA05-1FF98F9D16AC.03bd0c8ba9.png',
'7DC3462C-86E8-43D1-AC14-95B9F3CAB7F5':'//webeditor-static.cdn-one.com/7DC3462C-86E8-43D1-AC14-95B9F3CAB7F5.bf0dd3c65d.png',
'7EBF7B3F-AB9C-4BE3-8AA3-F2BCABA29308':'//webeditor-static.cdn-one.com/7EBF7B3F-AB9C-4BE3-8AA3-F2BCABA29308.e16e15e5a2.png',
'86E66F0E-B615-491E-AB93-02EA26E739DF':'//webeditor-static.cdn-one.com/86E66F0E-B615-491E-AB93-02EA26E739DF.395f1f1abf.png',
'8BE71EDA-8B36-4308-8F93-0BFF9D48011F':'//webeditor-static.cdn-one.com/8BE71EDA-8B36-4308-8F93-0BFF9D48011F.fc1177a373.png',
'8E6DAEEB-2149-4D7B-B0B7-48833D6674F9':'//webeditor-static.cdn-one.com/8E6DAEEB-2149-4D7B-B0B7-48833D6674F9.2ee304d391.png',
'90E6AE18-E966-411E-A206-A39CC4249640':'//webeditor-static.cdn-one.com/90E6AE18-E966-411E-A206-A39CC4249640.a3671b4707.png',
'92D17A27-C501-4C1A-9B74-7F2126D476AA':'//webeditor-static.cdn-one.com/92D17A27-C501-4C1A-9B74-7F2126D476AA.98484a2549.png',
'9372BB7F-C33D-4490-8FC1-D9C1748F1B00':'//webeditor-static.cdn-one.com/9372BB7F-C33D-4490-8FC1-D9C1748F1B00.c61c30fa04.png',
'93C20709-9258-4424-8FED-00C0E4F182FE':'//webeditor-static.cdn-one.com/93C20709-9258-4424-8FED-00C0E4F182FE.52ec4a48c2.png',
'9773A4DE-7F3D-480D-806C-47F2072A09F3':'//webeditor-static.cdn-one.com/9773A4DE-7F3D-480D-806C-47F2072A09F3.5af75d8746.png',
'97E75564-601B-4E2D-ADE4-C404293BCEB0':'//webeditor-static.cdn-one.com/97E75564-601B-4E2D-ADE4-C404293BCEB0.8550e2aac6.png',
'98709062-2541-49E5-B719-2BD8EDCEAE34':'//webeditor-static.cdn-one.com/98709062-2541-49E5-B719-2BD8EDCEAE34.5c02eba02f.png',
'98B05EE6-3FF7-4225-8E6C-B364A4D5A4E7':'//webeditor-static.cdn-one.com/98B05EE6-3FF7-4225-8E6C-B364A4D5A4E7.77e2f1941d.png',
'998163D4-6628-4431-9649-39330FF7B1DD':'//webeditor-static.cdn-one.com/998163D4-6628-4431-9649-39330FF7B1DD.424a21094d.png',
'99C5C747-AEE0-4A65-B67F-0D21D4BC7DD8':'//webeditor-static.cdn-one.com/99C5C747-AEE0-4A65-B67F-0D21D4BC7DD8.c14fbae6b1.png',
'9C098D93-215C-4FEC-9920-AF5F689477B7':'//webeditor-static.cdn-one.com/9C098D93-215C-4FEC-9920-AF5F689477B7.035e1a859d.png',
'9C51F5A7-A55E-480E-873C-866C6D9CED96':'//webeditor-static.cdn-one.com/9C51F5A7-A55E-480E-873C-866C6D9CED96.2824e706c0.png',
'A1405D9D-9BE1-4AC5-8604-BE6E20F61A7E':'//webeditor-static.cdn-one.com/A1405D9D-9BE1-4AC5-8604-BE6E20F61A7E.cb4749dac1.png',
'A4227214-40D6-4018-8FED-EFA5B616A7CA':'//webeditor-static.cdn-one.com/A4227214-40D6-4018-8FED-EFA5B616A7CA.77a65ab010.png',
'A4F8FDA5-2AA3-437E-BF0A-904A71B79BD3':'//webeditor-static.cdn-one.com/A4F8FDA5-2AA3-437E-BF0A-904A71B79BD3.a2c2560742.png',
'A51F9476-AC94-41E2-B494-4A42397348F9':'//webeditor-static.cdn-one.com/A51F9476-AC94-41E2-B494-4A42397348F9.5184861de2.png',
'A6B6C9A1-12E6-4B64-8100-460D635BF984':'//webeditor-static.cdn-one.com/A6B6C9A1-12E6-4B64-8100-460D635BF984.07460154d4.png',
'AA325A34-B75F-4838-B136-33296A0F63D2':'//webeditor-static.cdn-one.com/AA325A34-B75F-4838-B136-33296A0F63D2.a77182463d.png',
'AB52975E-0967-4B51-8DA9-785D6F9A3C79':'//webeditor-static.cdn-one.com/AB52975E-0967-4B51-8DA9-785D6F9A3C79.4edc27aa7b.png',
'ABDE7B7D-C2D2-4B0F-8A05-CD93FF231B43':'//webeditor-static.cdn-one.com/ABDE7B7D-C2D2-4B0F-8A05-CD93FF231B43.77a6ff375a.png',
'AD9F5937-B233-4AE6-9EB5-F2B5B8085661':'//webeditor-static.cdn-one.com/AD9F5937-B233-4AE6-9EB5-F2B5B8085661.15740aea05.png',
'B25A8465-F523-41D7-B049-FB3ED84917E0':'//webeditor-static.cdn-one.com/B25A8465-F523-41D7-B049-FB3ED84917E0.88d94f3857.png',
'B4B2FAB4-51EE-4724-870A-74FDD98B307B':'//webeditor-static.cdn-one.com/B4B2FAB4-51EE-4724-870A-74FDD98B307B.962a6fee52.png',
'B4F12329-05EB-40E2-BE7E-BD36C0491D8D':'//webeditor-static.cdn-one.com/B4F12329-05EB-40E2-BE7E-BD36C0491D8D.9d7735003b.png',
'B672CFDA-B43F-4B45-992C-B38A6320EC3A':'//webeditor-static.cdn-one.com/B672CFDA-B43F-4B45-992C-B38A6320EC3A.cc826580bb.png',
'B9E93092-C3DA-445A-A81B-8B1A027F1EE6':'//webeditor-static.cdn-one.com/B9E93092-C3DA-445A-A81B-8B1A027F1EE6.615867eb78.png',
'C14C7795-A390-4B21-860A-C02A36B0DB0D':'//webeditor-static.cdn-one.com/C14C7795-A390-4B21-860A-C02A36B0DB0D.79b621ed81.png',
'C179F788-A044-49E3-AF4D-2D27CBD60E5A':'//webeditor-static.cdn-one.com/C179F788-A044-49E3-AF4D-2D27CBD60E5A.faf89b9b3e.png',
'C685C25D-636C-402B-9F93-26B3D4460920':'//webeditor-static.cdn-one.com/C685C25D-636C-402B-9F93-26B3D4460920.2eae026688.png',
'CFB7058C-1454-4C1B-8E83-7BFF8EF61823':'//webeditor-static.cdn-one.com/CFB7058C-1454-4C1B-8E83-7BFF8EF61823.36be2c0af2.png',
'D16D963A-BF9C-4463-9937-2E2CE154F6DD':'//webeditor-static.cdn-one.com/D16D963A-BF9C-4463-9937-2E2CE154F6DD.a5de307650.png',
'D3FAB447-C620-4ECC-9582-25B60ED8D942':'//webeditor-static.cdn-one.com/D3FAB447-C620-4ECC-9582-25B60ED8D942.6e2dc13097.png',
'D73C7D3F-DCD7-4370-86A4-490A44136013':'//webeditor-static.cdn-one.com/D73C7D3F-DCD7-4370-86A4-490A44136013.01aaec544e.png',
'D82E5828-0612-4B4D-95E1-50668553442F':'//webeditor-static.cdn-one.com/D82E5828-0612-4B4D-95E1-50668553442F.c4ff20fb56.png',
'DA2CFBCD-2C75-4948-8B4E-1598383D5113':'//webeditor-static.cdn-one.com/DA2CFBCD-2C75-4948-8B4E-1598383D5113.4f9e5e4fe4.png',
'DAB59EC3-648B-4095-B233-1D935C33E2F6':'//webeditor-static.cdn-one.com/DAB59EC3-648B-4095-B233-1D935C33E2F6.f3e4ee7f65.png',
'DB127167-B1F2-414B-9314-1D0F59FB1EB5':'//webeditor-static.cdn-one.com/DB127167-B1F2-414B-9314-1D0F59FB1EB5.0449a809e0.png',
'DDDF9E1C-E288-454B-B20D-2E5CA55E22B6':'//webeditor-static.cdn-one.com/DDDF9E1C-E288-454B-B20D-2E5CA55E22B6.ed65b070c4.png',
'DFF82427-AC15-4AA4-96A8-C9D137E851CA':'//webeditor-static.cdn-one.com/DFF82427-AC15-4AA4-96A8-C9D137E851CA.c5a81aa988.png',
'E1FAD3A0-50DA-4B5F-99A7-B59BC46568BF':'//webeditor-static.cdn-one.com/E1FAD3A0-50DA-4B5F-99A7-B59BC46568BF.9333fe476e.png',
'EBD0C7E9-CDC5-4192-AFB9-3CD3D1116E8A':'//webeditor-static.cdn-one.com/EBD0C7E9-CDC5-4192-AFB9-3CD3D1116E8A.32da1ea64d.png',
'EF6525A1-4EDE-4DF0-832B-86501AD62D4F':'//webeditor-static.cdn-one.com/EF6525A1-4EDE-4DF0-832B-86501AD62D4F.7876fff919.png',
'EF8636B4-D274-4B36-A3B9-3CF1A576C565':'//webeditor-static.cdn-one.com/EF8636B4-D274-4B36-A3B9-3CF1A576C565.18c9b3a65b.png',
'F461723F-15FB-4AC9-A6DB-A67C3F29003A':'//webeditor-static.cdn-one.com/F461723F-15FB-4AC9-A6DB-A67C3F29003A.901966530e.png',
'F81C2E32-22AE-48BC-AF06-2DE61B0EF699':'//webeditor-static.cdn-one.com/F81C2E32-22AE-48BC-AF06-2DE61B0EF699.539a370c87.png',
'F8B2BD28-2441-4B95-BC9C-9F439796C17F':'//webeditor-static.cdn-one.com/F8B2BD28-2441-4B95-BC9C-9F439796C17F.03cef321fa.png',
'FBD16911-F3B2-492E-99A9-F5820E013F1A':'//webeditor-static.cdn-one.com/FBD16911-F3B2-492E-99A9-F5820E013F1A.2f97bbf096.png'
}
},
'760':{
'490':{
'001731EA-BAF4-426D-ABBB-89356CC12BF2':'//webeditor-static.cdn-one.com/001731EA-BAF4-426D-ABBB-89356CC12BF2.413f6ba4c1.png',
'0224F05C-E435-4733-A672-FE547D9FB33F':'//webeditor-static.cdn-one.com/0224F05C-E435-4733-A672-FE547D9FB33F.162d5f8bd8.png',
'03782AF4-B732-44D4-9B17-2B352438A8F7':'//webeditor-static.cdn-one.com/03782AF4-B732-44D4-9B17-2B352438A8F7.78b440f37f.png',
'0539D130-3B66-4115-B6B7-BEF0843229FC':'//webeditor-static.cdn-one.com/0539D130-3B66-4115-B6B7-BEF0843229FC.6a2b9d622f.png',
'060E9FC1-C3F1-47EF-A339-26B813F95FE2':'//webeditor-static.cdn-one.com/060E9FC1-C3F1-47EF-A339-26B813F95FE2.c9bfd9c85c.png',
'07C057DE-6B9F-4054-AC3B-8A18D5576458':'//webeditor-static.cdn-one.com/07C057DE-6B9F-4054-AC3B-8A18D5576458.3b4b6d1f1a.png',
'084AA085-3E96-4BB7-AF97-52B6841485F2':'//webeditor-static.cdn-one.com/084AA085-3E96-4BB7-AF97-52B6841485F2.12fff9b789.png',
'0D05EBAB-5B57-4AFC-B37F-D74C184DC330':'//webeditor-static.cdn-one.com/0D05EBAB-5B57-4AFC-B37F-D74C184DC330.0353eddbf5.png',
'125D220F-8FDC-4213-B966-E2F5FC03FDF5':'//webeditor-static.cdn-one.com/125D220F-8FDC-4213-B966-E2F5FC03FDF5.c75ad8599b.png',
'176BC94D-2465-40B9-B85B-C252B145777D':'//webeditor-static.cdn-one.com/176BC94D-2465-40B9-B85B-C252B145777D.30b6ef8bc0.png',
'1921575B-E4B7-40D9-A71D-F831DD78465E':'//webeditor-static.cdn-one.com/1921575B-E4B7-40D9-A71D-F831DD78465E.6f9dd02b98.png',
'19C01FE6-985B-4FAA-A702-1EB4A9AEFBBA':'//webeditor-static.cdn-one.com/19C01FE6-985B-4FAA-A702-1EB4A9AEFBBA.8fbade26ff.png',
'1A508E91-3007-4FD8-8BAA-24ACA61AAA68':'//webeditor-static.cdn-one.com/1A508E91-3007-4FD8-8BAA-24ACA61AAA68.95249260c8.png',
'1BBC770F-EDEA-478C-844B-49EE79B11AC3':'//webeditor-static.cdn-one.com/1BBC770F-EDEA-478C-844B-49EE79B11AC3.d81302869a.png',
'1C4669D4-606A-43B8-B5EA-6C3BFCC9171A':'//webeditor-static.cdn-one.com/1C4669D4-606A-43B8-B5EA-6C3BFCC9171A.f561a28c9c.png',
'1CF91525-45D5-45DD-8356-01676A31DE36':'//webeditor-static.cdn-one.com/1CF91525-45D5-45DD-8356-01676A31DE36.e14337b0e5.png',
'1D37228D-FD7B-4EB5-A860-749D5BE194C3':'//webeditor-static.cdn-one.com/1D37228D-FD7B-4EB5-A860-749D5BE194C3.cdb8be5074.png',
'1EAEF3EB-411E-4EAA-9FDE-5468F5B5754C':'//webeditor-static.cdn-one.com/1EAEF3EB-411E-4EAA-9FDE-5468F5B5754C.345a6844df.png',
'22C2E58D-C04B-49C7-A5AA-CF94087F2772':'//webeditor-static.cdn-one.com/22C2E58D-C04B-49C7-A5AA-CF94087F2772.d8112ae9e3.png',
'23583321-A2F2-4478-A996-7A99EA6541C2':'//webeditor-static.cdn-one.com/23583321-A2F2-4478-A996-7A99EA6541C2.55629d6f25.png',
'23E5F695-A336-415F-8EDE-86F727E54ACE':'//webeditor-static.cdn-one.com/23E5F695-A336-415F-8EDE-86F727E54ACE.9e4cf4d083.png',
'25A9B706-70F2-4C76-9CAE-284251B469B6':'//webeditor-static.cdn-one.com/25A9B706-70F2-4C76-9CAE-284251B469B6.7a264b1249.png',
'2685289B-22DA-4B34-A683-55E9AFC22105':'//webeditor-static.cdn-one.com/2685289B-22DA-4B34-A683-55E9AFC22105.ee5262e4ce.png',
'2E30034F-1AF6-4230-997D-6F48AF1B0011':'//webeditor-static.cdn-one.com/2E30034F-1AF6-4230-997D-6F48AF1B0011.322921ff1c.png',
'2FA166B9-4BE6-4BA0-98B6-DE96BAD3F2BA':'//webeditor-static.cdn-one.com/2FA166B9-4BE6-4BA0-98B6-DE96BAD3F2BA.629ba2cd29.png',
'3043CD74-B431-4AAE-8C0F-A4D93A82AE72':'//webeditor-static.cdn-one.com/3043CD74-B431-4AAE-8C0F-A4D93A82AE72.f087d4fc10.png',
'311EB8FA-A458-478B-AB21-FD2F7F4FD396':'//webeditor-static.cdn-one.com/311EB8FA-A458-478B-AB21-FD2F7F4FD396.e16fb4790a.png',
'334BBBC7-4FA8-446C-B74D-05735EAA1097':'//webeditor-static.cdn-one.com/334BBBC7-4FA8-446C-B74D-05735EAA1097.ec9f86004f.png',
'34061178-2E48-4F01-AF05-799E56AC9835':'//webeditor-static.cdn-one.com/34061178-2E48-4F01-AF05-799E56AC9835.f2bcb64457.png',
'34AA3CB7-85D6-4EEB-BA1C-59BE944196FF':'//webeditor-static.cdn-one.com/34AA3CB7-85D6-4EEB-BA1C-59BE944196FF.445240a1a9.png',
'3D50B879-D6BA-4E9C-8AD1-D1BE07EB8BDC':'//webeditor-static.cdn-one.com/3D50B879-D6BA-4E9C-8AD1-D1BE07EB8BDC.9399038b6a.png',
'3DB6416A-DF5F-47E5-8026-CDDA622DAC83':'//webeditor-static.cdn-one.com/3DB6416A-DF5F-47E5-8026-CDDA622DAC83.df9c5a1676.png',
'42CD1A9F-F9A5-499C-96FA-4B2AF07596A3':'//webeditor-static.cdn-one.com/42CD1A9F-F9A5-499C-96FA-4B2AF07596A3.48b13a3ae2.png',
'43832C0D-2A58-4B22-9C37-6DA817CD2EA5':'//webeditor-static.cdn-one.com/43832C0D-2A58-4B22-9C37-6DA817CD2EA5.835d98cb82.png',
'43B86FE4-41B7-474A-AFC1-508261E6504A':'//webeditor-static.cdn-one.com/43B86FE4-41B7-474A-AFC1-508261E6504A.7f41660624.png',
'4B88778E-0844-4F29-8C48-25ADD979BE07':'//webeditor-static.cdn-one.com/4B88778E-0844-4F29-8C48-25ADD979BE07.fe91e56c31.png',
'4F069106-1AFB-44A0-932C-23AC4E48D717':'//webeditor-static.cdn-one.com/4F069106-1AFB-44A0-932C-23AC4E48D717.362514e52c.png',
'54800989-B457-4B9C-83F1-65F53E137C6E':'//webeditor-static.cdn-one.com/54800989-B457-4B9C-83F1-65F53E137C6E.d7d9d6649a.png',
'54D6A027-D2A9-43D5-843C-B9FA7DA27AAC':'//webeditor-static.cdn-one.com/54D6A027-D2A9-43D5-843C-B9FA7DA27AAC.6260808914.png',
'58896882-CB5A-4CC1-992E-31E2B90BF944':'//webeditor-static.cdn-one.com/58896882-CB5A-4CC1-992E-31E2B90BF944.13189f9f37.png',
'5973DB30-E0E9-4B79-9B01-A6A4803A5B06':'//webeditor-static.cdn-one.com/5973DB30-E0E9-4B79-9B01-A6A4803A5B06.37380d4212.png',
'5B0B340F-9400-4984-9F75-313A054FCD1E':'//webeditor-static.cdn-one.com/5B0B340F-9400-4984-9F75-313A054FCD1E.b05f8a8f0f.png',
'5C5852E3-3BB3-46C1-9D1E-F7C7EDD008E5':'//webeditor-static.cdn-one.com/5C5852E3-3BB3-46C1-9D1E-F7C7EDD008E5.32890b1a01.png',
'5D06CBB0-1BB5-4C58-82E3-BC46594BB9EF':'//webeditor-static.cdn-one.com/5D06CBB0-1BB5-4C58-82E3-BC46594BB9EF.5a2beb5928.png',
'5E510A6D-585F-4578-89B5-F62FCCB3F9B7':'//webeditor-static.cdn-one.com/5E510A6D-585F-4578-89B5-F62FCCB3F9B7.544a986712.png',
'607B35C9-EF6E-4608-B895-2C48E5604BED':'//webeditor-static.cdn-one.com/607B35C9-EF6E-4608-B895-2C48E5604BED.e3eb79f786.png',
'6462FADC-98D5-4B29-A7DA-2103F9DE5E9B':'//webeditor-static.cdn-one.com/6462FADC-98D5-4B29-A7DA-2103F9DE5E9B.950c2e3fab.png',
'6483B0E7-059E-4314-8363-C7FB1F3A6CB6':'//webeditor-static.cdn-one.com/6483B0E7-059E-4314-8363-C7FB1F3A6CB6.fda208302e.png',
'667E3A08-C999-447A-9618-1F30C71B580C':'//webeditor-static.cdn-one.com/667E3A08-C999-447A-9618-1F30C71B580C.bf9dd1bb25.png',
'672EAAD3-66D9-41DB-AA81-1C0EFA461195':'//webeditor-static.cdn-one.com/672EAAD3-66D9-41DB-AA81-1C0EFA461195.7ea545a9d4.png',
'68A1CEC5-8443-49DA-A69E-10FD4EC1158A':'//webeditor-static.cdn-one.com/68A1CEC5-8443-49DA-A69E-10FD4EC1158A.8b2f0e4c69.png',
'68C76818-E65B-47A3-9596-6E17D6F12AD3':'//webeditor-static.cdn-one.com/68C76818-E65B-47A3-9596-6E17D6F12AD3.44cb9b7fb4.png',
'6945C55A-DB8F-4511-93EA-0AA6330D841C':'//webeditor-static.cdn-one.com/6945C55A-DB8F-4511-93EA-0AA6330D841C.66a797ee90.png',
'6A89F07A-DA86-4645-8D7C-C569598B0570':'//webeditor-static.cdn-one.com/6A89F07A-DA86-4645-8D7C-C569598B0570.6b177b4547.png',
'7058BCCD-D968-41AC-8347-BA25E75A346B':'//webeditor-static.cdn-one.com/7058BCCD-D968-41AC-8347-BA25E75A346B.297bab538e.png',
'724DC003-F351-4D99-B050-CA77A7F813AF':'//webeditor-static.cdn-one.com/724DC003-F351-4D99-B050-CA77A7F813AF.2105c2fdea.png',
'7434549F-3501-4637-B58C-028A7282733E':'//webeditor-static.cdn-one.com/7434549F-3501-4637-B58C-028A7282733E.c028aa1517.png',
'788775F0-0568-458E-AA05-1FF98F9D16AC':'//webeditor-static.cdn-one.com/788775F0-0568-458E-AA05-1FF98F9D16AC.4f975cd887.png',
'7DC3462C-86E8-43D1-AC14-95B9F3CAB7F5':'//webeditor-static.cdn-one.com/7DC3462C-86E8-43D1-AC14-95B9F3CAB7F5.300bceaef1.png',
'89267991-7599-4403-973C-5EAA3783B1E7':'//webeditor-static.cdn-one.com/89267991-7599-4403-973C-5EAA3783B1E7.c592d3621f.png',
'90E6AE18-E966-411E-A206-A39CC4249640':'//webeditor-static.cdn-one.com/90E6AE18-E966-411E-A206-A39CC4249640.a0354b49c6.png',
'917F5067-7446-4224-A3CA-A36F33793407':'//webeditor-static.cdn-one.com/917F5067-7446-4224-A3CA-A36F33793407.bac28592fb.png',
'92D17A27-C501-4C1A-9B74-7F2126D476AA':'//webeditor-static.cdn-one.com/92D17A27-C501-4C1A-9B74-7F2126D476AA.ea2d6ff59b.png',
'93C20709-9258-4424-8FED-00C0E4F182FE':'//webeditor-static.cdn-one.com/93C20709-9258-4424-8FED-00C0E4F182FE.d5d952c38c.png',
'9773A4DE-7F3D-480D-806C-47F2072A09F3':'//webeditor-static.cdn-one.com/9773A4DE-7F3D-480D-806C-47F2072A09F3.5bc3d3bb3b.png',
'98709062-2541-49E5-B719-2BD8EDCEAE34':'//webeditor-static.cdn-one.com/98709062-2541-49E5-B719-2BD8EDCEAE34.4769ece186.png',
'98B05EE6-3FF7-4225-8E6C-B364A4D5A4E7':'//webeditor-static.cdn-one.com/98B05EE6-3FF7-4225-8E6C-B364A4D5A4E7.fac00c26ae.png',
'998163D4-6628-4431-9649-39330FF7B1DD':'//webeditor-static.cdn-one.com/998163D4-6628-4431-9649-39330FF7B1DD.b7a14eda26.png',
'A0392AC0-A1A4-440C-9D8B-B31EF1AEF6DE':'//webeditor-static.cdn-one.com/A0392AC0-A1A4-440C-9D8B-B31EF1AEF6DE.ff0d2c8a80.png',
'A1405D9D-9BE1-4AC5-8604-BE6E20F61A7E':'//webeditor-static.cdn-one.com/A1405D9D-9BE1-4AC5-8604-BE6E20F61A7E.f62d91227f.png',
'A33A597A-F6E4-45A6-9AED-FE31C04904FA':'//webeditor-static.cdn-one.com/A33A597A-F6E4-45A6-9AED-FE31C04904FA.506e51b22d.png',
'A4642118-4EC6-40C1-8426-C2FC9844AF65':'//webeditor-static.cdn-one.com/A4642118-4EC6-40C1-8426-C2FC9844AF65.d24925efe4.png',
'A4F8FDA5-2AA3-437E-BF0A-904A71B79BD3':'//webeditor-static.cdn-one.com/A4F8FDA5-2AA3-437E-BF0A-904A71B79BD3.e719564188.png',
'A54D51AD-CC01-4463-B3B7-2DBD9A6FEF37':'//webeditor-static.cdn-one.com/A54D51AD-CC01-4463-B3B7-2DBD9A6FEF37.5da50e1cc9.png',
'A6B6C9A1-12E6-4B64-8100-460D635BF984':'//webeditor-static.cdn-one.com/A6B6C9A1-12E6-4B64-8100-460D635BF984.ffc3e8e846.png',
'A6D6D8E6-7CCD-48E3-98B8-225B15169B7C':'//webeditor-static.cdn-one.com/A6D6D8E6-7CCD-48E3-98B8-225B15169B7C.cf8e05c5d9.png',
'ABDE7B7D-C2D2-4B0F-8A05-CD93FF231B43':'//webeditor-static.cdn-one.com/ABDE7B7D-C2D2-4B0F-8A05-CD93FF231B43.f88e52b5cf.png',
'AFE0D697-B31D-4D3C-8BAE-F6E030894CF0':'//webeditor-static.cdn-one.com/AFE0D697-B31D-4D3C-8BAE-F6E030894CF0.7cc492a7ff.png',
'B12D4879-CD6B-430C-BB6C-992E925FD88B':'//webeditor-static.cdn-one.com/B12D4879-CD6B-430C-BB6C-992E925FD88B.237e532127.png',
'B35C53DD-5C8C-470F-8DA8-2153976EECE9':'//webeditor-static.cdn-one.com/B35C53DD-5C8C-470F-8DA8-2153976EECE9.f4b91e30e4.png',
'B4F12329-05EB-40E2-BE7E-BD36C0491D8D':'//webeditor-static.cdn-one.com/B4F12329-05EB-40E2-BE7E-BD36C0491D8D.412aa9df9c.png',
'B672CFDA-B43F-4B45-992C-B38A6320EC3A':'//webeditor-static.cdn-one.com/B672CFDA-B43F-4B45-992C-B38A6320EC3A.961c37788e.png',
'B6F2ED9D-A152-4959-A8F8-58F0C6E22FD1':'//webeditor-static.cdn-one.com/B6F2ED9D-A152-4959-A8F8-58F0C6E22FD1.4ee349ebcd.png',
'BCA2C9D5-7C5A-49D0-86D1-3A7E5961B2B5':'//webeditor-static.cdn-one.com/BCA2C9D5-7C5A-49D0-86D1-3A7E5961B2B5.ee9915771f.png',
'C14552AC-8DB7-4150-AB51-9B73B9401FC4':'//webeditor-static.cdn-one.com/C14552AC-8DB7-4150-AB51-9B73B9401FC4.e5eabf5ad2.png',
'C14C7795-A390-4B21-860A-C02A36B0DB0D':'//webeditor-static.cdn-one.com/C14C7795-A390-4B21-860A-C02A36B0DB0D.81ada818b0.png',
'C179F788-A044-49E3-AF4D-2D27CBD60E5A':'//webeditor-static.cdn-one.com/C179F788-A044-49E3-AF4D-2D27CBD60E5A.01ea7e46f5.png',
'C337552B-49CB-400F-8A27-0F7E739A9C96':'//webeditor-static.cdn-one.com/C337552B-49CB-400F-8A27-0F7E739A9C96.db7175741b.png',
'C3566464-F522-4956-BAFE-DC1EC8346905':'//webeditor-static.cdn-one.com/C3566464-F522-4956-BAFE-DC1EC8346905.27d0669714.png',
'C3F11272-1DAB-4E12-893C-DE32C78E2AFE':'//webeditor-static.cdn-one.com/C3F11272-1DAB-4E12-893C-DE32C78E2AFE.eaeba81c9c.png',
'C90CB248-F914-4E98-ADAF-F68C880B4057':'//webeditor-static.cdn-one.com/C90CB248-F914-4E98-ADAF-F68C880B4057.13c3eb587f.png',
'CB414496-EBCA-444A-9637-2F84BBF342E1':'//webeditor-static.cdn-one.com/CB414496-EBCA-444A-9637-2F84BBF342E1.7258ca215d.png',
'CE38524B-4C39-40DD-835C-BCCC910C6C70':'//webeditor-static.cdn-one.com/CE38524B-4C39-40DD-835C-BCCC910C6C70.9dab31a022.png',
'CE626112-0612-4A55-805E-0E91AB00BDBA':'//webeditor-static.cdn-one.com/CE626112-0612-4A55-805E-0E91AB00BDBA.1a5f83a723.png',
'D16D963A-BF9C-4463-9937-2E2CE154F6DD':'//webeditor-static.cdn-one.com/D16D963A-BF9C-4463-9937-2E2CE154F6DD.109dd59afe.png',
'D3FB1D53-3D5B-4014-BFF6-C03B22371004':'//webeditor-static.cdn-one.com/D3FB1D53-3D5B-4014-BFF6-C03B22371004.9a332aac1c.png',
'D73C7D3F-DCD7-4370-86A4-490A44136013':'//webeditor-static.cdn-one.com/D73C7D3F-DCD7-4370-86A4-490A44136013.6818d31767.png',
'D85CFDB4-466E-43BE-BDBD-F8D92BB37B60':'//webeditor-static.cdn-one.com/D85CFDB4-466E-43BE-BDBD-F8D92BB37B60.e02414538e.png',
'DA2CFBCD-2C75-4948-8B4E-1598383D5113':'//webeditor-static.cdn-one.com/DA2CFBCD-2C75-4948-8B4E-1598383D5113.5ee26d4eda.png',
'DAB59EC3-648B-4095-B233-1D935C33E2F6':'//webeditor-static.cdn-one.com/DAB59EC3-648B-4095-B233-1D935C33E2F6.08a9ccd30d.png',
'DB127167-B1F2-414B-9314-1D0F59FB1EB5':'//webeditor-static.cdn-one.com/DB127167-B1F2-414B-9314-1D0F59FB1EB5.f8d73f1a51.png',
'DD6F2D53-BECB-4B32-ACCD-B3CB7D584B6D':'//webeditor-static.cdn-one.com/DD6F2D53-BECB-4B32-ACCD-B3CB7D584B6D.f9e380bd73.png',
'DDDF9E1C-E288-454B-B20D-2E5CA55E22B6':'//webeditor-static.cdn-one.com/DDDF9E1C-E288-454B-B20D-2E5CA55E22B6.4f1583f431.png',
'DFF82427-AC15-4AA4-96A8-C9D137E851CA':'//webeditor-static.cdn-one.com/DFF82427-AC15-4AA4-96A8-C9D137E851CA.22ce62597a.png',
'E1FAD3A0-50DA-4B5F-99A7-B59BC46568BF':'//webeditor-static.cdn-one.com/E1FAD3A0-50DA-4B5F-99A7-B59BC46568BF.a2e1d060be.png',
'E6BECFFE-E8AE-4347-8231-4F952EF49393':'//webeditor-static.cdn-one.com/E6BECFFE-E8AE-4347-8231-4F952EF49393.90667ba3dc.png',
'EAE09073-6A96-4868-A79E-BB4180616034':'//webeditor-static.cdn-one.com/EAE09073-6A96-4868-A79E-BB4180616034.87fca8d129.png',
'EBD0C7E9-CDC5-4192-AFB9-3CD3D1116E8A':'//webeditor-static.cdn-one.com/EBD0C7E9-CDC5-4192-AFB9-3CD3D1116E8A.294b6d46cd.png',
'EBDC86F6-7098-417F-BEB7-02AADF6AA0EF':'//webeditor-static.cdn-one.com/EBDC86F6-7098-417F-BEB7-02AADF6AA0EF.9f1c2e1e07.png',
'EE6B32F3-69A1-4CB1-8484-739959A262B3':'//webeditor-static.cdn-one.com/EE6B32F3-69A1-4CB1-8484-739959A262B3.4ac3cf6ef3.png',
'EF6525A1-4EDE-4DF0-832B-86501AD62D4F':'//webeditor-static.cdn-one.com/EF6525A1-4EDE-4DF0-832B-86501AD62D4F.18d2ab4314.png',
'EFE438DC-B311-40A0-8FEF-F171024B9534':'//webeditor-static.cdn-one.com/EFE438DC-B311-40A0-8FEF-F171024B9534.6a5b59128f.png',
'F461723F-15FB-4AC9-A6DB-A67C3F29003A':'//webeditor-static.cdn-one.com/F461723F-15FB-4AC9-A6DB-A67C3F29003A.a427697908.png',
'F5764FBD-7435-458C-A387-5AA294513931':'//webeditor-static.cdn-one.com/F5764FBD-7435-458C-A387-5AA294513931.8209347f93.png',
'F8B2BD28-2441-4B95-BC9C-9F439796C17F':'//webeditor-static.cdn-one.com/F8B2BD28-2441-4B95-BC9C-9F439796C17F.8835eacf34.png',
'F8E77251-68FB-48FE-A095-57707A18912B':'//webeditor-static.cdn-one.com/F8E77251-68FB-48FE-A095-57707A18912B.2568a0bbc9.png',
'FBD16911-F3B2-492E-99A9-F5820E013F1A':'//webeditor-static.cdn-one.com/FBD16911-F3B2-492E-99A9-F5820E013F1A.019858fb8a.png',
'FEC7673E-9967-406E-99BC-62CE1D0A6936':'//webeditor-static.cdn-one.com/FEC7673E-9967-406E-99BC-62CE1D0A6936.477befda71.png'
}
}
}[width][height][id]
},
displayPreview:function(config){
config=config||{};
var templateOrPage=config.contentType,contentId=config.contentId,subPageIds=config.subPageIds,name=config.name||'';
if(!templateOrPage){
var currentContent=this.getCurrentContent();
if(!currentContent){
return
}
templateOrPage=currentContent.templateOrPage;
contentId=currentContent.contentId;
subPageIds=currentContent.subPageIds;
name=currentContent.name
}else{
this.setCurrentContent(templateOrPage,contentId,subPageIds,name)
}
var preview=this.getPreviewComponent(),previewUrl,that=this;
var mode=this.getPreviewMode()||'desktop',isMobileMode=mode.indexOf('mobile')>-1,width,height;
if(mode==='mobile-vertical'){
width=317;
height=457
}else if(mode==='mobile-horizontal'){
width=478;
height=297
}else{
width=window.innerWidth;
height=620
}
if(templateOrPage==='page'){
if(this.getSelectedPageId()&&subPageIds&&subPageIds.length){
contentId=this.getSelectedPageId()
}
}
if(templateOrPage==='template'){
previewUrl=this.app.dal.getPreviewUrl(contentId)
}else{
previewUrl=this.app.rep.defaultUrl+'/preview/'+contentId+'.html?templateselectorpreview='+mode
}
preview.update('<div class="mobile-scroller flex"><div class="iframe-wrapper"></div></div>');
var $el=oneJQuery('.iframe-wrapper',preview.el.dom);
if(!isMobileMode){
$el.height($el.parent().parent().height()-35);
$el.append('<iframe class="iframe-preview" style="left:0;top:0;" src="'+previewUrl+'"></iframe>')
}else{
$el.append('<iframe class="iframe-preview" style="width:'+width+'px;height: '+height+'px;" src="'+previewUrl+'"></iframe>');
$el[0].style.height=height+'px';
$el[0].style.width=width+'px'
}
var iframe=$el[0].firstChild,repositionIframe=function(){
this.disableClicks()
};
iframe.onload=repositionIframe.bind(this);
Ext.EventManager.removeAll(preview.getContentTarget().dom);
that.verticallyMiddleAlign();
if(isMobileMode){
oneJQuery(preview.el.query('.iframe-wrapper')[0]).perfectScrollbar()
}
},
checkSubscription:function(success,error){
var tsList=this.templateSelectorList;
var record=tsList.getSelectedData();
var isPremiumTemplate=(record||{}).isPremium||false;
var isPremiumUser=this.app.user.getSubscriptionStatus()===web.UserSubscriptionStatus.PREMIUM;
var that=this;
if(isPremiumTemplate){
if(isPremiumUser){
success.call(this)
}else{
Ext.Msg.show({
buttons:{ok:'Upgrade'},
fn:function(btn){
if(btn==='ok'){
web.upgradeToPremiumViaPopup({
app:that.app,
source:'TemplateSelector:UpgradePopup'
})
}
},
cls:'web-modal-premium',
title:'Premium feature',
msg:'You have chosen a Premium template and it is not available from your current Website Builder.'+'<br><br>'+'Upgrade to Website Builder Premium to use this template and get other great features.'
});
error.call(this)
}
}else{
success.call(this)
}
},
handleSelectTemplate:function(){
var tsList=this.templateSelectorList;
var activeCard=this.app.cards.layout.activeItem;
this.checkSubscription(function(){
activeCard.el.mask('','animated-loading-dots',true,true);
tsList.fireEvent('beforeok',tsList,tsList.getSelectedTemplateId());
tsList.fetchSelectedTemplate(function(template,stylesheet,pageConfigs){
activeCard.el.unmask();
tsList.fireEvent('ok',this,template,pageConfigs);
this.app.track([
'Template',
'select',
template.getName()
])
},this)
},function(){
})
},
handleWelcomeMessageVisibility:function(firstTimeUser){
this.welcomeMessageBanner.setVisible(firstTimeUser);
this.backButtonPanel.setVisible(!firstTimeUser);
this.doLayout()
},
disableClicks:function(){
var that=this;
var interceptClicks=function(){
var selector='a, div.container-link';
var fixHref=function(el,href){
var mode=that.getPreviewMode()||'desktop';
href=href.replace(/.html$/,'.html?templateselectorpreview='+mode);
el.attr('href',href)
};
oneJQuery('.iframe-preview').contents().find(selector).each(function(){
var el=oneJQuery(this);
var href=el.attr('href');
var isInternalLink=/^\/api\/v1\/repository\/preview\/[A-F0-9\-]+\./i.test(href);
var isDummyInternalLink=/0001B7F1-B179-4756-94A4-56A605179547/.test(href);
if(isInternalLink&&!isDummyInternalLink){
fixHref(el,href)
}else{
el.attr('onclick','return false;');
el.on('click',function(e){
e.stopPropagation();
e.preventDefault();
e.stopImmediatePropagation();
return false
})
}
})
};
var contactFormSubmitClone=function(){
var frame=oneJQuery('.iframe-preview').contents();
var el=frame.find('.contact-form-submit-btn');
el.each(function(){
var e=oneJQuery(this);
e.attr('onclick','return false;');
var parent=e.parent();
var html=parent.html();
parent.empty();
parent.html(html)
})
};
interceptClicks();
contactFormSubmitClone()
},
hackFixExtJSHeight:function(){
var el=this.templateSelectorList.el;
if(el){
this.cardList.setHeight(window.innerHeight-oneJQuery('.oneweb-header').height())
}
var mode=this.getPreviewMode()||'desktop';
if(mode==='desktop'){
el=oneJQuery('.iframe-wrapper');
if(el){
el.height(el.parent().parent().height()-35)
}
}
}
});
Ext.ns('web.windows.video');
web.windows.video.PromptURL=Ext.extend(Ext.Container,{
type:'web.windows.video.PromptURL',
Enum:{YouTube:'Youtube'},
validation:{Youtube:'(?:http|https)://www\\.youtube\\.com/watch\\?v=([^&]+).*'},
xtype:'web-windows-video-prompturl',
constructor:function(config){
this.provider='';
Ext.apply(this,{
xtype:'container',
layout:'vbox',
layoutConfig:{
align:'stretch',
defaultMargins:{
top:0,
right:0,
bottom:20,
left:0
}
},
items:[
{
xtype:'container',
cls:'web-windows-video-youtube-large',
layout:'hbox',
width:78,
height:32
},
{
xtype:'container',
layout:'hbox',
items:[{
xtype:'label',
text:'Enter the URL of a YouTube video'
}]
},
{
xtype:'container',
layout:'hbox',
items:[
{
xtype:'textfield',
ref:'../URLField',
height:28,
value:'http://',
flex:1
},
{
xtype:'spacer',
width:10
},
{
xtype:'button',
ref:'../addURLBtn',
cls:'x-btn-primary large wide',
text:'Add video',
listeners:{
click:this.onAddVideo,
scope:this
}
}
]
}
]
});
web.windows.video.PromptURL.superclass.constructor.call(this,config);
this.on('show',function(){
this.doLayout()
},this);
this.addEvents('videoselect')
},
setProvider:function(provider){
this.provider=provider
},
onAddVideo:function(){
var url=this.URLField.getValue(),regex,newRegex=/(https?):\/\/youtu.be\/([^$]+)/,newMatch;
newMatch=url.match(newRegex);
if(newMatch){
url='https://www.youtube.com/watch?v='+newMatch[2]
}
if(this.provider===this.Enum.YouTube){
regex=new RegExp(this.validation[this.provider]);
if(url.match(regex)){
this.onVideoSelect(this.provider,url)
}else{
this.URLField.markInvalid()
}
}
},
onVideoSelect:function(provider,url){
this.fireEvent('videoselect',provider,url)
}
});
Ext.reg(web.windows.video.PromptURL.prototype.xtype,web.windows.video.PromptURL);
web.windows.video.PopupPreview=Ext.extend(Ext.Window,{
type:'web.windows.video.PopupPreview',
constructor:function(){
this.videoHtml='';
web.windows.video.PopupPreview.superclass.constructor.apply(this,arguments);
this.on('show',function(){
this.videoHtml=this.videoHtml.replace('{url}',this.getURL());
this.update(this.videoHtml);
this.center()
},this)
},
setValues:function(values){
if(values&&values.html){
this.provider=values.provider;
this.url=values.url;
this.videoHtml=values.html
}
this.hide()
},
getURL:function(){
if(this.provider==='YouTube'){
var regex='(?:http|https)://www\\.youtube\\.com/watch\\?v=([^&]+).*',transform='https://www.youtube.com/embed/{\\1}?wmode=transparent';
return this.transformURL(this.url,regex,transform)
}
},
transformURL:function(url,regex,transform){
var matches=url.match(new RegExp(regex,''));
if(matches!==null){
var len=matches.length,i;
for(i=1;i<len;i+=1){
var regexObj=new RegExp('{\\\\'+i+'}','g');
transform=transform.replace(regexObj,matches[i])
}
return transform
}else{
one.debug('Either URL is wrong or video regex transform of URL is wrong')
}
return null
}
});
web.windows.video.YouTubeSearch=Ext.extend(Ext.Container,{
type:'web.windows.video.YouTubeSearch',
xtype:'web-windows-video-YouTubeSearch',
constructor:function(){
var that=this;
this.store=new Ext.data.Store({
fields:[
'videoId',
'title',
'author',
'description',
'published',
'views',
'thumbnailSrc'
]
});
Ext.apply(this,{
layout:'vbox',
layoutConfig:{
align:'stretch',
defaultMargins:{
top:0,
right:0,
bottom:20,
left:0
},
padding:5
},
items:[
{
xtype:'container',
layout:'hbox',
items:[
{
xtype:'container',
cls:'web-windows-video-youtube-small',
width:55,
height:28
},
{
xtype:'spacer',
width:30
},
{
xtype:'textfield',
ref:'../youTubeSearchText',
style:'margin-top:4px',
flex:2,
height:23,
enableKeyEvents:true,
listeners:{
keypress:function(field,event){
if(event.getKey()===event.ENTER){
this.onSearch()
}
},
scope:this
}
},
{
xtype:'spacer',
width:9
},
{
xtype:'button',
cls:'x-btn-primary',
style:'margin-top:4px',
text:'Search videos',
tooltip:'Search videos on YouTube.',
ref:'../youTubeSearchBtn',
listeners:{
click:this.onSearch,
scope:this
}
},
{
xtype:'spacer',
width:9
},
{
xtype:'button',
ref:'../youTubeUploadBtn',
cls:'x-btn-primary',
style:'margin-top:4px',
text:'Upload video to YouTube',
tooltip:'Open YouTube to upload a video.',
listeners:{
click:this.onUploadClick,
scope:this
}
}
]
},
{
xtype:'dataview',
ref:'resultList',
cls:'youtube-search-dataview',
height:393,
style:{overflow:'auto'},
store:this.store,
itemSelector:'.web-windows-video-youtubesearch-list',
tpl:new Ext.XTemplate('<tpl for=".">','<table class="web-windows-video-youtubesearch-list {[xindex % 2 === 0 ? "web-windows-video-youtubesearch-list-even" : "web-windows-video-youtubesearch-list-odd"]}"><tbody>','<tr class="web-windows-video-youtubesearch-row">','<td class="web-windows-video-youtubesearch-list-thumb"><div style="background-image:url({thumbnailSrc});"></div></td>','<td class="web-windows-video-youtubesearch-list-text"><div class="video-title">{title}</div><div class="video-description">{description}</div>','<div class="video-footer">','<tpl if="author!==\'\'">{author} | </tpl>','{published}','<tpl if="views!==\'\'"> |  {views}</tpl>','</div></td>','<td><input type="button" class="web-windows-video-youtubesearch-preview-btn" value="'+'Preview'+'" /></td>','</tr>','</tbody></table>','</tpl>'),
listeners:{
click:function(dataView,index,node,eventObj){
var target=eventObj.getTarget(),videoId=this.store.getAt(index).get('videoId');
if(target.nodeName.toLowerCase()!=='input'){
this.onVideoSelect(videoId)
}else{
this.onPreviewClick(videoId);
eventObj.stopPropagation()
}
},
render:function(panel){
panel.tip=new Ext.ToolTip({
target:panel.getEl(),
delegate:'.web-windows-video-youtubesearch-row',
html:'Click to insert',
trackMouse:true
})
},
afterrender:function(panel){
oneJQuery.infiniteScroll({
container:panel.el.dom,
callback:function(){
if(that.nextPageToken){
that.search()
}
}
})
},
scope:this
}
}
]
});
this.addEvents('videoselect');
web.windows.video.YouTubeSearch.superclass.constructor.apply(this,arguments)
},
setSearchText:function(value){
this.youTubeSearchText.suspendEvents();
this.youTubeSearchText.setValue(value);
this.youTubeSearchText.resumeEvents();
this.newSearch()
},
search:function(suppress){
var that=this;
if(this.searchIsActive){
return
}
this.searchIsActive=true;
var $=oneJQuery;
var $loadingYoutubeSearchResults=$('<div class="animated-loading-dots"><div></div></div>');
var $resultListDom=$(that.resultList.el.dom);
$resultListDom.append($loadingYoutubeSearchResults);
$.ajax({
url:'https://www.googleapis.com/youtube/v3/search?'+'q='+window.encodeURIComponent(this.youTubeSearchText.getValue())+'&part=snippet'+function(){
if(that.nextPageToken){
return'&pageToken='+that.nextPageToken
}
return''
}()+'&maxResults=20'+'&type=video'+'&key='+'AIzaSyDZxXy0ClAGmOo7IwFilUtLCbibOGOzAiM',
complete:function(){
that.searchIsActive=false;
$loadingYoutubeSearchResults.remove()
},
success:function(data,textStatus,jqXHR){
var Record=Ext.data.Record.create([]);
that.nextPageToken=data&&data.nextPageToken||null;
if(data&&data.items.length){
data.items.forEach(function(item){
var recordObject={
videoId:item.id.videoId,
title:item.snippet.title,
author:function(raw){
if(raw){
return'by '+raw
}
return''
}(item.snippet.channelTitle),
description:function(raw){
if(raw.length>120){
return raw.substring(0,120)+'...'
}
return raw
}(item.snippet.description),
published:function(raw){
var time=new Date(new Date-new Date(raw)),temp,text;
if((temp=time.getFullYear()-1970)>0){
time=one.locale.renderUnit(temp,'year')
}else if(time.getMonth()){
time=one.locale.renderUnit(time.getMonth(),'month')
}else if(time.getHours()){
time=one.locale.renderUnit(time.getHours(),'hour')
}else if(time.getMinutes()){
time=one.locale.renderUnit(time.getMinutes(),'minute')
}else{
text='Few seconds ago'
}
if(!text){
text=time+' ago'
}
return text
}(item.snippet.publishedAt),
views:'',
thumbnailSrc:function(raw){
var thumb='';
Ext.each(raw,function(thumbnail,index2){
thumb=thumbnail.url
});
thumb=thumb.replace(/^http:/,'');
return thumb
}(item.snippet.thumbnails.default)
};
var record=new Record(recordObject);
that.store.add(record)
})
}else{
$resultListDom.html('<div class="youtube-no-results-to-display">'+'No results to display'+'</div>')
}
},
error:function(){
}
})
},
reInitSearch:function(){
delete this.nextPageToken;
this.store.removeAll();
this.searchIsActive=false;
var $=oneJQuery;
var $resultListDom=$(this.resultList.el.dom);
$resultListDom.html('')
},
newSearch:function(){
this.reInitSearch();
this.search()
},
onSearch:function(){
this.newSearch()
},
onUploadClick:function(){
window.open('https://www.youtube.com/upload')
},
onPreviewClick:function(videoId){
var url='https://www.youtube.com/embed/'+videoId;
this.popupPreview=this.app.windows.show({
type:'web.windows.video.PopupPreview',
persist:false,
modal:true,
minWidth:450+56,
minHeight:250+(40+60),
values:{
provider:'YouTube',
url:url,
html:'<iframe class="youtube-player" type="text/html" allowfullscreen src="'+url+'?wmode=transparent&autoplay=1" style="border:none;width:100%;height:100%;min-width:450px;min-height:250px;" />'
}
})
},
onVideoSelect:function(videoId){
if(this.popupPreview){
this.popupPreview.hide()
}
this.fireEvent('videoselect','https://www.youtube.com/watch?v='+videoId)
}
});
Ext.reg(web.windows.video.YouTubeSearch.prototype.xtype,web.windows.video.YouTubeSearch);
web.windows.video.Video=Ext.extend(web.windows.Window,{
type:'web.windows.video.Video',
Enum:{YouTube:'Youtube'},
initComponent:function(){
Ext.apply(this,{
title:'Video',
width:634,
height:331,
resizable:false,
modal:true,
layout:'card',
activeItem:0,
defaults:{border:false},
items:[
{
xtype:'container',
ref:'main',
layout:'vbox',
layoutConfig:{
align:'stretch',
defaultMargins:{
top:0,
right:0,
bottom:20,
left:0
},
padding:5
},
items:[
{
xtype:'container',
cls:'web-windows-video-youtube-large',
layout:'hbox',
width:78,
height:32
},
{
xtype:'container',
layout:'hbox',
layoutConfig:{align:'middle'},
items:[
{
xtype:'textfield',
ref:'../../youTubeSearchText',
flex:1,
height:23,
enableKeyEvents:true,
listeners:{
keypress:function(field,event){
if(event.getKey()===event.ENTER){
this.onYouTubeSearch()
}
},
scope:this
}
},
{
xtype:'spacer',
width:10
},
{
xtype:'button',
cls:'x-btn-primary large wide',
text:'Search videos',
tooltip:'Search videos on YouTube.',
ref:'../youTubeSearchBtn',
listeners:{
click:this.onYouTubeSearch,
scope:this
}
}
]
},
{
xtype:'container',
layout:'hbox',
items:[
{
xtype:'button',
cls:'x-btn-primary large wide',
text:'Upload video to YouTube',
tooltip:'Open YouTube to upload a video.',
ref:'../../youTubeUpload',
listeners:{
click:this.onYouTubeUploadClick,
scope:this
}
},
{
xtype:'spacer',
width:7
},
{
xtype:'button',
cls:'x-btn-primary large wide',
text:'Paste a link to a YouTube video',
tooltip:'Add YouTube video manually.',
ref:'../../youTubeManualAdd',
listeners:{
click:this.onYouTubeManualAdd,
scope:this
}
}
]
}
]
},
{
xtype:'web-windows-video-YouTubeSearch',
ref:'youTubeSearchWindow',
app:this.app,
listeners:{
videoselect:function(url){
this.onVideoSelect(this.Enum.YouTube,url)
},
scope:this
}
},
{
xtype:'web-windows-video-prompturl',
ref:'promptURLWindow',
listeners:{
videoselect:function(provider,url){
this.onVideoSelect(provider,url)
},
scope:this
}
}
],
listeners:{
show:function(){
this.setHeight(this.height);
this.center();
this.layout.setActiveItem(0)
},
scope:this
}
});
web.windows.video.Video.superclass.initComponent.apply(this,arguments)
},
initListeners:function(){
},
onYouTubeSearch:function(){
this.setHeight(573);
this.center();
this.youTubeSearchWindow.setSearchText(this.youTubeSearchText.getValue());
this.layout.setActiveItem(1)
},
onYouTubeUploadClick:function(){
window.open('https://www.youtube.com/upload')
},
onYouTubeManualAdd:function(){
this.promptURLWindow.setProvider(this.Enum.YouTube);
this.layout.setActiveItem(2)
},
onVideoSelect:function(provider,url){
this.hide();
this.fireEvent('ok',provider,url)
}
});
web.windows.WindowFactory=function(app){
this.app=app;
this.manager=Ext.WindowMgr;
this.windows={}
};
web.windows.WindowFactory.prototype={
create:function(config){
var WindowNs=web.windows,mapping,winCfg,type;
if(config.type&&this.windows[config.type]){
mapping=this.windows[config.type];
this.removeListeners(mapping);
mapping.listeners=config.listeners||{};
if(config.okFn){
Ext.apply(mapping.listeners,{
ok:config.okFn,
cancel:config.cancelFn||Ext.emptyFn,
scope:config.scope||mapping.listeners.scope
})
}
Ext.iterate(mapping.listeners,function(key,value){
if(key!=='scope'){
mapping.win.addListener(key,value,mapping.listeners.scope)
}
})
}else{
mapping={};
if(config.type){
type=config.type.replace(/^web\.windows\./,'',type);
type.split('.').forEach(function(ns){
WindowNs=WindowNs[ns]||WindowNs
})
}else{
WindowNs=web.windows.Window
}
winCfg=Ext.applyIf({
closeAction:config.type&&config.persist!==false?'hide':'close',
manager:this.manager,
app:this.app
},config);
winCfg.listeners=winCfg.listeners||{};
if(config.okFn){
Ext.apply(winCfg.listeners,{
ok:config.okFn,
cancel:config.cancelFn||Ext.emptyFn,
scope:config.scope||winCfg.listeners.scope
})
}
if(Ext.isFunction(WindowNs)){
mapping.win=new WindowNs(winCfg);
mapping.listeners=winCfg.listeners;
if(config.type&&config.persist!==false){
this.windows[config.type]=mapping
}
}else{
mapping.win=new web.windows.Window(winCfg)
}
}
return mapping.win
},
get:function(type){
return this.windows[type]
},
show:function(config){
var win=this.create(config);
if(config.hasOwnProperty('values')&&win.setValues){
win.setValues(config.values)
}
win.show();
this.manager.bringToFront(win);
return win
},
hide:function(config){
var mapping;
if(config.type&&this.windows[config.type]){
mapping=this.windows[config.type];
mapping.win.hide()
}
},
hideAll:function(){
this.manager.hideAll()
},
setWindowToCenter:function(win,options){
if(win.el){
options=options||{};
if(options.onlyIfOutsideView){
if(!(win.getWidth()+win.getPosition()[0]>Ext.getBody().getWidth()||win.getHeight()+win.getPosition()[1]>Ext.getBody().getHeight()||win.getPosition()[0]<0||win.getPosition()[1]<0)){
return false
}
}
var bodyWidth=Ext.getBody().getWidth();
var bodyHeight=Ext.getBody().getHeight();
var winWidth=win.getWidth();
var winHeight=win.getHeight();
var left=(bodyWidth-winWidth)/2;
left=Math.max(left,0);
var top=(bodyHeight-winHeight)/2;
top=Math.max(top,0);
win.setPosition(left,top);
return true
}else{
return null
}
},
removeListeners:function(mapping){
var win=mapping.win,listeners=mapping.listeners,eventName;
for(eventName in listeners){
if(eventName!=='scope'&&listeners.hasOwnProperty(eventName)){
win.un(eventName,listeners[eventName],listeners.scope||mapping.scope)
}
}
}
};
web.windows.WindowFactory.types=[];
web.windows.Rollback=Ext.extend(web.windows.Window,{
initComponent:function(){
this.width=500;
this.height=300;
this.title='Rollback data for this domain to a previous point in time';
this.layout='form';
this.items=[
{
xtype:'label',
text:'',
html:'<h1>Select a UTC date and time</h1>'
},
{
xtype:'spacer',
height:10
},
{
xtype:'datefield',
fieldLabel:'Date',
ref:'datefield'
},
{
xtype:'timefield',
fieldLabel:'Time',
format:'H:i',
ref:'timefield'
}
];
this.buttons=[{
text:'Rollback',
cls:'x-btn-primary',
listeners:{
click:this.rollbackButtonClicked,
scope:this
}
}];
this.listeners={
show:function(){
var date=new Date;
date=date.add(Date.MINUTE,date.getTimezoneOffset());
this.datefield.setValue(date);
this.timefield.setValue(date)
},
scope:this
};
web.windows.Rollback.superclass.initComponent.apply(this,arguments)
},
rollbackAPI:function(domainName,time,accessCode,callback,scope){
scope=scope||this;
if(Object.prototype.toString.call(time)==='[object Date]'){
time=time.getTime()
}
Ext.Ajax.request({
url:'/api/v1/'+domainName+'/doc',
method:'POST',
jsonData:{
command:'rollback',
time:time,
accessCode:accessCode
},
callback:callback,
scope:scope
})
},
rollbackButtonClicked:function(button,event){
var date=this.datefield.getValue(),time=this.timefield.getValue(),datetime,app=one.viewport.application,domain=app.dal.getDomain(),that=this;
button.disable();
time=time.match(/\d+/g);
datetime=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate(),time[0],time[1],0,0));
Ext.Msg.prompt('Access code','Access code',function(btn,accessCode){
if(btn==='ok'){
Ext.Msg.show({
title:'Confirm',
msg:'The data will be rolled back to this time: <br>'+datetime.toISOString(),
buttons:Ext.Msg.OKCANCEL,
closable:false,
fn:function(b){
if(b==='ok'){
that.rollbackAPI(domain,datetime,accessCode,function(options,success,xhr){
if(success){
that.hide();
Ext.Msg.show({
msg:'Success.<br>App will restart when you close this window.',
title:'Success',
icon:Ext.Msg.INFO,
fn:function(){
document.location.reload()
}
})
}else{
Ext.Msg.show({
msg:'Error: '+xhr.responseText,
title:'Error',
icon:Ext.Msg.ERROR,
fn:function(){
button.enable()
}
})
}
},that)
}else{
button.enable()
}
},
scope:this
})
}else{
button.enable()
}
})
}
});
web.dd.Proxy=function(){
var body=Ext.getBody(),paper,cfg,el,paperEl;
this.el=el=Ext.get(Ext.DomHelper.append(body,{style:{pointerEvents:'none'}}));
paper=this.paper=Raphael(el.dom,0,0);
this.paperEl=paperEl=el.last();
Ext.apply(this.paperEl.dom.style,{
pointerEvents:'none',
position:'absolute',
zIndex:'1001',
left:'0px',
top:'0px'
});
function fixPointerEvents(){
if(!this.fixedPointer){
if(Ext.isIE){
Ext.apply(paperEl.dom.style,{visibility:'hidden'});
if(paperEl.dom.nodeName.toLowerCase()==='svg'){
var children=paperEl.dom.childNodes,i,len=children.length;
for(i=0;i<len;i+=1){
children[i].style.visibility='visible'
}
}
paperEl.un('mouseover',fixPointerEvents)
}else{
this.drawInIframe()
}
this.fixedPointer=true
}
}
this.paperEl.on('mouseover',fixPointerEvents,this);
cfg={'stroke-width':1};
this.rect=paper.rect(0,0,0,0).attr(cfg)
};
web.dd.Proxy.prototype={
init:function(app){
this.app=app;
app.proxy=this
},
drawInIframe:function(){
var paperEl=this.paperEl,webkitFrameBody;
this.items={};
this.webkitFrame=Ext.DomHelper.createDom({
tag:'iframe',
cls:'isvg',
scrolling:'no'
});
this.el.dom.appendChild(this.webkitFrame);
webkitFrameBody=this.webkitFrame.contentWindow.document.body;
Ext.get(webkitFrameBody).insertFirst(paperEl);
Ext.apply(paperEl.dom.style,{
pointerEvents:'none',
position:'absolute',
zIndex:'1001',
left:'0px',
top:'0px'
})
},
setValid:function(valid){
var stroke=valid?'rgba(63, 63, 63, 0)':'rgba(204, 42, 42, 1)',fill=valid?'rgba(63, 63, 63, 0)':'rgba(204, 42, 42, 0.2)',cfg={
fill:fill,
stroke:stroke
};
this.rect.attr(cfg)
},
show:function(cfg){
var el=this.paperEl,x=10,y=10,w,h,o=0.5;
el.dom.style.display='';
if(cfg){
w=cfg.width;
h=cfg.height;
el.setWidth(w+20);
el.setHeight(h+20);
el.setXY([
cfg.x-10,
cfg.y-10
]);
this.rect.attr({
x:x+o,
y:y+o,
width:Math.max(w-o*2,1),
height:Math.max(h-o*2,1)
})
}
this.setValid(cfg.valid)
},
hide:function(){
var el=this.paperEl;
el.dom.style.display='none'
}
};
Ext.ns('web.controllers.tips');
web.ui.tips.Lightbox=Ext.extend(web.windows.Window,{
videoerId:null,
constructor:function(config){
config=config||{};
Ext.apply(config,{
width:950,
height:650,
modal:true,
closeAction:'close',
padding:0,
title:'Tutorial'
});
config.html='<youtube id="4zdkoiqI5oM"><youtube>';
config.onShow=function(){
var html='<iframe width="100%" height="100%" src="https://www.youtube.com/embed/$youtubeid?rel=0" frameborder="0" allowfullscreen></iframe>';
html=html.replace('$youtubeid',this.videoerId);
this.update(html)
};
web.ui.tips.Lightbox.superclass.constructor.call(this,config)
},
show:function(id){
this.videoerId=id;
web.ui.tips.Lightbox.superclass.show.call(this,id)
}
});
web.controllers.tips.Tips=Ext.extend(Object,{
lightbox:null,
app:null,
constructor:function(config){
this.app=config.app;
this.tips=this.tips||config.tips||[];
var that=this;
this.tips.forEach(function(t,i,arr){
t.on('closeall',that.dismissAll,that);
t.on('close',that.updateHelpButtonUI,that);
t.on('showvideo',that.showVideo,that);
t.on('shownext',that.showNext,that);
t.on('showprev',that.showPrev,that);
t.on('switchtab',function(t){
that.app.getSidebar().setActiveTab(t)
},that)
})
},
updateHelpButtonUI:function(){
var allWinsAreClosed=true;
this.tips.forEach(function(t,i,arr){
if(!t.hidden){
allWinsAreClosed=false
}
});
if(allWinsAreClosed){
this.getHelpButton().setState(false)
}
},
displayOnStart:function(){
function run(){
var that=this;
function show(){
if(!this.tipsShownAlready){
this.displayInitial();
this.getHelpButton().setState(true);
this.tipsShownAlready=true
}
}
setTimeout(function(){
show.call(that)
},512)
}
if(this.app.site.folder.items.length===0){
this.app.on('load',run,this)
}
},
getHelpButton:function(){
var header=this.app.findByType('web-panels-header')[0];
return header.helpButton
},
displayAll:function(){
this.tips.forEach(function(t,i,arr){
t.show()
})
},
displayInitial:function(){
var tip=this.getInitial();
if(tip){
tip.show()
}
},
displayFirst:function(){
var tip=this.getFirst();
if(tip){
tip.show()
}
},
getInitial:function(){
var tips=this.tips,tip,i;
for(i=0;tip=tips[i];i+=1){
if(this.isInitial(tip)){
break
}
}
this.currentTip=i;
return tip
},
getFirst:function(){
var tips=this.tips,tip,i;
for(i=0;tip=tips[i];i+=1){
if(this.isVisible(tip)){
break
}
}
this.currentTip=i;
return tip
},
isInitial:function(tip){
var app=this.app,result=this.isVisible(tip);
if(!tip.version){
result=result&&app.isFirstVisit
}
return result
},
isVisible:function(tip){
var app=this.app,result=!tip.exclude,user;
if(tip.version){
user=app.user;
result=result&&!app.isFirstVisit&&app.isUpgrade&&(!user.oldVersion||user.toVersionScore(tip.version)>=user.toVersionScore(user.oldVersion))
}
return result
},
dismissAll:function(){
this.tips.forEach(function(t,i,arr){
t.hide()
});
this.getHelpButton().setState(false)
},
showVideo:function(tip){
this.lightbox=new web.ui.tips.Lightbox;
this.lightbox.show(tip.tutorial)
},
showNext:function(){
var count=0,len=this.tips.length;
this.tips[this.currentTip].hide();
do{
this.currentTip=(this.currentTip+1)%len;
count+=1
}while(!this.isVisible(this.tips[this.currentTip])&&count<len);
if(count<len){
this.tips[this.currentTip].show()
}
},
showPrev:function(){
var count=0,len=this.tips.length;
this.tips[this.currentTip].hide();
do{
if(this.currentTip>0){
this.currentTip=this.currentTip-1
}else{
this.currentTip=len-1
}
count+=1
}while(!this.isVisible(this.tips[this.currentTip])&&count<len);
if(count<len){
this.tips[this.currentTip].show()
}
}
});
web.ui.tips.PageTemplate=Ext.extend(web.ui.tips.BaseTip,{
constructor:function(){
var config={
width:410,
textHeight:90,
tip:'top left',
title:'Tip: Edit Page / Edit Template',
text:'<b>'+'Edit Page:'+'</b>'+' When this is active, the content you add will be added to the selected page '+('<b>'+'only'+'</b>')+'.'+'<br>'+'<br>'+('<b>'+'Edit Template:'+'</b>'+' When this is active, the content you add will be added to '+('<b>'+'all'+'</b>')+' pages using the same template.')
};
web.ui.tips.PageTemplate.superclass.constructor.call(this,config)
},
getX:function(){
return 340
},
getY:function(){
return 100
}
});
web.ui.tips.SavePreviewPublish=Ext.extend(web.ui.tips.BaseTip,{
constructor:function(){
var config={
width:430,
textHeight:150,
tip:'top left',
title:'Tip: Save, Preview and Publish',
text:'<b>'+'Save:'+'</b> '+('Clicking '+('<b>'+'Save'+'</b>')+' instantly saves your work so your changes don\'t get lost. Saving does not change your website on the internet, but merely saves it, so you can continue working.')+'<br><br>'+'<b>'+'Preview:'+'</b> '+('Use the '+('<b>'+'Preview'+'</b>')+' to see how your website will look once published.')+'<br><br>'+'<b>'+'Publish:'+'</b> '+('Clicking '+('<b>'+'Publish'+'</b>')+' publishes your changes for everyone to see. Remember to publish everytime you want your changes to go online.')
};
web.ui.tips.SavePreviewPublish.superclass.constructor.call(this,config)
},
getX:function(){
return 40
},
getY:function(){
return 100
}
});
web.ui.tips.Undo=Ext.extend(web.ui.tips.BaseTip,{
constructor:function(){
var link='<a href="https://www.one.com/en/support/guides-faq#webeditor" class="info-link" target="_blank">Check our guides &amp; FAQs</a>';
var config={
width:260,
textHeight:75,
showNextTip:false,
tip:'top right',
title:'Tip: Undo',
text:'Regret your last action? Just click '+('<b>'+'Undo'+'</b>')+' to reverse it.'+'<br /><br />'+('Need help? '+link)
};
web.ui.tips.Undo.superclass.constructor.call(this,config)
},
getX:function(){
return document.body.offsetWidth-310
},
getY:function(){
return 90
}
});
web.ui.tips.Pages=Ext.extend(web.ui.tips.BaseTip,{
constructor:function(){
var config={
width:380,
textHeight:180,
tip:'top left',
title:'Tip: Pages',
text:'Here you can find and navigate between your different Website Builder pages.'+'<br><br>'+('To create a new page, click '+('<b>'+'New Page (Duplicate)'+'</b>')+'. This duplicates the currently selected page for you to edit as a new page. Click the arrow next to New Page (Duplicate) to use another template or create an external link.')+'<br><br>'+'Edit the page\'s properties, by clicking the arrow next to it. This also allows you to make it the start page or to delete it.',
showPrevTip:false
};
web.ui.tips.Pages.superclass.constructor.call(this,config);
this.on('show',function(){
this.fireEvent('switchtab',0)
},this)
},
getX:function(){
return 20
},
getY:function(){
return 150
}
});
web.ui.tips.Components=Ext.extend(web.ui.tips.BaseTip,{
constructor:function(){
var config={
width:380,
textHeight:115,
tip:'top left',
title:'Tip: Components',
text:'To add content to your page drag a component from here to your page to the right.'+'<br><br>'+'When dragging a component to your page, please notice the blue area that indicates where your component will be placed.'
};
web.ui.tips.Components.superclass.constructor.call(this,config);
this.on('show',function(){
this.fireEvent('switchtab',1)
},this)
},
getX:function(){
return 95
},
getY:function(){
return 150
}
});
web.ui.tips.Properties=Ext.extend(web.ui.tips.BaseTip,{
constructor:function(){
var config={
width:360,
textHeight:90,
tip:'top left',
title:'Tip: Properties',
text:'After selecting a component on your page to the right, you can find all the available options here.'+'<br><br>'+('Please notice the edit-icons '+('<img src='+Ext.BLANK_IMAGE_URL+' class=\'icon icon-gear\' style=\'width: 15px; height: 15px;\'>')+', which provides you with even more options.')
};
web.ui.tips.Properties.superclass.constructor.call(this,config);
this.on('show',function(){
this.fireEvent('switchtab',2)
},this)
},
getX:function(){
return 200
},
getY:function(){
return 150
}
});
Ext.ns('web.ui.tips.upgrades');
web.ui.tips.upgrades.V1_0_0_MARGIN=Ext.extend(web.ui.tips.BaseTip,{
constructor:function(){
var config={
width:440,
textHeight:180,
version:'1.0.0',
showNextTip:false,
tip:false,
title:'Important changes',
text:'<b>New way to resize</b><br><br>When you select a component, you can now resize without affecting other components. Simply select a component and drag one of the dark squares to resize it.<br><br>You can still resize the old way by hovering over the edge of a component.<br><br><b>New way to add components</b><br><br>If you use the new way to resize, you can now add a new component to the space that is added when resizing.'
};
web.ui.tips.upgrades.V1_0_0_MARGIN.superclass.constructor.call(this,config)
},
getX:function(){
return Math.max(Math.round(document.body.offsetWidth/2)-220,10)
},
getY:function(){
return 140
}
});
web.controllers.tips.StartTips=Ext.extend(web.controllers.tips.Tips,{
constructor:function(config){
this.pageTemplate=new web.ui.tips.PageTemplate;
this.savePreviewPublish=new web.ui.tips.SavePreviewPublish;
this.undo=new web.ui.tips.Undo;
this.pages=new web.ui.tips.Pages;
this.components=new web.ui.tips.Components;
this.properties=new web.ui.tips.Properties;
this.tips=[
this.pages,
this.components,
this.properties,
this.pageTemplate,
this.savePreviewPublish,
this.undo
];
this.upgrades=[new web.ui.tips.upgrades.V1_0_0_MARGIN];
this.tips=this.tips.concat(this.upgrades);
web.controllers.tips.StartTips.superclass.constructor.call(this,config)
}
});
Ext.ns('web.controllers.googlewebfonts');
web.controllers.googlewebfonts.GoogleWebFonts=Ext.extend(Ext.util.Observable,{
app:null,
FONTS_LOADING_MODE:{
APP:'app',
PAGE:'page',
PREVIEW:'preview',
ADD_FONTS:'addFonts'
},
constructor:function(config){
this.app=config.app;
this.loadedFamilies={};
this.addEvents({'update':true});
var that=this,scanned;
this.app.on('import',function(o,config){
if(o&&o.type){
if(o instanceof web.data.components.Page){
scanned=false;
setTimeout(function(){
if(!scanned){
that.scanFonts();
scanned=true
}
},1000)
}
}
});
web.controllers.googlewebfonts.GoogleWebFonts.superclass.constructor.call(this,config)
},
addFont:function(){
var fonts=[],task=new Ext.util.DelayedTask(function(){
var site=this.app.site;
this.app.dal.set(site,function(){
},this);
this.initFonts(this.FONTS_LOADING_MODE.ADD_FONTS,fonts);
fonts.forEach(function(font){
this.fireEvent('update',font)
},this);
fonts=[]
});
return function(font){
var site=this.app.site;
if(font.length===0){
return
}
if(!site.fonts){
site.fonts=[]
}
if(site.fonts.indexOf(font)===-1){
site.fonts.push(font);
fonts.push(font);
task.delay(100,null,this)
}
}
}(),
removeFont:function(font){
var site=this.app.site,index;
if(!site.fonts){
return
}
index=site.fonts.indexOf(font);
if(index>0){
site.fonts.splice(index,1);
this.app.dal.set(site);
this.initFonts();
this.fireEvent('update',null)
}
},
initFonts:function(fontsLoadingMode,fonts){
if(fontsLoadingMode===this.FONTS_LOADING_MODE.APP){
this.loadFonts(this.app.site.fonts,true);
this.loadFonts(this.getPageGoogleFonts())
}else if(fontsLoadingMode===this.FONTS_LOADING_MODE.PAGE){
this.loadFonts(this.getPageGoogleFonts())
}else if(fontsLoadingMode===this.FONTS_LOADING_MODE.ADD_FONTS){
this.loadFonts(fonts)
}else if(fontsLoadingMode===this.FONTS_LOADING_MODE.PREVIEW){
this.loadFamilies([fonts[0]+':400:latin'],true)
}
},
loadFonts:function(fonts,forPreview){
var families=[],variantsCheat='100,100italic,200,200italic,300,300italic,500,500italic,600,600italic,700,700italic,800,800italic,900,900italic,italic,regular';
if(fonts){
this.loadGoogleFontList(function(response){
var data,fontDetails,i,index,detail;
if(response.fontDetails){
fontDetails=response.fontDetails
}else if(response.responseText){
data=Ext.decode(response.responseText);
fontDetails=data.items;
response.fontDetails=fontDetails
}
if(fontDetails){
var detailsAddedCount=0;
for(i=0;i<fontDetails.length;i+=1){
index=fonts.indexOf('google://'+fontDetails[i].family);
if(index!==-1){
detail=fontDetails[i];
var familyWithVariants=fonts[index].replace(/^google:\/\//,'')+':'+(forPreview?'400':detail?this.optimizeVariants(detail.variants).join():variantsCheat);
if(!this.loadedFamilies[familyWithVariants]){
families.push(familyWithVariants)
}
detailsAddedCount++;
if(detailsAddedCount===fonts.length){
break
}
}
}
}
this.loadFamilies(families,forPreview)
},this)
}
},
optimizeVariants:function(variants){
var normals=[],italics=[],normal,italic,bold,boldItalic,results=[];
variants.forEach(function(variant){
if(variant.match('italic')){
italics.push(variant==='italic'?400:parseInt(variant,10))
}else{
normals.push(variant==='regular'?400:parseInt(variant,10))
}
},this);
[
400,
300,
500,
200,
600,
100,
700,
800,
900
].forEach(function(size){
if(!normal&&normals.indexOf(size)!==-1){
normal=size;
results.push(normal===400?'regular':normal)
}
if(!italic&&italics.indexOf(size)!==-1){
italic=size;
results.push((italic===400?'':normal)+'italic')
}
},this);
[
700,
800,
600,
900,
500
].forEach(function(size){
if(!bold&&normal&&size>normal&&normals.indexOf(size)!==-1){
bold=size;
results.push(bold)
}
if(!boldItalic&&italic&&size>italic&&italics.indexOf(size)!==-1){
boldItalic=size;
results.push(boldItalic+'italic')
}
},this);
return results
},
loadGoogleFontList:function(fn,scope){
if(this.googleFontListResponse){
fn.call(scope,this.googleFontListResponse);
return
}
this.app.dal.queueRequest({
url:'static/googleWebFontsList.67ce06cbd6.json',
method:'GET',
callback:function(opts,success,response){
this.googleFontListResponse=response;
fn.call(scope,response)
},
scope:this
})
},
loadFamilies:function(families,forPreview){
var now=[],later=[],perRequest=10,delayRequest=5000;
if(families.length>0){
if(families.length>perRequest){
now=[];
families.forEach(function(family,index){
if(index<=perRequest){
now.push(family);
this.loadedFamilies[family]=true
}else{
later.push(family)
}
},this);
families=now;
this.loadFamilies.defer(delayRequest,this,[
later,
forPreview
])
}else{
families.forEach(function(family,index){
this.loadedFamilies[family]=true
},this)
}
families.push('&subset='+(forPreview?'latin':'all'));
var that=this;
window.WebFontConfig={
'google':{'families':families},
active:function(){
that.fireEvent('google-fonts-active',forPreview)
},
inactive:function(){
that.fireEvent('inactive')
}
};
if(!window.WebFont){
if(!this.isLoading){
(function(){
var wf=document.createElement('script'),s;
wf.src=('https:'===document.location.protocol?'https':'http')+'://ajax.googleapis.com/ajax/libs/webfont/1.4.10/webfont.js';
wf.type='text/javascript';
wf.async='true';
s=document.getElementsByTagName('script')[0];
s.parentNode.insertBefore(wf,s);
that.isLoading=true
}())
}
}else{
window.WebFont.load(window.WebFontConfig);
this.isLoading=false
}
}else{
this.fireEvent('inactive')
}
},
getPageGoogleFonts:function(){
var page,template,stylesheet,app=this.app,googleRegex=/^google:\/\//,googleFonts=[],visit;
visit=function(part){
var font=part.fontType||part.font;
if(font&&Ext.isString(font)&&googleRegex.test(font)&&googleFonts.indexOf(font)===-1){
googleFonts.push(font)
}
};
page=app.getSelected('page');
template=app.getSelected('template');
stylesheet=app.getSelected('stylesheet');
var arrSkipProperties=[
'dict',
'parent',
'currentPage'
];
page.getIterator(arrSkipProperties).forEach(visit,this);
template.getIterator(arrSkipProperties).forEach(visit,this);
stylesheet.getIterator(arrSkipProperties).forEach(visit,this);
return googleFonts
},
scanFonts:function(){
this.getPageGoogleFonts().forEach(function(font){
this.addFont(font)
},this)
}
});
web.windows.NortonAVMakesIE9Slow=Ext.extend(web.windows.Window,{
constructor:function(config){
web.windows.NortonAVMakesIE9Slow.superclass.constructor.call(this,config);
var that=this;
web.windows.NortonAVMakesIE9Slow.anyway=function(){
that.hide();
that.callback.call(that.scope)
}
},
initComponent:function(){
this.width=640;
this.height=480;
this.cls='web-modal-warning x-window-dlg';
this.closable=false;
this.resizable=false;
this.title='';
this.items=[
{html:'<h1>'+'Sorry, it looks like Website Builder is running very slow for you on Internet Explorer 9'+'</h1><BR><BR>'+'Website Builder is running slow on your browser. This could be due to many reasons. For the best experience on the web and to use the One.com Website Builder, we suggest you try Google Chrome or Mozilla Firefox.'},
{
xtype:'container',
cls:'button-wrap',
hidden:true,
items:[{
xtype:'button',
text:'Upgrade',
cls:'x-btn-primary',
handler:function(){
var href='';
if(Ext.isIE){
href='http://www.microsoft.com/windows/Internet-explorer/'
}
if(Ext.isChrome){
href='http://www.google.com/chrome'
}
if(Ext.isGecko){
href='http://www.firefox.com/'
}
if(Ext.isOpera){
href='http://www.opera.com/'
}
if(Ext.isSafari){
href='http://www.apple.com/safari/'
}
document.location.href=href
}
}]
},
{html:'<div class=\'unsupported\'>'+'<table><tbody>'+'<tr>'+'<td class=\'browser\'><a href=\'http://www.google.com/chrome\'><span class=\'browser-icon chrome\'></span></a><a href=\'http://www.google.com/chrome\'>Google Chrome</a></td>'+'<td class=\'browser\'><a href=\'http://www.firefox.com/\'><span class=\'browser-icon firefox\'></span></a><a href=\'http://www.firefox.com/\'>Firefox</a></td>'+'</tr>'+'</tbody></table>'+'</div>'},
{html:'<span class=recommended-browsers>One.com recommends using the latest version of <a href=http://www.google.com/chrome>Google Chrome</a>, <a href=http://www.firefox.com>Firefox</a>, <a href=http://www.apple.com/safari/ >Safari</a>, <a href=http://www.opera.com/ >Opera</a> or <a href=http://www.microsoft.com/windows/Internet-explorer/ >Internet Explorer</a>.</span><br><br><span class=proceed>If you want to proceed anyway, click <a href=# onclick=web.windows.NortonAVMakesIE9Slow.anyway();>here</a>.</span>'}
];
web.windows.NortonAVMakesIE9Slow.superclass.initComponent.apply(this,arguments)
}
});
web.windows.NewFeatureMsg=Ext.extend(web.windows.Window,{
type:'web.windows.NewFeatureMsg',
modal:true,
resizable:false,
constructor:function(config){
var that=this;
that.width=714;
that.newFeatures=[];
[
{
title:'Introducing Website Builder Premium',
desc:'Go Premium with Website Builder, and get exciting features; publish large websites, use exclusive templates, backup your website.',
imageCls:'whatsnew-image1'
},
{
title:'Backups in Website Builder',
desc:'Backup & Restore is included in Website Builder Premium. This means backups when you save, and preview of backups. Restore your website from up to 200 saved versions.',
imageCls:'whatsnew-image2'
},
{
title:'High resolution publishing and exclusive templates',
desc:'When you publish your images and icons in Premium, you get high resolution and a pixel-sharp experience on any screen. Premium also includes exclusive template designs.',
imageCls:'whatsnew-image3'
}
].forEach(function(feature){
that.newFeatures.push({
html:'<p class="newfeature-title">'+feature.title+'</p>'+'<p class="newfeature-text">'+feature.desc+'</p>',
imageCls:feature.imageCls
})
});
this.currenFeatureIndex=0;
this.prevArrowHide=true;
if(this.newFeatures.length>1){
this.nextArrowHide=false
}else{
this.nextArrowHide=true
}
web.windows.NewFeatureMsg.superclass.constructor.call(this,config)
},
initComponent:function(){
var app=one.viewport.application;
var isPremium=app.user.subscriptionStatus===web.UserSubscriptionStatus.PREMIUM;
this.cls='newFeatureMsgCntnr';
if(Ext.isIE11||Ext.isIE){
this.cls+=' ie11'
}
this.navigate=function(direction){
var prevBtn=this.item.prevBtn,nextBtn=this.item.nextBtn;
if(direction==='next'){
this.currenFeatureIndex++;
if(this.currenFeatureIndex===this.newFeatures.length-1){
nextBtn.hide();
this.okButton.setText('Close')
}else{
nextBtn.show()
}
prevBtn.show()
}else{
this.currenFeatureIndex--;
if(this.currenFeatureIndex===0){
prevBtn.hide()
}else{
prevBtn.show();
this.okButton.setText('Next')
}
nextBtn.show()
}
this.item.desc.el.update(this.newFeatures[this.currenFeatureIndex].html);
this.item.img.items.items[1].el.dom.className='imgPlaceholder '+this.newFeatures[this.currenFeatureIndex].imageCls;
this.item.counter.update(this.currenFeatureIndex+1+'/'+this.newFeatures.length)
};
this.items=[
{
xtype:'container',
ref:'item',
cls:'itemPlaceholder',
items:[
{
xtype:'container',
cls:'hbox cross-center header',
items:[
{
xtype:'box',
cls:'newFeatureIcon'
},
{
xtype:'container',
cls:'hbox main-between newFeatureHeaderText',
items:[
{
xtype:'box',
html:'What\'s new'
},
{
xtype:'box',
ref:'../../counter',
html:this.newFeatures.length===1?'':'1/'+this.newFeatures.length
}
]
}
]
},
{
xtype:'box',
cls:'desc',
ref:'desc',
html:this.newFeatures[0].html
},
{
xtype:'container',
ref:'img',
cls:'hbox cross-center',
items:[
{
xtype:'container',
cls:'icons-cntnr hbox cross-center',
items:[{
xtype:'button',
ref:'../../prevBtn',
iconCls:'icon-prev',
hidden:this.prevArrowHide,
handler:function(){
this.navigate('previous')
},
scope:this
}]
},
{
xtype:'box',
cls:'imgPlaceholder '+this.newFeatures[0].imageCls
},
{
xtype:'container',
cls:'icons-cntnr hbox cross-center',
items:[{
xtype:'button',
ref:'../../nextBtn',
iconCls:'icon-next',
hidden:this.nextArrowHide,
handler:function(button){
this.navigate('next')
},
scope:this
}]
}
]
}
]
},
{
xtype:'container',
cls:'hbox cross-center web-window-footer',
items:[
{
ref:'../hideNewFeature',
xtype:'checkbox',
boxLabel:'Don\'t show this again'
},
{
xtype:'spacer',
cls:'flex'
},
{
ref:'../upgradeButton',
xtype:'button',
cls:'x-btn-primary large wide',
style:isPremium?'display: none':'',
text:'Upgrade to Premium',
listeners:{
click:function(button){
var app=one.viewport.application;
web.upgradeToPremiumViaPopup({
app:app,
source:'NewFeatureWin:UpgradeBtn'
})
},
scope:this
}
},
{
xtype:'spacer',
width:10
},
{
ref:'../okButton',
xtype:'button',
cls:(isPremium?'x-btn-primary':'x-btn-secondary')+' large wide',
text:'Next',
listeners:{
click:function(button){
if(this.currenFeatureIndex<this.newFeatures.length-1){
this.navigate('next')
}else{
this.close()
}
},
scope:this
}
}
]
}
];
var that=this;
var escHandler=function(evt){
if(evt.key==='Escape'){
that.close()
}
};
this.listeners={
show:function(){
window.addEventListener('keyup',escHandler)
},
close:function(){
window.removeEventListener('keyup',escHandler)
},
scope:this
};
web.windows.NewFeatureMsg.superclass.initComponent.apply(this,arguments)
}
});
Ext.ComponentMgr.registerType('web-windows-new-feature-message',web.windows.NewFeatureMsg);
Ext.ns('one.boneAuth');
one.boneAuth.parseCookieValue=function(cookieValue){
cookieValue=cookieValue||Ext.util.Cookies.get('BoneAuth')||'';
var originallyAuthenticatedEmailAddress;
cookieValue=cookieValue&&cookieValue.replace(/\x1e(.*)$/,function($0,emailAddress){
originallyAuthenticatedEmailAddress=emailAddress;
return''
});
var base64Decoded=Ext.ux.Base64.decode(cookieValue),matchBase64Decoded=base64Decoded&&base64Decoded.match(/^([0-9a-f]{32})([0-9a-f]{8})(.+)$/);
if(matchBase64Decoded){
return{
md5Hex:matchBase64Decoded[1],
timestamp:new Date(1000*parseInt(matchBase64Decoded[2],16)),
realm:matchBase64Decoded[3],
originallyAuthenticatedEmailAddress:originallyAuthenticatedEmailAddress
}
}
};
web.ui.ActionTips=Ext.extend(Object,{
tips:null,
constructor:function(config){
var app=config.app;
this.cfg=config;
this.textMessages={
'actionTip-moveOrResizeFirstComp':{msg:'Keep an eye on the guidelines that appear as you move or resize. They will help you to align your components with other components on your site. You can also turn off the guidelines by holding down Alt on your keyboard.'},
'actionTip-selectSecondComp':{msg:'If you want to select multiple components drag your mouse over the components you want to select. You can also select them by holding down '+('<span style="font-weight: bold">'+(Ext.isMac?'Cmd':'Ctrl')+'</span>')+' on your keyboard, while clicking the components.'},
'actionTip-doubleClickSameArea':{msg:'If you are trying to select a component that is underneath others, use the '+'<span class="icon icon-web-workspace-multiselectnav-tree"></span>'+' button to see other components nearby.'},
'actionTip-jigglingMouseWhileResize':{msg:'Turn off the guidelines by holding down '+'<span style="font-weight: bold">Alt</span>'+' on your keyboard while you move or resize.'},
'actionTip-jigglingMouseWhileDrag':{msg:'Adjust the position of components with the arrow keys on your keyboard.'},
'actionTip-firstTimeChangeColor':{msg:'Remove a color by clicking the '+'<span class="icon web-ui-actiontips-x-icon"></span>'+' button inside the color box.'}
};
this.currentMessages=[];
var textMessages=this.textMessages;
for(var property in textMessages){
if(textMessages.hasOwnProperty(property)){
if(app.dal.uiState.get(property)==='yes'){
textMessages[property].alreadySeen=true
}
}
}
web.ui.ActionTips.superclass.constructor.call(this,config)
},
pushMessage:function(msgKey){
var textMessage=this.textMessages[msgKey];
if(textMessage&&!textMessage.alreadySeen&&!this.currentMessages[msgKey]){
if(!this.tips){
this.tips=new Ext.ToolTip({
target:this.cfg.app.workspace.el,
trackMouse:false,
autoHide:false,
closable:true,
cls:'customTip',
listeners:{
hide:function(){
var currentMessages=this.currentMessages,app=this.cfg.app;
for(var property in currentMessages){
if(currentMessages.hasOwnProperty(property)){
app.dal.uiState.set(property,'yes');
this.textMessages[property].alreadySeen=true;
delete currentMessages[property]
}
}
this.tips.destroy();
this.tips=null
}.createDelegate(this),
beforeshow:function(){
for(var key in this.currentMessages){
if(this.currentMessages.hasOwnProperty(key)){
return true
}
}
return false
}.createDelegate(this)
}
})
}
this.tips.add(new Ext.Container({
style:{margin:'0px 10px 15px 0px'},
html:textMessage.msg
}));
this.tips.doLayout();
this.currentMessages[msgKey]={msg:textMessage};
this.tips.showAt([
0,
0
])
}
},
isAlreadySeen:function(msgKey){
return this.textMessages[msgKey].alreadySeen
},
hideTips:function(){
if(this.tips){
this.tips.addClass('hideTips')
}
},
showTips:function(){
if(this.tips){
this.tips.removeClass('hideTips')
}
}
});
web.utils.IntercomTracker={
isValidUser:false,
consoleEnabled:false,
boot:function(userInfo){
var appId='nqpz9vww';
if(!false){
delete this.enable
}
if(appId){
window.Intercom('boot',{
'app_id':appId,
'email':userInfo.email,
'user_hash':userInfo.intercomIdentityKey,
'created_at':userInfo.orderCreateTime,
'name':userInfo.customerName
});
this.isValidUser=true
}
},
trackEvent:function(event){
var v=this.isValidUser;
if(false&&!this.consoleEnabled){
v=null
}
if(v){
window.Intercom('trackEvent',event)
}
},
enable:function(){
if(false){
this.consoleEnabled=true;
return'Intercom tracking is now enabled.'
}else{
return'This command only works on staging or next.'
}
}
};
web.utils.AppEventCollector={
extend:function(obj1,obj2){
for(var prop in obj2){
if(obj2.hasOwnProperty(prop)){
obj1[prop]=obj2[prop]
}
}
return obj1
},
sendEventToAppEventCollector:function(tag,input){
var url='https://aec.one.com/';
var app='webeditor';
var env='production';
if(!url||!app||!env){
return
}
url=url.replace(/\/$/,'');
var extend=web.utils.AppEventCollector.extend;
var body=extend({},input);
body=extend(body,{
'app':app,
'env':env
});
var xhr=new XMLHttpRequest;
xhr.open('POST',url+'/event/'+tag);
xhr.withCredentials=true;
var payload;
if(typeof FormData==='function'){
payload=new FormData;
Object.keys(body).forEach(function(key){
if(typeof body[key]!=='undefined'){
payload.append(key,body[key])
}
})
}else{
xhr.setRequestHeader('Content-Type','application/json;charset=utf-8');
payload=JSON.stringify(body)
}
xhr.send(payload)
},
sendHeartbeat:function(){
web.utils.AppEventCollector.sendEventToAppEventCollector('heartbeat',{eventtype:'heartbeat'})
}
};
web.utils.Url={
getParams:function(specificUrl){
function parseToObj(str,re){
var o={};
while(true){
var e=re.exec(str);
if(!e){
break
}
o[e[1]]=e[2]
}
return o
}
var st=specificUrl||location.href;
return{
beforeHash:parseToObj(st,/([^#?&=]+)=([^&#]*)(?=.*?\#)/gi),
afterHash:parseToObj(st,/([^#?&=]+)=([^&#]*)(?!.*?\#)/gi)
}
}
};
web.Application=Ext.extend(one.Application,{
name:'Website Builder',
coreEvents:[
'adjust',
'auto-adjust',
'update',
'select',
'deselect',
'mode',
'view',
'load',
'activate',
'delete',
'save',
'dragstart',
'dragging',
'dragend',
'import',
'focus',
'launch'
],
prepareForLaunch:function(oldApplication,callback,scope){
var domain,authenticationData=one.boneAuth.parseCookieValue(),hasValidCookie=false,applicationConfig={preferences:{}},prefs=applicationConfig.preferences,delay=Date.now()-scope.invokeTime.getTime(),tooLateToMigrate=false,requestUserAndSite;
if(authenticationData){
domain=authenticationData.realm;
hasValidCookie=true
}
if(location.hash){
var overrideDomain=web.utils.Url.getParams().afterHash.targetDomain;
if(overrideDomain){
if(overrideDomain!==domain){
hasValidCookie=false
}
domain=overrideDomain
}
}
applicationConfig.dal=new web.DAL({
domain:domain,
listeners:{
needlogin:function(){
web.redirectToLoginPage({
specifySelfAsSuccessUrl:true,
domainName:applicationConfig.dal.domain,
originallyAuthenticatedEmailAddress:authenticationData&&authenticationData.originallyAuthenticatedEmailAddress
})
},
needmigrate:function(){
if(!tooLateToMigrate){
var infoDiv=document.querySelector('.one-viewport-progress-info');
infoDiv.innerHTML='We are moving your site to the new Website Builder. It might take a few minutes, so please wait...';
applicationConfig.dal.migrate(function(success,response){
infoDiv.innerHTML='';
if(!success){
Ext.Msg.show({
title:'',
cls:'web-modal-warning x-window-dlg',
iconCls:'web-warning-icon',
msg:'We\'re sorry, but this takes longer than expected. In the meantime we\'ll continue to move your site. Please try again in 10 minutes.',
buttons:{ok:'OK'}
})
}else if(success&&!response.success){
one.fatal('Custom - Migration failed');
one.error('<b>'+'Moving your site to the new Website Builder failed.'+'</b>'+'<br />'+'Please contact our support for further assistance.','Moving failed')
}else{
requestUserAndSite()
}
})
}else{
Ext.Msg.show({
cls:'web-modal-warning x-window-dlg',
iconCls:'web-warning-icon',
title:'Updated',
msg:'Oops! Your session is unrecoverable. You will have to reload.',
buttons:{ok:'OK'},
fn:function(){
window.location.reload()
},
scope:this
});
one.fatal('Session is unrecoverable requiring a page reload')
}
}
}
});
if(!hasValidCookie){
applicationConfig.dal.paused=true;
applicationConfig.dal.fireEvent('needlogin')
}
async.seq(function(next){
if(Ext.isIE9&&delay>2000){
this.track([
'Application',
'nav-ie9-slow',
'delay',
delay
]);
var w=new web.windows.NortonAVMakesIE9Slow({
callback:function(){
next();
this.track([
'Application',
'nav-ie9-slow-proceedanyway'
])
},
scope:this
});
w.show()
}else{
next()
}
},function(next){
applicationConfig.dal.queueRequest({
url:function(){
return applicationConfig.dal.defaultUrl+'/migrate'
},
method:'GET',
callback:function(opts,success,response){
if(!response.responseText){
throw new Error('Migration error: 2140')
}
var responseObj=Ext.decode(response.responseText);
if(success){
if(window.DATAVERSIONNUMBER===undefined){
window.DATAVERSIONNUMBER=responseObj.latestDataVersionNumber
}
next()
}
}
})
},requestUserAndSite=async.seq(function(next){
applicationConfig.dal.queueRequest({
url:function(){
return applicationConfig.dal.defaultUrl+'/preferences/1/webEditorUiState'
},
method:'GET',
callback:function(opts,success,response){
if(success){
prefs.user=Ext.applyIf({type:'web.User'},Ext.decode(response.responseText));
prefs.user.firstVisit=false
}else{
prefs.user={
id:'userConfig',
type:'web.User',
webEditorUiStateWasUnavailable:true,
firstVisit:true
}
}
prefs.domain=domain;
prefs.user.subscriptionStatus=web.UserSubscriptionStatus.UNKNOWN;
oneJQuery.ajax({
url:'/api/v1/'+domain+'/subscriptionStatus',
timeout:15000,
success:function(data,textStatus,jqXHR){
prefs.user.subscriptionStatus=data.subscriptionType;
var availableUpgrade=data.availableUpgrades&&data.availableUpgrades[0];
if(availableUpgrade){
prefs.user.freeUpgradeAvailable=availableUpgrade.freeUpgradeAvailable===true;
prefs.user.subscriptionEnd=availableUpgrade.subscriptionEnd;
prefs.user.chargesForUpgrade=availableUpgrade.chargesForUpgrade
}
},
complete:function(){
next(null,prefs)
}
})
}
})
},function(prefs,next){
if(prefs.user.subscriptionStatus===web.UserSubscriptionStatus.PREMIUM){
next(null,prefs)
}else{
prefs.user.subscriptionStatusBackupRestore=web.UserSubscriptionStatusBackupRestore.UNKNOWN;
oneJQuery.ajax({
url:'/api/v1/'+prefs.domain+'/subscriptionStatusBackupRestore',
timeout:15000,
success:function(data,textStatus,jqXHR){
if(data){
if(data.subscribed===true){
prefs.user.subscriptionStatusBackupRestore=web.UserSubscriptionStatusBackupRestore.SUBSCRIBED
}else if(data.subscribed===false){
prefs.user.subscriptionStatusBackupRestore=web.UserSubscriptionStatusBackupRestore.NOTSUBSCRIBED
}
}
},
complete:function(){
next(null,prefs)
}
})
}
},function(prefs,next){
applicationConfig.dal.get('web.data.Site','site',function fnSuccess(opts,success,response){
if(success){
var site=Ext.decode(response.responseText),pageId;
prefs.site=site;
var allowOldAndNewWsbTogether=false;
try{
var shaObj=new jsSHA('SHA-1','TEXT');
shaObj.update(domain);
var shaHash=shaObj.getHash('HEX');
allowOldAndNewWsbTogether=localStorage['allowOldAndNewWsbTogether']==='yes'||'no'==='yes'||([
'62f3d4e74f273b2fc90e955eaf6e3147d7f89c66',
'e4d59908b5db3b46723499f5896fa0bfc1165c2a',
'3a83c4ed2a51605e1d1b8b21f2bae2c0747d2d7b',
'6d2ecd9c36114106b886d924936cdfca2104ed99',
'bb3323417e565dc4800d12bac0005cb5c3e209e4',
'7fe11ed84a8bfd51492236d507fd964a681ab9c3',
'68d74f83a84ca42d74918f1b9b9e4a7c7417ad62',
'31a524986af77e9f0e6079ac2a64b90b4fbeb197',
'3d9d81cc761190b2a75ac5b3860a5ae0d34c5281',
'80aceade4f19b01a519da7ba7fce5165917cd745',
'80b534dadc5d5e8a7cce2a603a04953f1d6e7a2a',
'3553b09ffe4080c2076e8b5208ddda6143457b68',
'2e6b536f6dfd50a80795b110a2e8ac7d52212b6b',
'1616f86103625c1f25d5d4a7d456eea4d08c75a2',
'0f54651f3671fac48777cff5487a140852f7579c',
'09f57ed51773f5382f15a97641fb1b415cbd1927',
'64db771c10a7841548314a282b164c2a504b3b51',
'dff2d3446a8769edf69e58807431047ef7824f97',
'301e12bf0e95df5c8e49a5e4edfca23fbe7b7b2b',
'9de149261a605f57ea156271328c929642d0b6a1',
'd6872760f3994e97b0b5691c49e7ec61a63aa337',
'501231a59d1bf555557605606df2eb5afeeca050',
'cb10525c36191e223f4680d7f4d06b0ec688c7c6',
'c1345d6e4177a9cf7a44f1f5d6a8815bbd56c049',
'4eb6949e198faa1e82c9e89870a6b6dd40d2c4b5',
'541aa3fc9c8245b3ea3ceb33304ca0c612ea3fd1',
'515c599318355064936a0540edbd02e626ab54f5',
'415f0707fe556cdccd7d17e6ee06c8ffbc09dc64',
'b1ef880f067e054a3444738962794dd365ea0549',
'ad3be5bfabbf71a1a42ef6b8fb3a00c7d349facc',
'a19be8650968792098f8282260de8fb27575af9c',
'cf550ae6262c06204d069349d8d6fee6c6f6b377',
'b0cb44ee262c635906311cf5928c72370b23d284',
'9636a67660390dbbef1fdffa825e00474d88db7b',
'e2655cca389f1f87cb027e2288a337ccd356e23e',
'5d53caad2a62b328043186e6f3120ea0852d8987',
'33367fcfd7b8c003064122260fa7175fca9524b6',
'b1a4dcddd056593193d2b4c62243c4dcedc1cc10',
'0d090416d202dd78ec5273053c0bf76634d2efec',
'09890b809d66e20dcc145d27ea55ba89fd1fb10d',
'7fc7f27dd83424a1fdaf23c1321bf3aee935925b',
'fa822bb0e7cd2c9d5f3613838ed340898e57144d',
'89893c8d2c25e19202072dedf4a5d123048f4453',
'47682756071bc30c243c6558edd89e17393ea156',
'916a3bc75a85d1f49cd2ecf67d764ebb542ba2dd',
'877ff76ea6cb28ece69c6c6115adaca1fb036fdf',
'2b9e1903045e0de1ff4541359be2a3928c7e4fec',
'fdcc498283199d44d90fc640a2e6560e302b7801',
'a64eb87b75dbc25b65fb0cc4623d126d79cc542f',
'e77628ac9cb95c6457282f16e08e27e4b8f06cc8',
'c30e1ca986e5a747b173314eaebd2ed67b0f4703',
'2bb2ab89420b77e8df5700a28cf780e9ad07fe2d',
'84ff48075882d2b0efc10b985883f981e77fae3f',
'77fafe19b131164fde4106756f029887dba97364',
'c5dd21ebd0cc68f34f97ed3c4eae7dda53082b21',
'b06dbeb4ef12a194299b0684f926865d8fafc432',
'c1134b16b6f6cf85468c98da87100e2d7b0e0df5',
'766143a87ec816e683c61c87f3147f8bd61d44a3',
'67faf3000acb5d635e832599df2a1dfe868524ac',
'092f0c95d86f6c34a82f8e895e79a9a23d557c6c',
'4f5344f5b03f75a3123ac84bbdb8f88d45021cd7',
'0a8201f1fd23449ac35321b0d95b3fc9889e024c',
'0d73e45dcba04aa85f94f22dabb282dffbecee6e',
'4841b532c5904a9e68158ec58f208fbd68c10f8a',
'dc78b7f12ba97dbd8c795fd397e943fc26617e79',
'd1f306ca018e708539fafe1aeeebdccb1a92057c',
'482dedc03dca1ce33aaac031bda0d5dae183644c',
'79dfc73f32ebef6266e6819fb6428aae6dffe7f5',
'7f4a640c12e86c2effc5cea7920e4361e2703e85',
'aa48b1bdc158aa728a0a9d4cd9f78516e5d02d18',
'7d891863effbfe11e10a788e86810dbc1705ebd3',
'2c839d9b5b0802091acb0a4500475cd34ef98108',
'758f0d67ab6a877d29c830bf01e5eae132b7867c',
'16d0519fdf2c26377f2dd080d709458c12380473',
'c0f595427af1702f361aeec157a2f5370725faa2',
'0b0f2b2e8059d0b8be4a138c99eab7de4250699a',
'262960239b92f6c8849c6e6c993482acbc1b4665',
'be24182db458240db7c971b7596ae91cc151ebf7',
'e5246c2c6fd9a112b3b57c7f43f83458cade5f55',
'3e85dc71c68c47aa178a28fe704b2aead2d6f4c0',
'b4f15b48e206f7e10a1e8df69119ad4ba64690f5',
'f6ac6ae732e9f1303e1d5ad1434f72f18d8efea2',
'5b0384a44b00052539557db580970c4de6d8d09c',
'7f3c66bd10ea2a3377e4577301bc1cbd7c05ecc4',
'c52fbcfa70b7dddb2c417e53a96d9b217726fdfb',
'c2e3b8acfd93323e71386b1c36c78ad981210426',
'fa22276280d841844db5ea82071f2d3f39d084b4',
'9f2120abcadb7f89377b545d89b7349da9dcefa9',
'70d26987871426cade2480745f99220b2e20c904',
'22e526c23c77e1f90808d67a9fbedb3e8d55491a',
'1e804564ee9b116e9ea650770b8ffda638d4d51b',
'94d7515394dc3cf156a814c3defcbae4a3047f61',
'f16fac39de875e82262e775b221a8b65e8b388dc',
'3b7eed5d3d43039520ce052c0555334cc5c6bc71',
'48265db96fe5985fc658643424537a5519b0ad60',
'5d5123c0948ba90a1fb7271adebd6d47f538a6fe',
'ddbbb0779bf6ae71bd535ab300b155cc62894b58',
'03dc1bf8f7a1bd54db4b1a112601089e9ea44c99',
'2154637a4753649de1b272a192e506bd067caf2d',
'157af01fa944815d5525ee6f41c5fe37a41a18ba',
'cb2ff08b19426c501166b40c015d6edcdd1cdc0a',
'44a4c5c76bbfc2761cc00b2377e81b3c7705fd7e',
'426134b9123365766962729279110fa7af56ef2d',
'9e46fdc03d205e41874a7cf046683cc283cb544f',
'e2655cca389f1f87cb027e2288a337ccd356e23e',
'8dd4dd6a4cb5b2dc2d0a9920b890c71f4071ce10',
'd5f5c02bd72873500253e7999cb2e7f8a7aed218',
'66af15e7652a921fe23f43746b28843478dbe3f2',
'7fed8a8ee0f3aac190cabf69f98cc91cb4d7576f',
'9d2535296c7232176e5f214762bcf048c0a5ae8b',
'6416ce625f4efc2ee02ed1a34da60f8bfa36f9e7',
'd98907dc0e1dfea7f3fef65e7b0feecec9ab4266',
'9eec36b00843be296cb1042d5ae2e889bc880369',
'e180d2a3fd11aa1725a84d505e7190b465f676bd',
'b6a62e76c91e37b3b36ff515ccf93016718a1bf8',
'c0d90f1ac6f46ce7a7d07f372517843d541880eb',
'501231a59d1bf555557605606df2eb5afeeca050',
'edd4ce385c5db3f2eb8629d96e64942b0fe8ae3c',
'43e7fb4693c528fccea750b713a4346486c50581',
'63205cd5b1fd1a65d309981435fba3814b3d3559',
'f416ee1efc69db60392c134ea745f2a7ec0058b8',
'4360dcedaa29d213057cf0aae1b89ca403a82c4a',
'dc3675922c4c9e833baf52651870ea3a4b91df4e',
'3f7e49d95df81236c7c44eeb871dccc2092e7f78',
'ab3c339df4222e39759efcf86bf9c5d1767d87af',
'84ff48075882d2b0efc10b985883f981e77fae3f',
'79dfc73f32ebef6266e6819fb6428aae6dffe7f5',
'd6872760f3994e97b0b5691c49e7ec61a63aa337',
'6e8c024761b2ca7470f252d9c35772e59ab7494c',
'33225b08198d8de8aa52dbac172d045fc77e0721',
'779dc2122a6b05f598448dfc99e018c7bdd7c008',
'9220a560d4efd633fa6c77664cb0cf728af8c8c8',
'4c779a354c49dc2fe3485612242fb3ce2fb12d83',
'0f439a1781a11e65a179e4412c5f812f69c68575',
'da59c12c48ccfa5f5ace3cffbc9e7c86112e5fac',
'8b13e278847d64b1338aaa100e15d3d4a3ef5031',
'ed63f0d10be0346606735f8da7c085d8dc3c55d8',
'2c839d9b5b0802091acb0a4500475cd34ef98108',
'758f0d67ab6a877d29c830bf01e5eae132b7867c',
'c0f595427af1702f361aeec157a2f5370725faa2',
'8d8494245b63f738a0d2a4727d455d7766868e77',
'48265db96fe5985fc658643424537a5519b0ad60',
'03dc1bf8f7a1bd54db4b1a112601089e9ea44c99',
'2154637a4753649de1b272a192e506bd067caf2d',
'1b68e930617715f8d705ae8a35e6531d28024c9b',
'766143a87ec816e683c61c87f3147f8bd61d44a3',
'67faf3000acb5d635e832599df2a1dfe868524ac',
'88b790d1acbc25153aa5c868a8eea7090e49a406',
'dc78b7f12ba97dbd8c795fd397e943fc26617e79'
]||[]).indexOf(shaHash)>=0
}catch(e){
}
if(site.prefersNewWSB&&!allowOldAndNewWsbTogether){
window.location=window.location.origin+'/new';
return
}
pageId=function(){
var uiStateLastPageId=applicationConfig.dal.uiState.get('lastPageId'),folder=site.folder,firstPageIdInSite;
if(!folder||!folder.items||!folder.items.length){
applicationConfig.dal.uiState['delete']('lastPageId');
uiStateLastPageId=null;
site.homePageId=''
}
var linkPages=[];
(function(){
var getLinkPages=function(item){
var items=item&&item.items;
if(items&&items.length){
Ext.each(items,function(link){
if(link.type==='web.data.links.LinkPage'){
linkPages.push(link);
getLinkPages(link)
}
})
}
};
getLinkPages(folder)
}());
var isExistingPage=function(pageId){
var pageExists=false;
Ext.each(linkPages,function(linkPage){
if(pageId===linkPage.pageId){
pageExists=true;
return false
}
});
return pageExists
};
if(uiStateLastPageId&&isExistingPage(uiStateLastPageId)){
return uiStateLastPageId
}else if(site.homePageId){
return site.homePageId
}else{
Ext.each(linkPages,function(linkPage){
firstPageIdInSite=linkPage.pageId;
return false
});
return firstPageIdInSite||null
}
}();
next(null,prefs,pageId)
}else{
one.fatal('Custom - Unable to load '+opts.url);
Ext.Msg.show({
closable:false,
buttons:{ok:'OK'},
fn:function(){
applicationConfig.dal.get('web.data.Site','site',fnSuccess)
},
cls:'web-modal-warning x-window-dlg',
iconCls:'web-warning-icon',
title:'Could not load your site',
msg:'<b>'+'Could not load your site'+'</b><br/>'+('Click '+('<b>'+'OK'+'</b>')+' to try again or contact our support for further assistance.')
})
}
})
},function(prefs,pageId,next){
if(pageId){
applicationConfig.dal.getAllPageData(pageId,function(opts,success,response){
if(success&&response.responseText){
var txt=response.responseText,json=Ext.decode(txt);
prefs.page=json.page;
prefs.template=json.template;
prefs.stylesheet=json.stylesheet;
applicationConfig.dal.getPublishedState(function(opts,success,response){
if(success){
var info=Ext.decode(response.responseText);
prefs.publishStatus=info.status;
prefs.publishInfo=info
}
next()
})
}else if(success){
one.fatal('The AJAX request was successful but response was blank. (response.responseText = "'+response.responseText+'")',{requestedUrl:opts&&opts.url});
next()
}else{
next()
}
})
}else{
next()
}
},function(){
tooLateToMigrate=true;
callback.call(scope||window,applicationConfig)
}))();
window.setTimeout(function(){
if(!scope.application&&!(one.Application.loginDialog&&one.Application.loginDialog.isVisible())){
one.fatal('Custom - application not available even after long wait')
}
},90000)
},
constructor:function(config){
this.addEvents.apply(this,this.coreEvents);
this.user=null;
this.mode='page';
this.preferences=config.preferences||{};
this.dal=config.dal;
this.dm=new web.DM;
this.invoker=new web.commands.Invoker(this);
this.panels={};
this.rep=new web.Repository;
this.selections={};
this.isFirstVisit=false;
this.windows=new web.windows.WindowFactory(this);
this.startTips=new web.controllers.tips.StartTips({app:this});
this.googleWebFonts=new web.controllers.googlewebfonts.GoogleWebFonts({app:this});
this.initKeyMaps();
this.initFocus();
this.initListeners();
this.applyPreferences();
this.initDebug();
this.initIntercom();
this.updatePremiumUI();
this.updateBackupRestoreUI();
this.dal.getEncryptedDomain(function(options,success,response){
if(success){
var json=JSON.parse(response.responseText);
this.googleAnalyticsCustom('dimension1',json.encryptedDomain);
this.trackEvent({
eventCategory:'Application',
eventAction:'start'
})
}
},this);
setInterval(function(){
web.utils.AppEventCollector.sendHeartbeat()
},300000);
web.utils.AppEventCollector.sendHeartbeat();
web.Application.superclass.constructor.call(this,config)
},
initDebug:function(){
var versionMeta=Ext.query('meta[http-equiv="Content-Version"]')[0];
if(versionMeta&&versionMeta.getAttribute('content').indexOf('/production')===-1){
one.Log.addHandler(one.Log.DEBUG,function(msg,obj,levelName){
try{
;
if(obj){
;
}
}catch(exIE){
try{
;
if(obj){
;
}
}catch(ex){
}
}
})
}
},
initComponent:function(){
var publishing,toolbarMode,toolbarUndoRedo,sitemap,components,properties,headerHeight=48,toolbarHeight=60;
this.heightBeforeWorkspace=headerHeight+toolbarHeight;
publishing=new web.panels.Publishing({
itemId:'publishing',
app:this,
height:28,
publishStatus:this.preferences.publishStatus,
publishInfo:this.preferences.publishInfo,
style:{padding:'0'}
});
toolbarMode=new web.panels.Mode({
itemId:'mode',
app:this,
height:toolbarHeight,
style:{padding:'0'}
});
toolbarUndoRedo=new web.workspace.Toolbar({
itemId:'workspacetools',
app:this,
flex:1,
style:{padding:'0'}
});
sitemap=new web.panels.SiteMap({
itemId:'sitemap',
app:this,
minHeight:200,
height:300,
region:'north',
split:true
});
components=new web.panels.Components({
itemId:'components',
app:this,
region:'center',
minHeight:200,
height:455
});
properties=new web.panels.Properties({
itemId:'properties',
app:this,
plugins:[new web.ui.plugins.DomObserver({
click:function(event){
var customPanel=null,customPanelBody=null,expandedPanels=document.body.querySelectorAll('.web-props-panel .custom-panel-isExpanded'),expandedPanelLength=expandedPanels.length;
if(expandedPanelLength===0){
return
}else if(expandedPanelLength===1){
if(this.find('id',expandedPanels[0].id)[0].container.contains(event.target)){
return
}else{
customPanelBody=this.getEl().dom.querySelector('.custom-panel-isExpanded');
customPanel=this.find('id',customPanelBody.id)[0].findParentByType('container');
this.collapseCustomPanel(customPanelBody,customPanel)
}
}else if(expandedPanelLength>1){
for(var i=0;i<expandedPanelLength;i+=1){
if(!event.within(Ext.get(expandedPanels[i]).prev().prev())){
customPanel=this.find('id',expandedPanels[i].id)[0].findParentByType('container');
customPanelBody=expandedPanels[i];
break
}
}
this.collapseCustomPanel(customPanelBody,customPanel)
}
},
scope:this
})]
});
this.properties=properties;
var preview=new web.panels.Preview({
app:this,
isPublishButtonDisabled:function(){
return publishing.publishButton.disabled
},
onPublish:function(cb,scope){
publishing.onPublish(cb,scope);
this.close()
}
});
this.preview=preview;
var templateSelector=new web.panels.TemplateSelector({app:this});
this.templateSelector=templateSelector;
var pageImport=new web.windows.PageImport({
app:this,
region:'center'
});
this.pageImport=pageImport;
this.workspace=new web.workspace.Panel({
itemId:'workspace',
region:'center',
app:this,
listeners:{
'auto-adjust':function(){
if(this.app.waitForAdjust){
this.app.waitForAdjust=false;
this.app.fireEvent('launch');
this.app.showRestoreSuccessMessage()
}
}
}
});
this.actionTips=new web.ui.ActionTips({app:this});
this.id='web-0';
this.cls='web-app';
this.border=false;
this.layout='border';
this.items=[
{
region:'north',
border:false,
height:headerHeight,
layout:'border',
items:[{
region:'center',
xtype:'container',
height:headerHeight,
layoutConfig:{align:'stretch'},
items:[{
xtype:'web-panels-header',
flex:1
}],
border:false,
layout:{
type:'hbox',
align:'stretch'
},
defaults:{
app:this,
border:false
}
}]
},
{
region:'center',
xtype:'container',
layout:'card',
ref:'cards',
layoutOnCardChange:true,
activeItem:0,
items:[
{
xtype:'container',
layout:'border',
ref:'main',
items:[
{
region:'north',
xtype:'container',
layout:'border',
height:toolbarHeight,
defaults:{
border:false,
layout:{
type:'hbox',
align:'stretch'
},
defaults:{
app:this,
border:false
}
},
style:{'background-color':'#f9f9f9'},
items:[
{
region:'west',
layout:'hbox',
layoutConfig:{align:'top'},
items:publishing,
cls:'top-bar light-green',
width:315,
height:toolbarHeight,
style:{paddingTop:'15px'}
},
{
region:'center',
layout:'hbox',
layoutConfig:{align:'bottom'},
items:[
toolbarMode,
toolbarUndoRedo
],
cls:'top-bar light-green',
height:toolbarHeight,
style:{paddingTop:'10px'}
},
{
region:'south',
xtype:'container',
layout:'hbox',
layoutConfig:{align:'stretch'},
height:7,
items:[
{
xtype:'container',
width:315,
style:'background-color: #f9f9f9',
html:''
},
{
xtype:'container',
flex:1,
style:'background-color: #34525f; '
}
]
}
]
},
{
xtype:'tabpanel',
ref:'../../sidebar',
region:'west',
activeTab:0,
border:false,
width:315,
defaults:{border:false},
cls:'sidebar',
layoutOnTabChange:true,
deferredRender:false,
items:[
sitemap,
components,
properties
],
listeners:{
render:function(){
this.on('select',function(c,t){
if(c==='tab'){
this.sidebar.setActiveTab(t)
}
},this)
},
tabchange:function(){
document.body.focus()
},
scope:this
}
},
this.workspace
]
},
{
xtype:'container',
layout:'border',
items:[{
region:'center',
items:[preview]
}]
},
{
xtype:'container',
layout:'border',
items:[{
region:'center',
items:[templateSelector]
}],
listeners:{
initializeCard:function(config){
templateSelector.setValues(config.values);
templateSelector.removeOldListeners(config.listeners);
templateSelector.addPassedListeners(config.listeners);
templateSelector.resetUi()
}
}
},
{
xtype:'container',
layout:'border',
items:[pageImport]
}
]
}
];
this.plugins=[
new web.DocumentLoader,
new web.dd.Proxy
];
web.Application.superclass.initComponent.apply(this,arguments);
this.panels={
workspace:this.workspace,
publishing:publishing,
sitemap:sitemap,
components:components,
properties:properties
};
this.makeShadows();
this.makePremiumTopBar()
},
getSidebar:function(){
return this.sidebar
},
initListeners:function(){
this.rep.on('needmigrate',function(){
var cfg={
title:'Updated',
msg:'Website Builder has been updated. Please save your work and reload.',
buttons:{
yes:'Save and Reload',
no:'Reload without saving'
},
fn:function(buttonId){
if(buttonId==='yes'){
this.on('save',function(){
window.location.reload()
});
this.save()
}else{
window.location.reload()
}
},
scope:this
};
if(!this.hasUnsavedChanges()){
cfg=Ext.apply(cfg,{
title:'Updated',
msg:'Website Builder has been updated. Your work is already saved. Please reload.',
buttons:{ok:'OK'}
})
}
Ext.Msg.show(cfg)
},this);
this.on('activate',this.activatePanel,this);
this.on('save',function(part,options){
if(part instanceof web.data.links.LinkPage||part instanceof web.data.Site){
if(options&&options.saveFailed){
return
}
var foundPage=this.site.getFolder().getItems().some(function(link){
return link instanceof web.data.links.LinkPage
});
if(!foundPage){
this.createFirstPage()
}
}
},this);
this.on('mode',this.onMode,this);
this.on('select',this.onSelect,this);
this.on('deselect',this.onDeselect,this);
this.on('launch',this.firstAction,this,{single:true});
this.googleWebFonts.on('google-fonts-active',function(){
this.fireEvent('fonts-status');
this.fireEvent('fonts-active')
}.bind(this));
this.googleWebFonts.on('inactive',function(){
this.fireEvent('fonts-status');
this.fireEvent('fonts-inactive')
}.bind(this))
},
activatePanel:function(option,config){
var cards=this.cards;
if(option==='workspace'){
cards.layout.setActiveItem(0);
cards.doLayout();
this.enableDisableTooltips('enable');
this.showHideShadow('vertical','show');
this.showHideShadow('horizontal','show');
oneJQuery('.premium-top-bar').removeClass('hide');
this.actionTips.showTips()
}else if(option==='preview'){
setTimeout(function(){
cards.layout.setActiveItem(1);
cards.doLayout();
this.enableDisableTooltips('disable');
this.showHideShadow('vertical','hide');
oneJQuery('.premium-top-bar').addClass('hide');
if(config&&config.mode==='backups'){
this.preview.refresh({showHideBackupOptions:'show'});
this.track([
'Backups',
'preview'
])
}else{
this.preview.refresh({showHideBackupOptions:'hide'});
this.track([
'Publishing',
'preview'
])
}
}.bind(this),50);
this.actionTips.hideTips()
}else if(option==='templates'){
cards.layout.setActiveItem(2);
cards.doLayout();
cards.layout.activeItem.fireEvent('initializeCard',config);
this.enableDisableTooltips('disable');
this.showHideShadow('vertical','hide');
this.showHideShadow('horizontal','hide');
oneJQuery('.premium-top-bar').addClass('hide');
this.actionTips.hideTips()
}else if(option==='pageimport'){
cards.layout.setActiveItem(3);
cards.doLayout();
this.pageImport.init(config.values);
this.pageImport.showPage('preface');
this.enableDisableTooltips('disable');
this.showHideShadow('vertical','hide');
this.showHideShadow('horizontal','show');
oneJQuery('.premium-top-bar').addClass('hide');
this.track([
'Import Tool',
'Start'
])
}
},
checkContext:function(){
var dom=document.activeElement;
return Ext.fly(dom).hasClass('one-rte-capture')||!Ext.WindowMgr.getActive()
},
isText:function(){
var name=document.activeElement.nodeName.toLowerCase();
return name==='input'||name==='textarea'
},
initKeyMaps:function(){
Ext.get(document).on('keydown',function(ev){
var e=ev.browserEvent,keycode=e.keyCode,ctrlOrCmd=e.ctrlKey||e.metaKey,shiftOrAlt=e.altKey||e.shiftKey;
switch(keycode){
case 83:
if(ctrlOrCmd&&!shiftOrAlt){
ev.stopEvent();
this.save()
}
break;
case 90:
if(this.checkContext()){
if(ctrlOrCmd&&!shiftOrAlt){
this.invoker.undo();
ev.stopEvent()
}else if(e.metaKey&&e.shiftKey&&!e.altKey){
this.invoker.redo();
ev.stopEvent()
}
}
break;
case 89:
if(e.ctrlKey&&!shiftOrAlt&&this.checkContext()){
this.invoker.redo();
ev.stopEvent()
}
break;
case 27:
if(ctrlOrCmd&&!shiftOrAlt){
var component=this.getSelected('component'),page=this.selections.page,template=this.selections.template,next;
if(component&&page&&template){
if(component!==page&&component!==template){
next=this.isPageMode(component)?page:template;
this.fireEvent('deselect',component);
this.fireEvent('select',next)
}
}
ev.stopEvent()
}
break;
case 65:
if(ctrlOrCmd){
if(!this.isText()){
if(this.checkContext()){
this.fireEvent('selectall',ev)
}
ev.stopEvent()
}
}
break
}
},this)
},
initFocus:function(){
var handler=function(e){
e=e||window.event;
var oldFocus=this.focus,newFocus=document.activeElement,isFocus;
if(oldFocus!==newFocus){
this.focus=newFocus;
isFocus=e.type.indexOf('focus')>-1;
this.fireEvent('focus',newFocus,oldFocus,isFocus?'focus':'blur')
}
}.createDelegate(this);
if(document.addEventListener){
document.addEventListener('focus',handler,true);
document.addEventListener('blur',handler,true)
}else{
document.attachEvent('onfocusin',handler);
document.attachEvent('onfocusout',handler)
}
},
initIntercom:function(){
this.dal.getDomainOwnerData(function(opts,success,response){
if(success){
var info=JSON.parse(response.responseText);
if(!info.error){
web.utils.IntercomTracker.boot(info)
}
}else if(response.status===500){
one.fatal('Custom - getDomainOwnerData() request failed from server end with status 500')
}
})
},
onSelect:function(part){
var template,stylesheet,oldPage;
if(!part){
one.fatal('Select event fired with undefined part.')
}else if(part instanceof web.data.components.Page){
oldPage=this.getSelected('page');
template=part.getTemplate();
if(this.inPageMode()){
this.setSelected('component',part)
}
this.setSelected('page',part);
if(!template){
one.fatal('Part is selected without template available.')
}else{
this.setSelected('template',template);
stylesheet=template.getStylesheet();
if(!stylesheet){
one.fatal('Template via page is selected without stylesheet available.')
}else{
this.setSelected('stylesheet',stylesheet)
}
}
}else if(part instanceof web.data.components.Template){
this.setSelected('template',part);
this.setSelected('component',part);
stylesheet=part.getStylesheet();
if(!stylesheet){
one.fatal('Template is selected without stylesheet available.')
}else{
this.setSelected('stylesheet',stylesheet)
}
}else if(part instanceof web.data.styles.Stylesheet){
this.setSelected('stylesheet',part)
}else if(part instanceof web.data.components.Component){
this.setSelected('component',part)
}else if(part instanceof web.data.styles.Style){
this.setSelected('style',part)
}
},
onDeselect:function(part){
if(!part){
one.fatal('Deselect event fired with undefined part.')
}else if(part instanceof web.data.components.Page){
this.setSelected('page',null);
this.setSelected('template',null);
this.setSelected('stylesheet',null);
this.setSelected('component',null)
}else if(part instanceof web.data.components.Template){
this.setSelected('template',null);
this.setSelected('stylesheet',null);
this.setSelected('component',null)
}else if(part instanceof web.data.styles.Stylesheet){
this.setSelected('stylesheet',null)
}else if(part instanceof web.data.components.Component){
this.setSelected('component',null)
}else if(part instanceof web.data.styles.Style){
this.setSelected('style',null)
}
},
getSelected:function(type){
return this.selections[type]
},
setSelected:function(type,part){
var selections=this.selections,oldIsPage,newIsPage;
selections[type]=part;
if(type==='component'){
if(selections[type]&&part){
oldIsPage=this.isPageMode(selections[type]);
newIsPage=this.isPageMode(part);
if(oldIsPage!==newIsPage){
this.fireEvent('mode',newIsPage?'page':'template')
}
}
}else{
if(type==='page'){
this.dal.uiState.set('lastPageId',part.id)
}
}
},
onMode:function(mode){
var selections=this.selections,component=selections.component,oldIsPage=this.isPageMode(component),newIsPage=mode==='page',next=oldIsPage!==newIsPage?newIsPage?selections.page:selections.template:null,borderToCode=this.user.isBorderToCode()!==false?true:false;
if(mode==='template'&&next&&next.borderToCode&&borderToCode){
Ext.Msg.show({
cls:'warningMsgCntnr',
title:'Website Builder no longer supports border for page',
msg:'<p>We have detected that one or more pages on your site has a border around the entire page.</p><br><p>Unfortunately Website Builder no longer supports this.</p><br><p>We have converted your border to a Code component. This means that your website will keep the border, but in order to change it you need to change the code in the Code component at the top. If you wish to remove the border, you should delete the Code component.</p><br><p>We are very sorry for the inconvenience.</p>',
width:580,
closable:false,
buttons:{ok:'OK'}
});
this.user.set({borderToCode:false});
this.dal.set(this.user)
}
if(next){
this.mode=mode;
this.fireEvent('select',next)
}
},
applyPreferences:function(){
var preferences=this.preferences,page,template,stylesheet;
this.user=this.dm.create(preferences.user);
this.site=this.dm.create(preferences.site);
this.setSelected('user',this.user);
this.setSelected('site',this.site);
try{
this.version=Ext.DomQuery.selectNode('meta[http-equiv=Content-Version]').getAttribute('content')
}catch(e){
}
this.isFirstVisit=this.user.isFirstVisit();
this.isUpgrade=this.user.isUpgrade(this.version);
if(this.isFirstVisit||this.isUpgrade){
this.startTips.displayOnStart()
}
if((this.isUpgrade||!this.user.version)&&this.version){
this.user.set({version:this.version});
this.dal.set(this.user)
}
if(preferences.page){
stylesheet=this.dm.create(preferences.stylesheet);
template=this.dm.create(preferences.template);
page=this.dm.create(preferences.page);
this.setSelected('page',page);
this.setSelected('template',template);
this.setSelected('component',page);
this.setSelected('stylesheet',stylesheet);
this.googleWebFonts.initFonts(this.googleWebFonts.FONTS_LOADING_MODE.APP);
this.waitForAdjust=true
}else{
this.on('afterlayout',function(){
this.fireEvent('launch')
},this,{single:true})
}
},
getSite:function(){
return this.site
},
showRestoreSuccessMessage:function(){
if(this.dal.uiState.get('restoreStatus')==='success'){
this.dal.uiState.delete('restoreStatus');
var $=oneJQuery;
var $restoreSuccessMessage=$('<div class="restore-success-message-parent">'+'<div class="restore-success-message">'+'<div class="restore-success-message-icon"></div>'+'<div class="restore-success-message-title">'+'Success!'+'</div>'+'<div class="restore-success-message-text">'+'Your website has been restored.'+'</div>'+'</div>'+'</div>');
$('body').append($restoreSuccessMessage);
$restoreSuccessMessage.hide().fadeIn(400,function(){
setTimeout(function(){
$restoreSuccessMessage.fadeOut(400,function(){
$restoreSuccessMessage.remove()
})
},2500)
})
}
},
firstAction:function(){
var page=this.getSelected('page'),firstLinkPage,links,numLinks,i,showNewFeatureMsg=function(){
var adjustSize=function(h,welcomeMsg){
if(h>600){
welcomeMsg.item.el.setHeight('auto');
welcomeMsg.el.center()
}else{
welcomeMsg.el.setTop(0);
welcomeMsg.item.el.setHeight(h-60)
}
};
var welcomeMsg,newFeatureVersion='v18';
if(newFeatureVersion!==this.user.visitedVersion&&!this.isFirstVisit){
welcomeMsg=this.windows.create({type:'web.windows.NewFeatureMsg'});
welcomeMsg.show();
welcomeMsg.el.center();
welcomeMsg.on('hide',function(){
if(welcomeMsg.hideNewFeature.checked){
this.user.visitedVersion=newFeatureVersion;
this.dal.set(this.user)
}
},this);
Ext.EventManager.onWindowResize(function(w,h){
if(welcomeMsg.el.dom){
adjustSize(h,welcomeMsg)
}
})
}
};
if(page){
this.fireEvent('select',this.site.getFolder().findLinkPage(page.getId()));
showNewFeatureMsg.call(this)
}else{
links=this.site.getFolder().getItems();
numLinks=links.length;
i=0;
while(!firstLinkPage&&i<numLinks){
if(links[i].type==='web.data.links.LinkPage'){
firstLinkPage=links[i]
}
i+=1
}
if(!firstLinkPage){
this.createFirstPage(showNewFeatureMsg)
}else{
this.dal.getWithDependents(firstLinkPage.getPageId(),'web.data.components.Page',function(opts,success,response){
var dm=this.dm,data,page;
if(success){
data=Ext.decode(response.responseText);
page=dm.create(data.page);
this.setSelected('page',page);
this.setSelected('template',dm.create(data.template));
this.setSelected('component',page);
this.setSelected('stylesheet',dm.create(data.stylesheet));
this.fireEvent('select',page)
}
},this)
}
}
},
createFirstPage:function(callback){
var updateUserFn=function(part){
if(part instanceof web.data.components.Page){
this.user.set({firstVisit:false});
this.dal.set(this.user,callback,this)
}
};
this.request({
type:'newpageandtemplate',
nocancel:true,
nomodified:this.isFirstVisit||!this.site.folder.getPageCount(),
parent:this.getSite().getFolder()
});
this.on('select',updateUserFn,this,{single:true})
},
applyHistoryToken:function(token){
},
clearUndoRedo:function(){
this.invoker.purgeListeners();
this.invoker=new web.commands.Invoker(this)
},
isPageMode:function(component){
return!component||component.inPage()
},
getMode:function(){
return this.mode
},
getModeDoc:function(){
return this.selections[this.mode]
},
inPageMode:function(){
return this.getMode()==='page'
},
inTemplateMode:function(){
return!this.inPageMode()
},
makePremiumTopBar:function(){
var that=this;
oneJQuery('body').append('<div class="premium-top-bar upgrade-option"><div class=content><div class=upgrade-txt>You created <span data-model=application_pages></span> pages. Your current Website Builder can only publish up to 5 pages.</div><div class="web-button x-btn-premium outline small x-btn-noicon upgrade-btn"><div class="x-btn-small x-btn-icon-small-left"><em><a unselectable=on class=x-btn-text><span class=no-free-upgrade-offer>Upgrade</span> <span class=free-upgrade-offer>Free Upgrade</span></a></em></div></div><div class=close-btn><a unselectable=on href=#><img src=//webeditor-static.cdn-one.com/blank_1x1.fc94fb0c3e.gif class="icon icon-close" style=position:relative;width:12px;height:12px></a></div></div></div>');
oneJQuery('.premium-top-bar .upgrade-btn').on('click',function(){
web.upgradeToPremiumViaPopup.call(that,{
app:that,
source:'Workspace:TopBlueBarBtn'
})
});
oneJQuery('.premium-top-bar .close-btn').on('click',function(){
oneJQuery('.premium-top-bar').animate({top:-oneJQuery('.premium-top-bar').height()})
});
var previousPageCount=0;
var updateUI=function(){
var pages=this.site.folder.getAllPages();
if(pages.length<=5){
oneJQuery('.premium-top-bar').delay(1000).animate({top:-oneJQuery('.premium-top-bar').height()})
}else{
if(pages.length>previousPageCount){
oneJQuery('.premium-top-bar').delay(1000).animate({top:0})
}
}
previousPageCount=pages.length;
oneJQuery('.premium-top-bar [data-model=application_pages]').html(pages.length)
};
this.on('update',function(part,action){
if(part.type==='web.data.links.LinkPage'){
updateUI.call(this)
}
},this);
setTimeout(function(){
updateUI.call(that)
},2000)
},
makeShadows:function(){
var body=Ext.getBody();
body.createChild('<div id="newui-topshadow" class="newui-shadows"></div>');
body.createChild('<div id="newui-verticalshadow" class="newui-shadows"></div>')
},
showHideShadow:function(whichShadow,showOrHide){
var id;
if(whichShadow==='horizontal'){
id='newui-topshadow'
}else{
id='newui-verticalshadow'
}
if(showOrHide==='show'){
Ext.get(id).show()
}else{
Ext.get(id).hide()
}
},
enableDisableTooltips:function(doWhat){
var startTips=this.startTips,helpButton=startTips.getHelpButton();
if(doWhat==='disable'){
startTips.dismissAll();
helpButton.disable()
}else{
helpButton.enable()
}
},
getWorkspaceUsableHeight:function(){
return Ext.getBody().getHeight()-this.heightBeforeWorkspace
},
verboseRegEx:/^(de|da|fr|nl|it|es)$/,
isVerbose:function(){
return one&&one.locale&&one.locale.id&&this.verboseRegEx.test(one.locale.id)
},
collapseCustomPanel:function(customPanelBody,customPanel){
if(customPanelBody.style.height){
customPanelBody.style.height=''
}
var customPanelBodyClassList=customPanelBody.className.trim().split(' ');
if(customPanel.settingsGearBtn){
customPanel.settingsGearBtn.suspendEvents();
customPanel.settingsGearBtn.toggle();
customPanel.settingsGearBtn.resumeEvents()
}else if(customPanel.getEl().findParent('.listTextPanelContainer-isExpanded',7)){
Ext.get(customPanel.getEl().select('.custom-color-panel-gear-btn.x-btn-pressed').elements[0].id).removeClass('x-btn-pressed');
Ext.get(customPanel.getEl().findParent('.listTextPanelContainer',7).id).removeClass('listTextPanelContainer-isExpanded')
}
for(var j=customPanelBodyClassList.length-1;j>0;j=j-1){
Ext.get(customPanelBody.id).removeClass(customPanelBodyClassList[j])
}
var gearBtn=Ext.get(customPanelBody).prev().prev().child('.custom-color-panel-gear-btn'),patchHolder=Ext.get(customPanelBody).prev('.custom-panel-patch-holder');
if(customPanel.panelBodyPatch){
setTimeout(function(){
customPanel.panelBodyPatch.getEl().toggleClass('custom-panel-patch-holder-visible')
},200)
}else if(gearBtn&&patchHolder){
gearBtn.toggleClass('x-btn-pressed');
patchHolder.toggleClass('custom-panel-patch-holder-visible')
}
},
track:function(arr){
if(arr&&typeof arr==='object'&&arr.length>=0){
if(arr.length>0){
ga.apply(window,[
'send',
'event'
].concat(arr))
}
}else{
one.fatal('app.trackEvent: Parameter must be an array.',arr)
}
},
trackEvent:function(event){
if(!event||typeof event!=='object'){
one.fatal('app.trackEvent: event must be an object.',event);
return
}else if(!event.eventCategory){
one.fatal('app.trackEvent: event.eventCategory must be set.',event);
return
}else if(event.eventValue&&isNaN(event.eventValue)){
one.fatal('app.trackEvent: event.eventValue must be a number.',event);
return
}
ga('send','event',event)
},
trackPageview:function(pageName){
if(!pageName||typeof pageName!=='string'){
one.fatal('app.trackPageview: pageName must be a string.',pageName);
return
}
ga('send','pageview',pageName)
},
googleAnalyticsCustom:function(dimension,value){
if(!dimension||typeof dimension!=='string'){
one.fatal('app.googleAnalyticsCustom: dimension must be a string.',dimension);
return
}
if(!/^dimension[0-9]+$/.test(dimension)){
one.fatal('app.googleAnalyticsCustom: dimension must follow this format: dimension[0-9]+.',dimension);
return
}
ga('set',dimension,value)
},
updatePremiumUI:function(){
var isNormal=this.user.subscriptionStatus!==web.UserSubscriptionStatus.PREMIUM;
if(isNormal){
oneJQuery('body').removeClass('hide-upgrade-options')
}else{
oneJQuery('body').addClass('hide-upgrade-options')
}
if(this.user.freeUpgradeAvailable){
oneJQuery('body').addClass('free-upgrade-offer')
}else{
oneJQuery('body').removeClass('free-upgrade-offer')
}
},
userHasFullBackupRestoreAccess:function(){
if(this.user.subscriptionStatus===web.UserSubscriptionStatus.PREMIUM||this.user.subscriptionStatusBackupRestore===web.UserSubscriptionStatusBackupRestore.SUBSCRIBED){
return true
}
try{
return localStorage['backups-feature']==='enabled'
}catch(e){
}
return false
},
userBackupRestoreAccessStatusUnknown:function(){
if(this.user.subscriptionStatus===web.UserSubscriptionStatus.UNKNOWN||this.user.subscriptionStatusBackupRestore===web.UserSubscriptionStatusBackupRestore.UNKNOWN){
return true
}
return false
},
updateBackupRestoreUI:function(){
if(this.userHasFullBackupRestoreAccess()){
oneJQuery('body').addClass('allow-backup-restore')
}
}
});
web.windows.UnsupportedBrowser=function(callback){
var isTouchDevice='ontouchstart'in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0;
web.windows.UnsupportedBrowser.anyway=function(){
var days=14*24*3600*1000,d=new Date(new Date().getTime()+days);
Ext.util.Cookies.set('unsupported-browser-skipped','true',d);
if(window.localStorage){
if(web.windows.UnsupportedBrowser.win.hideInfo.checked===true&&'ontouchstart'in document.documentElement){
window.localStorage.setItem('NoTouchSupportInfo','true')
}else{
window.localStorage.setItem('NoBrowserSupportInfo','true')
}
}
web.windows.UnsupportedBrowser.win.hide();
callback()
};
if(Ext.isIE&&navigator.appVersion&&navigator.appVersion.indexOf('Windows NT 6')===-1){
web.windows.UnsupportedBrowser.win=new web.windows.Window({
width:680,
height:470,
cls:'web-windows-unsupportedbrowser web-modal-warning x-window-dlg',
closable:false,
resizable:false,
title:'',
items:[{html:'<h1>'+'Sorry, it looks like you are using a browser that is not supported by One.com Website Builder'+'</h1><BR><BR>'+'It looks like you\'re using an old version of Internet Explorer that can\'t be upgraded to the latest version. For the best experience on the web and to use the One.com Website Builder, we suggest you try Google Chrome or Mozilla Firefox.'+'<div class=\'unsupported\'>'+'<table><tbody>'+'<tr>'+'<td class=\'browser\'><a href=\'http://www.google.com/chrome\'><span class=\'browser-icon chrome\'></span></a><a href=\'http://www.google.com/chrome\'>Google Chrome</a></td>'+'<td class=\'browser\'><a href=\'http://www.firefox.com/\'><span class=\'browser-icon firefox\'></span></a><a href=\'http://www.firefox.com/\'>Firefox</a></td>'+'</tr>'+'</tbody></table>'+'</div>'+'<span class=recommended-browsers>One.com recommends using the latest version of <a href=http://www.google.com/chrome>Google Chrome</a>, <a href=http://www.firefox.com>Firefox</a>, <a href=http://www.apple.com/safari/ >Safari</a>, <a href=http://www.opera.com/ >Opera</a> or <a href=http://www.microsoft.com/windows/Internet-explorer/ >Internet Explorer</a>.</span>'}]
});
web.windows.UnsupportedBrowser.win.show()
}else{
if(window.localStorage&&(isTouchDevice&&window.localStorage.getItem('NoTouchSupportInfo')==='true'||!isTouchDevice&&window.localStorage.getItem('NoBrowserSupportInfo')==='true')){
callback();
return
}
var htmlForUnsupportedBrowser='<span class=\'web-warning-icon\' style=\'width: 20px;display: inline-block;vertical-align: sub;\'></span><span style=\'font-size: 16px;\'>'+'Unsupported browser'+'</span><BR><BR>'+'Your browser is not supported or may be out of date. For the best experience using One.com\'s Website Builder, please upgrade your browser.';
var htmlForTouchDevice='<span class=\'web-warning-icon\' style=\'width: 20px;display: inline-block;vertical-align: sub;\'></span><span style=\'font-size: 16px;\'>'+'Unsupported touch screen'+'</span><BR><BR>'+'Website Builder does not support the touch screen on your device, but you are welcome to continue anyway.';
web.windows.UnsupportedBrowser.win=new web.windows.Window({
width:480,
height:320,
cls:'web-windows-unsupportedbrowser web-modal-warning x-window-dlg',
closable:false,
resizable:false,
title:'',
items:[
{html:isTouchDevice?htmlForTouchDevice:htmlForUnsupportedBrowser},
{
xtype:'container',
cls:'hbox cross-center web-window-footer '+(!isTouchDevice?'ie-window-footer-css':''),
items:[
{
ref:'../hideInfo',
xtype:'checkbox',
boxLabel:'<span style="white-space:nowrap">Don\'t show this again</span>'
},
{
xtype:'spacer',
cls:'flex'
},
{
xtype:'container',
cls:'button-wrap',
items:[{
xtype:'button',
cls:'x-btn-primary large wide '+(!isTouchDevice?'btn-continue':''),
text:'Continue',
listeners:{
click:function(){
web.windows.UnsupportedBrowser.anyway()
}
}
}]
},
{
xtype:'container',
cls:'button-wrap',
hidden:isTouchDevice,
items:[{
xtype:'button',
text:'Upgrade',
cls:'x-btn-primary large wide btn-upgrade',
handler:function(){
var href='';
if(Ext.isIE){
href='http://www.microsoft.com/windows/Internet-explorer/'
}
if(Ext.isChrome){
href='http://www.google.com/chrome'
}
if(Ext.isGecko){
href='http://www.firefox.com/'
}
if(Ext.isOpera){
href='http://www.opera.com/'
}
if(Ext.isSafari){
href='http://www.apple.com/safari/'
}
document.location.href=href
}
}]
}
]
}
]
});
web.windows.UnsupportedBrowser.win.show()
}
};
web.windows.UnsupportedBrowser.unsupported=function(){
var ua=window.navigator.userAgent.toLowerCase(),ie=ua.match(/msie (\d+)/)||ua.match(/trident.+rv.(\d+)/),firefox=!/webkit/.test(ua)&&ua.match(/firefox\/(\d+)/),chrome=ua.match(/chrome\/(\d+)/),safari=/safari/.test(ua)&&ua.match(/version\/(\d+)/),opera=ua.match(/opera.+?(\d+\.\d+)$/),mobile=/mobile/.test(ua),supported=(ie&&ie[1]>=10||firefox&&firefox[1]>=10||chrome&&chrome[1]>=16||safari&&safari[1]>=5||opera&&opera[1]>=10)&&!mobile,isTouchDevice='ontouchstart'in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0;
return!supported||isTouchDevice
}();
web.windows.UnsupportedBrowser.unsupportedWarningSupressed=function(){
return Ext.util.Cookies.get('unsupported-browser-skipped')==='true'
}();
web.windows.UnsupportedDimension=function(callback){
Ext.Msg.show({
cls:'web-windows-unsupporteddimension web-modal-warning',
iconCls:'web-warning-icon',
width:480,
buttons:{ok:'Continue'},
fn:function(buttonId){
if(buttonId==='cancel'){
window.location='https://www.one.com/admin/frontpage.do'
}else{
callback()
}
},
title:'Browser window too small',
msg:'Your browser window is too small for all of Website Builder\'s features.'+'<br><br>'+'Make sure that the zoom level on your browser is set to 100%, make the browser window bigger and consider removing any toolbars in the browser.'+'<br>'
})
};
web.windows.UnsupportedDimension.unsupported=function(){
var width=window.innerWidth||document.documentElement.clientWidth,height=window.innerHeight||document.documentElement.clientHeight,supported;
supported=width>=1000&&height>=580;
return!supported
}();
if(window.BUILDDEVELOPMENT){
var loadingDiv=document.createElement('div');
loadingDiv.id='one-viewport-loading';
loadingDiv.innerHTML='<div><div class="animated-loading-dots"><div></div></div>'+'<div id="loadingcntnr"></div>'+'<div class="one-viewport-progress-info"></div></div>';
document.body.insertBefore(loadingDiv,document.body.firstChild)
}
one.Viewport=Ext.extend(Ext.Viewport,{
layout:'fit',
hideBorders:true,
constructor:function(config){
one.viewport=this;
this.loadingScreen=Ext.get('one-viewport-loading')||new Ext.CompositeElement;
var loadingEl=Ext.get('loadingcntnr').dom;
loadingEl.innerHTML='Loading...';
this.addEvents('localeready');
this.waitForLoading=config.waitForLoading;
one.Viewport.superclass.constructor.call(this,config);
if(!Ext.isIE){
this.applicationNameMeta=Ext.fly(document.getElementsByTagName('head')[0]).createChild({
tag:'meta',
name:'application-name'
})
}
if(Ext.QuickTips){
Ext.QuickTips.init()
}
Ext.getBody().createChild({
tag:'form',
action:'#',
cls:'x-hidden',
id:'history-form',
cn:{
cn:[
{
tag:'input',
id:Ext.History.fieldId,
type:'hidden'
},
{
tag:'iframe',
id:Ext.History.iframeId
}
]
}
});
if(Ext.isGecko){
window.addEventListener('keydown',function(e){
if(e.keyCode===27){
e.preventDefault()
}
},false)
}
Ext.History.init();
this.historyToken=Ext.History.getToken();
Ext.History.on({
scope:this,
change:function(newToken){
if(newToken!==this.historyToken){
this.items.each(function(item){
item.applyHistoryToken(newToken)
},this);
this.historyToken=newToken
}
}
});
if(window.applicationCache&&applicationCache.status>applicationCache.UNCACHED){
this.updateApplicationCache(function(updateReady){
if(updateReady){
document.location.reload()
}else{
this.loadLocaleAndLaunchApplication()
}
},this)
}else{
this.loadLocaleAndLaunchApplication()
}
},
loadLocaleAndLaunchApplication:function(){
if(this.localeId){
this.on({
scope:this,
single:true,
localeready:this.launchApplication
});
this.setLocale(this.localeId)
}else{
this.launchApplication()
}
function handleKey(ev,el){
if(this.application){
this.application.handleKeyEvent(ev,el)
}
}
Ext.getDoc().on({
scope:this,
keydown:handleKey,
keypress:handleKey
})
},
updateApplicationCache:function(cb,scope){
function reportToCb(updateReady){
setTimeout(function(){
cb.call(scope||window,updateReady)
},0)
}
if(window.applicationCache&&applicationCache.status>applicationCache.UNCACHED){
if(applicationCache.status===applicationCache.UDPATEREADY){
applicationCache.swapCache();
reportToCb(true)
}else{
var eventNames=[
'updateready',
'noupdate',
'error',
'obsolete'
],eventHandler=function(e){
eventNames.forEach(function(eventName){
applicationCache.removeEventListener(eventName,eventHandler)
});
if(e.type==='updateready'){
applicationCache.swapCache();
reportToCb(true)
}else{
reportToCb(false)
}
};
eventNames.forEach(function(eventName){
applicationCache.addEventListener(eventName,eventHandler,false)
});
if(applicationCache.status!==applicationCache.CHECKING&&applicationCache.status!==applicationCache.status.DOWNLOADING){
applicationCache.update()
}
}
}else{
reportToCb(false)
}
},
launchApplication:function(){
if(this.application){
this.application.destroy()
}
this.applicationConstructor.prototype.prepareForLaunch(this.application,function(applicationConfig){
this.add(this.application=new this.applicationConstructor(Ext.apply({
historyToken:Ext.History.getToken(),
listeners:{
scope:this,
relaunch:function(){
this.launchApplication.defer(1,this)
},
titlechange:function(viewport,newTitle){
document.title=newTitle;
if(this.applicationNameMeta){
this.applicationNameMeta.set({value:newTitle})
}
},
launch:function(){
this.hideLoading()
}
}
},applicationConfig||{})));
if(!this.waitForLoading){
this.hideLoading()
}
this.doLayout()
},this)
},
setLocale:function(localeId){
if(one.locale&&one.locale.id===localeId){
this.fireEvent('localeready')
}else{
if(localeId in one){
one.locale=one.localelib[localeId];
one.locale.init();
this.fireEvent('localeready')
}else{
Ext.Ajax.request({
method:'GET',
url:this.getLocaleFileUrl(localeId+'.js'),
scope:this,
success:function(xhr){
eval(xhr.responseText);
one.locale=one.localelib[localeId];
one.locale.init();
one.locale.getNormalizedId=function(){
var locale=this.id,i=locale.indexOf('_');
if(-1!=i){
locale=locale.substring(0,i)
}
return locale
};
this.fireEvent('localeready')
},
failure:function(){
if(localeId!=='en_US'){
this.setLocale('en_US')
}
}
})
}
}
},
hideLoading:function(){
this.loadingScreen.hide()
},
showLoading:function(){
this.loadingScreen.show()
},
onAdd:function(item){
one.Viewport.superclass.onAdd.apply(this,arguments);
item.addClass('one-viewport-component');
this.mon(item,'historytokenchanged',this.onItemHistoryTokenChanged,this)
},
onRemove:function(item){
item.removeClass('one-viewport-component');
this.mun(item,'historytokenchanged',this.onItemHistoryTokenChanged,this)
},
onItemHistoryTokenChanged:function(item,token){
this.historyToken=token;
Ext.History.add(token,true)
}
});
Ext.reg('one-viewport',one.Viewport);
Ext.override(Ext.Component,{
mon:function(item,ename,fn,scope,opt){
if(!item){
one.fatal('Ext.Component.mon called without item.');
return
}
this.createMons();
if(Ext.isObject(ename)){
var propRe=/^(?:scope|delay|buffer|single|stopEvent|preventDefault|stopPropagation|normalized|args|delegate)$/;
var o=ename;
for(var e in o){
if(propRe.test(e)){
continue
}
if(Ext.isFunction(o[e])){
this.mons.push({
item:item,
ename:e,
fn:o[e],
scope:o.scope
});
item.on(e,o[e],o.scope,o)
}else{
this.mons.push({
item:item,
ename:e,
fn:o[e],
scope:o.scope
});
item.on(e,o[e])
}
}
return
}
this.mons.push({
item:item,
ename:ename,
fn:fn,
scope:scope
});
item.on(ename,fn,scope,opt)
}
});
(function(){
var body=document.body;
if(body){
body.blur=function(){
}
}
}());
(function(){
try{
if(!window.location.origin){
window.location.origin=window.location.protocol+'//'+window.location.hostname+(window.location.port?':'+window.location.port:'')
}
}catch(e){
}
}());
if(typeof Object.create!=='function'){
Object.create=function(obj){
function F(){
}
F.prototype=obj;
return new F
}
}
(function($,window,document){
var Carousel={
init:function(options,el){
var base=this;
base.$elem=$(el);
base.options=$.extend({},$.fn.owlCarousel.options,base.$elem.data(),options);
base.userOptions=options;
base.loadContent()
},
loadContent:function(){
var base=this,url;
function getData(data){
var i,content='';
if(typeof base.options.jsonSuccess==='function'){
base.options.jsonSuccess.apply(this,[data])
}else{
for(i in data.owl){
if(data.owl.hasOwnProperty(i)){
content+=data.owl[i].item
}
}
base.$elem.html(content)
}
base.logIn()
}
if(typeof base.options.beforeInit==='function'){
base.options.beforeInit.apply(this,[base.$elem])
}
if(typeof base.options.jsonPath==='string'){
url=base.options.jsonPath;
$.getJSON(url,getData)
}else{
base.logIn()
}
},
logIn:function(){
var base=this;
base.$elem.data('owl-originalStyles',base.$elem.attr('style'));
base.$elem.data('owl-originalClasses',base.$elem.attr('class'));
base.$elem.css({opacity:0});
base.orignalItems=base.options.items;
base.checkBrowser();
base.wrapperWidth=0;
base.checkVisible=null;
base.setVars()
},
setVars:function(){
var base=this;
if(base.$elem.children().length===0){
return false
}
base.baseClass();
base.eventTypes();
base.$userItems=base.$elem.children();
base.itemsAmount=base.$userItems.length;
base.wrapItems();
base.$owlItems=base.$elem.find('.owl-item');
base.$owlWrapper=base.$elem.find('.owl-wrapper');
base.playDirection='next';
base.prevItem=0;
base.prevArr=[0];
base.currentItem=0;
base.customEvents();
base.onStartup()
},
onStartup:function(){
var base=this;
base.updateItems();
base.calculateAll();
base.buildControls();
base.updateControls();
base.response();
base.moveEvents();
base.stopOnHover();
base.owlStatus();
if(base.options.transitionStyle!==false){
base.transitionTypes(base.options.transitionStyle)
}
if(base.options.autoPlay===true){
base.options.autoPlay=5000
}
base.play();
base.$elem.find('.owl-wrapper').css('display','block');
if(!base.$elem.is(':visible')){
base.watchVisibility()
}else{
base.$elem.css('opacity',1)
}
base.onstartup=false;
base.eachMoveUpdate();
if(typeof base.options.afterInit==='function'){
base.options.afterInit.apply(this,[base.$elem])
}
},
eachMoveUpdate:function(){
var base=this;
if(base.options.lazyLoad===true){
base.lazyLoad()
}
if(base.options.autoHeight===true){
base.autoHeight()
}
base.onVisibleItems();
if(typeof base.options.afterAction==='function'){
base.options.afterAction.apply(this,[base.$elem])
}
},
updateVars:function(){
var base=this;
if(typeof base.options.beforeUpdate==='function'){
base.options.beforeUpdate.apply(this,[base.$elem])
}
base.watchVisibility();
base.updateItems();
base.calculateAll();
base.updatePosition();
base.updateControls();
base.eachMoveUpdate();
if(typeof base.options.afterUpdate==='function'){
base.options.afterUpdate.apply(this,[base.$elem])
}
},
reload:function(){
var base=this;
window.setTimeout(function(){
base.updateVars()
},0)
},
watchVisibility:function(){
var base=this;
if(base.$elem.is(':visible')===false){
base.$elem.css({opacity:0});
window.clearInterval(base.autoPlayInterval);
window.clearInterval(base.checkVisible)
}else{
return false
}
base.checkVisible=window.setInterval(function(){
if(base.$elem.is(':visible')){
base.reload();
base.$elem.animate({opacity:1},200);
window.clearInterval(base.checkVisible)
}
},500)
},
wrapItems:function(){
var base=this;
base.$userItems.wrapAll('<div class="owl-wrapper">').wrap('<div class="owl-item"></div>');
base.$elem.find('.owl-wrapper').wrap('<div class="owl-wrapper-outer">');
base.wrapperOuter=base.$elem.find('.owl-wrapper-outer');
base.$elem.css('display','block')
},
baseClass:function(){
var base=this,hasBaseClass=base.$elem.hasClass(base.options.baseClass),hasThemeClass=base.$elem.hasClass(base.options.theme);
if(!hasBaseClass){
base.$elem.addClass(base.options.baseClass)
}
if(!hasThemeClass){
base.$elem.addClass(base.options.theme)
}
},
updateItems:function(){
var base=this,width,i;
if(base.options.responsive===false){
return false
}
if(base.options.singleItem===true){
base.options.items=base.orignalItems=1;
base.options.itemsCustom=false;
base.options.itemsDesktop=false;
base.options.itemsDesktopSmall=false;
base.options.itemsTablet=false;
base.options.itemsTabletSmall=false;
base.options.itemsMobile=false;
return false
}
width=$(base.options.responsiveBaseWidth).width();
if(width>(base.options.itemsDesktop[0]||base.orignalItems)){
base.options.items=base.orignalItems
}
if(base.options.itemsCustom!==false){
base.options.itemsCustom.sort(function(a,b){
return a[0]-b[0]
});
for(i=0;i<base.options.itemsCustom.length;i+=1){
if(base.options.itemsCustom[i][0]<=width){
base.options.items=base.options.itemsCustom[i][1]
}
}
}else{
if(width<=base.options.itemsDesktop[0]&&base.options.itemsDesktop!==false){
base.options.items=base.options.itemsDesktop[1]
}
if(width<=base.options.itemsDesktopSmall[0]&&base.options.itemsDesktopSmall!==false){
base.options.items=base.options.itemsDesktopSmall[1]
}
if(width<=base.options.itemsTablet[0]&&base.options.itemsTablet!==false){
base.options.items=base.options.itemsTablet[1]
}
if(width<=base.options.itemsTabletSmall[0]&&base.options.itemsTabletSmall!==false){
base.options.items=base.options.itemsTabletSmall[1]
}
if(width<=base.options.itemsMobile[0]&&base.options.itemsMobile!==false){
base.options.items=base.options.itemsMobile[1]
}
}
if(base.options.items>base.itemsAmount&&base.options.itemsScaleUp===true){
base.options.items=base.itemsAmount
}
},
response:function(){
var base=this,smallDelay,lastWindowWidth;
if(base.options.responsive!==true){
return false
}
lastWindowWidth=$(window).width();
base.resizer=function(){
if($(window).width()!==lastWindowWidth){
if(base.options.autoPlay!==false){
window.clearInterval(base.autoPlayInterval)
}
window.clearTimeout(smallDelay);
smallDelay=window.setTimeout(function(){
lastWindowWidth=$(window).width();
base.updateVars()
},base.options.responsiveRefreshRate)
}
};
$(window).resize(base.resizer)
},
updatePosition:function(){
var base=this;
base.jumpTo(base.currentItem);
if(base.options.autoPlay!==false){
base.checkAp()
}
},
appendItemsSizes:function(){
var base=this,roundPages=0,lastItem=base.itemsAmount-base.options.items;
base.$owlItems.each(function(index){
var $this=$(this);
$this.css({'width':base.itemWidth}).data('owl-item',Number(index));
if(index%base.options.items===0||index===lastItem){
if(!(index>lastItem)){
roundPages+=1
}
}
$this.data('owl-roundPages',roundPages)
})
},
appendWrapperSizes:function(){
var base=this,width=base.$owlItems.length*base.itemWidth;
base.$owlWrapper.css({
'width':width*2,
'left':0
});
base.appendItemsSizes()
},
calculateAll:function(){
var base=this;
base.calculateWidth();
base.appendWrapperSizes();
base.loops();
base.max()
},
calculateWidth:function(){
var base=this;
base.itemWidth=Math.round(base.$elem.width()/base.options.items)
},
max:function(){
var base=this,maximum=(base.itemsAmount*base.itemWidth-base.options.items*base.itemWidth)*-1;
if(base.options.items>base.itemsAmount){
base.maximumItem=0;
maximum=0;
base.maximumPixels=0
}else{
base.maximumItem=base.itemsAmount-base.options.items;
base.maximumPixels=maximum
}
return maximum
},
min:function(){
return 0
},
loops:function(){
var base=this,prev=0,elWidth=0,i,item,roundPageNum;
base.positionsInArray=[0];
base.pagesInArray=[];
for(i=0;i<base.itemsAmount;i+=1){
elWidth+=base.itemWidth;
base.positionsInArray.push(-elWidth);
if(base.options.scrollPerPage===true){
item=$(base.$owlItems[i]);
roundPageNum=item.data('owl-roundPages');
if(roundPageNum!==prev){
base.pagesInArray[prev]=base.positionsInArray[i];
prev=roundPageNum
}
}
}
},
buildControls:function(){
var base=this;
if(base.options.navigation===true||base.options.pagination===true){
base.owlControls=$('<div class="owl-controls"/>').toggleClass('clickable',!base.browser.isTouch).appendTo(base.$elem)
}
if(base.options.pagination===true){
base.buildPagination()
}
if(base.options.navigation===true){
base.buildButtons()
}
},
buildButtons:function(){
var base=this,buttonsWrapper=$('<div class="owl-buttons"/>');
base.owlControls.append(buttonsWrapper);
base.buttonPrev=$('<div/>',{
'class':'owl-prev',
'html':base.options.navigationText[0]||''
});
base.buttonNext=$('<div/>',{
'class':'owl-next',
'html':base.options.navigationText[1]||''
});
buttonsWrapper.append(base.buttonPrev).append(base.buttonNext);
buttonsWrapper.on('touchstart.owlControls mousedown.owlControls','div[class^="owl"]',function(event){
event.preventDefault()
});
buttonsWrapper.on('touchend.owlControls mouseup.owlControls','div[class^="owl"]',function(event){
event.preventDefault();
if($(this).hasClass('owl-next')){
base.next()
}else{
base.prev()
}
})
},
buildPagination:function(){
var base=this;
base.paginationWrapper=$('<div class="owl-pagination"/>');
base.owlControls.append(base.paginationWrapper);
base.paginationWrapper.on('touchend.owlControls mouseup.owlControls','.owl-page',function(event){
event.preventDefault();
if(Number($(this).data('owl-page'))!==base.currentItem){
base.goTo(Number($(this).data('owl-page')),true)
}
})
},
updatePagination:function(){
var base=this,counter,lastPage,lastItem,i,paginationButton,paginationButtonInner;
if(base.options.pagination===false){
return false
}
base.paginationWrapper.html('');
counter=0;
lastPage=base.itemsAmount-base.itemsAmount%base.options.items;
for(i=0;i<base.itemsAmount;i+=1){
if(i%base.options.items===0){
counter+=1;
if(lastPage===i){
lastItem=base.itemsAmount-base.options.items
}
paginationButton=$('<div/>',{'class':'owl-page'});
paginationButtonInner=$('<span></span>',{
'text':base.options.paginationNumbers===true?counter:'',
'class':base.options.paginationNumbers===true?'owl-numbers':''
});
paginationButton.append(paginationButtonInner);
paginationButton.data('owl-page',lastPage===i?lastItem:i);
paginationButton.data('owl-roundPages',counter);
base.paginationWrapper.append(paginationButton)
}
}
base.checkPagination()
},
checkPagination:function(){
var base=this;
if(base.options.pagination===false){
return false
}
base.paginationWrapper.find('.owl-page').each(function(){
if($(this).data('owl-roundPages')===$(base.$owlItems[base.currentItem]).data('owl-roundPages')){
base.paginationWrapper.find('.owl-page').removeClass('active');
$(this).addClass('active')
}
})
},
checkNavigation:function(){
var base=this;
if(base.options.navigation===false){
return false
}
if(base.options.rewindNav===false){
if(base.currentItem===0&&base.maximumItem===0){
base.buttonPrev.addClass('disabled');
base.buttonNext.addClass('disabled')
}else if(base.currentItem===0&&base.maximumItem!==0){
base.buttonPrev.addClass('disabled');
base.buttonNext.removeClass('disabled')
}else if(base.currentItem===base.maximumItem){
base.buttonPrev.removeClass('disabled');
base.buttonNext.addClass('disabled')
}else if(base.currentItem!==0&&base.currentItem!==base.maximumItem){
base.buttonPrev.removeClass('disabled');
base.buttonNext.removeClass('disabled')
}
}
},
updateControls:function(){
var base=this;
base.updatePagination();
base.checkNavigation();
if(base.owlControls){
if(base.options.items>=base.itemsAmount){
base.owlControls.hide()
}else{
base.owlControls.show()
}
}
},
destroyControls:function(){
var base=this;
if(base.owlControls){
base.owlControls.remove()
}
},
next:function(speed){
var base=this;
if(base.isTransition){
return false
}
base.currentItem+=base.options.scrollPerPage===true?base.options.items:1;
if(base.currentItem>base.maximumItem+(base.options.scrollPerPage===true?base.options.items-1:0)){
if(base.options.rewindNav===true){
base.currentItem=0;
speed='rewind'
}else{
base.currentItem=base.maximumItem;
return false
}
}
base.goTo(base.currentItem,speed)
},
prev:function(speed){
var base=this;
if(base.isTransition){
return false
}
if(base.options.scrollPerPage===true&&base.currentItem>0&&base.currentItem<base.options.items){
base.currentItem=0
}else{
base.currentItem-=base.options.scrollPerPage===true?base.options.items:1
}
if(base.currentItem<0){
if(base.options.rewindNav===true){
base.currentItem=base.maximumItem;
speed='rewind'
}else{
base.currentItem=0;
return false
}
}
base.goTo(base.currentItem,speed)
},
goTo:function(position,speed,drag){
var base=this,goToPixel;
if(base.isTransition){
return false
}
if(typeof base.options.beforeMove==='function'){
base.options.beforeMove.apply(this,[base.$elem])
}
if(position>=base.maximumItem){
position=base.maximumItem
}else if(position<=0){
position=0
}
base.currentItem=base.owl.currentItem=position;
if(base.options.transitionStyle!==false&&drag!=='drag'&&base.options.items===1&&base.browser.support3d===true){
base.swapSpeed(0);
if(base.browser.support3d===true){
base.transition3d(base.positionsInArray[position])
}else{
base.css2slide(base.positionsInArray[position],1)
}
base.afterGo();
base.singleItemTransition();
return false
}
goToPixel=base.positionsInArray[position];
if(base.browser.support3d===true){
base.isCss3Finish=false;
if(speed===true){
base.swapSpeed('paginationSpeed');
window.setTimeout(function(){
base.isCss3Finish=true
},base.options.paginationSpeed)
}else if(speed==='rewind'){
base.swapSpeed(base.options.rewindSpeed);
window.setTimeout(function(){
base.isCss3Finish=true
},base.options.rewindSpeed)
}else{
base.swapSpeed('slideSpeed');
window.setTimeout(function(){
base.isCss3Finish=true
},base.options.slideSpeed)
}
base.transition3d(goToPixel)
}else{
if(speed===true){
base.css2slide(goToPixel,base.options.paginationSpeed)
}else if(speed==='rewind'){
base.css2slide(goToPixel,base.options.rewindSpeed)
}else{
base.css2slide(goToPixel,base.options.slideSpeed)
}
}
base.afterGo()
},
jumpTo:function(position){
var base=this;
if(typeof base.options.beforeMove==='function'){
base.options.beforeMove.apply(this,[base.$elem])
}
if(position>=base.maximumItem||position===-1){
position=base.maximumItem
}else if(position<=0){
position=0
}
base.swapSpeed(0);
if(base.browser.support3d===true){
base.transition3d(base.positionsInArray[position])
}else{
base.css2slide(base.positionsInArray[position],1)
}
base.currentItem=base.owl.currentItem=position;
base.afterGo()
},
afterGo:function(){
var base=this;
base.prevArr.push(base.currentItem);
base.prevItem=base.owl.prevItem=base.prevArr[base.prevArr.length-2];
base.prevArr.shift(0);
if(base.prevItem!==base.currentItem){
base.checkPagination();
base.checkNavigation();
base.eachMoveUpdate();
if(base.options.autoPlay!==false){
base.checkAp()
}
}
if(typeof base.options.afterMove==='function'&&base.prevItem!==base.currentItem){
base.options.afterMove.apply(this,[base.$elem])
}
},
stop:function(){
var base=this;
base.apStatus='stop';
window.clearInterval(base.autoPlayInterval)
},
checkAp:function(){
var base=this;
if(base.apStatus!=='stop'){
base.play()
}
},
play:function(){
var base=this;
base.apStatus='play';
if(base.options.autoPlay===false){
return false
}
window.clearInterval(base.autoPlayInterval);
base.autoPlayInterval=window.setInterval(function(){
base.next(true)
},base.options.autoPlay)
},
swapSpeed:function(action){
var base=this;
if(action==='slideSpeed'){
base.$owlWrapper.css(base.addCssSpeed(base.options.slideSpeed))
}else if(action==='paginationSpeed'){
base.$owlWrapper.css(base.addCssSpeed(base.options.paginationSpeed))
}else if(typeof action!=='string'){
base.$owlWrapper.css(base.addCssSpeed(action))
}
},
addCssSpeed:function(speed){
return{
'-webkit-transition':'all '+speed+'ms ease',
'-moz-transition':'all '+speed+'ms ease',
'-o-transition':'all '+speed+'ms ease',
'transition':'all '+speed+'ms ease'
}
},
removeTransition:function(){
return{
'-webkit-transition':'',
'-moz-transition':'',
'-o-transition':'',
'transition':''
}
},
doTranslate:function(pixels){
return{
'-webkit-transform':'translate3d('+pixels+'px, 0px, 0px)',
'-moz-transform':'translate3d('+pixels+'px, 0px, 0px)',
'-o-transform':'translate3d('+pixels+'px, 0px, 0px)',
'-ms-transform':'translate3d('+pixels+'px, 0px, 0px)',
'transform':'translate3d('+pixels+'px, 0px,0px)'
}
},
transition3d:function(value){
var base=this;
base.$owlWrapper.css(base.doTranslate(value))
},
css2move:function(value){
var base=this;
base.$owlWrapper.css({'left':value})
},
css2slide:function(value,speed){
var base=this;
base.isCssFinish=false;
base.$owlWrapper.stop(true,true).animate({'left':value},{
duration:speed||base.options.slideSpeed,
complete:function(){
base.isCssFinish=true
}
})
},
has3d:function(){
var el=document.createElement('p'),has3d,transforms={
'webkitTransform':'-webkit-transform',
'OTransform':'-o-transform',
'msTransform':'-ms-transform',
'MozTransform':'-moz-transform',
'transform':'transform'
};
document.body.insertBefore(el,null);
for(var t in transforms){
if(el.style[t]!==undefined){
el.style[t]='translate3d(1px,1px,1px)';
has3d=window.getComputedStyle(el).getPropertyValue(transforms[t])
}
}
document.body.removeChild(el);
return has3d!==undefined&&has3d.length>0&&has3d!=='none'
},
checkBrowser:function(){
var base=this,translate3D='translate3d(0px, 0px, 0px)',tempElem=document.createElement('div'),regex,asSupport,support3d,isTouch;
tempElem.style.cssText='  -moz-transform:'+translate3D+'; -ms-transform:'+translate3D+'; -o-transform:'+translate3D+'; -webkit-transform:'+translate3D+'; transform:'+translate3D;
regex=/translate3d\(0px, 0px, 0px\)/g;
asSupport=tempElem.style.cssText.match(regex);
support3d=asSupport!==null&&asSupport.length===1;
isTouch='ontouchstart'in window||window.navigator.msMaxTouchPoints;
base.browser={
'support3d':this.has3d(),
'isTouch':isTouch
}
},
moveEvents:function(){
var base=this;
if(base.options.mouseDrag!==false||base.options.touchDrag!==false){
base.gestures();
base.disabledEvents()
}
},
eventTypes:function(){
var base=this,types=[
's',
'e',
'x'
];
base.ev_types={};
if(base.options.mouseDrag===true&&base.options.touchDrag===true){
types=[
'touchstart.owl mousedown.owl',
'touchmove.owl mousemove.owl',
'touchend.owl touchcancel.owl mouseup.owl'
]
}else if(base.options.mouseDrag===false&&base.options.touchDrag===true){
types=[
'touchstart.owl',
'touchmove.owl',
'touchend.owl touchcancel.owl'
]
}else if(base.options.mouseDrag===true&&base.options.touchDrag===false){
types=[
'mousedown.owl',
'mousemove.owl',
'mouseup.owl'
]
}
base.ev_types.start=types[0];
base.ev_types.move=types[1];
base.ev_types.end=types[2]
},
disabledEvents:function(){
var base=this;
base.$elem.on('dragstart.owl',function(event){
event.preventDefault()
});
base.$elem.on('mousedown.disableTextSelect',function(e){
return $(e.target).is('input, textarea, select, option')
})
},
gestures:function(){
var base=this,locals={
offsetX:0,
offsetY:0,
baseElWidth:0,
relativePos:0,
position:null,
minSwipe:null,
maxSwipe:null,
sliding:null,
dargging:null,
targetElement:null
};
base.isCssFinish=true;
function getTouches(event){
if(event.touches!==undefined){
return{
x:event.touches[0].pageX,
y:event.touches[0].pageY
}
}
if(event.touches===undefined){
if(event.pageX!==undefined){
return{
x:event.pageX,
y:event.pageY
}
}
if(event.pageX===undefined){
return{
x:event.clientX,
y:event.clientY
}
}
}
}
function swapEvents(type){
if(type==='on'){
$(document).on(base.ev_types.move,dragMove);
$(document).on(base.ev_types.end,dragEnd)
}else if(type==='off'){
$(document).off(base.ev_types.move);
$(document).off(base.ev_types.end)
}
}
function dragStart(event){
var ev=event.originalEvent||event||window.event,position;
if(ev.which===3){
return false
}
if(base.itemsAmount<=base.options.items){
return
}
if(base.isCssFinish===false&&!base.options.dragBeforeAnimFinish){
return false
}
if(base.isCss3Finish===false&&!base.options.dragBeforeAnimFinish){
return false
}
if(base.options.autoPlay!==false){
window.clearInterval(base.autoPlayInterval)
}
if(base.browser.isTouch!==true&&!base.$owlWrapper.hasClass('grabbing')){
base.$owlWrapper.addClass('grabbing')
}
base.newPosX=0;
base.newRelativeX=0;
$(this).css(base.removeTransition());
position=$(this).position();
locals.relativePos=position.left;
locals.offsetX=getTouches(ev).x-position.left;
locals.offsetY=getTouches(ev).y-position.top;
swapEvents('on');
locals.sliding=false;
locals.targetElement=ev.target||ev.srcElement
}
function dragMove(event){
var ev=event.originalEvent||event||window.event,minSwipe,maxSwipe;
base.newPosX=getTouches(ev).x-locals.offsetX;
base.newPosY=getTouches(ev).y-locals.offsetY;
base.newRelativeX=base.newPosX-locals.relativePos;
if(typeof base.options.startDragging==='function'&&locals.dragging!==true&&base.newRelativeX!==0){
locals.dragging=true;
base.options.startDragging.apply(base,[base.$elem])
}
if((base.newRelativeX>8||base.newRelativeX<-8)&&base.browser.isTouch===true){
if(ev.preventDefault!==undefined){
ev.preventDefault()
}else{
ev.returnValue=false
}
locals.sliding=true
}
if((base.newPosY>10||base.newPosY<-10)&&locals.sliding===false){
$(document).off('touchmove.owl')
}
minSwipe=function(){
return base.newRelativeX/5
};
maxSwipe=function(){
return base.maximumPixels+base.newRelativeX/5
};
base.newPosX=Math.max(Math.min(base.newPosX,minSwipe()),maxSwipe());
if(base.browser.support3d===true){
base.transition3d(base.newPosX)
}else{
base.css2move(base.newPosX)
}
}
function dragEnd(event){
var ev=event.originalEvent||event||window.event,newPosition,handlers,owlStopEvent;
ev.target=ev.target||ev.srcElement;
locals.dragging=false;
if(base.browser.isTouch!==true){
base.$owlWrapper.removeClass('grabbing')
}
if(base.newRelativeX<0){
base.dragDirection=base.owl.dragDirection='left'
}else{
base.dragDirection=base.owl.dragDirection='right'
}
if(base.newRelativeX!==0){
newPosition=base.getNewPosition();
base.goTo(newPosition,false,'drag');
if(locals.targetElement===ev.target&&base.browser.isTouch!==true){
$(ev.target).on('click.disable',function(ev){
ev.stopImmediatePropagation();
ev.stopPropagation();
ev.preventDefault();
$(ev.target).off('click.disable')
});
handlers=$._data(ev.target,'events').click;
owlStopEvent=handlers.pop();
handlers.splice(0,0,owlStopEvent)
}
}
swapEvents('off')
}
base.$elem.on(base.ev_types.start,'.owl-wrapper',dragStart)
},
getNewPosition:function(){
var base=this,newPosition=base.closestItem();
if(newPosition>base.maximumItem){
base.currentItem=base.maximumItem;
newPosition=base.maximumItem
}else if(base.newPosX>=0){
newPosition=0;
base.currentItem=0
}
return newPosition
},
closestItem:function(){
var base=this,array=base.options.scrollPerPage===true?base.pagesInArray:base.positionsInArray,goal=base.newPosX,closest=null;
$.each(array,function(i,v){
if(goal-base.itemWidth/20>array[i+1]&&goal-base.itemWidth/20<v&&base.moveDirection()==='left'){
closest=v;
if(base.options.scrollPerPage===true){
base.currentItem=$.inArray(closest,base.positionsInArray)
}else{
base.currentItem=i
}
}else if(goal+base.itemWidth/20<v&&goal+base.itemWidth/20>(array[i+1]||array[i]-base.itemWidth)&&base.moveDirection()==='right'){
if(base.options.scrollPerPage===true){
closest=array[i+1]||array[array.length-1];
base.currentItem=$.inArray(closest,base.positionsInArray)
}else{
closest=array[i+1];
base.currentItem=i+1
}
}
});
return base.currentItem
},
moveDirection:function(){
var base=this,direction;
if(base.newRelativeX<0){
direction='right';
base.playDirection='next'
}else{
direction='left';
base.playDirection='prev'
}
return direction
},
customEvents:function(){
var base=this;
base.$elem.on('owl.next',function(){
base.next()
});
base.$elem.on('owl.prev',function(){
base.prev()
});
base.$elem.on('owl.play',function(event,speed){
base.options.autoPlay=speed;
base.play();
base.hoverStatus='play'
});
base.$elem.on('owl.stop',function(){
base.stop();
base.hoverStatus='stop'
});
base.$elem.on('owl.goTo',function(event,item){
base.goTo(item)
});
base.$elem.on('owl.jumpTo',function(event,item){
base.jumpTo(item)
})
},
stopOnHover:function(){
var base=this;
if(base.options.stopOnHover===true&&base.browser.isTouch!==true&&base.options.autoPlay!==false){
base.$elem.on('mouseover',function(){
base.stop()
});
base.$elem.on('mouseout',function(){
if(base.hoverStatus!=='stop'){
base.play()
}
})
}
},
lazyLoad:function(){
var base=this,i,$item,itemNumber,$lazyImg,follow;
if(base.options.lazyLoad===false){
return false
}
for(i=0;i<base.itemsAmount;i+=1){
$item=$(base.$owlItems[i]);
if($item.data('owl-loaded')==='loaded'){
continue
}
itemNumber=$item.data('owl-item');
$lazyImg=$item.find('.lazyOwl');
if(typeof $lazyImg.data('src')!=='string'){
$item.data('owl-loaded','loaded');
continue
}
if($item.data('owl-loaded')===undefined){
$lazyImg.hide();
$item.addClass('loading').data('owl-loaded','checked')
}
if(base.options.lazyFollow===true){
follow=itemNumber>=base.currentItem
}else{
follow=true
}
if(follow&&itemNumber<base.currentItem+base.options.items&&$lazyImg.length){
base.lazyPreload($item,$lazyImg)
}
}
},
lazyPreload:function($item,$lazyImg){
var base=this,iterations=0,isBackgroundImg;
if($lazyImg.prop('tagName')==='DIV'){
$lazyImg.css('background-image','url('+$lazyImg.data('src')+')');
isBackgroundImg=true
}else{
$lazyImg[0].src=$lazyImg.data('src')
}
function showImage(){
$item.data('owl-loaded','loaded').removeClass('loading');
$lazyImg.removeAttr('data-src');
if(base.options.lazyEffect==='fade'){
$lazyImg.fadeIn(400)
}else{
$lazyImg.show()
}
if(typeof base.options.afterLazyLoad==='function'){
base.options.afterLazyLoad.apply(this,[base.$elem])
}
}
function checkLazyImage(){
iterations+=1;
if(base.completeImg($lazyImg.get(0))||isBackgroundImg===true){
showImage()
}else if(iterations<=100){
window.setTimeout(checkLazyImage,100)
}else{
showImage()
}
}
checkLazyImage()
},
autoHeight:function(){
var base=this,$currentimg=$(base.$owlItems[base.currentItem]).find('img'),iterations;
function addHeight(){
var $currentItem=$(base.$owlItems[base.currentItem]).height();
base.wrapperOuter.css('height',$currentItem+'px');
if(!base.wrapperOuter.hasClass('autoHeight')){
window.setTimeout(function(){
base.wrapperOuter.addClass('autoHeight')
},0)
}
}
function checkImage(){
iterations+=1;
if(base.completeImg($currentimg.get(0))){
addHeight()
}else if(iterations<=100){
window.setTimeout(checkImage,100)
}else{
base.wrapperOuter.css('height','')
}
}
if($currentimg.get(0)!==undefined){
iterations=0;
checkImage()
}else{
addHeight()
}
},
completeImg:function(img){
var naturalWidthType;
if(!img.complete){
return false
}
naturalWidthType=typeof img.naturalWidth;
if(naturalWidthType!=='undefined'&&img.naturalWidth===0){
return false
}
return true
},
onVisibleItems:function(){
var base=this,i;
if(base.options.addClassActive===true){
base.$owlItems.removeClass('active')
}
base.visibleItems=[];
for(i=base.currentItem;i<base.currentItem+base.options.items;i+=1){
base.visibleItems.push(i);
if(base.options.addClassActive===true){
$(base.$owlItems[i]).addClass('active')
}
}
base.owl.visibleItems=base.visibleItems
},
transitionTypes:function(className){
var base=this;
base.outClass='owl-'+className+'-out';
base.inClass='owl-'+className+'-in'
},
singleItemTransition:function(){
var base=this,outClass=base.outClass,inClass=base.inClass,$currentItem=base.$owlItems.eq(base.currentItem),$prevItem=base.$owlItems.eq(base.prevItem),prevPos=Math.abs(base.positionsInArray[base.currentItem])+base.positionsInArray[base.prevItem],origin=Math.abs(base.positionsInArray[base.currentItem])+base.itemWidth/2,animEnd='webkitAnimationEnd oAnimationEnd MSAnimationEnd animationend';
base.isTransition=true;
base.$owlWrapper.addClass('owl-origin').css({
'-webkit-transform-origin':origin+'px',
'-moz-perspective-origin':origin+'px',
'perspective-origin':origin+'px'
});
function transStyles(prevPos){
return{
'position':'relative',
'left':prevPos+'px'
}
}
$prevItem.css(transStyles(prevPos,10)).addClass(outClass).on(animEnd,function(){
base.endPrev=true;
$prevItem.off(animEnd);
base.clearTransStyle($prevItem,outClass)
});
$currentItem.addClass(inClass).on(animEnd,function(){
base.endCurrent=true;
$currentItem.off(animEnd);
base.clearTransStyle($currentItem,inClass)
})
},
clearTransStyle:function(item,classToRemove){
var base=this;
item.css({
'position':'',
'left':''
}).removeClass(classToRemove);
if(base.endPrev&&base.endCurrent){
base.$owlWrapper.removeClass('owl-origin');
base.endPrev=false;
base.endCurrent=false;
base.isTransition=false
}
},
owlStatus:function(){
var base=this;
base.owl={
'userOptions':base.userOptions,
'baseElement':base.$elem,
'userItems':base.$userItems,
'owlItems':base.$owlItems,
'currentItem':base.currentItem,
'prevItem':base.prevItem,
'visibleItems':base.visibleItems,
'isTouch':base.browser.isTouch,
'browser':base.browser,
'dragDirection':base.dragDirection
}
},
clearEvents:function(){
var base=this;
base.$elem.off('.owl owl mousedown.disableTextSelect');
$(document).off('.owl owl');
$(window).off('resize',base.resizer)
},
unWrap:function(){
var base=this;
if(base.$elem.children().length!==0){
base.$owlWrapper.unwrap();
base.$userItems.unwrap().unwrap();
if(base.owlControls){
base.owlControls.remove()
}
}
base.clearEvents();
base.$elem.attr('style',base.$elem.data('owl-originalStyles')||'').attr('class',base.$elem.data('owl-originalClasses'))
},
destroy:function(){
var base=this;
base.stop();
window.clearInterval(base.checkVisible);
base.unWrap();
base.$elem.removeData()
},
reinit:function(newOptions){
var base=this,options=$.extend({},base.userOptions,newOptions);
base.unWrap();
base.init(options,base.$elem)
},
addItem:function(htmlString,targetPosition){
var base=this,position;
if(!htmlString){
return false
}
if(base.$elem.children().length===0){
base.$elem.append(htmlString);
base.setVars();
return false
}
base.unWrap();
if(targetPosition===undefined||targetPosition===-1){
position=-1
}else{
position=targetPosition
}
if(position>=base.$userItems.length||position===-1){
base.$userItems.eq(-1).after(htmlString)
}else{
base.$userItems.eq(position).before(htmlString)
}
base.setVars()
},
removeItem:function(targetPosition){
var base=this,position;
if(base.$elem.children().length===0){
return false
}
if(targetPosition===undefined||targetPosition===-1){
position=-1
}else{
position=targetPosition
}
base.unWrap();
base.$userItems.eq(position).remove();
base.setVars()
}
};
$.fn.owlCarousel=function(options){
return this.each(function(){
if($(this).data('owl-init')===true){
return false
}
$(this).data('owl-init',true);
var carousel=Object.create(Carousel);
carousel.init(options,this);
$.data(this,'owlCarousel',carousel)
})
};
$.fn.owlCarousel.options={
items:5,
itemsCustom:false,
itemsDesktop:[
1199,
4
],
itemsDesktopSmall:[
979,
3
],
itemsTablet:[
768,
2
],
itemsTabletSmall:false,
itemsMobile:[
479,
1
],
singleItem:false,
itemsScaleUp:false,
slideSpeed:200,
paginationSpeed:800,
rewindSpeed:1000,
autoPlay:false,
stopOnHover:false,
navigation:false,
navigationText:[
'prev',
'next'
],
rewindNav:true,
scrollPerPage:false,
pagination:true,
paginationNumbers:false,
responsive:true,
responsiveRefreshRate:200,
responsiveBaseWidth:window,
baseClass:'owl-carousel',
theme:'owl-theme',
lazyLoad:false,
lazyFollow:true,
lazyEffect:'fade',
autoHeight:false,
jsonPath:false,
jsonSuccess:false,
dragBeforeAnimFinish:true,
mouseDrag:true,
touchDrag:true,
addClassActive:false,
transitionStyle:false,
beforeUpdate:false,
afterUpdate:false,
beforeInit:false,
afterInit:false,
beforeMove:false,
afterMove:false,
afterAction:false,
startDragging:false,
afterLazyLoad:false
}
}(oneJQuery,window,document));
(function(){
function o(e){
var i=function(e,t){
return r('',e,t)
},s=t;
e&&(t[e]||(t[e]={}),s=t[e]);
if(!s.define||!s.define.packaged)
n.original=s.define,s.define=n,s.define.packaged=!0;
if(!s.require||!s.require.packaged)
r.original=s.require,s.require=i,s.require.packaged=!0
}
var e='ace',t=function(){
return this
}();
if(!e&&typeof requirejs!='undefined')
return;
var n=function(e,t,r){
if(typeof e!='string'){
n.original?n.original.apply(window,arguments):(console.error('dropping module because define wasn\'t a string.'),console.trace());
return
}
arguments.length==2&&(r=t),n.modules||(n.modules={},n.payloads={}),n.payloads[e]=r,n.modules[e]=null
},r=function(e,t,n){
if(Object.prototype.toString.call(t)==='[object Array]'){
var i=[];
for(var o=0,u=t.length;o<u;++o){
var a=s(e,t[o]);
if(!a&&r.original)
return r.original.apply(window,arguments);
i.push(a)
}
n&&n.apply(null,i)
}else{
if(typeof t=='string'){
var f=s(e,t);
return!f&&r.original?r.original.apply(window,arguments):(n&&n(),f)
}
if(r.original)
return r.original.apply(window,arguments)
}
},i=function(e,t){
if(t.indexOf('!')!==-1){
var n=t.split('!');
return i(e,n[0])+'!'+i(e,n[1])
}
if(t.charAt(0)=='.'){
var r=e.split('/').slice(0,-1).join('/');
t=r+'/'+t;
while(t.indexOf('.')!==-1&&s!=t){
var s=t;
t=t.replace(/\/\.\//,'/').replace(/[^\/]+\/\.\.\//,'')
}
}
return t
},s=function(e,t){
t=i(e,t);
var s=n.modules[t];
if(!s){
s=n.payloads[t];
if(typeof s=='function'){
var o={},u={
id:t,
uri:'',
exports:o,
packaged:!0
},a=function(e,n){
return r(t,e,n)
},f=s(a,o,u);
o=f||u.exports,n.modules[t]=o,delete n.payloads[t]
}
s=n.modules[t]=o||s
}
return s
};
o(e)
}(),ace.define('ace/ace',[
'require',
'exports',
'module',
'ace/lib/fixoldbrowsers',
'ace/lib/dom',
'ace/lib/event',
'ace/editor',
'ace/edit_session',
'ace/undomanager',
'ace/virtual_renderer',
'ace/multi_select',
'ace/worker/worker_client',
'ace/keyboard/hash_handler',
'ace/placeholder',
'ace/mode/folding/fold_mode',
'ace/theme/textmate',
'ace/config'
],function(e,t,n){
e('./lib/fixoldbrowsers');
var r=e('./lib/dom'),i=e('./lib/event'),s=e('./editor').Editor,o=e('./edit_session').EditSession,u=e('./undomanager').UndoManager,a=e('./virtual_renderer').VirtualRenderer,f=e('./multi_select').MultiSelect;
e('./worker/worker_client'),e('./keyboard/hash_handler'),e('./placeholder'),e('./mode/folding/fold_mode'),e('./theme/textmate'),t.config=e('./config'),t.require=e,t.edit=function(e){
if(typeof e=='string'){
var n=e,e=document.getElementById(n);
if(!e)
throw new Error('ace.edit can\'t find div #'+n)
}
if(e.env&&e.env.editor instanceof s)
return e.env.editor;
var o=t.createEditSession(r.getInnerText(e));
e.innerHTML='';
var u=new s(new a(e));
new f(u),u.setSession(o);
var l={
document:o,
editor:u,
onResize:u.resize.bind(u,null)
};
return i.addListener(window,'resize',l.onResize),u.on('destroy',function(){
i.removeListener(window,'resize',l.onResize)
}),e.env=u.env=l,u
},t.createEditSession=function(e,t){
var n=new o(e,t);
return n.setUndoManager(new u),n
},t.EditSession=o,t.UndoManager=u
}),ace.define('ace/lib/fixoldbrowsers',[
'require',
'exports',
'module',
'ace/lib/regexp',
'ace/lib/es5-shim'
],function(e,t,n){
e('./regexp'),e('./es5-shim')
}),ace.define('ace/lib/regexp',[
'require',
'exports',
'module'
],function(e,t,n){
function o(e){
return(e.global?'g':'')+(e.ignoreCase?'i':'')+(e.multiline?'m':'')+(e.extended?'x':'')+(e.sticky?'y':'')
}
function u(e,t,n){
if(Array.prototype.indexOf)
return e.indexOf(t,n);
for(var r=n||0;r<e.length;r++)
if(e[r]===t)
return r;
return-1
}
var r={
exec:RegExp.prototype.exec,
test:RegExp.prototype.test,
match:String.prototype.match,
replace:String.prototype.replace,
split:String.prototype.split
},i=r.exec.call(/()??/,'')[1]===undefined,s=function(){
var e=/^/g;
return r.test.call(e,''),!e.lastIndex
}();
if(s&&i)
return;
RegExp.prototype.exec=function(e){
var t=r.exec.apply(this,arguments),n,a;
if(typeof e=='string'&&t){
!i&&t.length>1&&u(t,'')>-1&&(a=RegExp(this.source,r.replace.call(o(this),'g','')),r.replace.call(e.slice(t.index),a,function(){
for(var e=1;e<arguments.length-2;e++)
arguments[e]===undefined&&(t[e]=undefined)
}));
if(this._xregexp&&this._xregexp.captureNames)
for(var f=1;f<t.length;f++)
n=this._xregexp.captureNames[f-1],n&&(t[n]=t[f]);
!s&&this.global&&!t[0].length&&this.lastIndex>t.index&&this.lastIndex--
}
return t
},s||(RegExp.prototype.test=function(e){
var t=r.exec.call(this,e);
return t&&this.global&&!t[0].length&&this.lastIndex>t.index&&this.lastIndex--,!!t
})
}),ace.define('ace/lib/es5-shim',[
'require',
'exports',
'module'
],function(e,t,n){
function r(){
}
function w(e){
try{
return Object.defineProperty(e,'sentinel',{}),'sentinel'in e
}catch(t){
}
}
function H(e){
return e=+e,e!==e?e=0:e!==0&&e!==1/0&&e!==-1/0&&(e=(e>0||-1)*Math.floor(Math.abs(e))),e
}
function B(e){
var t=typeof e;
return e===null||t==='undefined'||t==='boolean'||t==='number'||t==='string'
}
function j(e){
var t,n,r;
if(B(e))
return e;
n=e.valueOf;
if(typeof n=='function'){
t=n.call(e);
if(B(t))
return t
}
r=e.toString;
if(typeof r=='function'){
t=r.call(e);
if(B(t))
return t
}
throw new TypeError
}
Function.prototype.bind||(Function.prototype.bind=function(t){
var n=this;
if(typeof n!='function')
throw new TypeError('Function.prototype.bind called on incompatible '+n);
var i=u.call(arguments,1),s=function(){
if(this instanceof s){
var e=n.apply(this,i.concat(u.call(arguments)));
return Object(e)===e?e:this
}
return n.apply(t,i.concat(u.call(arguments)))
};
return n.prototype&&(r.prototype=n.prototype,s.prototype=new r,r.prototype=null),s
});
var i=Function.prototype.call,s=Array.prototype,o=Object.prototype,u=s.slice,a=i.bind(o.toString),f=i.bind(o.hasOwnProperty),l,c,h,p,d;
if(d=f(o,'__defineGetter__'))
l=i.bind(o.__defineGetter__),c=i.bind(o.__defineSetter__),h=i.bind(o.__lookupGetter__),p=i.bind(o.__lookupSetter__);
if([
1,
2
].splice(0).length!=2)
if(!function(){
function e(e){
var t=new Array(e+2);
return t[0]=t[1]=0,t
}
var t=[],n;
t.splice.apply(t,e(20)),t.splice.apply(t,e(26)),n=t.length,t.splice(5,0,'XXX'),n+1==t.length;
if(n+1==t.length)
return!0
}())
Array.prototype.splice=function(e,t){
var n=this.length;
e>0?e>n&&(e=n):e==void 0?e=0:e<0&&(e=Math.max(n+e,0)),e+t<n||(t=n-e);
var r=this.slice(e,e+t),i=u.call(arguments,2),s=i.length;
if(e===n)
s&&this.push.apply(this,i);
else{
var o=Math.min(t,n-e),a=e+o,f=a+s-o,l=n-a,c=n-o;
if(f<a)
for(var h=0;h<l;++h)
this[f+h]=this[a+h];
else if(f>a)
for(h=l;h--;)
this[f+h]=this[a+h];
if(s&&e===c)
this.length=c,this.push.apply(this,i);
else{
this.length=c+s;
for(h=0;h<s;++h)
this[e+h]=i[h]
}
}
return r
};
else{
var v=Array.prototype.splice;
Array.prototype.splice=function(e,t){
return arguments.length?v.apply(this,[
e===void 0?0:e,
t===void 0?this.length-e:t
].concat(u.call(arguments,2))):[]
}
}
Array.isArray||(Array.isArray=function(t){
return a(t)=='[object Array]'
});
var m=Object('a'),g=m[0]!='a'||!(0 in m);
Array.prototype.forEach||(Array.prototype.forEach=function(t){
var n=F(this),r=g&&a(this)=='[object String]'?this.split(''):n,i=arguments[1],s=-1,o=r.length>>>0;
if(a(t)!='[object Function]')
throw new TypeError;
while(++s<o)
s in r&&t.call(i,r[s],s,n)
}),Array.prototype.map||(Array.prototype.map=function(t){
var n=F(this),r=g&&a(this)=='[object String]'?this.split(''):n,i=r.length>>>0,s=Array(i),o=arguments[1];
if(a(t)!='[object Function]')
throw new TypeError(t+' is not a function');
for(var u=0;u<i;u++)
u in r&&(s[u]=t.call(o,r[u],u,n));
return s
}),Array.prototype.filter||(Array.prototype.filter=function(t){
var n=F(this),r=g&&a(this)=='[object String]'?this.split(''):n,i=r.length>>>0,s=[],o,u=arguments[1];
if(a(t)!='[object Function]')
throw new TypeError(t+' is not a function');
for(var f=0;f<i;f++)
f in r&&(o=r[f],t.call(u,o,f,n)&&s.push(o));
return s
}),Array.prototype.every||(Array.prototype.every=function(t){
var n=F(this),r=g&&a(this)=='[object String]'?this.split(''):n,i=r.length>>>0,s=arguments[1];
if(a(t)!='[object Function]')
throw new TypeError(t+' is not a function');
for(var o=0;o<i;o++)
if(o in r&&!t.call(s,r[o],o,n))
return!1;
return!0
}),Array.prototype.some||(Array.prototype.some=function(t){
var n=F(this),r=g&&a(this)=='[object String]'?this.split(''):n,i=r.length>>>0,s=arguments[1];
if(a(t)!='[object Function]')
throw new TypeError(t+' is not a function');
for(var o=0;o<i;o++)
if(o in r&&t.call(s,r[o],o,n))
return!0;
return!1
}),Array.prototype.reduce||(Array.prototype.reduce=function(t){
var n=F(this),r=g&&a(this)=='[object String]'?this.split(''):n,i=r.length>>>0;
if(a(t)!='[object Function]')
throw new TypeError(t+' is not a function');
if(!i&&arguments.length==1)
throw new TypeError('reduce of empty array with no initial value');
var s=0,o;
if(arguments.length>=2)
o=arguments[1];
else
do{
if(s in r){
o=r[s++];
break
}
if(++s>=i)
throw new TypeError('reduce of empty array with no initial value')
}while(!0);
for(;s<i;s++)
s in r&&(o=t.call(void 0,o,r[s],s,n));
return o
}),Array.prototype.reduceRight||(Array.prototype.reduceRight=function(t){
var n=F(this),r=g&&a(this)=='[object String]'?this.split(''):n,i=r.length>>>0;
if(a(t)!='[object Function]')
throw new TypeError(t+' is not a function');
if(!i&&arguments.length==1)
throw new TypeError('reduceRight of empty array with no initial value');
var s,o=i-1;
if(arguments.length>=2)
s=arguments[1];
else
do{
if(o in r){
s=r[o--];
break
}
if(--o<0)
throw new TypeError('reduceRight of empty array with no initial value')
}while(!0);
do
o in this&&(s=t.call(void 0,s,r[o],o,n));
while(o--);
return s
});
if(!Array.prototype.indexOf||[
0,
1
].indexOf(1,2)!=-1)
Array.prototype.indexOf=function(t){
var n=g&&a(this)=='[object String]'?this.split(''):F(this),r=n.length>>>0;
if(!r)
return-1;
var i=0;
arguments.length>1&&(i=H(arguments[1])),i=i>=0?i:Math.max(0,r+i);
for(;i<r;i++)
if(i in n&&n[i]===t)
return i;
return-1
};
if(!Array.prototype.lastIndexOf||[
0,
1
].lastIndexOf(0,-3)!=-1)
Array.prototype.lastIndexOf=function(t){
var n=g&&a(this)=='[object String]'?this.split(''):F(this),r=n.length>>>0;
if(!r)
return-1;
var i=r-1;
arguments.length>1&&(i=Math.min(i,H(arguments[1]))),i=i>=0?i:r-Math.abs(i);
for(;i>=0;i--)
if(i in n&&t===n[i])
return i;
return-1
};
Object.getPrototypeOf||(Object.getPrototypeOf=function(t){
return t.__proto__||(t.constructor?t.constructor.prototype:o)
});
if(!Object.getOwnPropertyDescriptor){
var y='Object.getOwnPropertyDescriptor called on a non-object: ';
Object.getOwnPropertyDescriptor=function(t,n){
if(typeof t!='object'&&typeof t!='function'||t===null)
throw new TypeError(y+t);
if(!f(t,n))
return;
var r,i,s;
r={
enumerable:!0,
configurable:!0
};
if(d){
var u=t.__proto__;
t.__proto__=o;
var i=h(t,n),s=p(t,n);
t.__proto__=u;
if(i||s)
return i&&(r.get=i),s&&(r.set=s),r
}
return r.value=t[n],r
}
}
Object.getOwnPropertyNames||(Object.getOwnPropertyNames=function(t){
return Object.keys(t)
});
if(!Object.create){
var b;
Object.prototype.__proto__===null?b=function(){
return{__proto__:null}
}:b=function(){
var e={};
for(var t in e)
e[t]=null;
return e.constructor=e.hasOwnProperty=e.propertyIsEnumerable=e.isPrototypeOf=e.toLocaleString=e.toString=e.valueOf=e.__proto__=null,e
},Object.create=function(t,n){
var r;
if(t===null)
r=b();
else{
if(typeof t!='object')
throw new TypeError('typeof prototype['+typeof t+'] != \'object\'');
var i=function(){
};
i.prototype=t,r=new i,r.__proto__=t
}
return n!==void 0&&Object.defineProperties(r,n),r
}
}
if(Object.defineProperty){
var E=w({}),S=typeof document=='undefined'||w(document.createElement('div'));
if(!E||!S)
var x=Object.defineProperty
}
if(!Object.defineProperty||x){
var T='Property description must be an object: ',N='Object.defineProperty called on non-object: ',C='getters & setters can not be defined on this javascript engine';
Object.defineProperty=function(t,n,r){
if(typeof t!='object'&&typeof t!='function'||t===null)
throw new TypeError(N+t);
if(typeof r!='object'&&typeof r!='function'||r===null)
throw new TypeError(T+r);
if(x)
try{
return x.call(Object,t,n,r)
}catch(i){
}
if(f(r,'value'))
if(d&&(h(t,n)||p(t,n))){
var s=t.__proto__;
t.__proto__=o,delete t[n],t[n]=r.value,t.__proto__=s
}else
t[n]=r.value;
else{
if(!d)
throw new TypeError(C);
f(r,'get')&&l(t,n,r.get),f(r,'set')&&c(t,n,r.set)
}
return t
}
}
Object.defineProperties||(Object.defineProperties=function(t,n){
for(var r in n)
f(n,r)&&Object.defineProperty(t,r,n[r]);
return t
}),Object.seal||(Object.seal=function(t){
return t
}),Object.freeze||(Object.freeze=function(t){
return t
});
try{
Object.freeze(function(){
})
}catch(k){
Object.freeze=function(t){
return function(n){
return typeof n=='function'?n:t(n)
}
}(Object.freeze)
}
Object.preventExtensions||(Object.preventExtensions=function(t){
return t
}),Object.isSealed||(Object.isSealed=function(t){
return!1
}),Object.isFrozen||(Object.isFrozen=function(t){
return!1
}),Object.isExtensible||(Object.isExtensible=function(t){
if(Object(t)===t)
throw new TypeError;
var n='';
while(f(t,n))
n+='?';
t[n]=!0;
var r=f(t,n);
return delete t[n],r
});
if(!Object.keys){
var L=!0,A=[
'toString',
'toLocaleString',
'valueOf',
'hasOwnProperty',
'isPrototypeOf',
'propertyIsEnumerable',
'constructor'
],O=A.length;
for(var M in{toString:null})
L=!1;
Object.keys=function I(e){
if(typeof e!='object'&&typeof e!='function'||e===null)
throw new TypeError('Object.keys called on a non-object');
var I=[];
for(var t in e)
f(e,t)&&I.push(t);
if(L)
for(var n=0,r=O;n<r;n++){
var i=A[n];
f(e,i)&&I.push(i)
}
return I
}
}
Date.now||(Date.now=function(){
return new Date().getTime()
});
var _='	\n\r \u2028\u2029';
if(!String.prototype.trim||_.trim()){
_='['+_+']';
var D=new RegExp('^'+_+_+'*'),P=new RegExp(_+_+'*$');
String.prototype.trim=function(){
return String(this).replace(D,'').replace(P,'')
}
}
var F=function(e){
if(e==null)
throw new TypeError('can\'t convert '+e+' to object');
return Object(e)
}
}),ace.define('ace/lib/dom',[
'require',
'exports',
'module'
],function(e,t,n){
if(typeof document=='undefined')
return;
var r='http://www.w3.org/1999/xhtml';
t.getDocumentHead=function(e){
return e||(e=document),e.head||e.getElementsByTagName('head')[0]||e.documentElement
},t.createElement=function(e,t){
return document.createElementNS?document.createElementNS(t||r,e):document.createElement(e)
},t.hasCssClass=function(e,t){
var n=e.className.split(/\s+/g);
return n.indexOf(t)!==-1
},t.addCssClass=function(e,n){
t.hasCssClass(e,n)||(e.className+=' '+n)
},t.removeCssClass=function(e,t){
var n=e.className.split(/\s+/g);
for(;;){
var r=n.indexOf(t);
if(r==-1)
break;
n.splice(r,1)
}
e.className=n.join(' ')
},t.toggleCssClass=function(e,t){
var n=e.className.split(/\s+/g),r=!0;
for(;;){
var i=n.indexOf(t);
if(i==-1)
break;
r=!1,n.splice(i,1)
}
return r&&n.push(t),e.className=n.join(' '),r
},t.setCssClass=function(e,n,r){
r?t.addCssClass(e,n):t.removeCssClass(e,n)
},t.hasCssString=function(e,t){
var n=0,r;
t=t||document;
if(t.createStyleSheet&&(r=t.styleSheets)){
while(n<r.length)
if(r[n++].owningElement.id===e)
return!0
}else if(r=t.getElementsByTagName('style'))
while(n<r.length)
if(r[n++].id===e)
return!0;
return!1
},t.importCssString=function(n,i,s){
s=s||document;
if(i&&t.hasCssString(i,s))
return null;
var o;
s.createStyleSheet?(o=s.createStyleSheet(),o.cssText=n,i&&(o.owningElement.id=i)):(o=s.createElementNS?s.createElementNS(r,'style'):s.createElement('style'),o.appendChild(s.createTextNode(n)),i&&(o.id=i),t.getDocumentHead(s).appendChild(o))
},t.importCssStylsheet=function(e,n){
if(n.createStyleSheet)
n.createStyleSheet(e);
else{
var r=t.createElement('link');
r.rel='stylesheet',r.href=e,t.getDocumentHead(n).appendChild(r)
}
},t.getInnerWidth=function(e){
return parseInt(t.computedStyle(e,'paddingLeft'),10)+parseInt(t.computedStyle(e,'paddingRight'),10)+e.clientWidth
},t.getInnerHeight=function(e){
return parseInt(t.computedStyle(e,'paddingTop'),10)+parseInt(t.computedStyle(e,'paddingBottom'),10)+e.clientHeight
},window.pageYOffset!==undefined?(t.getPageScrollTop=function(){
return window.pageYOffset
},t.getPageScrollLeft=function(){
return window.pageXOffset
}):(t.getPageScrollTop=function(){
return document.body.scrollTop
},t.getPageScrollLeft=function(){
return document.body.scrollLeft
}),window.getComputedStyle?t.computedStyle=function(e,t){
return t?(window.getComputedStyle(e,'')||{})[t]||'':window.getComputedStyle(e,'')||{}
}:t.computedStyle=function(e,t){
return t?e.currentStyle[t]:e.currentStyle
},t.scrollbarWidth=function(e){
var n=t.createElement('ace_inner');
n.style.width='100%',n.style.minWidth='0px',n.style.height='200px',n.style.display='block';
var r=t.createElement('ace_outer'),i=r.style;
i.position='absolute',i.left='-10000px',i.overflow='hidden',i.width='200px',i.minWidth='0px',i.height='150px',i.display='block',r.appendChild(n);
var s=e.documentElement;
s.appendChild(r);
var o=n.offsetWidth;
i.overflow='scroll';
var u=n.offsetWidth;
return o==u&&(u=r.clientWidth),s.removeChild(r),o-u
},t.setInnerHtml=function(e,t){
var n=e.cloneNode(!1);
return n.innerHTML=t,e.parentNode.replaceChild(n,e),n
},'textContent'in document.documentElement?(t.setInnerText=function(e,t){
e.textContent=t
},t.getInnerText=function(e){
return e.textContent
}):(t.setInnerText=function(e,t){
e.innerText=t
},t.getInnerText=function(e){
return e.innerText
}),t.getParentWindow=function(e){
return e.defaultView||e.parentWindow
}
}),ace.define('ace/lib/event',[
'require',
'exports',
'module',
'ace/lib/keys',
'ace/lib/useragent',
'ace/lib/dom'
],function(e,t,n){
function o(e,t,n){
var s=0;
!i.isOpera||'KeyboardEvent'in window||!i.isMac?s=0|(t.ctrlKey?1:0)|(t.altKey?2:0)|(t.shiftKey?4:0)|(t.metaKey?8:0):s=0|(t.metaKey?1:0)|(t.altKey?2:0)|(t.shiftKey?4:0)|(t.ctrlKey?8:0);
if(!i.isMac&&u){
if(u[91]||u[92])
s|=8;
if(u.altGr){
if((3&s)==3)
return;
u.altGr=0
}
if(n===18||n===17){
var o=t.location||t.keyLocation;
if(n===17&&o===1)
a=t.timeStamp;
else if(n===18&&s===3&&o===2){
var f=-a;
a=t.timeStamp,f+=a,f<3&&(u.altGr=!0)
}
}
}
if(n in r.MODIFIER_KEYS){
switch(r.MODIFIER_KEYS[n]){
case'Alt':
s=2;
break;
case'Shift':
s=4;
break;
case'Ctrl':
s=1;
break;
default:
s=8
}
n=0
}
s&8&&(n===91||n===93)&&(n=0);
if(!s&&n===13)
if(t.location||t.keyLocation===3){
e(t,s,-n);
if(t.defaultPrevented)
return
}
return!!s||n in r.FUNCTION_KEYS||n in r.PRINTABLE_KEYS?e(t,s,n):!1
}
var r=e('./keys'),i=e('./useragent'),s=e('./dom');
t.addListener=function(e,t,n){
if(e.addEventListener)
return e.addEventListener(t,n,!1);
if(e.attachEvent){
var r=function(){
n.call(e,window.event)
};
n._wrapper=r,e.attachEvent('on'+t,r)
}
},t.removeListener=function(e,t,n){
if(e.removeEventListener)
return e.removeEventListener(t,n,!1);
e.detachEvent&&e.detachEvent('on'+t,n._wrapper||n)
},t.stopEvent=function(e){
return t.stopPropagation(e),t.preventDefault(e),!1
},t.stopPropagation=function(e){
e.stopPropagation?e.stopPropagation():e.cancelBubble=!0
},t.preventDefault=function(e){
e.preventDefault?e.preventDefault():e.returnValue=!1
},t.getButton=function(e){
return e.type=='dblclick'?0:e.type=='contextmenu'||e.ctrlKey&&i.isMac?2:e.preventDefault?e.button:{
1:0,
2:2,
4:1
}[e.button]
},t.capture=function(e,n,r){
function i(e){
n&&n(e),r&&r(e),t.removeListener(document,'mousemove',n,!0),t.removeListener(document,'mouseup',i,!0),t.removeListener(document,'dragstart',i,!0)
}
t.addListener(document,'mousemove',n,!0),t.addListener(document,'mouseup',i,!0),t.addListener(document,'dragstart',i,!0)
},t.addMouseWheelListener=function(e,n){
if('onmousewheel'in e){
var r=8;
t.addListener(e,'mousewheel',function(e){
e.wheelDeltaX!==undefined?(e.wheelX=-e.wheelDeltaX/r,e.wheelY=-e.wheelDeltaY/r):(e.wheelX=0,e.wheelY=-e.wheelDelta/r),n(e)
})
}else
'onwheel'in e?t.addListener(e,'wheel',function(e){
e.wheelX=(e.deltaX||0)*5,e.wheelY=(e.deltaY||0)*5,n(e)
}):t.addListener(e,'DOMMouseScroll',function(e){
e.axis&&e.axis==e.HORIZONTAL_AXIS?(e.wheelX=(e.detail||0)*5,e.wheelY=0):(e.wheelX=0,e.wheelY=(e.detail||0)*5),n(e)
})
},t.addMultiMouseDownListener=function(e,n,r,s){
var o=0,u,a,f,l={
2:'dblclick',
3:'tripleclick',
4:'quadclick'
};
t.addListener(e,'mousedown',function(e){
t.getButton(e)!=0?o=0:e.detail>1?(o++,o>4&&(o=1)):o=1;
if(i.isIE){
var n=Math.abs(e.clientX-u)>5||Math.abs(e.clientY-a)>5;
n&&(o=1),o==1&&(u=e.clientX,a=e.clientY)
}
r[s]('mousedown',e);
if(o>4)
o=0;
else if(o>1)
return r[s](l[o],e)
}),i.isOldIE&&t.addListener(e,'dblclick',function(e){
o=2,f&&clearTimeout(f),f=setTimeout(function(){
f=null
},n[o-1]||600),r[s]('mousedown',e),r[s](l[o],e)
})
};
var u=null,a=0;
t.addCommandKeyListener=function(e,n){
var r=t.addListener;
if(i.isOldGecko||i.isOpera&&!('KeyboardEvent'in window)){
var s=null;
r(e,'keydown',function(e){
s=e.keyCode
}),r(e,'keypress',function(e){
return o(n,e,s)
})
}else{
var a=null;
r(e,'keydown',function(e){
u[e.keyCode]=!0;
var t=o(n,e,e.keyCode);
return a=e.defaultPrevented,t
}),r(e,'keypress',function(e){
a&&(e.ctrlKey||e.altKey||e.shiftKey||e.metaKey)&&(t.stopEvent(e),a=null)
}),r(e,'keyup',function(e){
u[e.keyCode]=null
}),u||(u=Object.create(null),r(window,'focus',function(e){
u=Object.create(null)
}))
}
};
if(window.postMessage&&!i.isOldIE){
var f=1;
t.nextTick=function(e,n){
n=n||window;
var r='zero-timeout-message-'+f;
t.addListener(n,'message',function i(s){
s.data==r&&(t.stopPropagation(s),t.removeListener(n,'message',i),e())
}),n.postMessage(r,'*')
}
}
t.nextFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame,t.nextFrame?t.nextFrame=t.nextFrame.bind(window):t.nextFrame=function(e){
setTimeout(e,17)
}
}),ace.define('ace/lib/keys',[
'require',
'exports',
'module',
'ace/lib/oop'
],function(e,t,n){
var r=e('./oop'),i=function(){
var e={
MODIFIER_KEYS:{
16:'Shift',
17:'Ctrl',
18:'Alt',
224:'Meta'
},
KEY_MODS:{
ctrl:1,
alt:2,
option:2,
shift:4,
meta:8,
command:8,
cmd:8
},
FUNCTION_KEYS:{
8:'Backspace',
9:'Tab',
13:'Return',
19:'Pause',
27:'Esc',
32:'Space',
33:'PageUp',
34:'PageDown',
35:'End',
36:'Home',
37:'Left',
38:'Up',
39:'Right',
40:'Down',
44:'Print',
45:'Insert',
46:'Delete',
96:'Numpad0',
97:'Numpad1',
98:'Numpad2',
99:'Numpad3',
100:'Numpad4',
101:'Numpad5',
102:'Numpad6',
103:'Numpad7',
104:'Numpad8',
105:'Numpad9',
'-13':'NumpadEnter',
112:'F1',
113:'F2',
114:'F3',
115:'F4',
116:'F5',
117:'F6',
118:'F7',
119:'F8',
120:'F9',
121:'F10',
122:'F11',
123:'F12',
144:'Numlock',
145:'Scrolllock'
},
PRINTABLE_KEYS:{
32:' ',
48:'0',
49:'1',
50:'2',
51:'3',
52:'4',
53:'5',
54:'6',
55:'7',
56:'8',
57:'9',
59:';',
61:'=',
65:'a',
66:'b',
67:'c',
68:'d',
69:'e',
70:'f',
71:'g',
72:'h',
73:'i',
74:'j',
75:'k',
76:'l',
77:'m',
78:'n',
79:'o',
80:'p',
81:'q',
82:'r',
83:'s',
84:'t',
85:'u',
86:'v',
87:'w',
88:'x',
89:'y',
90:'z',
107:'+',
109:'-',
110:'.',
188:',',
190:'.',
191:'/',
192:'`',
219:'[',
220:'\\',
221:']',
222:'\''
}
};
for(var t in e.FUNCTION_KEYS){
var n=e.FUNCTION_KEYS[t].toLowerCase();
e[n]=parseInt(t,10)
}
return r.mixin(e,e.MODIFIER_KEYS),r.mixin(e,e.PRINTABLE_KEYS),r.mixin(e,e.FUNCTION_KEYS),e.enter=e['return'],e.escape=e.esc,e.del=e['delete'],e[173]='-',e
}();
r.mixin(t,i),t.keyCodeToString=function(e){
return(i[e]||String.fromCharCode(e)).toLowerCase()
}
}),ace.define('ace/lib/oop',[
'require',
'exports',
'module'
],function(e,t,n){
t.inherits=function(){
var e=Object.create||function(e,t){
var n=function(){
};
n.prototype=e,object=new n,object.__proto__=e,typeof t!='undefined'&&Object.defineProperties&&Object.defineProperties(object,t)
};
return function(t,n){
t.super_=n,t.prototype=e(n.prototype,{
constructor:{
value:t,
enumerable:!1,
writable:!0,
configurable:!0
}
})
}
}(),t.mixin=function(e,t){
for(var n in t)
e[n]=t[n];
return e
},t.implement=function(e,n){
t.mixin(e,n)
}
}),ace.define('ace/lib/useragent',[
'require',
'exports',
'module'
],function(e,t,n){
t.OS={
LINUX:'LINUX',
MAC:'MAC',
WINDOWS:'WINDOWS'
},t.getOS=function(){
return t.isMac?t.OS.MAC:t.isLinux?t.OS.LINUX:t.OS.WINDOWS
};
if(typeof navigator!='object')
return;
var r=(navigator.platform.match(/mac|win|linux/i)||['other'])[0].toLowerCase(),i=navigator.userAgent;
t.isWin=r=='win',t.isMac=r=='mac',t.isLinux=r=='linux',t.isIE=(navigator.appName=='Microsoft Internet Explorer'||navigator.appName.indexOf('MSAppHost')>=0)&&parseFloat(navigator.userAgent.match(/MSIE ([0-9]+[\.0-9]+)/)[1]),t.isOldIE=t.isIE&&t.isIE<9,t.isGecko=t.isMozilla=window.controllers&&window.navigator.product==='Gecko',t.isOldGecko=t.isGecko&&parseInt((navigator.userAgent.match(/rv\:(\d+)/)||[])[1],10)<4,t.isOpera=window.opera&&Object.prototype.toString.call(window.opera)=='[object Opera]',t.isWebKit=parseFloat(i.split('WebKit/')[1])||undefined,t.isChrome=parseFloat(i.split(' Chrome/')[1])||undefined,t.isAIR=i.indexOf('AdobeAIR')>=0,t.isIPad=i.indexOf('iPad')>=0,t.isTouchPad=i.indexOf('TouchPad')>=0
}),ace.define('ace/editor',[
'require',
'exports',
'module',
'ace/lib/fixoldbrowsers',
'ace/lib/oop',
'ace/lib/dom',
'ace/lib/lang',
'ace/lib/useragent',
'ace/keyboard/textinput',
'ace/mouse/mouse_handler',
'ace/mouse/fold_handler',
'ace/keyboard/keybinding',
'ace/edit_session',
'ace/search',
'ace/range',
'ace/lib/event_emitter',
'ace/commands/command_manager',
'ace/commands/default_commands',
'ace/config'
],function(e,t,n){
e('./lib/fixoldbrowsers');
var r=e('./lib/oop'),i=e('./lib/dom'),s=e('./lib/lang'),o=e('./lib/useragent'),u=e('./keyboard/textinput').TextInput,a=e('./mouse/mouse_handler').MouseHandler,f=e('./mouse/fold_handler').FoldHandler,l=e('./keyboard/keybinding').KeyBinding,c=e('./edit_session').EditSession,h=e('./search').Search,p=e('./range').Range,d=e('./lib/event_emitter').EventEmitter,v=e('./commands/command_manager').CommandManager,m=e('./commands/default_commands').commands,g=e('./config'),y=function(e,t){
var n=e.getContainerElement();
this.container=n,this.renderer=e,this.commands=new v(o.isMac?'mac':'win',m),this.textInput=new u(e.getTextAreaContainer(),this),this.renderer.textarea=this.textInput.getElement(),this.keyBinding=new l(this),this.$mouseHandler=new a(this),new f(this),this.$blockScrolling=0,this.$search=new h().set({wrap:!0}),this.$historyTracker=this.$historyTracker.bind(this),this.commands.on('exec',this.$historyTracker),this.$initOperationListeners(),this._$emitInputEvent=s.delayedCall(function(){
this._signal('input',{}),this.session.bgTokenizer&&this.session.bgTokenizer.scheduleStart()
}.bind(this)),this.on('change',function(e,t){
t._$emitInputEvent.schedule(31)
}),this.setSession(t||new c('')),g.resetOptions(this),g._emit('editor',this)
};
(function(){
r.implement(this,d),this.$initOperationListeners=function(){
function e(e){
return e[e.length-1]
}
this.selections=[],this.commands.on('exec',function(t){
this.startOperation(t);
var n=t.command;
if(n.group=='fileJump'){
var r=this.prevOp;
if(!r||r.command.group!='fileJump')
this.lastFileJumpPos=e(this.selections)
}else
this.lastFileJumpPos=null
}.bind(this),!0),this.commands.on('afterExec',function(e){
var t=e.command;
if(t.group=='fileJump'&&this.lastFileJumpPos&&!this.curOp.selectionChanged){
this.selection.fromJSON(this.lastFileJumpPos);
return
}
this.endOperation(e)
}.bind(this),!0),this.$opResetTimer=s.delayedCall(this.endOperation.bind(this)),this.on('change',function(){
this.curOp||this.startOperation(),this.curOp.docChanged=!0
}.bind(this),!0),this.on('changeSelection',function(){
this.curOp||this.startOperation(),this.curOp.selectionChanged=!0
}.bind(this),!0)
},this.curOp=null,this.prevOp={},this.startOperation=function(e){
if(this.curOp){
if(!e||this.curOp.command)
return;
this.prevOp=this.curOp
}
e||(this.previousCommand=null,e={}),this.$opResetTimer.schedule(),this.curOp={
command:e.command||{},
args:e.args
};
var t=this.curOp.command;
t&&t.scrollIntoView&&this.$blockScrolling++,this.selections.push(this.selection.toJSON())
},this.endOperation=function(){
if(this.curOp){
var e=this.curOp.command;
if(e&&e.scrollIntoView){
this.$blockScrolling--;
switch(e.scrollIntoView){
case'center':
this.renderer.scrollCursorIntoView(null,0.5);
break;
case'cursor':
this.renderer.scrollCursorIntoView();
break;
case'selectionPart':
this.renderer.scrollCursorIntoView();
break;
default:
}
}
this.prevOp=this.curOp,this.curOp=null
}
},this.$historyTracker=function(e){
if(!this.$mergeUndoDeltas)
return;
var t=this.prevOp,n=[
'backspace',
'del',
'insertstring'
],r=t.command&&e.command.name==t.command.name;
if(e.command.name=='insertstring'){
var i=e.args;
this.mergeNextCommand===undefined&&(this.mergeNextCommand=!0),r=r&&this.mergeNextCommand&&(!/\s/.test(i)||/\s/.test(t.args)),this.mergeNextCommand=!0
}else
r=r&&n.indexOf(e.command.name)!==-1;
this.$mergeUndoDeltas!='always'&&Date.now()-this.sequenceStartTime>2000&&(r=!1),r?this.session.mergeUndoDeltas=!0:n.indexOf(e.command.name)!==-1&&(this.sequenceStartTime=Date.now())
},this.setKeyboardHandler=function(e){
if(!e)
this.keyBinding.setKeyboardHandler(null);
else if(typeof e=='string'){
this.$keybindingId=e;
var t=this;
g.loadModule([
'keybinding',
e
],function(n){
t.$keybindingId==e&&t.keyBinding.setKeyboardHandler(n&&n.handler)
})
}else
this.$keybindingId=null,this.keyBinding.setKeyboardHandler(e)
},this.getKeyboardHandler=function(){
return this.keyBinding.getKeyboardHandler()
},this.setSession=function(e){
if(this.session==e)
return;
if(this.session){
var t=this.session;
this.session.removeEventListener('change',this.$onDocumentChange),this.session.removeEventListener('changeMode',this.$onChangeMode),this.session.removeEventListener('tokenizerUpdate',this.$onTokenizerUpdate),this.session.removeEventListener('changeTabSize',this.$onChangeTabSize),this.session.removeEventListener('changeWrapLimit',this.$onChangeWrapLimit),this.session.removeEventListener('changeWrapMode',this.$onChangeWrapMode),this.session.removeEventListener('onChangeFold',this.$onChangeFold),this.session.removeEventListener('changeFrontMarker',this.$onChangeFrontMarker),this.session.removeEventListener('changeBackMarker',this.$onChangeBackMarker),this.session.removeEventListener('changeBreakpoint',this.$onChangeBreakpoint),this.session.removeEventListener('changeAnnotation',this.$onChangeAnnotation),this.session.removeEventListener('changeOverwrite',this.$onCursorChange),this.session.removeEventListener('changeScrollTop',this.$onScrollTopChange),this.session.removeEventListener('changeScrollLeft',this.$onScrollLeftChange);
var n=this.session.getSelection();
n.removeEventListener('changeCursor',this.$onCursorChange),n.removeEventListener('changeSelection',this.$onSelectionChange)
}
this.session=e,this.$onDocumentChange=this.onDocumentChange.bind(this),e.addEventListener('change',this.$onDocumentChange),this.renderer.setSession(e),this.$onChangeMode=this.onChangeMode.bind(this),e.addEventListener('changeMode',this.$onChangeMode),this.$onTokenizerUpdate=this.onTokenizerUpdate.bind(this),e.addEventListener('tokenizerUpdate',this.$onTokenizerUpdate),this.$onChangeTabSize=this.renderer.onChangeTabSize.bind(this.renderer),e.addEventListener('changeTabSize',this.$onChangeTabSize),this.$onChangeWrapLimit=this.onChangeWrapLimit.bind(this),e.addEventListener('changeWrapLimit',this.$onChangeWrapLimit),this.$onChangeWrapMode=this.onChangeWrapMode.bind(this),e.addEventListener('changeWrapMode',this.$onChangeWrapMode),this.$onChangeFold=this.onChangeFold.bind(this),e.addEventListener('changeFold',this.$onChangeFold),this.$onChangeFrontMarker=this.onChangeFrontMarker.bind(this),this.session.addEventListener('changeFrontMarker',this.$onChangeFrontMarker),this.$onChangeBackMarker=this.onChangeBackMarker.bind(this),this.session.addEventListener('changeBackMarker',this.$onChangeBackMarker),this.$onChangeBreakpoint=this.onChangeBreakpoint.bind(this),this.session.addEventListener('changeBreakpoint',this.$onChangeBreakpoint),this.$onChangeAnnotation=this.onChangeAnnotation.bind(this),this.session.addEventListener('changeAnnotation',this.$onChangeAnnotation),this.$onCursorChange=this.onCursorChange.bind(this),this.session.addEventListener('changeOverwrite',this.$onCursorChange),this.$onScrollTopChange=this.onScrollTopChange.bind(this),this.session.addEventListener('changeScrollTop',this.$onScrollTopChange),this.$onScrollLeftChange=this.onScrollLeftChange.bind(this),this.session.addEventListener('changeScrollLeft',this.$onScrollLeftChange),this.selection=e.getSelection(),this.selection.addEventListener('changeCursor',this.$onCursorChange),this.$onSelectionChange=this.onSelectionChange.bind(this),this.selection.addEventListener('changeSelection',this.$onSelectionChange),this.onChangeMode(),this.$blockScrolling+=1,this.onCursorChange(),this.$blockScrolling-=1,this.onScrollTopChange(),this.onScrollLeftChange(),this.onSelectionChange(),this.onChangeFrontMarker(),this.onChangeBackMarker(),this.onChangeBreakpoint(),this.onChangeAnnotation(),this.session.getUseWrapMode()&&this.renderer.adjustWrapLimit(),this.renderer.updateFull(),this._emit('changeSession',{
session:e,
oldSession:t
})
},this.getSession=function(){
return this.session
},this.setValue=function(e,t){
return this.session.doc.setValue(e),t?t==1?this.navigateFileEnd():t==-1&&this.navigateFileStart():this.selectAll(),e
},this.getValue=function(){
return this.session.getValue()
},this.getSelection=function(){
return this.selection
},this.resize=function(e){
this.renderer.onResize(e)
},this.setTheme=function(e){
this.renderer.setTheme(e)
},this.getTheme=function(){
return this.renderer.getTheme()
},this.setStyle=function(e){
this.renderer.setStyle(e)
},this.unsetStyle=function(e){
this.renderer.unsetStyle(e)
},this.getFontSize=function(){
return this.getOption('fontSize')||i.computedStyle(this.container,'fontSize')
},this.setFontSize=function(e){
this.setOption('fontSize',e)
},this.$highlightBrackets=function(){
this.session.$bracketHighlight&&(this.session.removeMarker(this.session.$bracketHighlight),this.session.$bracketHighlight=null);
if(this.$highlightPending)
return;
var e=this;
this.$highlightPending=!0,setTimeout(function(){
e.$highlightPending=!1;
var t=e.session.findMatchingBracket(e.getCursorPosition());
if(t)
var n=new p(t.row,t.column,t.row,t.column+1);
else if(e.session.$mode.getMatching)
var n=e.session.$mode.getMatching(e.session);
n&&(e.session.$bracketHighlight=e.session.addMarker(n,'ace_bracket','text'))
},50)
},this.focus=function(){
var e=this;
setTimeout(function(){
e.textInput.focus()
}),this.textInput.focus()
},this.isFocused=function(){
return this.textInput.isFocused()
},this.blur=function(){
this.textInput.blur()
},this.onFocus=function(){
if(this.$isFocused)
return;
this.$isFocused=!0,this.renderer.showCursor(),this.renderer.visualizeFocus(),this._emit('focus')
},this.onBlur=function(){
if(!this.$isFocused)
return;
this.$isFocused=!1,this.renderer.hideCursor(),this.renderer.visualizeBlur(),this._emit('blur')
},this.$cursorChange=function(){
this.renderer.updateCursor()
},this.onDocumentChange=function(e){
var t=e.data,n=t.range,r;
n.start.row==n.end.row&&t.action!='insertLines'&&t.action!='removeLines'?r=n.end.row:r=Infinity,this.renderer.updateLines(n.start.row,r),this._emit('change',e),this.$cursorChange()
},this.onTokenizerUpdate=function(e){
var t=e.data;
this.renderer.updateLines(t.first,t.last)
},this.onScrollTopChange=function(){
this.renderer.scrollToY(this.session.getScrollTop())
},this.onScrollLeftChange=function(){
this.renderer.scrollToX(this.session.getScrollLeft())
},this.onCursorChange=function(){
this.$cursorChange(),this.$blockScrolling||this.renderer.scrollCursorIntoView(),this.$highlightBrackets(),this.$updateHighlightActiveLine(),this._emit('changeSelection')
},this.$updateHighlightActiveLine=function(){
var e=this.getSession(),t;
if(this.$highlightActiveLine){
if(this.$selectionStyle!='line'||!this.selection.isMultiLine())
t=this.getCursorPosition();
this.renderer.$maxLines&&this.session.getLength()===1&&(t=!1)
}
if(e.$highlightLineMarker&&!t)
e.removeMarker(e.$highlightLineMarker.id),e.$highlightLineMarker=null;
else if(!e.$highlightLineMarker&&t){
var n=new p(t.row,t.column,t.row,Infinity);
n.id=e.addMarker(n,'ace_active-line','screenLine'),e.$highlightLineMarker=n
}else
t&&(e.$highlightLineMarker.start.row=t.row,e.$highlightLineMarker.end.row=t.row,e.$highlightLineMarker.start.column=t.column,e._emit('changeBackMarker'))
},this.onSelectionChange=function(e){
var t=this.session;
t.$selectionMarker&&t.removeMarker(t.$selectionMarker),t.$selectionMarker=null;
if(!this.selection.isEmpty()){
var n=this.selection.getRange(),r=this.getSelectionStyle();
t.$selectionMarker=t.addMarker(n,'ace_selection',r)
}else
this.$updateHighlightActiveLine();
var i=this.$highlightSelectedWord&&this.$getSelectionHighLightRegexp();
this.session.highlight(i),this._emit('changeSelection')
},this.$getSelectionHighLightRegexp=function(){
var e=this.session,t=this.getSelectionRange();
if(t.isEmpty()||t.isMultiLine())
return;
var n=t.start.column-1,r=t.end.column+1,i=e.getLine(t.start.row),s=i.length,o=i.substring(Math.max(n,0),Math.min(r,s));
if(n>=0&&/^[\w\d]/.test(o)||r<=s&&/[\w\d]$/.test(o))
return;
o=i.substring(t.start.column,t.end.column);
if(!/^[\w\d]+$/.test(o))
return;
var u=this.$search.$assembleRegExp({
wholeWord:!0,
caseSensitive:!0,
needle:o
});
return u
},this.onChangeFrontMarker=function(){
this.renderer.updateFrontMarkers()
},this.onChangeBackMarker=function(){
this.renderer.updateBackMarkers()
},this.onChangeBreakpoint=function(){
this.renderer.updateBreakpoints()
},this.onChangeAnnotation=function(){
this.renderer.setAnnotations(this.session.getAnnotations())
},this.onChangeMode=function(e){
this.renderer.updateText(),this._emit('changeMode',e)
},this.onChangeWrapLimit=function(){
this.renderer.updateFull()
},this.onChangeWrapMode=function(){
this.renderer.onResize(!0)
},this.onChangeFold=function(){
this.$updateHighlightActiveLine(),this.renderer.updateFull()
},this.getSelectedText=function(){
return this.session.getTextRange(this.getSelectionRange())
},this.getCopyText=function(){
var e=this.getSelectedText();
return this._signal('copy',e),e
},this.onCopy=function(){
this.commands.exec('copy',this)
},this.onCut=function(){
this.commands.exec('cut',this)
},this.onPaste=function(e){
if(this.$readOnly)
return;
this._emit('paste',e),this.insert(e)
},this.execCommand=function(e,t){
this.commands.exec(e,this,t)
},this.insert=function(e){
var t=this.session,n=t.getMode(),r=this.getCursorPosition();
if(this.getBehavioursEnabled()){
var i=n.transformAction(t.getState(r.row),'insertion',this,t,e);
i&&(e!==i.text&&(this.session.mergeUndoDeltas=!1,this.$mergeNextCommand=!1),e=i.text)
}
e=='	'&&(e=this.session.getTabString());
if(!this.selection.isEmpty()){
var s=this.getSelectionRange();
r=this.session.remove(s),this.clearSelection()
}else if(this.session.getOverwrite()){
var s=new p.fromPoints(r,r);
s.end.column+=e.length,this.session.remove(s)
}
if(e=='\n'||e=='\r\n'){
var o=t.getLine(r.row);
if(r.column>o.search(/\S|$/)){
var u=o.substr(r.column).search(/\S|$/);
t.doc.removeInLine(r.row,r.column,r.column+u)
}
}
this.clearSelection();
var a=r.column,f=t.getState(r.row),o=t.getLine(r.row),l=n.checkOutdent(f,o,e),c=t.insert(r,e);
i&&i.selection&&(i.selection.length==2?this.selection.setSelectionRange(new p(r.row,a+i.selection[0],r.row,a+i.selection[1])):this.selection.setSelectionRange(new p(r.row+i.selection[0],i.selection[1],r.row+i.selection[2],i.selection[3])));
if(t.getDocument().isNewLine(e)){
var h=n.getNextLineIndent(f,o.slice(0,r.column),t.getTabString());
t.insert({
row:r.row+1,
column:0
},h)
}
l&&n.autoOutdent(f,t,r.row)
},this.onTextInput=function(e){
this.keyBinding.onTextInput(e)
},this.onCommandKey=function(e,t,n){
this.keyBinding.onCommandKey(e,t,n)
},this.setOverwrite=function(e){
this.session.setOverwrite(e)
},this.getOverwrite=function(){
return this.session.getOverwrite()
},this.toggleOverwrite=function(){
this.session.toggleOverwrite()
},this.setScrollSpeed=function(e){
this.setOption('scrollSpeed',e)
},this.getScrollSpeed=function(){
return this.getOption('scrollSpeed')
},this.setDragDelay=function(e){
this.setOption('dragDelay',e)
},this.getDragDelay=function(){
return this.getOption('dragDelay')
},this.setSelectionStyle=function(e){
this.setOption('selectionStyle',e)
},this.getSelectionStyle=function(){
return this.getOption('selectionStyle')
},this.setHighlightActiveLine=function(e){
this.setOption('highlightActiveLine',e)
},this.getHighlightActiveLine=function(){
return this.getOption('highlightActiveLine')
},this.setHighlightGutterLine=function(e){
this.setOption('highlightGutterLine',e)
},this.getHighlightGutterLine=function(){
return this.getOption('highlightGutterLine')
},this.setHighlightSelectedWord=function(e){
this.setOption('highlightSelectedWord',e)
},this.getHighlightSelectedWord=function(){
return this.$highlightSelectedWord
},this.setAnimatedScroll=function(e){
this.renderer.setAnimatedScroll(e)
},this.getAnimatedScroll=function(){
return this.renderer.getAnimatedScroll()
},this.setShowInvisibles=function(e){
this.renderer.setShowInvisibles(e)
},this.getShowInvisibles=function(){
return this.renderer.getShowInvisibles()
},this.setDisplayIndentGuides=function(e){
this.renderer.setDisplayIndentGuides(e)
},this.getDisplayIndentGuides=function(){
return this.renderer.getDisplayIndentGuides()
},this.setShowPrintMargin=function(e){
this.renderer.setShowPrintMargin(e)
},this.getShowPrintMargin=function(){
return this.renderer.getShowPrintMargin()
},this.setPrintMarginColumn=function(e){
this.renderer.setPrintMarginColumn(e)
},this.getPrintMarginColumn=function(){
return this.renderer.getPrintMarginColumn()
},this.setReadOnly=function(e){
this.setOption('readOnly',e)
},this.getReadOnly=function(){
return this.getOption('readOnly')
},this.setBehavioursEnabled=function(e){
this.setOption('behavioursEnabled',e)
},this.getBehavioursEnabled=function(){
return this.getOption('behavioursEnabled')
},this.setWrapBehavioursEnabled=function(e){
this.setOption('wrapBehavioursEnabled',e)
},this.getWrapBehavioursEnabled=function(){
return this.getOption('wrapBehavioursEnabled')
},this.setShowFoldWidgets=function(e){
this.setOption('showFoldWidgets',e)
},this.getShowFoldWidgets=function(){
return this.getOption('showFoldWidgets')
},this.setFadeFoldWidgets=function(e){
this.setOption('fadeFoldWidgets',e)
},this.getFadeFoldWidgets=function(){
return this.getOption('fadeFoldWidgets')
},this.remove=function(e){
this.selection.isEmpty()&&(e=='left'?this.selection.selectLeft():this.selection.selectRight());
var t=this.getSelectionRange();
if(this.getBehavioursEnabled()){
var n=this.session,r=n.getState(t.start.row),i=n.getMode().transformAction(r,'deletion',this,n,t);
if(t.end.column==0){
var s=n.getTextRange(t);
if(s[s.length-1]=='\n'){
var o=n.getLine(t.end.row);
/^\s+$/.test(o)&&(t.end.column=o.length)
}
}
i&&(t=i)
}
this.session.remove(t),this.clearSelection()
},this.removeWordRight=function(){
this.selection.isEmpty()&&this.selection.selectWordRight(),this.session.remove(this.getSelectionRange()),this.clearSelection()
},this.removeWordLeft=function(){
this.selection.isEmpty()&&this.selection.selectWordLeft(),this.session.remove(this.getSelectionRange()),this.clearSelection()
},this.removeToLineStart=function(){
this.selection.isEmpty()&&this.selection.selectLineStart(),this.session.remove(this.getSelectionRange()),this.clearSelection()
},this.removeToLineEnd=function(){
this.selection.isEmpty()&&this.selection.selectLineEnd();
var e=this.getSelectionRange();
e.start.column==e.end.column&&e.start.row==e.end.row&&(e.end.column=0,e.end.row++),this.session.remove(e),this.clearSelection()
},this.splitLine=function(){
this.selection.isEmpty()||(this.session.remove(this.getSelectionRange()),this.clearSelection());
var e=this.getCursorPosition();
this.insert('\n'),this.moveCursorToPosition(e)
},this.transposeLetters=function(){
if(!this.selection.isEmpty())
return;
var e=this.getCursorPosition(),t=e.column;
if(t===0)
return;
var n=this.session.getLine(e.row),r,i;
t<n.length?(r=n.charAt(t)+n.charAt(t-1),i=new p(e.row,t-1,e.row,t+1)):(r=n.charAt(t-1)+n.charAt(t-2),i=new p(e.row,t-2,e.row,t)),this.session.replace(i,r)
},this.toLowerCase=function(){
var e=this.getSelectionRange();
this.selection.isEmpty()&&this.selection.selectWord();
var t=this.getSelectionRange(),n=this.session.getTextRange(t);
this.session.replace(t,n.toLowerCase()),this.selection.setSelectionRange(e)
},this.toUpperCase=function(){
var e=this.getSelectionRange();
this.selection.isEmpty()&&this.selection.selectWord();
var t=this.getSelectionRange(),n=this.session.getTextRange(t);
this.session.replace(t,n.toUpperCase()),this.selection.setSelectionRange(e)
},this.indent=function(){
var e=this.session,t=this.getSelectionRange();
if(t.start.row<t.end.row){
var n=this.$getSelectedRows();
e.indentRows(n.first,n.last,'	');
return
}
if(t.start.column<t.end.column){
var r=e.getTextRange(t);
if(!/^\s+$/.test(r)){
var n=this.$getSelectedRows();
e.indentRows(n.first,n.last,'	');
return
}
}
var i=e.getLine(t.start.row),o=t.start,u=e.getTabSize(),a=e.documentToScreenColumn(o.row,o.column);
if(this.session.getUseSoftTabs())
var f=u-a%u,l=s.stringRepeat(' ',f);
else{
var f=a%u;
while(i[t.start.column]==' '&&f)
t.start.column--,f--;
this.selection.setSelectionRange(t),l='	'
}
return this.insert(l)
},this.blockIndent=function(){
var e=this.$getSelectedRows();
this.session.indentRows(e.first,e.last,'	')
},this.blockOutdent=function(){
var e=this.session.getSelection();
this.session.outdentRows(e.getRange())
},this.sortLines=function(){
var e=this.$getSelectedRows(),t=this.session,n=[];
for(i=e.first;i<=e.last;i++)
n.push(t.getLine(i));
n.sort(function(e,t){
return e.toLowerCase()<t.toLowerCase()?-1:e.toLowerCase()>t.toLowerCase()?1:0
});
var r=new p(0,0,0,0);
for(var i=e.first;i<=e.last;i++){
var s=t.getLine(i);
r.start.row=i,r.end.row=i,r.end.column=s.length,t.replace(r,n[i-e.first])
}
},this.toggleCommentLines=function(){
var e=this.session.getState(this.getCursorPosition().row),t=this.$getSelectedRows();
this.session.getMode().toggleCommentLines(e,this.session,t.first,t.last)
},this.toggleBlockComment=function(){
var e=this.getCursorPosition(),t=this.session.getState(e.row),n=this.getSelectionRange();
this.session.getMode().toggleBlockComment(t,this.session,n,e)
},this.getNumberAt=function(e,t){
var n=/[\-]?[0-9]+(?:\.[0-9]+)?/g;
n.lastIndex=0;
var r=this.session.getLine(e);
while(n.lastIndex<t){
var i=n.exec(r);
if(i.index<=t&&i.index+i[0].length>=t){
var s={
value:i[0],
start:i.index,
end:i.index+i[0].length
};
return s
}
}
return null
},this.modifyNumber=function(e){
var t=this.selection.getCursor().row,n=this.selection.getCursor().column,r=new p(t,n-1,t,n),i=this.session.getTextRange(r);
if(!isNaN(parseFloat(i))&&isFinite(i)){
var s=this.getNumberAt(t,n);
if(s){
var o=s.value.indexOf('.')>=0?s.start+s.value.indexOf('.')+1:s.end,u=s.start+s.value.length-o,a=parseFloat(s.value);
a*=Math.pow(10,u),o!==s.end&&n<o?e*=Math.pow(10,s.end-n-1):e*=Math.pow(10,s.end-n),a+=e,a/=Math.pow(10,u);
var f=a.toFixed(u),l=new p(t,s.start,t,s.end);
this.session.replace(l,f),this.moveCursorTo(t,Math.max(s.start+1,n+f.length-s.value.length))
}
}
},this.removeLines=function(){
var e=this.$getSelectedRows(),t;
e.first===0||e.last+1<this.session.getLength()?t=new p(e.first,0,e.last+1,0):t=new p(e.first-1,this.session.getLine(e.first-1).length,e.last,this.session.getLine(e.last).length),this.session.remove(t),this.clearSelection()
},this.duplicateSelection=function(){
var e=this.selection,t=this.session,n=e.getRange(),r=e.isBackwards();
if(n.isEmpty()){
var i=n.start.row;
t.duplicateLines(i,i)
}else{
var s=r?n.start:n.end,o=t.insert(s,t.getTextRange(n),!1);
n.start=s,n.end=o,e.setSelectionRange(n,r)
}
},this.moveLinesDown=function(){
this.$moveLines(function(e,t){
return this.session.moveLinesDown(e,t)
})
},this.moveLinesUp=function(){
this.$moveLines(function(e,t){
return this.session.moveLinesUp(e,t)
})
},this.moveText=function(e,t,n){
return this.session.moveText(e,t,n)
},this.copyLinesUp=function(){
this.$moveLines(function(e,t){
return this.session.duplicateLines(e,t),0
})
},this.copyLinesDown=function(){
this.$moveLines(function(e,t){
return this.session.duplicateLines(e,t)
})
},this.$moveLines=function(e){
var t=this.selection;
if(!t.inMultiSelectMode||this.inVirtualSelectionMode){
var n=t.toOrientedRange(),r=this.$getSelectedRows(n),i=e.call(this,r.first,r.last);
n.moveBy(i,0),t.fromOrientedRange(n)
}else{
var s=t.rangeList.ranges;
t.rangeList.detach(this.session);
for(var o=s.length;o--;){
var u=o,r=s[o].collapseRows(),a=r.end.row,f=r.start.row;
while(o--){
var r=s[o].collapseRows();
if(!(f-r.end.row<=1))
break;
f=r.end.row
}
o++;
var i=e.call(this,f,a);
while(u>=o)
s[u].moveBy(i,0),u--
}
t.fromOrientedRange(t.ranges[0]),t.rangeList.attach(this.session)
}
},this.$getSelectedRows=function(){
var e=this.getSelectionRange().collapseRows();
return{
first:this.session.getRowFoldStart(e.start.row),
last:this.session.getRowFoldEnd(e.end.row)
}
},this.onCompositionStart=function(e){
this.renderer.showComposition(this.getCursorPosition())
},this.onCompositionUpdate=function(e){
this.renderer.setCompositionText(e)
},this.onCompositionEnd=function(){
this.renderer.hideComposition()
},this.getFirstVisibleRow=function(){
return this.renderer.getFirstVisibleRow()
},this.getLastVisibleRow=function(){
return this.renderer.getLastVisibleRow()
},this.isRowVisible=function(e){
return e>=this.getFirstVisibleRow()&&e<=this.getLastVisibleRow()
},this.isRowFullyVisible=function(e){
return e>=this.renderer.getFirstFullyVisibleRow()&&e<=this.renderer.getLastFullyVisibleRow()
},this.$getVisibleRowCount=function(){
return this.renderer.getScrollBottomRow()-this.renderer.getScrollTopRow()+1
},this.$moveByPage=function(e,t){
var n=this.renderer,r=this.renderer.layerConfig,i=e*Math.floor(r.height/r.lineHeight);
this.$blockScrolling++,t==1?this.selection.$moveSelection(function(){
this.moveCursorBy(i,0)
}):t==0&&(this.selection.moveCursorBy(i,0),this.selection.clearSelection()),this.$blockScrolling--;
var s=n.scrollTop;
n.scrollBy(0,i*r.lineHeight),t!=null&&n.scrollCursorIntoView(null,0.5),n.animateScrolling(s)
},this.selectPageDown=function(){
this.$moveByPage(1,!0)
},this.selectPageUp=function(){
this.$moveByPage(-1,!0)
},this.gotoPageDown=function(){
this.$moveByPage(1,!1)
},this.gotoPageUp=function(){
this.$moveByPage(-1,!1)
},this.scrollPageDown=function(){
this.$moveByPage(1)
},this.scrollPageUp=function(){
this.$moveByPage(-1)
},this.scrollToRow=function(e){
this.renderer.scrollToRow(e)
},this.scrollToLine=function(e,t,n,r){
this.renderer.scrollToLine(e,t,n,r)
},this.centerSelection=function(){
var e=this.getSelectionRange(),t={
row:Math.floor(e.start.row+(e.end.row-e.start.row)/2),
column:Math.floor(e.start.column+(e.end.column-e.start.column)/2)
};
this.renderer.alignCursor(t,0.5)
},this.getCursorPosition=function(){
return this.selection.getCursor()
},this.getCursorPositionScreen=function(){
return this.session.documentToScreenPosition(this.getCursorPosition())
},this.getSelectionRange=function(){
return this.selection.getRange()
},this.selectAll=function(){
this.$blockScrolling+=1,this.selection.selectAll(),this.$blockScrolling-=1
},this.clearSelection=function(){
this.selection.clearSelection()
},this.moveCursorTo=function(e,t){
this.selection.moveCursorTo(e,t)
},this.moveCursorToPosition=function(e){
this.selection.moveCursorToPosition(e)
},this.jumpToMatching=function(e){
var t=this.getCursorPosition(),n=this.session.getBracketRange(t);
if(!n){
n=this.find({
needle:/[{}()\[\]]/g,
preventScroll:!0,
start:{
row:t.row,
column:t.column-1
}
});
if(!n)
return;
var r=n.start;
r.row==t.row&&Math.abs(r.column-t.column)<2&&(n=this.session.getBracketRange(r))
}
r=n&&n.cursor||r,r&&(e?n&&n.isEqual(this.getSelectionRange())?this.clearSelection():this.selection.selectTo(r.row,r.column):(this.clearSelection(),this.moveCursorTo(r.row,r.column)))
},this.gotoLine=function(e,t,n){
this.selection.clearSelection(),this.session.unfold({
row:e-1,
column:t||0
}),this.$blockScrolling+=1,this.exitMultiSelectMode&&this.exitMultiSelectMode(),this.moveCursorTo(e-1,t||0),this.$blockScrolling-=1,this.isRowFullyVisible(e-1)||this.scrollToLine(e-1,!0,n)
},this.navigateTo=function(e,t){
this.clearSelection(),this.moveCursorTo(e,t)
},this.navigateUp=function(e){
if(this.selection.isMultiLine()&&!this.selection.isBackwards()){
var t=this.selection.anchor.getPosition();
return this.moveCursorToPosition(t)
}
this.selection.clearSelection(),e=e||1,this.selection.moveCursorBy(-e,0)
},this.navigateDown=function(e){
if(this.selection.isMultiLine()&&this.selection.isBackwards()){
var t=this.selection.anchor.getPosition();
return this.moveCursorToPosition(t)
}
this.selection.clearSelection(),e=e||1,this.selection.moveCursorBy(e,0)
},this.navigateLeft=function(e){
if(!this.selection.isEmpty()){
var t=this.getSelectionRange().start;
this.moveCursorToPosition(t)
}else{
e=e||1;
while(e--)
this.selection.moveCursorLeft()
}
this.clearSelection()
},this.navigateRight=function(e){
if(!this.selection.isEmpty()){
var t=this.getSelectionRange().end;
this.moveCursorToPosition(t)
}else{
e=e||1;
while(e--)
this.selection.moveCursorRight()
}
this.clearSelection()
},this.navigateLineStart=function(){
this.selection.moveCursorLineStart(),this.clearSelection()
},this.navigateLineEnd=function(){
this.selection.moveCursorLineEnd(),this.clearSelection()
},this.navigateFileEnd=function(){
var e=this.renderer.scrollTop;
this.selection.moveCursorFileEnd(),this.clearSelection(),this.renderer.animateScrolling(e)
},this.navigateFileStart=function(){
var e=this.renderer.scrollTop;
this.selection.moveCursorFileStart(),this.clearSelection(),this.renderer.animateScrolling(e)
},this.navigateWordRight=function(){
this.selection.moveCursorWordRight(),this.clearSelection()
},this.navigateWordLeft=function(){
this.selection.moveCursorWordLeft(),this.clearSelection()
},this.replace=function(e,t){
t&&this.$search.set(t);
var n=this.$search.find(this.session),r=0;
return n?(this.$tryReplace(n,e)&&(r=1),n!==null&&(this.selection.setSelectionRange(n),this.renderer.scrollSelectionIntoView(n.start,n.end)),r):r
},this.replaceAll=function(e,t){
t&&this.$search.set(t);
var n=this.$search.findAll(this.session),r=0;
if(!n.length)
return r;
this.$blockScrolling+=1;
var i=this.getSelectionRange();
this.clearSelection(),this.selection.moveCursorTo(0,0);
for(var s=n.length-1;s>=0;--s)
this.$tryReplace(n[s],e)&&r++;
return this.selection.setSelectionRange(i),this.$blockScrolling-=1,r
},this.$tryReplace=function(e,t){
var n=this.session.getTextRange(e);
return t=this.$search.replace(n,t),t!==null?(e.end=this.session.replace(e,t),e):null
},this.getLastSearchOptions=function(){
return this.$search.getOptions()
},this.find=function(e,t,n){
t||(t={}),typeof e=='string'||e instanceof RegExp?t.needle=e:typeof e=='object'&&r.mixin(t,e);
var i=this.selection.getRange();
t.needle==null&&(e=this.session.getTextRange(i)||this.$search.$options.needle,e||(i=this.session.getWordRange(i.start.row,i.start.column),e=this.session.getTextRange(i)),this.$search.set({needle:e})),this.$search.set(t),t.start||this.$search.set({start:i});
var s=this.$search.find(this.session);
if(t.preventScroll)
return s;
if(s)
return this.revealRange(s,n),s;
t.backwards?i.start=i.end:i.end=i.start,this.selection.setRange(i)
},this.findNext=function(e,t){
this.find({
skipCurrent:!0,
backwards:!1
},e,t)
},this.findPrevious=function(e,t){
this.find(e,{
skipCurrent:!0,
backwards:!0
},t)
},this.revealRange=function(e,t){
this.$blockScrolling+=1,this.session.unfold(e),this.selection.setSelectionRange(e),this.$blockScrolling-=1;
var n=this.renderer.scrollTop;
this.renderer.scrollSelectionIntoView(e.start,e.end,0.5),t!=0&&this.renderer.animateScrolling(n)
},this.undo=function(){
this.$blockScrolling++,this.session.getUndoManager().undo(),this.$blockScrolling--,this.renderer.scrollCursorIntoView(null,0.5)
},this.redo=function(){
this.$blockScrolling++,this.session.getUndoManager().redo(),this.$blockScrolling--,this.renderer.scrollCursorIntoView(null,0.5)
},this.destroy=function(){
this.renderer.destroy(),this._emit('destroy',this)
},this.setAutoScrollEditorIntoView=function(e){
if(e===!1)
return;
var t,n=this,r=!1;
this.$scrollAnchor||(this.$scrollAnchor=document.createElement('div'));
var i=this.$scrollAnchor;
i.style.cssText='position:absolute',this.container.insertBefore(i,this.container.firstChild);
var s=this.on('changeSelection',function(){
r=!0
}),o=this.renderer.on('beforeRender',function(){
r&&(t=n.renderer.container.getBoundingClientRect())
}),u=this.renderer.on('afterRender',function(){
if(r&&t&&n.isFocused()){
var e=n.renderer,s=e.$cursorLayer.$pixelPos,o=e.layerConfig,u=s.top-o.offset;
s.top>=0&&u+t.top<0?r=!0:s.top<o.height&&s.top+t.top+o.lineHeight>window.innerHeight?r=!1:r=null,r!=null&&(i.style.top=u+'px',i.style.left=s.left+'px',i.style.height=o.lineHeight+'px',i.scrollIntoView(r)),r=t=null
}
});
this.setAutoScrollEditorIntoView=function(e){
if(e===!0)
return;
delete this.setAutoScrollEditorIntoView,this.removeEventListener('changeSelection',s),this.renderer.removeEventListener('afterRender',u),this.renderer.removeEventListener('beforeRender',o)
}
},this.$resetCursorStyle=function(){
var e=this.$cursorStyle||'ace',t=this.renderer.$cursorLayer;
if(!t)
return;
t.setSmoothBlinking(e=='smooth'),t.isBlinking=!this.$readOnly&&e!='wide'
}
}.call(y.prototype),g.defineOptions(y.prototype,'editor',{
selectionStyle:{
set:function(e){
this.onSelectionChange(),this._emit('changeSelectionStyle',{data:e})
},
initialValue:'line'
},
highlightActiveLine:{
set:function(){
this.$updateHighlightActiveLine()
},
initialValue:!0
},
highlightSelectedWord:{
set:function(e){
this.$onSelectionChange()
},
initialValue:!0
},
readOnly:{
set:function(e){
this.textInput.setReadOnly(e),this.$resetCursorStyle()
},
initialValue:!1
},
cursorStyle:{
set:function(e){
this.$resetCursorStyle()
},
values:[
'ace',
'slim',
'smooth',
'wide'
],
initialValue:'ace'
},
mergeUndoDeltas:{
values:[
!1,
!0,
'always'
],
initialValue:!0
},
behavioursEnabled:{initialValue:!0},
wrapBehavioursEnabled:{initialValue:!0},
hScrollBarAlwaysVisible:'renderer',
vScrollBarAlwaysVisible:'renderer',
highlightGutterLine:'renderer',
animatedScroll:'renderer',
showInvisibles:'renderer',
showPrintMargin:'renderer',
printMarginColumn:'renderer',
printMargin:'renderer',
fadeFoldWidgets:'renderer',
showFoldWidgets:'renderer',
showGutter:'renderer',
displayIndentGuides:'renderer',
fontSize:'renderer',
fontFamily:'renderer',
maxLines:'renderer',
minLines:'renderer',
scrollPastEnd:'renderer',
fixedWidthGutter:'renderer',
scrollSpeed:'$mouseHandler',
dragDelay:'$mouseHandler',
dragEnabled:'$mouseHandler',
focusTimout:'$mouseHandler',
firstLineNumber:'session',
overwrite:'session',
newLineMode:'session',
useWorker:'session',
useSoftTabs:'session',
tabSize:'session',
wrap:'session',
foldStyle:'session'
}),t.Editor=y)
}),ace.define('ace/lib/lang',[
'require',
'exports',
'module'
],function(e,t,n){
t.stringReverse=function(e){
return e.split('').reverse().join('')
},t.stringRepeat=function(e,t){
var n='';
while(t>0){
t&1&&(n+=e);
if(t>>=1)
e+=e
}
return n
};
var r=/^\s\s*/,i=/\s\s*$/;
t.stringTrimLeft=function(e){
return e.replace(r,'')
},t.stringTrimRight=function(e){
return e.replace(i,'')
},t.copyObject=function(e){
var t={};
for(var n in e)
t[n]=e[n];
return t
},t.copyArray=function(e){
var t=[];
for(var n=0,r=e.length;n<r;n++)
e[n]&&typeof e[n]=='object'?t[n]=this.copyObject(e[n]):t[n]=e[n];
return t
},t.deepCopy=function(e){
if(typeof e!='object'||!e)
return e;
var n=e.constructor;
if(n===RegExp)
return e;
var r=n();
for(var i in e)
typeof e[i]=='object'?r[i]=t.deepCopy(e[i]):r[i]=e[i];
return r
},t.arrayToMap=function(e){
var t={};
for(var n=0;n<e.length;n++)
t[e[n]]=1;
return t
},t.createMap=function(e){
var t=Object.create(null);
for(var n in e)
t[n]=e[n];
return t
},t.arrayRemove=function(e,t){
for(var n=0;n<=e.length;n++)
t===e[n]&&e.splice(n,1)
},t.escapeRegExp=function(e){
return e.replace(/([.*+?^${}()|[\]\/\\])/g,'\\$1')
},t.escapeHTML=function(e){
return e.replace(/&/g,'&#38;').replace(/"/g,'&#34;').replace(/'/g,'&#39;').replace(/</g,'&#60;')
},t.getMatchOffsets=function(e,t){
var n=[];
return e.replace(t,function(e){
n.push({
offset:arguments[arguments.length-2],
length:e.length
})
}),n
},t.deferredCall=function(e){
var t=null,n=function(){
t=null,e()
},r=function(e){
return r.cancel(),t=setTimeout(n,e||0),r
};
return r.schedule=r,r.call=function(){
return this.cancel(),e(),r
},r.cancel=function(){
return clearTimeout(t),t=null,r
},r.isPending=function(){
return t
},r
},t.delayedCall=function(e,t){
var n=null,r=function(){
n=null,e()
},i=function(e){
n==null&&(n=setTimeout(r,e||t))
};
return i.delay=function(e){
n&&clearTimeout(n),n=setTimeout(r,e||t)
},i.schedule=i,i.call=function(){
this.cancel(),e()
},i.cancel=function(){
n&&clearTimeout(n),n=null
},i.isPending=function(){
return n
},i
}
}),ace.define('ace/keyboard/textinput',[
'require',
'exports',
'module',
'ace/lib/event',
'ace/lib/useragent',
'ace/lib/dom',
'ace/lib/lang'
],function(e,t,n){
var r=e('../lib/event'),i=e('../lib/useragent'),s=e('../lib/dom'),o=e('../lib/lang'),u=i.isChrome<18,a=function(e,t){
function b(e){
if(h)
return;
if(k)
t=0,r=e?0:n.value.length-1;
else
var t=e?2:1,r=2;
try{
n.setSelectionRange(t,r)
}catch(i){
}
}
function w(){
if(h)
return;
n.value=a,i.isWebKit&&y.schedule()
}
function F(){
setTimeout(function(){
p&&(n.style.cssText=p,p=''),t.renderer.$keepTextAreaAtCursor==null&&(t.renderer.$keepTextAreaAtCursor=!0,t.renderer.$moveTextAreaToCursor())
},0)
}
var n=s.createElement('textarea');
n.className='ace_text-input',i.isTouchPad&&n.setAttribute('x-palm-disable-auto-cap',!0),n.wrap='off',n.autocorrect='off',n.autocapitalize='off',n.spellcheck=!1,n.style.opacity='0',e.insertBefore(n,e.firstChild);
var a='',f=!1,l=!1,c=!1,h=!1,p='',d=!0;
try{
var v=document.activeElement===n
}catch(m){
}
r.addListener(n,'blur',function(){
t.onBlur(),v=!1
}),r.addListener(n,'focus',function(){
v=!0,t.onFocus(),b()
}),this.focus=function(){
n.focus()
},this.blur=function(){
n.blur()
},this.isFocused=function(){
return v
};
var g=o.delayedCall(function(){
v&&b(d)
}),y=o.delayedCall(function(){
h||(n.value=a,v&&b())
});
i.isWebKit||t.addEventListener('changeSelection',function(){
t.selection.isEmpty()!=d&&(d=!d,g.schedule())
}),w(),v&&t.onFocus();
var E=function(e){
return e.selectionStart===0&&e.selectionEnd===e.value.length
};
!n.setSelectionRange&&n.createTextRange&&(n.setSelectionRange=function(e,t){
var n=this.createTextRange();
n.collapse(!0),n.moveStart('character',e),n.moveEnd('character',t),n.select()
},E=function(e){
try{
var t=e.ownerDocument.selection.createRange()
}catch(n){
}
return!t||t.parentElement()!=e?!1:t.text==e.value
});
if(i.isOldIE){
var S=!1,x=function(e){
if(S)
return;
var t=n.value;
if(h||!t||t==a)
return;
if(e&&t==a[0])
return T.schedule();
A(t),S=!0,w(),S=!1
},T=o.delayedCall(x);
r.addListener(n,'propertychange',x);
var N={
13:1,
27:1
};
r.addListener(n,'keyup',function(e){
h&&(!n.value||N[e.keyCode])&&setTimeout(B,0);
if((n.value.charCodeAt(0)||0)<129)
return T.call();
h?H():P()
}),r.addListener(n,'keydown',function(e){
T.schedule(50)
})
}
var C=function(e){
f?f=!1:l?l=!1:E(n)?(t.selectAll(),b()):k&&b(t.selection.isEmpty())
},k=null;
this.setInputHandler=function(e){
k=e
},this.getInputHandler=function(){
return k
};
var L=!1,A=function(e){
k&&(e=k(e),k=null),c?(b(),e&&t.onPaste(e),c=!1):e==a.charAt(0)?L?t.execCommand('del',{source:'ace'}):t.execCommand('backspace',{source:'ace'}):(e.substring(0,2)==a?e=e.substr(2):e.charAt(0)==a.charAt(0)?e=e.substr(1):e.charAt(e.length-1)==a.charAt(0)&&(e=e.slice(0,-1)),e.charAt(e.length-1)==a.charAt(0)&&(e=e.slice(0,-1)),e&&t.onTextInput(e)),L&&(L=!1)
},O=function(e){
if(h)
return;
var t=n.value;
A(t),w()
},M=function(e){
var i=t.getCopyText();
if(!i){
r.preventDefault(e);
return
}
var s=e.clipboardData||window.clipboardData;
if(s&&!u){
var o=s.setData('Text',i);
o&&(t.onCut(),r.preventDefault(e))
}
o||(f=!0,n.value=i,n.select(),setTimeout(function(){
f=!1,w(),b(),t.onCut()
}))
},_=function(e){
var i=t.getCopyText();
if(!i){
r.preventDefault(e);
return
}
var s=e.clipboardData||window.clipboardData;
if(s&&!u){
var o=s.setData('Text',i);
o&&(t.onCopy(),r.preventDefault(e))
}
o||(l=!0,n.value=i,n.select(),setTimeout(function(){
l=!1,w(),b(),t.onCopy()
}))
},D=function(e){
var s=e.clipboardData||window.clipboardData;
if(s){
var o=s.getData('Text');
o&&t.onPaste(o),i.isIE&&setTimeout(b),r.preventDefault(e)
}else
n.value='',c=!0
};
r.addCommandKeyListener(n,t.onCommandKey.bind(t)),r.addListener(n,'select',C),r.addListener(n,'input',O),r.addListener(n,'cut',M),r.addListener(n,'copy',_),r.addListener(n,'paste',D),(!('oncut'in n)||!('oncopy'in n)||!('onpaste'in n))&&r.addListener(e,'keydown',function(e){
if(i.isMac&&!e.metaKey||!e.ctrlKey)
return;
switch(e.keyCode){
case 67:
_(e);
break;
case 86:
D(e);
break;
case 88:
M(e)
}
});
var P=function(e){
if(h)
return;
h={},t.onCompositionStart(),setTimeout(H,0),t.on('mousedown',B),t.selection.isEmpty()||(t.insert(''),t.session.markUndoGroup(),t.selection.clearSelection()),t.session.markUndoGroup()
},H=function(){
if(!h)
return;
var e=n.value.replace(/\x01/g,'');
if(h.lastValue===e)
return;
t.onCompositionUpdate(e),h.lastValue&&t.undo(),h.lastValue=e;
if(h.lastValue){
var r=t.selection.getRange();
t.insert(h.lastValue),t.session.markUndoGroup(),h.range=t.selection.getRange(),t.selection.setRange(r),t.selection.clearSelection()
}
},B=function(e){
var r=h;
h=!1;
var i=setTimeout(function(){
i=null;
var e=n.value.replace(/\x01/g,'');
if(h)
return;
e==r.lastValue?w():!r.lastValue&&e&&(w(),A(e))
});
k=function(n){
return i&&clearTimeout(i),n=n.replace(/\x01/g,''),n==r.lastValue?'':(r.lastValue&&i&&t.undo(),n)
},t.onCompositionEnd(),t.removeListener('mousedown',B),e.type=='compositionend'&&r.range&&t.selection.setRange(r.range)
},j=o.delayedCall(H,50);
r.addListener(n,'compositionstart',P),i.isGecko?r.addListener(n,'text',function(){
j.schedule()
}):(r.addListener(n,'keyup',function(){
j.schedule()
}),r.addListener(n,'keydown',function(){
j.schedule()
})),r.addListener(n,'compositionend',B),this.getElement=function(){
return n
},this.setReadOnly=function(e){
n.readOnly=e
},this.onContextMenu=function(e){
L=!0,p||(p=n.style.cssText),n.style.cssText='z-index:100000;'+(i.isIE?'opacity:0.1;':''),b(t.selection.isEmpty()),t._emit('nativecontextmenu',{
target:t,
domEvent:e
});
var o=t.container.getBoundingClientRect(),u=s.computedStyle(t.container),a=o.top+(parseInt(u.borderTopWidth)||0),f=o.left+(parseInt(o.borderLeftWidth)||0),l=o.bottom-a-n.clientHeight,c=function(e){
n.style.left=e.clientX-f-2+'px',n.style.top=Math.min(e.clientY-a-2,l)+'px'
};
c(e);
if(e.type!='mousedown')
return;
t.renderer.$keepTextAreaAtCursor&&(t.renderer.$keepTextAreaAtCursor=null),i.isWin&&r.capture(t.container,c,F)
},this.onContextMenuClose=F;
if(!i.isGecko||i.isMac){
var I=function(e){
t.textInput.onContextMenu(e),F()
};
r.addListener(t.renderer.scroller,'contextmenu',I),r.addListener(n,'contextmenu',I)
}
};
t.TextInput=a
}),ace.define('ace/mouse/mouse_handler',[
'require',
'exports',
'module',
'ace/lib/event',
'ace/lib/useragent',
'ace/mouse/default_handlers',
'ace/mouse/default_gutter_handler',
'ace/mouse/mouse_event',
'ace/mouse/dragdrop_handler',
'ace/config'
],function(e,t,n){
var r=e('../lib/event'),i=e('../lib/useragent'),s=e('./default_handlers').DefaultHandlers,o=e('./default_gutter_handler').GutterHandler,u=e('./mouse_event').MouseEvent,a=e('./dragdrop_handler').DragdropHandler,f=e('../config'),l=function(e){
this.editor=e,new s(this),new o(this),new a(this);
var t=e.renderer.getMouseEventTarget();
r.addListener(t,'click',this.onMouseEvent.bind(this,'click')),r.addListener(t,'mousemove',this.onMouseMove.bind(this,'mousemove')),r.addMultiMouseDownListener(t,[
300,
300,
250
],this,'onMouseEvent'),e.renderer.scrollBarV&&(r.addMultiMouseDownListener(e.renderer.scrollBarV.inner,[
300,
300,
250
],this,'onMouseEvent'),r.addMultiMouseDownListener(e.renderer.scrollBarH.inner,[
300,
300,
250
],this,'onMouseEvent')),r.addMouseWheelListener(e.container,this.onMouseWheel.bind(this,'mousewheel'));
var n=e.renderer.$gutter;
r.addListener(n,'mousedown',this.onMouseEvent.bind(this,'guttermousedown')),r.addListener(n,'click',this.onMouseEvent.bind(this,'gutterclick')),r.addListener(n,'dblclick',this.onMouseEvent.bind(this,'gutterdblclick')),r.addListener(n,'mousemove',this.onMouseEvent.bind(this,'guttermousemove')),r.addListener(t,'mousedown',function(t){
e.focus()
}),r.addListener(n,'mousedown',function(t){
return e.focus(),r.preventDefault(t)
})
};
(function(){
this.onMouseEvent=function(e,t){
this.editor._emit(e,new u(t,this.editor))
},this.onMouseMove=function(e,t){
var n=this.editor._eventRegistry&&this.editor._eventRegistry.mousemove;
if(!n||!n.length)
return;
this.editor._emit(e,new u(t,this.editor))
},this.onMouseWheel=function(e,t){
var n=new u(t,this.editor);
n.speed=this.$scrollSpeed*2,n.wheelX=t.wheelX,n.wheelY=t.wheelY,this.editor._emit(e,n)
},this.setState=function(e){
this.state=e
},this.captureMouse=function(e,t){
this.x=e.x,this.y=e.y,this.isMousePressed=!0;
var n=this.editor.renderer;
n.$keepTextAreaAtCursor&&(n.$keepTextAreaAtCursor=null);
var s=this,o=function(e){
s.x=e.clientX,s.y=e.clientY,t&&t(e)
},u=function(e){
clearInterval(f),a(),s[s.state+'End']&&s[s.state+'End'](e),s.$clickSelection=null,n.$keepTextAreaAtCursor==null&&(n.$keepTextAreaAtCursor=!0,n.$moveTextAreaToCursor()),s.isMousePressed=!1,s.onMouseEvent('mouseup',e)
},a=function(){
s[s.state]&&s[s.state]()
};
if(i.isOldIE&&e.domEvent.type=='dblclick')
return setTimeout(function(){
u(e)
});
r.capture(this.editor.container,o,u);
var f=setInterval(a,20)
}
}.call(l.prototype),f.defineOptions(l.prototype,'mouseHandler',{
scrollSpeed:{initialValue:2},
dragDelay:{initialValue:150},
dragEnabled:{initialValue:!0},
focusTimout:{initialValue:0}
}),t.MouseHandler=l)
}),ace.define('ace/mouse/default_handlers',[
'require',
'exports',
'module',
'ace/lib/dom',
'ace/lib/event',
'ace/lib/useragent'
],function(e,t,n){
function u(e){
e.$clickSelection=null;
var t=e.editor;
t.setDefaultHandler('mousedown',this.onMouseDown.bind(e)),t.setDefaultHandler('dblclick',this.onDoubleClick.bind(e)),t.setDefaultHandler('tripleclick',this.onTripleClick.bind(e)),t.setDefaultHandler('quadclick',this.onQuadClick.bind(e)),t.setDefaultHandler('mousewheel',this.onMouseWheel.bind(e));
var n=[
'select',
'startSelect',
'selectEnd',
'selectAllEnd',
'selectByWordsEnd',
'selectByLinesEnd',
'dragWait',
'dragWaitEnd',
'focusWait'
];
n.forEach(function(t){
e[t]=this[t]
},this),e.selectByLines=this.extendSelectionBy.bind(e,'getLineRange'),e.selectByWords=this.extendSelectionBy.bind(e,'getWordRange')
}
function a(e,t,n,r){
return Math.sqrt(Math.pow(n-e,2)+Math.pow(r-t,2))
}
function f(e,t){
if(e.start.row==e.end.row)
var n=2*t.column-e.start.column-e.end.column;
else if(e.start.row==e.end.row-1&&!e.start.column&&!e.end.column)
var n=t.column-4;
else
var n=2*t.row-e.start.row-e.end.row;
return n<0?{
cursor:e.start,
anchor:e.end
}:{
cursor:e.end,
anchor:e.start
}
}
var r=e('../lib/dom'),i=e('../lib/event'),s=e('../lib/useragent'),o=0;
(function(){
this.onMouseDown=function(e){
var t=e.inSelection(),n=e.getDocumentPosition();
this.mousedownEvent=e;
var r=this.editor,i=e.getButton();
if(i!==0){
var s=r.getSelectionRange(),o=s.isEmpty();
o&&(r.moveCursorToPosition(n),r.selection.clearSelection()),r.textInput.onContextMenu(e.domEvent);
return
}
if(t&&!r.isFocused()){
r.focus();
if(this.$focusTimout&&!this.$clickSelection&&!r.inMultiSelectMode){
this.mousedownEvent.time=new Date().getTime(),this.setState('focusWait'),this.captureMouse(e);
return
}
}
return!t||this.$clickSelection||e.getShiftKey()||r.inMultiSelectMode?this.startSelect(n):t&&(this.mousedownEvent.time=new Date().getTime(),this.startSelect(n)),this.captureMouse(e),e.preventDefault()
},this.startSelect=function(e){
e=e||this.editor.renderer.screenToTextCoordinates(this.x,this.y);
var t=this.editor,n=this.mousedownEvent.getShiftKey();
setTimeout(function(){
n?t.selection.selectToPosition(e):this.$clickSelection||(t.moveCursorToPosition(e),t.selection.clearSelection())
}.bind(this),0),t.renderer.scroller.setCapture&&t.renderer.scroller.setCapture(),t.setStyle('ace_selecting'),this.setState('select')
},this.select=function(){
var e,t=this.editor,n=t.renderer.screenToTextCoordinates(this.x,this.y);
if(this.$clickSelection){
var r=this.$clickSelection.comparePoint(n);
if(r==-1)
e=this.$clickSelection.end;
else if(r==1)
e=this.$clickSelection.start;
else{
var i=f(this.$clickSelection,n);
n=i.cursor,e=i.anchor
}
t.selection.setSelectionAnchor(e.row,e.column)
}
t.selection.selectToPosition(n),t.renderer.scrollCursorIntoView()
},this.extendSelectionBy=function(e){
var t,n=this.editor,r=n.renderer.screenToTextCoordinates(this.x,this.y),i=n.selection[e](r.row,r.column);
if(this.$clickSelection){
var s=this.$clickSelection.comparePoint(i.start),o=this.$clickSelection.comparePoint(i.end);
if(s==-1&&o<=0){
t=this.$clickSelection.end;
if(i.end.row!=r.row||i.end.column!=r.column)
r=i.start
}else if(o==1&&s>=0){
t=this.$clickSelection.start;
if(i.start.row!=r.row||i.start.column!=r.column)
r=i.end
}else if(s==-1&&o==1)
r=i.end,t=i.start;
else{
var u=f(this.$clickSelection,r);
r=u.cursor,t=u.anchor
}
n.selection.setSelectionAnchor(t.row,t.column)
}
n.selection.selectToPosition(r),n.renderer.scrollCursorIntoView()
},this.selectEnd=this.selectAllEnd=this.selectByWordsEnd=this.selectByLinesEnd=function(){
this.editor.unsetStyle('ace_selecting'),this.editor.renderer.scroller.releaseCapture&&this.editor.renderer.scroller.releaseCapture()
},this.focusWait=function(){
var e=a(this.mousedownEvent.x,this.mousedownEvent.y,this.x,this.y),t=new Date().getTime();
(e>o||t-this.mousedownEvent.time>this.$focusTimout)&&this.startSelect(this.mousedownEvent.getDocumentPosition())
},this.onDoubleClick=function(e){
var t=e.getDocumentPosition(),n=this.editor,r=n.session,i=r.getBracketRange(t);
if(i){
i.isEmpty()&&(i.start.column--,i.end.column++),this.$clickSelection=i,this.setState('select');
return
}
this.$clickSelection=n.selection.getWordRange(t.row,t.column),this.setState('selectByWords')
},this.onTripleClick=function(e){
var t=e.getDocumentPosition(),n=this.editor;
this.setState('selectByLines'),this.$clickSelection=n.selection.getLineRange(t.row)
},this.onQuadClick=function(e){
var t=this.editor;
t.selectAll(),this.$clickSelection=t.getSelectionRange(),this.setState('selectAll')
},this.onMouseWheel=function(e){
if(e.getShiftKey()||e.getAccelKey())
return;
var t=e.domEvent.timeStamp,n=t-(this.$lastScrollTime||0),r=this.editor,i=r.renderer.isScrollableBy(e.wheelX*e.speed,e.wheelY*e.speed);
if(i||n<200)
return this.$lastScrollTime=t,r.renderer.scrollBy(e.wheelX*e.speed,e.wheelY*e.speed),e.stop()
}
}.call(u.prototype),t.DefaultHandlers=u)
}),ace.define('ace/mouse/default_gutter_handler',[
'require',
'exports',
'module',
'ace/lib/dom',
'ace/lib/event'
],function(e,t,n){
function s(e){
function f(){
u=r.createElement('div'),u.className='ace_gutter-tooltip',u.style.display='none',t.container.appendChild(u)
}
function l(){
u||f();
var e=o.getDocumentPosition().row,r=n.$annotations[e];
if(!r)
return c();
var i=t.session.getLength();
if(e==i){
var s=t.renderer.pixelToScreenCoordinates(0,o.y).row,l=o.$pos;
if(s>t.session.documentToScreenRow(l.row,l.column))
return c()
}
if(a==r)
return;
a=r.text.join('<br/>'),u.style.display='block',u.innerHTML=a,t.on('mousewheel',c),h(o)
}
function c(){
s&&(s=clearTimeout(s)),a&&(u.style.display='none',a=null,t.removeEventListener('mousewheel',c))
}
function h(e){
var n=t.renderer.$gutter.getBoundingClientRect();
u.style.left=e.x+15+'px';
if(e.y+3*t.renderer.lineHeight+15<n.bottom)
u.style.bottom='',u.style.top=e.y+15+'px';
else{
u.style.top='';
var r=window.innerHeight||document.documentElement.clientHeight;
u.style.bottom=r-e.y+5+'px'
}
}
var t=e.editor,n=t.renderer.$gutterLayer;
e.editor.setDefaultHandler('guttermousedown',function(r){
if(!t.isFocused()||r.getButton()!=0)
return;
var i=n.getRegion(r);
if(i=='foldWidgets')
return;
var s=r.getDocumentPosition().row,o=t.session.selection;
if(r.getShiftKey())
o.selectTo(s,0);
else{
if(r.domEvent.detail==2)
return t.selectAll(),r.preventDefault();
e.$clickSelection=t.selection.getLineRange(s)
}
return e.setState('selectByLines'),e.captureMouse(r),r.preventDefault()
});
var s,o,u,a;
e.editor.setDefaultHandler('guttermousemove',function(t){
var n=t.domEvent.target||t.domEvent.srcElement;
if(r.hasCssClass(n,'ace_fold-widget'))
return c();
a&&h(t),o=t;
if(s)
return;
s=setTimeout(function(){
s=null,o&&!e.isMousePressed?l():c()
},50)
}),i.addListener(t.renderer.$gutter,'mouseout',function(e){
o=null;
if(!a||s)
return;
s=setTimeout(function(){
s=null,c()
},50)
}),t.on('changeSession',c)
}
var r=e('../lib/dom'),i=e('../lib/event');
t.GutterHandler=s
}),ace.define('ace/mouse/mouse_event',[
'require',
'exports',
'module',
'ace/lib/event',
'ace/lib/useragent'
],function(e,t,n){
var r=e('../lib/event'),i=e('../lib/useragent'),s=t.MouseEvent=function(e,t){
this.domEvent=e,this.editor=t,this.x=this.clientX=e.clientX,this.y=this.clientY=e.clientY,this.$pos=null,this.$inSelection=null,this.propagationStopped=!1,this.defaultPrevented=!1
};
(function(){
this.stopPropagation=function(){
r.stopPropagation(this.domEvent),this.propagationStopped=!0
},this.preventDefault=function(){
r.preventDefault(this.domEvent),this.defaultPrevented=!0
},this.stop=function(){
this.stopPropagation(),this.preventDefault()
},this.getDocumentPosition=function(){
return this.$pos?this.$pos:(this.$pos=this.editor.renderer.screenToTextCoordinates(this.clientX,this.clientY),this.$pos)
},this.inSelection=function(){
if(this.$inSelection!==null)
return this.$inSelection;
var e=this.editor,t=e.getSelectionRange();
if(t.isEmpty())
this.$inSelection=!1;
else{
var n=this.getDocumentPosition();
this.$inSelection=t.contains(n.row,n.column)
}
return this.$inSelection
},this.getButton=function(){
return r.getButton(this.domEvent)
},this.getShiftKey=function(){
return this.domEvent.shiftKey
},this.getAccelKey=i.isMac?function(){
return this.domEvent.metaKey
}:function(){
return this.domEvent.ctrlKey
}
}.call(s.prototype))
}),ace.define('ace/mouse/dragdrop_handler',[
'require',
'exports',
'module',
'ace/lib/dom',
'ace/lib/event',
'ace/lib/useragent'
],function(e,t,n){
function f(e){
function T(e,n){
var r=new Date().getTime(),i=!n||e.row!=n.row,s=!n||e.column!=n.column;
if(!S||i||s)
t.$blockScrolling+=1,t.moveCursorToPosition(e),t.$blockScrolling-=1,S=r,x={
x:p,
y:d
};
else{
var o=l(x.x,x.y,p,d);
o>a?S=null:r-S>=u&&(t.renderer.scrollCursorIntoView(),S=null)
}
}
function N(e,n){
var r=new Date().getTime(),i=t.renderer.layerConfig.lineHeight,s=t.renderer.layerConfig.characterWidth,u=t.renderer.scroller.getBoundingClientRect(),a={
x:{
left:p-u.left,
right:u.right-p
},
y:{
top:d-u.top,
bottom:u.bottom-d
}
},f=Math.min(a.x.left,a.x.right),l=Math.min(a.y.top,a.y.bottom),c={
row:e.row,
column:e.column
};
f/s<=2&&(c.column+=a.x.left<a.x.right?-3:2),l/ i<=1&&(c.row+=a.y.top<a.y.bottom?-1:1);
var h=e.row!=c.row,v=e.column!=c.column,m=!n||e.row!=n.row;
h||v&&!m?E?r-E>=o&&t.renderer.scrollCursorIntoView(c):E=r:E=null
}
function C(){
var e=g;
g=t.renderer.screenToTextCoordinates(p,d),T(g,e),N(g,e)
}
function k(){
m=t.selection.toOrientedRange(),h=t.session.addMarker(m,'ace_selection',t.getSelectionStyle()),t.clearSelection(),t.isFocused()&&t.renderer.$cursorLayer.setBlinking(!1),clearInterval(v),v=setInterval(C,20),y=0,i.addListener(document,'mousemove',O)
}
function L(){
clearInterval(v),t.session.removeMarker(h),h=null,t.$blockScrolling+=1,t.selection.fromOrientedRange(m),t.$blockScrolling-=1,t.isFocused()&&!w&&t.renderer.$cursorLayer.setBlinking(!t.getReadOnly()),m=null,y=0,E=null,S=null,i.removeListener(document,'mousemove',O)
}
function O(){
A==null&&(A=setTimeout(function(){
A!=null&&h&&L()
},20))
}
function M(e){
var t=e.types;
return!t||Array.prototype.some.call(t,function(e){
return e=='text/plain'||e=='Text'
})
}
function _(e){
var t=[
'copy',
'copymove',
'all',
'uninitialized'
],n=[
'move',
'copymove',
'linkmove',
'all',
'uninitialized'
],r=s.isMac?e.altKey:e.ctrlKey,i='uninitialized';
try{
i=e.dataTransfer.effectAllowed.toLowerCase()
}catch(e){
}
var o='none';
return r&&t.indexOf(i)>=0?o='copy':n.indexOf(i)>=0?o='move':t.indexOf(i)>=0&&(o='copy'),o
}
var t=e.editor,n=r.createElement('img');
n.src='data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==',s.isOpera&&(n.style.cssText='width:1px;height:1px;position:fixed;top:0;left:0;z-index:2147483647;opacity:0;');
var f=[
'dragWait',
'dragWaitEnd',
'startDrag',
'dragReadyEnd',
'onMouseDrag'
];
f.forEach(function(t){
e[t]=this[t]
},this),t.addEventListener('mousedown',this.onMouseDown.bind(e));
var c=t.container,h,p,d,v,m,g,y=0,b,w,E,S,x;
this.onDragStart=function(e){
if(this.cancelDrag||!c.draggable){
var r=this;
return setTimeout(function(){
r.startSelect(),r.captureMouse(e)
},0),e.preventDefault()
}
m=t.getSelectionRange();
var i=e.dataTransfer;
i.effectAllowed=t.getReadOnly()?'copy':'copyMove',s.isOpera&&(t.container.appendChild(n),n._top=n.offsetTop),i.setDragImage&&i.setDragImage(n,0,0),s.isOpera&&t.container.removeChild(n),i.clearData(),i.setData('Text',t.session.getTextRange()),w=!0,this.setState('drag')
},this.onDragEnd=function(e){
c.draggable=!1,w=!1,this.setState(null);
if(!t.getReadOnly()){
var n=e.dataTransfer.dropEffect;
!b&&n=='move'&&t.session.remove(t.getSelectionRange()),t.renderer.$cursorLayer.setBlinking(!0)
}
this.editor.unsetStyle('ace_dragging')
},this.onDragEnter=function(e){
if(t.getReadOnly()||!M(e.dataTransfer))
return;
return h||k(),y++,e.dataTransfer.dropEffect=b=_(e),i.preventDefault(e)
},this.onDragOver=function(e){
if(t.getReadOnly()||!M(e.dataTransfer))
return;
return h||(k(),y++),A!==null&&(A=null),p=e.clientX,d=e.clientY,e.dataTransfer.dropEffect=b=_(e),i.preventDefault(e)
},this.onDragLeave=function(e){
y--;
if(y<=0&&h)
return L(),b=null,i.preventDefault(e)
},this.onDrop=function(e){
if(!h)
return;
var n=e.dataTransfer;
if(w)
switch(b){
case'move':
m.contains(g.row,g.column)?m={
start:g,
end:g
}:m=t.moveText(m,g);
break;
case'copy':
m=t.moveText(m,g,!0)
}
else{
var r=n.getData('Text');
m={
start:g,
end:t.session.insert(g,r)
},t.focus(),b=null
}
return L(),i.preventDefault(e)
},i.addListener(c,'dragstart',this.onDragStart.bind(e)),i.addListener(c,'dragend',this.onDragEnd.bind(e)),i.addListener(c,'dragenter',this.onDragEnter.bind(e)),i.addListener(c,'dragover',this.onDragOver.bind(e)),i.addListener(c,'dragleave',this.onDragLeave.bind(e)),i.addListener(c,'drop',this.onDrop.bind(e));
var A=null
}
function l(e,t,n,r){
return Math.sqrt(Math.pow(n-e,2)+Math.pow(r-t,2))
}
var r=e('../lib/dom'),i=e('../lib/event'),s=e('../lib/useragent'),o=200,u=200,a=5;
(function(){
this.dragWait=function(){
var e=new Date().getTime()-this.mousedownEvent.time;
e>this.editor.getDragDelay()&&this.startDrag()
},this.dragWaitEnd=function(){
var e=this.editor.container;
e.draggable=!1,this.startSelect(this.mousedownEvent.getDocumentPosition()),this.selectEnd()
},this.dragReadyEnd=function(e){
this.editor.renderer.$cursorLayer.setBlinking(!this.editor.getReadOnly()),this.editor.unsetStyle('ace_dragging'),this.dragWaitEnd()
},this.startDrag=function(){
this.cancelDrag=!1;
var e=this.editor.container;
e.draggable=!0,this.editor.renderer.$cursorLayer.setBlinking(!1),this.editor.setStyle('ace_dragging'),this.setState('dragReady')
},this.onMouseDrag=function(e){
var t=this.editor.container;
if(s.isIE&&this.state=='dragReady'){
var n=l(this.mousedownEvent.x,this.mousedownEvent.y,this.x,this.y);
n>3&&t.dragDrop()
}
if(this.state==='dragWait'){
var n=l(this.mousedownEvent.x,this.mousedownEvent.y,this.x,this.y);
n>0&&(t.draggable=!1,this.startSelect(this.mousedownEvent.getDocumentPosition()))
}
},this.onMouseDown=function(e){
if(!this.$dragEnabled)
return;
this.mousedownEvent=e;
var t=this.editor,n=e.inSelection(),r=e.getButton(),i=e.domEvent.detail||1;
if(i===1&&r===0&&n){
this.mousedownEvent.time=new Date().getTime();
var o=e.domEvent.target||e.domEvent.srcElement;
'unselectable'in o&&(o.unselectable='on');
if(t.getDragDelay()){
if(s.isWebKit){
self.cancelDrag=!0;
var u=t.container;
u.draggable=!0
}
this.setState('dragWait')
}else
this.startDrag();
this.captureMouse(e,this.onMouseDrag.bind(this)),e.defaultPrevented=!0
}
}
}.call(f.prototype),t.DragdropHandler=f)
}),ace.define('ace/config',[
'require',
'exports',
'module',
'ace/lib/lang',
'ace/lib/oop',
'ace/lib/net',
'ace/lib/event_emitter'
],function(e,t,n){
'no use strict';
function f(e){
return e.replace(/-(.)/g,function(e,t){
return t.toUpperCase()
})
}
var r=e('./lib/lang'),i=e('./lib/oop'),s=e('./lib/net'),o=e('./lib/event_emitter').EventEmitter,u=function(){
return this
}(),a={
packaged:!1,
workerPath:null,
modePath:null,
themePath:null,
basePath:'',
suffix:'.js',
$moduleUrls:{}
};
t.get=function(e){
if(!a.hasOwnProperty(e))
throw new Error('Unknown config key: '+e);
return a[e]
},t.set=function(e,t){
if(!a.hasOwnProperty(e))
throw new Error('Unknown config key: '+e);
a[e]=t
},t.all=function(){
return r.copyObject(a)
},i.implement(t,o),t.moduleUrl=function(e,t){
if(a.$moduleUrls[e])
return a.$moduleUrls[e];
var n=e.split('/');
t=t||n[n.length-2]||'';
var r=t=='snippets'?'/':'-',i=n[n.length-1];
if(r=='-'){
var s=new RegExp('^'+t+'[\\-_]|[\\-_]'+t+'$','g');
i=i.replace(s,'')
}
(!i||i==t)&&n.length>1&&(i=n[n.length-2]);
var o=a[t+'Path'];
return o==null?o=a.basePath:r=='/'&&(t=r=''),o&&o.slice(-1)!='/'&&(o+='/'),o+t+r+i+this.get('suffix')
},t.setModuleUrl=function(e,t){
return a.$moduleUrls[e]=t
},t.$loading={},t.loadModule=function(n,r){
var i,o;
Array.isArray(n)&&(o=n[0],n=n[1]);
try{
i=e(n)
}catch(u){
}
if(i&&!t.$loading[n])
return r&&r(i);
t.$loading[n]||(t.$loading[n]=[]),t.$loading[n].push(r);
if(t.$loading[n].length>1)
return;
var a=function(){
e([n],function(e){
t._emit('load.module',{
name:n,
module:e
});
var r=t.$loading[n];
t.$loading[n]=null,r.forEach(function(t){
t&&t(e)
})
})
};
if(!t.get('packaged'))
return a();
s.loadScript(t.moduleUrl(n,o),a)
},t.init=function(){
a.packaged=e.packaged||n.packaged||u.define&&define.packaged;
if(!u.document)
return'';
var r={},i='',s=document.getElementsByTagName('script');
for(var o=0;o<s.length;o++){
var l=s[o],c=l.src||l.getAttribute('src');
if(!c)
continue;
var h=l.attributes;
for(var p=0,d=h.length;p<d;p++){
var v=h[p];
v.name.indexOf('data-ace-')===0&&(r[f(v.name.replace(/^data-ace-/,''))]=v.value)
}
var m=c.match(/^(.*)\/ace(\-\w+)?\.js(\?|$)/);
m&&(i=m[1])
}
i&&(r.base=r.base||i,r.packaged=!0),r.basePath=r.base,r.workerPath=r.workerPath||r.base,r.modePath=r.modePath||r.base,r.themePath=r.themePath||r.base,delete r.base;
for(var g in r)
typeof r[g]!='undefined'&&t.set(g,r[g])
};
var l={
setOptions:function(e){
Object.keys(e).forEach(function(t){
this.setOption(t,e[t])
},this)
},
getOptions:function(e){
var t={};
return e?Array.isArray(e)||(t=e,e=Object.keys(t)):e=Object.keys(this.$options),e.forEach(function(e){
t[e]=this.getOption(e)
},this),t
},
setOption:function(e,t){
if(this['$'+e]===t)
return;
var n=this.$options[e];
if(!n)
return typeof console!='undefined'&&console.warn&&console.warn('misspelled option "'+e+'"'),undefined;
if(n.forwardTo)
return this[n.forwardTo]&&this[n.forwardTo].setOption(e,t);
n.handlesSet||(this['$'+e]=t),n&&n.set&&n.set.call(this,t)
},
getOption:function(e){
var t=this.$options[e];
return t?t.forwardTo?this[t.forwardTo]&&this[t.forwardTo].getOption(e):t&&t.get?t.get.call(this):this['$'+e]:(typeof console!='undefined'&&console.warn&&console.warn('misspelled option "'+e+'"'),undefined)
}
},c={};
t.defineOptions=function(e,t,n){
return e.$options||(c[t]=e.$options={}),Object.keys(n).forEach(function(t){
var r=n[t];
typeof r=='string'&&(r={forwardTo:r}),r.name||(r.name=t),e.$options[r.name]=r,'initialValue'in r&&(e['$'+r.name]=r.initialValue)
}),i.implement(e,l),this
},t.resetOptions=function(e){
Object.keys(e.$options).forEach(function(t){
var n=e.$options[t];
'value'in n&&e.setOption(t,n.value)
})
},t.setDefaultValue=function(e,n,r){
var i=c[e]||(c[e]={});
i[n]&&(i.forwardTo?t.setDefaultValue(i.forwardTo,n,r):i[n].value=r)
},t.setDefaultValues=function(e,n){
Object.keys(n).forEach(function(r){
t.setDefaultValue(e,r,n[r])
})
}
}),ace.define('ace/lib/net',[
'require',
'exports',
'module',
'ace/lib/dom'
],function(e,t,n){
var r=e('./dom');
t.get=function(e,t){
var n=new XMLHttpRequest;
n.open('GET',e,!0),n.onreadystatechange=function(){
n.readyState===4&&t(n.responseText)
},n.send(null)
},t.loadScript=function(e,t){
var n=r.getDocumentHead(),i=document.createElement('script');
i.src=e,n.appendChild(i),i.onload=i.onreadystatechange=function(e,n){
if(n||!i.readyState||i.readyState=='loaded'||i.readyState=='complete')
i=i.onload=i.onreadystatechange=null,n||t()
}
}
}),ace.define('ace/lib/event_emitter',[
'require',
'exports',
'module'
],function(e,t,n){
var r={},i=function(){
this.propagationStopped=!0
},s=function(){
this.defaultPrevented=!0
};
r._emit=r._dispatchEvent=function(e,t){
this._eventRegistry||(this._eventRegistry={}),this._defaultHandlers||(this._defaultHandlers={});
var n=this._eventRegistry[e]||[],r=this._defaultHandlers[e];
if(!n.length&&!r)
return;
if(typeof t!='object'||!t)
t={};
t.type||(t.type=e),t.stopPropagation||(t.stopPropagation=i),t.preventDefault||(t.preventDefault=s),n=n.slice();
for(var o=0;o<n.length;o++){
n[o](t,this);
if(t.propagationStopped)
break
}
if(r&&!t.defaultPrevented)
return r(t,this)
},r._signal=function(e,t){
var n=(this._eventRegistry||{})[e];
if(!n)
return;
n=n.slice();
for(var r=0;r<n.length;r++)
n[r](t,this)
},r.once=function(e,t){
var n=this;
t&&this.addEventListener(e,function r(){
n.removeEventListener(e,r),t.apply(null,arguments)
})
},r.setDefaultHandler=function(e,t){
var n=this._defaultHandlers;
n||(n=this._defaultHandlers={_disabled_:{}});
if(n[e]){
var r=n[e],i=n._disabled_[e];
i||(n._disabled_[e]=i=[]),i.push(r);
var s=i.indexOf(t);
s!=-1&&i.splice(s,1)
}
n[e]=t
},r.removeDefaultHandler=function(e,t){
var n=this._defaultHandlers;
if(!n)
return;
var r=n._disabled_[e];
if(n[e]==t){
var i=n[e];
r&&this.setDefaultHandler(e,r.pop())
}else if(r){
var s=r.indexOf(t);
s!=-1&&r.splice(s,1)
}
},r.on=r.addEventListener=function(e,t,n){
this._eventRegistry=this._eventRegistry||{};
var r=this._eventRegistry[e];
return r||(r=this._eventRegistry[e]=[]),r.indexOf(t)==-1&&r[n?'unshift':'push'](t),t
},r.off=r.removeListener=r.removeEventListener=function(e,t){
this._eventRegistry=this._eventRegistry||{};
var n=this._eventRegistry[e];
if(!n)
return;
var r=n.indexOf(t);
r!==-1&&n.splice(r,1)
},r.removeAllListeners=function(e){
this._eventRegistry&&(this._eventRegistry[e]=[])
},t.EventEmitter=r
}),ace.define('ace/mouse/fold_handler',[
'require',
'exports',
'module'
],function(e,t,n){
function r(e){
e.on('click',function(t){
var n=t.getDocumentPosition(),r=e.session,i=r.getFoldAt(n.row,n.column,1);
i&&(t.getAccelKey()?r.removeFold(i):r.expandFold(i),t.stop())
}),e.on('gutterclick',function(t){
var n=e.renderer.$gutterLayer.getRegion(t);
if(n=='foldWidgets'){
var r=t.getDocumentPosition().row,i=e.session;
i.foldWidgets&&i.foldWidgets[r]&&e.session.onFoldWidgetClick(r,t),e.isFocused()||e.focus(),t.stop()
}
}),e.on('gutterdblclick',function(t){
var n=e.renderer.$gutterLayer.getRegion(t);
if(n=='foldWidgets'){
var r=t.getDocumentPosition().row,i=e.session,s=i.getParentFoldRangeData(r,!0),o=s.range||s.firstRange;
if(o){
r=o.start.row;
var u=i.getFoldAt(r,i.getLine(r).length,1);
u?i.removeFold(u):(i.addFold('...',o),e.renderer.scrollCursorIntoView({
row:o.start.row,
column:0
}))
}
t.stop()
}
})
}
t.FoldHandler=r
}),ace.define('ace/keyboard/keybinding',[
'require',
'exports',
'module',
'ace/lib/keys',
'ace/lib/event'
],function(e,t,n){
var r=e('../lib/keys'),i=e('../lib/event'),s=function(e){
this.$editor=e,this.$data={},this.$handlers=[],this.setDefaultHandler(e.commands)
};
(function(){
this.setDefaultHandler=function(e){
this.removeKeyboardHandler(this.$defaultHandler),this.$defaultHandler=e,this.addKeyboardHandler(e,0),this.$data={editor:this.$editor}
},this.setKeyboardHandler=function(e){
var t=this.$handlers;
if(t[t.length-1]==e)
return;
while(t[t.length-1]&&t[t.length-1]!=this.$defaultHandler)
this.removeKeyboardHandler(t[t.length-1]);
this.addKeyboardHandler(e,1)
},this.addKeyboardHandler=function(e,t){
if(!e)
return;
var n=this.$handlers.indexOf(e);
n!=-1&&this.$handlers.splice(n,1),t==undefined?this.$handlers.push(e):this.$handlers.splice(t,0,e),n==-1&&e.attach&&e.attach(this.$editor)
},this.removeKeyboardHandler=function(e){
var t=this.$handlers.indexOf(e);
return t==-1?!1:(this.$handlers.splice(t,1),e.detach&&e.detach(this.$editor),!0)
},this.getKeyboardHandler=function(){
return this.$handlers[this.$handlers.length-1]
},this.$callKeyboardHandlers=function(e,t,n,r){
var s,o=!1,u=this.$editor.commands;
for(var a=this.$handlers.length;a--;){
s=this.$handlers[a].handleKeyboard(this.$data,e,t,n,r);
if(!s||!s.command)
continue;
s.command=='null'?o=!0:o=u.exec(s.command,this.$editor,s.args,r),o&&r&&e!=-1&&s.passEvent!=1&&s.command.passEvent!=1&&i.stopEvent(r);
if(o)
break
}
return o
},this.onCommandKey=function(e,t,n){
var i=r.keyCodeToString(n);
this.$callKeyboardHandlers(t,i,n,e)
},this.onTextInput=function(e){
var t=this.$callKeyboardHandlers(-1,e);
t||this.$editor.commands.exec('insertstring',this.$editor,e)
}
}.call(s.prototype),t.KeyBinding=s)
}),ace.define('ace/edit_session',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/lib/lang',
'ace/config',
'ace/lib/event_emitter',
'ace/selection',
'ace/mode/text',
'ace/range',
'ace/document',
'ace/background_tokenizer',
'ace/search_highlight',
'ace/edit_session/folding',
'ace/edit_session/bracket_match'
],function(e,t,n){
var r=e('./lib/oop'),i=e('./lib/lang'),s=e('./config'),o=e('./lib/event_emitter').EventEmitter,u=e('./selection').Selection,a=e('./mode/text').Mode,f=e('./range').Range,l=e('./document').Document,c=e('./background_tokenizer').BackgroundTokenizer,h=e('./search_highlight').SearchHighlight,p=function(e,t){
this.$breakpoints=[],this.$decorations=[],this.$frontMarkers={},this.$backMarkers={},this.$markerId=1,this.$undoSelect=!0,this.$foldData=[],this.$foldData.toString=function(){
return this.join('\n')
},this.on('changeFold',this.onChangeFold.bind(this)),this.$onChange=this.onChange.bind(this);
if(typeof e!='object'||!e.getLine)
e=new l(e);
this.setDocument(e),this.selection=new u(this),s.resetOptions(this),this.setMode(t),s._emit('session',this)
};
(function(){
function g(e){
return e<4352?!1:e>=4352&&e<=4447||e>=4515&&e<=4519||e>=4602&&e<=4607||e>=9001&&e<=9002||e>=11904&&e<=11929||e>=11931&&e<=12019||e>=12032&&e<=12245||e>=12272&&e<=12283||e>=12288&&e<=12350||e>=12353&&e<=12438||e>=12441&&e<=12543||e>=12549&&e<=12589||e>=12593&&e<=12686||e>=12688&&e<=12730||e>=12736&&e<=12771||e>=12784&&e<=12830||e>=12832&&e<=12871||e>=12880&&e<=13054||e>=13056&&e<=19903||e>=19968&&e<=42124||e>=42128&&e<=42182||e>=43360&&e<=43388||e>=44032&&e<=55203||e>=55216&&e<=55238||e>=55243&&e<=55291||e>=63744&&e<=64255||e>=65040&&e<=65049||e>=65072&&e<=65106||e>=65108&&e<=65126||e>=65128&&e<=65131||e>=65281&&e<=65376||e>=65504&&e<=65510
}
r.implement(this,o),this.setDocument=function(e){
this.doc&&this.doc.removeListener('change',this.$onChange),this.doc=e,e.on('change',this.$onChange),this.bgTokenizer&&this.bgTokenizer.setDocument(this.getDocument()),this.resetCaches()
},this.getDocument=function(){
return this.doc
},this.$resetRowCache=function(e){
if(!e){
this.$docRowCache=[],this.$screenRowCache=[];
return
}
var t=this.$docRowCache.length,n=this.$getRowCacheIndex(this.$docRowCache,e)+1;
t>n&&(this.$docRowCache.splice(n,t),this.$screenRowCache.splice(n,t))
},this.$getRowCacheIndex=function(e,t){
var n=0,r=e.length-1;
while(n<=r){
var i=n+r>>1,s=e[i];
if(t>s)
n=i+1;
else{
if(!(t<s))
return i;
r=i-1
}
}
return n-1
},this.resetCaches=function(){
this.$modified=!0,this.$wrapData=[],this.$rowLengthCache=[],this.$resetRowCache(0),this.bgTokenizer&&this.bgTokenizer.start(0)
},this.onChangeFold=function(e){
var t=e.data;
this.$resetRowCache(t.start.row)
},this.onChange=function(e){
var t=e.data;
this.$modified=!0,this.$resetRowCache(t.range.start.row);
var n=this.$updateInternalDataOnChange(e);
!this.$fromUndo&&this.$undoManager&&!t.ignore&&(this.$deltasDoc.push(t),n&&n.length!=0&&this.$deltasFold.push({
action:'removeFolds',
folds:n
}),this.$informUndoManager.schedule()),this.bgTokenizer.$updateOnChange(t),this._emit('change',e)
},this.setValue=function(e){
this.doc.setValue(e),this.selection.moveCursorTo(0,0),this.selection.clearSelection(),this.$resetRowCache(0),this.$deltas=[],this.$deltasDoc=[],this.$deltasFold=[],this.getUndoManager().reset()
},this.getValue=this.toString=function(){
return this.doc.getValue()
},this.getSelection=function(){
return this.selection
},this.getState=function(e){
return this.bgTokenizer.getState(e)
},this.getTokens=function(e){
return this.bgTokenizer.getTokens(e)
},this.getTokenAt=function(e,t){
var n=this.bgTokenizer.getTokens(e),r,i=0;
if(t==null)
s=n.length-1,i=this.getLine(e).length;
else
for(var s=0;s<n.length;s++){
i+=n[s].value.length;
if(i>=t)
break
}
return r=n[s],r?(r.index=s,r.start=i-r.value.length,r):null
},this.setUndoManager=function(e){
this.$undoManager=e,this.$deltas=[],this.$deltasDoc=[],this.$deltasFold=[],this.$informUndoManager&&this.$informUndoManager.cancel();
if(e){
var t=this;
this.$syncInformUndoManager=function(){
t.$informUndoManager.cancel(),t.$deltasFold.length&&(t.$deltas.push({
group:'fold',
deltas:t.$deltasFold
}),t.$deltasFold=[]),t.$deltasDoc.length&&(t.$deltas.push({
group:'doc',
deltas:t.$deltasDoc
}),t.$deltasDoc=[]),t.$deltas.length>0&&e.execute({
action:'aceupdate',
args:[
t.$deltas,
t
],
merge:t.mergeUndoDeltas
}),t.mergeUndoDeltas=!1,t.$deltas=[]
},this.$informUndoManager=i.delayedCall(this.$syncInformUndoManager)
}
},this.markUndoGroup=function(){
this.$syncInformUndoManager&&this.$syncInformUndoManager()
},this.$defaultUndoManager={
undo:function(){
},
redo:function(){
},
reset:function(){
}
},this.getUndoManager=function(){
return this.$undoManager||this.$defaultUndoManager
},this.getTabString=function(){
return this.getUseSoftTabs()?i.stringRepeat(' ',this.getTabSize()):'	'
},this.setUseSoftTabs=function(e){
this.setOption('useSoftTabs',e)
},this.getUseSoftTabs=function(){
return this.$useSoftTabs&&!this.$mode.$indentWithTabs
},this.setTabSize=function(e){
this.setOption('tabSize',e)
},this.getTabSize=function(){
return this.$tabSize
},this.isTabStop=function(e){
return this.$useSoftTabs&&e.column%this.$tabSize==0
},this.$overwrite=!1,this.setOverwrite=function(e){
this.setOption('overwrite',e)
},this.getOverwrite=function(){
return this.$overwrite
},this.toggleOverwrite=function(){
this.setOverwrite(!this.$overwrite)
},this.addGutterDecoration=function(e,t){
this.$decorations[e]||(this.$decorations[e]=''),this.$decorations[e]+=' '+t,this._emit('changeBreakpoint',{})
},this.removeGutterDecoration=function(e,t){
this.$decorations[e]=(this.$decorations[e]||'').replace(' '+t,''),this._emit('changeBreakpoint',{})
},this.getBreakpoints=function(){
return this.$breakpoints
},this.setBreakpoints=function(e){
this.$breakpoints=[];
for(var t=0;t<e.length;t++)
this.$breakpoints[e[t]]='ace_breakpoint';
this._emit('changeBreakpoint',{})
},this.clearBreakpoints=function(){
this.$breakpoints=[],this._emit('changeBreakpoint',{})
},this.setBreakpoint=function(e,t){
t===undefined&&(t='ace_breakpoint'),t?this.$breakpoints[e]=t:delete this.$breakpoints[e],this._emit('changeBreakpoint',{})
},this.clearBreakpoint=function(e){
delete this.$breakpoints[e],this._emit('changeBreakpoint',{})
},this.addMarker=function(e,t,n,r){
var i=this.$markerId++,s={
range:e,
type:n||'line',
renderer:typeof n=='function'?n:null,
clazz:t,
inFront:!!r,
id:i
};
return r?(this.$frontMarkers[i]=s,this._emit('changeFrontMarker')):(this.$backMarkers[i]=s,this._emit('changeBackMarker')),i
},this.addDynamicMarker=function(e,t){
if(!e.update)
return;
var n=this.$markerId++;
return e.id=n,e.inFront=!!t,t?(this.$frontMarkers[n]=e,this._emit('changeFrontMarker')):(this.$backMarkers[n]=e,this._emit('changeBackMarker')),e
},this.removeMarker=function(e){
var t=this.$frontMarkers[e]||this.$backMarkers[e];
if(!t)
return;
var n=t.inFront?this.$frontMarkers:this.$backMarkers;
t&&(delete n[e],this._emit(t.inFront?'changeFrontMarker':'changeBackMarker'))
},this.getMarkers=function(e){
return e?this.$frontMarkers:this.$backMarkers
},this.highlight=function(e){
if(!this.$searchHighlight){
var t=new h(null,'ace_selected-word','text');
this.$searchHighlight=this.addDynamicMarker(t)
}
this.$searchHighlight.setRegexp(e)
},this.highlightLines=function(e,t,n,r){
typeof t!='number'&&(n=t,t=e),n||(n='ace_step');
var i=new f(e,0,t,Infinity);
return i.id=this.addMarker(i,n,'fullLine',r),i
},this.setAnnotations=function(e){
this.$annotations=e,this._emit('changeAnnotation',{})
},this.getAnnotations=function(){
return this.$annotations||[]
},this.clearAnnotations=function(){
this.setAnnotations([])
},this.$detectNewLine=function(e){
var t=e.match(/^.*?(\r?\n)/m);
t?this.$autoNewLine=t[1]:this.$autoNewLine='\n'
},this.getWordRange=function(e,t){
var n=this.getLine(e),r=!1;
t>0&&(r=!!n.charAt(t-1).match(this.tokenRe)),r||(r=!!n.charAt(t).match(this.tokenRe));
if(r)
var i=this.tokenRe;
else if(/^\s+$/.test(n.slice(t-1,t+1)))
var i=/\s/;
else
var i=this.nonTokenRe;
var s=t;
if(s>0){
do
s--;
while(s>=0&&n.charAt(s).match(i));
s++
}
var o=t;
while(o<n.length&&n.charAt(o).match(i))
o++;
return new f(e,s,e,o)
},this.getAWordRange=function(e,t){
var n=this.getWordRange(e,t),r=this.getLine(n.end.row);
while(r.charAt(n.end.column).match(/[ \t]/))
n.end.column+=1;
return n
},this.setNewLineMode=function(e){
this.doc.setNewLineMode(e)
},this.getNewLineMode=function(){
return this.doc.getNewLineMode()
},this.setUseWorker=function(e){
this.setOption('useWorker',e)
},this.getUseWorker=function(){
return this.$useWorker
},this.onReloadTokenizer=function(e){
var t=e.data;
this.bgTokenizer.start(t.first),this._emit('tokenizerUpdate',e)
},this.$modes={},this.$mode=null,this.$modeId=null,this.setMode=function(e,t){
if(e&&typeof e=='object'){
if(e.getTokenizer)
return this.$onChangeMode(e);
var n=e,r=n.path
}else
r=e||'ace/mode/text';
this.$modes['ace/mode/text']||(this.$modes['ace/mode/text']=new a);
if(this.$modes[r]&&!n){
this.$onChangeMode(this.$modes[r]),t&&t();
return
}
this.$modeId=r,s.loadModule([
'mode',
r
],function(e){
if(this.$modeId!==r)
return t&&t();
if(this.$modes[r]&&!n)
return this.$onChangeMode(this.$modes[r]);
e&&e.Mode&&(e=new e.Mode(n),n||(this.$modes[r]=e,e.$id=r),this.$onChangeMode(e),t&&t())
}.bind(this)),this.$mode||this.$onChangeMode(this.$modes['ace/mode/text'],!0)
},this.$onChangeMode=function(e,t){
t||(this.$modeId=e.$id);
if(this.$mode===e)
return;
this.$mode=e,this.$stopWorker(),this.$useWorker&&this.$startWorker();
var n=e.getTokenizer();
if(n.addEventListener!==undefined){
var r=this.onReloadTokenizer.bind(this);
n.addEventListener('update',r)
}
if(!this.bgTokenizer){
this.bgTokenizer=new c(n);
var i=this;
this.bgTokenizer.addEventListener('update',function(e){
i._emit('tokenizerUpdate',e)
})
}else
this.bgTokenizer.setTokenizer(n);
this.bgTokenizer.setDocument(this.getDocument()),this.tokenRe=e.tokenRe,this.nonTokenRe=e.nonTokenRe,t||(this.$options.wrapMethod.set.call(this,this.$wrapMethod),this.$setFolding(e.foldingRules),this._emit('changeMode'),this.bgTokenizer.start(0))
},this.$stopWorker=function(){
this.$worker&&this.$worker.terminate(),this.$worker=null
},this.$startWorker=function(){
if(typeof Worker!='undefined'&&!e.noWorker)
try{
this.$worker=this.$mode.createWorker(this)
}catch(t){
console.log('Could not load worker'),console.log(t),this.$worker=null
}
else
this.$worker=null
},this.getMode=function(){
return this.$mode
},this.$scrollTop=0,this.setScrollTop=function(e){
if(this.$scrollTop===e||isNaN(e))
return;
this.$scrollTop=e,this._signal('changeScrollTop',e)
},this.getScrollTop=function(){
return this.$scrollTop
},this.$scrollLeft=0,this.setScrollLeft=function(e){
if(this.$scrollLeft===e||isNaN(e))
return;
this.$scrollLeft=e,this._signal('changeScrollLeft',e)
},this.getScrollLeft=function(){
return this.$scrollLeft
},this.getScreenWidth=function(){
return this.$computeWidth(),this.lineWidgets?Math.max(this.getLineWidgetMaxWidth(),this.screenWidth):this.screenWidth
},this.getLineWidgetMaxWidth=function(){
if(this.lineWidgetsWidth!=null)
return this.lineWidgetsWidth;
var e=0;
return this.lineWidgets.forEach(function(t){
t&&t.screenWidth>e&&(e=t.screenWidth)
}),this.lineWidgetWidth=e
},this.$computeWidth=function(e){
if(this.$modified||e){
this.$modified=!1;
if(this.$useWrapMode)
return this.screenWidth=this.$wrapLimit;
var t=this.doc.getAllLines(),n=this.$rowLengthCache,r=0,i=0,s=this.$foldData[i],o=s?s.start.row:Infinity,u=t.length;
for(var a=0;a<u;a++){
if(a>o){
a=s.end.row+1;
if(a>=u)
break;
s=this.$foldData[i++],o=s?s.start.row:Infinity
}
n[a]==null&&(n[a]=this.$getStringScreenWidth(t[a])[0]),n[a]>r&&(r=n[a])
}
this.screenWidth=r
}
},this.getLine=function(e){
return this.doc.getLine(e)
},this.getLines=function(e,t){
return this.doc.getLines(e,t)
},this.getLength=function(){
return this.doc.getLength()
},this.getTextRange=function(e){
return this.doc.getTextRange(e||this.selection.getRange())
},this.insert=function(e,t){
return this.doc.insert(e,t)
},this.remove=function(e){
return this.doc.remove(e)
},this.undoChanges=function(e,t){
if(!e.length)
return;
this.$fromUndo=!0;
var n=null;
for(var r=e.length-1;r!=-1;r--){
var i=e[r];
i.group=='doc'?(this.doc.revertDeltas(i.deltas),n=this.$getUndoSelection(i.deltas,!0,n)):i.deltas.forEach(function(e){
this.addFolds(e.folds)
},this)
}
return this.$fromUndo=!1,n&&this.$undoSelect&&!t&&this.selection.setSelectionRange(n),n
},this.redoChanges=function(e,t){
if(!e.length)
return;
this.$fromUndo=!0;
var n=null;
for(var r=0;r<e.length;r++){
var i=e[r];
i.group=='doc'&&(this.doc.applyDeltas(i.deltas),n=this.$getUndoSelection(i.deltas,!1,n))
}
return this.$fromUndo=!1,n&&this.$undoSelect&&!t&&this.selection.setSelectionRange(n),n
},this.setUndoSelect=function(e){
this.$undoSelect=e
},this.$getUndoSelection=function(e,t,n){
function r(e){
var n=e.action==='insertText'||e.action==='insertLines';
return t?!n:n
}
var i=e[0],s,o,u=!1;
r(i)?(s=f.fromPoints(i.range.start,i.range.end),u=!0):(s=f.fromPoints(i.range.start,i.range.start),u=!1);
for(var a=1;a<e.length;a++)
i=e[a],r(i)?(o=i.range.start,s.compare(o.row,o.column)==-1&&s.setStart(i.range.start),o=i.range.end,s.compare(o.row,o.column)==1&&s.setEnd(i.range.end),u=!0):(o=i.range.start,s.compare(o.row,o.column)==-1&&(s=f.fromPoints(i.range.start,i.range.start)),u=!1);
if(n!=null){
f.comparePoints(n.start,s.start)==0&&(n.start.column+=s.end.column-s.start.column,n.end.column+=s.end.column-s.start.column);
var l=n.compareRange(s);
l==1?s.setStart(n.start):l==-1&&s.setEnd(n.end)
}
return s
},this.replace=function(e,t){
return this.doc.replace(e,t)
},this.moveText=function(e,t,n){
var r=this.getTextRange(e),i=this.getFoldsInRange(e),s=f.fromPoints(t,t);
if(!n){
this.remove(e);
var o=e.start.row-e.end.row,u=o?-e.end.column:e.start.column-e.end.column;
u&&(s.start.row==e.end.row&&s.start.column>e.end.column&&(s.start.column+=u),s.end.row==e.end.row&&s.end.column>e.end.column&&(s.end.column+=u)),o&&s.start.row>=e.end.row&&(s.start.row+=o,s.end.row+=o)
}
s.end=this.insert(s.start,r);
if(i.length){
var a=e.start,l=s.start,o=l.row-a.row,u=l.column-a.column;
this.addFolds(i.map(function(e){
return e=e.clone(),e.start.row==a.row&&(e.start.column+=u),e.end.row==a.row&&(e.end.column+=u),e.start.row+=o,e.end.row+=o,e
}))
}
return s
},this.indentRows=function(e,t,n){
n=n.replace(/\t/g,this.getTabString());
for(var r=e;r<=t;r++)
this.insert({
row:r,
column:0
},n)
},this.outdentRows=function(e){
var t=e.collapseRows(),n=new f(0,0,0,0),r=this.getTabSize();
for(var i=t.start.row;i<=t.end.row;++i){
var s=this.getLine(i);
n.start.row=i,n.end.row=i;
for(var o=0;o<r;++o)
if(s.charAt(o)!=' ')
break;
o<r&&s.charAt(o)=='	'?(n.start.column=o,n.end.column=o+1):(n.start.column=0,n.end.column=o),this.remove(n)
}
},this.$moveLines=function(e,t,n){
e=this.getRowFoldStart(e),t=this.getRowFoldEnd(t);
if(n<0){
var r=this.getRowFoldStart(e+n);
if(r<0)
return 0;
var i=r-e
}else if(n>0){
var r=this.getRowFoldEnd(t+n);
if(r>this.doc.getLength()-1)
return 0;
var i=r-t
}else{
e=this.$clipRowToDocument(e),t=this.$clipRowToDocument(t);
var i=t-e+1
}
var s=new f(e,0,t,Number.MAX_VALUE),o=this.getFoldsInRange(s).map(function(e){
return e=e.clone(),e.start.row+=i,e.end.row+=i,e
}),u=n==0?this.doc.getLines(e,t):this.doc.removeLines(e,t);
return this.doc.insertLines(e+i,u),o.length&&this.addFolds(o),i
},this.moveLinesUp=function(e,t){
return this.$moveLines(e,t,-1)
},this.moveLinesDown=function(e,t){
return this.$moveLines(e,t,1)
},this.duplicateLines=function(e,t){
return this.$moveLines(e,t,0)
},this.$clipRowToDocument=function(e){
return Math.max(0,Math.min(e,this.doc.getLength()-1))
},this.$clipColumnToRow=function(e,t){
return t<0?0:Math.min(this.doc.getLine(e).length,t)
},this.$clipPositionToDocument=function(e,t){
t=Math.max(0,t);
if(e<0)
e=0,t=0;
else{
var n=this.doc.getLength();
e>=n?(e=n-1,t=this.doc.getLine(n-1).length):t=Math.min(this.doc.getLine(e).length,t)
}
return{
row:e,
column:t
}
},this.$clipRangeToDocument=function(e){
e.start.row<0?(e.start.row=0,e.start.column=0):e.start.column=this.$clipColumnToRow(e.start.row,e.start.column);
var t=this.doc.getLength()-1;
return e.end.row>t?(e.end.row=t,e.end.column=this.doc.getLine(t).length):e.end.column=this.$clipColumnToRow(e.end.row,e.end.column),e
},this.$wrapLimit=80,this.$useWrapMode=!1,this.$wrapLimitRange={
min:null,
max:null
},this.setUseWrapMode=function(e){
if(e!=this.$useWrapMode){
this.$useWrapMode=e,this.$modified=!0,this.$resetRowCache(0);
if(e){
var t=this.getLength();
this.$wrapData=[];
for(var n=0;n<t;n++)
this.$wrapData.push([]);
this.$updateWrapData(0,t-1)
}
this._emit('changeWrapMode')
}
},this.getUseWrapMode=function(){
return this.$useWrapMode
},this.setWrapLimitRange=function(e,t){
if(this.$wrapLimitRange.min!==e||this.$wrapLimitRange.max!==t)
this.$wrapLimitRange={
min:e,
max:t
},this.$modified=!0,this._emit('changeWrapMode')
},this.adjustWrapLimit=function(e,t){
var n=this.$wrapLimitRange;
n.max<0&&(n={
min:t,
max:t
});
var r=this.$constrainWrapLimit(e,n.min,n.max);
return r!=this.$wrapLimit&&r>1?(this.$wrapLimit=r,this.$modified=!0,this.$useWrapMode&&(this.$updateWrapData(0,this.getLength()-1),this.$resetRowCache(0),this._emit('changeWrapLimit')),!0):!1
},this.$constrainWrapLimit=function(e,t,n){
return t&&(e=Math.max(t,e)),n&&(e=Math.min(n,e)),e
},this.getWrapLimit=function(){
return this.$wrapLimit
},this.setWrapLimit=function(e){
this.setWrapLimitRange(e,e)
},this.getWrapLimitRange=function(){
return{
min:this.$wrapLimitRange.min,
max:this.$wrapLimitRange.max
}
},this.$updateInternalDataOnChange=function(e){
var t=this.$useWrapMode,n,r=e.data.action,i=e.data.range.start.row,s=e.data.range.end.row,o=e.data.range.start,u=e.data.range.end,a=null;
r.indexOf('Lines')!=-1?(r=='insertLines'?s=i+e.data.lines.length:s=i,n=e.data.lines?e.data.lines.length:s-i):n=s-i,this.$updating=!0;
if(n!=0)
if(r.indexOf('remove')!=-1){
this[t?'$wrapData':'$rowLengthCache'].splice(i,n);
var f=this.$foldData;
a=this.getFoldsInRange(e.data.range),this.removeFolds(a);
var l=this.getFoldLine(u.row),c=0;
if(l){
l.addRemoveChars(u.row,u.column,o.column-u.column),l.shiftRow(-n);
var h=this.getFoldLine(i);
h&&h!==l&&(h.merge(l),l=h),c=f.indexOf(l)+1
}
for(c;c<f.length;c++){
var l=f[c];
l.start.row>=u.row&&l.shiftRow(-n)
}
s=i
}else{
var p;
if(t){
p=[
i,
0
];
for(var d=0;d<n;d++)
p.push([]);
this.$wrapData.splice.apply(this.$wrapData,p)
}else
p=Array(n),p.unshift(i,0),this.$rowLengthCache.splice.apply(this.$rowLengthCache,p);
var f=this.$foldData,l=this.getFoldLine(i),c=0;
if(l){
var v=l.range.compareInside(o.row,o.column);
v==0?(l=l.split(o.row,o.column),l.shiftRow(n),l.addRemoveChars(s,0,u.column-o.column)):v==-1&&(l.addRemoveChars(i,0,u.column-o.column),l.shiftRow(n)),c=f.indexOf(l)+1
}
for(c;c<f.length;c++){
var l=f[c];
l.start.row>=i&&l.shiftRow(n)
}
}
else{
n=Math.abs(e.data.range.start.column-e.data.range.end.column),r.indexOf('remove')!=-1&&(a=this.getFoldsInRange(e.data.range),this.removeFolds(a),n=-n);
var l=this.getFoldLine(i);
l&&l.addRemoveChars(i,o.column,n)
}
return t&&this.$wrapData.length!=this.doc.getLength()&&console.error('doc.getLength() and $wrapData.length have to be the same!'),this.$updating=!1,t?this.$updateWrapData(i,s):this.$updateRowLengthCache(i,s),a
},this.$updateRowLengthCache=function(e,t,n){
this.$rowLengthCache[e]=null,this.$rowLengthCache[t]=null
},this.$updateWrapData=function(e,t){
var n=this.doc.getAllLines(),r=this.getTabSize(),i=this.$wrapData,s=this.$wrapLimit,o,a,f=e;
t=Math.min(t,n.length-1);
while(f<=t)
a=this.getFoldLine(f,a),a?(o=[],a.walk(function(e,t,r,i){
var s;
if(e!=null){
s=this.$getDisplayTokens(e,o.length),s[0]=u;
for(var a=1;a<s.length;a++)
s[a]=l
}else
s=this.$getDisplayTokens(n[t].substring(i,r),o.length);
o=o.concat(s)
}.bind(this),a.end.row,n[a.end.row].length+1),i[a.start.row]=this.$computeWrapSplits(o,s,r),f=a.end.row+1):(o=this.$getDisplayTokens(n[f]),i[f]=this.$computeWrapSplits(o,s,r),f++)
};
var t=1,n=2,u=3,l=4,p=9,d=10,v=11,m=12;
this.$computeWrapSplits=function(e,t){
function a(t){
var r=e.slice(i,t),o=r.length;
r.join('').replace(/12/g,function(){
o-=1
}).replace(/2/g,function(){
o-=1
}),s+=o,n.push(s),i=t
}
if(e.length==0)
return[];
var n=[],r=e.length,i=0,s=0,o=this.$wrapAsCode;
while(r-i>t){
var f=i+t;
if(e[f-1]>=d&&e[f]>=d){
a(f);
continue
}
if(e[f]==u||e[f]==l){
for(f;f!=i-1;f--)
if(e[f]==u)
break;
if(f>i){
a(f);
continue
}
f=i+t;
for(f;f<e.length;f++)
if(e[f]!=l)
break;
if(f==e.length)
break;
a(f);
continue
}
var c=Math.max(f-(o?10:t-(t>>2)),i-1);
while(f>c&&e[f]<u)
f--;
if(o){
while(f>c&&e[f]<u)
f--;
while(f>c&&e[f]==p)
f--
}else
while(f>c&&e[f]<d)
f--;
if(f>c){
a(++f);
continue
}
f=i+t,a(f)
}
return n
},this.$getDisplayTokens=function(e,r){
var i=[],s;
r=r||0;
for(var o=0;o<e.length;o++){
var u=e.charCodeAt(o);
if(u==9){
s=this.getScreenTabSize(i.length+r),i.push(v);
for(var a=1;a<s;a++)
i.push(m)
}else
u==32?i.push(d):u>39&&u<48||u>57&&u<64?i.push(p):u>=4352&&g(u)?i.push(t,n):i.push(t)
}
return i
},this.$getStringScreenWidth=function(e,t,n){
if(t==0)
return[
0,
0
];
t==null&&(t=Infinity),n=n||0;
var r,i;
for(i=0;i<e.length;i++){
r=e.charCodeAt(i),r==9?n+=this.getScreenTabSize(n):r>=4352&&g(r)?n+=2:n+=1;
if(n>t)
break
}
return[
n,
i
]
},this.lineWidgets=null,this.getRowLength=function(e){
if(this.lineWidgets)
var t=this.lineWidgets[e]&&this.lineWidgets[e].rowCount||0;
else
t=0;
return!this.$useWrapMode||!this.$wrapData[e]?1+t:this.$wrapData[e].length+1+t
},this.getRowLineCount=function(e){
return!this.$useWrapMode||!this.$wrapData[e]?1:this.$wrapData[e].length+1
},this.getScreenLastRowColumn=function(e){
var t=this.screenToDocumentPosition(e,Number.MAX_VALUE);
return this.documentToScreenColumn(t.row,t.column)
},this.getDocumentLastRowColumn=function(e,t){
var n=this.documentToScreenRow(e,t);
return this.getScreenLastRowColumn(n)
},this.getDocumentLastRowColumnPosition=function(e,t){
var n=this.documentToScreenRow(e,t);
return this.screenToDocumentPosition(n,Number.MAX_VALUE/10)
},this.getRowSplitData=function(e){
return this.$useWrapMode?this.$wrapData[e]:undefined
},this.getScreenTabSize=function(e){
return this.$tabSize-e%this.$tabSize
},this.screenToDocumentRow=function(e,t){
return this.screenToDocumentPosition(e,t).row
},this.screenToDocumentColumn=function(e,t){
return this.screenToDocumentPosition(e,t).column
},this.screenToDocumentPosition=function(e,t){
if(e<0)
return{
row:0,
column:0
};
var n,r=0,i=0,s,o=0,u=0,a=this.$screenRowCache,f=this.$getRowCacheIndex(a,e),l=a.length;
if(l&&f>=0)
var o=a[f],r=this.$docRowCache[f],c=e>a[l-1];
else
var c=!l;
var h=this.getLength()-1,p=this.getNextFoldLine(r),d=p?p.start.row:Infinity;
while(o<=e){
u=this.getRowLength(r);
if(o+u>e||r>=h)
break;
o+=u,r++,r>d&&(r=p.end.row+1,p=this.getNextFoldLine(r,p),d=p?p.start.row:Infinity),c&&(this.$docRowCache.push(r),this.$screenRowCache.push(o))
}
if(p&&p.start.row<=r)
n=this.getFoldDisplayLine(p),r=p.start.row;
else{
if(o+u<=e||r>h)
return{
row:h,
column:this.getLine(h).length
};
n=this.getLine(r),p=null
}
if(this.$useWrapMode){
var v=this.$wrapData[r];
if(v){
var m=Math.floor(e-o);
s=v[m],m>0&&v.length&&(i=v[m-1]||v[v.length-1],n=n.substring(i))
}
}
return i+=this.$getStringScreenWidth(n,t)[1],this.$useWrapMode&&i>=s&&(i=s-1),p?p.idxToPosition(i):{
row:r,
column:i
}
},this.documentToScreenPosition=function(e,t){
if(typeof t=='undefined')
var n=this.$clipPositionToDocument(e.row,e.column);
else
n=this.$clipPositionToDocument(e,t);
e=n.row,t=n.column;
var r=0,i=null,s=null;
s=this.getFoldAt(e,t,1),s&&(e=s.start.row,t=s.start.column);
var o,u=0,a=this.$docRowCache,f=this.$getRowCacheIndex(a,e),l=a.length;
if(l&&f>=0)
var u=a[f],r=this.$screenRowCache[f],c=e>a[l-1];
else
var c=!l;
var h=this.getNextFoldLine(u),p=h?h.start.row:Infinity;
while(u<e){
if(u>=p){
o=h.end.row+1;
if(o>e)
break;
h=this.getNextFoldLine(o,h),p=h?h.start.row:Infinity
}else
o=u+1;
r+=this.getRowLength(u),u=o,c&&(this.$docRowCache.push(u),this.$screenRowCache.push(r))
}
var d='';
h&&u>=p?(d=this.getFoldDisplayLine(h,e,t),i=h.start.row):(d=this.getLine(e).substring(0,t),i=e);
if(this.$useWrapMode){
var v=this.$wrapData[i],m=0;
while(d.length>=v[m])
r++,m++;
d=d.substring(v[m-1]||0,d.length)
}
return{
row:r,
column:this.$getStringScreenWidth(d)[0]
}
},this.documentToScreenColumn=function(e,t){
return this.documentToScreenPosition(e,t).column
},this.documentToScreenRow=function(e,t){
return this.documentToScreenPosition(e,t).row
},this.getScreenLength=function(){
var e=0,t=null;
if(!this.$useWrapMode){
e=this.getLength();
var n=this.$foldData;
for(var r=0;r<n.length;r++)
t=n[r],e-=t.end.row-t.start.row
}else{
var i=this.$wrapData.length,s=0,r=0,t=this.$foldData[r++],o=t?t.start.row:Infinity;
while(s<i)
e+=this.$wrapData[s].length+1,s++,s>o&&(s=t.end.row+1,t=this.$foldData[r++],o=t?t.start.row:Infinity)
}
return this.lineWidgets&&(e+=this.$getWidgetScreenLength()),e
}
}.call(p.prototype),e('./edit_session/folding').Folding.call(p.prototype),e('./edit_session/bracket_match').BracketMatch.call(p.prototype),s.defineOptions(p.prototype,'session',{
wrap:{
set:function(e){
!e||e=='off'?e=!1:e=='free'?e=!0:e=='printMargin'?e=-1:typeof e=='string'&&(e=parseInt(e,10)||!1);
if(this.$wrap==e)
return;
if(!e)
this.setUseWrapMode(!1);
else{
var t=typeof e=='number'?e:null;
this.setWrapLimitRange(t,t),this.setUseWrapMode(!0)
}
this.$wrap=e
},
get:function(){
return this.getUseWrapMode()?this.getWrapLimitRange().min||'free':'off'
},
handlesSet:!0
},
wrapMethod:{
set:function(e){
e=e=='auto'?this.$mode.type!='text':e!='text',e!=this.$wrapAsCode&&(this.$wrapAsCode=e,this.$useWrapMode&&(this.$modified=!0,this.$resetRowCache(0),this.$updateWrapData(0,this.getLength()-1)))
},
initialValue:'auto'
},
firstLineNumber:{
set:function(){
this._emit('changeBreakpoint')
},
initialValue:1
},
useWorker:{
set:function(e){
this.$useWorker=e,this.$stopWorker(),e&&this.$startWorker()
},
initialValue:!0
},
useSoftTabs:{initialValue:!0},
tabSize:{
set:function(e){
if(isNaN(e)||this.$tabSize===e)
return;
this.$modified=!0,this.$rowLengthCache=[],this.$tabSize=e,this._emit('changeTabSize')
},
initialValue:4,
handlesSet:!0
},
overwrite:{
set:function(e){
this._emit('changeOverwrite')
},
initialValue:!1
},
newLineMode:{
set:function(e){
this.doc.setNewLineMode(e)
},
get:function(){
return this.doc.getNewLineMode()
},
handlesSet:!0
}
}),t.EditSession=p)
}),ace.define('ace/selection',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/lib/lang',
'ace/lib/event_emitter',
'ace/range'
],function(e,t,n){
var r=e('./lib/oop'),i=e('./lib/lang'),s=e('./lib/event_emitter').EventEmitter,o=e('./range').Range,u=function(e){
this.session=e,this.doc=e.getDocument(),this.clearSelection(),this.lead=this.selectionLead=this.doc.createAnchor(0,0),this.anchor=this.selectionAnchor=this.doc.createAnchor(0,0);
var t=this;
this.lead.on('change',function(e){
t._emit('changeCursor'),t.$isEmpty||t._emit('changeSelection'),!t.$keepDesiredColumnOnChange&&e.old.column!=e.value.column&&(t.$desiredColumn=null)
}),this.selectionAnchor.on('change',function(){
t.$isEmpty||t._emit('changeSelection')
})
};
(function(){
r.implement(this,s),this.isEmpty=function(){
return this.$isEmpty||this.anchor.row==this.lead.row&&this.anchor.column==this.lead.column
},this.isMultiLine=function(){
return this.isEmpty()?!1:this.getRange().isMultiLine()
},this.getCursor=function(){
return this.lead.getPosition()
},this.setSelectionAnchor=function(e,t){
this.anchor.setPosition(e,t),this.$isEmpty&&(this.$isEmpty=!1,this._emit('changeSelection'))
},this.getSelectionAnchor=function(){
return this.$isEmpty?this.getSelectionLead():this.anchor.getPosition()
},this.getSelectionLead=function(){
return this.lead.getPosition()
},this.shiftSelection=function(e){
if(this.$isEmpty){
this.moveCursorTo(this.lead.row,this.lead.column+e);
return
}
var t=this.getSelectionAnchor(),n=this.getSelectionLead(),r=this.isBackwards();
(!r||t.column!==0)&&this.setSelectionAnchor(t.row,t.column+e),(r||n.column!==0)&&this.$moveSelection(function(){
this.moveCursorTo(n.row,n.column+e)
})
},this.isBackwards=function(){
var e=this.anchor,t=this.lead;
return e.row>t.row||e.row==t.row&&e.column>t.column
},this.getRange=function(){
var e=this.anchor,t=this.lead;
return this.isEmpty()?o.fromPoints(t,t):this.isBackwards()?o.fromPoints(t,e):o.fromPoints(e,t)
},this.clearSelection=function(){
this.$isEmpty||(this.$isEmpty=!0,this._emit('changeSelection'))
},this.selectAll=function(){
var e=this.doc.getLength()-1;
this.setSelectionAnchor(0,0),this.moveCursorTo(e,this.doc.getLine(e).length)
},this.setRange=this.setSelectionRange=function(e,t){
t?(this.setSelectionAnchor(e.end.row,e.end.column),this.selectTo(e.start.row,e.start.column)):(this.setSelectionAnchor(e.start.row,e.start.column),this.selectTo(e.end.row,e.end.column)),this.getRange().isEmpty()&&(this.$isEmpty=!0),this.$desiredColumn=null
},this.$moveSelection=function(e){
var t=this.lead;
this.$isEmpty&&this.setSelectionAnchor(t.row,t.column),e.call(this)
},this.selectTo=function(e,t){
this.$moveSelection(function(){
this.moveCursorTo(e,t)
})
},this.selectToPosition=function(e){
this.$moveSelection(function(){
this.moveCursorToPosition(e)
})
},this.selectUp=function(){
this.$moveSelection(this.moveCursorUp)
},this.selectDown=function(){
this.$moveSelection(this.moveCursorDown)
},this.selectRight=function(){
this.$moveSelection(this.moveCursorRight)
},this.selectLeft=function(){
this.$moveSelection(this.moveCursorLeft)
},this.selectLineStart=function(){
this.$moveSelection(this.moveCursorLineStart)
},this.selectLineEnd=function(){
this.$moveSelection(this.moveCursorLineEnd)
},this.selectFileEnd=function(){
this.$moveSelection(this.moveCursorFileEnd)
},this.selectFileStart=function(){
this.$moveSelection(this.moveCursorFileStart)
},this.selectWordRight=function(){
this.$moveSelection(this.moveCursorWordRight)
},this.selectWordLeft=function(){
this.$moveSelection(this.moveCursorWordLeft)
},this.getWordRange=function(e,t){
if(typeof t=='undefined'){
var n=e||this.lead;
e=n.row,t=n.column
}
return this.session.getWordRange(e,t)
},this.selectWord=function(){
this.setSelectionRange(this.getWordRange())
},this.selectAWord=function(){
var e=this.getCursor(),t=this.session.getAWordRange(e.row,e.column);
this.setSelectionRange(t)
},this.getLineRange=function(e,t){
var n=typeof e=='number'?e:this.lead.row,r,i=this.session.getFoldLine(n);
return i?(n=i.start.row,r=i.end.row):r=n,t===!0?new o(n,0,r,this.session.getLine(r).length):new o(n,0,r+1,0)
},this.selectLine=function(){
this.setSelectionRange(this.getLineRange())
},this.moveCursorUp=function(){
this.moveCursorBy(-1,0)
},this.moveCursorDown=function(){
this.moveCursorBy(1,0)
},this.moveCursorLeft=function(){
var e=this.lead.getPosition(),t;
if(t=this.session.getFoldAt(e.row,e.column,-1))
this.moveCursorTo(t.start.row,t.start.column);
else if(e.column==0)
e.row>0&&this.moveCursorTo(e.row-1,this.doc.getLine(e.row-1).length);
else{
var n=this.session.getTabSize();
this.session.isTabStop(e)&&this.doc.getLine(e.row).slice(e.column-n,e.column).split(' ').length-1==n?this.moveCursorBy(0,-n):this.moveCursorBy(0,-1)
}
},this.moveCursorRight=function(){
var e=this.lead.getPosition(),t;
if(t=this.session.getFoldAt(e.row,e.column,1))
this.moveCursorTo(t.end.row,t.end.column);
else if(this.lead.column==this.doc.getLine(this.lead.row).length)
this.lead.row<this.doc.getLength()-1&&this.moveCursorTo(this.lead.row+1,0);
else{
var n=this.session.getTabSize(),e=this.lead;
this.session.isTabStop(e)&&this.doc.getLine(e.row).slice(e.column,e.column+n).split(' ').length-1==n?this.moveCursorBy(0,n):this.moveCursorBy(0,1)
}
},this.moveCursorLineStart=function(){
var e=this.lead.row,t=this.lead.column,n=this.session.documentToScreenRow(e,t),r=this.session.screenToDocumentPosition(n,0),i=this.session.getDisplayLine(e,null,r.row,r.column),s=i.match(/^\s*/);
s[0].length!=t&&!this.session.$useEmacsStyleLineStart&&(r.column+=s[0].length),this.moveCursorToPosition(r)
},this.moveCursorLineEnd=function(){
var e=this.lead,t=this.session.getDocumentLastRowColumnPosition(e.row,e.column);
if(this.lead.column==t.column){
var n=this.session.getLine(t.row);
if(t.column==n.length){
var r=n.search(/\s+$/);
r>0&&(t.column=r)
}
}
this.moveCursorTo(t.row,t.column)
},this.moveCursorFileEnd=function(){
var e=this.doc.getLength()-1,t=this.doc.getLine(e).length;
this.moveCursorTo(e,t)
},this.moveCursorFileStart=function(){
this.moveCursorTo(0,0)
},this.moveCursorLongWordRight=function(){
var e=this.lead.row,t=this.lead.column,n=this.doc.getLine(e),r=n.substring(t),i;
this.session.nonTokenRe.lastIndex=0,this.session.tokenRe.lastIndex=0;
var s=this.session.getFoldAt(e,t,1);
if(s){
this.moveCursorTo(s.end.row,s.end.column);
return
}
if(i=this.session.nonTokenRe.exec(r))
t+=this.session.nonTokenRe.lastIndex,this.session.nonTokenRe.lastIndex=0,r=n.substring(t);
if(t>=n.length){
this.moveCursorTo(e,n.length),this.moveCursorRight(),e<this.doc.getLength()-1&&this.moveCursorWordRight();
return
}
if(i=this.session.tokenRe.exec(r))
t+=this.session.tokenRe.lastIndex,this.session.tokenRe.lastIndex=0;
this.moveCursorTo(e,t)
},this.moveCursorLongWordLeft=function(){
var e=this.lead.row,t=this.lead.column,n;
if(n=this.session.getFoldAt(e,t,-1)){
this.moveCursorTo(n.start.row,n.start.column);
return
}
var r=this.session.getFoldStringAt(e,t,-1);
r==null&&(r=this.doc.getLine(e).substring(0,t));
var s=i.stringReverse(r),o;
this.session.nonTokenRe.lastIndex=0,this.session.tokenRe.lastIndex=0;
if(o=this.session.nonTokenRe.exec(s))
t-=this.session.nonTokenRe.lastIndex,s=s.slice(this.session.nonTokenRe.lastIndex),this.session.nonTokenRe.lastIndex=0;
if(t<=0){
this.moveCursorTo(e,0),this.moveCursorLeft(),e>0&&this.moveCursorWordLeft();
return
}
if(o=this.session.tokenRe.exec(s))
t-=this.session.tokenRe.lastIndex,this.session.tokenRe.lastIndex=0;
this.moveCursorTo(e,t)
},this.$shortWordEndIndex=function(e){
var t,n=0,r,i=/\s/,s=this.session.tokenRe;
s.lastIndex=0;
if(t=this.session.tokenRe.exec(e))
n=this.session.tokenRe.lastIndex;
else{
while((r=e[n])&&i.test(r))
n++;
if(n<1){
s.lastIndex=0;
while((r=e[n])&&!s.test(r)){
s.lastIndex=0,n++;
if(i.test(r)){
if(n>2){
n--;
break
}
while((r=e[n])&&i.test(r))
n++;
if(n>2)
break
}
}
}
}
return s.lastIndex=0,n
},this.moveCursorShortWordRight=function(){
var e=this.lead.row,t=this.lead.column,n=this.doc.getLine(e),r=n.substring(t),i=this.session.getFoldAt(e,t,1);
if(i)
return this.moveCursorTo(i.end.row,i.end.column);
if(t==n.length){
var s=this.doc.getLength();
do
e++,r=this.doc.getLine(e);
while(e<s&&/^\s*$/.test(r));
/^\s+/.test(r)||(r=''),t=0
}
var o=this.$shortWordEndIndex(r);
this.moveCursorTo(e,t+o)
},this.moveCursorShortWordLeft=function(){
var e=this.lead.row,t=this.lead.column,n;
if(n=this.session.getFoldAt(e,t,-1))
return this.moveCursorTo(n.start.row,n.start.column);
var r=this.session.getLine(e).substring(0,t);
if(t==0){
do
e--,r=this.doc.getLine(e);
while(e>0&&/^\s*$/.test(r));
t=r.length,/\s+$/.test(r)||(r='')
}
var s=i.stringReverse(r),o=this.$shortWordEndIndex(s);
return this.moveCursorTo(e,t-o)
},this.moveCursorWordRight=function(){
this.session.$selectLongWords?this.moveCursorLongWordRight():this.moveCursorShortWordRight()
},this.moveCursorWordLeft=function(){
this.session.$selectLongWords?this.moveCursorLongWordLeft():this.moveCursorShortWordLeft()
},this.moveCursorBy=function(e,t){
var n=this.session.documentToScreenPosition(this.lead.row,this.lead.column);
t===0&&(this.$desiredColumn?n.column=this.$desiredColumn:this.$desiredColumn=n.column);
var r=this.session.screenToDocumentPosition(n.row+e,n.column);
e!==0&&t===0&&r.row===this.lead.row&&r.column===this.lead.column&&this.session.lineWidgets&&this.session.lineWidgets[r.row]&&r.row++,this.moveCursorTo(r.row,r.column+t,t===0)
},this.moveCursorToPosition=function(e){
this.moveCursorTo(e.row,e.column)
},this.moveCursorTo=function(e,t,n){
var r=this.session.getFoldAt(e,t,1);
r&&(e=r.start.row,t=r.start.column),this.$keepDesiredColumnOnChange=!0,this.lead.setPosition(e,t),this.$keepDesiredColumnOnChange=!1,n||(this.$desiredColumn=null)
},this.moveCursorToScreen=function(e,t,n){
var r=this.session.screenToDocumentPosition(e,t);
this.moveCursorTo(r.row,r.column,n)
},this.detach=function(){
this.lead.detach(),this.anchor.detach(),this.session=this.doc=null
},this.fromOrientedRange=function(e){
this.setSelectionRange(e,e.cursor==e.start),this.$desiredColumn=e.desiredColumn||this.$desiredColumn
},this.toOrientedRange=function(e){
var t=this.getRange();
return e?(e.start.column=t.start.column,e.start.row=t.start.row,e.end.column=t.end.column,e.end.row=t.end.row):e=t,e.cursor=this.isBackwards()?e.start:e.end,e.desiredColumn=this.$desiredColumn,e
},this.toJSON=function(){
if(this.rangeCount)
var e=this.ranges.map(function(e){
var t=e.clone();
return t.isBackwards=e.cursor==e.start,t
});
else{
var e=this.getRange();
e.isBackwards=this.isBackwards()
}
return e
},this.fromJSON=function(e){
if(e.start==undefined){
if(this.rangeList){
this.toSingleRange(e[0]);
for(var t=e.length;t--;){
var n=o.fromPoints(e[t].start,e[t].end);
e.isBackwards&&(n.cursor=n.start),this.addRange(n,!0)
}
return
}
e=e[0]
}
this.rangeList&&this.toSingleRange(e),this.setSelectionRange(e,e.isBackwards)
},this.isEqual=function(e){
if((e.length||this.rangeCount)&&e.length!=this.rangeCount)
return!1;
if(!e.length||!this.ranges)
return this.getRange().isEqual(e);
for(var t=this.ranges.length;t--;)
if(!this.ranges[t].isEqual(e[t]))
return!1;
return!0
}
}.call(u.prototype),t.Selection=u)
}),ace.define('ace/range',[
'require',
'exports',
'module'
],function(e,t,n){
var r=function(e,t){
return e.row-t.row||e.column-t.column
},i=function(e,t,n,r){
this.start={
row:e,
column:t
},this.end={
row:n,
column:r
}
};
(function(){
this.isEqual=function(e){
return this.start.row===e.start.row&&this.end.row===e.end.row&&this.start.column===e.start.column&&this.end.column===e.end.column
},this.toString=function(){
return'Range: ['+this.start.row+'/'+this.start.column+'] -> ['+this.end.row+'/'+this.end.column+']'
},this.contains=function(e,t){
return this.compare(e,t)==0
},this.compareRange=function(e){
var t,n=e.end,r=e.start;
return t=this.compare(n.row,n.column),t==1?(t=this.compare(r.row,r.column),t==1?2:t==0?1:0):t==-1?-2:(t=this.compare(r.row,r.column),t==-1?-1:t==1?42:0)
},this.comparePoint=function(e){
return this.compare(e.row,e.column)
},this.containsRange=function(e){
return this.comparePoint(e.start)==0&&this.comparePoint(e.end)==0
},this.intersects=function(e){
var t=this.compareRange(e);
return t==-1||t==0||t==1
},this.isEnd=function(e,t){
return this.end.row==e&&this.end.column==t
},this.isStart=function(e,t){
return this.start.row==e&&this.start.column==t
},this.setStart=function(e,t){
typeof e=='object'?(this.start.column=e.column,this.start.row=e.row):(this.start.row=e,this.start.column=t)
},this.setEnd=function(e,t){
typeof e=='object'?(this.end.column=e.column,this.end.row=e.row):(this.end.row=e,this.end.column=t)
},this.inside=function(e,t){
return this.compare(e,t)==0?this.isEnd(e,t)||this.isStart(e,t)?!1:!0:!1
},this.insideStart=function(e,t){
return this.compare(e,t)==0?this.isEnd(e,t)?!1:!0:!1
},this.insideEnd=function(e,t){
return this.compare(e,t)==0?this.isStart(e,t)?!1:!0:!1
},this.compare=function(e,t){
return!this.isMultiLine()&&e===this.start.row?t<this.start.column?-1:t>this.end.column?1:0:e<this.start.row?-1:e>this.end.row?1:this.start.row===e?t>=this.start.column?0:-1:this.end.row===e?t<=this.end.column?0:1:0
},this.compareStart=function(e,t){
return this.start.row==e&&this.start.column==t?-1:this.compare(e,t)
},this.compareEnd=function(e,t){
return this.end.row==e&&this.end.column==t?1:this.compare(e,t)
},this.compareInside=function(e,t){
return this.end.row==e&&this.end.column==t?1:this.start.row==e&&this.start.column==t?-1:this.compare(e,t)
},this.clipRows=function(e,t){
if(this.end.row>t)
var n={
row:t+1,
column:0
};
else if(this.end.row<e)
var n={
row:e,
column:0
};
if(this.start.row>t)
var r={
row:t+1,
column:0
};
else if(this.start.row<e)
var r={
row:e,
column:0
};
return i.fromPoints(r||this.start,n||this.end)
},this.extend=function(e,t){
var n=this.compare(e,t);
if(n==0)
return this;
if(n==-1)
var r={
row:e,
column:t
};
else
var s={
row:e,
column:t
};
return i.fromPoints(r||this.start,s||this.end)
},this.isEmpty=function(){
return this.start.row===this.end.row&&this.start.column===this.end.column
},this.isMultiLine=function(){
return this.start.row!==this.end.row
},this.clone=function(){
return i.fromPoints(this.start,this.end)
},this.collapseRows=function(){
return this.end.column==0?new i(this.start.row,0,Math.max(this.start.row,this.end.row-1),0):new i(this.start.row,0,this.end.row,0)
},this.toScreenRange=function(e){
var t=e.documentToScreenPosition(this.start),n=e.documentToScreenPosition(this.end);
return new i(t.row,t.column,n.row,n.column)
},this.moveBy=function(e,t){
this.start.row+=e,this.start.column+=t,this.end.row+=e,this.end.column+=t
}
}.call(i.prototype),i.fromPoints=function(e,t){
return new i(e.row,e.column,t.row,t.column)
},i.comparePoints=r,i.comparePoints=function(e,t){
return e.row-t.row||e.column-t.column
},t.Range=i)
}),ace.define('ace/mode/text',[
'require',
'exports',
'module',
'ace/tokenizer',
'ace/mode/text_highlight_rules',
'ace/mode/behaviour',
'ace/unicode',
'ace/lib/lang',
'ace/token_iterator',
'ace/range'
],function(e,t,n){
var r=e('../tokenizer').Tokenizer,i=e('./text_highlight_rules').TextHighlightRules,s=e('./behaviour').Behaviour,o=e('../unicode'),u=e('../lib/lang'),a=e('../token_iterator').TokenIterator,f=e('../range').Range,l=function(){
this.HighlightRules=i,this.$behaviour=new s
};
(function(){
this.tokenRe=new RegExp('^['+o.packages.L+o.packages.Mn+o.packages.Mc+o.packages.Nd+o.packages.Pc+'\\$_]+','g'),this.nonTokenRe=new RegExp('^(?:[^'+o.packages.L+o.packages.Mn+o.packages.Mc+o.packages.Nd+o.packages.Pc+'\\$_]|s])+','g'),this.getTokenizer=function(){
return this.$tokenizer||(this.$highlightRules=new this.HighlightRules,this.$tokenizer=new r(this.$highlightRules.getRules())),this.$tokenizer
},this.lineCommentStart='',this.blockComment='',this.toggleCommentLines=function(e,t,n,r){
function w(e){
for(var t=n;t<=r;t++)
e(i.getLine(t),t)
}
var i=t.doc,s=!0,o=!0,a=Infinity,f=t.getTabSize(),l=!1;
if(!this.lineCommentStart){
if(!this.blockComment)
return!1;
var c=this.blockComment.start,h=this.blockComment.end,p=new RegExp('^(\\s*)(?:'+u.escapeRegExp(c)+')'),d=new RegExp('(?:'+u.escapeRegExp(h)+')\\s*$'),v=function(e,t){
if(g(e,t))
return;
if(!s||/\S/.test(e))
i.insertInLine({
row:t,
column:e.length
},h),i.insertInLine({
row:t,
column:a
},c)
},m=function(e,t){
var n;
(n=e.match(d))&&i.removeInLine(t,e.length-n[0].length,e.length),(n=e.match(p))&&i.removeInLine(t,n[1].length,n[0].length)
},g=function(e,n){
if(p.test(e))
return!0;
var r=t.getTokens(n);
for(var i=0;i<r.length;i++)
if(r[i].type==='comment')
return!0
}
}else{
if(Array.isArray(this.lineCommentStart))
var p=this.lineCommentStart.map(u.escapeRegExp).join('|'),c=this.lineCommentStart[0];
else
var p=u.escapeRegExp(this.lineCommentStart),c=this.lineCommentStart;
p=new RegExp('^(\\s*)(?:'+p+') ?'),l=t.getUseSoftTabs();
var m=function(e,t){
var n=e.match(p);
if(!n)
return;
var r=n[1].length,s=n[0].length;
!b(e,r,s)&&n[0][s-1]==' '&&s--,i.removeInLine(t,r,s)
},y=c+' ',v=function(e,t){
if(!s||/\S/.test(e))
b(e,a,a)?i.insertInLine({
row:t,
column:a
},y):i.insertInLine({
row:t,
column:a
},c)
},g=function(e,t){
return p.test(e)
},b=function(e,t,n){
var r=0;
while(t--&&e.charAt(t)==' ')
r++;
if(r%f!=0)
return!1;
var r=0;
while(e.charAt(n++)==' ')
r++;
return f>2?r%f!=f-1:r%f==0
}
}
var E=Infinity;
w(function(e,t){
var n=e.search(/\S/);
n!==-1?(n<a&&(a=n),o&&!g(e,t)&&(o=!1)):E>e.length&&(E=e.length)
}),a==Infinity&&(a=E,s=!1,o=!1),l&&a%f!=0&&(a=Math.floor(a/f)*f),w(o?m:v)
},this.toggleBlockComment=function(e,t,n,r){
var i=this.blockComment;
if(!i)
return;
!i.start&&i[0]&&(i=i[0]);
var s=new a(t,r.row,r.column),o=s.getCurrentToken(),u=t.selection,l=t.selection.toOrientedRange(),c,h;
if(o&&/comment/.test(o.type)){
var p,d;
while(o&&/comment/.test(o.type)){
var v=o.value.indexOf(i.start);
if(v!=-1){
var m=s.getCurrentTokenRow(),g=s.getCurrentTokenColumn()+v;
p=new f(m,g,m,g+i.start.length);
break
}
o=s.stepBackward()
}
var s=new a(t,r.row,r.column),o=s.getCurrentToken();
while(o&&/comment/.test(o.type)){
var v=o.value.indexOf(i.end);
if(v!=-1){
var m=s.getCurrentTokenRow(),g=s.getCurrentTokenColumn()+v;
d=new f(m,g,m,g+i.end.length);
break
}
o=s.stepForward()
}
d&&t.remove(d),p&&(t.remove(p),c=p.start.row,h=-i.start.length)
}else
h=i.start.length,c=n.start.row,t.insert(n.end,i.end),t.insert(n.start,i.start);
l.start.row==c&&(l.start.column+=h),l.end.row==c&&(l.end.column+=h),t.selection.fromOrientedRange(l)
},this.getNextLineIndent=function(e,t,n){
return this.$getIndent(t)
},this.checkOutdent=function(e,t,n){
return!1
},this.autoOutdent=function(e,t,n){
},this.$getIndent=function(e){
return e.match(/^\s*/)[0]
},this.createWorker=function(e){
return null
},this.createModeDelegates=function(e){
this.$embeds=[],this.$modes={};
for(var t in e)
e[t]&&(this.$embeds.push(t),this.$modes[t]=new e[t]);
var n=[
'toggleCommentLines',
'getNextLineIndent',
'checkOutdent',
'autoOutdent',
'transformAction',
'getCompletions'
];
for(var t=0;t<n.length;t++)
(function(e){
var r=n[t],i=e[r];
e[n[t]]=function(){
return this.$delegator(r,arguments,i)
}
}(this))
},this.$delegator=function(e,t,n){
var r=t[0];
typeof r!='string'&&(r=r[0]);
for(var i=0;i<this.$embeds.length;i++){
if(!this.$modes[this.$embeds[i]])
continue;
var s=r.split(this.$embeds[i]);
if(!s[0]&&s[1]){
t[0]=s[1];
var o=this.$modes[this.$embeds[i]];
return o[e].apply(o,t)
}
}
var u=n.apply(this,t);
return n?u:undefined
},this.transformAction=function(e,t,n,r,i){
if(this.$behaviour){
var s=this.$behaviour.getBehaviours();
for(var o in s)
if(s[o][t]){
var u=s[o][t].apply(this,arguments);
if(u)
return u
}
}
},this.getKeywords=function(e){
if(!this.completionKeywords){
var t=this.$tokenizer.rules,n=[];
for(var r in t){
var i=t[r];
for(var s=0,o=i.length;s<o;s++)
if(typeof i[s].token=='string')
/keyword|support|storage/.test(i[s].token)&&n.push(i[s].regex);
else if(typeof i[s].token=='object')
for(var u=0,a=i[s].token.length;u<a;u++)
if(/keyword|support|storage/.test(i[s].token[u])){
var r=i[s].regex.match(/\(.+?\)/g)[u];
n.push(r.substr(1,r.length-2))
}
}
this.completionKeywords=n
}
return e?n.concat(this.$keywordList||[]):this.$keywordList
},this.$createKeywordList=function(){
return this.$highlightRules||this.getTokenizer(),this.$keywordList=this.$highlightRules.$keywordList||[]
},this.getCompletions=function(e,t,n,r){
var i=this.$keywordList||this.$createKeywordList();
return i.map(function(e){
return{
name:e,
value:e,
score:0,
meta:'keyword'
}
})
}
}.call(l.prototype),t.Mode=l)
}),ace.define('ace/tokenizer',[
'require',
'exports',
'module'
],function(e,t,n){
var r=1000,i=function(e){
this.states=e,this.regExps={},this.matchMappings={};
for(var t in this.states){
var n=this.states[t],r=[],i=0,s=this.matchMappings[t]={defaultToken:'text'},o='g',u=[];
for(var a=0;a<n.length;a++){
var f=n[a];
f.defaultToken&&(s.defaultToken=f.defaultToken),f.caseInsensitive&&(o='gi');
if(f.regex==null)
continue;
f.regex instanceof RegExp&&(f.regex=f.regex.toString().slice(1,-1));
var l=f.regex,c=new RegExp('(?:('+l+')|(.))').exec('a').length-2;
if(Array.isArray(f.token))
if(f.token.length==1||c==1)
f.token=f.token[0];
else{
if(c-1!=f.token.length)
throw new Error('number of classes and regexp groups in \''+f.token+'\'\n\''+f.regex+'\' doesn\'t match\n'+(c-1)+'!='+f.token.length);
f.tokenArray=f.token,f.token=null,f.onMatch=this.$arrayTokens
}
else
typeof f.token=='function'&&!f.onMatch&&(c>1?f.onMatch=this.$applyToken:f.onMatch=f.token);
c>1&&(/\\\d/.test(f.regex)?l=f.regex.replace(/\\([0-9]+)/g,function(e,t){
return'\\'+(parseInt(t,10)+i+1)
}):(c=1,l=this.removeCapturingGroups(f.regex)),!f.splitRegex&&typeof f.token!='string'&&u.push(f)),s[i]=a,i+=c,r.push(l),f.onMatch||(f.onMatch=null),f.__proto__=null
}
u.forEach(function(e){
e.splitRegex=this.createSplitterRegexp(e.regex,o)
},this),this.regExps[t]=new RegExp('('+r.join(')|(')+')|($)',o)
}
};
(function(){
this.$setMaxTokenCount=function(e){
r=e|0
},this.$applyToken=function(e){
var t=this.splitRegex.exec(e).slice(1),n=this.token.apply(this,t);
if(typeof n=='string')
return[{
type:n,
value:e
}];
var r=[];
for(var i=0,s=n.length;i<s;i++)
t[i]&&(r[r.length]={
type:n[i],
value:t[i]
});
return r
},this.$arrayTokens=function(e){
if(!e)
return[];
var t=this.splitRegex.exec(e);
if(!t)
return'text';
var n=[],r=this.tokenArray;
for(var i=0,s=r.length;i<s;i++)
t[i+1]&&(n[n.length]={
type:r[i],
value:t[i+1]
});
return n
},this.removeCapturingGroups=function(e){
var t=e.replace(/\[(?:\\.|[^\]])*?\]|\\.|\(\?[:=!]|(\()/g,function(e,t){
return t?'(?:':e
});
return t
},this.createSplitterRegexp=function(e,t){
if(e.indexOf('(?=')!=-1){
var n=0,r=!1,i={};
e.replace(/(\\.)|(\((?:\?[=!])?)|(\))|([\[\]])/g,function(e,t,s,o,u,a){
return r?r=u!=']':u?r=!0:o?(n==i.stack&&(i.end=a+1,i.stack=-1),n--):s&&(n++,s.length!=1&&(i.stack=n,i.start=a)),e
}),i.end!=null&&/^\)*$/.test(e.substr(i.end))&&(e=e.substring(0,i.start)+e.substr(i.end))
}
return new RegExp(e,(t||'').replace('g',''))
},this.getLineTokens=function(e,t){
if(t&&typeof t!='string'){
var n=t.slice(0);
t=n[0]
}else
var n=[];
var i=t||'start',s=this.states[i],o=this.matchMappings[i],u=this.regExps[i];
u.lastIndex=0;
var a,f=[],l=0,c={
type:null,
value:''
};
while(a=u.exec(e)){
var h=o.defaultToken,p=null,d=a[0],v=u.lastIndex;
if(v-d.length>l){
var m=e.substring(l,v-d.length);
c.type==h?c.value+=m:(c.type&&f.push(c),c={
type:h,
value:m
})
}
for(var g=0;g<a.length-2;g++){
if(a[g+1]===undefined)
continue;
p=s[o[g]],p.onMatch?h=p.onMatch(d,i,n):h=p.token,p.next&&(typeof p.next=='string'?i=p.next:i=p.next(i,n),s=this.states[i],s||(window.console&&console.error&&console.error(i,'doesn\'t exist'),i='start',s=this.states[i]),o=this.matchMappings[i],l=v,u=this.regExps[i],u.lastIndex=v);
break
}
if(d)
if(typeof h=='string')
!!p&&p.merge===!1||c.type!==h?(c.type&&f.push(c),c={
type:h,
value:d
}):c.value+=d;
else if(h){
c.type&&f.push(c),c={
type:null,
value:''
};
for(var g=0;g<h.length;g++)
f.push(h[g])
}
if(l==e.length)
break;
l=v;
if(f.length>r){
while(l<e.length)
c.type&&f.push(c),c={
value:e.substring(l,l+=2000),
type:'overflow'
};
i='start',n=[];
break
}
}
return c.type&&f.push(c),n.length>1&&n[0]!==i&&n.unshift(i),{
tokens:f,
state:n.length?n:i
}
}
}.call(i.prototype),t.Tokenizer=i)
}),ace.define('ace/mode/text_highlight_rules',[
'require',
'exports',
'module',
'ace/lib/lang'
],function(e,t,n){
var r=e('../lib/lang'),i=function(){
this.$rules={
start:[
{
token:'empty_line',
regex:'^$'
},
{defaultToken:'text'}
]
}
};
(function(){
this.addRules=function(e,t){
if(!t){
for(var n in e)
this.$rules[n]=e[n];
return
}
for(var n in e){
var r=e[n];
for(var i=0;i<r.length;i++){
var s=r[i];
s.next&&(typeof s.next!='string'?s.nextState&&s.nextState.indexOf(t)!==0&&(s.nextState=t+s.nextState):s.next.indexOf(t)!==0&&(s.next=t+s.next))
}
this.$rules[t+n]=r
}
},this.getRules=function(){
return this.$rules
},this.embedRules=function(e,t,n,i,s){
var o=new e().getRules();
if(i)
for(var u=0;u<i.length;u++)
i[u]=t+i[u];
else{
i=[];
for(var a in o)
i.push(t+a)
}
this.addRules(o,t);
if(n){
var f=Array.prototype[s?'push':'unshift'];
for(var u=0;u<i.length;u++)
f.apply(this.$rules[i[u]],r.deepCopy(n))
}
this.$embeds||(this.$embeds=[]),this.$embeds.push(t)
},this.getEmbeds=function(){
return this.$embeds
};
var e=function(e,t){
return e!='start'&&t.unshift(this.nextState,e),this.nextState
},t=function(e,t){
return t[0]!==e?'start':(t.shift(),t.shift())
};
this.normalizeRules=function(){
function i(s){
var o=r[s];
o.processed=!0;
for(var u=0;u<o.length;u++){
var a=o[u];
!a.regex&&a.start&&(a.regex=a.start,a.next||(a.next=[]),a.next.push({defaultToken:a.token},{
token:a.token+'.end',
regex:a.end||a.start,
next:'pop'
}),a.token=a.token+'.start',a.push=!0);
var f=a.next||a.push;
if(f&&Array.isArray(f)){
var l=a.stateName;
l||(l=a.token,typeof l!='string'&&(l=l[0]||''),r[l]&&(l+=n++)),r[l]=f,a.next=l,i(l)
}else
f=='pop'&&(a.next=t);
a.push&&(a.nextState=a.next||a.push,a.next=e,delete a.push);
if(a.rules)
for(var c in a.rules)
r[c]?r[c].push&&r[c].push.apply(r[c],a.rules[c]):r[c]=a.rules[c];
if(a.include||typeof a=='string')
var h=a.include||a,p=r[h];
else
Array.isArray(a)&&(p=a);
if(p){
var d=[
u,
1
].concat(p);
a.noEscape&&(d=d.filter(function(e){
return!e.next
})),o.splice.apply(o,d),u--,p=null
}
a.keywordMap&&(a.token=this.createKeywordMapper(a.keywordMap,a.defaultToken||'text',a.caseInsensitive),delete a.defaultToken)
}
}
var n=0,r=this.$rules;
Object.keys(r).forEach(i,this)
},this.createKeywordMapper=function(e,t,n,r){
var i=Object.create(null);
return Object.keys(e).forEach(function(t){
var s=e[t];
n&&(s=s.toLowerCase());
var o=s.split(r||'|');
for(var u=o.length;u--;)
i[o[u]]=t
}),Object.getPrototypeOf(i)&&(i.__proto__=null),this.$keywordList=Object.keys(i),e=null,n?function(e){
return i[e.toLowerCase()]||t
}:function(e){
return i[e]||t
}
},this.getKeywords=function(){
return this.$keywords
}
}.call(i.prototype),t.TextHighlightRules=i)
}),ace.define('ace/mode/behaviour',[
'require',
'exports',
'module'
],function(e,t,n){
var r=function(){
this.$behaviours={}
};
(function(){
this.add=function(e,t,n){
switch(undefined){
case this.$behaviours:
this.$behaviours={};
case this.$behaviours[e]:
this.$behaviours[e]={}
}
this.$behaviours[e][t]=n
},this.addBehaviours=function(e){
for(var t in e)
for(var n in e[t])
this.add(t,n,e[t][n])
},this.remove=function(e){
this.$behaviours&&this.$behaviours[e]&&delete this.$behaviours[e]
},this.inherit=function(e,t){
if(typeof e=='function')
var n=new e().getBehaviours(t);
else
var n=e.getBehaviours(t);
this.addBehaviours(n)
},this.getBehaviours=function(e){
if(!e)
return this.$behaviours;
var t={};
for(var n=0;n<e.length;n++)
this.$behaviours[e[n]]&&(t[e[n]]=this.$behaviours[e[n]]);
return t
}
}.call(r.prototype),t.Behaviour=r)
}),ace.define('ace/unicode',[
'require',
'exports',
'module'
],function(e,t,n){
function r(e){
var n=/\w{4}/g;
for(var r in e)
t.packages[r]=e[r].replace(n,'\\u$&')
}
t.packages={},r({
L:'0041-005A0061-007A00AA00B500BA00C0-00D600D8-00F600F8-02C102C6-02D102E0-02E402EC02EE0370-037403760377037A-037D03860388-038A038C038E-03A103A3-03F503F7-0481048A-05250531-055605590561-058705D0-05EA05F0-05F20621-064A066E066F0671-06D306D506E506E606EE06EF06FA-06FC06FF07100712-072F074D-07A507B107CA-07EA07F407F507FA0800-0815081A082408280904-0939093D09500958-0961097109720979-097F0985-098C098F09900993-09A809AA-09B009B209B6-09B909BD09CE09DC09DD09DF-09E109F009F10A05-0A0A0A0F0A100A13-0A280A2A-0A300A320A330A350A360A380A390A59-0A5C0A5E0A72-0A740A85-0A8D0A8F-0A910A93-0AA80AAA-0AB00AB20AB30AB5-0AB90ABD0AD00AE00AE10B05-0B0C0B0F0B100B13-0B280B2A-0B300B320B330B35-0B390B3D0B5C0B5D0B5F-0B610B710B830B85-0B8A0B8E-0B900B92-0B950B990B9A0B9C0B9E0B9F0BA30BA40BA8-0BAA0BAE-0BB90BD00C05-0C0C0C0E-0C100C12-0C280C2A-0C330C35-0C390C3D0C580C590C600C610C85-0C8C0C8E-0C900C92-0CA80CAA-0CB30CB5-0CB90CBD0CDE0CE00CE10D05-0D0C0D0E-0D100D12-0D280D2A-0D390D3D0D600D610D7A-0D7F0D85-0D960D9A-0DB10DB3-0DBB0DBD0DC0-0DC60E01-0E300E320E330E40-0E460E810E820E840E870E880E8A0E8D0E94-0E970E99-0E9F0EA1-0EA30EA50EA70EAA0EAB0EAD-0EB00EB20EB30EBD0EC0-0EC40EC60EDC0EDD0F000F40-0F470F49-0F6C0F88-0F8B1000-102A103F1050-1055105A-105D106110651066106E-10701075-1081108E10A0-10C510D0-10FA10FC1100-1248124A-124D1250-12561258125A-125D1260-1288128A-128D1290-12B012B2-12B512B8-12BE12C012C2-12C512C8-12D612D8-13101312-13151318-135A1380-138F13A0-13F41401-166C166F-167F1681-169A16A0-16EA1700-170C170E-17111720-17311740-17511760-176C176E-17701780-17B317D717DC1820-18771880-18A818AA18B0-18F51900-191C1950-196D1970-19741980-19AB19C1-19C71A00-1A161A20-1A541AA71B05-1B331B45-1B4B1B83-1BA01BAE1BAF1C00-1C231C4D-1C4F1C5A-1C7D1CE9-1CEC1CEE-1CF11D00-1DBF1E00-1F151F18-1F1D1F20-1F451F48-1F4D1F50-1F571F591F5B1F5D1F5F-1F7D1F80-1FB41FB6-1FBC1FBE1FC2-1FC41FC6-1FCC1FD0-1FD31FD6-1FDB1FE0-1FEC1FF2-1FF41FF6-1FFC2071207F2090-209421022107210A-211321152119-211D212421262128212A-212D212F-2139213C-213F2145-2149214E218321842C00-2C2E2C30-2C5E2C60-2CE42CEB-2CEE2D00-2D252D30-2D652D6F2D80-2D962DA0-2DA62DA8-2DAE2DB0-2DB62DB8-2DBE2DC0-2DC62DC8-2DCE2DD0-2DD62DD8-2DDE2E2F300530063031-3035303B303C3041-3096309D-309F30A1-30FA30FC-30FF3105-312D3131-318E31A0-31B731F0-31FF3400-4DB54E00-9FCBA000-A48CA4D0-A4FDA500-A60CA610-A61FA62AA62BA640-A65FA662-A66EA67F-A697A6A0-A6E5A717-A71FA722-A788A78BA78CA7FB-A801A803-A805A807-A80AA80C-A822A840-A873A882-A8B3A8F2-A8F7A8FBA90A-A925A930-A946A960-A97CA984-A9B2A9CFAA00-AA28AA40-AA42AA44-AA4BAA60-AA76AA7AAA80-AAAFAAB1AAB5AAB6AAB9-AABDAAC0AAC2AADB-AADDABC0-ABE2AC00-D7A3D7B0-D7C6D7CB-D7FBF900-FA2DFA30-FA6DFA70-FAD9FB00-FB06FB13-FB17FB1DFB1F-FB28FB2A-FB36FB38-FB3CFB3EFB40FB41FB43FB44FB46-FBB1FBD3-FD3DFD50-FD8FFD92-FDC7FDF0-FDFBFE70-FE74FE76-FEFCFF21-FF3AFF41-FF5AFF66-FFBEFFC2-FFC7FFCA-FFCFFFD2-FFD7FFDA-FFDC',
Ll:'0061-007A00AA00B500BA00DF-00F600F8-00FF01010103010501070109010B010D010F01110113011501170119011B011D011F01210123012501270129012B012D012F01310133013501370138013A013C013E014001420144014601480149014B014D014F01510153015501570159015B015D015F01610163016501670169016B016D016F0171017301750177017A017C017E-0180018301850188018C018D019201950199-019B019E01A101A301A501A801AA01AB01AD01B001B401B601B901BA01BD-01BF01C601C901CC01CE01D001D201D401D601D801DA01DC01DD01DF01E101E301E501E701E901EB01ED01EF01F001F301F501F901FB01FD01FF02010203020502070209020B020D020F02110213021502170219021B021D021F02210223022502270229022B022D022F02310233-0239023C023F0240024202470249024B024D024F-02930295-02AF037103730377037B-037D039003AC-03CE03D003D103D5-03D703D903DB03DD03DF03E103E303E503E703E903EB03ED03EF-03F303F503F803FB03FC0430-045F04610463046504670469046B046D046F04710473047504770479047B047D047F0481048B048D048F04910493049504970499049B049D049F04A104A304A504A704A904AB04AD04AF04B104B304B504B704B904BB04BD04BF04C204C404C604C804CA04CC04CE04CF04D104D304D504D704D904DB04DD04DF04E104E304E504E704E904EB04ED04EF04F104F304F504F704F904FB04FD04FF05010503050505070509050B050D050F05110513051505170519051B051D051F0521052305250561-05871D00-1D2B1D62-1D771D79-1D9A1E011E031E051E071E091E0B1E0D1E0F1E111E131E151E171E191E1B1E1D1E1F1E211E231E251E271E291E2B1E2D1E2F1E311E331E351E371E391E3B1E3D1E3F1E411E431E451E471E491E4B1E4D1E4F1E511E531E551E571E591E5B1E5D1E5F1E611E631E651E671E691E6B1E6D1E6F1E711E731E751E771E791E7B1E7D1E7F1E811E831E851E871E891E8B1E8D1E8F1E911E931E95-1E9D1E9F1EA11EA31EA51EA71EA91EAB1EAD1EAF1EB11EB31EB51EB71EB91EBB1EBD1EBF1EC11EC31EC51EC71EC91ECB1ECD1ECF1ED11ED31ED51ED71ED91EDB1EDD1EDF1EE11EE31EE51EE71EE91EEB1EED1EEF1EF11EF31EF51EF71EF91EFB1EFD1EFF-1F071F10-1F151F20-1F271F30-1F371F40-1F451F50-1F571F60-1F671F70-1F7D1F80-1F871F90-1F971FA0-1FA71FB0-1FB41FB61FB71FBE1FC2-1FC41FC61FC71FD0-1FD31FD61FD71FE0-1FE71FF2-1FF41FF61FF7210A210E210F2113212F21342139213C213D2146-2149214E21842C30-2C5E2C612C652C662C682C6A2C6C2C712C732C742C76-2C7C2C812C832C852C872C892C8B2C8D2C8F2C912C932C952C972C992C9B2C9D2C9F2CA12CA32CA52CA72CA92CAB2CAD2CAF2CB12CB32CB52CB72CB92CBB2CBD2CBF2CC12CC32CC52CC72CC92CCB2CCD2CCF2CD12CD32CD52CD72CD92CDB2CDD2CDF2CE12CE32CE42CEC2CEE2D00-2D25A641A643A645A647A649A64BA64DA64FA651A653A655A657A659A65BA65DA65FA663A665A667A669A66BA66DA681A683A685A687A689A68BA68DA68FA691A693A695A697A723A725A727A729A72BA72DA72F-A731A733A735A737A739A73BA73DA73FA741A743A745A747A749A74BA74DA74FA751A753A755A757A759A75BA75DA75FA761A763A765A767A769A76BA76DA76FA771-A778A77AA77CA77FA781A783A785A787A78CFB00-FB06FB13-FB17FF41-FF5A',
Lu:'0041-005A00C0-00D600D8-00DE01000102010401060108010A010C010E01100112011401160118011A011C011E01200122012401260128012A012C012E01300132013401360139013B013D013F0141014301450147014A014C014E01500152015401560158015A015C015E01600162016401660168016A016C016E017001720174017601780179017B017D018101820184018601870189-018B018E-0191019301940196-0198019C019D019F01A001A201A401A601A701A901AC01AE01AF01B1-01B301B501B701B801BC01C401C701CA01CD01CF01D101D301D501D701D901DB01DE01E001E201E401E601E801EA01EC01EE01F101F401F6-01F801FA01FC01FE02000202020402060208020A020C020E02100212021402160218021A021C021E02200222022402260228022A022C022E02300232023A023B023D023E02410243-02460248024A024C024E03700372037603860388-038A038C038E038F0391-03A103A3-03AB03CF03D2-03D403D803DA03DC03DE03E003E203E403E603E803EA03EC03EE03F403F703F903FA03FD-042F04600462046404660468046A046C046E04700472047404760478047A047C047E0480048A048C048E04900492049404960498049A049C049E04A004A204A404A604A804AA04AC04AE04B004B204B404B604B804BA04BC04BE04C004C104C304C504C704C904CB04CD04D004D204D404D604D804DA04DC04DE04E004E204E404E604E804EA04EC04EE04F004F204F404F604F804FA04FC04FE05000502050405060508050A050C050E05100512051405160518051A051C051E0520052205240531-055610A0-10C51E001E021E041E061E081E0A1E0C1E0E1E101E121E141E161E181E1A1E1C1E1E1E201E221E241E261E281E2A1E2C1E2E1E301E321E341E361E381E3A1E3C1E3E1E401E421E441E461E481E4A1E4C1E4E1E501E521E541E561E581E5A1E5C1E5E1E601E621E641E661E681E6A1E6C1E6E1E701E721E741E761E781E7A1E7C1E7E1E801E821E841E861E881E8A1E8C1E8E1E901E921E941E9E1EA01EA21EA41EA61EA81EAA1EAC1EAE1EB01EB21EB41EB61EB81EBA1EBC1EBE1EC01EC21EC41EC61EC81ECA1ECC1ECE1ED01ED21ED41ED61ED81EDA1EDC1EDE1EE01EE21EE41EE61EE81EEA1EEC1EEE1EF01EF21EF41EF61EF81EFA1EFC1EFE1F08-1F0F1F18-1F1D1F28-1F2F1F38-1F3F1F48-1F4D1F591F5B1F5D1F5F1F68-1F6F1FB8-1FBB1FC8-1FCB1FD8-1FDB1FE8-1FEC1FF8-1FFB21022107210B-210D2110-211221152119-211D212421262128212A-212D2130-2133213E213F214521832C00-2C2E2C602C62-2C642C672C692C6B2C6D-2C702C722C752C7E-2C802C822C842C862C882C8A2C8C2C8E2C902C922C942C962C982C9A2C9C2C9E2CA02CA22CA42CA62CA82CAA2CAC2CAE2CB02CB22CB42CB62CB82CBA2CBC2CBE2CC02CC22CC42CC62CC82CCA2CCC2CCE2CD02CD22CD42CD62CD82CDA2CDC2CDE2CE02CE22CEB2CEDA640A642A644A646A648A64AA64CA64EA650A652A654A656A658A65AA65CA65EA662A664A666A668A66AA66CA680A682A684A686A688A68AA68CA68EA690A692A694A696A722A724A726A728A72AA72CA72EA732A734A736A738A73AA73CA73EA740A742A744A746A748A74AA74CA74EA750A752A754A756A758A75AA75CA75EA760A762A764A766A768A76AA76CA76EA779A77BA77DA77EA780A782A784A786A78BFF21-FF3A',
Lt:'01C501C801CB01F21F88-1F8F1F98-1F9F1FA8-1FAF1FBC1FCC1FFC',
Lm:'02B0-02C102C6-02D102E0-02E402EC02EE0374037A0559064006E506E607F407F507FA081A0824082809710E460EC610FC17D718431AA71C78-1C7D1D2C-1D611D781D9B-1DBF2071207F2090-20942C7D2D6F2E2F30053031-3035303B309D309E30FC-30FEA015A4F8-A4FDA60CA67FA717-A71FA770A788A9CFAA70AADDFF70FF9EFF9F',
Lo:'01BB01C0-01C3029405D0-05EA05F0-05F20621-063F0641-064A066E066F0671-06D306D506EE06EF06FA-06FC06FF07100712-072F074D-07A507B107CA-07EA0800-08150904-0939093D09500958-096109720979-097F0985-098C098F09900993-09A809AA-09B009B209B6-09B909BD09CE09DC09DD09DF-09E109F009F10A05-0A0A0A0F0A100A13-0A280A2A-0A300A320A330A350A360A380A390A59-0A5C0A5E0A72-0A740A85-0A8D0A8F-0A910A93-0AA80AAA-0AB00AB20AB30AB5-0AB90ABD0AD00AE00AE10B05-0B0C0B0F0B100B13-0B280B2A-0B300B320B330B35-0B390B3D0B5C0B5D0B5F-0B610B710B830B85-0B8A0B8E-0B900B92-0B950B990B9A0B9C0B9E0B9F0BA30BA40BA8-0BAA0BAE-0BB90BD00C05-0C0C0C0E-0C100C12-0C280C2A-0C330C35-0C390C3D0C580C590C600C610C85-0C8C0C8E-0C900C92-0CA80CAA-0CB30CB5-0CB90CBD0CDE0CE00CE10D05-0D0C0D0E-0D100D12-0D280D2A-0D390D3D0D600D610D7A-0D7F0D85-0D960D9A-0DB10DB3-0DBB0DBD0DC0-0DC60E01-0E300E320E330E40-0E450E810E820E840E870E880E8A0E8D0E94-0E970E99-0E9F0EA1-0EA30EA50EA70EAA0EAB0EAD-0EB00EB20EB30EBD0EC0-0EC40EDC0EDD0F000F40-0F470F49-0F6C0F88-0F8B1000-102A103F1050-1055105A-105D106110651066106E-10701075-1081108E10D0-10FA1100-1248124A-124D1250-12561258125A-125D1260-1288128A-128D1290-12B012B2-12B512B8-12BE12C012C2-12C512C8-12D612D8-13101312-13151318-135A1380-138F13A0-13F41401-166C166F-167F1681-169A16A0-16EA1700-170C170E-17111720-17311740-17511760-176C176E-17701780-17B317DC1820-18421844-18771880-18A818AA18B0-18F51900-191C1950-196D1970-19741980-19AB19C1-19C71A00-1A161A20-1A541B05-1B331B45-1B4B1B83-1BA01BAE1BAF1C00-1C231C4D-1C4F1C5A-1C771CE9-1CEC1CEE-1CF12135-21382D30-2D652D80-2D962DA0-2DA62DA8-2DAE2DB0-2DB62DB8-2DBE2DC0-2DC62DC8-2DCE2DD0-2DD62DD8-2DDE3006303C3041-3096309F30A1-30FA30FF3105-312D3131-318E31A0-31B731F0-31FF3400-4DB54E00-9FCBA000-A014A016-A48CA4D0-A4F7A500-A60BA610-A61FA62AA62BA66EA6A0-A6E5A7FB-A801A803-A805A807-A80AA80C-A822A840-A873A882-A8B3A8F2-A8F7A8FBA90A-A925A930-A946A960-A97CA984-A9B2AA00-AA28AA40-AA42AA44-AA4BAA60-AA6FAA71-AA76AA7AAA80-AAAFAAB1AAB5AAB6AAB9-AABDAAC0AAC2AADBAADCABC0-ABE2AC00-D7A3D7B0-D7C6D7CB-D7FBF900-FA2DFA30-FA6DFA70-FAD9FB1DFB1F-FB28FB2A-FB36FB38-FB3CFB3EFB40FB41FB43FB44FB46-FBB1FBD3-FD3DFD50-FD8FFD92-FDC7FDF0-FDFBFE70-FE74FE76-FEFCFF66-FF6FFF71-FF9DFFA0-FFBEFFC2-FFC7FFCA-FFCFFFD2-FFD7FFDA-FFDC',
M:'0300-036F0483-04890591-05BD05BF05C105C205C405C505C70610-061A064B-065E067006D6-06DC06DE-06E406E706E806EA-06ED07110730-074A07A6-07B007EB-07F30816-0819081B-08230825-08270829-082D0900-0903093C093E-094E0951-0955096209630981-098309BC09BE-09C409C709C809CB-09CD09D709E209E30A01-0A030A3C0A3E-0A420A470A480A4B-0A4D0A510A700A710A750A81-0A830ABC0ABE-0AC50AC7-0AC90ACB-0ACD0AE20AE30B01-0B030B3C0B3E-0B440B470B480B4B-0B4D0B560B570B620B630B820BBE-0BC20BC6-0BC80BCA-0BCD0BD70C01-0C030C3E-0C440C46-0C480C4A-0C4D0C550C560C620C630C820C830CBC0CBE-0CC40CC6-0CC80CCA-0CCD0CD50CD60CE20CE30D020D030D3E-0D440D46-0D480D4A-0D4D0D570D620D630D820D830DCA0DCF-0DD40DD60DD8-0DDF0DF20DF30E310E34-0E3A0E47-0E4E0EB10EB4-0EB90EBB0EBC0EC8-0ECD0F180F190F350F370F390F3E0F3F0F71-0F840F860F870F90-0F970F99-0FBC0FC6102B-103E1056-1059105E-10601062-10641067-106D1071-10741082-108D108F109A-109D135F1712-17141732-1734175217531772177317B6-17D317DD180B-180D18A91920-192B1930-193B19B0-19C019C819C91A17-1A1B1A55-1A5E1A60-1A7C1A7F1B00-1B041B34-1B441B6B-1B731B80-1B821BA1-1BAA1C24-1C371CD0-1CD21CD4-1CE81CED1CF21DC0-1DE61DFD-1DFF20D0-20F02CEF-2CF12DE0-2DFF302A-302F3099309AA66F-A672A67CA67DA6F0A6F1A802A806A80BA823-A827A880A881A8B4-A8C4A8E0-A8F1A926-A92DA947-A953A980-A983A9B3-A9C0AA29-AA36AA43AA4CAA4DAA7BAAB0AAB2-AAB4AAB7AAB8AABEAABFAAC1ABE3-ABEAABECABEDFB1EFE00-FE0FFE20-FE26',
Mn:'0300-036F0483-04870591-05BD05BF05C105C205C405C505C70610-061A064B-065E067006D6-06DC06DF-06E406E706E806EA-06ED07110730-074A07A6-07B007EB-07F30816-0819081B-08230825-08270829-082D0900-0902093C0941-0948094D0951-095509620963098109BC09C1-09C409CD09E209E30A010A020A3C0A410A420A470A480A4B-0A4D0A510A700A710A750A810A820ABC0AC1-0AC50AC70AC80ACD0AE20AE30B010B3C0B3F0B41-0B440B4D0B560B620B630B820BC00BCD0C3E-0C400C46-0C480C4A-0C4D0C550C560C620C630CBC0CBF0CC60CCC0CCD0CE20CE30D41-0D440D4D0D620D630DCA0DD2-0DD40DD60E310E34-0E3A0E47-0E4E0EB10EB4-0EB90EBB0EBC0EC8-0ECD0F180F190F350F370F390F71-0F7E0F80-0F840F860F870F90-0F970F99-0FBC0FC6102D-10301032-10371039103A103D103E10581059105E-10601071-1074108210851086108D109D135F1712-17141732-1734175217531772177317B7-17BD17C617C9-17D317DD180B-180D18A91920-19221927192819321939-193B1A171A181A561A58-1A5E1A601A621A65-1A6C1A73-1A7C1A7F1B00-1B031B341B36-1B3A1B3C1B421B6B-1B731B801B811BA2-1BA51BA81BA91C2C-1C331C361C371CD0-1CD21CD4-1CE01CE2-1CE81CED1DC0-1DE61DFD-1DFF20D0-20DC20E120E5-20F02CEF-2CF12DE0-2DFF302A-302F3099309AA66FA67CA67DA6F0A6F1A802A806A80BA825A826A8C4A8E0-A8F1A926-A92DA947-A951A980-A982A9B3A9B6-A9B9A9BCAA29-AA2EAA31AA32AA35AA36AA43AA4CAAB0AAB2-AAB4AAB7AAB8AABEAABFAAC1ABE5ABE8ABEDFB1EFE00-FE0FFE20-FE26',
Mc:'0903093E-09400949-094C094E0982098309BE-09C009C709C809CB09CC09D70A030A3E-0A400A830ABE-0AC00AC90ACB0ACC0B020B030B3E0B400B470B480B4B0B4C0B570BBE0BBF0BC10BC20BC6-0BC80BCA-0BCC0BD70C01-0C030C41-0C440C820C830CBE0CC0-0CC40CC70CC80CCA0CCB0CD50CD60D020D030D3E-0D400D46-0D480D4A-0D4C0D570D820D830DCF-0DD10DD8-0DDF0DF20DF30F3E0F3F0F7F102B102C10311038103B103C105610571062-10641067-106D108310841087-108C108F109A-109C17B617BE-17C517C717C81923-19261929-192B193019311933-193819B0-19C019C819C91A19-1A1B1A551A571A611A631A641A6D-1A721B041B351B3B1B3D-1B411B431B441B821BA11BA61BA71BAA1C24-1C2B1C341C351CE11CF2A823A824A827A880A881A8B4-A8C3A952A953A983A9B4A9B5A9BAA9BBA9BD-A9C0AA2FAA30AA33AA34AA4DAA7BABE3ABE4ABE6ABE7ABE9ABEAABEC',
Me:'0488048906DE20DD-20E020E2-20E4A670-A672',
N:'0030-003900B200B300B900BC-00BE0660-066906F0-06F907C0-07C90966-096F09E6-09EF09F4-09F90A66-0A6F0AE6-0AEF0B66-0B6F0BE6-0BF20C66-0C6F0C78-0C7E0CE6-0CEF0D66-0D750E50-0E590ED0-0ED90F20-0F331040-10491090-10991369-137C16EE-16F017E0-17E917F0-17F91810-18191946-194F19D0-19DA1A80-1A891A90-1A991B50-1B591BB0-1BB91C40-1C491C50-1C5920702074-20792080-20892150-21822185-21892460-249B24EA-24FF2776-27932CFD30073021-30293038-303A3192-31953220-32293251-325F3280-328932B1-32BFA620-A629A6E6-A6EFA830-A835A8D0-A8D9A900-A909A9D0-A9D9AA50-AA59ABF0-ABF9FF10-FF19',
Nd:'0030-00390660-066906F0-06F907C0-07C90966-096F09E6-09EF0A66-0A6F0AE6-0AEF0B66-0B6F0BE6-0BEF0C66-0C6F0CE6-0CEF0D66-0D6F0E50-0E590ED0-0ED90F20-0F291040-10491090-109917E0-17E91810-18191946-194F19D0-19DA1A80-1A891A90-1A991B50-1B591BB0-1BB91C40-1C491C50-1C59A620-A629A8D0-A8D9A900-A909A9D0-A9D9AA50-AA59ABF0-ABF9FF10-FF19',
Nl:'16EE-16F02160-21822185-218830073021-30293038-303AA6E6-A6EF',
No:'00B200B300B900BC-00BE09F4-09F90BF0-0BF20C78-0C7E0D70-0D750F2A-0F331369-137C17F0-17F920702074-20792080-20892150-215F21892460-249B24EA-24FF2776-27932CFD3192-31953220-32293251-325F3280-328932B1-32BFA830-A835',
P:'0021-00230025-002A002C-002F003A003B003F0040005B-005D005F007B007D00A100AB00B700BB00BF037E0387055A-055F0589058A05BE05C005C305C605F305F40609060A060C060D061B061E061F066A-066D06D40700-070D07F7-07F90830-083E0964096509700DF40E4F0E5A0E5B0F04-0F120F3A-0F3D0F850FD0-0FD4104A-104F10FB1361-13681400166D166E169B169C16EB-16ED1735173617D4-17D617D8-17DA1800-180A1944194519DE19DF1A1E1A1F1AA0-1AA61AA8-1AAD1B5A-1B601C3B-1C3F1C7E1C7F1CD32010-20272030-20432045-20512053-205E207D207E208D208E2329232A2768-277527C527C627E6-27EF2983-299829D8-29DB29FC29FD2CF9-2CFC2CFE2CFF2E00-2E2E2E302E313001-30033008-30113014-301F3030303D30A030FBA4FEA4FFA60D-A60FA673A67EA6F2-A6F7A874-A877A8CEA8CFA8F8-A8FAA92EA92FA95FA9C1-A9CDA9DEA9DFAA5C-AA5FAADEAADFABEBFD3EFD3FFE10-FE19FE30-FE52FE54-FE61FE63FE68FE6AFE6BFF01-FF03FF05-FF0AFF0C-FF0FFF1AFF1BFF1FFF20FF3B-FF3DFF3FFF5BFF5DFF5F-FF65',
Pd:'002D058A05BE140018062010-20152E172E1A301C303030A0FE31FE32FE58FE63FF0D',
Ps:'0028005B007B0F3A0F3C169B201A201E2045207D208D23292768276A276C276E27702772277427C527E627E827EA27EC27EE2983298529872989298B298D298F299129932995299729D829DA29FC2E222E242E262E283008300A300C300E3010301430163018301A301DFD3EFE17FE35FE37FE39FE3BFE3DFE3FFE41FE43FE47FE59FE5BFE5DFF08FF3BFF5BFF5FFF62',
Pe:'0029005D007D0F3B0F3D169C2046207E208E232A2769276B276D276F27712773277527C627E727E927EB27ED27EF298429862988298A298C298E2990299229942996299829D929DB29FD2E232E252E272E293009300B300D300F3011301530173019301B301E301FFD3FFE18FE36FE38FE3AFE3CFE3EFE40FE42FE44FE48FE5AFE5CFE5EFF09FF3DFF5DFF60FF63',
Pi:'00AB2018201B201C201F20392E022E042E092E0C2E1C2E20',
Pf:'00BB2019201D203A2E032E052E0A2E0D2E1D2E21',
Pc:'005F203F20402054FE33FE34FE4D-FE4FFF3F',
Po:'0021-00230025-0027002A002C002E002F003A003B003F0040005C00A100B700BF037E0387055A-055F058905C005C305C605F305F40609060A060C060D061B061E061F066A-066D06D40700-070D07F7-07F90830-083E0964096509700DF40E4F0E5A0E5B0F04-0F120F850FD0-0FD4104A-104F10FB1361-1368166D166E16EB-16ED1735173617D4-17D617D8-17DA1800-18051807-180A1944194519DE19DF1A1E1A1F1AA0-1AA61AA8-1AAD1B5A-1B601C3B-1C3F1C7E1C7F1CD3201620172020-20272030-2038203B-203E2041-20432047-205120532055-205E2CF9-2CFC2CFE2CFF2E002E012E06-2E082E0B2E0E-2E162E182E192E1B2E1E2E1F2E2A-2E2E2E302E313001-3003303D30FBA4FEA4FFA60D-A60FA673A67EA6F2-A6F7A874-A877A8CEA8CFA8F8-A8FAA92EA92FA95FA9C1-A9CDA9DEA9DFAA5C-AA5FAADEAADFABEBFE10-FE16FE19FE30FE45FE46FE49-FE4CFE50-FE52FE54-FE57FE5F-FE61FE68FE6AFE6BFF01-FF03FF05-FF07FF0AFF0CFF0EFF0FFF1AFF1BFF1FFF20FF3CFF61FF64FF65',
S:'0024002B003C-003E005E0060007C007E00A2-00A900AC00AE-00B100B400B600B800D700F702C2-02C502D2-02DF02E5-02EB02ED02EF-02FF03750384038503F604820606-0608060B060E060F06E906FD06FE07F609F209F309FA09FB0AF10B700BF3-0BFA0C7F0CF10CF20D790E3F0F01-0F030F13-0F170F1A-0F1F0F340F360F380FBE-0FC50FC7-0FCC0FCE0FCF0FD5-0FD8109E109F13601390-139917DB194019E0-19FF1B61-1B6A1B74-1B7C1FBD1FBF-1FC11FCD-1FCF1FDD-1FDF1FED-1FEF1FFD1FFE20442052207A-207C208A-208C20A0-20B8210021012103-21062108210921142116-2118211E-2123212521272129212E213A213B2140-2144214A-214D214F2190-2328232B-23E82400-24262440-244A249C-24E92500-26CD26CF-26E126E326E8-26FF2701-27042706-2709270C-27272729-274B274D274F-27522756-275E2761-276727942798-27AF27B1-27BE27C0-27C427C7-27CA27CC27D0-27E527F0-29822999-29D729DC-29FB29FE-2B4C2B50-2B592CE5-2CEA2E80-2E992E9B-2EF32F00-2FD52FF0-2FFB300430123013302030363037303E303F309B309C319031913196-319F31C0-31E33200-321E322A-32503260-327F328A-32B032C0-32FE3300-33FF4DC0-4DFFA490-A4C6A700-A716A720A721A789A78AA828-A82BA836-A839AA77-AA79FB29FDFCFDFDFE62FE64-FE66FE69FF04FF0BFF1C-FF1EFF3EFF40FF5CFF5EFFE0-FFE6FFE8-FFEEFFFCFFFD',
Sm:'002B003C-003E007C007E00AC00B100D700F703F60606-060820442052207A-207C208A-208C2140-2144214B2190-2194219A219B21A021A321A621AE21CE21CF21D221D421F4-22FF2308-230B23202321237C239B-23B323DC-23E125B725C125F8-25FF266F27C0-27C427C7-27CA27CC27D0-27E527F0-27FF2900-29822999-29D729DC-29FB29FE-2AFF2B30-2B442B47-2B4CFB29FE62FE64-FE66FF0BFF1C-FF1EFF5CFF5EFFE2FFE9-FFEC',
Sc:'002400A2-00A5060B09F209F309FB0AF10BF90E3F17DB20A0-20B8A838FDFCFE69FF04FFE0FFE1FFE5FFE6',
Sk:'005E006000A800AF00B400B802C2-02C502D2-02DF02E5-02EB02ED02EF-02FF0375038403851FBD1FBF-1FC11FCD-1FCF1FDD-1FDF1FED-1FEF1FFD1FFE309B309CA700-A716A720A721A789A78AFF3EFF40FFE3',
So:'00A600A700A900AE00B000B60482060E060F06E906FD06FE07F609FA0B700BF3-0BF80BFA0C7F0CF10CF20D790F01-0F030F13-0F170F1A-0F1F0F340F360F380FBE-0FC50FC7-0FCC0FCE0FCF0FD5-0FD8109E109F13601390-1399194019E0-19FF1B61-1B6A1B74-1B7C210021012103-21062108210921142116-2118211E-2123212521272129212E213A213B214A214C214D214F2195-2199219C-219F21A121A221A421A521A7-21AD21AF-21CD21D021D121D321D5-21F32300-2307230C-231F2322-2328232B-237B237D-239A23B4-23DB23E2-23E82400-24262440-244A249C-24E92500-25B625B8-25C025C2-25F72600-266E2670-26CD26CF-26E126E326E8-26FF2701-27042706-2709270C-27272729-274B274D274F-27522756-275E2761-276727942798-27AF27B1-27BE2800-28FF2B00-2B2F2B452B462B50-2B592CE5-2CEA2E80-2E992E9B-2EF32F00-2FD52FF0-2FFB300430123013302030363037303E303F319031913196-319F31C0-31E33200-321E322A-32503260-327F328A-32B032C0-32FE3300-33FF4DC0-4DFFA490-A4C6A828-A82BA836A837A839AA77-AA79FDFDFFE4FFE8FFEDFFEEFFFCFFFD',
Z:'002000A01680180E2000-200A20282029202F205F3000',
Zs:'002000A01680180E2000-200A202F205F3000',
Zl:'2028',
Zp:'2029',
C:'0000-001F007F-009F00AD03780379037F-0383038B038D03A20526-05300557055805600588058B-059005C8-05CF05EB-05EF05F5-0605061C061D0620065F06DD070E070F074B074C07B2-07BF07FB-07FF082E082F083F-08FF093A093B094F095609570973-097809800984098D098E0991099209A909B109B3-09B509BA09BB09C509C609C909CA09CF-09D609D8-09DB09DE09E409E509FC-0A000A040A0B-0A0E0A110A120A290A310A340A370A3A0A3B0A3D0A43-0A460A490A4A0A4E-0A500A52-0A580A5D0A5F-0A650A76-0A800A840A8E0A920AA90AB10AB40ABA0ABB0AC60ACA0ACE0ACF0AD1-0ADF0AE40AE50AF00AF2-0B000B040B0D0B0E0B110B120B290B310B340B3A0B3B0B450B460B490B4A0B4E-0B550B58-0B5B0B5E0B640B650B72-0B810B840B8B-0B8D0B910B96-0B980B9B0B9D0BA0-0BA20BA5-0BA70BAB-0BAD0BBA-0BBD0BC3-0BC50BC90BCE0BCF0BD1-0BD60BD8-0BE50BFB-0C000C040C0D0C110C290C340C3A-0C3C0C450C490C4E-0C540C570C5A-0C5F0C640C650C70-0C770C800C810C840C8D0C910CA90CB40CBA0CBB0CC50CC90CCE-0CD40CD7-0CDD0CDF0CE40CE50CF00CF3-0D010D040D0D0D110D290D3A-0D3C0D450D490D4E-0D560D58-0D5F0D640D650D76-0D780D800D810D840D97-0D990DB20DBC0DBE0DBF0DC7-0DC90DCB-0DCE0DD50DD70DE0-0DF10DF5-0E000E3B-0E3E0E5C-0E800E830E850E860E890E8B0E8C0E8E-0E930E980EA00EA40EA60EA80EA90EAC0EBA0EBE0EBF0EC50EC70ECE0ECF0EDA0EDB0EDE-0EFF0F480F6D-0F700F8C-0F8F0F980FBD0FCD0FD9-0FFF10C6-10CF10FD-10FF1249124E124F12571259125E125F1289128E128F12B112B612B712BF12C112C612C712D7131113161317135B-135E137D-137F139A-139F13F5-13FF169D-169F16F1-16FF170D1715-171F1737-173F1754-175F176D17711774-177F17B417B517DE17DF17EA-17EF17FA-17FF180F181A-181F1878-187F18AB-18AF18F6-18FF191D-191F192C-192F193C-193F1941-1943196E196F1975-197F19AC-19AF19CA-19CF19DB-19DD1A1C1A1D1A5F1A7D1A7E1A8A-1A8F1A9A-1A9F1AAE-1AFF1B4C-1B4F1B7D-1B7F1BAB-1BAD1BBA-1BFF1C38-1C3A1C4A-1C4C1C80-1CCF1CF3-1CFF1DE7-1DFC1F161F171F1E1F1F1F461F471F4E1F4F1F581F5A1F5C1F5E1F7E1F7F1FB51FC51FD41FD51FDC1FF01FF11FF51FFF200B-200F202A-202E2060-206F20722073208F2095-209F20B9-20CF20F1-20FF218A-218F23E9-23FF2427-243F244B-245F26CE26E226E4-26E727002705270A270B2728274C274E2753-2755275F27602795-279727B027BF27CB27CD-27CF2B4D-2B4F2B5A-2BFF2C2F2C5F2CF2-2CF82D26-2D2F2D66-2D6E2D70-2D7F2D97-2D9F2DA72DAF2DB72DBF2DC72DCF2DD72DDF2E32-2E7F2E9A2EF4-2EFF2FD6-2FEF2FFC-2FFF3040309730983100-3104312E-3130318F31B8-31BF31E4-31EF321F32FF4DB6-4DBF9FCC-9FFFA48D-A48FA4C7-A4CFA62C-A63FA660A661A674-A67BA698-A69FA6F8-A6FFA78D-A7FAA82C-A82FA83A-A83FA878-A87FA8C5-A8CDA8DA-A8DFA8FC-A8FFA954-A95EA97D-A97FA9CEA9DA-A9DDA9E0-A9FFAA37-AA3FAA4EAA4FAA5AAA5BAA7C-AA7FAAC3-AADAAAE0-ABBFABEEABEFABFA-ABFFD7A4-D7AFD7C7-D7CAD7FC-F8FFFA2EFA2FFA6EFA6FFADA-FAFFFB07-FB12FB18-FB1CFB37FB3DFB3FFB42FB45FBB2-FBD2FD40-FD4FFD90FD91FDC8-FDEFFDFEFDFFFE1A-FE1FFE27-FE2FFE53FE67FE6C-FE6FFE75FEFD-FF00FFBF-FFC1FFC8FFC9FFD0FFD1FFD8FFD9FFDD-FFDFFFE7FFEF-FFFBFFFEFFFF',
Cc:'0000-001F007F-009F',
Cf:'00AD0600-060306DD070F17B417B5200B-200F202A-202E2060-2064206A-206FFEFFFFF9-FFFB',
Co:'E000-F8FF',
Cs:'D800-DFFF',
Cn:'03780379037F-0383038B038D03A20526-05300557055805600588058B-059005C8-05CF05EB-05EF05F5-05FF06040605061C061D0620065F070E074B074C07B2-07BF07FB-07FF082E082F083F-08FF093A093B094F095609570973-097809800984098D098E0991099209A909B109B3-09B509BA09BB09C509C609C909CA09CF-09D609D8-09DB09DE09E409E509FC-0A000A040A0B-0A0E0A110A120A290A310A340A370A3A0A3B0A3D0A43-0A460A490A4A0A4E-0A500A52-0A580A5D0A5F-0A650A76-0A800A840A8E0A920AA90AB10AB40ABA0ABB0AC60ACA0ACE0ACF0AD1-0ADF0AE40AE50AF00AF2-0B000B040B0D0B0E0B110B120B290B310B340B3A0B3B0B450B460B490B4A0B4E-0B550B58-0B5B0B5E0B640B650B72-0B810B840B8B-0B8D0B910B96-0B980B9B0B9D0BA0-0BA20BA5-0BA70BAB-0BAD0BBA-0BBD0BC3-0BC50BC90BCE0BCF0BD1-0BD60BD8-0BE50BFB-0C000C040C0D0C110C290C340C3A-0C3C0C450C490C4E-0C540C570C5A-0C5F0C640C650C70-0C770C800C810C840C8D0C910CA90CB40CBA0CBB0CC50CC90CCE-0CD40CD7-0CDD0CDF0CE40CE50CF00CF3-0D010D040D0D0D110D290D3A-0D3C0D450D490D4E-0D560D58-0D5F0D640D650D76-0D780D800D810D840D97-0D990DB20DBC0DBE0DBF0DC7-0DC90DCB-0DCE0DD50DD70DE0-0DF10DF5-0E000E3B-0E3E0E5C-0E800E830E850E860E890E8B0E8C0E8E-0E930E980EA00EA40EA60EA80EA90EAC0EBA0EBE0EBF0EC50EC70ECE0ECF0EDA0EDB0EDE-0EFF0F480F6D-0F700F8C-0F8F0F980FBD0FCD0FD9-0FFF10C6-10CF10FD-10FF1249124E124F12571259125E125F1289128E128F12B112B612B712BF12C112C612C712D7131113161317135B-135E137D-137F139A-139F13F5-13FF169D-169F16F1-16FF170D1715-171F1737-173F1754-175F176D17711774-177F17DE17DF17EA-17EF17FA-17FF180F181A-181F1878-187F18AB-18AF18F6-18FF191D-191F192C-192F193C-193F1941-1943196E196F1975-197F19AC-19AF19CA-19CF19DB-19DD1A1C1A1D1A5F1A7D1A7E1A8A-1A8F1A9A-1A9F1AAE-1AFF1B4C-1B4F1B7D-1B7F1BAB-1BAD1BBA-1BFF1C38-1C3A1C4A-1C4C1C80-1CCF1CF3-1CFF1DE7-1DFC1F161F171F1E1F1F1F461F471F4E1F4F1F581F5A1F5C1F5E1F7E1F7F1FB51FC51FD41FD51FDC1FF01FF11FF51FFF2065-206920722073208F2095-209F20B9-20CF20F1-20FF218A-218F23E9-23FF2427-243F244B-245F26CE26E226E4-26E727002705270A270B2728274C274E2753-2755275F27602795-279727B027BF27CB27CD-27CF2B4D-2B4F2B5A-2BFF2C2F2C5F2CF2-2CF82D26-2D2F2D66-2D6E2D70-2D7F2D97-2D9F2DA72DAF2DB72DBF2DC72DCF2DD72DDF2E32-2E7F2E9A2EF4-2EFF2FD6-2FEF2FFC-2FFF3040309730983100-3104312E-3130318F31B8-31BF31E4-31EF321F32FF4DB6-4DBF9FCC-9FFFA48D-A48FA4C7-A4CFA62C-A63FA660A661A674-A67BA698-A69FA6F8-A6FFA78D-A7FAA82C-A82FA83A-A83FA878-A87FA8C5-A8CDA8DA-A8DFA8FC-A8FFA954-A95EA97D-A97FA9CEA9DA-A9DDA9E0-A9FFAA37-AA3FAA4EAA4FAA5AAA5BAA7C-AA7FAAC3-AADAAAE0-ABBFABEEABEFABFA-ABFFD7A4-D7AFD7C7-D7CAD7FC-D7FFFA2EFA2FFA6EFA6FFADA-FAFFFB07-FB12FB18-FB1CFB37FB3DFB3FFB42FB45FBB2-FBD2FD40-FD4FFD90FD91FDC8-FDEFFDFEFDFFFE1A-FE1FFE27-FE2FFE53FE67FE6C-FE6FFE75FEFDFEFEFF00FFBF-FFC1FFC8FFC9FFD0FFD1FFD8FFD9FFDD-FFDFFFE7FFEF-FFF8FFFEFFFF'
})
}),ace.define('ace/token_iterator',[
'require',
'exports',
'module'
],function(e,t,n){
var r=function(e,t,n){
this.$session=e,this.$row=t,this.$rowTokens=e.getTokens(t);
var r=e.getTokenAt(t,n);
this.$tokenIndex=r?r.index:-1
};
(function(){
this.stepBackward=function(){
this.$tokenIndex-=1;
while(this.$tokenIndex<0){
this.$row-=1;
if(this.$row<0)
return this.$row=0,null;
this.$rowTokens=this.$session.getTokens(this.$row),this.$tokenIndex=this.$rowTokens.length-1
}
return this.$rowTokens[this.$tokenIndex]
},this.stepForward=function(){
this.$tokenIndex+=1;
var e;
while(this.$tokenIndex>=this.$rowTokens.length){
this.$row+=1,e||(e=this.$session.getLength());
if(this.$row>=e)
return this.$row=e-1,null;
this.$rowTokens=this.$session.getTokens(this.$row),this.$tokenIndex=0
}
return this.$rowTokens[this.$tokenIndex]
},this.getCurrentToken=function(){
return this.$rowTokens[this.$tokenIndex]
},this.getCurrentTokenRow=function(){
return this.$row
},this.getCurrentTokenColumn=function(){
var e=this.$rowTokens,t=this.$tokenIndex,n=e[t].start;
if(n!==undefined)
return n;
n=0;
while(t>0)
t-=1,n+=e[t].value.length;
return n
}
}.call(r.prototype),t.TokenIterator=r)
}),ace.define('ace/document',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/lib/event_emitter',
'ace/range',
'ace/anchor'
],function(e,t,n){
var r=e('./lib/oop'),i=e('./lib/event_emitter').EventEmitter,s=e('./range').Range,o=e('./anchor').Anchor,u=function(e){
this.$lines=[],e.length==0?this.$lines=['']:Array.isArray(e)?this._insertLines(0,e):this.insert({
row:0,
column:0
},e)
};
(function(){
r.implement(this,i),this.setValue=function(e){
var t=this.getLength();
this.remove(new s(0,0,t,this.getLine(t-1).length)),this.insert({
row:0,
column:0
},e)
},this.getValue=function(){
return this.getAllLines().join(this.getNewLineCharacter())
},this.createAnchor=function(e,t){
return new o(this,e,t)
},'aaa'.split(/a/).length==0?this.$split=function(e){
return e.replace(/\r\n|\r/g,'\n').split('\n')
}:this.$split=function(e){
return e.split(/\r\n|\r|\n/)
},this.$detectNewLine=function(e){
var t=e.match(/^.*?(\r\n|\r|\n)/m);
this.$autoNewLine=t?t[1]:'\n'
},this.getNewLineCharacter=function(){
switch(this.$newLineMode){
case'windows':
return'\r\n';
case'unix':
return'\n';
default:
return this.$autoNewLine
}
},this.$autoNewLine='\n',this.$newLineMode='auto',this.setNewLineMode=function(e){
if(this.$newLineMode===e)
return;
this.$newLineMode=e
},this.getNewLineMode=function(){
return this.$newLineMode
},this.isNewLine=function(e){
return e=='\r\n'||e=='\r'||e=='\n'
},this.getLine=function(e){
return this.$lines[e]||''
},this.getLines=function(e,t){
return this.$lines.slice(e,t+1)
},this.getAllLines=function(){
return this.getLines(0,this.getLength())
},this.getLength=function(){
return this.$lines.length
},this.getTextRange=function(e){
if(e.start.row==e.end.row)
return this.getLine(e.start.row).substring(e.start.column,e.end.column);
var t=this.getLines(e.start.row,e.end.row);
t[0]=(t[0]||'').substring(e.start.column);
var n=t.length-1;
return e.end.row-e.start.row==n&&(t[n]=t[n].substring(0,e.end.column)),t.join(this.getNewLineCharacter())
},this.$clipPosition=function(e){
var t=this.getLength();
return e.row>=t?(e.row=Math.max(0,t-1),e.column=this.getLine(t-1).length):e.row<0&&(e.row=0),e
},this.insert=function(e,t){
if(!t||t.length===0)
return e;
e=this.$clipPosition(e),this.getLength()<=1&&this.$detectNewLine(t);
var n=this.$split(t),r=n.splice(0,1)[0],i=n.length==0?null:n.splice(n.length-1,1)[0];
return e=this.insertInLine(e,r),i!==null&&(e=this.insertNewLine(e),e=this._insertLines(e.row,n),e=this.insertInLine(e,i||'')),e
},this.insertLines=function(e,t){
return e>=this.getLength()?this.insert({
row:e,
column:0
},'\n'+t.join('\n')):this._insertLines(Math.max(e,0),t)
},this._insertLines=function(e,t){
if(t.length==0)
return{
row:e,
column:0
};
if(t.length>65535){
var n=this._insertLines(e,t.slice(65535));
t=t.slice(0,65535)
}
var r=[
e,
0
];
r.push.apply(r,t),this.$lines.splice.apply(this.$lines,r);
var i=new s(e,0,e+t.length,0),o={
action:'insertLines',
range:i,
lines:t
};
return this._emit('change',{data:o}),n||i.end
},this.insertNewLine=function(e){
e=this.$clipPosition(e);
var t=this.$lines[e.row]||'';
this.$lines[e.row]=t.substring(0,e.column),this.$lines.splice(e.row+1,0,t.substring(e.column,t.length));
var n={
row:e.row+1,
column:0
},r={
action:'insertText',
range:s.fromPoints(e,n),
text:this.getNewLineCharacter()
};
return this._emit('change',{data:r}),n
},this.insertInLine=function(e,t){
if(t.length==0)
return e;
var n=this.$lines[e.row]||'';
this.$lines[e.row]=n.substring(0,e.column)+t+n.substring(e.column);
var r={
row:e.row,
column:e.column+t.length
},i={
action:'insertText',
range:s.fromPoints(e,r),
text:t
};
return this._emit('change',{data:i}),r
},this.remove=function(e){
!e instanceof s&&(e=s.fromPoints(e.start,e.end)),e.start=this.$clipPosition(e.start),e.end=this.$clipPosition(e.end);
if(e.isEmpty())
return e.start;
var t=e.start.row,n=e.end.row;
if(e.isMultiLine()){
var r=e.start.column==0?t:t+1,i=n-1;
e.end.column>0&&this.removeInLine(n,0,e.end.column),i>=r&&this._removeLines(r,i),r!=t&&(this.removeInLine(t,e.start.column,this.getLine(t).length),this.removeNewLine(e.start.row))
}else
this.removeInLine(t,e.start.column,e.end.column);
return e.start
},this.removeInLine=function(e,t,n){
if(t==n)
return;
var r=new s(e,t,e,n),i=this.getLine(e),o=i.substring(t,n),u=i.substring(0,t)+i.substring(n,i.length);
this.$lines.splice(e,1,u);
var a={
action:'removeText',
range:r,
text:o
};
return this._emit('change',{data:a}),r.start
},this.removeLines=function(e,t){
return e<0||t>=this.getLength()?this.remove(new s(e,0,t+1,0)):this._removeLines(e,t)
},this._removeLines=function(e,t){
var n=new s(e,0,t+1,0),r=this.$lines.splice(e,t-e+1),i={
action:'removeLines',
range:n,
nl:this.getNewLineCharacter(),
lines:r
};
return this._emit('change',{data:i}),r
},this.removeNewLine=function(e){
var t=this.getLine(e),n=this.getLine(e+1),r=new s(e,t.length,e+1,0),i=t+n;
this.$lines.splice(e,2,i);
var o={
action:'removeText',
range:r,
text:this.getNewLineCharacter()
};
this._emit('change',{data:o})
},this.replace=function(e,t){
!e instanceof s&&(e=s.fromPoints(e.start,e.end));
if(t.length==0&&e.isEmpty())
return e.start;
if(t==this.getTextRange(e))
return e.end;
this.remove(e);
if(t)
var n=this.insert(e.start,t);
else
n=e.start;
return n
},this.applyDeltas=function(e){
for(var t=0;t<e.length;t++){
var n=e[t],r=s.fromPoints(n.range.start,n.range.end);
n.action=='insertLines'?this.insertLines(r.start.row,n.lines):n.action=='insertText'?this.insert(r.start,n.text):n.action=='removeLines'?this._removeLines(r.start.row,r.end.row-1):n.action=='removeText'&&this.remove(r)
}
},this.revertDeltas=function(e){
for(var t=e.length-1;t>=0;t--){
var n=e[t],r=s.fromPoints(n.range.start,n.range.end);
n.action=='insertLines'?this._removeLines(r.start.row,r.end.row-1):n.action=='insertText'?this.remove(r):n.action=='removeLines'?this._insertLines(r.start.row,n.lines):n.action=='removeText'&&this.insert(r.start,n.text)
}
},this.indexToPosition=function(e,t){
var n=this.$lines||this.getAllLines(),r=this.getNewLineCharacter().length;
for(var i=t||0,s=n.length;i<s;i++){
e-=n[i].length+r;
if(e<0)
return{
row:i,
column:e+n[i].length+r
}
}
return{
row:s-1,
column:n[s-1].length
}
},this.positionToIndex=function(e,t){
var n=this.$lines||this.getAllLines(),r=this.getNewLineCharacter().length,i=0,s=Math.min(e.row,n.length);
for(var o=t||0;o<s;++o)
i+=n[o].length+r;
return i+e.column
}
}.call(u.prototype),t.Document=u)
}),ace.define('ace/anchor',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/lib/event_emitter'
],function(e,t,n){
var r=e('./lib/oop'),i=e('./lib/event_emitter').EventEmitter,s=t.Anchor=function(e,t,n){
this.$onChange=this.onChange.bind(this),this.attach(e),typeof n=='undefined'?this.setPosition(t.row,t.column):this.setPosition(t,n)
};
(function(){
r.implement(this,i),this.getPosition=function(){
return this.$clipPositionToDocument(this.row,this.column)
},this.getDocument=function(){
return this.document
},this.$insertRight=!1,this.onChange=function(e){
var t=e.data,n=t.range;
if(n.start.row==n.end.row&&n.start.row!=this.row)
return;
if(n.start.row>this.row)
return;
if(n.start.row==this.row&&n.start.column>this.column)
return;
var r=this.row,i=this.column,s=n.start,o=n.end;
if(t.action==='insertText')
if(s.row===r&&s.column<=i){
if(s.column!==i||!this.$insertRight)
s.row===o.row?i+=o.column-s.column:(i-=s.column,r+=o.row-s.row)
}else
s.row!==o.row&&s.row<r&&(r+=o.row-s.row);
else
t.action==='insertLines'?s.row<=r&&(r+=o.row-s.row):t.action==='removeText'?s.row===r&&s.column<i?o.column>=i?i=s.column:i=Math.max(0,i-(o.column-s.column)):s.row!==o.row&&s.row<r?(o.row===r&&(i=Math.max(0,i-o.column)+s.column),r-=o.row-s.row):o.row===r&&(r-=o.row-s.row,i=Math.max(0,i-o.column)+s.column):t.action=='removeLines'&&s.row<=r&&(o.row<=r?r-=o.row-s.row:(r=s.row,i=0));
this.setPosition(r,i,!0)
},this.setPosition=function(e,t,n){
var r;
n?r={
row:e,
column:t
}:r=this.$clipPositionToDocument(e,t);
if(this.row==r.row&&this.column==r.column)
return;
var i={
row:this.row,
column:this.column
};
this.row=r.row,this.column=r.column,this._emit('change',{
old:i,
value:r
})
},this.detach=function(){
this.document.removeEventListener('change',this.$onChange)
},this.attach=function(e){
this.document=e||this.document,this.document.on('change',this.$onChange)
},this.$clipPositionToDocument=function(e,t){
var n={};
return e>=this.document.getLength()?(n.row=Math.max(0,this.document.getLength()-1),n.column=this.document.getLine(n.row).length):e<0?(n.row=0,n.column=0):(n.row=e,n.column=Math.min(this.document.getLine(n.row).length,Math.max(0,t))),t<0&&(n.column=0),n
}
}.call(s.prototype))
}),ace.define('ace/background_tokenizer',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/lib/event_emitter'
],function(e,t,n){
var r=e('./lib/oop'),i=e('./lib/event_emitter').EventEmitter,s=function(e,t){
this.running=!1,this.lines=[],this.states=[],this.currentLine=0,this.tokenizer=e;
var n=this;
this.$worker=function(){
if(!n.running)
return;
var e=new Date,t=n.currentLine,r=-1,i=n.doc;
while(n.lines[t])
t++;
var s=t,o=i.getLength(),u=0;
n.running=!1;
while(t<o){
n.$tokenizeRow(t),r=t;
do
t++;
while(n.lines[t]);
u++;
if(u%5==0&&new Date-e>20){
n.running=setTimeout(n.$worker,20),n.currentLine=t;
return
}
}
n.currentLine=t,s<=r&&n.fireUpdateEvent(s,r)
}
};
(function(){
r.implement(this,i),this.setTokenizer=function(e){
this.tokenizer=e,this.lines=[],this.states=[],this.start(0)
},this.setDocument=function(e){
this.doc=e,this.lines=[],this.states=[],this.stop()
},this.fireUpdateEvent=function(e,t){
var n={
first:e,
last:t
};
this._emit('update',{data:n})
},this.start=function(e){
this.currentLine=Math.min(e||0,this.currentLine,this.doc.getLength()),this.lines.splice(this.currentLine,this.lines.length),this.states.splice(this.currentLine,this.states.length),this.stop(),this.running=setTimeout(this.$worker,700)
},this.scheduleStart=function(){
this.running||(this.running=setTimeout(this.$worker,700))
},this.$updateOnChange=function(e){
var t=e.range,n=t.start.row,r=t.end.row-n;
if(r===0)
this.lines[n]=null;
else if(e.action=='removeText'||e.action=='removeLines')
this.lines.splice(n,r+1,null),this.states.splice(n,r+1,null);
else{
var i=Array(r+1);
i.unshift(n,1),this.lines.splice.apply(this.lines,i),this.states.splice.apply(this.states,i)
}
this.currentLine=Math.min(n,this.currentLine,this.doc.getLength()),this.stop()
},this.stop=function(){
this.running&&clearTimeout(this.running),this.running=!1
},this.getTokens=function(e){
return this.lines[e]||this.$tokenizeRow(e)
},this.getState=function(e){
return this.currentLine==e&&this.$tokenizeRow(e),this.states[e]||'start'
},this.$tokenizeRow=function(e){
var t=this.doc.getLine(e),n=this.states[e-1],r=this.tokenizer.getLineTokens(t,n,e);
return this.states[e]+''!=r.state+''?(this.states[e]=r.state,this.lines[e+1]=null,this.currentLine>e+1&&(this.currentLine=e+1)):this.currentLine==e&&(this.currentLine=e+1),this.lines[e]=r.tokens
}
}.call(s.prototype),t.BackgroundTokenizer=s)
}),ace.define('ace/search_highlight',[
'require',
'exports',
'module',
'ace/lib/lang',
'ace/lib/oop',
'ace/range'
],function(e,t,n){
var r=e('./lib/lang'),i=e('./lib/oop'),s=e('./range').Range,o=function(e,t,n){
this.setRegexp(e),this.clazz=t,this.type=n||'text'
};
(function(){
this.MAX_RANGES=500,this.setRegexp=function(e){
if(this.regExp+''==e+'')
return;
this.regExp=e,this.cache=[]
},this.update=function(e,t,n,i){
if(!this.regExp)
return;
var o=i.firstRow,u=i.lastRow;
for(var a=o;a<=u;a++){
var f=this.cache[a];
f==null&&(f=r.getMatchOffsets(n.getLine(a),this.regExp),f.length>this.MAX_RANGES&&(f=f.slice(0,this.MAX_RANGES)),f=f.map(function(e){
return new s(a,e.offset,a,e.offset+e.length)
}),this.cache[a]=f.length?f:'');
for(var l=f.length;l--;)
t.drawSingleLineMarker(e,f[l].toScreenRange(n),this.clazz,i)
}
}
}.call(o.prototype),t.SearchHighlight=o)
}),ace.define('ace/edit_session/folding',[
'require',
'exports',
'module',
'ace/range',
'ace/edit_session/fold_line',
'ace/edit_session/fold',
'ace/token_iterator'
],function(e,t,n){
function u(){
this.getFoldAt=function(e,t,n){
var r=this.getFoldLine(e);
if(!r)
return null;
var i=r.folds;
for(var s=0;s<i.length;s++){
var o=i[s];
if(o.range.contains(e,t)){
if(n==1&&o.range.isEnd(e,t))
continue;
if(n==-1&&o.range.isStart(e,t))
continue;
return o
}
}
},this.getFoldsInRange=function(e){
var t=e.start,n=e.end,r=this.$foldData,i=[];
t.column+=1,n.column-=1;
for(var s=0;s<r.length;s++){
var o=r[s].range.compareRange(e);
if(o==2)
continue;
if(o==-2)
break;
var u=r[s].folds;
for(var a=0;a<u.length;a++){
var f=u[a];
o=f.range.compareRange(e);
if(o==-2)
break;
if(o==2)
continue;
if(o==42)
break;
i.push(f)
}
}
return t.column-=1,n.column+=1,i
},this.getFoldsInRangeList=function(e){
if(Array.isArray(e)){
var t=[];
e.forEach(function(e){
t=t.concat(this.getFoldsInRange(e))
},this)
}else
var t=this.getFoldsInRange(e);
return t
},this.getAllFolds=function(){
function n(t){
e.push(t)
}
var e=[],t=this.$foldData;
for(var r=0;r<t.length;r++)
for(var i=0;i<t[r].folds.length;i++)
n(t[r].folds[i]);
return e
},this.getFoldStringAt=function(e,t,n,r){
r=r||this.getFoldLine(e);
if(!r)
return null;
var i={end:{column:0}},s,o;
for(var u=0;u<r.folds.length;u++){
o=r.folds[u];
var a=o.range.compareEnd(e,t);
if(a==-1){
s=this.getLine(o.start.row).substring(i.end.column,o.start.column);
break
}
if(a===0)
return null;
i=o
}
return s||(s=this.getLine(o.start.row).substring(i.end.column)),n==-1?s.substring(0,t-i.end.column):n==1?s.substring(t-i.end.column):s
},this.getFoldLine=function(e,t){
var n=this.$foldData,r=0;
t&&(r=n.indexOf(t)),r==-1&&(r=0);
for(r;r<n.length;r++){
var i=n[r];
if(i.start.row<=e&&i.end.row>=e)
return i;
if(i.end.row>e)
return null
}
return null
},this.getNextFoldLine=function(e,t){
var n=this.$foldData,r=0;
t&&(r=n.indexOf(t)),r==-1&&(r=0);
for(r;r<n.length;r++){
var i=n[r];
if(i.end.row>=e)
return i
}
return null
},this.getFoldedRowCount=function(e,t){
var n=this.$foldData,r=t-e+1;
for(var i=0;i<n.length;i++){
var s=n[i],o=s.end.row,u=s.start.row;
if(o>=t){
u<t&&(u>=e?r-=t-u:r=0);
break
}
o>=e&&(u>=e?r-=o-u:r-=o-e+1)
}
return r
},this.$addFoldLine=function(e){
return this.$foldData.push(e),this.$foldData.sort(function(e,t){
return e.start.row-t.start.row
}),e
},this.addFold=function(e,t){
var n=this.$foldData,r=!1,o;
e instanceof s?o=e:(o=new s(t,e),o.collapseChildren=t.collapseChildren),this.$clipRangeToDocument(o.range);
var u=o.start.row,a=o.start.column,f=o.end.row,l=o.end.column;
if(u<f||u==f&&a<=l-2){
var c=this.getFoldAt(u,a,1),h=this.getFoldAt(f,l,-1);
if(c&&h==c)
return c.addSubFold(o);
if(c&&!c.range.isStart(u,a)||h&&!h.range.isEnd(f,l))
throw new Error('A fold can\'t intersect already existing fold'+o.range+c.range);
var p=this.getFoldsInRange(o.range);
p.length>0&&(this.removeFolds(p),p.forEach(function(e){
o.addSubFold(e)
}));
for(var d=0;d<n.length;d++){
var v=n[d];
if(f==v.start.row){
v.addFold(o),r=!0;
break
}
if(u==v.end.row){
v.addFold(o),r=!0;
if(!o.sameRow){
var m=n[d+1];
if(m&&m.start.row==f){
v.merge(m);
break
}
}
break
}
if(f<=v.start.row)
break
}
return r||(v=this.$addFoldLine(new i(this.$foldData,o))),this.$useWrapMode?this.$updateWrapData(v.start.row,v.start.row):this.$updateRowLengthCache(v.start.row,v.start.row),this.$modified=!0,this._emit('changeFold',{
data:o,
action:'add'
}),o
}
throw new Error('The range has to be at least 2 characters width')
},this.addFolds=function(e){
e.forEach(function(e){
this.addFold(e)
},this)
},this.removeFold=function(e){
var t=e.foldLine,n=t.start.row,r=t.end.row,i=this.$foldData,s=t.folds;
if(s.length==1)
i.splice(i.indexOf(t),1);
else if(t.range.isEnd(e.end.row,e.end.column))
s.pop(),t.end.row=s[s.length-1].end.row,t.end.column=s[s.length-1].end.column;
else if(t.range.isStart(e.start.row,e.start.column))
s.shift(),t.start.row=s[0].start.row,t.start.column=s[0].start.column;
else if(e.sameRow)
s.splice(s.indexOf(e),1);
else{
var o=t.split(e.start.row,e.start.column);
s=o.folds,s.shift(),o.start.row=s[0].start.row,o.start.column=s[0].start.column
}
this.$updating||(this.$useWrapMode?this.$updateWrapData(n,r):this.$updateRowLengthCache(n,r)),this.$modified=!0,this._emit('changeFold',{
data:e,
action:'remove'
})
},this.removeFolds=function(e){
var t=[];
for(var n=0;n<e.length;n++)
t.push(e[n]);
t.forEach(function(e){
this.removeFold(e)
},this),this.$modified=!0
},this.expandFold=function(e){
this.removeFold(e),e.subFolds.forEach(function(t){
e.restoreRange(t),this.addFold(t)
},this),e.collapseChildren>0&&this.foldAll(e.start.row+1,e.end.row,e.collapseChildren-1),e.subFolds=[]
},this.expandFolds=function(e){
e.forEach(function(e){
this.expandFold(e)
},this)
},this.unfold=function(e,t){
var n,i;
e==null?(n=new r(0,0,this.getLength(),0),t=!0):typeof e=='number'?n=new r(e,0,e,this.getLine(e).length):'row'in e?n=r.fromPoints(e,e):n=e,i=this.getFoldsInRangeList(n);
if(t)
this.removeFolds(i);
else
while(i.length)
this.expandFolds(i),i=this.getFoldsInRangeList(n)
},this.isRowFolded=function(e,t){
return!!this.getFoldLine(e,t)
},this.getRowFoldEnd=function(e,t){
var n=this.getFoldLine(e,t);
return n?n.end.row:e
},this.getRowFoldStart=function(e,t){
var n=this.getFoldLine(e,t);
return n?n.start.row:e
},this.getFoldDisplayLine=function(e,t,n,r,i){
r==null&&(r=e.start.row,i=0),t==null&&(t=e.end.row,n=this.getLine(t).length);
var s=this.doc,o='';
return e.walk(function(e,t,n,u){
if(t<r)
return;
if(t==r){
if(n<i)
return;
u=Math.max(i,u)
}
e!=null?o+=e:o+=s.getLine(t).substring(u,n)
},t,n),o
},this.getDisplayLine=function(e,t,n,r){
var i=this.getFoldLine(e);
if(!i){
var s;
return s=this.doc.getLine(e),s.substring(r||0,t||s.length)
}
return this.getFoldDisplayLine(i,e,t,n,r)
},this.$cloneFoldData=function(){
var e=[];
return e=this.$foldData.map(function(t){
var n=t.folds.map(function(e){
return e.clone()
});
return new i(e,n)
}),e
},this.toggleFold=function(e){
var t=this.selection,n=t.getRange(),r,i;
if(n.isEmpty()){
var s=n.start;
r=this.getFoldAt(s.row,s.column);
if(r){
this.expandFold(r);
return
}
(i=this.findMatchingBracket(s))?n.comparePoint(i)==1?n.end=i:(n.start=i,n.start.column++,n.end.column--):(i=this.findMatchingBracket({
row:s.row,
column:s.column+1
}))?(n.comparePoint(i)==1?n.end=i:n.start=i,n.start.column++):n=this.getCommentFoldRange(s.row,s.column)||n
}else{
var o=this.getFoldsInRange(n);
if(e&&o.length){
this.expandFolds(o);
return
}
o.length==1&&(r=o[0])
}
r||(r=this.getFoldAt(n.start.row,n.start.column));
if(r&&r.range.toString()==n.toString()){
this.expandFold(r);
return
}
var u='...';
if(!n.isMultiLine()){
u=this.getTextRange(n);
if(u.length<4)
return;
u=u.trim().substring(0,2)+'..'
}
this.addFold(u,n)
},this.getCommentFoldRange=function(e,t,n){
var i=new o(this,e,t),s=i.getCurrentToken();
if(s&&/^comment|string/.test(s.type)){
var u=new r,a=new RegExp(s.type.replace(/\..*/,'\\.'));
if(n!=1){
do
s=i.stepBackward();
while(s&&a.test(s.type));
i.stepForward()
}
u.start.row=i.getCurrentTokenRow(),u.start.column=i.getCurrentTokenColumn()+2,i=new o(this,e,t);
if(n!=-1){
do
s=i.stepForward();
while(s&&a.test(s.type));
s=i.stepBackward()
}else
s=i.getCurrentToken();
return u.end.row=i.getCurrentTokenRow(),u.end.column=i.getCurrentTokenColumn()+s.value.length-2,u
}
},this.foldAll=function(e,t,n){
n==undefined&&(n=100000);
var r=this.foldWidgets;
if(!r)
return;
t=t||this.getLength(),e=e||0;
for(var i=e;i<t;i++){
r[i]==null&&(r[i]=this.getFoldWidget(i));
if(r[i]!='start')
continue;
var s=this.getFoldWidgetRange(i);
if(s&&s.isMultiLine()&&s.end.row<=t&&s.start.row>=e)
try{
var o=this.addFold('...',s);
o.collapseChildren=n,i=s.end.row
}catch(u){
}
}
},this.$foldStyles={
manual:1,
markbegin:1,
markbeginend:1
},this.$foldStyle='markbegin',this.setFoldStyle=function(e){
if(!this.$foldStyles[e])
throw new Error('invalid fold style: '+e+'['+Object.keys(this.$foldStyles).join(', ')+']');
if(this.$foldStyle==e)
return;
this.$foldStyle=e,e=='manual'&&this.unfold();
var t=this.$foldMode;
this.$setFolding(null),this.$setFolding(t)
},this.$setFolding=function(e){
if(this.$foldMode==e)
return;
this.$foldMode=e,this.removeListener('change',this.$updateFoldWidgets),this._emit('changeAnnotation');
if(!e||this.$foldStyle=='manual'){
this.foldWidgets=null;
return
}
this.foldWidgets=[],this.getFoldWidget=e.getFoldWidget.bind(e,this,this.$foldStyle),this.getFoldWidgetRange=e.getFoldWidgetRange.bind(e,this,this.$foldStyle),this.$updateFoldWidgets=this.updateFoldWidgets.bind(this),this.on('change',this.$updateFoldWidgets)
},this.getParentFoldRangeData=function(e,t){
var n=this.foldWidgets;
if(!n||t&&n[e])
return{};
var r=e-1,i;
while(r>=0){
var s=n[r];
s==null&&(s=n[r]=this.getFoldWidget(r));
if(s=='start'){
var o=this.getFoldWidgetRange(r);
i||(i=o);
if(o&&o.end.row>=e)
break
}
r--
}
return{
range:r!==-1&&o,
firstRange:i
}
},this.onFoldWidgetClick=function(e,t){
t=t.domEvent;
var n={
children:t.shiftKey,
all:t.ctrlKey||t.metaKey,
siblings:t.altKey
},r=this.$toggleFoldWidget(e,n);
r||((t.target||t.srcElement).className+=' ace_invalid')
},this.$toggleFoldWidget=function(e,t){
var n=this.getFoldWidget(e),r=this.getLine(e),i=n==='end'?-1:1,s=this.getFoldAt(e,i===-1?0:r.length,i);
if(s){
t.children||t.all?this.removeFold(s):this.expandFold(s);
return
}
var o=this.getFoldWidgetRange(e,!0);
if(o&&!o.isMultiLine()){
s=this.getFoldAt(o.start.row,o.start.column,1);
if(s&&o.isEqual(s.range)){
this.removeFold(s);
return
}
}
if(t.siblings){
var u=this.getParentFoldRangeData(e);
if(u.range)
var a=u.range.start.row+1,f=u.range.end.row;
this.foldAll(a,f,t.all?10000:0)
}else
t.children?(f=o?o.end.row:this.getLength(),this.foldAll(e+1,o.end.row,t.all?10000:0)):o&&(t.all&&(o.collapseChildren=10000),this.addFold('...',o));
return o
},this.toggleFoldWidget=function(e){
var t=this.selection.getCursor().row;
t=this.getRowFoldStart(t);
var n=this.$toggleFoldWidget(t,{});
if(n)
return;
var r=this.getParentFoldRangeData(t,!0);
n=r.range||r.firstRange;
if(n){
t=n.start.row;
var i=this.getFoldAt(t,this.getLine(t).length,1);
i?this.removeFold(i):this.addFold('...',n)
}
},this.updateFoldWidgets=function(e){
var t=e.data,n=t.range,r=n.start.row,i=n.end.row-r;
if(i===0)
this.foldWidgets[r]=null;
else if(t.action=='removeText'||t.action=='removeLines')
this.foldWidgets.splice(r,i+1,null);
else{
var s=Array(i+1);
s.unshift(r,1),this.foldWidgets.splice.apply(this.foldWidgets,s)
}
}
}
var r=e('../range').Range,i=e('./fold_line').FoldLine,s=e('./fold').Fold,o=e('../token_iterator').TokenIterator;
t.Folding=u
}),ace.define('ace/edit_session/fold_line',[
'require',
'exports',
'module',
'ace/range'
],function(e,t,n){
function i(e,t){
this.foldData=e,Array.isArray(t)?this.folds=t:t=this.folds=[t];
var n=t[t.length-1];
this.range=new r(t[0].start.row,t[0].start.column,n.end.row,n.end.column),this.start=this.range.start,this.end=this.range.end,this.folds.forEach(function(e){
e.setFoldLine(this)
},this)
}
var r=e('../range').Range;
(function(){
this.shiftRow=function(e){
this.start.row+=e,this.end.row+=e,this.folds.forEach(function(t){
t.start.row+=e,t.end.row+=e
})
},this.addFold=function(e){
if(e.sameRow){
if(e.start.row<this.startRow||e.endRow>this.endRow)
throw new Error('Can\'t add a fold to this FoldLine as it has no connection');
this.folds.push(e),this.folds.sort(function(e,t){
return-e.range.compareEnd(t.start.row,t.start.column)
}),this.range.compareEnd(e.start.row,e.start.column)>0?(this.end.row=e.end.row,this.end.column=e.end.column):this.range.compareStart(e.end.row,e.end.column)<0&&(this.start.row=e.start.row,this.start.column=e.start.column)
}else if(e.start.row==this.end.row)
this.folds.push(e),this.end.row=e.end.row,this.end.column=e.end.column;
else{
if(e.end.row!=this.start.row)
throw new Error('Trying to add fold to FoldRow that doesn\'t have a matching row');
this.folds.unshift(e),this.start.row=e.start.row,this.start.column=e.start.column
}
e.foldLine=this
},this.containsRow=function(e){
return e>=this.start.row&&e<=this.end.row
},this.walk=function(e,t,n){
var r=0,i=this.folds,s,o,u,a=!0;
t==null&&(t=this.end.row,n=this.end.column);
for(var f=0;f<i.length;f++){
s=i[f],o=s.range.compareStart(t,n);
if(o==-1){
e(null,t,n,r,a);
return
}
u=e(null,s.start.row,s.start.column,r,a),u=!u&&e(s.placeholder,s.start.row,s.start.column,r);
if(u||o==0)
return;
a=!s.sameRow,r=s.end.column
}
e(null,t,n,r,a)
},this.getNextFoldTo=function(e,t){
var n,r;
for(var i=0;i<this.folds.length;i++){
n=this.folds[i],r=n.range.compareEnd(e,t);
if(r==-1)
return{
fold:n,
kind:'after'
};
if(r==0)
return{
fold:n,
kind:'inside'
}
}
return null
},this.addRemoveChars=function(e,t,n){
var r=this.getNextFoldTo(e,t),i,s;
if(r){
i=r.fold;
if(r.kind=='inside'&&i.start.column!=t&&i.start.row!=e)
window.console&&window.console.log(e,t,i);
else if(i.start.row==e){
s=this.folds;
var o=s.indexOf(i);
o==0&&(this.start.column+=n);
for(o;o<s.length;o++){
i=s[o],i.start.column+=n;
if(!i.sameRow)
return;
i.end.column+=n
}
this.end.column+=n
}
}
},this.split=function(e,t){
var n=this.getNextFoldTo(e,t).fold,r=this.folds,s=this.foldData;
if(!n)
return null;
var o=r.indexOf(n),u=r[o-1];
this.end.row=u.end.row,this.end.column=u.end.column,r=r.splice(o,r.length-o);
var a=new i(s,r);
return s.splice(s.indexOf(this)+1,0,a),a
},this.merge=function(e){
var t=e.folds;
for(var n=0;n<t.length;n++)
this.addFold(t[n]);
var r=this.foldData;
r.splice(r.indexOf(e),1)
},this.toString=function(){
var e=[this.range.toString()+': ['];
return this.folds.forEach(function(t){
e.push('  '+t.toString())
}),e.push(']'),e.join('\n')
},this.idxToPosition=function(e){
var t=0,n;
for(var r=0;r<this.folds.length;r++){
var n=this.folds[r];
e-=n.start.column-t;
if(e<0)
return{
row:n.start.row,
column:n.start.column+e
};
e-=n.placeholder.length;
if(e<0)
return n.start;
t=n.end.column
}
return{
row:this.end.row,
column:this.end.column+e
}
}
}.call(i.prototype),t.FoldLine=i)
}),ace.define('ace/edit_session/fold',[
'require',
'exports',
'module',
'ace/range',
'ace/range_list',
'ace/lib/oop'
],function(e,t,n){
function u(e,t){
e.row-=t.row,e.row==0&&(e.column-=t.column)
}
function a(e,t){
u(e.start,t),u(e.end,t)
}
function f(e,t){
e.row==0&&(e.column+=t.column),e.row+=t.row
}
function l(e,t){
f(e.start,t),f(e.end,t)
}
var r=e('../range').Range,i=e('../range_list').RangeList,s=e('../lib/oop'),o=t.Fold=function(e,t){
this.foldLine=null,this.placeholder=t,this.range=e,this.start=e.start,this.end=e.end,this.sameRow=e.start.row==e.end.row,this.subFolds=this.ranges=[]
};
s.inherits(o,i),function(){
this.toString=function(){
return'"'+this.placeholder+'" '+this.range.toString()
},this.setFoldLine=function(e){
this.foldLine=e,this.subFolds.forEach(function(t){
t.setFoldLine(e)
})
},this.clone=function(){
var e=this.range.clone(),t=new o(e,this.placeholder);
return this.subFolds.forEach(function(e){
t.subFolds.push(e.clone())
}),t.collapseChildren=this.collapseChildren,t
},this.addSubFold=function(e){
if(this.range.isEqual(e))
return;
if(!this.range.containsRange(e))
throw new Error('A fold can\'t intersect already existing fold'+e.range+this.range);
a(e,this.start);
var t=e.start.row,n=e.start.column;
for(var r=0,i=-1;r<this.subFolds.length;r++){
i=this.subFolds[r].range.compare(t,n);
if(i!=1)
break
}
var s=this.subFolds[r];
if(i==0)
return s.addSubFold(e);
var t=e.range.end.row,n=e.range.end.column;
for(var o=r,i=-1;o<this.subFolds.length;o++){
i=this.subFolds[o].range.compare(t,n);
if(i!=1)
break
}
var u=this.subFolds[o];
if(i==0)
throw new Error('A fold can\'t intersect already existing fold'+e.range+this.range);
var f=this.subFolds.splice(r,o-r,e);
return e.setFoldLine(this.foldLine),e
},this.restoreRange=function(e){
return l(e,this.start)
}
}.call(o.prototype)
}),ace.define('ace/range_list',[
'require',
'exports',
'module',
'ace/range'
],function(e,t,n){
var r=e('./range').Range,i=r.comparePoints,s=function(){
this.ranges=[]
};
(function(){
this.comparePoints=i,this.pointIndex=function(e,t,n){
var r=this.ranges;
for(var s=n||0;s<r.length;s++){
var o=r[s],u=i(e,o.end);
if(u>0)
continue;
var a=i(e,o.start);
return u===0?t&&a!==0?-s-2:s:a>0||a===0&&!t?s:-s-1
}
return-s-1
},this.add=function(e){
var t=!e.isEmpty(),n=this.pointIndex(e.start,t);
n<0&&(n=-n-1);
var r=this.pointIndex(e.end,t,n);
return r<0?r=-r-1:r++,this.ranges.splice(n,r-n,e)
},this.addList=function(e){
var t=[];
for(var n=e.length;n--;)
t.push.call(t,this.add(e[n]));
return t
},this.substractPoint=function(e){
var t=this.pointIndex(e);
if(t>=0)
return this.ranges.splice(t,1)
},this.merge=function(){
var e=[],t=this.ranges;
t=t.sort(function(e,t){
return i(e.start,t.start)
});
var n=t[0],r;
for(var s=1;s<t.length;s++){
r=n,n=t[s];
var o=i(r.end,n.start);
if(o<0)
continue;
if(o==0&&!r.isEmpty()&&!n.isEmpty())
continue;
i(r.end,n.end)<0&&(r.end.row=n.end.row,r.end.column=n.end.column),t.splice(s,1),e.push(n),n=r,s--
}
return this.ranges=t,e
},this.contains=function(e,t){
return this.pointIndex({
row:e,
column:t
})>=0
},this.containsPoint=function(e){
return this.pointIndex(e)>=0
},this.rangeAtPoint=function(e){
var t=this.pointIndex(e);
if(t>=0)
return this.ranges[t]
},this.clipRows=function(e,t){
var n=this.ranges;
if(n[0].start.row>t||n[n.length-1].start.row<e)
return[];
var r=this.pointIndex({
row:e,
column:0
});
r<0&&(r=-r-1);
var i=this.pointIndex({
row:t,
column:0
},r);
i<0&&(i=-i-1);
var s=[];
for(var o=r;o<i;o++)
s.push(n[o]);
return s
},this.removeAll=function(){
return this.ranges.splice(0,this.ranges.length)
},this.attach=function(e){
this.session&&this.detach(),this.session=e,this.onChange=this.$onChange.bind(this),this.session.on('change',this.onChange)
},this.detach=function(){
if(!this.session)
return;
this.session.removeListener('change',this.onChange),this.session=null
},this.$onChange=function(e){
var t=e.data.range;
if(e.data.action[0]=='i')
var n=t.start,r=t.end;
else
var r=t.start,n=t.end;
var i=n.row,s=r.row,o=s-i,u=-n.column+r.column,a=this.ranges;
for(var f=0,l=a.length;f<l;f++){
var c=a[f];
if(c.end.row<i)
continue;
if(c.start.row>i)
break;
c.start.row==i&&c.start.column>=n.column&&(c.start.column!=n.column||!this.$insertRight)&&(c.start.column+=u,c.start.row+=o);
if(c.end.row==i&&c.end.column>=n.column){
if(c.end.column==n.column&&this.$insertRight)
continue;
c.end.column==n.column&&u>0&&f<l-1&&c.end.column>c.start.column&&c.end.column==a[f+1].start.column&&(c.end.column-=u),c.end.column+=u,c.end.row+=o
}
}
if(o!=0&&f<l)
for(;f<l;f++){
var c=a[f];
c.start.row+=o,c.end.row+=o
}
}
}.call(s.prototype),t.RangeList=s)
}),ace.define('ace/edit_session/bracket_match',[
'require',
'exports',
'module',
'ace/token_iterator',
'ace/range'
],function(e,t,n){
function s(){
this.findMatchingBracket=function(e,t){
if(e.column==0)
return null;
var n=t||this.getLine(e.row).charAt(e.column-1);
if(n=='')
return null;
var r=n.match(/([\(\[\{])|([\)\]\}])/);
return r?r[1]?this.$findClosingBracket(r[1],e):this.$findOpeningBracket(r[2],e):null
},this.getBracketRange=function(e){
var t=this.getLine(e.row),n=!0,r,s=t.charAt(e.column-1),o=s&&s.match(/([\(\[\{])|([\)\]\}])/);
o||(s=t.charAt(e.column),e={
row:e.row,
column:e.column+1
},o=s&&s.match(/([\(\[\{])|([\)\]\}])/),n=!1);
if(!o)
return null;
if(o[1]){
var u=this.$findClosingBracket(o[1],e);
if(!u)
return null;
r=i.fromPoints(e,u),n||(r.end.column++,r.start.column--),r.cursor=r.end
}else{
var u=this.$findOpeningBracket(o[2],e);
if(!u)
return null;
r=i.fromPoints(u,e),n||(r.start.column++,r.end.column--),r.cursor=r.start
}
return r
},this.$brackets={
')':'(',
'(':')',
']':'[',
'[':']',
'{':'}',
'}':'{'
},this.$findOpeningBracket=function(e,t,n){
var i=this.$brackets[e],s=1,o=new r(this,t.row,t.column),u=o.getCurrentToken();
u||(u=o.stepForward());
if(!u)
return;
n||(n=new RegExp('(\\.?'+u.type.replace('.','\\.').replace('rparen','.paren')+')+'));
var a=t.column-o.getCurrentTokenColumn()-2,f=u.value;
for(;;){
while(a>=0){
var l=f.charAt(a);
if(l==i){
s-=1;
if(s==0)
return{
row:o.getCurrentTokenRow(),
column:a+o.getCurrentTokenColumn()
}
}else
l==e&&(s+=1);
a-=1
}
do
u=o.stepBackward();
while(u&&!n.test(u.type));
if(u==null)
break;
f=u.value,a=f.length-1
}
return null
},this.$findClosingBracket=function(e,t,n){
var i=this.$brackets[e],s=1,o=new r(this,t.row,t.column),u=o.getCurrentToken();
u||(u=o.stepForward());
if(!u)
return;
n||(n=new RegExp('(\\.?'+u.type.replace('.','\\.').replace('lparen','.paren')+')+'));
var a=t.column-o.getCurrentTokenColumn();
for(;;){
var f=u.value,l=f.length;
while(a<l){
var c=f.charAt(a);
if(c==i){
s-=1;
if(s==0)
return{
row:o.getCurrentTokenRow(),
column:a+o.getCurrentTokenColumn()
}
}else
c==e&&(s+=1);
a+=1
}
do
u=o.stepForward();
while(u&&!n.test(u.type));
if(u==null)
break;
a=0
}
return null
}
}
var r=e('../token_iterator').TokenIterator,i=e('../range').Range;
t.BracketMatch=s
}),ace.define('ace/search',[
'require',
'exports',
'module',
'ace/lib/lang',
'ace/lib/oop',
'ace/range'
],function(e,t,n){
var r=e('./lib/lang'),i=e('./lib/oop'),s=e('./range').Range,o=function(){
this.$options={}
};
(function(){
this.set=function(e){
return i.mixin(this.$options,e),this
},this.getOptions=function(){
return r.copyObject(this.$options)
},this.setOptions=function(e){
this.$options=e
},this.find=function(e){
var t=this.$matchIterator(e,this.$options);
if(!t)
return!1;
var n=null;
return t.forEach(function(e,t,r){
if(!e.start){
var i=e.offset+(r||0);
n=new s(t,i,t,i+e.length)
}else
n=e;
return!0
}),n
},this.findAll=function(e){
var t=this.$options;
if(!t.needle)
return[];
this.$assembleRegExp(t);
var n=t.range,i=n?e.getLines(n.start.row,n.end.row):e.doc.getAllLines(),o=[],u=t.re;
if(t.$isMultiLine){
var a=u.length,f=i.length-a;
for(var l=u.offset||0;l<=f;l++){
for(var c=0;c<a;c++)
if(i[l+c].search(u[c])==-1)
break;
var h=i[l],p=i[l+a-1],d=h.match(u[0])[0].length,v=p.match(u[a-1])[0].length;
o.push(new s(l,h.length-d,l+a-1,v))
}
}else
for(var m=0;m<i.length;m++){
var g=r.getMatchOffsets(i[m],u);
for(var c=0;c<g.length;c++){
var y=g[c];
o.push(new s(m,y.offset,m,y.offset+y.length))
}
}
if(n){
var b=n.start.column,w=n.start.column,m=0,c=o.length-1;
while(m<c&&o[m].start.column<b&&o[m].start.row==n.start.row)
m++;
while(m<c&&o[c].end.column>w&&o[c].end.row==n.end.row)
c--;
o=o.slice(m,c+1);
for(m=0,c=o.length;m<c;m++)
o[m].start.row+=n.start.row,o[m].end.row+=n.start.row
}
return o
},this.replace=function(e,t){
var n=this.$options,r=this.$assembleRegExp(n);
if(n.$isMultiLine)
return t;
if(!r)
return;
var i=r.exec(e);
if(!i||i[0].length!=e.length)
return null;
t=e.replace(r,t);
if(n.preserveCase){
t=t.split('');
for(var s=Math.min(e.length,e.length);s--;){
var o=e[s];
o&&o.toLowerCase()!=o?t[s]=t[s].toUpperCase():t[s]=t[s].toLowerCase()
}
t=t.join('')
}
return t
},this.$matchIterator=function(e,t){
var n=this.$assembleRegExp(t);
if(!n)
return!1;
var i=this,o,u=t.backwards;
if(t.$isMultiLine)
var a=n.length,f=function(t,r,i){
var u=t.search(n[0]);
if(u==-1)
return;
for(var f=1;f<a;f++){
t=e.getLine(r+f);
if(t.search(n[f])==-1)
return
}
var l=t.match(n[a-1])[0].length,c=new s(r,u,r+a-1,l);
n.offset==1?(c.start.row--,c.start.column=Number.MAX_VALUE):i&&(c.start.column+=i);
if(o(c))
return!0
};
else if(u)
var f=function(e,t,i){
var s=r.getMatchOffsets(e,n);
for(var u=s.length-1;u>=0;u--)
if(o(s[u],t,i))
return!0
};
else
var f=function(e,t,i){
var s=r.getMatchOffsets(e,n);
for(var u=0;u<s.length;u++)
if(o(s[u],t,i))
return!0
};
return{
forEach:function(n){
o=n,i.$lineIterator(e,t).forEach(f)
}
}
},this.$assembleRegExp=function(e,t){
if(e.needle instanceof RegExp)
return e.re=e.needle;
var n=e.needle;
if(!e.needle)
return e.re=!1;
e.regExp||(n=r.escapeRegExp(n)),e.wholeWord&&(n='\\b'+n+'\\b');
var i=e.caseSensitive?'g':'gi';
e.$isMultiLine=!t&&/[\n\r]/.test(n);
if(e.$isMultiLine)
return e.re=this.$assembleMultilineRegExp(n,i);
try{
var s=new RegExp(n,i)
}catch(o){
s=!1
}
return e.re=s
},this.$assembleMultilineRegExp=function(e,t){
var n=e.replace(/\r\n|\r|\n/g,'$\n^').split('\n'),r=[];
for(var i=0;i<n.length;i++)
try{
r.push(new RegExp(n[i],t))
}catch(s){
return!1
}
return n[0]==''?(r.shift(),r.offset=1):r.offset=0,r
},this.$lineIterator=function(e,t){
var n=t.backwards==1,r=t.skipCurrent!=0,i=t.range,s=t.start;
s||(s=i?i[n?'end':'start']:e.selection.getRange()),s.start&&(s=s[r!=n?'end':'start']);
var o=i?i.start.row:0,u=i?i.end.row:e.getLength()-1,a=n?function(n){
var r=s.row,i=e.getLine(r).substring(0,s.column);
if(n(i,r))
return;
for(r--;r>=o;r--)
if(n(e.getLine(r),r))
return;
if(t.wrap==0)
return;
for(r=u,o=s.row;r>=o;r--)
if(n(e.getLine(r),r))
return
}:function(n){
var r=s.row,i=e.getLine(r).substr(s.column);
if(n(i,r,s.column))
return;
for(r+=1;r<=u;r++)
if(n(e.getLine(r),r))
return;
if(t.wrap==0)
return;
for(r=o,u=s.row;r<=u;r++)
if(n(e.getLine(r),r))
return
};
return{forEach:a}
}
}.call(o.prototype),t.Search=o)
}),ace.define('ace/commands/command_manager',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/keyboard/hash_handler',
'ace/lib/event_emitter'
],function(e,t,n){
var r=e('../lib/oop'),i=e('../keyboard/hash_handler').HashHandler,s=e('../lib/event_emitter').EventEmitter,o=function(e,t){
i.call(this,t,e),this.byName=this.commands,this.setDefaultHandler('exec',function(e){
return e.command.exec(e.editor,e.args||{})
})
};
r.inherits(o,i),function(){
r.implement(this,s),this.exec=function(e,t,n){
typeof e=='string'&&(e=this.commands[e]);
if(!e)
return!1;
if(t&&t.$readOnly&&!e.readOnly)
return!1;
var r={
editor:t,
command:e,
args:n
},i=this._emit('exec',r);
return this._signal('afterExec',r),i===!1?!1:!0
},this.toggleRecording=function(e){
if(this.$inReplay)
return;
return e&&e._emit('changeStatus'),this.recording?(this.macro.pop(),this.removeEventListener('exec',this.$addCommandToMacro),this.macro.length||(this.macro=this.oldMacro),this.recording=!1):(this.$addCommandToMacro||(this.$addCommandToMacro=function(e){
this.macro.push([
e.command,
e.args
])
}.bind(this)),this.oldMacro=this.macro,this.macro=[],this.on('exec',this.$addCommandToMacro),this.recording=!0)
},this.replay=function(e){
if(this.$inReplay||!this.macro)
return;
if(this.recording)
return this.toggleRecording(e);
try{
this.$inReplay=!0,this.macro.forEach(function(t){
typeof t=='string'?this.exec(t,e):this.exec(t[0],e,t[1])
},this)
}finally{
this.$inReplay=!1
}
},this.trimMacro=function(e){
return e.map(function(e){
return typeof e[0]!='string'&&(e[0]=e[0].name),e[1]||(e=e[0]),e
})
}
}.call(o.prototype),t.CommandManager=o
}),ace.define('ace/keyboard/hash_handler',[
'require',
'exports',
'module',
'ace/lib/keys',
'ace/lib/useragent'
],function(e,t,n){
function s(e,t){
this.platform=t||(i.isMac?'mac':'win'),this.commands={},this.commandKeyBinding={};
if(this.__defineGetter__&&this.__defineSetter__&&typeof console!='undefined'&&console.error){
var n=!1,r=function(){
n||(n=!0,console.error('commmandKeyBinding has too many m\'s. use commandKeyBinding'))
};
this.__defineGetter__('commmandKeyBinding',function(){
return r(),this.commandKeyBinding
}),this.__defineSetter__('commmandKeyBinding',function(e){
return r(),this.commandKeyBinding=e
})
}else
this.commmandKeyBinding=this.commandKeyBinding;
this.addCommands(e)
}
var r=e('../lib/keys'),i=e('../lib/useragent');
(function(){
this.addCommand=function(e){
this.commands[e.name]&&this.removeCommand(e),this.commands[e.name]=e,e.bindKey&&this._buildKeyHash(e)
},this.removeCommand=function(e){
var t=typeof e=='string'?e:e.name;
e=this.commands[t],delete this.commands[t];
var n=this.commandKeyBinding;
for(var r in n)
for(var i in n[r])
n[r][i]==e&&delete n[r][i]
},this.bindKey=function(e,t){
if(!e)
return;
if(typeof t=='function'){
this.addCommand({
exec:t,
bindKey:e,
name:t.name||e
});
return
}
var n=this.commandKeyBinding;
e.split('|').forEach(function(e){
var r=this.parseKeys(e,t),i=r.hashId;
(n[i]||(n[i]={}))[r.key]=t
},this)
},this.addCommands=function(e){
e&&Object.keys(e).forEach(function(t){
var n=e[t];
if(!n)
return;
if(typeof n=='string')
return this.bindKey(n,t);
typeof n=='function'&&(n={exec:n});
if(typeof n!='object')
return;
n.name||(n.name=t),this.addCommand(n)
},this)
},this.removeCommands=function(e){
Object.keys(e).forEach(function(t){
this.removeCommand(e[t])
},this)
},this.bindKeys=function(e){
Object.keys(e).forEach(function(t){
this.bindKey(t,e[t])
},this)
},this._buildKeyHash=function(e){
var t=e.bindKey;
if(!t)
return;
var n=typeof t=='string'?t:t[this.platform];
this.bindKey(n,e)
},this.parseKeys=function(e){
e.indexOf(' ')!=-1&&(e=e.split(/\s+/).pop());
var t=e.toLowerCase().split(/[\-\+]([\-\+])?/).filter(function(e){
return e
}),n=t.pop(),i=r[n];
if(r.FUNCTION_KEYS[i])
n=r.FUNCTION_KEYS[i].toLowerCase();
else{
if(!t.length)
return{
key:n,
hashId:-1
};
if(t.length==1&&t[0]=='shift')
return{
key:n.toUpperCase(),
hashId:-1
}
}
var s=0;
for(var o=t.length;o--;){
var u=r.KEY_MODS[t[o]];
if(u==null)
return typeof console!='undefined'&&console.error('invalid modifier '+t[o]+' in '+e),!1;
s|=u
}
return{
key:n,
hashId:s
}
},this.findKeyCommand=function(t,n){
var r=this.commandKeyBinding;
return r[t]&&r[t][n]
},this.handleKeyboard=function(e,t,n,r){
return{command:this.findKeyCommand(t,n)}
}
}.call(s.prototype),t.HashHandler=s)
}),ace.define('ace/commands/default_commands',[
'require',
'exports',
'module',
'ace/lib/lang',
'ace/config'
],function(e,t,n){
function s(e,t){
return{
win:e,
mac:t
}
}
var r=e('../lib/lang'),i=e('../config');
t.commands=[
{
name:'showSettingsMenu',
bindKey:s('Ctrl-,','Command-,'),
exec:function(e){
i.loadModule('ace/ext/settings_menu',function(t){
t.init(e),e.showSettingsMenu()
})
},
readOnly:!0
},
{
name:'selectall',
bindKey:s('Ctrl-A','Command-A'),
exec:function(e){
e.selectAll()
},
readOnly:!0
},
{
name:'centerselection',
bindKey:s(null,'Ctrl-L'),
exec:function(e){
e.centerSelection()
},
readOnly:!0
},
{
name:'gotoline',
bindKey:s('Ctrl-L','Command-L'),
exec:function(e){
var t=parseInt(prompt('Enter line number:'),10);
isNaN(t)||e.gotoLine(t)
},
readOnly:!0
},
{
name:'fold',
bindKey:s('Alt-L|Ctrl-F1','Command-Alt-L|Command-F1'),
exec:function(e){
e.session.toggleFold(!1)
},
scrollIntoView:'center',
readOnly:!0
},
{
name:'unfold',
bindKey:s('Alt-Shift-L|Ctrl-Shift-F1','Command-Alt-Shift-L|Command-Shift-F1'),
exec:function(e){
e.session.toggleFold(!0)
},
scrollIntoView:'center',
readOnly:!0
},
{
name:'toggleFoldWidget',
bindKey:s('F2','F2'),
exec:function(e){
e.session.toggleFoldWidget()
},
scrollIntoView:'center',
readOnly:!0
},
{
name:'toggleParentFoldWidget',
bindKey:s('Alt-F2','Alt-F2'),
exec:function(e){
e.session.toggleFoldWidget(!0)
},
scrollIntoView:'center',
readOnly:!0
},
{
name:'foldall',
bindKey:s('Ctrl-Alt-0','Ctrl-Command-Option-0'),
exec:function(e){
e.session.foldAll()
},
scrollIntoView:'center',
readOnly:!0
},
{
name:'foldOther',
bindKey:s('Alt-0','Command-Option-0'),
exec:function(e){
e.session.foldAll(),e.session.unfold(e.selection.getAllRanges())
},
scrollIntoView:'center',
readOnly:!0
},
{
name:'unfoldall',
bindKey:s('Alt-Shift-0','Command-Option-Shift-0'),
exec:function(e){
e.session.unfold()
},
scrollIntoView:'center',
readOnly:!0
},
{
name:'findnext',
bindKey:s('Ctrl-K','Command-G'),
exec:function(e){
e.findNext()
},
readOnly:!0
},
{
name:'findprevious',
bindKey:s('Ctrl-Shift-K','Command-Shift-G'),
exec:function(e){
e.findPrevious()
},
readOnly:!0
},
{
name:'find',
bindKey:s('Ctrl-F','Command-F'),
exec:function(e){
i.loadModule('ace/ext/searchbox',function(t){
t.Search(e)
})
},
readOnly:!0
},
{
name:'overwrite',
bindKey:'Insert',
exec:function(e){
e.toggleOverwrite()
},
readOnly:!0
},
{
name:'selecttostart',
bindKey:s('Ctrl-Shift-Home','Command-Shift-Up'),
exec:function(e){
e.getSelection().selectFileStart()
},
multiSelectAction:'forEach',
readOnly:!0,
group:'fileJump'
},
{
name:'gotostart',
bindKey:s('Ctrl-Home','Command-Home|Command-Up'),
exec:function(e){
e.navigateFileStart()
},
multiSelectAction:'forEach',
readOnly:!0,
group:'fileJump'
},
{
name:'selectup',
bindKey:s('Shift-Up','Shift-Up'),
exec:function(e){
e.getSelection().selectUp()
},
multiSelectAction:'forEach',
readOnly:!0
},
{
name:'golineup',
bindKey:s('Up','Up|Ctrl-P'),
exec:function(e,t){
e.navigateUp(t.times)
},
multiSelectAction:'forEach',
readOnly:!0
},
{
name:'selecttoend',
bindKey:s('Ctrl-Shift-End','Command-Shift-Down'),
exec:function(e){
e.getSelection().selectFileEnd()
},
multiSelectAction:'forEach',
readOnly:!0,
group:'fileJump'
},
{
name:'gotoend',
bindKey:s('Ctrl-End','Command-End|Command-Down'),
exec:function(e){
e.navigateFileEnd()
},
multiSelectAction:'forEach',
readOnly:!0,
group:'fileJump'
},
{
name:'selectdown',
bindKey:s('Shift-Down','Shift-Down'),
exec:function(e){
e.getSelection().selectDown()
},
multiSelectAction:'forEach',
readOnly:!0
},
{
name:'golinedown',
bindKey:s('Down','Down|Ctrl-N'),
exec:function(e,t){
e.navigateDown(t.times)
},
multiSelectAction:'forEach',
readOnly:!0
},
{
name:'selectwordleft',
bindKey:s('Ctrl-Shift-Left','Option-Shift-Left'),
exec:function(e){
e.getSelection().selectWordLeft()
},
multiSelectAction:'forEach',
readOnly:!0
},
{
name:'gotowordleft',
bindKey:s('Ctrl-Left','Option-Left'),
exec:function(e){
e.navigateWordLeft()
},
multiSelectAction:'forEach',
readOnly:!0
},
{
name:'selecttolinestart',
bindKey:s('Alt-Shift-Left','Command-Shift-Left'),
exec:function(e){
e.getSelection().selectLineStart()
},
multiSelectAction:'forEach',
readOnly:!0
},
{
name:'gotolinestart',
bindKey:s('Alt-Left|Home','Command-Left|Home|Ctrl-A'),
exec:function(e){
e.navigateLineStart()
},
multiSelectAction:'forEach',
readOnly:!0
},
{
name:'selectleft',
bindKey:s('Shift-Left','Shift-Left'),
exec:function(e){
e.getSelection().selectLeft()
},
multiSelectAction:'forEach',
readOnly:!0
},
{
name:'gotoleft',
bindKey:s('Left','Left|Ctrl-B'),
exec:function(e,t){
e.navigateLeft(t.times)
},
multiSelectAction:'forEach',
readOnly:!0
},
{
name:'selectwordright',
bindKey:s('Ctrl-Shift-Right','Option-Shift-Right'),
exec:function(e){
e.getSelection().selectWordRight()
},
multiSelectAction:'forEach',
readOnly:!0
},
{
name:'gotowordright',
bindKey:s('Ctrl-Right','Option-Right'),
exec:function(e){
e.navigateWordRight()
},
multiSelectAction:'forEach',
readOnly:!0
},
{
name:'selecttolineend',
bindKey:s('Alt-Shift-Right','Command-Shift-Right'),
exec:function(e){
e.getSelection().selectLineEnd()
},
multiSelectAction:'forEach',
readOnly:!0
},
{
name:'gotolineend',
bindKey:s('Alt-Right|End','Command-Right|End|Ctrl-E'),
exec:function(e){
e.navigateLineEnd()
},
multiSelectAction:'forEach',
readOnly:!0
},
{
name:'selectright',
bindKey:s('Shift-Right','Shift-Right'),
exec:function(e){
e.getSelection().selectRight()
},
multiSelectAction:'forEach',
readOnly:!0
},
{
name:'gotoright',
bindKey:s('Right','Right|Ctrl-F'),
exec:function(e,t){
e.navigateRight(t.times)
},
multiSelectAction:'forEach',
readOnly:!0
},
{
name:'selectpagedown',
bindKey:'Shift-PageDown',
exec:function(e){
e.selectPageDown()
},
readOnly:!0
},
{
name:'pagedown',
bindKey:s(null,'Option-PageDown'),
exec:function(e){
e.scrollPageDown()
},
readOnly:!0
},
{
name:'gotopagedown',
bindKey:s('PageDown','PageDown|Ctrl-V'),
exec:function(e){
e.gotoPageDown()
},
readOnly:!0
},
{
name:'selectpageup',
bindKey:'Shift-PageUp',
exec:function(e){
e.selectPageUp()
},
readOnly:!0
},
{
name:'pageup',
bindKey:s(null,'Option-PageUp'),
exec:function(e){
e.scrollPageUp()
},
readOnly:!0
},
{
name:'gotopageup',
bindKey:'PageUp',
exec:function(e){
e.gotoPageUp()
},
readOnly:!0
},
{
name:'scrollup',
bindKey:s('Ctrl-Up',null),
exec:function(e){
e.renderer.scrollBy(0,-2*e.renderer.layerConfig.lineHeight)
},
readOnly:!0
},
{
name:'scrolldown',
bindKey:s('Ctrl-Down',null),
exec:function(e){
e.renderer.scrollBy(0,2*e.renderer.layerConfig.lineHeight)
},
readOnly:!0
},
{
name:'selectlinestart',
bindKey:'Shift-Home',
exec:function(e){
e.getSelection().selectLineStart()
},
multiSelectAction:'forEach',
readOnly:!0
},
{
name:'selectlineend',
bindKey:'Shift-End',
exec:function(e){
e.getSelection().selectLineEnd()
},
multiSelectAction:'forEach',
readOnly:!0
},
{
name:'togglerecording',
bindKey:s('Ctrl-Alt-E','Command-Option-E'),
exec:function(e){
e.commands.toggleRecording(e)
},
readOnly:!0
},
{
name:'replaymacro',
bindKey:s('Ctrl-Shift-E','Command-Shift-E'),
exec:function(e){
e.commands.replay(e)
},
readOnly:!0
},
{
name:'jumptomatching',
bindKey:s('Ctrl-P','Ctrl-Shift-P'),
exec:function(e){
e.jumpToMatching()
},
multiSelectAction:'forEach',
readOnly:!0
},
{
name:'selecttomatching',
bindKey:s('Ctrl-Shift-P',null),
exec:function(e){
e.jumpToMatching(!0)
},
multiSelectAction:'forEach',
readOnly:!0
},
{
name:'cut',
exec:function(e){
var t=e.getSelectionRange();
e._emit('cut',t),e.selection.isEmpty()||(e.session.remove(t),e.clearSelection())
},
multiSelectAction:'forEach'
},
{
name:'removeline',
bindKey:s('Ctrl-D','Command-D'),
exec:function(e){
e.removeLines()
},
multiSelectAction:'forEachLine'
},
{
name:'duplicateSelection',
bindKey:s('Ctrl-Shift-D','Command-Shift-D'),
exec:function(e){
e.duplicateSelection()
},
multiSelectAction:'forEach'
},
{
name:'sortlines',
bindKey:s('Ctrl-Alt-S','Command-Alt-S'),
exec:function(e){
e.sortLines()
},
multiSelectAction:'forEachLine'
},
{
name:'togglecomment',
bindKey:s('Ctrl-/','Command-/'),
exec:function(e){
e.toggleCommentLines()
},
multiSelectAction:'forEachLine',
scrollIntoView:'selectionPart'
},
{
name:'toggleBlockComment',
bindKey:s('Ctrl-Shift-/','Command-Shift-/'),
exec:function(e){
e.toggleBlockComment()
},
multiSelectAction:'forEach'
},
{
name:'modifyNumberUp',
bindKey:s('Ctrl-Shift-Up','Alt-Shift-Up'),
exec:function(e){
e.modifyNumber(1)
},
multiSelectAction:'forEach'
},
{
name:'modifyNumberDown',
bindKey:s('Ctrl-Shift-Down','Alt-Shift-Down'),
exec:function(e){
e.modifyNumber(-1)
},
multiSelectAction:'forEach'
},
{
name:'replace',
bindKey:s('Ctrl-H','Command-Option-F'),
exec:function(e){
i.loadModule('ace/ext/searchbox',function(t){
t.Search(e,!0)
})
}
},
{
name:'undo',
bindKey:s('Ctrl-Z','Command-Z'),
exec:function(e){
e.undo()
}
},
{
name:'redo',
bindKey:s('Ctrl-Shift-Z|Ctrl-Y','Command-Shift-Z|Command-Y'),
exec:function(e){
e.redo()
}
},
{
name:'copylinesup',
bindKey:s('Alt-Shift-Up','Command-Option-Up'),
exec:function(e){
e.copyLinesUp()
}
},
{
name:'movelinesup',
bindKey:s('Alt-Up','Option-Up'),
exec:function(e){
e.moveLinesUp()
}
},
{
name:'copylinesdown',
bindKey:s('Alt-Shift-Down','Command-Option-Down'),
exec:function(e){
e.copyLinesDown()
}
},
{
name:'movelinesdown',
bindKey:s('Alt-Down','Option-Down'),
exec:function(e){
e.moveLinesDown()
}
},
{
name:'del',
bindKey:s('Delete','Delete|Ctrl-D|Shift-Delete'),
exec:function(e){
e.remove('right')
},
multiSelectAction:'forEach'
},
{
name:'backspace',
bindKey:s('Shift-Backspace|Backspace','Ctrl-Backspace|Shift-Backspace|Backspace|Ctrl-H'),
exec:function(e){
e.remove('left')
},
multiSelectAction:'forEach'
},
{
name:'cut_or_delete',
bindKey:s('Shift-Delete',null),
exec:function(e){
if(!e.selection.isEmpty())
return!1;
e.remove('left')
},
multiSelectAction:'forEach'
},
{
name:'removetolinestart',
bindKey:s('Alt-Backspace','Command-Backspace'),
exec:function(e){
e.removeToLineStart()
},
multiSelectAction:'forEach'
},
{
name:'removetolineend',
bindKey:s('Alt-Delete','Ctrl-K'),
exec:function(e){
e.removeToLineEnd()
},
multiSelectAction:'forEach'
},
{
name:'removewordleft',
bindKey:s('Ctrl-Backspace','Alt-Backspace|Ctrl-Alt-Backspace'),
exec:function(e){
e.removeWordLeft()
},
multiSelectAction:'forEach'
},
{
name:'removewordright',
bindKey:s('Ctrl-Delete','Alt-Delete'),
exec:function(e){
e.removeWordRight()
},
multiSelectAction:'forEach'
},
{
name:'outdent',
bindKey:s('Shift-Tab','Shift-Tab'),
exec:function(e){
e.blockOutdent()
},
multiSelectAction:'forEach',
scrollIntoView:'selectionPart'
},
{
name:'indent',
bindKey:s('Tab','Tab'),
exec:function(e){
e.indent()
},
multiSelectAction:'forEach',
scrollIntoView:'selectionPart'
},
{
name:'blockoutdent',
bindKey:s('Ctrl-[','Ctrl-['),
exec:function(e){
e.blockOutdent()
},
multiSelectAction:'forEachLine',
scrollIntoView:'selectionPart'
},
{
name:'blockindent',
bindKey:s('Ctrl-]','Ctrl-]'),
exec:function(e){
e.blockIndent()
},
multiSelectAction:'forEachLine',
scrollIntoView:'selectionPart'
},
{
name:'insertstring',
exec:function(e,t){
e.insert(t)
},
multiSelectAction:'forEach',
scrollIntoView:'cursor'
},
{
name:'inserttext',
exec:function(e,t){
e.insert(r.stringRepeat(t.text||'',t.times||1))
},
multiSelectAction:'forEach'
},
{
name:'splitline',
bindKey:s(null,'Ctrl-O'),
exec:function(e){
e.splitLine()
},
multiSelectAction:'forEach'
},
{
name:'transposeletters',
bindKey:s('Ctrl-T','Ctrl-T'),
exec:function(e){
e.transposeLetters()
},
multiSelectAction:function(e){
e.transposeSelections(1)
}
},
{
name:'touppercase',
bindKey:s('Ctrl-U','Ctrl-U'),
exec:function(e){
e.toUpperCase()
},
multiSelectAction:'forEach'
},
{
name:'tolowercase',
bindKey:s('Ctrl-Shift-U','Ctrl-Shift-U'),
exec:function(e){
e.toLowerCase()
},
multiSelectAction:'forEach'
}
]
}),ace.define('ace/undomanager',[
'require',
'exports',
'module'
],function(e,t,n){
var r=function(){
this.reset()
};
(function(){
this.execute=function(e){
var t=e.args[0];
this.$doc=e.args[1],e.merge&&this.hasUndo()&&(t=this.$undoStack.pop().concat(t)),this.$undoStack.push(t),this.$redoStack=[],this.dirtyCounter<0&&(this.dirtyCounter=NaN),this.dirtyCounter++
},this.undo=function(e){
var t=this.$undoStack.pop(),n=null;
return t&&(n=this.$doc.undoChanges(t,e),this.$redoStack.push(t),this.dirtyCounter--),n
},this.redo=function(e){
var t=this.$redoStack.pop(),n=null;
return t&&(n=this.$doc.redoChanges(t,e),this.$undoStack.push(t),this.dirtyCounter++),n
},this.reset=function(){
this.$undoStack=[],this.$redoStack=[],this.dirtyCounter=0
},this.hasUndo=function(){
return this.$undoStack.length>0
},this.hasRedo=function(){
return this.$redoStack.length>0
},this.markClean=function(){
this.dirtyCounter=0
},this.isClean=function(){
return this.dirtyCounter===0
}
}.call(r.prototype),t.UndoManager=r)
}),ace.define('ace/virtual_renderer',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/lib/dom',
'ace/lib/useragent',
'ace/config',
'ace/layer/gutter',
'ace/layer/marker',
'ace/layer/text',
'ace/layer/cursor',
'ace/scrollbar',
'ace/renderloop',
'ace/lib/event_emitter'
],function(e,t,n){
var r=e('./lib/oop'),i=e('./lib/dom'),s=e('./lib/useragent'),o=e('./config'),u=e('./layer/gutter').Gutter,a=e('./layer/marker').Marker,f=e('./layer/text').Text,l=e('./layer/cursor').Cursor,c=e('./scrollbar').ScrollBarH,h=e('./scrollbar').ScrollBarV,p=e('./renderloop').RenderLoop,d=e('./lib/event_emitter').EventEmitter,v='.ace_editor {position: relative;overflow: hidden;font-family: \'Monaco\', \'Menlo\', \'Ubuntu Mono\', \'Consolas\', \'source-code-pro\', monospace;font-size: 12px;line-height: normal;color: black;-ms-user-select: none;-moz-user-select: none;-webkit-user-select: none;user-select: none;}.ace_scroller {position: absolute;overflow: hidden;top: 0;bottom: 0;background-color: inherit;}.ace_content {position: absolute;-moz-box-sizing: border-box;-webkit-box-sizing: border-box;box-sizing: border-box;cursor: text;}.ace_dragging, .ace_dragging * {cursor: move !important;}.ace_dragging .ace_scroller:before{position: absolute;top: 0;left: 0;right: 0;bottom: 0;content: \'\';background: rgba(250, 250, 250, 0.01);z-index: 1000;}.ace_dragging.ace_dark .ace_scroller:before{background: rgba(0, 0, 0, 0.01);}.ace_selecting, .ace_selecting * {cursor: text !important;}.ace_gutter {position: absolute;overflow : hidden;width: auto;top: 0;bottom: 0;left: 0;cursor: default;z-index: 4;}.ace_gutter-active-line {position: absolute;left: 0;right: 0;}.ace_scroller.ace_scroll-left {box-shadow: 17px 0 16px -16px rgba(0, 0, 0, 0.4) inset;}.ace_gutter-cell {padding-left: 19px;padding-right: 6px;background-repeat: no-repeat;}.ace_gutter-cell.ace_error {background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6QUM2OEZDQTQ4RTU0MTFFMUEzM0VFRTM2RUY1M0RBMjYiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6QUM2OEZDQTU4RTU0MTFFMUEzM0VFRTM2RUY1M0RBMjYiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpBQzY4RkNBMjhFNTQxMUUxQTMzRUVFMzZFRjUzREEyNiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpBQzY4RkNBMzhFNTQxMUUxQTMzRUVFMzZFRjUzREEyNiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PkgXxbAAAAJbSURBVHjapFNNaBNBFH4zs5vdZLP5sQmNpT82QY209heh1ioWisaDRcSKF0WKJ0GQnrzrxasHsR6EnlrwD0TagxJabaVEpFYxLWlLSS822tr87m66ccfd2GKyVhA6MMybgfe97/vmPUQphd0sZjto9XIn9OOsvlu2nkqRzVU+6vvlzPf8W6bk8dxQ0NPbxAALgCgg2JkaQuhzQau/El0zbmUA7U0Es8v2CiYmKQJHGO1QICCLoqilMhkmurDAyapKgqItezi/USRdJqEYY4D5jCy03ht2yMkkvL91jTTX10qzyyu2hruPRN7jgbH+EOsXcMLgYiThEgAMhABW85oqy1DXdRIdvP1AHJ2acQXvDIrVHcdQNrEKNYSVMSZGMjEzIIAwDXIo+6G/FxcGnzkC3T2oMhLjre49sBB+RRcHLqdafK6sYdE/GGBwU1VpFNj0aN8pJbe+BkZyevUrvLl6Xmm0W9IuTc0DxrDNAJd5oEvI/KRsNC3bQyNjPO9yQ1YHcfj2QvfQc/5TUhJTBc2iM0U7AWDQtc1nJHvD/cfO2s7jaGkiTEfa/Ep8coLu7zmNmh8+dc5lZDuUeFAGUNA/OY6JVaypQ0vjr7XYjUvJM37vt+j1vuTK5DgVfVUoTjVe+y3/LxMxY2GgU+CSLy4cpfsYorRXuXIOi0Vt40h67uZFTdIo6nLaZcwUJWAzwNS0tBnqqKzQDnjdG/iPyZxo46HaKUpbvYkj8qYRTZsBhge+JHhZyh0x9b95JqjVJkT084kZIPwu/mPWqPgfQ5jXh2+92Ay7HedfAgwA6KDWafb4w3cAAAAASUVORK5CYII=");background-repeat: no-repeat;background-position: 2px center;}.ace_gutter-cell.ace_warning {background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6QUM2OEZDQTg4RTU0MTFFMUEzM0VFRTM2RUY1M0RBMjYiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6QUM2OEZDQTk4RTU0MTFFMUEzM0VFRTM2RUY1M0RBMjYiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpBQzY4RkNBNjhFNTQxMUUxQTMzRUVFMzZFRjUzREEyNiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpBQzY4RkNBNzhFNTQxMUUxQTMzRUVFMzZFRjUzREEyNiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pgd7PfIAAAGmSURBVHjaYvr//z8DJZiJgUIANoCRkREb9gLiSVAaQx4OQM7AAkwd7XU2/v++/rOttdYGEB9dASEvOMydGKfH8Gv/p4XTkvRBfLxeQAP+1cUhXopyvzhP7P/IoSj7g7Mw09cNKO6J1QQ0L4gICPIv/veg/8W+JdFvQNLHVsW9/nmn9zk7B+cCkDwhL7gt6knSZnx9/LuCEOcvkIAMP+cvto9nfqyZmmUAksfnBUtbM60gX/3/kgyv3/xSFOL5DZT+L8vP+Yfh5cvfPvp/xUHyQHXGyAYwgpwBjZYFT3Y1OEl/OfCH4ffv3wzc4iwMvNIsDJ+f/mH4+vIPAxsb631WW0Yln6ZpQLXdMK/DXGDflh+sIv37EivD5x//Gb7+YWT4y86sl7BCCkSD+Z++/1dkvsFRl+HnD1Rvje4F8whjMXmGj58YGf5zsDMwcnAwfPvKcml62DsQDeaDxN+/Y0qwlpEHqrdB94IRNIDUgfgfKJChGK4OikEW3gTiXUB950ASLFAF54AC94A0G9QAfOnmF9DCDzABFqS08IHYDIScdijOjQABBgC+/9awBH96jwAAAABJRU5ErkJggg==");background-position: 2px center;}.ace_gutter-cell.ace_info {background-image: url("data:image/gif;base64,R0lGODlhEAAQAMQAAAAAAEFBQVJSUl5eXmRkZGtra39/f4WFhYmJiZGRkaampry8vMPDw8zMzNXV1dzc3OTk5Orq6vDw8P///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABQALAAAAAAQABAAAAUuICWOZGmeaBml5XGwFCQSBGyXRSAwtqQIiRuiwIM5BoYVbEFIyGCQoeJGrVptIQA7");background-position: 2px center;}.ace_dark .ace_gutter-cell.ace_info {background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpGRTk5MTVGREIxNDkxMUUxOTc5Q0FFREQyMTNGMjBFQyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpGRTk5MTVGRUIxNDkxMUUxOTc5Q0FFREQyMTNGMjBFQyI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZFOTkxNUZCQjE0OTExRTE5NzlDQUVERDIxM0YyMEVDIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOkZFOTkxNUZDQjE0OTExRTE5NzlDQUVERDIxM0YyMEVDIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+SIDkjAAAAJ1JREFUeNpi/P//PwMlgImBQkB7A6qrq/+DMC55FkIGKCoq4pVnpFkgTp069f/+/fv/r1u37r+tre1/kg0A+ptn9uzZYLaRkRHpLvjw4cNXWVlZhufPnzOcO3eOdAO0tbVPAjHDmzdvGA4fPsxIsgGSkpJmv379Ynj37h2DjIyMCMkG3LhxQ/T27dsMampqDHZ2dq/pH41DxwCAAAMAFdc68dUsFZgAAAAASUVORK5CYII=");}.ace_scrollbar {position: absolute;overflow-x: hidden;overflow-y: auto;right: 0;top: 0;bottom: 0;z-index: 6;}.ace_scrollbar-inner {position: absolute;cursor: text;left: 0;top: 0;}.ace_scrollbar-h {position: absolute;overflow-x: auto;overflow-y: hidden;right: 0;left: 0;bottom: 0;z-index: 6;}.ace_print-margin {position: absolute;height: 100%;}.ace_text-input {position: absolute;z-index: 0;width: 0.5em;height: 1em;opacity: 0;background: transparent;-moz-appearance: none;appearance: none;border: none;resize: none;outline: none;overflow: hidden;font: inherit;padding: 0 1px;margin: 0 -1px;text-indent: -1em;-ms-user-select: text;-moz-user-select: text;-webkit-user-select: text;user-select: text;}.ace_text-input.ace_composition {background: #f8f8f8;color: #111;z-index: 1000;opacity: 1;text-indent: 0;}.ace_layer {z-index: 1;position: absolute;overflow: hidden;white-space: pre;height: 100%;width: 100%;-moz-box-sizing: border-box;-webkit-box-sizing: border-box;box-sizing: border-box;/* setting pointer-events: auto; on node under the mouse, which changesduring scroll, will break mouse wheel scrolling in Safari */pointer-events: none;}.ace_gutter-layer {position: relative;width: auto;text-align: right;pointer-events: auto;}.ace_text-layer {font: inherit !important;}.ace_cjk {display: inline-block;text-align: center;}.ace_cursor-layer {z-index: 4;}.ace_cursor {z-index: 4;position: absolute;-moz-box-sizing: border-box;-webkit-box-sizing: border-box;box-sizing: border-box;border-left: 2px solid}.ace_slim-cursors .ace_cursor {border-left-width: 1px;}.ace_overwrite-cursors .ace_cursor {border-left-width: 0px;border-bottom: 1px solid;}.ace_hidden-cursors .ace_cursor {opacity: 0.2;}.ace_smooth-blinking .ace_cursor {-moz-transition: opacity 0.18s;-webkit-transition: opacity 0.18s;-o-transition: opacity 0.18s;-ms-transition: opacity 0.18s;transition: opacity 0.18s;}.ace_cursor[style*="opacity: 0"]{-ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=0)";}.ace_editor.ace_multiselect .ace_cursor {border-left-width: 1px;}.ace_marker-layer .ace_step, .ace_marker-layer .ace_stack {position: absolute;z-index: 3;}.ace_marker-layer .ace_selection {position: absolute;z-index: 5;}.ace_marker-layer .ace_bracket {position: absolute;z-index: 6;}.ace_marker-layer .ace_active-line {position: absolute;z-index: 2;}.ace_marker-layer .ace_selected-word {position: absolute;z-index: 4;-moz-box-sizing: border-box;-webkit-box-sizing: border-box;box-sizing: border-box;}.ace_line .ace_fold {-moz-box-sizing: border-box;-webkit-box-sizing: border-box;box-sizing: border-box;display: inline-block;height: 11px;margin-top: -2px;vertical-align: middle;background-image:url("data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%11%00%00%00%09%08%06%00%00%00%D4%E8%C7%0C%00%00%03%1EiCCPICC%20Profile%00%00x%01%85T%DFk%D3P%14%FE%DAe%9D%B0%E1%8B%3Ag%11%09%3Eh%91ndStC%9C%B6kW%BA%CDZ%EA6%B7!H%9B%A6m%5C%9A%C6%24%ED~%B0%07%D9%8Bo%3A%C5w%F1%07%3E%F9%07%0C%D9%83o%7B%92%0D%C6%14a%F8%AC%88%22L%F6%22%B3%9E%9B4M\'S%03%B9%F7%BB%DF%F9%EE9\'%E7%E4%5E%A0%F9qZ%D3%14%2F%0F%14USO%C5%C2%FC%C4%E4%14%DF%F2%01%5E%1CC%2B%FChM%8B%86%16J%26G%40%0F%D3%B2y%EF%B3%F3%0E%1E%C6lt%EEo%DF%AB%FEc%D5%9A%95%0C%11%F0%1C%20%BE%945%C4%22%E1Y%A0i%5C%D4t%13%E0%D6%89%EF%9D15%C2%CDLsX%A7%04%09%1Fg8oc%81%E1%8C%8D%23%96f45%40%9A%09%C2%07%C5B%3AK%B8%408%98i%E0%F3%0D%D8%CE%81%14%E4\'%26%A9%92.%8B%3C%ABER%2F%E5dE%B2%0C%F6%F0%1Fs%83%F2_%B0%A8%94%E9%9B%AD%E7%10%8Dm%9A%19N%D1%7C%8A%DE%1F9%7Dp%8C%E6%00%D5%C1%3F_%18%BDA%B8%9DpX6%E3%A35~B%CD%24%AE%11%26%BD%E7%EEti%98%EDe%9A%97Y)%12%25%1C%24%BCbT%AE3li%E6%0B%03%89%9A%E6%D3%ED%F4P%92%B0%9F4%BF43Y%F3%E3%EDP%95%04%EB1%C5%F5%F6KF%F4%BA%BD%D7%DB%91%93%07%E35%3E%A7)%D6%7F%40%FE%BD%F7%F5r%8A%E5y%92%F0%EB%B4%1E%8D%D5%F4%5B%92%3AV%DB%DB%E4%CD%A6%23%C3%C4wQ%3F%03HB%82%8E%1Cd(%E0%91B%0Ca%9Ac%C4%AA%F8L%16%19%22J%A4%D2itTy%B28%D6%3B(%93%96%ED%1CGx%C9_%0E%B8%5E%16%F5%5B%B2%B8%F6%E0%FB%9E%DD%25%D7%8E%BC%15%85%C5%B7%A3%D8Q%ED%B5%81%E9%BA%B2%13%9A%1B%7Fua%A5%A3n%E17%B9%E5%9B%1Bm%AB%0B%08Q%FE%8A%E5%B1H%5Ee%CAO%82Q%D7u6%E6%90S%97%FCu%0B%CF2%94%EE%25v%12X%0C%BA%AC%F0%5E%F8*l%0AO%85%17%C2%97%BF%D4%C8%CE%DE%AD%11%CB%80q%2C%3E%AB%9ES%CD%C6%EC%25%D2L%D2%EBd%B8%BF%8A%F5B%C6%18%F9%901CZ%9D%BE%24M%9C%8A9%F2%DAP%0B\'%06w%82%EB%E6%E2%5C%2F%D7%07%9E%BB%CC%5D%E1%FA%B9%08%AD.r%23%8E%C2%17%F5E%7C!%F0%BE3%BE%3E_%B7o%88a%A7%DB%BE%D3d%EB%A31Z%EB%BB%D3%91%BA%A2%B1z%94%8F%DB\'%F6%3D%8E%AA%13%19%B2%B1%BE%B1~V%08%2B%B4%A2cjJ%B3tO%00%03%25mN%97%F3%05%93%EF%11%84%0B%7C%88%AE-%89%8F%ABbW%90O%2B%0Ao%99%0C%5E%97%0CI%AFH%D9.%B0%3B%8F%ED%03%B6S%D6%5D%E6i_s9%F3*p%E9%1B%FD%C3%EB.7U%06%5E%19%C0%D1s.%17%A03u%E4%09%B0%7C%5E%2C%EB%15%DB%1F%3C%9E%B7%80%91%3B%DBc%AD%3Dma%BA%8B%3EV%AB%DBt.%5B%1E%01%BB%0F%AB%D5%9F%CF%AA%D5%DD%E7%E4%7F%0Bx%A3%FC%06%A9%23%0A%D6%C2%A1_2%00%00%00%09pHYs%00%00%0B%13%00%00%0B%13%01%00%9A%9C%18%00%00%00%B5IDAT(%15%A5%91%3D%0E%02!%10%85ac%E1%05%D6%CE%D6%C6%CE%D2%E8%ED%CD%DE%C0%C6%D6N.%E0V%F8%3D%9Ca%891XH%C2%BE%D9y%3F%90!%E6%9C%C3%BFk%E5%011%C6-%F5%C8N%04%DF%BD%FF%89%DFt%83DN%60%3E%F3%AB%A0%DE%1A%5Dg%BE%10Q%97%1B%40%9C%A8o%10%8F%5E%828%B4%1B%60%87%F6%02%26%85%1Ch%1E%C1%2B%5Bk%FF%86%EE%B7j%09%9A%DA%9B%ACe%A3%F9%EC%DA!9%B4%D5%A6%81%86%86%98%CC%3C%5B%40%FA%81%B3%E9%CB%23%94%C16Azo%05%D4%E1%C1%95a%3B%8A\'%A0%E8%CC%17%22%85%1D%BA%00%A2%FA%DC%0A%94%D1%D1%8D%8B%3A%84%17B%C7%60%1A%25Z%FC%8D%00%00%00%00IEND%AEB%60%82"),url("data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%05%00%00%007%08%06%00%00%00%C4%DD%80C%00%00%03%1EiCCPICC%20Profile%00%00x%01%85T%DFk%D3P%14%FE%DAe%9D%B0%E1%8B%3Ag%11%09%3Eh%91ndStC%9C%B6kW%BA%CDZ%EA6%B7!H%9B%A6m%5C%9A%C6%24%ED~%B0%07%D9%8Bo%3A%C5w%F1%07%3E%F9%07%0C%D9%83o%7B%92%0D%C6%14a%F8%AC%88%22L%F6%22%B3%9E%9B4M\'S%03%B9%F7%BB%DF%F9%EE9\'%E7%E4%5E%A0%F9qZ%D3%14%2F%0F%14USO%C5%C2%FC%C4%E4%14%DF%F2%01%5E%1CC%2B%FChM%8B%86%16J%26G%40%0F%D3%B2y%EF%B3%F3%0E%1E%C6lt%EEo%DF%AB%FEc%D5%9A%95%0C%11%F0%1C%20%BE%945%C4%22%E1Y%A0i%5C%D4t%13%E0%D6%89%EF%9D15%C2%CDLsX%A7%04%09%1Fg8oc%81%E1%8C%8D%23%96f45%40%9A%09%C2%07%C5B%3AK%B8%408%98i%E0%F3%0D%D8%CE%81%14%E4\'%26%A9%92.%8B%3C%ABER%2F%E5dE%B2%0C%F6%F0%1Fs%83%F2_%B0%A8%94%E9%9B%AD%E7%10%8Dm%9A%19N%D1%7C%8A%DE%1F9%7Dp%8C%E6%00%D5%C1%3F_%18%BDA%B8%9DpX6%E3%A35~B%CD%24%AE%11%26%BD%E7%EEti%98%EDe%9A%97Y)%12%25%1C%24%BCbT%AE3li%E6%0B%03%89%9A%E6%D3%ED%F4P%92%B0%9F4%BF43Y%F3%E3%EDP%95%04%EB1%C5%F5%F6KF%F4%BA%BD%D7%DB%91%93%07%E35%3E%A7)%D6%7F%40%FE%BD%F7%F5r%8A%E5y%92%F0%EB%B4%1E%8D%D5%F4%5B%92%3AV%DB%DB%E4%CD%A6%23%C3%C4wQ%3F%03HB%82%8E%1Cd(%E0%91B%0Ca%9Ac%C4%AA%F8L%16%19%22J%A4%D2itTy%B28%D6%3B(%93%96%ED%1CGx%C9_%0E%B8%5E%16%F5%5B%B2%B8%F6%E0%FB%9E%DD%25%D7%8E%BC%15%85%C5%B7%A3%D8Q%ED%B5%81%E9%BA%B2%13%9A%1B%7Fua%A5%A3n%E17%B9%E5%9B%1Bm%AB%0B%08Q%FE%8A%E5%B1H%5Ee%CAO%82Q%D7u6%E6%90S%97%FCu%0B%CF2%94%EE%25v%12X%0C%BA%AC%F0%5E%F8*l%0AO%85%17%C2%97%BF%D4%C8%CE%DE%AD%11%CB%80q%2C%3E%AB%9ES%CD%C6%EC%25%D2L%D2%EBd%B8%BF%8A%F5B%C6%18%F9%901CZ%9D%BE%24M%9C%8A9%F2%DAP%0B\'%06w%82%EB%E6%E2%5C%2F%D7%07%9E%BB%CC%5D%E1%FA%B9%08%AD.r%23%8E%C2%17%F5E%7C!%F0%BE3%BE%3E_%B7o%88a%A7%DB%BE%D3d%EB%A31Z%EB%BB%D3%91%BA%A2%B1z%94%8F%DB\'%F6%3D%8E%AA%13%19%B2%B1%BE%B1~V%08%2B%B4%A2cjJ%B3tO%00%03%25mN%97%F3%05%93%EF%11%84%0B%7C%88%AE-%89%8F%ABbW%90O%2B%0Ao%99%0C%5E%97%0CI%AFH%D9.%B0%3B%8F%ED%03%B6S%D6%5D%E6i_s9%F3*p%E9%1B%FD%C3%EB.7U%06%5E%19%C0%D1s.%17%A03u%E4%09%B0%7C%5E%2C%EB%15%DB%1F%3C%9E%B7%80%91%3B%DBc%AD%3Dma%BA%8B%3EV%AB%DBt.%5B%1E%01%BB%0F%AB%D5%9F%CF%AA%D5%DD%E7%E4%7F%0Bx%A3%FC%06%A9%23%0A%D6%C2%A1_2%00%00%00%09pHYs%00%00%0B%13%00%00%0B%13%01%00%9A%9C%18%00%00%00%3AIDAT8%11c%FC%FF%FF%7F%18%03%1A%60%01%F2%3F%A0%891%80%04%FF%11-%F8%17%9BJ%E2%05%B1ZD%81v%26t%E7%80%F8%A3%82h%A12%1A%20%A3%01%02%0F%01%BA%25%06%00%19%C0%0D%AEF%D5%3ES%00%00%00%00IEND%AEB%60%82");background-repeat: no-repeat, repeat-x;background-position: center center, top left;color: transparent;border: 1px solid black;-moz-border-radius: 2px;-webkit-border-radius: 2px;border-radius: 2px;cursor: pointer;pointer-events: auto;}.ace_dark .ace_fold {}.ace_fold:hover{background-image:url("data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%11%00%00%00%09%08%06%00%00%00%D4%E8%C7%0C%00%00%03%1EiCCPICC%20Profile%00%00x%01%85T%DFk%D3P%14%FE%DAe%9D%B0%E1%8B%3Ag%11%09%3Eh%91ndStC%9C%B6kW%BA%CDZ%EA6%B7!H%9B%A6m%5C%9A%C6%24%ED~%B0%07%D9%8Bo%3A%C5w%F1%07%3E%F9%07%0C%D9%83o%7B%92%0D%C6%14a%F8%AC%88%22L%F6%22%B3%9E%9B4M\'S%03%B9%F7%BB%DF%F9%EE9\'%E7%E4%5E%A0%F9qZ%D3%14%2F%0F%14USO%C5%C2%FC%C4%E4%14%DF%F2%01%5E%1CC%2B%FChM%8B%86%16J%26G%40%0F%D3%B2y%EF%B3%F3%0E%1E%C6lt%EEo%DF%AB%FEc%D5%9A%95%0C%11%F0%1C%20%BE%945%C4%22%E1Y%A0i%5C%D4t%13%E0%D6%89%EF%9D15%C2%CDLsX%A7%04%09%1Fg8oc%81%E1%8C%8D%23%96f45%40%9A%09%C2%07%C5B%3AK%B8%408%98i%E0%F3%0D%D8%CE%81%14%E4\'%26%A9%92.%8B%3C%ABER%2F%E5dE%B2%0C%F6%F0%1Fs%83%F2_%B0%A8%94%E9%9B%AD%E7%10%8Dm%9A%19N%D1%7C%8A%DE%1F9%7Dp%8C%E6%00%D5%C1%3F_%18%BDA%B8%9DpX6%E3%A35~B%CD%24%AE%11%26%BD%E7%EEti%98%EDe%9A%97Y)%12%25%1C%24%BCbT%AE3li%E6%0B%03%89%9A%E6%D3%ED%F4P%92%B0%9F4%BF43Y%F3%E3%EDP%95%04%EB1%C5%F5%F6KF%F4%BA%BD%D7%DB%91%93%07%E35%3E%A7)%D6%7F%40%FE%BD%F7%F5r%8A%E5y%92%F0%EB%B4%1E%8D%D5%F4%5B%92%3AV%DB%DB%E4%CD%A6%23%C3%C4wQ%3F%03HB%82%8E%1Cd(%E0%91B%0Ca%9Ac%C4%AA%F8L%16%19%22J%A4%D2itTy%B28%D6%3B(%93%96%ED%1CGx%C9_%0E%B8%5E%16%F5%5B%B2%B8%F6%E0%FB%9E%DD%25%D7%8E%BC%15%85%C5%B7%A3%D8Q%ED%B5%81%E9%BA%B2%13%9A%1B%7Fua%A5%A3n%E17%B9%E5%9B%1Bm%AB%0B%08Q%FE%8A%E5%B1H%5Ee%CAO%82Q%D7u6%E6%90S%97%FCu%0B%CF2%94%EE%25v%12X%0C%BA%AC%F0%5E%F8*l%0AO%85%17%C2%97%BF%D4%C8%CE%DE%AD%11%CB%80q%2C%3E%AB%9ES%CD%C6%EC%25%D2L%D2%EBd%B8%BF%8A%F5B%C6%18%F9%901CZ%9D%BE%24M%9C%8A9%F2%DAP%0B\'%06w%82%EB%E6%E2%5C%2F%D7%07%9E%BB%CC%5D%E1%FA%B9%08%AD.r%23%8E%C2%17%F5E%7C!%F0%BE3%BE%3E_%B7o%88a%A7%DB%BE%D3d%EB%A31Z%EB%BB%D3%91%BA%A2%B1z%94%8F%DB\'%F6%3D%8E%AA%13%19%B2%B1%BE%B1~V%08%2B%B4%A2cjJ%B3tO%00%03%25mN%97%F3%05%93%EF%11%84%0B%7C%88%AE-%89%8F%ABbW%90O%2B%0Ao%99%0C%5E%97%0CI%AFH%D9.%B0%3B%8F%ED%03%B6S%D6%5D%E6i_s9%F3*p%E9%1B%FD%C3%EB.7U%06%5E%19%C0%D1s.%17%A03u%E4%09%B0%7C%5E%2C%EB%15%DB%1F%3C%9E%B7%80%91%3B%DBc%AD%3Dma%BA%8B%3EV%AB%DBt.%5B%1E%01%BB%0F%AB%D5%9F%CF%AA%D5%DD%E7%E4%7F%0Bx%A3%FC%06%A9%23%0A%D6%C2%A1_2%00%00%00%09pHYs%00%00%0B%13%00%00%0B%13%01%00%9A%9C%18%00%00%00%B5IDAT(%15%A5%91%3D%0E%02!%10%85ac%E1%05%D6%CE%D6%C6%CE%D2%E8%ED%CD%DE%C0%C6%D6N.%E0V%F8%3D%9Ca%891XH%C2%BE%D9y%3F%90!%E6%9C%C3%BFk%E5%011%C6-%F5%C8N%04%DF%BD%FF%89%DFt%83DN%60%3E%F3%AB%A0%DE%1A%5Dg%BE%10Q%97%1B%40%9C%A8o%10%8F%5E%828%B4%1B%60%87%F6%02%26%85%1Ch%1E%C1%2B%5Bk%FF%86%EE%B7j%09%9A%DA%9B%ACe%A3%F9%EC%DA!9%B4%D5%A6%81%86%86%98%CC%3C%5B%40%FA%81%B3%E9%CB%23%94%C16Azo%05%D4%E1%C1%95a%3B%8A\'%A0%E8%CC%17%22%85%1D%BA%00%A2%FA%DC%0A%94%D1%D1%8D%8B%3A%84%17B%C7%60%1A%25Z%FC%8D%00%00%00%00IEND%AEB%60%82"),url("data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%05%00%00%007%08%06%00%00%00%C4%DD%80C%00%00%03%1EiCCPICC%20Profile%00%00x%01%85T%DFk%D3P%14%FE%DAe%9D%B0%E1%8B%3Ag%11%09%3Eh%91ndStC%9C%B6kW%BA%CDZ%EA6%B7!H%9B%A6m%5C%9A%C6%24%ED~%B0%07%D9%8Bo%3A%C5w%F1%07%3E%F9%07%0C%D9%83o%7B%92%0D%C6%14a%F8%AC%88%22L%F6%22%B3%9E%9B4M\'S%03%B9%F7%BB%DF%F9%EE9\'%E7%E4%5E%A0%F9qZ%D3%14%2F%0F%14USO%C5%C2%FC%C4%E4%14%DF%F2%01%5E%1CC%2B%FChM%8B%86%16J%26G%40%0F%D3%B2y%EF%B3%F3%0E%1E%C6lt%EEo%DF%AB%FEc%D5%9A%95%0C%11%F0%1C%20%BE%945%C4%22%E1Y%A0i%5C%D4t%13%E0%D6%89%EF%9D15%C2%CDLsX%A7%04%09%1Fg8oc%81%E1%8C%8D%23%96f45%40%9A%09%C2%07%C5B%3AK%B8%408%98i%E0%F3%0D%D8%CE%81%14%E4\'%26%A9%92.%8B%3C%ABER%2F%E5dE%B2%0C%F6%F0%1Fs%83%F2_%B0%A8%94%E9%9B%AD%E7%10%8Dm%9A%19N%D1%7C%8A%DE%1F9%7Dp%8C%E6%00%D5%C1%3F_%18%BDA%B8%9DpX6%E3%A35~B%CD%24%AE%11%26%BD%E7%EEti%98%EDe%9A%97Y)%12%25%1C%24%BCbT%AE3li%E6%0B%03%89%9A%E6%D3%ED%F4P%92%B0%9F4%BF43Y%F3%E3%EDP%95%04%EB1%C5%F5%F6KF%F4%BA%BD%D7%DB%91%93%07%E35%3E%A7)%D6%7F%40%FE%BD%F7%F5r%8A%E5y%92%F0%EB%B4%1E%8D%D5%F4%5B%92%3AV%DB%DB%E4%CD%A6%23%C3%C4wQ%3F%03HB%82%8E%1Cd(%E0%91B%0Ca%9Ac%C4%AA%F8L%16%19%22J%A4%D2itTy%B28%D6%3B(%93%96%ED%1CGx%C9_%0E%B8%5E%16%F5%5B%B2%B8%F6%E0%FB%9E%DD%25%D7%8E%BC%15%85%C5%B7%A3%D8Q%ED%B5%81%E9%BA%B2%13%9A%1B%7Fua%A5%A3n%E17%B9%E5%9B%1Bm%AB%0B%08Q%FE%8A%E5%B1H%5Ee%CAO%82Q%D7u6%E6%90S%97%FCu%0B%CF2%94%EE%25v%12X%0C%BA%AC%F0%5E%F8*l%0AO%85%17%C2%97%BF%D4%C8%CE%DE%AD%11%CB%80q%2C%3E%AB%9ES%CD%C6%EC%25%D2L%D2%EBd%B8%BF%8A%F5B%C6%18%F9%901CZ%9D%BE%24M%9C%8A9%F2%DAP%0B\'%06w%82%EB%E6%E2%5C%2F%D7%07%9E%BB%CC%5D%E1%FA%B9%08%AD.r%23%8E%C2%17%F5E%7C!%F0%BE3%BE%3E_%B7o%88a%A7%DB%BE%D3d%EB%A31Z%EB%BB%D3%91%BA%A2%B1z%94%8F%DB\'%F6%3D%8E%AA%13%19%B2%B1%BE%B1~V%08%2B%B4%A2cjJ%B3tO%00%03%25mN%97%F3%05%93%EF%11%84%0B%7C%88%AE-%89%8F%ABbW%90O%2B%0Ao%99%0C%5E%97%0CI%AFH%D9.%B0%3B%8F%ED%03%B6S%D6%5D%E6i_s9%F3*p%E9%1B%FD%C3%EB.7U%06%5E%19%C0%D1s.%17%A03u%E4%09%B0%7C%5E%2C%EB%15%DB%1F%3C%9E%B7%80%91%3B%DBc%AD%3Dma%BA%8B%3EV%AB%DBt.%5B%1E%01%BB%0F%AB%D5%9F%CF%AA%D5%DD%E7%E4%7F%0Bx%A3%FC%06%A9%23%0A%D6%C2%A1_2%00%00%00%09pHYs%00%00%0B%13%00%00%0B%13%01%00%9A%9C%18%00%00%003IDAT8%11c%FC%FF%FF%7F%3E%03%1A%60%01%F2%3F%A3%891%80%04%FFQ%26%F8w%C0%B43%A1%DB%0C%E2%8F%0A%A2%85%CAh%80%8C%06%08%3C%04%E8%96%18%00%A3S%0D%CD%CF%D8%C1%9D%00%00%00%00IEND%AEB%60%82");background-repeat: no-repeat, repeat-x;background-position: center center, top left;}.ace_gutter-tooltip {background-color: #FFF;background-image: -webkit-linear-gradient(top, transparent, rgba(0, 0, 0, 0.1));background-image: linear-gradient(to bottom, transparent, rgba(0, 0, 0, 0.1));border: 1px solid gray;border-radius: 1px;box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);color: black;display: inline-block;max-width: 500px;padding: 4px;position: fixed;z-index: 999999;-moz-box-sizing: border-box;-webkit-box-sizing: border-box;box-sizing: border-box;cursor: default;white-space: pre-line;word-wrap: break-word;line-height: normal;font-style: normal;font-weight: normal;letter-spacing: normal;}.ace_folding-enabled > .ace_gutter-cell {padding-right: 13px;}.ace_fold-widget {-moz-box-sizing: border-box;-webkit-box-sizing: border-box;box-sizing: border-box;margin: 0 -12px 0 1px;display: none;width: 11px;vertical-align: top;background-image: url("data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%05%00%00%00%05%08%06%00%00%00%8Do%26%E5%00%00%004IDATx%DAe%8A%B1%0D%000%0C%C2%F2%2CK%96%BC%D0%8F9%81%88H%E9%D0%0E%96%C0%10%92%3E%02%80%5E%82%E4%A9*-%EEsw%C8%CC%11%EE%96w%D8%DC%E9*Eh%0C%151(%00%00%00%00IEND%AEB%60%82");background-repeat: no-repeat;background-position: center;border-radius: 3px;border: 1px solid transparent;cursor: pointer;}.ace_folding-enabled .ace_fold-widget {display: inline-block;   }.ace_fold-widget.ace_end {background-image: url("data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%05%00%00%00%05%08%06%00%00%00%8Do%26%E5%00%00%004IDATx%DAm%C7%C1%09%000%08C%D1%8C%ECE%C8E(%8E%EC%02)%1EZJ%F1%C1\'%04%07I%E1%E5%EE%CAL%F5%A2%99%99%22%E2%D6%1FU%B5%FE0%D9x%A7%26Wz5%0E%D5%00%00%00%00IEND%AEB%60%82");}.ace_fold-widget.ace_closed {background-image: url("data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%03%00%00%00%06%08%06%00%00%00%06%E5%24%0C%00%00%009IDATx%DA5%CA%C1%09%000%08%03%C0%AC*(%3E%04%C1%0D%BA%B1%23%A4Uh%E0%20%81%C0%CC%F8%82%81%AA%A2%AArGfr%88%08%11%11%1C%DD%7D%E0%EE%5B%F6%F6%CB%B8%05Q%2F%E9tai%D9%00%00%00%00IEND%AEB%60%82");}.ace_fold-widget:hover {border: 1px solid rgba(0, 0, 0, 0.3);background-color: rgba(255, 255, 255, 0.2);-moz-box-shadow: 0 1px 1px rgba(255, 255, 255, 0.7);-webkit-box-shadow: 0 1px 1px rgba(255, 255, 255, 0.7);box-shadow: 0 1px 1px rgba(255, 255, 255, 0.7);}.ace_fold-widget:active {border: 1px solid rgba(0, 0, 0, 0.4);background-color: rgba(0, 0, 0, 0.05);-moz-box-shadow: 0 1px 1px rgba(255, 255, 255, 0.8);-webkit-box-shadow: 0 1px 1px rgba(255, 255, 255, 0.8);box-shadow: 0 1px 1px rgba(255, 255, 255, 0.8);}/*** Dark version for fold widgets*/.ace_dark .ace_fold-widget {background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHklEQVQIW2P4//8/AzoGEQ7oGCaLLAhWiSwB146BAQCSTPYocqT0AAAAAElFTkSuQmCC");}.ace_dark .ace_fold-widget.ace_end {background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAH0lEQVQIW2P4//8/AxQ7wNjIAjDMgC4AxjCVKBirIAAF0kz2rlhxpAAAAABJRU5ErkJggg==");}.ace_dark .ace_fold-widget.ace_closed {background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAAFCAYAAACAcVaiAAAAHElEQVQIW2P4//+/AxAzgDADlOOAznHAKgPWAwARji8UIDTfQQAAAABJRU5ErkJggg==");}.ace_dark .ace_fold-widget:hover {box-shadow: 0 1px 1px rgba(255, 255, 255, 0.2);background-color: rgba(255, 255, 255, 0.1);}.ace_dark .ace_fold-widget:active {-moz-box-shadow: 0 1px 1px rgba(255, 255, 255, 0.2);-webkit-box-shadow: 0 1px 1px rgba(255, 255, 255, 0.2);box-shadow: 0 1px 1px rgba(255, 255, 255, 0.2);}.ace_fold-widget.ace_invalid {background-color: #FFB4B4;border-color: #DE5555;}.ace_fade-fold-widgets .ace_fold-widget {-moz-transition: opacity 0.4s ease 0.05s;-webkit-transition: opacity 0.4s ease 0.05s;-o-transition: opacity 0.4s ease 0.05s;-ms-transition: opacity 0.4s ease 0.05s;transition: opacity 0.4s ease 0.05s;opacity: 0;}.ace_fade-fold-widgets:hover .ace_fold-widget {-moz-transition: opacity 0.05s ease 0.05s;-webkit-transition: opacity 0.05s ease 0.05s;-o-transition: opacity 0.05s ease 0.05s;-ms-transition: opacity 0.05s ease 0.05s;transition: opacity 0.05s ease 0.05s;opacity:1;}.ace_underline {text-decoration: underline;}.ace_bold {font-weight: bold;}.ace_nobold .ace_bold {font-weight: normal;}.ace_italic {font-style: italic;}.ace_error-marker {background-color: rgba(255, 0, 0,0.2);position: absolute;z-index: 9;}.ace_highlight-marker {background-color: rgba(255, 255, 0,0.2);position: absolute;z-index: 8;}';
i.importCssString(v,'ace_editor');
var m=function(e,t){
var n=this;
this.container=e||i.createElement('div'),this.$keepTextAreaAtCursor=!0,i.addCssClass(this.container,'ace_editor'),this.setTheme(t),this.$gutter=i.createElement('div'),this.$gutter.className='ace_gutter',this.container.appendChild(this.$gutter),this.scroller=i.createElement('div'),this.scroller.className='ace_scroller',this.container.appendChild(this.scroller),this.content=i.createElement('div'),this.content.className='ace_content',this.scroller.appendChild(this.content),this.$gutterLayer=new u(this.$gutter),this.$gutterLayer.on('changeGutterWidth',this.onGutterResize.bind(this)),this.$markerBack=new a(this.content);
var r=this.$textLayer=new f(this.content);
this.canvas=r.element,this.$markerFront=new a(this.content),this.$cursorLayer=new l(this.content),this.$horizScroll=!1,this.$vScroll=!1,this.scrollBar=this.scrollBarV=new h(this.container,this),this.scrollBarH=new c(this.container,this),this.scrollBarV.addEventListener('scroll',function(e){
n.$scrollAnimation||n.session.setScrollTop(e.data-n.scrollMargin.top)
}),this.scrollBarH.addEventListener('scroll',function(e){
n.$scrollAnimation||n.session.setScrollLeft(e.data-n.scrollMargin.left)
}),this.scrollTop=0,this.scrollLeft=0,this.cursorPos={
row:0,
column:0
},this.$textLayer.addEventListener('changeCharacterSize',function(){
n.updateCharacterSize(),n.onResize(!0),n._signal('changeCharacterSize')
}),this.$size={
width:0,
height:0,
scrollerHeight:0,
scrollerWidth:0,
$dirty:!0
},this.layerConfig={
width:1,
padding:0,
firstRow:0,
firstRowScreen:0,
lastRow:0,
lineHeight:0,
characterWidth:0,
minHeight:1,
maxHeight:1,
offset:0,
height:1
},this.scrollMargin={
left:0,
right:0,
top:0,
bottom:0,
v:0,
h:0
},this.$loop=new p(this.$renderChanges.bind(this),this.container.ownerDocument.defaultView),this.$loop.schedule(this.CHANGE_FULL),this.updateCharacterSize(),this.setPadding(4),o.resetOptions(this),o._emit('renderer',this)
};
(function(){
this.CHANGE_CURSOR=1,this.CHANGE_MARKER=2,this.CHANGE_GUTTER=4,this.CHANGE_SCROLL=8,this.CHANGE_LINES=16,this.CHANGE_TEXT=32,this.CHANGE_SIZE=64,this.CHANGE_MARKER_BACK=128,this.CHANGE_MARKER_FRONT=256,this.CHANGE_FULL=512,this.CHANGE_H_SCROLL=1024,r.implement(this,d),this.updateCharacterSize=function(){
this.$textLayer.allowBoldFonts!=this.$allowBoldFonts&&(this.$allowBoldFonts=this.$textLayer.allowBoldFonts,this.setStyle('ace_nobold',!this.$allowBoldFonts)),this.layerConfig.characterWidth=this.characterWidth=this.$textLayer.getCharacterWidth(),this.layerConfig.lineHeight=this.lineHeight=this.$textLayer.getLineHeight(),this.$updatePrintMargin()
},this.setSession=function(e){
this.session=e,this.scrollMargin.top&&e.getScrollTop()<=0&&e.setScrollTop(-this.scrollMargin.top),this.scroller.className='ace_scroller',this.$cursorLayer.setSession(e),this.$markerBack.setSession(e),this.$markerFront.setSession(e),this.$gutterLayer.setSession(e),this.$textLayer.setSession(e),this.$loop.schedule(this.CHANGE_FULL)
},this.updateLines=function(e,t){
t===undefined&&(t=Infinity),this.$changedLines?(this.$changedLines.firstRow>e&&(this.$changedLines.firstRow=e),this.$changedLines.lastRow<t&&(this.$changedLines.lastRow=t)):this.$changedLines={
firstRow:e,
lastRow:t
};
if(this.$changedLines.firstRow>this.layerConfig.lastRow||this.$changedLines.lastRow<this.layerConfig.firstRow)
return;
this.$loop.schedule(this.CHANGE_LINES)
},this.onChangeTabSize=function(){
this.$loop.schedule(this.CHANGE_TEXT|this.CHANGE_MARKER),this.$textLayer.onChangeTabSize()
},this.updateText=function(){
this.$loop.schedule(this.CHANGE_TEXT)
},this.updateFull=function(e){
e?this.$renderChanges(this.CHANGE_FULL,!0):this.$loop.schedule(this.CHANGE_FULL)
},this.updateFontSize=function(){
this.$textLayer.checkForSizeChanges()
},this.$changes=0,this.$updateSizeAsync=function(){
this.$loop.pending?this.$size.$dirty=!0:this.onResize()
},this.onResize=function(e,t,n,r){
if(this.resizing>2)
return;
this.resizing>0?this.resizing++:this.resizing=e?1:0;
var i=this.container;
r||(r=i.clientHeight||i.scrollHeight),n||(n=i.clientWidth||i.scrollWidth);
var s=this.$updateCachedSize(e,t,n,r);
if(!this.$size.scrollerHeight||!n&&!r)
return this.resizing=0;
e&&(this.$gutterLayer.$padding=null),e?this.$renderChanges(s|this.$changes,!0):this.$loop.schedule(s|this.$changes),this.resizing&&(this.resizing=0)
},this.$updateCachedSize=function(e,t,n,r){
var i=0,s=this.$size,o={
width:s.width,
height:s.height,
scrollerHeight:s.scrollerHeight,
scrollerWidth:s.scrollerWidth
};
r&&(e||s.height!=r)&&(s.height=r,i=this.CHANGE_SIZE,s.scrollerHeight=s.height,this.$horizScroll&&(s.scrollerHeight-=this.scrollBarH.getHeight()),this.scrollBarV.element.style.bottom=this.scrollBarH.getHeight()+'px',this.session&&(i|=this.CHANGE_SCROLL));
if(n&&(e||s.width!=n)){
i=this.CHANGE_SIZE,s.width=n,t==null&&(t=this.$showGutter?this.$gutter.offsetWidth:0),this.gutterWidth=t,this.scrollBarH.element.style.left=this.scroller.style.left=t+'px',s.scrollerWidth=Math.max(0,n-t-this.scrollBarV.getWidth()),this.scrollBarH.element.style.right=this.scroller.style.right=this.scrollBarV.getWidth()+'px',this.scroller.style.bottom=this.scrollBarH.getHeight()+'px';
if(this.session&&this.session.getUseWrapMode()&&this.adjustWrapLimit()||e)
i|=this.CHANGE_FULL
}
return s.$dirty&&(s.$dirty=!n&&!r),i&&this._signal('resize',o),i
},this.onGutterResize=function(){
var e=this.$showGutter?this.$gutter.offsetWidth:0;
e!=this.gutterWidth&&(this.$changes|=this.$updateCachedSize(!0,e,this.$size.width,this.$size.height)),this.session.getUseWrapMode()&&this.adjustWrapLimit()?this.$loop.schedule(this.CHANGE_FULL):this.$size.$dirty?this.$loop.schedule(this.CHANGE_FULL):(this.$computeLayerConfig(),this.$loop.schedule(this.CHANGE_MARKER))
},this.adjustWrapLimit=function(){
var e=this.$size.scrollerWidth-this.$padding*2,t=Math.floor(e/this.characterWidth);
return this.session.adjustWrapLimit(t,this.$showPrintMargin&&this.$printMarginColumn)
},this.setAnimatedScroll=function(e){
this.setOption('animatedScroll',e)
},this.getAnimatedScroll=function(){
return this.$animatedScroll
},this.setShowInvisibles=function(e){
this.setOption('showInvisibles',e)
},this.getShowInvisibles=function(){
return this.getOption('showInvisibles')
},this.getDisplayIndentGuides=function(){
return this.getOption('displayIndentGuides')
},this.setDisplayIndentGuides=function(e){
this.setOption('displayIndentGuides',e)
},this.setShowPrintMargin=function(e){
this.setOption('showPrintMargin',e)
},this.getShowPrintMargin=function(){
return this.getOption('showPrintMargin')
},this.setPrintMarginColumn=function(e){
this.setOption('printMarginColumn',e)
},this.getPrintMarginColumn=function(){
return this.getOption('printMarginColumn')
},this.getShowGutter=function(){
return this.getOption('showGutter')
},this.setShowGutter=function(e){
return this.setOption('showGutter',e)
},this.getFadeFoldWidgets=function(){
return this.getOption('fadeFoldWidgets')
},this.setFadeFoldWidgets=function(e){
this.setOption('fadeFoldWidgets',e)
},this.setHighlightGutterLine=function(e){
this.setOption('highlightGutterLine',e)
},this.getHighlightGutterLine=function(){
return this.getOption('highlightGutterLine')
},this.$updateGutterLineHighlight=function(){
var e=this.$cursorLayer.$pixelPos,t=this.layerConfig.lineHeight;
if(this.session.getUseWrapMode()){
var n=this.session.selection.getCursor();
n.column=0,e=this.$cursorLayer.getPixelPosition(n,!0),t*=this.session.getRowLength(n.row)
}
this.$gutterLineHighlight.style.top=e.top-this.layerConfig.offset+'px',this.$gutterLineHighlight.style.height=t+'px'
},this.$updatePrintMargin=function(){
if(!this.$showPrintMargin&&!this.$printMarginEl)
return;
if(!this.$printMarginEl){
var e=i.createElement('div');
e.className='ace_layer ace_print-margin-layer',this.$printMarginEl=i.createElement('div'),this.$printMarginEl.className='ace_print-margin',e.appendChild(this.$printMarginEl),this.content.insertBefore(e,this.content.firstChild)
}
var t=this.$printMarginEl.style;
t.left=this.characterWidth*this.$printMarginColumn+this.$padding+'px',t.visibility=this.$showPrintMargin?'visible':'hidden',this.session&&this.session.$wrap==-1&&this.adjustWrapLimit()
},this.getContainerElement=function(){
return this.container
},this.getMouseEventTarget=function(){
return this.content
},this.getTextAreaContainer=function(){
return this.container
},this.$moveTextAreaToCursor=function(){
if(!this.$keepTextAreaAtCursor)
return;
var e=this.layerConfig,t=this.$cursorLayer.$pixelPos.top,n=this.$cursorLayer.$pixelPos.left;
t-=e.offset;
var r=this.lineHeight;
if(t<0||t>e.height-r)
return;
var i=this.characterWidth;
if(this.$composition){
var s=this.textarea.value.replace(/^\x01+/,'');
i*=this.session.$getStringScreenWidth(s)[0]+2,r+=2,t-=1
}
n-=this.scrollLeft,n>this.$size.scrollerWidth-i&&(n=this.$size.scrollerWidth-i),n-=this.scrollBar.width,this.textarea.style.height=r+'px',this.textarea.style.width=i+'px',this.textarea.style.right=Math.max(0,this.$size.scrollerWidth-n-i)+'px',this.textarea.style.bottom=Math.max(0,this.$size.height-t-r)+'px'
},this.getFirstVisibleRow=function(){
return this.layerConfig.firstRow
},this.getFirstFullyVisibleRow=function(){
return this.layerConfig.firstRow+(this.layerConfig.offset===0?0:1)
},this.getLastFullyVisibleRow=function(){
var e=Math.floor((this.layerConfig.height+this.layerConfig.offset)/this.layerConfig.lineHeight);
return this.layerConfig.firstRow-1+e
},this.getLastVisibleRow=function(){
return this.layerConfig.lastRow
},this.$padding=null,this.setPadding=function(e){
this.$padding=e,this.$textLayer.setPadding(e),this.$cursorLayer.setPadding(e),this.$markerFront.setPadding(e),this.$markerBack.setPadding(e),this.$loop.schedule(this.CHANGE_FULL),this.$updatePrintMargin()
},this.setScrollMargin=function(e,t,n,r){
var i=this.scrollMargin;
i.top=e|0,i.bottom=t|0,i.right=r|0,i.left=n|0,i.v=i.top+i.bottom,i.h=i.left+i.right,i.top&&this.scrollTop<=0&&this.session&&this.session.setScrollTop(i.top),this.updateFull()
},this.getHScrollBarAlwaysVisible=function(){
return this.$hScrollBarAlwaysVisible
},this.setHScrollBarAlwaysVisible=function(e){
this.setOption('hScrollBarAlwaysVisible',e)
},this.getVScrollBarAlwaysVisible=function(){
return this.$hScrollBarAlwaysVisible
},this.setVScrollBarAlwaysVisible=function(e){
this.setOption('vScrollBarAlwaysVisible',e)
},this.$updateScrollBarV=function(){
this.scrollBarV.setInnerHeight(this.layerConfig.maxHeight+this.scrollMargin.v),this.scrollBarV.setScrollTop(this.scrollTop+this.scrollMargin.top)
},this.$updateScrollBarH=function(){
this.scrollBarH.setInnerWidth(this.layerConfig.width+2*this.$padding+this.scrollMargin.h),this.scrollBarH.setScrollLeft(this.scrollLeft+this.scrollMargin.left)
},this.$renderChanges=function(e,t){
this.$changes&&(e|=this.$changes,this.$changes=0);
if(!this.session||!this.container.offsetWidth||!e&&!t){
this.$changes|=e;
return
}
if(this.$size.$dirty)
return this.$changes|=e,this.onResize(!0);
this.lineHeight||this.$textLayer.checkForSizeChanges(),this._signal('beforeRender');
if(e&this.CHANGE_FULL||e&this.CHANGE_SIZE||e&this.CHANGE_TEXT||e&this.CHANGE_LINES||e&this.CHANGE_SCROLL||e&this.CHANGE_H_SCROLL)
e|=this.$computeLayerConfig();
e&this.CHANGE_H_SCROLL&&(this.$updateScrollBarH(),this.content.style.marginLeft=-this.scrollLeft+'px',this.scroller.className=this.scrollLeft<=0?'ace_scroller':'ace_scroller ace_scroll-left');
if(e&this.CHANGE_FULL){
this.$updateScrollBarV(),this.$updateScrollBarH(),this.$textLayer.update(this.layerConfig),this.$showGutter&&this.$gutterLayer.update(this.layerConfig),this.$markerBack.update(this.layerConfig),this.$markerFront.update(this.layerConfig),this.$cursorLayer.update(this.layerConfig),this.$moveTextAreaToCursor(),this.$highlightGutterLine&&this.$updateGutterLineHighlight(),this._signal('afterRender');
return
}
if(e&this.CHANGE_SCROLL){
this.$updateScrollBarV(),e&this.CHANGE_TEXT||e&this.CHANGE_LINES?this.$textLayer.update(this.layerConfig):this.$textLayer.scrollLines(this.layerConfig),this.$showGutter&&this.$gutterLayer.update(this.layerConfig),this.$markerBack.update(this.layerConfig),this.$markerFront.update(this.layerConfig),this.$cursorLayer.update(this.layerConfig),this.$highlightGutterLine&&this.$updateGutterLineHighlight(),this.$moveTextAreaToCursor(),this._signal('afterRender');
return
}
e&this.CHANGE_TEXT?(this.$textLayer.update(this.layerConfig),this.$showGutter&&this.$gutterLayer.update(this.layerConfig)):e&this.CHANGE_LINES?(this.$updateLines()||e&this.CHANGE_GUTTER&&this.$showGutter)&&this.$gutterLayer.update(this.layerConfig):(e&this.CHANGE_TEXT||e&this.CHANGE_GUTTER)&&this.$showGutter&&this.$gutterLayer.update(this.layerConfig),e&this.CHANGE_CURSOR&&(this.$cursorLayer.update(this.layerConfig),this.$moveTextAreaToCursor(),this.$highlightGutterLine&&this.$updateGutterLineHighlight()),e&(this.CHANGE_MARKER|this.CHANGE_MARKER_FRONT)&&this.$markerFront.update(this.layerConfig),e&(this.CHANGE_MARKER|this.CHANGE_MARKER_BACK)&&this.$markerBack.update(this.layerConfig);
if(e&this.CHANGE_SIZE||e&this.CHANGE_LINES)
this.$updateScrollBarV(),this.$updateScrollBarH();
this._signal('afterRender')
},this.$autosize=function(e,t){
var e=this.session.getScreenLength()*this.lineHeight,n=this.$maxLines*this.lineHeight,r=Math.max((this.$minLines||1)*this.lineHeight,Math.min(n,e)),i=e>n;
if(r!=this.desiredHeight||this.$size.height!=this.desiredHeight||i!=this.$vScroll){
i!=this.$vScroll&&(this.$vScroll=i,this.scrollBarV.setVisible(i));
var s=this.container.clientWidth;
this.container.style.height=r+'px',this.$updateCachedSize(!0,this.$gutterWidth,s,r),this.desiredHeight=r
}
},this.$computeLayerConfig=function(){
this.$maxLines&&this.lineHeight>1&&this.$autosize();
var e=this.session,t=this.$size.height<=2*this.lineHeight,n=this.session.getScreenLength(),r=n*this.lineHeight,i=this.scrollTop%this.lineHeight,s=this.$size.scrollerHeight+this.lineHeight,o=this.$getLongestLine(),u=!t&&(this.$hScrollBarAlwaysVisible||this.$size.scrollerWidth-o-2*this.$padding<0),a=this.$horizScroll!==u;
a&&(this.$horizScroll=u,this.scrollBarH.setVisible(u)),!this.$maxLines&&this.$scrollPastEnd&&this.scrollTop>r-this.$size.scrollerHeight&&(r+=Math.min((this.$size.scrollerHeight-this.lineHeight)*this.$scrollPastEnd,this.scrollTop-r+this.$size.scrollerHeight));
var f=!t&&(this.$vScrollBarAlwaysVisible||this.$size.scrollerHeight-r<0),l=this.$vScroll!==f;
l&&(this.$vScroll=f,this.scrollBarV.setVisible(f)),this.session.setScrollTop(Math.max(-this.scrollMargin.top,Math.min(this.scrollTop,r-this.$size.scrollerHeight+this.scrollMargin.v))),this.session.setScrollLeft(Math.max(-this.scrollMargin.left,Math.min(this.scrollLeft,o+2*this.$padding-this.$size.scrollerWidth+this.scrollMargin.h)));
var c=Math.ceil(s/this.lineHeight)-1,h=Math.max(0,Math.round((this.scrollTop-i)/this.lineHeight)),p=h+c,d,v,m=this.lineHeight;
h=e.screenToDocumentRow(h,0);
var g=e.getFoldLine(h);
g&&(h=g.start.row),d=e.documentToScreenRow(h,0),v=e.getRowLength(h)*m,p=Math.min(e.screenToDocumentRow(p,0),e.getLength()-1),s=this.$size.scrollerHeight+e.getRowLength(p)*m+v,i=this.scrollTop-d*m;
var y=0;
if(a||l)
y=this.$updateCachedSize(!0,this.gutterWidth,this.$size.width,this.$size.height),this._signal('scrollbarVisibilityChanged'),l&&(o=this.$getLongestLine());
return this.layerConfig={
width:o,
padding:this.$padding,
firstRow:h,
firstRowScreen:d,
lastRow:p,
lineHeight:m,
characterWidth:this.characterWidth,
minHeight:s,
maxHeight:r,
offset:i,
height:this.$size.scrollerHeight
},this.$gutterLayer.element.style.marginTop=-i+'px',this.content.style.marginTop=-i+'px',this.content.style.width=o+2*this.$padding+'px',this.content.style.height=s+'px',y
},this.$updateLines=function(){
var e=this.$changedLines.firstRow,t=this.$changedLines.lastRow;
this.$changedLines=null;
var n=this.layerConfig;
if(e>n.lastRow+1)
return;
if(t<n.firstRow)
return;
if(t===Infinity){
this.$showGutter&&this.$gutterLayer.update(n),this.$textLayer.update(n);
return
}
return this.$textLayer.updateLines(n,e,t),!0
},this.$getLongestLine=function(){
var e=this.session.getScreenWidth();
return this.showInvisibles&&!this.session.$useWrapMode&&(e+=1),Math.max(this.$size.scrollerWidth-2*this.$padding,Math.round(e*this.characterWidth))
},this.updateFrontMarkers=function(){
this.$markerFront.setMarkers(this.session.getMarkers(!0)),this.$loop.schedule(this.CHANGE_MARKER_FRONT)
},this.updateBackMarkers=function(){
this.$markerBack.setMarkers(this.session.getMarkers()),this.$loop.schedule(this.CHANGE_MARKER_BACK)
},this.addGutterDecoration=function(e,t){
this.$gutterLayer.addGutterDecoration(e,t)
},this.removeGutterDecoration=function(e,t){
this.$gutterLayer.removeGutterDecoration(e,t)
},this.updateBreakpoints=function(e){
this.$loop.schedule(this.CHANGE_GUTTER)
},this.setAnnotations=function(e){
this.$gutterLayer.setAnnotations(e),this.$loop.schedule(this.CHANGE_GUTTER)
},this.updateCursor=function(){
this.$loop.schedule(this.CHANGE_CURSOR)
},this.hideCursor=function(){
this.$cursorLayer.hideCursor()
},this.showCursor=function(){
this.$cursorLayer.showCursor()
},this.scrollSelectionIntoView=function(e,t,n){
this.scrollCursorIntoView(e,n),this.scrollCursorIntoView(t,n)
},this.scrollCursorIntoView=function(e,t){
if(this.$size.scrollerHeight===0)
return;
var n=this.$cursorLayer.getPixelPosition(e),r=n.left,i=n.top,s=this.$scrollAnimation?this.session.getScrollTop():this.scrollTop;
s>i?(t&&(i-=t*this.$size.scrollerHeight),i==0?i=-this.scrollMargin.top:i==0&&(i=+this.scrollMargin.bottom),this.session.setScrollTop(i)):s+this.$size.scrollerHeight<i+this.lineHeight&&(t&&(i+=t*this.$size.scrollerHeight),this.session.setScrollTop(i+this.lineHeight-this.$size.scrollerHeight));
var o=this.scrollLeft;
o>r?(r<this.$padding+2*this.layerConfig.characterWidth&&(r=-this.scrollMargin.left),this.session.setScrollLeft(r)):o+this.$size.scrollerWidth<r+this.characterWidth?this.session.setScrollLeft(Math.round(r+this.characterWidth-this.$size.scrollerWidth)):o<=this.$padding&&r-o<this.characterWidth&&this.session.setScrollLeft(0)
},this.getScrollTop=function(){
return this.session.getScrollTop()
},this.getScrollLeft=function(){
return this.session.getScrollLeft()
},this.getScrollTopRow=function(){
return this.scrollTop/this.lineHeight
},this.getScrollBottomRow=function(){
return Math.max(0,Math.floor((this.scrollTop+this.$size.scrollerHeight)/this.lineHeight)-1)
},this.scrollToRow=function(e){
this.session.setScrollTop(e*this.lineHeight)
},this.alignCursor=function(e,t){
typeof e=='number'&&(e={
row:e,
column:0
});
var n=this.$cursorLayer.getPixelPosition(e),r=this.$size.scrollerHeight-this.lineHeight,i=n.top-r*(t||0);
return this.session.setScrollTop(i),i
},this.STEPS=8,this.$calcSteps=function(e,t){
var n=0,r=this.STEPS,i=[],s=function(e,t,n){
return n*(Math.pow(e-1,3)+1)+t
};
for(n=0;n<r;++n)
i.push(s(n/this.STEPS,e,t-e));
return i
},this.scrollToLine=function(e,t,n,r){
var i=this.$cursorLayer.getPixelPosition({
row:e,
column:0
}),s=i.top;
t&&(s-=this.$size.scrollerHeight/2);
var o=this.scrollTop;
this.session.setScrollTop(s),n!==!1&&this.animateScrolling(o,r)
},this.animateScrolling=function(e,t){
var n=this.scrollTop;
if(!this.$animatedScroll)
return;
var r=this;
if(e==n)
return;
if(this.$scrollAnimation){
var i=this.$scrollAnimation.steps;
if(i.length){
e=i[0];
if(e==n)
return
}
}
var s=r.$calcSteps(e,n);
this.$scrollAnimation={
from:e,
to:n,
steps:s
},clearInterval(this.$timer),r.session.setScrollTop(s.shift()),this.$timer=setInterval(function(){
s.length?(r.session.setScrollTop(s.shift()),r.session.$scrollTop=n):n!=null?(r.session.$scrollTop=-1,r.session.setScrollTop(n),n=null):(r.$timer=clearInterval(r.$timer),r.$scrollAnimation=null,t&&t())
},10)
},this.scrollToY=function(e){
this.scrollTop!==e&&(this.$loop.schedule(this.CHANGE_SCROLL),this.scrollTop=e)
},this.scrollToX=function(e){
this.scrollLeft!==e&&(this.scrollLeft=e),this.$loop.schedule(this.CHANGE_H_SCROLL)
},this.scrollTo=function(e,t){
this.session.setScrollTop(t),this.session.setScrollLeft(t)
},this.scrollBy=function(e,t){
t&&this.session.setScrollTop(this.session.getScrollTop()+t),e&&this.session.setScrollLeft(this.session.getScrollLeft()+e)
},this.isScrollableBy=function(e,t){
if(t<0&&this.session.getScrollTop()>=1-this.scrollMargin.top)
return!0;
if(t>0&&this.session.getScrollTop()+this.$size.scrollerHeight-this.layerConfig.maxHeight-(this.$size.scrollerHeight-this.lineHeight)*this.$scrollPastEnd<-1+this.scrollMargin.bottom)
return!0;
if(e<0&&this.session.getScrollLeft()>=1-this.scrollMargin.left)
return!0;
if(e>0&&this.session.getScrollLeft()+this.$size.scrollerWidth-this.layerConfig.width<-1+this.scrollMargin.right)
return!0
},this.pixelToScreenCoordinates=function(e,t){
var n=this.scroller.getBoundingClientRect(),r=(e+this.scrollLeft-n.left-this.$padding)/this.characterWidth,i=Math.floor((t+this.scrollTop-n.top)/this.lineHeight),s=Math.round(r);
return{
row:i,
column:s,
side:r-s>0?1:-1
}
},this.screenToTextCoordinates=function(e,t){
var n=this.scroller.getBoundingClientRect(),r=Math.round((e+this.scrollLeft-n.left-this.$padding)/this.characterWidth),i=(t+this.scrollTop-n.top)/this.lineHeight;
return this.session.screenToDocumentPosition(i,Math.max(r,0))
},this.textToScreenCoordinates=function(e,t){
var n=this.scroller.getBoundingClientRect(),r=this.session.documentToScreenPosition(e,t),i=this.$padding+Math.round(r.column*this.characterWidth),s=r.row*this.lineHeight;
return{
pageX:n.left+i-this.scrollLeft,
pageY:n.top+s-this.scrollTop
}
},this.visualizeFocus=function(){
i.addCssClass(this.container,'ace_focus')
},this.visualizeBlur=function(){
i.removeCssClass(this.container,'ace_focus')
},this.showComposition=function(e){
this.$composition||(this.$composition={
keepTextAreaAtCursor:this.$keepTextAreaAtCursor,
cssText:this.textarea.style.cssText
}),this.$keepTextAreaAtCursor=!0,i.addCssClass(this.textarea,'ace_composition'),this.textarea.style.cssText='',this.$moveTextAreaToCursor()
},this.setCompositionText=function(e){
this.$moveTextAreaToCursor()
},this.hideComposition=function(){
if(!this.$composition)
return;
i.removeCssClass(this.textarea,'ace_composition'),this.$keepTextAreaAtCursor=this.$composition.keepTextAreaAtCursor,this.textarea.style.cssText=this.$composition.cssText,this.$composition=null
},this.setTheme=function(e,t){
function s(r){
if(n.$themeValue!=e)
return t&&t();
if(!r.cssClass)
return;
i.importCssString(r.cssText,r.cssClass,n.container.ownerDocument),n.theme&&i.removeCssClass(n.container,n.theme.cssClass),n.$theme=r.cssClass,n.theme=r,i.addCssClass(n.container,r.cssClass),i.setCssClass(n.container,'ace_dark',r.isDark);
var s='padding'in r?r.padding:4;
n.$padding&&s!=n.$padding&&n.setPadding(s),n.$size&&(n.$size.width=0,n.onResize()),n._dispatchEvent('themeLoaded',{theme:r}),t&&t()
}
var n=this;
this.$themeValue=e,n._dispatchEvent('themeChange',{theme:e});
if(!e||typeof e=='string'){
var r=e||'ace/theme/textmate';
o.loadModule([
'theme',
r
],s)
}else
s(e)
},this.getTheme=function(){
return this.$themeValue
},this.setStyle=function(e,t){
i.setCssClass(this.container,e,t!=0)
},this.unsetStyle=function(e){
i.removeCssClass(this.container,e)
},this.setMouseCursor=function(e){
this.content.style.cursor=e
},this.destroy=function(){
this.$textLayer.destroy(),this.$cursorLayer.destroy()
}
}.call(m.prototype),o.defineOptions(m.prototype,'renderer',{
animatedScroll:{initialValue:!1},
showInvisibles:{
set:function(e){
this.$textLayer.setShowInvisibles(e)&&this.$loop.schedule(this.CHANGE_TEXT)
},
initialValue:!1
},
showPrintMargin:{
set:function(){
this.$updatePrintMargin()
},
initialValue:!0
},
printMarginColumn:{
set:function(){
this.$updatePrintMargin()
},
initialValue:80
},
printMargin:{
set:function(e){
typeof e=='number'&&(this.$printMarginColumn=e),this.$showPrintMargin=!!e,this.$updatePrintMargin()
},
get:function(){
return this.$showPrintMargin&&this.$printMarginColumn
}
},
showGutter:{
set:function(e){
this.$gutter.style.display=e?'block':'none',this.onGutterResize()
},
initialValue:!0
},
fadeFoldWidgets:{
set:function(e){
i.setCssClass(this.$gutter,'ace_fade-fold-widgets',e)
},
initialValue:!1
},
showFoldWidgets:{
set:function(e){
this.$gutterLayer.setShowFoldWidgets(e)
},
initialValue:!0
},
displayIndentGuides:{
set:function(e){
this.$textLayer.setDisplayIndentGuides(e)&&this.$loop.schedule(this.CHANGE_TEXT)
},
initialValue:!0
},
highlightGutterLine:{
set:function(e){
if(!this.$gutterLineHighlight){
this.$gutterLineHighlight=i.createElement('div'),this.$gutterLineHighlight.className='ace_gutter-active-line',this.$gutter.appendChild(this.$gutterLineHighlight);
return
}
this.$gutterLineHighlight.style.display=e?'':'none',this.$cursorLayer.$pixelPos&&this.$updateGutterLineHighlight()
},
initialValue:!1,
value:!0
},
hScrollBarAlwaysVisible:{
set:function(e){
(!this.$hScrollBarAlwaysVisible||!this.$horizScroll)&&this.$loop.schedule(this.CHANGE_SCROLL)
},
initialValue:!1
},
vScrollBarAlwaysVisible:{
set:function(e){
(!this.$vScrollBarAlwaysVisible||!this.$vScroll)&&this.$loop.schedule(this.CHANGE_SCROLL)
},
initialValue:!1
},
fontSize:{
set:function(e){
typeof e=='number'&&(e+='px'),this.container.style.fontSize=e,this.updateFontSize()
},
initialValue:12
},
fontFamily:{
set:function(e){
this.container.style.fontFamily=e,this.updateFontSize()
}
},
maxLines:{
set:function(e){
this.updateFull()
}
},
minLines:{
set:function(e){
this.updateFull()
}
},
scrollPastEnd:{
set:function(e){
e=+e||0;
if(this.$scrollPastEnd==e)
return;
this.$scrollPastEnd=e,this.$loop.schedule(this.CHANGE_SCROLL)
},
initialValue:0,
handlesSet:!0
},
fixedWidthGutter:{
set:function(e){
this.$gutterLayer.$fixedWidth=!!e,this.$loop.schedule(this.CHANGE_GUTTER)
}
}
}),t.VirtualRenderer=m)
}),ace.define('ace/layer/gutter',[
'require',
'exports',
'module',
'ace/lib/dom',
'ace/lib/oop',
'ace/lib/lang',
'ace/lib/event_emitter'
],function(e,t,n){
var r=e('../lib/dom'),i=e('../lib/oop'),s=e('../lib/lang'),o=e('../lib/event_emitter').EventEmitter,u=function(e){
this.element=r.createElement('div'),this.element.className='ace_layer ace_gutter-layer',e.appendChild(this.element),this.setShowFoldWidgets(this.$showFoldWidgets),this.gutterWidth=0,this.$annotations=[],this.$updateAnnotations=this.$updateAnnotations.bind(this),this.$cells=[]
};
(function(){
i.implement(this,o),this.setSession=function(e){
this.session&&this.session.removeEventListener('change',this.$updateAnnotations),this.session=e,e.on('change',this.$updateAnnotations)
},this.addGutterDecoration=function(e,t){
window.console&&console.warn&&console.warn('deprecated use session.addGutterDecoration'),this.session.addGutterDecoration(e,t)
},this.removeGutterDecoration=function(e,t){
window.console&&console.warn&&console.warn('deprecated use session.removeGutterDecoration'),this.session.removeGutterDecoration(e,t)
},this.setAnnotations=function(e){
this.$annotations=[];
for(var t=0;t<e.length;t++){
var n=e[t],r=n.row,i=this.$annotations[r];
i||(i=this.$annotations[r]={text:[]});
var o=n.text;
o=o?s.escapeHTML(o):n.html||'',i.text.indexOf(o)===-1&&i.text.push(o);
var u=n.type;
u=='error'?i.className=' ace_error':u=='warning'&&i.className!=' ace_error'?i.className=' ace_warning':u=='info'&&!i.className&&(i.className=' ace_info')
}
},this.$updateAnnotations=function(e){
if(!this.$annotations.length)
return;
var t=e.data,n=t.range,r=n.start.row,i=n.end.row-r;
if(i!==0)
if(t.action=='removeText'||t.action=='removeLines')
this.$annotations.splice(r,i+1,null);
else{
var s=new Array(i+1);
s.unshift(r,1),this.$annotations.splice.apply(this.$annotations,s)
}
},this.update=function(e){
var t=e.firstRow,n=e.lastRow,i=this.session,s=i.getNextFoldLine(t),o=s?s.start.row:Infinity,u=this.$showFoldWidgets&&i.foldWidgets,a=i.$breakpoints,f=i.$decorations,l=i.$firstLineNumber,c=0,h=i.gutterRenderer,p=null,d=-1,v=t;
for(;;){
v>o&&(v=s.end.row+1,s=i.getNextFoldLine(v,s),o=s?s.start.row:Infinity);
if(v>n){
while(this.$cells.length>d+1)
p=this.$cells.pop(),this.element.removeChild(p.element);
break
}
p=this.$cells[++d],p||(p={
element:null,
textNode:null,
foldWidget:null
},p.element=r.createElement('div'),p.textNode=document.createTextNode(''),p.element.appendChild(p.textNode),this.element.appendChild(p.element),this.$cells[d]=p);
var m='ace_gutter-cell ';
a[v]&&(m+=a[v]),f[v]&&(m+=f[v]),this.$annotations[v]&&(m+=this.$annotations[v].className),p.element.className!=m&&(p.element.className=m);
var g=i.getRowLength(v)*e.lineHeight+'px';
g!=p.element.style.height&&(p.element.style.height=g);
if(u){
var y=u[v];
y==null&&(y=u[v]=i.getFoldWidget(v))
}
if(y){
p.foldWidget||(p.foldWidget=r.createElement('span'),p.element.appendChild(p.foldWidget));
var m='ace_fold-widget ace_'+y;
y=='start'&&v==o&&v<s.end.row?m+=' ace_closed':m+=' ace_open',p.foldWidget.className!=m&&(p.foldWidget.className=m);
var g=e.lineHeight+'px';
p.foldWidget.style.height!=g&&(p.foldWidget.style.height=g)
}else
p.foldWidget&&(p.element.removeChild(p.foldWidget),p.foldWidget=null);
var b=c=h?h.getText(i,v):v+l;
b!=p.textNode.data&&(p.textNode.data=b),v++
}
this.element.style.height=e.minHeight+'px';
if(this.$fixedWidth||i.$useWrapMode)
c=i.getLength();
var w=h?h.getWidth(i,c,e):c.toString().length*e.characterWidth,E=this.$padding||this.$computePadding();
w+=E.left+E.right,w!==this.gutterWidth&&!isNaN(w)&&(this.gutterWidth=w,this.element.style.width=Math.ceil(this.gutterWidth)+'px',this._emit('changeGutterWidth',w))
},this.$fixedWidth=!1,this.$showFoldWidgets=!0,this.setShowFoldWidgets=function(e){
e?r.addCssClass(this.element,'ace_folding-enabled'):r.removeCssClass(this.element,'ace_folding-enabled'),this.$showFoldWidgets=e,this.$padding=null
},this.getShowFoldWidgets=function(){
return this.$showFoldWidgets
},this.$computePadding=function(){
if(!this.element.firstChild)
return{
left:0,
right:0
};
var e=r.computedStyle(this.element.firstChild);
return this.$padding={},this.$padding.left=parseInt(e.paddingLeft)+1||0,this.$padding.right=parseInt(e.paddingRight)||0,this.$padding
},this.getRegion=function(e){
var t=this.$padding||this.$computePadding(),n=this.element.getBoundingClientRect();
if(e.x<t.left+n.left)
return'markers';
if(this.$showFoldWidgets&&e.x>n.right-t.right)
return'foldWidgets'
}
}.call(u.prototype),t.Gutter=u)
}),ace.define('ace/layer/marker',[
'require',
'exports',
'module',
'ace/range',
'ace/lib/dom'
],function(e,t,n){
var r=e('../range').Range,i=e('../lib/dom'),s=function(e){
this.element=i.createElement('div'),this.element.className='ace_layer ace_marker-layer',e.appendChild(this.element)
};
(function(){
this.$padding=0,this.setPadding=function(e){
this.$padding=e
},this.setSession=function(e){
this.session=e
},this.setMarkers=function(e){
this.markers=e
},this.update=function(e){
var e=e||this.config;
if(!e)
return;
this.config=e;
var t=[];
for(var n in this.markers){
var r=this.markers[n];
if(!r.range){
r.update(t,this,this.session,e);
continue
}
var s=r.range.clipRows(e.firstRow,e.lastRow);
if(s.isEmpty())
continue;
s=s.toScreenRange(this.session);
if(r.renderer){
var o=this.$getTop(s.start.row,e),u=this.$padding+s.start.column*e.characterWidth;
r.renderer(t,s,u,o,e)
}else
r.type=='fullLine'?this.drawFullLineMarker(t,s,r.clazz,e):r.type=='screenLine'?this.drawScreenLineMarker(t,s,r.clazz,e):s.isMultiLine()?r.type=='text'?this.drawTextMarker(t,s,r.clazz,e):this.drawMultiLineMarker(t,s,r.clazz,e):this.drawSingleLineMarker(t,s,r.clazz+' ace_start',e)
}
this.element=i.setInnerHtml(this.element,t.join(''))
},this.$getTop=function(e,t){
return(e-t.firstRowScreen)*t.lineHeight
},this.drawTextMarker=function(e,t,n,i,s){
var o=t.start.row,u=new r(o,t.start.column,o,this.session.getScreenLastRowColumn(o));
this.drawSingleLineMarker(e,u,n+' ace_start',i,1,s),o=t.end.row,u=new r(o,0,o,t.end.column),this.drawSingleLineMarker(e,u,n,i,0,s);
for(o=t.start.row+1;o<t.end.row;o++)
u.start.row=o,u.end.row=o,u.end.column=this.session.getScreenLastRowColumn(o),this.drawSingleLineMarker(e,u,n,i,1,s)
},this.drawMultiLineMarker=function(e,t,n,r,i){
var s=this.$padding,o=r.lineHeight,u=this.$getTop(t.start.row,r),a=s+t.start.column*r.characterWidth;
i=i||'',e.push('<div class=\'',n,' ace_start\' style=\'','height:',o,'px;','right:0;','top:',u,'px;','left:',a,'px;',i,'\'></div>'),u=this.$getTop(t.end.row,r);
var f=t.end.column*r.characterWidth;
e.push('<div class=\'',n,'\' style=\'','height:',o,'px;','width:',f,'px;','top:',u,'px;','left:',s,'px;',i,'\'></div>'),o=(t.end.row-t.start.row-1)*r.lineHeight;
if(o<0)
return;
u=this.$getTop(t.start.row+1,r),e.push('<div class=\'',n,'\' style=\'','height:',o,'px;','right:0;','top:',u,'px;','left:',s,'px;',i,'\'></div>')
},this.drawSingleLineMarker=function(e,t,n,r,i,s){
var o=r.lineHeight,u=(t.end.column+(i||0)-t.start.column)*r.characterWidth,a=this.$getTop(t.start.row,r),f=this.$padding+t.start.column*r.characterWidth;
e.push('<div class=\'',n,'\' style=\'','height:',o,'px;','width:',u,'px;','top:',a,'px;','left:',f,'px;',s||'','\'></div>')
},this.drawFullLineMarker=function(e,t,n,r,i){
var s=this.$getTop(t.start.row,r),o=r.lineHeight;
t.start.row!=t.end.row&&(o+=this.$getTop(t.end.row,r)-s),e.push('<div class=\'',n,'\' style=\'','height:',o,'px;','top:',s,'px;','left:0;right:0;',i||'','\'></div>')
},this.drawScreenLineMarker=function(e,t,n,r,i){
var s=this.$getTop(t.start.row,r),o=r.lineHeight;
e.push('<div class=\'',n,'\' style=\'','height:',o,'px;','top:',s,'px;','left:0;right:0;',i||'','\'></div>')
}
}.call(s.prototype),t.Marker=s)
}),ace.define('ace/layer/text',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/lib/dom',
'ace/lib/lang',
'ace/lib/useragent',
'ace/lib/event_emitter'
],function(e,t,n){
var r=e('../lib/oop'),i=e('../lib/dom'),s=e('../lib/lang'),o=e('../lib/useragent'),u=e('../lib/event_emitter').EventEmitter,a=function(e){
this.element=i.createElement('div'),this.element.className='ace_layer ace_text-layer',e.appendChild(this.element),this.$characterSize={
width:0,
height:0
},this.checkForSizeChanges(),this.$pollSizeChanges()
};
(function(){
r.implement(this,u),this.EOF_CHAR='',this.EOL_CHAR='',this.TAB_CHAR='',this.SPACE_CHAR='',this.$padding=0,this.setPadding=function(e){
this.$padding=e,this.element.style.padding='0 '+e+'px'
},this.getLineHeight=function(){
return this.$characterSize.height||0
},this.getCharacterWidth=function(){
return this.$characterSize.width||0
},this.checkForSizeChanges=function(){
var e=this.$measureSizes();
if(e&&(this.$characterSize.width!==e.width||this.$characterSize.height!==e.height)){
this.$measureNode.style.fontWeight='bold';
var t=this.$measureSizes();
this.$measureNode.style.fontWeight='',this.$characterSize=e,this.allowBoldFonts=t&&t.width===e.width&&t.height===e.height,this._emit('changeCharacterSize',{data:e})
}
},this.$pollSizeChanges=function(){
var e=this;
this.$pollSizeChangesTimer=setInterval(function(){
e.checkForSizeChanges()
},500)
},this.$fontStyles={
fontFamily:1,
fontSize:1,
fontWeight:1,
fontStyle:1,
lineHeight:1
},this.$measureSizes=o.isIE||o.isOldGecko?function(){
var e=1000;
if(!this.$measureNode){
var t=this.$measureNode=i.createElement('div'),n=t.style;
n.width=n.height='auto',n.left=n.top=-e*40+'px',n.visibility='hidden',n.position='fixed',n.overflow='visible',n.whiteSpace='nowrap',t.innerHTML=s.stringRepeat('Xy',e);
if(this.element.ownerDocument.body)
this.element.ownerDocument.body.appendChild(t);
else{
var r=this.element.parentNode;
while(!i.hasCssClass(r,'ace_editor'))
r=r.parentNode;
r.appendChild(t)
}
}
if(!this.element.offsetWidth)
return null;
var n=this.$measureNode.style,o=i.computedStyle(this.element);
for(var u in this.$fontStyles)
n[u]=o[u];
var a={
height:this.$measureNode.offsetHeight,
width:this.$measureNode.offsetWidth/(e*2)
};
return a.width==0||a.height==0?null:a
}:function(){
if(!this.$measureNode){
var e=this.$measureNode=i.createElement('div'),t=e.style;
t.width=t.height='auto',t.left=t.top='-100px',t.visibility='hidden',t.position='fixed',t.overflow='visible',t.whiteSpace='nowrap',e.innerHTML=s.stringRepeat('X',100);
var n=this.element.parentNode;
while(n&&!i.hasCssClass(n,'ace_editor'))
n=n.parentNode;
if(!n)
return this.$measureNode=null;
n.appendChild(e)
}
var r=this.$measureNode.getBoundingClientRect(),o={
height:r.height,
width:r.width/100
};
return o.width==0||o.height==0?null:o
},this.setSession=function(e){
this.session=e,this.$computeTabString()
},this.showInvisibles=!1,this.setShowInvisibles=function(e){
return this.showInvisibles==e?!1:(this.showInvisibles=e,this.$computeTabString(),!0)
},this.displayIndentGuides=!0,this.setDisplayIndentGuides=function(e){
return this.displayIndentGuides==e?!1:(this.displayIndentGuides=e,this.$computeTabString(),!0)
},this.$tabStrings=[],this.onChangeTabSize=this.$computeTabString=function(){
var e=this.session.getTabSize();
this.tabSize=e;
var t=this.$tabStrings=[0];
for(var n=1;n<e+1;n++)
this.showInvisibles?t.push('<span class=\'ace_invisible\'>'+this.TAB_CHAR+s.stringRepeat('',n-1)+'</span>'):t.push(s.stringRepeat('',n));
if(this.displayIndentGuides){
this.$indentGuideRe=/\s\S| \t|\t |\s$/;
var r='ace_indent-guide';
if(this.showInvisibles){
r+=' ace_invisible';
var i=s.stringRepeat(this.SPACE_CHAR,this.tabSize),o=this.TAB_CHAR+s.stringRepeat('',this.tabSize-1)
}else
var i=s.stringRepeat('',this.tabSize),o=i;
this.$tabStrings[' ']='<span class=\''+r+'\'>'+i+'</span>',this.$tabStrings['	']='<span class=\''+r+'\'>'+o+'</span>'
}
},this.updateLines=function(e,t,n){
(this.config.lastRow!=e.lastRow||this.config.firstRow!=e.firstRow)&&this.scrollLines(e),this.config=e;
var r=Math.max(t,e.firstRow),s=Math.min(n,e.lastRow),o=this.element.childNodes,u=0;
for(var a=e.firstRow;a<r;a++){
var f=this.session.getFoldLine(a);
if(f){
if(f.containsRow(r)){
r=f.start.row;
break
}
a=f.end.row
}
u++
}
var a=r,f=this.session.getNextFoldLine(a),l=f?f.start.row:Infinity;
for(;;){
a>l&&(a=f.end.row+1,f=this.session.getNextFoldLine(a,f),l=f?f.start.row:Infinity);
if(a>s)
break;
var c=o[u++];
if(c){
var h=[];
this.$renderLine(h,a,!this.$useLineGroups(),a==l?f:!1),c.style.height=e.lineHeight*this.session.getRowLength(a)+'px',i.setInnerHtml(c,h.join(''))
}
a++
}
},this.scrollLines=function(e){
var t=this.config;
this.config=e;
if(!t||t.lastRow<e.firstRow)
return this.update(e);
if(e.lastRow<t.firstRow)
return this.update(e);
var n=this.element;
if(t.firstRow<e.firstRow)
for(var r=this.session.getFoldedRowCount(t.firstRow,e.firstRow-1);r>0;r--)
n.removeChild(n.firstChild);
if(t.lastRow>e.lastRow)
for(var r=this.session.getFoldedRowCount(e.lastRow+1,t.lastRow);r>0;r--)
n.removeChild(n.lastChild);
if(e.firstRow<t.firstRow){
var i=this.$renderLinesFragment(e,e.firstRow,t.firstRow-1);
n.firstChild?n.insertBefore(i,n.firstChild):n.appendChild(i)
}
if(e.lastRow>t.lastRow){
var i=this.$renderLinesFragment(e,t.lastRow+1,e.lastRow);
n.appendChild(i)
}
},this.$renderLinesFragment=function(e,t,n){
var r=this.element.ownerDocument.createDocumentFragment(),s=t,o=this.session.getNextFoldLine(s),u=o?o.start.row:Infinity;
for(;;){
s>u&&(s=o.end.row+1,o=this.session.getNextFoldLine(s,o),u=o?o.start.row:Infinity);
if(s>n)
break;
var a=i.createElement('div'),f=[];
this.$renderLine(f,s,!1,s==u?o:!1),a.innerHTML=f.join('');
if(this.$useLineGroups())
a.className='ace_line_group',r.appendChild(a),a.style.height=e.lineHeight*this.session.getRowLength(s)+'px';
else{
var l=a.childNodes;
while(l.length)
r.appendChild(l[0])
}
s++
}
return r
},this.update=function(e){
this.config=e;
var t=[],n=e.firstRow,r=e.lastRow,s=n,o=this.session.getNextFoldLine(s),u=o?o.start.row:Infinity;
for(;;){
s>u&&(s=o.end.row+1,o=this.session.getNextFoldLine(s,o),u=o?o.start.row:Infinity);
if(s>r)
break;
this.$useLineGroups()&&t.push('<div class=\'ace_line_group\' style=\'height:',e.lineHeight*this.session.getRowLength(s),'px\'>'),this.$renderLine(t,s,!1,s==u?o:!1),this.$useLineGroups()&&t.push('</div>'),s++
}
this.element=i.setInnerHtml(this.element,t.join(''))
},this.$textToken={
text:!0,
rparen:!0,
lparen:!0
},this.$renderToken=function(e,t,n,r){
var i=this,o=/\t|&|<|( +)|([\x00-\x1f\x80-\xa0\u1680\u180E\u2000-\u200f\u2028\u2029\u202F\u205F\u3000\uFEFF])|[\u1100-\u115F\u11A3-\u11A7\u11FA-\u11FF\u2329-\u232A\u2E80-\u2E99\u2E9B-\u2EF3\u2F00-\u2FD5\u2FF0-\u2FFB\u3000-\u303E\u3041-\u3096\u3099-\u30FF\u3105-\u312D\u3131-\u318E\u3190-\u31BA\u31C0-\u31E3\u31F0-\u321E\u3220-\u3247\u3250-\u32FE\u3300-\u4DBF\u4E00-\uA48C\uA490-\uA4C6\uA960-\uA97C\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFAFF\uFE10-\uFE19\uFE30-\uFE52\uFE54-\uFE66\uFE68-\uFE6B\uFF01-\uFF60\uFFE0-\uFFE6]/g,u=function(e,n,r,o,u){
if(n)
return i.showInvisibles?'<span class=\'ace_invisible\'>'+s.stringRepeat(i.SPACE_CHAR,e.length)+'</span>':s.stringRepeat('',e.length);
if(e=='&')
return'&#38;';
if(e=='<')
return'&#60;';
if(e=='	'){
var a=i.session.getScreenTabSize(t+o);
return t+=a-1,i.$tabStrings[a]
}
if(e==''){
var f=i.showInvisibles?'ace_cjk ace_invisible':'ace_cjk',l=i.showInvisibles?i.SPACE_CHAR:'';
return t+=1,'<span class=\''+f+'\' style=\'width:'+i.config.characterWidth*2+'px\'>'+l+'</span>'
}
return r?'<span class=\'ace_invisible ace_invalid\'>'+i.SPACE_CHAR+'</span>':(t+=1,'<span class=\'ace_cjk\' style=\'width:'+i.config.characterWidth*2+'px\'>'+e+'</span>')
},a=r.replace(o,u);
if(!this.$textToken[n.type]){
var f='ace_'+n.type.replace(/\./g,' ace_'),l='';
n.type=='fold'&&(l=' style=\'width:'+n.value.length*this.config.characterWidth+'px;\' '),e.push('<span class=\'',f,'\'',l,'>',a,'</span>')
}else
e.push(a);
return t+r.length
},this.renderIndentGuide=function(e,t,n){
var r=t.search(this.$indentGuideRe);
return r<=0||r>=n?t:t[0]==' '?(r-=r%this.tabSize,e.push(s.stringRepeat(this.$tabStrings[' '],r/this.tabSize)),t.substr(r)):t[0]=='	'?(e.push(s.stringRepeat(this.$tabStrings['	'],r)),t.substr(r)):t
},this.$renderWrappedLine=function(e,t,n,r){
var i=0,s=0,o=n[0],u=0;
for(var a=0;a<t.length;a++){
var f=t[a],l=f.value;
if(a==0&&this.displayIndentGuides){
i=l.length,l=this.renderIndentGuide(e,l,o);
if(!l)
continue;
i-=l.length
}
if(i+l.length<o)
u=this.$renderToken(e,u,f,l),i+=l.length;
else{
while(i+l.length>=o)
u=this.$renderToken(e,u,f,l.substring(0,o-i)),l=l.substring(o-i),i=o,r||e.push('</div>','<div class=\'ace_line\' style=\'height:',this.config.lineHeight,'px\'>'),s++,u=0,o=n[s]||Number.MAX_VALUE;
l.length!=0&&(i+=l.length,u=this.$renderToken(e,u,f,l))
}
}
},this.$renderSimpleLine=function(e,t){
var n=0,r=t[0],i=r.value;
this.displayIndentGuides&&(i=this.renderIndentGuide(e,i)),i&&(n=this.$renderToken(e,n,r,i));
for(var s=1;s<t.length;s++)
r=t[s],i=r.value,n=this.$renderToken(e,n,r,i)
},this.$renderLine=function(e,t,n,r){
!r&&r!=0&&(r=this.session.getFoldLine(t));
if(r)
var i=this.$getFoldLineTokens(t,r);
else
var i=this.session.getTokens(t);
n||e.push('<div class=\'ace_line\' style=\'height:',this.config.lineHeight*(this.$useLineGroups()?1:this.session.getRowLength(t)),'px\'>');
if(i.length){
var s=this.session.getRowSplitData(t);
s&&s.length?this.$renderWrappedLine(e,i,s,n):this.$renderSimpleLine(e,i)
}
this.showInvisibles&&(r&&(t=r.end.row),e.push('<span class=\'ace_invisible\'>',t==this.session.getLength()-1?this.EOF_CHAR:this.EOL_CHAR,'</span>')),n||e.push('</div>')
},this.$getFoldLineTokens=function(e,t){
function i(e,t,n){
var i=0,s=0;
while(s+e[i].value.length<t){
s+=e[i].value.length,i++;
if(i==e.length)
return
}
if(s!=t){
var o=e[i].value.substring(t-s);
o.length>n-t&&(o=o.substring(0,n-t)),r.push({
type:e[i].type,
value:o
}),s=t+o.length,i+=1
}
while(s<n&&i<e.length){
var o=e[i].value;
o.length+s>n?r.push({
type:e[i].type,
value:o.substring(0,n-s)
}):r.push(e[i]),s+=o.length,i+=1
}
}
var n=this.session,r=[],s=n.getTokens(e);
return t.walk(function(e,t,o,u,a){
e!=null?r.push({
type:'fold',
value:e
}):(a&&(s=n.getTokens(t)),s.length&&i(s,u,o))
},t.end.row,this.session.getLine(t.end.row).length),r
},this.$useLineGroups=function(){
return this.session.getUseWrapMode()
},this.destroy=function(){
clearInterval(this.$pollSizeChangesTimer),this.$measureNode&&this.$measureNode.parentNode.removeChild(this.$measureNode),delete this.$measureNode
}
}.call(a.prototype),t.Text=a)
}),ace.define('ace/layer/cursor',[
'require',
'exports',
'module',
'ace/lib/dom'
],function(e,t,n){
var r=e('../lib/dom'),i=function(e){
this.element=r.createElement('div'),this.element.className='ace_layer ace_cursor-layer',e.appendChild(this.element),this.isVisible=!1,this.isBlinking=!0,this.blinkInterval=1000,this.smoothBlinking=!1,this.cursors=[],this.cursor=this.addCursor(),r.addCssClass(this.element,'ace_hidden-cursors')
};
(function(){
this.$padding=0,this.setPadding=function(e){
this.$padding=e
},this.setSession=function(e){
this.session=e
},this.setBlinking=function(e){
e!=this.isBlinking&&(this.isBlinking=e,this.restartTimer())
},this.setBlinkInterval=function(e){
e!=this.blinkInterval&&(this.blinkInterval=e,this.restartTimer())
},this.setSmoothBlinking=function(e){
e!=this.smoothBlinking&&(this.smoothBlinking=e,e?r.addCssClass(this.element,'ace_smooth-blinking'):r.removeCssClass(this.element,'ace_smooth-blinking'),this.restartTimer())
},this.addCursor=function(){
var e=r.createElement('div');
return e.className='ace_cursor',this.element.appendChild(e),this.cursors.push(e),e
},this.removeCursor=function(){
if(this.cursors.length>1){
var e=this.cursors.pop();
return e.parentNode.removeChild(e),e
}
},this.hideCursor=function(){
this.isVisible=!1,r.addCssClass(this.element,'ace_hidden-cursors'),this.restartTimer()
},this.showCursor=function(){
this.isVisible=!0,r.removeCssClass(this.element,'ace_hidden-cursors'),this.restartTimer()
},this.restartTimer=function(){
clearInterval(this.intervalId),clearTimeout(this.timeoutId),this.smoothBlinking&&r.removeCssClass(this.element,'ace_smooth-blinking');
for(var e=this.cursors.length;e--;)
this.cursors[e].style.opacity='';
if(!this.isBlinking||!this.blinkInterval||!this.isVisible)
return;
this.smoothBlinking&&setTimeout(function(){
r.addCssClass(this.element,'ace_smooth-blinking')
}.bind(this));
var t=function(){
this.timeoutId=setTimeout(function(){
for(var e=this.cursors.length;e--;)
this.cursors[e].style.opacity=0
}.bind(this),0.6*this.blinkInterval)
}.bind(this);
this.intervalId=setInterval(function(){
for(var e=this.cursors.length;e--;)
this.cursors[e].style.opacity='';
t()
}.bind(this),this.blinkInterval),t()
},this.getPixelPosition=function(e,t){
if(!this.config||!this.session)
return{
left:0,
top:0
};
e||(e=this.session.selection.getCursor());
var n=this.session.documentToScreenPosition(e),r=this.$padding+n.column*this.config.characterWidth,i=(n.row-(t?this.config.firstRowScreen:0))*this.config.lineHeight;
return{
left:r,
top:i
}
},this.update=function(e){
this.config=e;
var t=this.session.$selectionMarkers,n=0,r=0;
if(t===undefined||t.length===0)
t=[{cursor:null}];
for(var n=0,i=t.length;n<i;n++){
var s=this.getPixelPosition(t[n].cursor,!0);
if((s.top>e.height+e.offset||s.top<-e.offset)&&n>1)
continue;
var o=(this.cursors[r++]||this.addCursor()).style;
o.left=s.left+'px',o.top=s.top+'px',o.width=e.characterWidth+'px',o.height=e.lineHeight+'px'
}
while(this.cursors.length>r)
this.removeCursor();
var u=this.session.getOverwrite();
this.$setOverwrite(u),this.$pixelPos=s,this.restartTimer()
},this.$setOverwrite=function(e){
e!=this.overwrite&&(this.overwrite=e,e?r.addCssClass(this.element,'ace_overwrite-cursors'):r.removeCssClass(this.element,'ace_overwrite-cursors'))
},this.destroy=function(){
clearInterval(this.intervalId),clearTimeout(this.timeoutId)
}
}.call(i.prototype),t.Cursor=i)
}),ace.define('ace/scrollbar',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/lib/dom',
'ace/lib/event',
'ace/lib/event_emitter'
],function(e,t,n){
var r=e('./lib/oop'),i=e('./lib/dom'),s=e('./lib/event'),o=e('./lib/event_emitter').EventEmitter,u=function(e,t){
this.element=i.createElement('div'),this.element.className='ace_scrollbar',this.inner=i.createElement('div'),this.inner.className='ace_scrollbar-inner',this.element.appendChild(this.inner),e.appendChild(this.element),t.$scrollbarWidth=this.width=i.scrollbarWidth(e.ownerDocument),t.$scrollbarWidth=this.width=i.scrollbarWidth(e.ownerDocument),this.fullWidth=this.width,this.inner.style.width=this.element.style.width=(this.width||15)+5+'px',this.setVisible(!1),this.element.style.overflowY='scroll',s.addListener(this.element,'scroll',this.onScrollV.bind(this)),s.addListener(this.element,'mousedown',s.preventDefault)
},a=function(e,t){
this.element=i.createElement('div'),this.element.className='ace_scrollbar-h',this.inner=i.createElement('div'),this.inner.className='ace_scrollbar-inner',this.element.appendChild(this.inner),e.appendChild(this.element),this.height=t.$scrollbarWidth,this.fullHeight=this.height,this.inner.style.height=this.element.style.height=(this.height||15)+5+'px',this.setVisible(!1),this.element.style.overflowX='scroll',s.addListener(this.element,'scroll',this.onScrollH.bind(this)),s.addListener(this.element,'mousedown',s.preventDefault)
};
(function(){
r.implement(this,o),this.setVisible=function(e){
e?(this.element.style.display='',this.fullWidth&&(this.width=this.fullWidth),this.fullHeight&&(this.height=this.fullHeight)):(this.element.style.display='none',this.height=this.width=0)
},this.onScrollV=function(){
this.skipEvent||(this.scrollTop=this.element.scrollTop,this._emit('scroll',{data:this.scrollTop})),this.skipEvent=!1
},this.onScrollH=function(){
this.skipEvent||(this.scrollLeft=this.element.scrollLeft,this._emit('scroll',{data:this.scrollLeft})),this.skipEvent=!1
},this.getWidth=function(){
return this.width
},this.getHeight=function(){
return this.height
},this.setHeight=function(e){
this.element.style.height=e+'px'
},this.setWidth=function(e){
this.element.style.width=e+'px'
},this.setInnerHeight=function(e){
this.inner.style.height=e+'px'
},this.setInnerWidth=function(e){
this.inner.style.width=e+'px'
},this.setScrollTop=function(e){
this.scrollTop!=e&&(this.skipEvent=!0,this.scrollTop=this.element.scrollTop=e)
},this.setScrollLeft=function(e){
this.scrollLeft!=e&&(this.skipEvent=!0,this.scrollLeft=this.element.scrollLeft=e)
}
}.call(u.prototype),a.prototype=u.prototype,t.ScrollBar=u,t.ScrollBarV=u,t.ScrollBarH=a)
}),ace.define('ace/renderloop',[
'require',
'exports',
'module',
'ace/lib/event'
],function(e,t,n){
var r=e('./lib/event'),i=function(e,t){
this.onRender=e,this.pending=!1,this.changes=0,this.window=t||window
};
(function(){
this.schedule=function(e){
this.changes=this.changes|e;
if(!this.pending){
this.pending=!0;
var t=this;
r.nextFrame(function(){
t.pending=!1;
var e;
while(e=t.changes)
t.changes=0,t.onRender(e)
},this.window)
}
}
}.call(i.prototype),t.RenderLoop=i)
}),ace.define('ace/multi_select',[
'require',
'exports',
'module',
'ace/range_list',
'ace/range',
'ace/selection',
'ace/mouse/multi_select_handler',
'ace/lib/event',
'ace/lib/lang',
'ace/commands/multi_select_commands',
'ace/search',
'ace/edit_session',
'ace/editor',
'ace/config'
],function(e,t,n){
function h(e,t,n){
return c.$options.wrap=!0,c.$options.needle=t,c.$options.backwards=n==-1,c.find(e)
}
function v(e,t){
return e.row==t.row&&e.column==t.column
}
function m(e){
if(e.$multiselectOnSessionChange)
return;
e.$onAddRange=e.$onAddRange.bind(e),e.$onRemoveRange=e.$onRemoveRange.bind(e),e.$onMultiSelect=e.$onMultiSelect.bind(e),e.$onSingleSelect=e.$onSingleSelect.bind(e),e.$multiselectOnSessionChange=t.onSessionChange.bind(e),e.$multiselectOnSessionChange(e),e.on('changeSession',e.$multiselectOnSessionChange),e.on('mousedown',o),e.commands.addCommands(f.defaultCommands),g(e)
}
function g(e){
function r(t){
n&&(e.renderer.setMouseCursor(''),n=!1)
}
var t=e.textInput.getElement(),n=!1;
u.addListener(t,'keydown',function(t){
t.keyCode==18&&!(t.ctrlKey||t.shiftKey||t.metaKey)?n||(e.renderer.setMouseCursor('crosshair'),n=!0):n&&r()
}),u.addListener(t,'keyup',r),u.addListener(t,'blur',r)
}
var r=e('./range_list').RangeList,i=e('./range').Range,s=e('./selection').Selection,o=e('./mouse/multi_select_handler').onMouseDown,u=e('./lib/event'),a=e('./lib/lang'),f=e('./commands/multi_select_commands');
t.commands=f.defaultCommands.concat(f.multiSelectCommands);
var l=e('./search').Search,c=new l,p=e('./edit_session').EditSession;
(function(){
this.getSelectionMarkers=function(){
return this.$selectionMarkers
}
}.call(p.prototype),function(){
this.ranges=null,this.rangeList=null,this.addRange=function(e,t){
if(!e)
return;
if(!this.inMultiSelectMode&&this.rangeCount==0){
var n=this.toOrientedRange();
this.rangeList.add(n),this.rangeList.add(e);
if(this.rangeList.ranges.length!=2)
return this.rangeList.removeAll(),t||this.fromOrientedRange(e);
this.rangeList.removeAll(),this.rangeList.add(n),this.$onAddRange(n)
}
e.cursor||(e.cursor=e.end);
var r=this.rangeList.add(e);
return this.$onAddRange(e),r.length&&this.$onRemoveRange(r),this.rangeCount>1&&!this.inMultiSelectMode&&(this._emit('multiSelect'),this.inMultiSelectMode=!0,this.session.$undoSelect=!1,this.rangeList.attach(this.session)),t||this.fromOrientedRange(e)
},this.toSingleRange=function(e){
e=e||this.ranges[0];
var t=this.rangeList.removeAll();
t.length&&this.$onRemoveRange(t),e&&this.fromOrientedRange(e)
},this.substractPoint=function(e){
var t=this.rangeList.substractPoint(e);
if(t)
return this.$onRemoveRange(t),t[0]
},this.mergeOverlappingRanges=function(){
var e=this.rangeList.merge();
e.length?this.$onRemoveRange(e):this.ranges[0]&&this.fromOrientedRange(this.ranges[0])
},this.$onAddRange=function(e){
this.rangeCount=this.rangeList.ranges.length,this.ranges.unshift(e),this._emit('addRange',{range:e})
},this.$onRemoveRange=function(e){
this.rangeCount=this.rangeList.ranges.length;
if(this.rangeCount==1&&this.inMultiSelectMode){
var t=this.rangeList.ranges.pop();
e.push(t),this.rangeCount=0
}
for(var n=e.length;n--;){
var r=this.ranges.indexOf(e[n]);
this.ranges.splice(r,1)
}
this._emit('removeRange',{ranges:e}),this.rangeCount==0&&this.inMultiSelectMode&&(this.inMultiSelectMode=!1,this._emit('singleSelect'),this.session.$undoSelect=!0,this.rangeList.detach(this.session)),t=t||this.ranges[0],t&&!t.isEqual(this.getRange())&&this.fromOrientedRange(t)
},this.$initRangeList=function(){
if(this.rangeList)
return;
this.rangeList=new r,this.ranges=[],this.rangeCount=0
},this.getAllRanges=function(){
return this.rangeCount?this.rangeList.ranges.concat():[this.getRange()]
},this.splitIntoLines=function(){
if(this.rangeCount>1){
var e=this.rangeList.ranges,t=e[e.length-1],n=i.fromPoints(e[0].start,t.end);
this.toSingleRange(),this.setSelectionRange(n,t.cursor==t.start)
}else{
var n=this.getRange(),r=this.isBackwards(),s=n.start.row,o=n.end.row;
if(s==o){
if(r)
var u=n.end,a=n.start;
else
var u=n.start,a=n.end;
this.addRange(i.fromPoints(a,a)),this.addRange(i.fromPoints(u,u));
return
}
var f=[],l=this.getLineRange(s,!0);
l.start.column=n.start.column,f.push(l);
for(var c=s+1;c<o;c++)
f.push(this.getLineRange(c,!0));
l=this.getLineRange(o,!0),l.end.column=n.end.column,f.push(l),f.forEach(this.addRange,this)
}
},this.toggleBlockSelection=function(){
if(this.rangeCount>1){
var e=this.rangeList.ranges,t=e[e.length-1],n=i.fromPoints(e[0].start,t.end);
this.toSingleRange(),this.setSelectionRange(n,t.cursor==t.start)
}else{
var r=this.session.documentToScreenPosition(this.selectionLead),s=this.session.documentToScreenPosition(this.selectionAnchor),o=this.rectangularRangeBlock(r,s);
o.forEach(this.addRange,this)
}
},this.rectangularRangeBlock=function(e,t,n){
var r=[],s=e.column<t.column;
if(s)
var o=e.column,u=t.column;
else
var o=t.column,u=e.column;
var a=e.row<t.row;
if(a)
var f=e.row,l=t.row;
else
var f=t.row,l=e.row;
o<0&&(o=0),f<0&&(f=0),f==l&&(n=!0);
for(var c=f;c<=l;c++){
var h=i.fromPoints(this.session.screenToDocumentPosition(c,o),this.session.screenToDocumentPosition(c,u));
if(h.isEmpty()){
if(p&&v(h.end,p))
break;
var p=h.end
}
h.cursor=s?h.start:h.end,r.push(h)
}
a&&r.reverse();
if(!n){
var d=r.length-1;
while(r[d].isEmpty()&&d>0)
d--;
if(d>0){
var m=0;
while(r[m].isEmpty())
m++
}
for(var g=d;g>=m;g--)
r[g].isEmpty()&&r.splice(g,1)
}
return r
}
}.call(s.prototype));
var d=e('./editor').Editor;
(function(){
this.updateSelectionMarkers=function(){
this.renderer.updateCursor(),this.renderer.updateBackMarkers()
},this.addSelectionMarker=function(e){
e.cursor||(e.cursor=e.end);
var t=this.getSelectionStyle();
return e.marker=this.session.addMarker(e,'ace_selection',t),this.session.$selectionMarkers.push(e),this.session.selectionMarkerCount=this.session.$selectionMarkers.length,e
},this.removeSelectionMarker=function(e){
if(!e.marker)
return;
this.session.removeMarker(e.marker);
var t=this.session.$selectionMarkers.indexOf(e);
t!=-1&&this.session.$selectionMarkers.splice(t,1),this.session.selectionMarkerCount=this.session.$selectionMarkers.length
},this.removeSelectionMarkers=function(e){
var t=this.session.$selectionMarkers;
for(var n=e.length;n--;){
var r=e[n];
if(!r.marker)
continue;
this.session.removeMarker(r.marker);
var i=t.indexOf(r);
i!=-1&&t.splice(i,1)
}
this.session.selectionMarkerCount=t.length
},this.$onAddRange=function(e){
this.addSelectionMarker(e.range),this.renderer.updateCursor(),this.renderer.updateBackMarkers()
},this.$onRemoveRange=function(e){
this.removeSelectionMarkers(e.ranges),this.renderer.updateCursor(),this.renderer.updateBackMarkers()
},this.$onMultiSelect=function(e){
if(this.inMultiSelectMode)
return;
this.inMultiSelectMode=!0,this.setStyle('ace_multiselect'),this.keyBinding.addKeyboardHandler(f.keyboardHandler),this.commands.setDefaultHandler('exec',this.$onMultiSelectExec),this.renderer.updateCursor(),this.renderer.updateBackMarkers()
},this.$onSingleSelect=function(e){
if(this.session.multiSelect.inVirtualMode)
return;
this.inMultiSelectMode=!1,this.unsetStyle('ace_multiselect'),this.keyBinding.removeKeyboardHandler(f.keyboardHandler),this.commands.removeDefaultHandler('exec',this.$onMultiSelectExec),this.renderer.updateCursor(),this.renderer.updateBackMarkers()
},this.$onMultiSelectExec=function(e){
var t=e.command,n=e.editor;
if(!n.multiSelect)
return;
if(!t.multiSelectAction){
var r=t.exec(n,e.args||{});
n.multiSelect.addRange(n.multiSelect.toOrientedRange()),n.multiSelect.mergeOverlappingRanges()
}else
t.multiSelectAction=='forEach'?r=n.forEachSelection(t,e.args):t.multiSelectAction=='forEachLine'?r=n.forEachSelection(t,e.args,!0):t.multiSelectAction=='single'?(n.exitMultiSelectMode(),r=t.exec(n,e.args||{})):r=t.multiSelectAction(n,e.args||{});
return r
},this.forEachSelection=function(e,t,n){
if(this.inVirtualSelectionMode)
return;
var r=this.session,i=this.selection,o=i.rangeList,u,a=i._eventRegistry;
i._eventRegistry={};
var f=new s(r);
this.inVirtualSelectionMode=!0;
for(var l=o.ranges.length;l--;){
if(n)
while(l>0&&o.ranges[l].start.row==o.ranges[l-1].end.row)
l--;
f.fromOrientedRange(o.ranges[l]),this.selection=r.selection=f;
var c=e.exec(this,t||{});
!u==undefined&&(u=c),f.toOrientedRange(o.ranges[l])
}
f.detach(),this.selection=r.selection=i,this.inVirtualSelectionMode=!1,i._eventRegistry=a,i.mergeOverlappingRanges();
var h=this.renderer.$scrollAnimation;
return this.onCursorChange(),this.onSelectionChange(),h&&h.from==h.to&&this.renderer.animateScrolling(h.from),u
},this.exitMultiSelectMode=function(){
if(!this.inMultiSelectMode||this.inVirtualSelectionMode)
return;
this.multiSelect.toSingleRange()
},this.getSelectedText=function(){
var e='';
if(this.inMultiSelectMode&&!this.inVirtualSelectionMode){
var t=this.multiSelect.rangeList.ranges,n=[];
for(var r=0;r<t.length;r++)
n.push(this.session.getTextRange(t[r]));
var i=this.session.getDocument().getNewLineCharacter();
e=n.join(i),e.length==(n.length-1)*i.length&&(e='')
}else
this.selection.isEmpty()||(e=this.session.getTextRange(this.getSelectionRange()));
return e
},this.onPaste=function(e){
if(this.$readOnly)
return;
this._signal('paste',e);
if(!this.inMultiSelectMode||this.inVirtualSelectionMode)
return this.insert(e);
var t=e.split(/\r\n|\r|\n/),n=this.selection.rangeList.ranges;
if(t.length>n.length||t.length<2||!t[1])
return this.commands.exec('insertstring',this,e);
for(var r=n.length;r--;){
var i=n[r];
i.isEmpty()||this.session.remove(i),this.session.insert(i.start,t[r])
}
},this.findAll=function(e,t,n){
t=t||{},t.needle=e||t.needle,this.$search.set(t);
var r=this.$search.findAll(this.session);
if(!r.length)
return 0;
this.$blockScrolling+=1;
var i=this.multiSelect;
n||i.toSingleRange(r[0]);
for(var s=r.length;s--;)
i.addRange(r[s],!0);
return this.$blockScrolling-=1,r.length
},this.selectMoreLines=function(e,t){
var n=this.selection.toOrientedRange(),r=n.cursor==n.end,s=this.session.documentToScreenPosition(n.cursor);
this.selection.$desiredColumn&&(s.column=this.selection.$desiredColumn);
var o=this.session.screenToDocumentPosition(s.row+e,s.column);
if(!n.isEmpty())
var u=this.session.documentToScreenPosition(r?n.end:n.start),a=this.session.screenToDocumentPosition(u.row+e,u.column);
else
var a=o;
if(r){
var f=i.fromPoints(o,a);
f.cursor=f.start
}else{
var f=i.fromPoints(a,o);
f.cursor=f.end
}
f.desiredColumn=s.column;
if(!this.selection.inMultiSelectMode)
this.selection.addRange(n);
else if(t)
var l=n.cursor;
this.selection.addRange(f),l&&this.selection.substractPoint(l)
},this.transposeSelections=function(e){
var t=this.session,n=t.multiSelect,r=n.ranges;
for(var i=r.length;i--;){
var s=r[i];
if(s.isEmpty()){
var o=t.getWordRange(s.start.row,s.start.column);
s.start.row=o.start.row,s.start.column=o.start.column,s.end.row=o.end.row,s.end.column=o.end.column
}
}
n.mergeOverlappingRanges();
var u=[];
for(var i=r.length;i--;){
var s=r[i];
u.unshift(t.getTextRange(s))
}
e<0?u.unshift(u.pop()):u.push(u.shift());
for(var i=r.length;i--;){
var s=r[i],o=s.clone();
t.replace(s,u[i]),s.start.row=o.start.row,s.start.column=o.start.column
}
},this.selectMore=function(e,t){
var n=this.session,r=n.multiSelect,i=r.toOrientedRange();
if(i.isEmpty()){
i=n.getWordRange(i.start.row,i.start.column),i.cursor=e==-1?i.start:i.end,this.multiSelect.addRange(i);
return
}
var s=n.getTextRange(i),o=h(n,s,e);
o&&(o.cursor=e==-1?o.start:o.end,this.$blockScrolling+=1,this.session.unfold(o),this.multiSelect.addRange(o),this.$blockScrolling-=1,this.renderer.scrollCursorIntoView(null,0.5)),t&&this.multiSelect.substractPoint(i.cursor)
},this.alignCursors=function(){
var e=this.session,t=e.multiSelect,n=t.ranges;
if(!n.length){
var r=this.selection.getRange(),s=r.start.row,o=r.end.row,u=s==o;
if(u){
var f=this.session.getLength(),l;
do
l=this.session.getLine(o);
while(/[=:]/.test(l)&&++o<f);
do
l=this.session.getLine(s);
while(/[=:]/.test(l)&&--s>0);
s<0&&(s=0),o>=f&&(o=f-1)
}
var c=this.session.doc.removeLines(s,o);
c=this.$reAlignText(c,u),this.session.doc.insert({
row:s,
column:0
},c.join('\n')+'\n'),u||(r.start.column=0,r.end.column=c[c.length-1].length),this.selection.setRange(r)
}else{
var h=-1,p=n.filter(function(e){
if(e.cursor.row==h)
return!0;
h=e.cursor.row
});
t.$onRemoveRange(p);
var d=0,v=Infinity,m=n.map(function(t){
var n=t.cursor,r=e.getLine(n.row),i=r.substr(n.column).search(/\S/g);
return i==-1&&(i=0),n.column>d&&(d=n.column),i<v&&(v=i),i
});
n.forEach(function(t,n){
var r=t.cursor,s=d-r.column,o=m[n]-v;
s>o?e.insert(r,a.stringRepeat(' ',s-o)):e.remove(new i(r.row,r.column,r.row,r.column-s+o)),t.start.column=t.end.column=d,t.start.row=t.end.row=r.row,t.cursor=t.end
}),t.fromOrientedRange(n[0]),this.renderer.updateCursor(),this.renderer.updateBackMarkers()
}
},this.$reAlignText=function(e,t){
function u(e){
return a.stringRepeat(' ',e)
}
function f(e){
return e[2]?u(i)+e[2]+u(s-e[2].length+o)+e[4].replace(/^([=:])\s+/,'$1 '):e[0]
}
function l(e){
return e[2]?u(i+s-e[2].length)+e[2]+u(o,' ')+e[4].replace(/^([=:])\s+/,'$1 '):e[0]
}
function c(e){
return e[2]?u(i)+e[2]+u(o)+e[4].replace(/^([=:])\s+/,'$1 '):e[0]
}
var n=!0,r=!0,i,s,o;
return e.map(function(e){
var t=e.match(/(\s*)(.*?)(\s*)([=:].*)/);
return t?i==null?(i=t[1].length,s=t[2].length,o=t[3].length,t):(i+s+o!=t[1].length+t[2].length+t[3].length&&(r=!1),i!=t[1].length&&(n=!1),i>t[1].length&&(i=t[1].length),s<t[2].length&&(s=t[2].length),o>t[3].length&&(o=t[3].length),t):[e]
}).map(t?f:n?r?l:f:c)
}
}.call(d.prototype),t.onSessionChange=function(e){
var t=e.session;
t.multiSelect||(t.$selectionMarkers=[],t.selection.$initRangeList(),t.multiSelect=t.selection),this.multiSelect=t.multiSelect;
var n=e.oldSession;
n&&(n.multiSelect.removeEventListener('addRange',this.$onAddRange),n.multiSelect.removeEventListener('removeRange',this.$onRemoveRange),n.multiSelect.removeEventListener('multiSelect',this.$onMultiSelect),n.multiSelect.removeEventListener('singleSelect',this.$onSingleSelect)),t.multiSelect.on('addRange',this.$onAddRange),t.multiSelect.on('removeRange',this.$onRemoveRange),t.multiSelect.on('multiSelect',this.$onMultiSelect),t.multiSelect.on('singleSelect',this.$onSingleSelect),this.inMultiSelectMode!=t.selection.inMultiSelectMode&&(t.selection.inMultiSelectMode?this.$onMultiSelect():this.$onSingleSelect())
},t.MultiSelect=m,e('./config').defineOptions(d.prototype,'editor',{
enableMultiselect:{
set:function(e){
m(this),e?(this.on('changeSession',this.$multiselectOnSessionChange),this.on('mousedown',o)):(this.off('changeSession',this.$multiselectOnSessionChange),this.off('mousedown',o))
},
value:!0
}
}))
}),ace.define('ace/mouse/multi_select_handler',[
'require',
'exports',
'module',
'ace/lib/event'
],function(e,t,n){
function i(e,t){
return e.row==t.row&&e.column==t.column
}
function s(e){
var t=e.domEvent,n=t.altKey,s=t.shiftKey,o=e.getAccelKey(),u=e.getButton();
if(e.editor.inMultiSelectMode&&u==2){
e.editor.textInput.onContextMenu(e.domEvent);
return
}
if(!o&&!n){
u==0&&e.editor.inMultiSelectMode&&e.editor.exitMultiSelectMode();
return
}
var a=e.editor,f=a.selection,l=a.inMultiSelectMode,c=e.getDocumentPosition(),h=f.getCursor(),p=e.inSelection()||f.isEmpty()&&i(c,h),d=e.x,v=e.y,m=function(e){
d=e.clientX,v=e.clientY
},g=function(){
var e=a.renderer.pixelToScreenCoordinates(d,v),t=y.screenToDocumentPosition(e.row,e.column);
if(i(w,e)&&i(t,f.selectionLead))
return;
w=e,a.selection.moveCursorToPosition(t),a.selection.clearSelection(),a.renderer.scrollCursorIntoView(),a.removeSelectionMarkers(x),x=f.rectangularRangeBlock(w,b),x.forEach(a.addSelectionMarker,a),a.updateSelectionMarkers()
},y=a.session,b=a.renderer.pixelToScreenCoordinates(d,v),w=b;
if(o&&!s&&!n&&u==0){
if(!l&&p)
return;
if(!l){
var E=f.toOrientedRange();
a.addSelectionMarker(E)
}
var S=f.rangeList.rangeAtPoint(c);
a.once('mouseup',function(){
var e=f.toOrientedRange();
S&&e.isEmpty()&&i(S.cursor,e.cursor)?f.substractPoint(e.cursor):(E&&(a.removeSelectionMarker(E),f.addRange(E)),f.addRange(e))
})
}else if(n&&u==0){
e.stop(),l&&!o?f.toSingleRange():!l&&o&&f.addRange();
var x=[];
s?(b=y.documentToScreenPosition(f.lead),g()):(f.moveCursorToPosition(c),f.clearSelection());
var T=function(e){
clearInterval(C),a.removeSelectionMarkers(x);
for(var t=0;t<x.length;t++)
f.addRange(x[t])
},N=g;
r.capture(a.container,m,T);
var C=setInterval(function(){
N()
},20);
return e.preventDefault()
}
}
var r=e('../lib/event');
t.onMouseDown=s
}),ace.define('ace/commands/multi_select_commands',[
'require',
'exports',
'module',
'ace/keyboard/hash_handler'
],function(e,t,n){
t.defaultCommands=[
{
name:'addCursorAbove',
exec:function(e){
e.selectMoreLines(-1)
},
bindKey:{
win:'Ctrl-Alt-Up',
mac:'Ctrl-Alt-Up'
},
readonly:!0
},
{
name:'addCursorBelow',
exec:function(e){
e.selectMoreLines(1)
},
bindKey:{
win:'Ctrl-Alt-Down',
mac:'Ctrl-Alt-Down'
},
readonly:!0
},
{
name:'addCursorAboveSkipCurrent',
exec:function(e){
e.selectMoreLines(-1,!0)
},
bindKey:{
win:'Ctrl-Alt-Shift-Up',
mac:'Ctrl-Alt-Shift-Up'
},
readonly:!0
},
{
name:'addCursorBelowSkipCurrent',
exec:function(e){
e.selectMoreLines(1,!0)
},
bindKey:{
win:'Ctrl-Alt-Shift-Down',
mac:'Ctrl-Alt-Shift-Down'
},
readonly:!0
},
{
name:'selectMoreBefore',
exec:function(e){
e.selectMore(-1)
},
bindKey:{
win:'Ctrl-Alt-Left',
mac:'Ctrl-Alt-Left'
},
readonly:!0
},
{
name:'selectMoreAfter',
exec:function(e){
e.selectMore(1)
},
bindKey:{
win:'Ctrl-Alt-Right',
mac:'Ctrl-Alt-Right'
},
readonly:!0
},
{
name:'selectNextBefore',
exec:function(e){
e.selectMore(-1,!0)
},
bindKey:{
win:'Ctrl-Alt-Shift-Left',
mac:'Ctrl-Alt-Shift-Left'
},
readonly:!0
},
{
name:'selectNextAfter',
exec:function(e){
e.selectMore(1,!0)
},
bindKey:{
win:'Ctrl-Alt-Shift-Right',
mac:'Ctrl-Alt-Shift-Right'
},
readonly:!0
},
{
name:'splitIntoLines',
exec:function(e){
e.multiSelect.splitIntoLines()
},
bindKey:{
win:'Ctrl-Alt-L',
mac:'Ctrl-Alt-L'
},
readonly:!0
},
{
name:'alignCursors',
exec:function(e){
e.alignCursors()
},
bindKey:{
win:'Ctrl-Alt-A',
mac:'Ctrl-Alt-A'
}
}
],t.multiSelectCommands=[{
name:'singleSelection',
bindKey:'esc',
exec:function(e){
e.exitMultiSelectMode()
},
readonly:!0,
isAvailable:function(e){
return e&&e.inMultiSelectMode
}
}];
var r=e('../keyboard/hash_handler').HashHandler;
t.keyboardHandler=new r(t.multiSelectCommands)
}),ace.define('ace/worker/worker_client',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/lib/event_emitter',
'ace/config'
],function(e,t,n){
var r=e('../lib/oop'),i=e('../lib/event_emitter').EventEmitter,s=e('../config'),o=function(t,n,r){
this.$sendDeltaQueue=this.$sendDeltaQueue.bind(this),this.changeListener=this.changeListener.bind(this),this.onMessage=this.onMessage.bind(this),e.nameToUrl&&!e.toUrl&&(e.toUrl=e.nameToUrl);
var i;
if(s.get('packaged')||!e.toUrl)
i=s.moduleUrl(n,'worker');
else{
var o=this.$normalizePath;
i=o(e.toUrl('ace/worker/worker.js',null,'_'));
var u={};
t.forEach(function(t){
u[t]=o(e.toUrl(t,null,'_').replace(/(\.js)?(\?.*)?$/,''))
})
}
this.$worker=new Worker(i),this.$worker.postMessage({
init:!0,
tlns:u,
module:n,
classname:r
}),this.callbackId=1,this.callbacks={},this.$worker.onmessage=this.onMessage
};
(function(){
r.implement(this,i),this.onMessage=function(e){
var t=e.data;
switch(t.type){
case'log':
window.console&&console.log&&console.log.apply(console,t.data);
break;
case'event':
this._emit(t.name,{data:t.data});
break;
case'call':
var n=this.callbacks[t.id];
n&&(n(t.data),delete this.callbacks[t.id])
}
},this.$normalizePath=function(e){
return location.host?(e=e.replace(/^[a-z]+:\/\/[^\/]+/,''),e=location.protocol+'//'+location.host+(e.charAt(0)=='/'?'':location.pathname.replace(/\/[^\/]*$/,''))+'/'+e.replace(/^[\/]+/,''),e):e
},this.terminate=function(){
this._emit('terminate',{}),this.deltaQueue=null,this.$worker.terminate(),this.$worker=null,this.$doc.removeEventListener('change',this.changeListener),this.$doc=null
},this.send=function(e,t){
this.$worker.postMessage({
command:e,
args:t
})
},this.call=function(e,t,n){
if(n){
var r=this.callbackId++;
this.callbacks[r]=n,t.push(r)
}
this.send(e,t)
},this.emit=function(e,t){
try{
this.$worker.postMessage({
event:e,
data:{data:t.data}
})
}catch(n){
}
},this.attachToDocument=function(e){
this.$doc&&this.terminate(),this.$doc=e,this.call('setValue',[e.getValue()]),e.on('change',this.changeListener)
},this.changeListener=function(e){
this.deltaQueue?this.deltaQueue.push(e.data):(this.deltaQueue=[e.data],setTimeout(this.$sendDeltaQueue,0))
},this.$sendDeltaQueue=function(){
var e=this.deltaQueue;
if(!e)
return;
this.deltaQueue=null,e.length>20&&e.length>this.$doc.getLength()>>1?this.call('setValue',[this.$doc.getValue()]):this.emit('change',{data:e})
}
}.call(o.prototype));
var u=function(e,t,n){
this.$sendDeltaQueue=this.$sendDeltaQueue.bind(this),this.changeListener=this.changeListener.bind(this),this.callbackId=1,this.callbacks={},this.messageBuffer=[];
var r=null,o=Object.create(i),u=this;
this.$worker={},this.$worker.terminate=function(){
},this.$worker.postMessage=function(e){
u.messageBuffer.push(e),r&&setTimeout(a)
};
var a=function(){
var e=u.messageBuffer.shift();
e.command?r[e.command].apply(r,e.args):e.event&&o._emit(e.event,e.data)
};
o.postMessage=function(e){
u.onMessage({data:e})
},o.callback=function(e,t){
this.postMessage({
type:'call',
id:t,
data:e
})
},o.emit=function(e,t){
this.postMessage({
type:'event',
name:e,
data:t
})
},s.loadModule([
'worker',
t
],function(e){
r=new e[n](o);
while(u.messageBuffer.length)
a()
})
};
u.prototype=o.prototype,t.UIWorkerClient=u,t.WorkerClient=o
}),ace.define('ace/placeholder',[
'require',
'exports',
'module',
'ace/range',
'ace/lib/event_emitter',
'ace/lib/oop'
],function(e,t,n){
var r=e('./range').Range,i=e('./lib/event_emitter').EventEmitter,s=e('./lib/oop'),o=function(e,t,n,r,i,s){
var o=this;
this.length=t,this.session=e,this.doc=e.getDocument(),this.mainClass=i,this.othersClass=s,this.$onUpdate=this.onUpdate.bind(this),this.doc.on('change',this.$onUpdate),this.$others=r,this.$onCursorChange=function(){
setTimeout(function(){
o.onCursorChange()
})
},this.$pos=n;
var u=e.getUndoManager().$undoStack||e.getUndoManager().$undostack||{length:-1};
this.$undoStackDepth=u.length,this.setup(),e.selection.on('changeCursor',this.$onCursorChange)
};
(function(){
s.implement(this,i),this.setup=function(){
var e=this,t=this.doc,n=this.session,i=this.$pos;
this.pos=t.createAnchor(i.row,i.column),this.markerId=n.addMarker(new r(i.row,i.column,i.row,i.column+this.length),this.mainClass,null,!1),this.pos.on('change',function(t){
n.removeMarker(e.markerId),e.markerId=n.addMarker(new r(t.value.row,t.value.column,t.value.row,t.value.column+e.length),e.mainClass,null,!1)
}),this.others=[],this.$others.forEach(function(n){
var r=t.createAnchor(n.row,n.column);
e.others.push(r)
}),n.setUndoSelect(!1)
},this.showOtherMarkers=function(){
if(this.othersActive)
return;
var e=this.session,t=this;
this.othersActive=!0,this.others.forEach(function(n){
n.markerId=e.addMarker(new r(n.row,n.column,n.row,n.column+t.length),t.othersClass,null,!1),n.on('change',function(i){
e.removeMarker(n.markerId),n.markerId=e.addMarker(new r(i.value.row,i.value.column,i.value.row,i.value.column+t.length),t.othersClass,null,!1)
})
})
},this.hideOtherMarkers=function(){
if(!this.othersActive)
return;
this.othersActive=!1;
for(var e=0;e<this.others.length;e++)
this.session.removeMarker(this.others[e].markerId)
},this.onUpdate=function(e){
var t=e.data,n=t.range;
if(n.start.row!==n.end.row)
return;
if(n.start.row!==this.pos.row)
return;
if(this.$updating)
return;
this.$updating=!0;
var i=t.action==='insertText'?n.end.column-n.start.column:n.start.column-n.end.column;
if(n.start.column>=this.pos.column&&n.start.column<=this.pos.column+this.length+1){
var s=n.start.column-this.pos.column;
this.length+=i;
if(!this.session.$fromUndo){
if(t.action==='insertText')
for(var o=this.others.length-1;o>=0;o--){
var u=this.others[o],a={
row:u.row,
column:u.column+s
};
u.row===n.start.row&&n.start.column<u.column&&(a.column+=i),this.doc.insert(a,t.text)
}
else if(t.action==='removeText')
for(var o=this.others.length-1;o>=0;o--){
var u=this.others[o],a={
row:u.row,
column:u.column+s
};
u.row===n.start.row&&n.start.column<u.column&&(a.column+=i),this.doc.remove(new r(a.row,a.column,a.row,a.column-i))
}
n.start.column===this.pos.column&&t.action==='insertText'?setTimeout(function(){
this.pos.setPosition(this.pos.row,this.pos.column-i);
for(var e=0;e<this.others.length;e++){
var t=this.others[e],r={
row:t.row,
column:t.column-i
};
t.row===n.start.row&&n.start.column<t.column&&(r.column+=i),t.setPosition(r.row,r.column)
}
}.bind(this),0):n.start.column===this.pos.column&&t.action==='removeText'&&setTimeout(function(){
for(var e=0;e<this.others.length;e++){
var t=this.others[e];
t.row===n.start.row&&n.start.column<t.column&&t.setPosition(t.row,t.column-i)
}
}.bind(this),0)
}
this.pos._emit('change',{value:this.pos});
for(var o=0;o<this.others.length;o++)
this.others[o]._emit('change',{value:this.others[o]})
}
this.$updating=!1
},this.onCursorChange=function(e){
if(this.$updating)
return;
var t=this.session.selection.getCursor();
t.row===this.pos.row&&t.column>=this.pos.column&&t.column<=this.pos.column+this.length?(this.showOtherMarkers(),this._emit('cursorEnter',e)):(this.hideOtherMarkers(),this._emit('cursorLeave',e))
},this.detach=function(){
this.session.removeMarker(this.markerId),this.hideOtherMarkers(),this.doc.removeEventListener('change',this.$onUpdate),this.session.selection.removeEventListener('changeCursor',this.$onCursorChange),this.pos.detach();
for(var e=0;e<this.others.length;e++)
this.others[e].detach();
this.session.setUndoSelect(!0)
},this.cancel=function(){
if(this.$undoStackDepth===-1)
throw Error('Canceling placeholders only supported with undo manager attached to session.');
var e=this.session.getUndoManager(),t=(e.$undoStack||e.$undostack).length-this.$undoStackDepth;
for(var n=0;n<t;n++)
e.undo(!0)
}
}.call(o.prototype),t.PlaceHolder=o)
}),ace.define('ace/mode/folding/fold_mode',[
'require',
'exports',
'module',
'ace/range'
],function(e,t,n){
var r=e('../../range').Range,i=t.FoldMode=function(){
};
(function(){
this.foldingStartMarker=null,this.foldingStopMarker=null,this.getFoldWidget=function(e,t,n){
var r=e.getLine(n);
return this.foldingStartMarker.test(r)?'start':t=='markbeginend'&&this.foldingStopMarker&&this.foldingStopMarker.test(r)?'end':''
},this.getFoldWidgetRange=function(e,t,n){
return null
},this.indentationBlock=function(e,t,n){
var i=/\S/,s=e.getLine(t),o=s.search(i);
if(o==-1)
return;
var u=n||s.length,a=e.getLength(),f=t,l=t;
while(++t<a){
var c=e.getLine(t).search(i);
if(c==-1)
continue;
if(c<=o)
break;
l=t
}
if(l>f){
var h=e.getLine(l).length;
return new r(f,u,l,h)
}
},this.openingBracketBlock=function(e,t,n,i,s){
var o={
row:n,
column:i+1
},u=e.$findClosingBracket(t,o,s);
if(!u)
return;
var a=e.foldWidgets[u.row];
return a==null&&(a=e.getFoldWidget(u.row)),a=='start'&&u.row>o.row&&(u.row--,u.column=e.getLine(u.row).length),r.fromPoints(o,u)
},this.closingBracketBlock=function(e,t,n,i,s){
var o={
row:n,
column:i
},u=e.$findOpeningBracket(t,o);
if(!u)
return;
return u.column++,o.column--,r.fromPoints(u,o)
}
}.call(i.prototype))
}),ace.define('ace/theme/textmate',[
'require',
'exports',
'module',
'ace/lib/dom'
],function(e,t,n){
t.isDark=!1,t.cssClass='ace-tm',t.cssText='.ace-tm .ace_gutter {background: #f0f0f0;color: #333;}.ace-tm .ace_print-margin {width: 1px;background: #e8e8e8;}.ace-tm .ace_fold {background-color: #6B72E6;}.ace-tm {background-color: #FFFFFF;}.ace-tm .ace_cursor {color: black;}.ace-tm .ace_invisible {color: rgb(191, 191, 191);}.ace-tm .ace_storage,.ace-tm .ace_keyword {color: blue;}.ace-tm .ace_constant {color: rgb(197, 6, 11);}.ace-tm .ace_constant.ace_buildin {color: rgb(88, 72, 246);}.ace-tm .ace_constant.ace_language {color: rgb(88, 92, 246);}.ace-tm .ace_constant.ace_library {color: rgb(6, 150, 14);}.ace-tm .ace_invalid {background-color: rgba(255, 0, 0, 0.1);color: red;}.ace-tm .ace_support.ace_function {color: rgb(60, 76, 114);}.ace-tm .ace_support.ace_constant {color: rgb(6, 150, 14);}.ace-tm .ace_support.ace_type,.ace-tm .ace_support.ace_class {color: rgb(109, 121, 222);}.ace-tm .ace_keyword.ace_operator {color: rgb(104, 118, 135);}.ace-tm .ace_string {color: rgb(3, 106, 7);}.ace-tm .ace_comment {color: rgb(76, 136, 107);}.ace-tm .ace_comment.ace_doc {color: rgb(0, 102, 255);}.ace-tm .ace_comment.ace_doc.ace_tag {color: rgb(128, 159, 191);}.ace-tm .ace_constant.ace_numeric {color: rgb(0, 0, 205);}.ace-tm .ace_variable {color: rgb(49, 132, 149);}.ace-tm .ace_xml-pe {color: rgb(104, 104, 91);}.ace-tm .ace_entity.ace_name.ace_function {color: #0000A2;}.ace-tm .ace_heading {color: rgb(12, 7, 255);}.ace-tm .ace_list {color:rgb(185, 6, 144);}.ace-tm .ace_meta.ace_tag {color:rgb(0, 22, 142);}.ace-tm .ace_string.ace_regex {color: rgb(255, 0, 0)}.ace-tm .ace_marker-layer .ace_selection {background: rgb(181, 213, 255);}.ace-tm.ace_multiselect .ace_selection.ace_start {box-shadow: 0 0 3px 0px white;border-radius: 2px;}.ace-tm .ace_marker-layer .ace_step {background: rgb(252, 255, 0);}.ace-tm .ace_marker-layer .ace_stack {background: rgb(164, 229, 101);}.ace-tm .ace_marker-layer .ace_bracket {margin: -1px 0 0 -1px;border: 1px solid rgb(192, 192, 192);}.ace-tm .ace_marker-layer .ace_active-line {background: rgba(0, 0, 0, 0.07);}.ace-tm .ace_gutter-active-line {background-color : #dcdcdc;}.ace-tm .ace_marker-layer .ace_selected-word {background: rgb(250, 250, 255);border: 1px solid rgb(200, 200, 250);}.ace-tm .ace_indent-guide {background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAACCAYAAACZgbYnAAAAE0lEQVQImWP4////f4bLly//BwAmVgd1/w11/gAAAABJRU5ErkJggg==") right repeat-y;}';
var r=e('../lib/dom');
r.importCssString(t.cssText,t.cssClass)
}));
(function(){
ace.require(['ace/ace'],function(a){
a&&a.config.init();
if(!window.ace)
window.ace={};
for(var key in a)
if(a.hasOwnProperty(key))
ace[key]=a[key]
})
}());
ace.define('ace/mode/html',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/mode/text',
'ace/mode/javascript',
'ace/mode/css',
'ace/tokenizer',
'ace/mode/html_highlight_rules',
'ace/mode/behaviour/html',
'ace/mode/folding/html',
'ace/mode/html_completions'
],function(e,t,n){
var r=e('../lib/oop'),i=e('./text').Mode,s=e('./javascript').Mode,o=e('./css').Mode,u=e('../tokenizer').Tokenizer,a=e('./html_highlight_rules').HtmlHighlightRules,f=e('./behaviour/html').HtmlBehaviour,l=e('./folding/html').FoldMode,c=e('./html_completions').HtmlCompletions,h=function(){
this.HighlightRules=a,this.$behaviour=new f,this.$completer=new c,this.createModeDelegates({
'js-':s,
'css-':o
}),this.foldingRules=new l
};
r.inherits(h,i),function(){
this.blockComment={
start:'<!--',
end:'-->'
},this.getNextLineIndent=function(e,t,n){
return this.$getIndent(t)
},this.checkOutdent=function(e,t,n){
return!1
},this.getCompletions=function(e,t,n,r){
return this.$completer.getCompletions(e,t,n,r)
}
}.call(h.prototype),t.Mode=h
}),ace.define('ace/mode/javascript',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/mode/text',
'ace/tokenizer',
'ace/mode/javascript_highlight_rules',
'ace/mode/matching_brace_outdent',
'ace/range',
'ace/worker/worker_client',
'ace/mode/behaviour/cstyle',
'ace/mode/folding/cstyle'
],function(e,t,n){
var r=e('../lib/oop'),i=e('./text').Mode,s=e('../tokenizer').Tokenizer,o=e('./javascript_highlight_rules').JavaScriptHighlightRules,u=e('./matching_brace_outdent').MatchingBraceOutdent,a=e('../range').Range,f=e('../worker/worker_client').WorkerClient,l=e('./behaviour/cstyle').CstyleBehaviour,c=e('./folding/cstyle').FoldMode,h=function(){
this.HighlightRules=o,this.$outdent=new u,this.$behaviour=new l,this.foldingRules=new c
};
r.inherits(h,i),function(){
this.lineCommentStart='//',this.blockComment={
start:'/*',
end:'*/'
},this.getNextLineIndent=function(e,t,n){
var r=this.$getIndent(t),i=this.getTokenizer().getLineTokens(t,e),s=i.tokens,o=i.state;
if(s.length&&s[s.length-1].type=='comment')
return r;
if(e=='start'||e=='no_regex'){
var u=t.match(/^.*(?:\bcase\b.*\:|[\{\(\[])\s*$/);
u&&(r+=n)
}else if(e=='doc-start'){
if(o=='start'||o=='no_regex')
return'';
var u=t.match(/^\s*(\/?)\*/);
u&&(u[1]&&(r+=' '),r+='* ')
}
return r
},this.checkOutdent=function(e,t,n){
return this.$outdent.checkOutdent(t,n)
},this.autoOutdent=function(e,t,n){
this.$outdent.autoOutdent(t,n)
},this.createWorker=function(e){
var t=new f(['ace'],'ace/mode/javascript_worker','JavaScriptWorker');
return t.attachToDocument(e.getDocument()),t.on('jslint',function(t){
e.setAnnotations(t.data)
}),t.on('terminate',function(){
e.clearAnnotations()
}),t
}
}.call(h.prototype),t.Mode=h
}),ace.define('ace/mode/javascript_highlight_rules',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/mode/doc_comment_highlight_rules',
'ace/mode/text_highlight_rules'
],function(e,t,n){
var r=e('../lib/oop'),i=e('./doc_comment_highlight_rules').DocCommentHighlightRules,s=e('./text_highlight_rules').TextHighlightRules,o=function(){
var e=this.createKeywordMapper({
'variable.language':'Array|Boolean|Date|Function|Iterator|Number|Object|RegExp|String|Proxy|Namespace|QName|XML|XMLList|ArrayBuffer|Float32Array|Float64Array|Int16Array|Int32Array|Int8Array|Uint16Array|Uint32Array|Uint8Array|Uint8ClampedArray|Error|EvalError|InternalError|RangeError|ReferenceError|StopIteration|SyntaxError|TypeError|URIError|decodeURI|decodeURIComponent|encodeURI|encodeURIComponent|eval|isFinite|isNaN|parseFloat|parseInt|JSON|Math|this|arguments|prototype|window|document',
keyword:'const|yield|import|get|set|break|case|catch|continue|default|delete|do|else|finally|for|function|if|in|instanceof|new|return|switch|throw|try|typeof|let|var|while|with|debugger|__parent__|__count__|escape|unescape|with|__proto__|class|enum|extends|super|export|implements|private|public|interface|package|protected|static',
'storage.type':'const|let|var|function',
'constant.language':'null|Infinity|NaN|undefined',
'support.function':'alert',
'constant.language.boolean':'true|false'
},'identifier'),t='case|do|else|finally|in|instanceof|return|throw|try|typeof|yield|void',n='[a-zA-Z\\$_-][a-zA-Z\\d\\$_-]*\\b',r='\\\\(?:x[0-9a-fA-F]{2}|u[0-9a-fA-F]{4}|[0-2][0-7]{0,2}|3[0-6][0-7]?|37[0-7]?|[4-7][0-7]?|.)';
this.$rules={
no_regex:[
{
token:'comment',
regex:'\\/\\/',
next:'line_comment'
},
i.getStartRule('doc-start'),
{
token:'comment',
regex:/\/\*/,
next:'comment'
},
{
token:'string',
regex:'\'(?=.)',
next:'qstring'
},
{
token:'string',
regex:'"(?=.)',
next:'qqstring'
},
{
token:'constant.numeric',
regex:/0[xX][0-9a-fA-F]+\b/
},
{
token:'constant.numeric',
regex:/[+-]?\d+(?:(?:\.\d*)?(?:[eE][+-]?\d+)?)?\b/
},
{
token:[
'storage.type',
'punctuation.operator',
'support.function',
'punctuation.operator',
'entity.name.function',
'text',
'keyword.operator'
],
regex:'('+n+')(\\.)(prototype)(\\.)('+n+')(\\s*)(=)',
next:'function_arguments'
},
{
token:[
'storage.type',
'punctuation.operator',
'entity.name.function',
'text',
'keyword.operator',
'text',
'storage.type',
'text',
'paren.lparen'
],
regex:'('+n+')(\\.)('+n+')(\\s*)(=)(\\s*)(function)(\\s*)(\\()',
next:'function_arguments'
},
{
token:[
'entity.name.function',
'text',
'keyword.operator',
'text',
'storage.type',
'text',
'paren.lparen'
],
regex:'('+n+')(\\s*)(=)(\\s*)(function)(\\s*)(\\()',
next:'function_arguments'
},
{
token:[
'storage.type',
'punctuation.operator',
'entity.name.function',
'text',
'keyword.operator',
'text',
'storage.type',
'text',
'entity.name.function',
'text',
'paren.lparen'
],
regex:'('+n+')(\\.)('+n+')(\\s*)(=)(\\s*)(function)(\\s+)(\\w+)(\\s*)(\\()',
next:'function_arguments'
},
{
token:[
'storage.type',
'text',
'entity.name.function',
'text',
'paren.lparen'
],
regex:'(function)(\\s+)('+n+')(\\s*)(\\()',
next:'function_arguments'
},
{
token:[
'entity.name.function',
'text',
'punctuation.operator',
'text',
'storage.type',
'text',
'paren.lparen'
],
regex:'('+n+')(\\s*)(:)(\\s*)(function)(\\s*)(\\()',
next:'function_arguments'
},
{
token:[
'text',
'text',
'storage.type',
'text',
'paren.lparen'
],
regex:'(:)(\\s*)(function)(\\s*)(\\()',
next:'function_arguments'
},
{
token:'keyword',
regex:'(?:'+t+')\\b',
next:'start'
},
{
token:[
'punctuation.operator',
'support.function'
],
regex:/(\.)(s(?:h(?:ift|ow(?:Mod(?:elessDialog|alDialog)|Help))|croll(?:X|By(?:Pages|Lines)?|Y|To)?|t(?:op|rike)|i(?:n|zeToContent|debar|gnText)|ort|u(?:p|b(?:str(?:ing)?)?)|pli(?:ce|t)|e(?:nd|t(?:Re(?:sizable|questHeader)|M(?:i(?:nutes|lliseconds)|onth)|Seconds|Ho(?:tKeys|urs)|Year|Cursor|Time(?:out)?|Interval|ZOptions|Date|UTC(?:M(?:i(?:nutes|lliseconds)|onth)|Seconds|Hours|Date|FullYear)|FullYear|Active)|arch)|qrt|lice|avePreferences|mall)|h(?:ome|andleEvent)|navigate|c(?:har(?:CodeAt|At)|o(?:s|n(?:cat|textual|firm)|mpile)|eil|lear(?:Timeout|Interval)?|a(?:ptureEvents|ll)|reate(?:StyleSheet|Popup|EventObject))|t(?:o(?:GMTString|S(?:tring|ource)|U(?:TCString|pperCase)|Lo(?:caleString|werCase))|est|a(?:n|int(?:Enabled)?))|i(?:s(?:NaN|Finite)|ndexOf|talics)|d(?:isableExternalCapture|ump|etachEvent)|u(?:n(?:shift|taint|escape|watch)|pdateCommands)|j(?:oin|avaEnabled)|p(?:o(?:p|w)|ush|lugins.refresh|a(?:ddings|rse(?:Int|Float)?)|r(?:int|ompt|eference))|e(?:scape|nableExternalCapture|val|lementFromPoint|x(?:p|ec(?:Script|Command)?))|valueOf|UTC|queryCommand(?:State|Indeterm|Enabled|Value)|f(?:i(?:nd|le(?:ModifiedDate|Size|CreatedDate|UpdatedDate)|xed)|o(?:nt(?:size|color)|rward)|loor|romCharCode)|watch|l(?:ink|o(?:ad|g)|astIndexOf)|a(?:sin|nchor|cos|t(?:tachEvent|ob|an(?:2)?)|pply|lert|b(?:s|ort))|r(?:ou(?:nd|teEvents)|e(?:size(?:By|To)|calc|turnValue|place|verse|l(?:oad|ease(?:Capture|Events)))|andom)|g(?:o|et(?:ResponseHeader|M(?:i(?:nutes|lliseconds)|onth)|Se(?:conds|lection)|Hours|Year|Time(?:zoneOffset)?|Da(?:y|te)|UTC(?:M(?:i(?:nutes|lliseconds)|onth)|Seconds|Hours|Da(?:y|te)|FullYear)|FullYear|A(?:ttention|llResponseHeaders)))|m(?:in|ove(?:B(?:y|elow)|To(?:Absolute)?|Above)|ergeAttributes|a(?:tch|rgins|x))|b(?:toa|ig|o(?:ld|rderWidths)|link|ack))\b(?=\()/
},
{
token:[
'punctuation.operator',
'support.function.dom'
],
regex:/(\.)(s(?:ub(?:stringData|mit)|plitText|e(?:t(?:NamedItem|Attribute(?:Node)?)|lect))|has(?:ChildNodes|Feature)|namedItem|c(?:l(?:ick|o(?:se|neNode))|reate(?:C(?:omment|DATASection|aption)|T(?:Head|extNode|Foot)|DocumentFragment|ProcessingInstruction|E(?:ntityReference|lement)|Attribute))|tabIndex|i(?:nsert(?:Row|Before|Cell|Data)|tem)|open|delete(?:Row|C(?:ell|aption)|T(?:Head|Foot)|Data)|focus|write(?:ln)?|a(?:dd|ppend(?:Child|Data))|re(?:set|place(?:Child|Data)|move(?:NamedItem|Child|Attribute(?:Node)?)?)|get(?:NamedItem|Element(?:sBy(?:Name|TagName)|ById)|Attribute(?:Node)?)|blur)\b(?=\()/
},
{
token:[
'punctuation.operator',
'support.constant'
],
regex:/(\.)(s(?:ystemLanguage|cr(?:ipts|ollbars|een(?:X|Y|Top|Left))|t(?:yle(?:Sheets)?|atus(?:Text|bar)?)|ibling(?:Below|Above)|ource|uffixes|e(?:curity(?:Policy)?|l(?:ection|f)))|h(?:istory|ost(?:name)?|as(?:h|Focus))|y|X(?:MLDocument|SLDocument)|n(?:ext|ame(?:space(?:s|URI)|Prop))|M(?:IN_VALUE|AX_VALUE)|c(?:haracterSet|o(?:n(?:structor|trollers)|okieEnabled|lorDepth|mp(?:onents|lete))|urrent|puClass|l(?:i(?:p(?:boardData)?|entInformation)|osed|asses)|alle(?:e|r)|rypto)|t(?:o(?:olbar|p)|ext(?:Transform|Indent|Decoration|Align)|ags)|SQRT(?:1_2|2)|i(?:n(?:ner(?:Height|Width)|put)|ds|gnoreCase)|zIndex|o(?:scpu|n(?:readystatechange|Line)|uter(?:Height|Width)|p(?:sProfile|ener)|ffscreenBuffering)|NEGATIVE_INFINITY|d(?:i(?:splay|alog(?:Height|Top|Width|Left|Arguments)|rectories)|e(?:scription|fault(?:Status|Ch(?:ecked|arset)|View)))|u(?:ser(?:Profile|Language|Agent)|n(?:iqueID|defined)|pdateInterval)|_content|p(?:ixelDepth|ort|ersonalbar|kcs11|l(?:ugins|atform)|a(?:thname|dding(?:Right|Bottom|Top|Left)|rent(?:Window|Layer)?|ge(?:X(?:Offset)?|Y(?:Offset)?))|r(?:o(?:to(?:col|type)|duct(?:Sub)?|mpter)|e(?:vious|fix)))|e(?:n(?:coding|abledPlugin)|x(?:ternal|pando)|mbeds)|v(?:isibility|endor(?:Sub)?|Linkcolor)|URLUnencoded|P(?:I|OSITIVE_INFINITY)|f(?:ilename|o(?:nt(?:Size|Family|Weight)|rmName)|rame(?:s|Element)|gColor)|E|whiteSpace|l(?:i(?:stStyleType|n(?:eHeight|kColor))|o(?:ca(?:tion(?:bar)?|lName)|wsrc)|e(?:ngth|ft(?:Context)?)|a(?:st(?:M(?:odified|atch)|Index|Paren)|yer(?:s|X)|nguage))|a(?:pp(?:MinorVersion|Name|Co(?:deName|re)|Version)|vail(?:Height|Top|Width|Left)|ll|r(?:ity|guments)|Linkcolor|bove)|r(?:ight(?:Context)?|e(?:sponse(?:XML|Text)|adyState))|global|x|m(?:imeTypes|ultiline|enubar|argin(?:Right|Bottom|Top|Left))|L(?:N(?:10|2)|OG(?:10E|2E))|b(?:o(?:ttom|rder(?:Width|RightWidth|BottomWidth|Style|Color|TopWidth|LeftWidth))|ufferDepth|elow|ackground(?:Color|Image)))\b/
},
{
token:[
'storage.type',
'punctuation.operator',
'support.function.firebug'
],
regex:/(console)(\.)(warn|info|log|error|time|timeEnd|assert)\b/
},
{
token:e,
regex:n
},
{
token:'keyword.operator',
regex:/--|\+\+|[!$%&*+\-~]|===|==|=|!=|!==|<=|>=|<<=|>>=|>>>=|<>|<|>|!|&&|\|\||\?\:|\*=|%=|\+=|\-=|&=|\^=/,
next:'start'
},
{
token:'punctuation.operator',
regex:/\?|\:|\,|\;|\./,
next:'start'
},
{
token:'paren.lparen',
regex:/[\[({]/,
next:'start'
},
{
token:'paren.rparen',
regex:/[\])}]/
},
{
token:'keyword.operator',
regex:/\/=?/,
next:'start'
},
{
token:'comment',
regex:/^#!.*$/
}
],
start:[
i.getStartRule('doc-start'),
{
token:'comment',
regex:'\\/\\*',
next:'comment_regex_allowed'
},
{
token:'comment',
regex:'\\/\\/',
next:'line_comment_regex_allowed'
},
{
token:'string.regexp',
regex:'\\/',
next:'regex'
},
{
token:'text',
regex:'\\s+|^$',
next:'start'
},
{
token:'empty',
regex:'',
next:'no_regex'
}
],
regex:[
{
token:'regexp.keyword.operator',
regex:'\\\\(?:u[\\da-fA-F]{4}|x[\\da-fA-F]{2}|.)'
},
{
token:'string.regexp',
regex:'/\\w*',
next:'no_regex'
},
{
token:'invalid',
regex:/\{\d+\b,?\d*\}[+*]|[+*$^?][+*]|[$^][?]|\?{3,}/
},
{
token:'constant.language.escape',
regex:/\(\?[:=!]|\)|\{\d+\b,?\d*\}|[+*]\?|[()$^+*?]/
},
{
token:'constant.language.delimiter',
regex:/\|/
},
{
token:'constant.language.escape',
regex:/\[\^?/,
next:'regex_character_class'
},
{
token:'empty',
regex:'$',
next:'no_regex'
},
{defaultToken:'string.regexp'}
],
regex_character_class:[
{
token:'regexp.keyword.operator',
regex:'\\\\(?:u[\\da-fA-F]{4}|x[\\da-fA-F]{2}|.)'
},
{
token:'constant.language.escape',
regex:']',
next:'regex'
},
{
token:'constant.language.escape',
regex:'-'
},
{
token:'empty',
regex:'$',
next:'no_regex'
},
{defaultToken:'string.regexp.charachterclass'}
],
function_arguments:[
{
token:'variable.parameter',
regex:n
},
{
token:'punctuation.operator',
regex:'[, ]+'
},
{
token:'punctuation.operator',
regex:'$'
},
{
token:'empty',
regex:'',
next:'no_regex'
}
],
comment_regex_allowed:[
{
token:'comment',
regex:'\\*\\/',
next:'start'
},
{defaultToken:'comment'}
],
comment:[
{
token:'comment',
regex:'\\*\\/',
next:'no_regex'
},
{defaultToken:'comment'}
],
line_comment_regex_allowed:[
{
token:'comment',
regex:'$|^',
next:'start'
},
{defaultToken:'comment'}
],
line_comment:[
{
token:'comment',
regex:'$|^',
next:'no_regex'
},
{defaultToken:'comment'}
],
qqstring:[
{
token:'constant.language.escape',
regex:r
},
{
token:'string',
regex:'\\\\$',
next:'qqstring'
},
{
token:'string',
regex:'"|$',
next:'no_regex'
},
{defaultToken:'string'}
],
qstring:[
{
token:'constant.language.escape',
regex:r
},
{
token:'string',
regex:'\\\\$',
next:'qstring'
},
{
token:'string',
regex:'\'|$',
next:'no_regex'
},
{defaultToken:'string'}
]
},this.embedRules(i,'doc-',[i.getEndRule('no_regex')])
};
r.inherits(o,s),t.JavaScriptHighlightRules=o
}),ace.define('ace/mode/doc_comment_highlight_rules',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/mode/text_highlight_rules'
],function(e,t,n){
var r=e('../lib/oop'),i=e('./text_highlight_rules').TextHighlightRules,s=function(){
this.$rules={
start:[
{
token:'comment.doc.tag',
regex:'@[\\w\\d_]+'
},
{
token:'comment.doc.tag',
regex:'\\bTODO\\b'
},
{defaultToken:'comment.doc'}
]
}
};
r.inherits(s,i),s.getStartRule=function(e){
return{
token:'comment.doc',
regex:'\\/\\*(?=\\*)',
next:e
}
},s.getEndRule=function(e){
return{
token:'comment.doc',
regex:'\\*\\/',
next:e
}
},t.DocCommentHighlightRules=s
}),ace.define('ace/mode/matching_brace_outdent',[
'require',
'exports',
'module',
'ace/range'
],function(e,t,n){
var r=e('../range').Range,i=function(){
};
(function(){
this.checkOutdent=function(e,t){
return/^\s+$/.test(e)?/^\s*\}/.test(t):!1
},this.autoOutdent=function(e,t){
var n=e.getLine(t),i=n.match(/^(\s*\})/);
if(!i)
return 0;
var s=i[1].length,o=e.findMatchingBracket({
row:t,
column:s
});
if(!o||o.row==t)
return 0;
var u=this.$getIndent(e.getLine(o.row));
e.replace(new r(t,0,t,s-1),u)
},this.$getIndent=function(e){
return e.match(/^\s*/)[0]
}
}.call(i.prototype),t.MatchingBraceOutdent=i)
}),ace.define('ace/mode/behaviour/cstyle',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/mode/behaviour',
'ace/token_iterator',
'ace/lib/lang'
],function(e,t,n){
var r=e('../../lib/oop'),i=e('../behaviour').Behaviour,s=e('../../token_iterator').TokenIterator,o=e('../../lib/lang'),u=[
'text',
'paren.rparen',
'punctuation.operator'
],a=[
'text',
'paren.rparen',
'punctuation.operator',
'comment'
],f=0,l=-1,c='',h=0,p=-1,d='',v='',m=function(){
m.isSaneInsertion=function(e,t){
var n=e.getCursorPosition(),r=new s(t,n.row,n.column);
if(!this.$matchTokenType(r.getCurrentToken()||'text',u)){
var i=new s(t,n.row,n.column+1);
if(!this.$matchTokenType(i.getCurrentToken()||'text',u))
return!1
}
return r.stepForward(),r.getCurrentTokenRow()!==n.row||this.$matchTokenType(r.getCurrentToken()||'text',a)
},m.$matchTokenType=function(e,t){
return t.indexOf(e.type||e)>-1
},m.recordAutoInsert=function(e,t,n){
var r=e.getCursorPosition(),i=t.doc.getLine(r.row);
this.isAutoInsertedClosing(r,i,c[0])||(f=0),l=r.row,c=n+i.substr(r.column),f++
},m.recordMaybeInsert=function(e,t,n){
var r=e.getCursorPosition(),i=t.doc.getLine(r.row);
this.isMaybeInsertedClosing(r,i)||(h=0),p=r.row,d=i.substr(0,r.column)+n,v=i.substr(r.column),h++
},m.isAutoInsertedClosing=function(e,t,n){
return f>0&&e.row===l&&n===c[0]&&t.substr(e.column)===c
},m.isMaybeInsertedClosing=function(e,t){
return h>0&&e.row===p&&t.substr(e.column)===v&&t.substr(0,e.column)==d
},m.popAutoInsertedClosing=function(){
c=c.substr(1),f--
},m.clearMaybeInsertedClosing=function(){
h=0,p=-1
},this.add('braces','insertion',function(e,t,n,r,i){
var s=n.getCursorPosition(),u=r.doc.getLine(s.row);
if(i=='{'){
var a=n.getSelectionRange(),f=r.doc.getTextRange(a);
if(f!==''&&f!=='{'&&n.getWrapBehavioursEnabled())
return{
text:'{'+f+'}',
selection:!1
};
if(m.isSaneInsertion(n,r))
return/[\]\}\)]/.test(u[s.column])?(m.recordAutoInsert(n,r,'}'),{
text:'{}',
selection:[
1,
1
]
}):(m.recordMaybeInsert(n,r,'{'),{
text:'{',
selection:[
1,
1
]
})
}else if(i=='}'){
var l=u.substring(s.column,s.column+1);
if(l=='}'){
var c=r.$findOpeningBracket('}',{
column:s.column+1,
row:s.row
});
if(c!==null&&m.isAutoInsertedClosing(s,u,i))
return m.popAutoInsertedClosing(),{
text:'',
selection:[
1,
1
]
}
}
}else if(i=='\n'||i=='\r\n'){
var p='';
m.isMaybeInsertedClosing(s,u)&&(p=o.stringRepeat('}',h),m.clearMaybeInsertedClosing());
var l=u.substring(s.column,s.column+1);
if(l=='}'||p!==''){
var d=r.findMatchingBracket({
row:s.row,
column:s.column+1
},'}');
if(!d)
return null;
var v=this.getNextLineIndent(e,u.substring(0,s.column),r.getTabString()),g=this.$getIndent(u);
return{
text:'\n'+v+'\n'+g+p,
selection:[
1,
v.length,
1,
v.length
]
}
}
}
}),this.add('braces','deletion',function(e,t,n,r,i){
var s=r.doc.getTextRange(i);
if(!i.isMultiLine()&&s=='{'){
var o=r.doc.getLine(i.start.row),u=o.substring(i.end.column,i.end.column+1);
if(u=='}')
return i.end.column++,i;
h--
}
}),this.add('parens','insertion',function(e,t,n,r,i){
if(i=='('){
var s=n.getSelectionRange(),o=r.doc.getTextRange(s);
if(o!==''&&n.getWrapBehavioursEnabled())
return{
text:'('+o+')',
selection:!1
};
if(m.isSaneInsertion(n,r))
return m.recordAutoInsert(n,r,')'),{
text:'()',
selection:[
1,
1
]
}
}else if(i==')'){
var u=n.getCursorPosition(),a=r.doc.getLine(u.row),f=a.substring(u.column,u.column+1);
if(f==')'){
var l=r.$findOpeningBracket(')',{
column:u.column+1,
row:u.row
});
if(l!==null&&m.isAutoInsertedClosing(u,a,i))
return m.popAutoInsertedClosing(),{
text:'',
selection:[
1,
1
]
}
}
}
}),this.add('parens','deletion',function(e,t,n,r,i){
var s=r.doc.getTextRange(i);
if(!i.isMultiLine()&&s=='('){
var o=r.doc.getLine(i.start.row),u=o.substring(i.start.column+1,i.start.column+2);
if(u==')')
return i.end.column++,i
}
}),this.add('brackets','insertion',function(e,t,n,r,i){
if(i=='['){
var s=n.getSelectionRange(),o=r.doc.getTextRange(s);
if(o!==''&&n.getWrapBehavioursEnabled())
return{
text:'['+o+']',
selection:!1
};
if(m.isSaneInsertion(n,r))
return m.recordAutoInsert(n,r,']'),{
text:'[]',
selection:[
1,
1
]
}
}else if(i==']'){
var u=n.getCursorPosition(),a=r.doc.getLine(u.row),f=a.substring(u.column,u.column+1);
if(f==']'){
var l=r.$findOpeningBracket(']',{
column:u.column+1,
row:u.row
});
if(l!==null&&m.isAutoInsertedClosing(u,a,i))
return m.popAutoInsertedClosing(),{
text:'',
selection:[
1,
1
]
}
}
}
}),this.add('brackets','deletion',function(e,t,n,r,i){
var s=r.doc.getTextRange(i);
if(!i.isMultiLine()&&s=='['){
var o=r.doc.getLine(i.start.row),u=o.substring(i.start.column+1,i.start.column+2);
if(u==']')
return i.end.column++,i
}
}),this.add('string_dquotes','insertion',function(e,t,n,r,i){
if(i=='"'||i=='\''){
var s=i,o=n.getSelectionRange(),u=r.doc.getTextRange(o);
if(u!==''&&u!=='\''&&u!='"'&&n.getWrapBehavioursEnabled())
return{
text:s+u+s,
selection:!1
};
var a=n.getCursorPosition(),f=r.doc.getLine(a.row),l=f.substring(a.column-1,a.column);
if(l=='\\')
return null;
var c=r.getTokens(o.start.row),h=0,p,d=-1;
for(var v=0;v<c.length;v++){
p=c[v],p.type=='string'?d=-1:d<0&&(d=p.value.indexOf(s));
if(p.value.length+h>o.start.column)
break;
h+=c[v].value.length
}
if(!p||d<0&&p.type!=='comment'&&(p.type!=='string'||o.start.column!==p.value.length+h-1&&p.value.lastIndexOf(s)===p.value.length-1)){
if(!m.isSaneInsertion(n,r))
return;
return{
text:s+s,
selection:[
1,
1
]
}
}
if(p&&p.type==='string'){
var g=f.substring(a.column,a.column+1);
if(g==s)
return{
text:'',
selection:[
1,
1
]
}
}
}
}),this.add('string_dquotes','deletion',function(e,t,n,r,i){
var s=r.doc.getTextRange(i);
if(!i.isMultiLine()&&(s=='"'||s=='\'')){
var o=r.doc.getLine(i.start.row),u=o.substring(i.start.column+1,i.start.column+2);
if(u==s)
return i.end.column++,i
}
})
};
r.inherits(m,i),t.CstyleBehaviour=m
}),ace.define('ace/mode/folding/cstyle',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/range',
'ace/mode/folding/fold_mode'
],function(e,t,n){
var r=e('../../lib/oop'),i=e('../../range').Range,s=e('./fold_mode').FoldMode,o=t.FoldMode=function(e){
e&&(this.foldingStartMarker=new RegExp(this.foldingStartMarker.source.replace(/\|[^|]*?$/,'|'+e.start)),this.foldingStopMarker=new RegExp(this.foldingStopMarker.source.replace(/\|[^|]*?$/,'|'+e.end)))
};
r.inherits(o,s),function(){
this.foldingStartMarker=/(\{|\[)[^\}\]]*$|^\s*(\/\*)/,this.foldingStopMarker=/^[^\[\{]*(\}|\])|^[\s\*]*(\*\/)/,this.getFoldWidgetRange=function(e,t,n,r){
var i=e.getLine(n),s=i.match(this.foldingStartMarker);
if(s){
var o=s.index;
if(s[1])
return this.openingBracketBlock(e,s[1],n,o);
var u=e.getCommentFoldRange(n,o+s[0].length,1);
return u&&!u.isMultiLine()&&(r?u=this.getSectionRange(e,n):t!='all'&&(u=null)),u
}
if(t==='markbegin')
return;
var s=i.match(this.foldingStopMarker);
if(s){
var o=s.index+s[0].length;
return s[1]?this.closingBracketBlock(e,s[1],n,o):e.getCommentFoldRange(n,o,-1)
}
},this.getSectionRange=function(e,t){
var n=e.getLine(t),r=n.search(/\S/),s=t,o=n.length;
t+=1;
var u=t,a=e.getLength();
while(++t<a){
n=e.getLine(t);
var f=n.search(/\S/);
if(f===-1)
continue;
if(r>f)
break;
var l=this.getFoldWidgetRange(e,'all',t);
if(l){
if(l.start.row<=s)
break;
if(l.isMultiLine())
t=l.end.row;
else if(r==f)
break
}
u=t
}
return new i(s,o,u,e.getLine(u).length)
}
}.call(o.prototype)
}),ace.define('ace/mode/css',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/mode/text',
'ace/tokenizer',
'ace/mode/css_highlight_rules',
'ace/mode/matching_brace_outdent',
'ace/worker/worker_client',
'ace/mode/behaviour/css',
'ace/mode/folding/cstyle'
],function(e,t,n){
var r=e('../lib/oop'),i=e('./text').Mode,s=e('../tokenizer').Tokenizer,o=e('./css_highlight_rules').CssHighlightRules,u=e('./matching_brace_outdent').MatchingBraceOutdent,a=e('../worker/worker_client').WorkerClient,f=e('./behaviour/css').CssBehaviour,l=e('./folding/cstyle').FoldMode,c=function(){
this.HighlightRules=o,this.$outdent=new u,this.$behaviour=new f,this.foldingRules=new l
};
r.inherits(c,i),function(){
this.foldingRules='cStyle',this.blockComment={
start:'/*',
end:'*/'
},this.getNextLineIndent=function(e,t,n){
var r=this.$getIndent(t),i=this.getTokenizer().getLineTokens(t,e).tokens;
if(i.length&&i[i.length-1].type=='comment')
return r;
var s=t.match(/^.*\{\s*$/);
return s&&(r+=n),r
},this.checkOutdent=function(e,t,n){
return this.$outdent.checkOutdent(t,n)
},this.autoOutdent=function(e,t,n){
this.$outdent.autoOutdent(t,n)
},this.createWorker=function(e){
var t=new a(['ace'],'ace/mode/css_worker','Worker');
return t.attachToDocument(e.getDocument()),t.on('csslint',function(t){
e.setAnnotations(t.data)
}),t.on('terminate',function(){
e.clearAnnotations()
}),t
}
}.call(c.prototype),t.Mode=c
}),ace.define('ace/mode/css_highlight_rules',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/lib/lang',
'ace/mode/text_highlight_rules'
],function(e,t,n){
var r=e('../lib/oop'),i=e('../lib/lang'),s=e('./text_highlight_rules').TextHighlightRules,o=t.supportType='animation-fill-mode|alignment-adjust|alignment-baseline|animation-delay|animation-direction|animation-duration|animation-iteration-count|animation-name|animation-play-state|animation-timing-function|animation|appearance|azimuth|backface-visibility|background-attachment|background-break|background-clip|background-color|background-image|background-origin|background-position|background-repeat|background-size|background|baseline-shift|binding|bleed|bookmark-label|bookmark-level|bookmark-state|bookmark-target|border-bottom|border-bottom-color|border-bottom-left-radius|border-bottom-right-radius|border-bottom-style|border-bottom-width|border-collapse|border-color|border-image|border-image-outset|border-image-repeat|border-image-slice|border-image-source|border-image-width|border-left|border-left-color|border-left-style|border-left-width|border-radius|border-right|border-right-color|border-right-style|border-right-width|border-spacing|border-style|border-top|border-top-color|border-top-left-radius|border-top-right-radius|border-top-style|border-top-width|border-width|border|bottom|box-align|box-decoration-break|box-direction|box-flex-group|box-flex|box-lines|box-ordinal-group|box-orient|box-pack|box-shadow|box-sizing|break-after|break-before|break-inside|caption-side|clear|clip|color-profile|color|column-count|column-fill|column-gap|column-rule|column-rule-color|column-rule-style|column-rule-width|column-span|column-width|columns|content|counter-increment|counter-reset|crop|cue-after|cue-before|cue|cursor|direction|display|dominant-baseline|drop-initial-after-adjust|drop-initial-after-align|drop-initial-before-adjust|drop-initial-before-align|drop-initial-size|drop-initial-value|elevation|empty-cells|fit|fit-position|float-offset|float|font-family|font-size|font-size-adjust|font-stretch|font-style|font-variant|font-weight|font|grid-columns|grid-rows|hanging-punctuation|height|hyphenate-after|hyphenate-before|hyphenate-character|hyphenate-lines|hyphenate-resource|hyphens|icon|image-orientation|image-rendering|image-resolution|inline-box-align|left|letter-spacing|line-height|line-stacking-ruby|line-stacking-shift|line-stacking-strategy|line-stacking|list-style-image|list-style-position|list-style-type|list-style|margin-bottom|margin-left|margin-right|margin-top|margin|mark-after|mark-before|mark|marks|marquee-direction|marquee-play-count|marquee-speed|marquee-style|max-height|max-width|min-height|min-width|move-to|nav-down|nav-index|nav-left|nav-right|nav-up|opacity|orphans|outline-color|outline-offset|outline-style|outline-width|outline|overflow-style|overflow-x|overflow-y|overflow|padding-bottom|padding-left|padding-right|padding-top|padding|page-break-after|page-break-before|page-break-inside|page-policy|page|pause-after|pause-before|pause|perspective-origin|perspective|phonemes|pitch-range|pitch|play-during|position|presentation-level|punctuation-trim|quotes|rendering-intent|resize|rest-after|rest-before|rest|richness|right|rotation-point|rotation|ruby-align|ruby-overhang|ruby-position|ruby-span|size|speak-header|speak-numeral|speak-punctuation|speak|speech-rate|stress|string-set|table-layout|target-name|target-new|target-position|target|text-align-last|text-align|text-decoration|text-emphasis|text-height|text-indent|text-justify|text-outline|text-shadow|text-transform|text-wrap|top|transform-origin|transform-style|transform|transition-delay|transition-duration|transition-property|transition-timing-function|transition|unicode-bidi|vertical-align|visibility|voice-balance|voice-duration|voice-family|voice-pitch-range|voice-pitch|voice-rate|voice-stress|voice-volume|volume|white-space-collapse|white-space|widows|width|word-break|word-spacing|word-wrap|z-index',u=t.supportFunction='rgb|rgba|url|attr|counter|counters',a=t.supportConstant='absolute|after-edge|after|all-scroll|all|alphabetic|always|antialiased|armenian|auto|avoid-column|avoid-page|avoid|balance|baseline|before-edge|before|below|bidi-override|block-line-height|block|bold|bolder|border-box|both|bottom|box|break-all|break-word|capitalize|caps-height|caption|center|central|char|circle|cjk-ideographic|clone|close-quote|col-resize|collapse|column|consider-shifts|contain|content-box|cover|crosshair|cubic-bezier|dashed|decimal-leading-zero|decimal|default|disabled|disc|disregard-shifts|distribute-all-lines|distribute-letter|distribute-space|distribute|dotted|double|e-resize|ease-in|ease-in-out|ease-out|ease|ellipsis|end|exclude-ruby|fill|fixed|georgian|glyphs|grid-height|groove|hand|hanging|hebrew|help|hidden|hiragana-iroha|hiragana|horizontal|icon|ideograph-alpha|ideograph-numeric|ideograph-parenthesis|ideograph-space|ideographic|inactive|include-ruby|inherit|initial|inline-block|inline-box|inline-line-height|inline-table|inline|inset|inside|inter-ideograph|inter-word|invert|italic|justify|katakana-iroha|katakana|keep-all|last|left|lighter|line-edge|line-through|line|linear|list-item|local|loose|lower-alpha|lower-greek|lower-latin|lower-roman|lowercase|lr-tb|ltr|mathematical|max-height|max-size|medium|menu|message-box|middle|move|n-resize|ne-resize|newspaper|no-change|no-close-quote|no-drop|no-open-quote|no-repeat|none|normal|not-allowed|nowrap|nw-resize|oblique|open-quote|outset|outside|overline|padding-box|page|pointer|pre-line|pre-wrap|pre|preserve-3d|progress|relative|repeat-x|repeat-y|repeat|replaced|reset-size|ridge|right|round|row-resize|rtl|s-resize|scroll|se-resize|separate|slice|small-caps|small-caption|solid|space|square|start|static|status-bar|step-end|step-start|steps|stretch|strict|sub|super|sw-resize|table-caption|table-cell|table-column-group|table-column|table-footer-group|table-header-group|table-row-group|table-row|table|tb-rl|text-after-edge|text-before-edge|text-bottom|text-size|text-top|text|thick|thin|transparent|underline|upper-alpha|upper-latin|upper-roman|uppercase|use-script|vertical-ideographic|vertical-text|visible|w-resize|wait|whitespace|z-index|zero',f=t.supportConstantColor='aqua|black|blue|fuchsia|gray|green|lime|maroon|navy|olive|orange|purple|red|silver|teal|white|yellow',l=t.supportConstantFonts='arial|century|comic|courier|garamond|georgia|helvetica|impact|lucida|symbol|system|tahoma|times|trebuchet|utopia|verdana|webdings|sans-serif|serif|monospace',c=t.numRe='\\-?(?:(?:[0-9]+)|(?:[0-9]*\\.[0-9]+))',h=t.pseudoElements='(\\:+)\\b(after|before|first-letter|first-line|moz-selection|selection)\\b',p=t.pseudoClasses='(:)\\b(active|checked|disabled|empty|enabled|first-child|first-of-type|focus|hover|indeterminate|invalid|last-child|last-of-type|link|not|nth-child|nth-last-child|nth-last-of-type|nth-of-type|only-child|only-of-type|required|root|target|valid|visited)\\b',d=function(){
var e=this.createKeywordMapper({
'support.function':u,
'support.constant':a,
'support.type':o,
'support.constant.color':f,
'support.constant.fonts':l
},'text',!0);
this.$rules={
start:[
{
token:'comment',
regex:'\\/\\*',
push:'comment'
},
{
token:'paren.lparen',
regex:'\\{',
push:'ruleset'
},
{
token:'string',
regex:'@.*?{',
push:'media'
},
{
token:'keyword',
regex:'#[a-z0-9-_]+'
},
{
token:'variable',
regex:'\\.[a-z0-9-_]+'
},
{
token:'string',
regex:':[a-z0-9-_]+'
},
{
token:'constant',
regex:'[a-z0-9-_]+'
},
{caseInsensitive:!0}
],
media:[
{
token:'comment',
regex:'\\/\\*',
push:'comment'
},
{
token:'paren.lparen',
regex:'\\{',
push:'ruleset'
},
{
token:'string',
regex:'\\}',
next:'pop'
},
{
token:'keyword',
regex:'#[a-z0-9-_]+'
},
{
token:'variable',
regex:'\\.[a-z0-9-_]+'
},
{
token:'string',
regex:':[a-z0-9-_]+'
},
{
token:'constant',
regex:'[a-z0-9-_]+'
},
{caseInsensitive:!0}
],
comment:[
{
token:'comment',
regex:'\\*\\/',
next:'pop'
},
{defaultToken:'comment'}
],
ruleset:[
{
token:'paren.rparen',
regex:'\\}',
next:'pop'
},
{
token:'comment',
regex:'\\/\\*',
push:'comment'
},
{
token:'string',
regex:'["](?:(?:\\\\.)|(?:[^"\\\\]))*?["]'
},
{
token:'string',
regex:'[\'](?:(?:\\\\.)|(?:[^\'\\\\]))*?[\']'
},
{
token:[
'constant.numeric',
'keyword'
],
regex:'('+c+')(ch|cm|deg|em|ex|fr|gd|grad|Hz|in|kHz|mm|ms|pc|pt|px|rad|rem|s|turn|vh|vm|vw|%)'
},
{
token:'constant.numeric',
regex:c
},
{
token:'constant.numeric',
regex:'#[a-f0-9]{6}'
},
{
token:'constant.numeric',
regex:'#[a-f0-9]{3}'
},
{
token:[
'punctuation',
'entity.other.attribute-name.pseudo-element.css'
],
regex:h
},
{
token:[
'punctuation',
'entity.other.attribute-name.pseudo-class.css'
],
regex:p
},
{
token:[
'support.function',
'string',
'support.function'
],
regex:'(url\\()(.*)(\\))'
},
{
token:e,
regex:'\\-?[a-zA-Z_][a-zA-Z0-9_\\-]*'
},
{caseInsensitive:!0}
]
},this.normalizeRules()
};
r.inherits(d,s),t.CssHighlightRules=d
}),ace.define('ace/mode/behaviour/css',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/mode/behaviour',
'ace/mode/behaviour/cstyle',
'ace/token_iterator'
],function(e,t,n){
var r=e('../../lib/oop'),i=e('../behaviour').Behaviour,s=e('./cstyle').CstyleBehaviour,o=e('../../token_iterator').TokenIterator,u=function(){
this.inherit(s),this.add('colon','insertion',function(e,t,n,r,i){
if(i===':'){
var s=n.getCursorPosition(),u=new o(r,s.row,s.column),a=u.getCurrentToken();
a&&a.value.match(/\s+/)&&(a=u.stepBackward());
if(a&&a.type==='support.type'){
var f=r.doc.getLine(s.row),l=f.substring(s.column,s.column+1);
if(l===':')
return{
text:'',
selection:[
1,
1
]
};
if(!f.substring(s.column).match(/^\s*;/))
return{
text:':;',
selection:[
1,
1
]
}
}
}
}),this.add('colon','deletion',function(e,t,n,r,i){
var s=r.doc.getTextRange(i);
if(!i.isMultiLine()&&s===':'){
var u=n.getCursorPosition(),a=new o(r,u.row,u.column),f=a.getCurrentToken();
f&&f.value.match(/\s+/)&&(f=a.stepBackward());
if(f&&f.type==='support.type'){
var l=r.doc.getLine(i.start.row),c=l.substring(i.end.column,i.end.column+1);
if(c===';')
return i.end.column++,i
}
}
}),this.add('semicolon','insertion',function(e,t,n,r,i){
if(i===';'){
var s=n.getCursorPosition(),o=r.doc.getLine(s.row),u=o.substring(s.column,s.column+1);
if(u===';')
return{
text:'',
selection:[
1,
1
]
}
}
})
};
r.inherits(u,s),t.CssBehaviour=u
}),ace.define('ace/mode/html_highlight_rules',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/lib/lang',
'ace/mode/css_highlight_rules',
'ace/mode/javascript_highlight_rules',
'ace/mode/xml_highlight_rules'
],function(e,t,n){
var r=e('../lib/oop'),i=e('../lib/lang'),s=e('./css_highlight_rules').CssHighlightRules,o=e('./javascript_highlight_rules').JavaScriptHighlightRules,u=e('./xml_highlight_rules').XmlHighlightRules,a=i.createMap({
a:'anchor',
button:'form',
form:'form',
img:'image',
input:'form',
label:'form',
option:'form',
script:'script',
select:'form',
textarea:'form',
style:'style',
table:'table',
tbody:'table',
td:'table',
tfoot:'table',
th:'table',
tr:'table'
}),f=function(){
u.call(this),this.addRules({
attributes:[
{include:'space'},
{
token:'entity.other.attribute-name',
regex:'[-_a-zA-Z0-9:]+'
},
{
token:'keyword.operator.separator',
regex:'=',
push:[
{include:'space'},
{
token:'string',
regex:'[^<>=\'"`\\s]+',
next:'pop'
},
{
token:'empty',
regex:'',
next:'pop'
}
]
},
{include:'string'}
],
tag:[
{
token:function(e,t){
var n=a[t];
return[
'meta.tag.punctuation.begin',
'meta.tag.name'+(n?'.'+n:'')
]
},
regex:'(<)([-_a-zA-Z0-9:]+)',
next:'start_tag_stuff'
},
{
token:function(e,t){
var n=a[t];
return[
'meta.tag.punctuation.begin',
'meta.tag.name'+(n?'.'+n:'')
]
},
regex:'(</)([-_a-zA-Z0-9:]+)',
next:'end_tag_stuff'
}
],
start_tag_stuff:[
{include:'attributes'},
{
token:'meta.tag.punctuation.end',
regex:'/?>',
next:'start'
}
],
end_tag_stuff:[
{include:'space'},
{
token:'meta.tag.punctuation.end',
regex:'>',
next:'start'
}
]
}),this.embedTagRules(s,'css-','style'),this.embedTagRules(o,'js-','script'),this.constructor===f&&this.normalizeRules()
};
r.inherits(f,u),t.HtmlHighlightRules=f
}),ace.define('ace/mode/xml_highlight_rules',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/mode/xml_util',
'ace/mode/text_highlight_rules'
],function(e,t,n){
var r=e('../lib/oop'),i=e('./xml_util'),s=e('./text_highlight_rules').TextHighlightRules,o=function(e){
this.$rules={
start:[
{
token:'punctuation.string.begin',
regex:'<\\!\\[CDATA\\[',
next:'cdata'
},
{
token:[
'punctuation.instruction.begin',
'keyword.instruction'
],
regex:'(<\\?)(xml)(?=[\\s])',
next:'xml_declaration'
},
{
token:[
'punctuation.instruction.begin',
'keyword.instruction'
],
regex:'(<\\?)([-_a-zA-Z0-9]+)',
next:'instruction'
},
{
token:'comment',
regex:'<\\!--',
next:'comment'
},
{
token:[
'punctuation.doctype.begin',
'meta.tag.doctype'
],
regex:'(<\\!)(DOCTYPE)(?=[\\s])',
next:'doctype'
},
{include:'tag'},
{include:'reference'}
],
xml_declaration:[
{include:'attributes'},
{include:'instruction'}
],
instruction:[{
token:'punctuation.instruction.end',
regex:'\\?>',
next:'start'
}],
doctype:[
{include:'space'},
{include:'string'},
{
token:'punctuation.doctype.end',
regex:'>',
next:'start'
},
{
token:'xml-pe',
regex:'[-_a-zA-Z0-9:]+'
},
{
token:'punctuation.begin',
regex:'\\[',
push:'declarations'
}
],
declarations:[
{
token:'text',
regex:'\\s+'
},
{
token:'punctuation.end',
regex:']',
next:'pop'
},
{
token:[
'punctuation.begin',
'keyword'
],
regex:'(<\\!)([-_a-zA-Z0-9]+)',
push:[
{
token:'text',
regex:'\\s+'
},
{
token:'punctuation.end',
regex:'>',
next:'pop'
},
{include:'string'}
]
}
],
cdata:[
{
token:'string.end',
regex:'\\]\\]>',
next:'start'
},
{
token:'text',
regex:'\\s+'
},
{
token:'text',
regex:'(?:[^\\]]|\\](?!\\]>))+'
}
],
comment:[
{
token:'comment',
regex:'-->',
next:'start'
},
{defaultToken:'comment'}
],
tag:[
{
token:[
'meta.tag.punctuation.begin',
'meta.tag.name'
],
regex:'(<)((?:[-_a-zA-Z0-9]+:)?[-_a-zA-Z0-9]+)',
next:[
{include:'attributes'},
{
token:'meta.tag.punctuation.end',
regex:'/?>',
next:'start'
}
]
},
{
token:[
'meta.tag.punctuation.begin',
'meta.tag.name'
],
regex:'(</)((?:[-_a-zA-Z0-9]+:)?[-_a-zA-Z0-9]+)',
next:[
{include:'space'},
{
token:'meta.tag.punctuation.end',
regex:'>',
next:'start'
}
]
}
],
space:[{
token:'text',
regex:'\\s+'
}],
reference:[
{
token:'constant.language.escape',
regex:'(?:&#[0-9]+;)|(?:&#x[0-9a-fA-F]+;)|(?:&[a-zA-Z0-9_:\\.-]+;)'
},
{
token:'invalid.illegal',
regex:'&'
}
],
string:[
{
token:'string',
regex:'\'',
push:'qstring_inner'
},
{
token:'string',
regex:'"',
push:'qqstring_inner'
}
],
qstring_inner:[
{
token:'string',
regex:'\'',
next:'pop'
},
{include:'reference'},
{defaultToken:'string'}
],
qqstring_inner:[
{
token:'string',
regex:'"',
next:'pop'
},
{include:'reference'},
{defaultToken:'string'}
],
attributes:[
{
token:'entity.other.attribute-name',
regex:'(?:[-_a-zA-Z0-9]+:)?[-_a-zA-Z0-9]+'
},
{
token:'keyword.operator.separator',
regex:'='
},
{include:'space'},
{include:'string'}
]
},this.constructor===o&&this.normalizeRules()
};
(function(){
this.embedTagRules=function(e,t,n){
this.$rules.tag.unshift({
token:[
'meta.tag.punctuation.begin',
'meta.tag.name.'+n
],
regex:'(<)('+n+')',
next:[
{include:'space'},
{include:'attributes'},
{
token:'meta.tag.punctuation.end',
regex:'/?>',
next:t+'start'
}
]
}),this.$rules[n+'-end']=[
{include:'space'},
{
token:'meta.tag.punctuation.end',
regex:'>',
next:'start',
onMatch:function(e,t,n){
return n.splice(0),this.token
}
}
],this.embedRules(e,t,[
{
token:[
'meta.tag.punctuation.begin',
'meta.tag.name.'+n
],
regex:'(</)('+n+')',
next:n+'-end'
},
{
token:'string.begin',
regex:'<\\!\\[CDATA\\['
},
{
token:'string.end',
regex:'\\]\\]>'
}
])
}
}.call(s.prototype),r.inherits(o,s),t.XmlHighlightRules=o)
}),ace.define('ace/mode/xml_util',[
'require',
'exports',
'module'
],function(e,t,n){
function r(e){
return[
{
token:'string',
regex:'"',
next:e+'_qqstring'
},
{
token:'string',
regex:'\'',
next:e+'_qstring'
}
]
}
function i(e,t){
return[
{
token:'string',
regex:e,
next:t
},
{
token:'constant.language.escape',
regex:'(?:&#[0-9]+;)|(?:&#x[0-9a-fA-F]+;)|(?:&[a-zA-Z0-9_:\\.-]+;)'
},
{defaultToken:'string'}
]
}
t.tag=function(e,t,n,s){
e[t]=[
{
token:'text',
regex:'\\s+'
},
{
token:s?function(e){
return s[e]?'meta.tag.tag-name.'+s[e]:'meta.tag.tag-name'
}:'meta.tag.tag-name',
regex:'[-_a-zA-Z0-9:]+',
next:t+'_embed_attribute_list'
},
{
token:'empty',
regex:'',
next:t+'_embed_attribute_list'
}
],e[t+'_qstring']=i('\'',t+'_embed_attribute_list'),e[t+'_qqstring']=i('"',t+'_embed_attribute_list'),e[t+'_embed_attribute_list']=[
{
token:'meta.tag.r',
regex:'/?>',
next:n
},
{
token:'keyword.operator',
regex:'='
},
{
token:'entity.other.attribute-name',
regex:'[-_a-zA-Z0-9:]+'
},
{
token:'constant.numeric',
regex:'[+-]?\\d+(?:(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)?\\b'
},
{
token:'text',
regex:'\\s+'
}
].concat(r(t))
}
}),ace.define('ace/mode/behaviour/html',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/mode/behaviour/xml',
'ace/mode/behaviour/cstyle',
'ace/token_iterator'
],function(e,t,n){
function a(e,t){
var n=e.type.split('.');
return t.split('.').every(function(e){
return n.indexOf(e)!==-1
})
}
var r=e('../../lib/oop'),i=e('../behaviour/xml').XmlBehaviour,s=e('./cstyle').CstyleBehaviour,o=e('../../token_iterator').TokenIterator,u=[
'area',
'base',
'br',
'col',
'command',
'embed',
'hr',
'img',
'input',
'keygen',
'link',
'meta',
'param',
'source',
'track',
'wbr'
],f=function(){
this.inherit(i),this.add('autoclosing','insertion',function(e,t,n,r,i){
if(i=='>'){
var s=n.getCursorPosition(),f=new o(r,s.row,s.column),l=f.getCurrentToken();
if(l&&a(l,'string')&&f.getCurrentTokenColumn()+l.value.length>s.column)
return;
var c=!1;
if(!l||!a(l,'meta.tag')&&(!a(l,'text')||!l.value.match('/'))){
do
l=f.stepBackward();
while(l&&(a(l,'string')||a(l,'keyword.operator')||a(l,'entity.attribute-name')||a(l,'text')))
}else
c=!0;
if(!l||!a(l,'meta.tag.name')||f.stepBackward().value.match('/'))
return;
var h=l.value;
if(c)
var h=h.substring(0,s.column-l.start);
if(u.indexOf(h)!==-1)
return;
return{
text:'></'+h+'>',
selection:[
1,
1
]
}
}
})
};
r.inherits(f,i),t.HtmlBehaviour=f
}),ace.define('ace/mode/behaviour/xml',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/mode/behaviour',
'ace/mode/behaviour/cstyle',
'ace/token_iterator'
],function(e,t,n){
function u(e,t){
var n=e.type.split('.');
return t.split('.').every(function(e){
return n.indexOf(e)!==-1
})
}
var r=e('../../lib/oop'),i=e('../behaviour').Behaviour,s=e('./cstyle').CstyleBehaviour,o=e('../../token_iterator').TokenIterator,a=function(){
this.inherit(s,['string_dquotes']),this.add('autoclosing','insertion',function(e,t,n,r,i){
if(i=='>'){
var s=n.getCursorPosition(),a=new o(r,s.row,s.column),f=a.getCurrentToken();
if(f&&u(f,'string')&&a.getCurrentTokenColumn()+f.value.length>s.column)
return;
var l=!1;
if(!f||!u(f,'meta.tag')&&(!u(f,'text')||!f.value.match('/'))){
do
f=a.stepBackward();
while(f&&(u(f,'string')||u(f,'keyword.operator')||u(f,'entity.attribute-name')||u(f,'text')))
}else
l=!0;
if(!f||!u(f,'meta.tag.name')||a.stepBackward().value.match('/'))
return;
var c=f.value;
if(l)
var c=c.substring(0,s.column-f.start);
return{
text:'></'+c+'>',
selection:[
1,
1
]
}
}
}),this.add('autoindent','insertion',function(e,t,n,r,i){
if(i=='\n'){
var s=n.getCursorPosition(),o=r.getLine(s.row),u=o.substring(s.column,s.column+2);
if(u=='</'){
var a=this.$getIndent(o),f=a+r.getTabString();
return{
text:'\n'+f+'\n'+a,
selection:[
1,
f.length,
1,
f.length
]
}
}
}
})
};
r.inherits(a,i),t.XmlBehaviour=a
}),ace.define('ace/mode/folding/html',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/mode/folding/mixed',
'ace/mode/folding/xml',
'ace/mode/folding/cstyle'
],function(e,t,n){
var r=e('../../lib/oop'),i=e('./mixed').FoldMode,s=e('./xml').FoldMode,o=e('./cstyle').FoldMode,u=t.FoldMode=function(){
i.call(this,new s({
area:1,
base:1,
br:1,
col:1,
command:1,
embed:1,
hr:1,
img:1,
input:1,
keygen:1,
link:1,
meta:1,
param:1,
source:1,
track:1,
wbr:1,
li:1,
dt:1,
dd:1,
p:1,
rt:1,
rp:1,
optgroup:1,
option:1,
colgroup:1,
td:1,
th:1
}),{
'js-':new o,
'css-':new o
})
};
r.inherits(u,i)
}),ace.define('ace/mode/folding/mixed',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/mode/folding/fold_mode'
],function(e,t,n){
var r=e('../../lib/oop'),i=e('./fold_mode').FoldMode,s=t.FoldMode=function(e,t){
this.defaultMode=e,this.subModes=t
};
r.inherits(s,i),function(){
this.$getMode=function(e){
typeof e!='string'&&(e=e[0]);
for(var t in this.subModes)
if(e.indexOf(t)===0)
return this.subModes[t];
return null
},this.$tryMode=function(e,t,n,r){
var i=this.$getMode(e);
return i?i.getFoldWidget(t,n,r):''
},this.getFoldWidget=function(e,t,n){
return this.$tryMode(e.getState(n-1),e,t,n)||this.$tryMode(e.getState(n),e,t,n)||this.defaultMode.getFoldWidget(e,t,n)
},this.getFoldWidgetRange=function(e,t,n){
var r=this.$getMode(e.getState(n-1));
if(!r||!r.getFoldWidget(e,t,n))
r=this.$getMode(e.getState(n));
if(!r||!r.getFoldWidget(e,t,n))
r=this.defaultMode;
return r.getFoldWidgetRange(e,t,n)
}
}.call(s.prototype)
}),ace.define('ace/mode/folding/xml',[
'require',
'exports',
'module',
'ace/lib/oop',
'ace/lib/lang',
'ace/range',
'ace/mode/folding/fold_mode',
'ace/token_iterator'
],function(e,t,n){
var r=e('../../lib/oop'),i=e('../../lib/lang'),s=e('../../range').Range,o=e('./fold_mode').FoldMode,u=e('../../token_iterator').TokenIterator,a=t.FoldMode=function(e){
o.call(this),this.voidElements=e||{}
};
r.inherits(a,o),function(){
this.getFoldWidget=function(e,t,n){
var r=this._getFirstTagInLine(e,n);
return r.closing?t=='markbeginend'?'end':'':!r.tagName||this.voidElements[r.tagName.toLowerCase()]?'':r.selfClosing?'':r.value.indexOf('/'+r.tagName)!==-1?'':'start'
},this._getFirstTagInLine=function(e,t){
var n=e.getTokens(t),r='';
for(var s=0;s<n.length;s++){
var o=n[s];
o.type.lastIndexOf('meta.tag',0)===0?r+=o.value:r+=i.stringRepeat(' ',o.value.length)
}
return this._parseTag(r)
},this.tagRe=/^(\s*)(<?(\/?)([-_a-zA-Z0-9:!]*)\s*(\/?)>?)/,this._parseTag=function(e){
var t=e.match(this.tagRe),n=0;
return{
value:e,
match:t?t[2]:'',
closing:t?!!t[3]:!1,
selfClosing:t?!!t[5]||t[2]=='/>':!1,
tagName:t?t[4]:'',
column:t[1]?n+t[1].length:n
}
},this._readTagForward=function(e){
var t=e.getCurrentToken();
if(!t)
return null;
var n='',r;
do
if(t.type.lastIndexOf('meta.tag',0)===0){
if(!r)
var r={
row:e.getCurrentTokenRow(),
column:e.getCurrentTokenColumn()
};
n+=t.value;
if(n.indexOf('>')!==-1){
var i=this._parseTag(n);
return i.start=r,i.end={
row:e.getCurrentTokenRow(),
column:e.getCurrentTokenColumn()+t.value.length
},e.stepForward(),i
}
}
while(t=e.stepForward());
return null
},this._readTagBackward=function(e){
var t=e.getCurrentToken();
if(!t)
return null;
var n='',r;
do
if(t.type.lastIndexOf('meta.tag',0)===0){
r||(r={
row:e.getCurrentTokenRow(),
column:e.getCurrentTokenColumn()+t.value.length
}),n=t.value+n;
if(n.indexOf('<')!==-1){
var i=this._parseTag(n);
return i.end=r,i.start={
row:e.getCurrentTokenRow(),
column:e.getCurrentTokenColumn()
},e.stepBackward(),i
}
}
while(t=e.stepBackward());
return null
},this._pop=function(e,t){
while(e.length){
var n=e[e.length-1];
if(!t||n.tagName==t.tagName)
return e.pop();
if(this.voidElements[t.tagName])
return;
if(this.voidElements[n.tagName]){
e.pop();
continue
}
return null
}
},this.getFoldWidgetRange=function(e,t,n){
var r=this._getFirstTagInLine(e,n);
if(!r.match)
return null;
var i=r.closing||r.selfClosing,o=[],a;
if(!i){
var f=new u(e,n,r.column),l={
row:n,
column:r.column+r.tagName.length+2
};
while(a=this._readTagForward(f)){
if(a.selfClosing){
if(!o.length)
return a.start.column+=a.tagName.length+2,a.end.column-=2,s.fromPoints(a.start,a.end);
continue
}
if(a.closing){
this._pop(o,a);
if(o.length==0)
return s.fromPoints(l,a.start)
}else
o.push(a)
}
}else{
var f=new u(e,n,r.column+r.match.length),c={
row:n,
column:r.column
};
while(a=this._readTagBackward(f)){
if(a.selfClosing){
if(!o.length)
return a.start.column+=a.tagName.length+2,a.end.column-=2,s.fromPoints(a.start,a.end);
continue
}
if(!a.closing){
this._pop(o,a);
if(o.length==0)
return a.start.column+=a.tagName.length+2,s.fromPoints(a.start,c)
}else
o.push(a)
}
}
}
}.call(a.prototype)
}),ace.define('ace/mode/html_completions',[
'require',
'exports',
'module',
'ace/token_iterator'
],function(e,t,n){
function f(e,t){
var n=e.type.split('.');
return t.split('.').every(function(e){
return n.indexOf(e)!==-1
})
}
function l(e,t){
var n=new r(e,t.row,t.column),i=n.getCurrentToken();
if(!i||!f(i,'tag')&&(!f(i,'text')||!i.value.match('/')))
do
i=n.stepBackward();
while(i&&(f(i,'string')||f(i,'operator')||f(i,'attribute-name')||f(i,'text')));
if(i&&f(i,'tag-name')&&!n.stepBackward().value.match('/'))
return i.value
}
var r=e('../token_iterator').TokenIterator,i=[
'accesskey',
'class',
'contenteditable',
'contextmenu',
'dir',
'draggable',
'dropzone',
'hidden',
'id',
'lang',
'spellcheck',
'style',
'tabindex',
'title',
'translate'
],s=[
'onabort',
'onblur',
'oncancel',
'oncanplay',
'oncanplaythrough',
'onchange',
'onclick',
'onclose',
'oncontextmenu',
'oncuechange',
'ondblclick',
'ondrag',
'ondragend',
'ondragenter',
'ondragleave',
'ondragover',
'ondragstart',
'ondrop',
'ondurationchange',
'onemptied',
'onended',
'onerror',
'onfocus',
'oninput',
'oninvalid',
'onkeydown',
'onkeypress',
'onkeyup',
'onload',
'onloadeddata',
'onloadedmetadata',
'onloadstart',
'onmousedown',
'onmousemove',
'onmouseout',
'onmouseover',
'onmouseup',
'onmousewheel',
'onpause',
'onplay',
'onplaying',
'onprogress',
'onratechange',
'onreset',
'onscroll',
'onseeked',
'onseeking',
'onselect',
'onshow',
'onstalled',
'onsubmit',
'onsuspend',
'ontimeupdate',
'onvolumechange',
'onwaiting'
],o=i.concat(s),u={
html:['manifest'],
head:[],
title:[],
base:[
'href',
'target'
],
link:[
'href',
'hreflang',
'rel',
'media',
'type',
'sizes'
],
meta:[
'http-equiv',
'name',
'content',
'charset'
],
style:[
'type',
'media',
'scoped'
],
script:[
'charset',
'type',
'src',
'defer',
'async'
],
noscript:['href'],
body:[
'onafterprint',
'onbeforeprint',
'onbeforeunload',
'onhashchange',
'onmessage',
'onoffline',
'onpopstate',
'onredo',
'onresize',
'onstorage',
'onundo',
'onunload'
],
section:[],
nav:[],
article:['pubdate'],
aside:[],
h1:[],
h2:[],
h3:[],
h4:[],
h5:[],
h6:[],
header:[],
footer:[],
address:[],
main:[],
p:[],
hr:[],
pre:[],
blockquote:['cite'],
ol:[
'start',
'reversed'
],
ul:[],
li:['value'],
dl:[],
dt:[],
dd:[],
figure:[],
figcaption:[],
div:[],
a:[
'href',
'target',
'ping',
'rel',
'media',
'hreflang',
'type'
],
em:[],
strong:[],
small:[],
s:[],
cite:[],
q:['cite'],
dfn:[],
abbr:[],
data:[],
time:['datetime'],
code:[],
'var':[],
samp:[],
kbd:[],
sub:[],
sup:[],
i:[],
b:[],
u:[],
mark:[],
ruby:[],
rt:[],
rp:[],
bdi:[],
bdo:[],
span:[],
br:[],
wbr:[],
ins:[
'cite',
'datetime'
],
del:[
'cite',
'datetime'
],
img:[
'alt',
'src',
'height',
'width',
'usemap',
'ismap'
],
iframe:[
'name',
'src',
'height',
'width',
'sandbox',
'seamless'
],
embed:[
'src',
'height',
'width',
'type'
],
object:[
'param',
'data',
'type',
'height',
'width',
'usemap',
'name',
'form',
'classid'
],
param:[
'name',
'value'
],
video:[
'src',
'autobuffer',
'autoplay',
'loop',
'controls',
'width',
'height',
'poster'
],
audio:[
'src',
'autobuffer',
'autoplay',
'loop',
'controls'
],
source:[
'src',
'type',
'media'
],
track:[
'kind',
'src',
'srclang',
'label',
'default'
],
canvas:[
'width',
'height'
],
map:['name'],
area:[
'shape',
'coords',
'href',
'hreflang',
'alt',
'target',
'media',
'rel',
'ping',
'type'
],
svg:[],
math:[],
table:['summary'],
caption:[],
colgroup:['span'],
col:['span'],
tbody:[],
thead:[],
tfoot:[],
tr:[],
td:[
'headers',
'rowspan',
'colspan'
],
th:[
'headers',
'rowspan',
'colspan',
'scope'
],
form:[
'accept-charset',
'action',
'autocomplete',
'enctype',
'method',
'name',
'novalidate',
'target'
],
fieldset:[
'disabled',
'form',
'name'
],
legend:[],
label:[
'form',
'for'
],
input:[
'type',
'accept',
'alt',
'autocomplete',
'checked',
'disabled',
'form',
'formaction',
'formenctype',
'formmethod',
'formnovalidate',
'formtarget',
'height',
'list',
'max',
'maxlength',
'min',
'multiple',
'pattern',
'placeholder',
'readonly',
'required',
'size',
'src',
'step',
'width',
'files',
'value'
],
button:[
'autofocus',
'disabled',
'form',
'formaction',
'formenctype',
'formmethod',
'formnovalidate',
'formtarget',
'name',
'value',
'type'
],
select:[
'autofocus',
'disabled',
'form',
'multiple',
'name',
'size'
],
datalist:[],
optgroup:[
'disabled',
'label'
],
option:[
'disabled',
'selected',
'label',
'value'
],
textarea:[
'autofocus',
'disabled',
'form',
'maxlength',
'name',
'placeholder',
'readonly',
'required',
'rows',
'cols',
'wrap'
],
keygen:[
'autofocus',
'challenge',
'disabled',
'form',
'keytype',
'name'
],
output:[
'for',
'form',
'name'
],
progress:[
'value',
'max'
],
meter:[
'value',
'min',
'max',
'low',
'high',
'optimum'
],
details:['open'],
summary:[],
command:[
'type',
'label',
'icon',
'disabled',
'checked',
'radiogroup',
'command'
],
menu:[
'type',
'label'
],
dialog:['open']
},a=Object.keys(u),c=function(){
};
(function(){
this.getCompletions=function(e,t,n,r){
var i=t.getTokenAt(n.row,n.column);
return i?f(i,'tag-name')||i.value=='<'&&f(i,'text')?this.getTagCompletions(e,t,n,r):f(i,'text')||f(i,'attribute-name')?this.getAttributeCompetions(e,t,n,r):[]:[]
},this.getTagCompletions=function(e,t,n,r){
var i=a;
return r&&(i=i.filter(function(e){
return e.indexOf(r)===0
})),i.map(function(e){
return{
value:e,
meta:'tag'
}
})
},this.getAttributeCompetions=function(e,t,n,r){
var i=l(t,n);
if(!i)
return[];
var s=o;
return i in u&&(s=s.concat(u[i])),r&&(s=s.filter(function(e){
return e.indexOf(r)===0
})),s.map(function(e){
return{
caption:e,
snippet:e+'="$0"',
meta:'attribute'
}
})
}
}.call(c.prototype),t.HtmlCompletions=c)
});
if(!Array.prototype.find){
Array.prototype.find=function(predicate){
if(this===null){
throw new TypeError('Array.prototype.find called on null or undefined')
}
if(typeof predicate!=='function'){
throw new TypeError('predicate must be a function')
}
var list=Object(this);
var length=list.length>>>0;
var thisArg=arguments[1];
var value;
for(var i=0;i<length;i++){
value=list[i];
if(predicate.call(thisArg,value,i,list)){
return value
}
}
return undefined
}
}/*!
 * https://github.com/paulmillr/es6-shim
 * @license es6-shim Copyright 2013-2016 by Paul Miller (http://paulmillr.com)
 *   and contributors,  MIT License
 * es6-shim: v0.35.0
 * see https://github.com/paulmillr/es6-shim/blob/0.35.0/LICENSE
 * Details and documentation:
 * https://github.com/paulmillr/es6-shim/
 */
/*!
 * https://github.com/paulmillr/es6-shim
 * @license es6-shim Copyright 2013-2016 by Paul Miller (http://paulmillr.com)
 *   and contributors,  MIT License
 * es6-shim: v0.35.0
 * see https://github.com/paulmillr/es6-shim/blob/0.35.0/LICENSE
 * Details and documentation:
 * https://github.com/paulmillr/es6-shim/
 */
(function(e,t){
if(typeof define==='function'&&define.amd){
define(t)
}else if(typeof exports==='object'){
module.exports=t()
}else{
e.returnExports=t()
}
}(this,function(){
'use strict';
var e=Function.call.bind(Function.apply);
var t=Function.call.bind(Function.call);
var r=Array.isArray;
var n=Object.keys;
var o=function notThunker(t){
return function notThunk(){
return!e(t,this,arguments)
}
};
var i=function(e){
try{
e();
return false
}catch(t){
return true
}
};
var a=function valueOrFalseIfThrows(e){
try{
return e()
}catch(t){
return false
}
};
var u=o(i);
var f=function(){
return!i(function(){
Object.defineProperty({},'x',{
get:function(){
}
})
})
};
var s=!!Object.defineProperty&&f();
var c=function foo(){
}.name==='foo';
var l=Function.call.bind(Array.prototype.forEach);
var p=Function.call.bind(Array.prototype.reduce);
var v=Function.call.bind(Array.prototype.filter);
var y=Function.call.bind(Array.prototype.some);
var h=function(e,t,r,n){
if(!n&&t in e){
return
}
if(s){
Object.defineProperty(e,t,{
configurable:true,
enumerable:false,
writable:true,
value:r
})
}else{
e[t]=r
}
};
var b=function(e,t,r){
l(n(t),function(n){
var o=t[n];
h(e,n,o,!!r)
})
};
var g=Function.call.bind(Object.prototype.toString);
var d=typeof/abc/==='function'?function IsCallableSlow(e){
return typeof e==='function'&&g(e)==='[object Function]'
}:function IsCallableFast(e){
return typeof e==='function'
};
var O={
getter:function(e,t,r){
if(!s){
throw new TypeError('getters require true ES5 support')
}
Object.defineProperty(e,t,{
configurable:true,
enumerable:false,
get:r
})
},
proxy:function(e,t,r){
if(!s){
throw new TypeError('getters require true ES5 support')
}
var n=Object.getOwnPropertyDescriptor(e,t);
Object.defineProperty(r,t,{
configurable:n.configurable,
enumerable:n.enumerable,
get:function getKey(){
return e[t]
},
set:function setKey(r){
e[t]=r
}
})
},
redefine:function(e,t,r){
if(s){
var n=Object.getOwnPropertyDescriptor(e,t);
n.value=r;
Object.defineProperty(e,t,n)
}else{
e[t]=r
}
},
defineByDescriptor:function(e,t,r){
if(s){
Object.defineProperty(e,t,r)
}else if('value'in r){
e[t]=r.value
}
},
preserveToString:function(e,t){
if(t&&d(t.toString)){
h(e,'toString',t.toString.bind(t),true)
}
}
};
var m=Object.create||function(e,t){
var r=function Prototype(){
};
r.prototype=e;
var o=new r;
if(typeof t!=='undefined'){
n(t).forEach(function(e){
O.defineByDescriptor(o,e,t[e])
})
}
return o
};
var w=function(e,t){
if(!Object.setPrototypeOf){
return false
}
return a(function(){
var r=function Subclass(t){
var r=new e(t);
Object.setPrototypeOf(r,Subclass.prototype);
return r
};
Object.setPrototypeOf(r,e);
r.prototype=m(e.prototype,{constructor:{value:r}});
return t(r)
})
};
var j=function(){
if(typeof self!=='undefined'){
return self
}
if(typeof window!=='undefined'){
return window
}
if(typeof global!=='undefined'){
return global
}
throw new Error('unable to locate global object')
};
var S=j();
var T=S.isFinite;
var I=Function.call.bind(String.prototype.indexOf);
var E=Function.apply.bind(Array.prototype.indexOf);
var P=Function.call.bind(Array.prototype.concat);
var M=Function.call.bind(Array.prototype.sort);
var C=Function.call.bind(String.prototype.slice);
var x=Function.call.bind(Array.prototype.push);
var N=Function.apply.bind(Array.prototype.push);
var A=Function.call.bind(Array.prototype.shift);
var R=Math.max;
var _=Math.min;
var k=Math.floor;
var F=Math.abs;
var L=Math.log;
var D=Math.sqrt;
var z=Function.call.bind(Object.prototype.hasOwnProperty);
var q;
var G=function(){
};
var W=S.Symbol||{};
var H=W.species||'@@species';
var V=Number.isNaN||function isNaN(e){
return e!==e
};
var B=Number.isFinite||function isFinite(e){
return typeof e==='number'&&T(e)
};
var $=function isArguments(e){
return g(e)==='[object Arguments]'
};
var U=function isArguments(e){
return e!==null&&typeof e==='object'&&typeof e.length==='number'&&e.length>=0&&g(e)!=='[object Array]'&&g(e.callee)==='[object Function]'
};
var J=$(arguments)?$:U;
var K={
primitive:function(e){
return e===null||typeof e!=='function'&&typeof e!=='object'
},
object:function(e){
return e!==null&&typeof e==='object'
},
string:function(e){
return g(e)==='[object String]'
},
regex:function(e){
return g(e)==='[object RegExp]'
},
symbol:function(e){
return typeof S.Symbol==='function'&&typeof e==='symbol'
}
};
var X=function overrideNative(e,t,r){
var n=e[t];
h(e,t,r,true);
O.preserveToString(e[t],n)
};
var Z=typeof W==='function'&&typeof W['for']==='function'&&K.symbol(W());
var Y=K.symbol(W.iterator)?W.iterator:'_es6-shim iterator_';
if(S.Set&&typeof new S.Set()['@@iterator']==='function'){
Y='@@iterator'
}
if(!S.Reflect){
h(S,'Reflect',{},true)
}
var Q=S.Reflect;
var ee=String;
var te={
Call:function Call(t,r){
var n=arguments.length>2?arguments[2]:[];
if(!te.IsCallable(t)){
throw new TypeError(t+' is not a function')
}
return e(t,r,n)
},
RequireObjectCoercible:function(e,t){
if(e==null){
throw new TypeError(t||'Cannot call method on '+e)
}
return e
},
TypeIsObject:function(e){
if(e===void 0||e===null||e===true||e===false){
return false
}
return typeof e==='function'||typeof e==='object'
},
ToObject:function(e,t){
return Object(te.RequireObjectCoercible(e,t))
},
IsCallable:d,
IsConstructor:function(e){
return te.IsCallable(e)
},
ToInt32:function(e){
return te.ToNumber(e)>>0
},
ToUint32:function(e){
return te.ToNumber(e)>>>0
},
ToNumber:function(e){
if(g(e)==='[object Symbol]'){
throw new TypeError('Cannot convert a Symbol value to a number')
}
return+e
},
ToInteger:function(e){
var t=te.ToNumber(e);
if(V(t)){
return 0
}
if(t===0||!B(t)){
return t
}
return(t>0?1:-1)*k(F(t))
},
ToLength:function(e){
var t=te.ToInteger(e);
if(t<=0){
return 0
}
if(t>Number.MAX_SAFE_INTEGER){
return Number.MAX_SAFE_INTEGER
}
return t
},
SameValue:function(e,t){
if(e===t){
if(e===0){
return 1/e===1/t
}
return true
}
return V(e)&&V(t)
},
SameValueZero:function(e,t){
return e===t||V(e)&&V(t)
},
IsIterable:function(e){
return te.TypeIsObject(e)&&(typeof e[Y]!=='undefined'||J(e))
},
GetIterator:function(e){
if(J(e)){
return new q(e,'value')
}
var t=te.GetMethod(e,Y);
if(!te.IsCallable(t)){
throw new TypeError('value is not an iterable')
}
var r=te.Call(t,e);
if(!te.TypeIsObject(r)){
throw new TypeError('bad iterator')
}
return r
},
GetMethod:function(e,t){
var r=te.ToObject(e)[t];
if(r===void 0||r===null){
return void 0
}
if(!te.IsCallable(r)){
throw new TypeError('Method not callable: '+t)
}
return r
},
IteratorComplete:function(e){
return!!e.done
},
IteratorClose:function(e,t){
var r=te.GetMethod(e,'return');
if(r===void 0){
return
}
var n,o;
try{
n=te.Call(r,e)
}catch(i){
o=i
}
if(t){
return
}
if(o){
throw o
}
if(!te.TypeIsObject(n)){
throw new TypeError('Iterator\'s return method returned a non-object.')
}
},
IteratorNext:function(e){
var t=arguments.length>1?e.next(arguments[1]):e.next();
if(!te.TypeIsObject(t)){
throw new TypeError('bad iterator')
}
return t
},
IteratorStep:function(e){
var t=te.IteratorNext(e);
var r=te.IteratorComplete(t);
return r?false:t
},
Construct:function(e,t,r,n){
var o=typeof r==='undefined'?e:r;
if(!n&&Q.construct){
return Q.construct(e,t,o)
}
var i=o.prototype;
if(!te.TypeIsObject(i)){
i=Object.prototype
}
var a=m(i);
var u=te.Call(e,a,t);
return te.TypeIsObject(u)?u:a
},
SpeciesConstructor:function(e,t){
var r=e.constructor;
if(r===void 0){
return t
}
if(!te.TypeIsObject(r)){
throw new TypeError('Bad constructor')
}
var n=r[H];
if(n===void 0||n===null){
return t
}
if(!te.IsConstructor(n)){
throw new TypeError('Bad @@species')
}
return n
},
CreateHTML:function(e,t,r,n){
var o=te.ToString(e);
var i='<'+t;
if(r!==''){
var a=te.ToString(n);
var u=a.replace(/"/g,'&quot;');
i+=' '+r+'="'+u+'"'
}
var f=i+'>';
var s=f+o;
return s+'</'+t+'>'
},
IsRegExp:function IsRegExp(e){
if(!te.TypeIsObject(e)){
return false
}
var t=e[W.match];
if(typeof t!=='undefined'){
return!!t
}
return K.regex(e)
},
ToString:function ToString(e){
return ee(e)
}
};
if(s&&Z){
var re=function defineWellKnownSymbol(e){
if(K.symbol(W[e])){
return W[e]
}
var t=W['for']('Symbol.'+e);
Object.defineProperty(W,e,{
configurable:false,
enumerable:false,
writable:false,
value:t
});
return t
};
if(!K.symbol(W.search)){
var ne=re('search');
var oe=String.prototype.search;
h(RegExp.prototype,ne,function search(e){
return te.Call(oe,e,[this])
});
var ie=function search(e){
var t=te.RequireObjectCoercible(this);
if(e!==null&&typeof e!=='undefined'){
var r=te.GetMethod(e,ne);
if(typeof r!=='undefined'){
return te.Call(r,e,[t])
}
}
return te.Call(oe,t,[te.ToString(e)])
};
X(String.prototype,'search',ie)
}
if(!K.symbol(W.replace)){
var ae=re('replace');
var ue=String.prototype.replace;
h(RegExp.prototype,ae,function replace(e,t){
return te.Call(ue,e,[
this,
t
])
});
var fe=function replace(e,t){
var r=te.RequireObjectCoercible(this);
if(e!==null&&typeof e!=='undefined'){
var n=te.GetMethod(e,ae);
if(typeof n!=='undefined'){
return te.Call(n,e,[
r,
t
])
}
}
return te.Call(ue,r,[
te.ToString(e),
t
])
};
X(String.prototype,'replace',fe)
}
if(!K.symbol(W.split)){
var se=re('split');
var ce=String.prototype.split;
h(RegExp.prototype,se,function split(e,t){
return te.Call(ce,e,[
this,
t
])
});
var le=function split(e,t){
var r=te.RequireObjectCoercible(this);
if(e!==null&&typeof e!=='undefined'){
var n=te.GetMethod(e,se);
if(typeof n!=='undefined'){
return te.Call(n,e,[
r,
t
])
}
}
return te.Call(ce,r,[
te.ToString(e),
t
])
};
X(String.prototype,'split',le)
}
var pe=K.symbol(W.match);
var ve=pe&&function(){
var e={};
e[W.match]=function(){
return 42
};
return'a'.match(e)!==42
}();
if(!pe||ve){
var ye=re('match');
var he=String.prototype.match;
h(RegExp.prototype,ye,function match(e){
return te.Call(he,e,[this])
});
var be=function match(e){
var t=te.RequireObjectCoercible(this);
if(e!==null&&typeof e!=='undefined'){
var r=te.GetMethod(e,ye);
if(typeof r!=='undefined'){
return te.Call(r,e,[t])
}
}
return te.Call(he,t,[te.ToString(e)])
};
X(String.prototype,'match',be)
}
}
var ge=function wrapConstructor(e,t,r){
O.preserveToString(t,e);
if(Object.setPrototypeOf){
Object.setPrototypeOf(e,t)
}
if(s){
l(Object.getOwnPropertyNames(e),function(n){
if(n in G||r[n]){
return
}
O.proxy(e,n,t)
})
}else{
l(Object.keys(e),function(n){
if(n in G||r[n]){
return
}
t[n]=e[n]
})
}
t.prototype=e.prototype;
O.redefine(e.prototype,'constructor',t)
};
var de=function(){
return this
};
var Oe=function(e){
if(s&&!z(e,H)){
O.getter(e,H,de)
}
};
var me=function(e,t){
var r=t||function iterator(){
return this
};
h(e,Y,r);
if(!e[Y]&&K.symbol(Y)){
e[Y]=r
}
};
var we=function createDataProperty(e,t,r){
if(s){
Object.defineProperty(e,t,{
configurable:true,
enumerable:true,
writable:true,
value:r
})
}else{
e[t]=r
}
};
var je=function createDataPropertyOrThrow(e,t,r){
we(e,t,r);
if(!te.SameValue(e[t],r)){
throw new TypeError('property is nonconfigurable')
}
};
var Se=function(e,t,r,n){
if(!te.TypeIsObject(e)){
throw new TypeError('Constructor requires `new`: '+t.name)
}
var o=t.prototype;
if(!te.TypeIsObject(o)){
o=r
}
var i=m(o);
for(var a in n){
if(z(n,a)){
var u=n[a];
h(i,a,u,true)
}
}
return i
};
if(String.fromCodePoint&&String.fromCodePoint.length!==1){
var Te=String.fromCodePoint;
X(String,'fromCodePoint',function fromCodePoint(e){
return te.Call(Te,this,arguments)
})
}
var Ie={
fromCodePoint:function fromCodePoint(e){
var t=[];
var r;
for(var n=0,o=arguments.length;n<o;n++){
r=Number(arguments[n]);
if(!te.SameValue(r,te.ToInteger(r))||r<0||r>1114111){
throw new RangeError('Invalid code point '+r)
}
if(r<65536){
x(t,String.fromCharCode(r))
}else{
r-=65536;
x(t,String.fromCharCode((r>>10)+55296));
x(t,String.fromCharCode(r%1024+56320))
}
}
return t.join('')
},
raw:function raw(e){
var t=te.ToObject(e,'bad callSite');
var r=te.ToObject(t.raw,'bad raw value');
var n=r.length;
var o=te.ToLength(n);
if(o<=0){
return''
}
var i=[];
var a=0;
var u,f,s,c;
while(a<o){
u=te.ToString(a);
s=te.ToString(r[u]);
x(i,s);
if(a+1>=o){
break
}
f=a+1<arguments.length?arguments[a+1]:'';
c=te.ToString(f);
x(i,c);
a+=1
}
return i.join('')
}
};
if(String.raw&&String.raw({
raw:{
0:'x',
1:'y',
length:2
}
})!=='xy'){
X(String,'raw',Ie.raw)
}
b(String,Ie);
var Ee=function repeat(e,t){
if(t<1){
return''
}
if(t%2){
return repeat(e,t-1)+e
}
var r=repeat(e,t/2);
return r+r
};
var Pe=Infinity;
var Me={
repeat:function repeat(e){
var t=te.ToString(te.RequireObjectCoercible(this));
var r=te.ToInteger(e);
if(r<0||r>=Pe){
throw new RangeError('repeat count must be less than infinity and not overflow maximum string size')
}
return Ee(t,r)
},
startsWith:function startsWith(e){
var t=te.ToString(te.RequireObjectCoercible(this));
if(te.IsRegExp(e)){
throw new TypeError('Cannot call method "startsWith" with a regex')
}
var r=te.ToString(e);
var n;
if(arguments.length>1){
n=arguments[1]
}
var o=R(te.ToInteger(n),0);
return C(t,o,o+r.length)===r
},
endsWith:function endsWith(e){
var t=te.ToString(te.RequireObjectCoercible(this));
if(te.IsRegExp(e)){
throw new TypeError('Cannot call method "endsWith" with a regex')
}
var r=te.ToString(e);
var n=t.length;
var o;
if(arguments.length>1){
o=arguments[1]
}
var i=typeof o==='undefined'?n:te.ToInteger(o);
var a=_(R(i,0),n);
return C(t,a-r.length,a)===r
},
includes:function includes(e){
if(te.IsRegExp(e)){
throw new TypeError('"includes" does not accept a RegExp')
}
var t=te.ToString(e);
var r;
if(arguments.length>1){
r=arguments[1]
}
return I(this,t,r)!==-1
},
codePointAt:function codePointAt(e){
var t=te.ToString(te.RequireObjectCoercible(this));
var r=te.ToInteger(e);
var n=t.length;
if(r>=0&&r<n){
var o=t.charCodeAt(r);
var i=r+1===n;
if(o<55296||o>56319||i){
return o
}
var a=t.charCodeAt(r+1);
if(a<56320||a>57343){
return o
}
return(o-55296)*1024+(a-56320)+65536
}
}
};
if(String.prototype.includes&&'a'.includes('a',Infinity)!==false){
X(String.prototype,'includes',Me.includes)
}
if(String.prototype.startsWith&&String.prototype.endsWith){
var Ce=i(function(){
'/a/'.startsWith(/a/)
});
var xe=a(function(){
return'abc'.startsWith('a',Infinity)===false
});
if(!Ce||!xe){
X(String.prototype,'startsWith',Me.startsWith);
X(String.prototype,'endsWith',Me.endsWith)
}
}
if(Z){
var Ne=a(function(){
var e=/a/;
e[W.match]=false;
return'/a/'.startsWith(e)
});
if(!Ne){
X(String.prototype,'startsWith',Me.startsWith)
}
var Ae=a(function(){
var e=/a/;
e[W.match]=false;
return'/a/'.endsWith(e)
});
if(!Ae){
X(String.prototype,'endsWith',Me.endsWith)
}
var Re=a(function(){
var e=/a/;
e[W.match]=false;
return'/a/'.includes(e)
});
if(!Re){
X(String.prototype,'includes',Me.includes)
}
}
b(String.prototype,Me);
var _e=[
'	\n\r ',
'\u2028',
'\u2029'
].join('');
var ke=new RegExp('(^['+_e+']+)|(['+_e+']+$)','g');
var Fe=function trim(){
return te.ToString(te.RequireObjectCoercible(this)).replace(ke,'')
};
var Le=[
'',
'',
''
].join('');
var De=new RegExp('['+Le+']','g');
var ze=/^[\-+]0x[0-9a-f]+$/i;
var qe=Le.trim().length!==Le.length;
h(String.prototype,'trim',Fe,qe);
var Ge=function(e){
te.RequireObjectCoercible(e);
this._s=te.ToString(e);
this._i=0
};
Ge.prototype.next=function(){
var e=this._s,t=this._i;
if(typeof e==='undefined'||t>=e.length){
this._s=void 0;
return{
value:void 0,
done:true
}
}
var r=e.charCodeAt(t),n,o;
if(r<55296||r>56319||t+1===e.length){
o=1
}else{
n=e.charCodeAt(t+1);
o=n<56320||n>57343?1:2
}
this._i=t+o;
return{
value:e.substr(t,o),
done:false
}
};
me(Ge.prototype);
me(String.prototype,function(){
return new Ge(this)
});
var We={
from:function from(e){
var r=this;
var n;
if(arguments.length>1){
n=arguments[1]
}
var o,i;
if(typeof n==='undefined'){
o=false
}else{
if(!te.IsCallable(n)){
throw new TypeError('Array.from: when provided, the second argument must be a function')
}
if(arguments.length>2){
i=arguments[2]
}
o=true
}
var a=typeof(J(e)||te.GetMethod(e,Y))!=='undefined';
var u,f,s;
if(a){
f=te.IsConstructor(r)?Object(new r):[];
var c=te.GetIterator(e);
var l,p;
s=0;
while(true){
l=te.IteratorStep(c);
if(l===false){
break
}
p=l.value;
try{
if(o){
p=typeof i==='undefined'?n(p,s):t(n,i,p,s)
}
f[s]=p
}catch(v){
te.IteratorClose(c,true);
throw v
}
s+=1
}
u=s
}else{
var y=te.ToObject(e);
u=te.ToLength(y.length);
f=te.IsConstructor(r)?Object(new r(u)):new Array(u);
var h;
for(s=0;s<u;++s){
h=y[s];
if(o){
h=typeof i==='undefined'?n(h,s):t(n,i,h,s)
}
f[s]=h
}
}
f.length=u;
return f
},
of:function of(){
var e=arguments.length;
var t=this;
var n=r(t)||!te.IsCallable(t)?new Array(e):te.Construct(t,[e]);
for(var o=0;o<e;++o){
je(n,o,arguments[o])
}
n.length=e;
return n
}
};
b(Array,We);
Oe(Array);
var He=function(e){
return{
value:e,
done:arguments.length===0
}
};
q=function(e,t){
this.i=0;
this.array=e;
this.kind=t
};
b(q.prototype,{
next:function(){
var e=this.i,t=this.array;
if(!(this instanceof q)){
throw new TypeError('Not an ArrayIterator')
}
if(typeof t!=='undefined'){
var r=te.ToLength(t.length);
for(;e<r;e++){
var n=this.kind;
var o;
if(n==='key'){
o=e
}else if(n==='value'){
o=t[e]
}else if(n==='entry'){
o=[
e,
t[e]
]
}
this.i=e+1;
return{
value:o,
done:false
}
}
}
this.array=void 0;
return{
value:void 0,
done:true
}
}
});
me(q.prototype);
var Ve=function orderKeys(e,t){
var r=String(te.ToInteger(e))===e;
var n=String(te.ToInteger(t))===t;
if(r&&n){
return t-e
}else if(r&&!n){
return-1
}else if(!r&&n){
return 1
}else{
return e.localeCompare(t)
}
};
var Be=function getAllKeys(e){
var t=[];
var r=[];
for(var n in e){
x(z(e,n)?t:r,n)
}
M(t,Ve);
M(r,Ve);
return P(t,r)
};
var $e=Array.of===We.of||function(){
var e=function Foo(e){
this.length=e
};
e.prototype=[];
var t=Array.of.apply(e,[
1,
2
]);
return t instanceof e&&t.length===2
}();
if(!$e){
X(Array,'of',We.of)
}
var Ue={
copyWithin:function copyWithin(e,t){
var r=te.ToObject(this);
var n=te.ToLength(r.length);
var o=te.ToInteger(e);
var i=te.ToInteger(t);
var a=o<0?R(n+o,0):_(o,n);
var u=i<0?R(n+i,0):_(i,n);
var f;
if(arguments.length>2){
f=arguments[2]
}
var s=typeof f==='undefined'?n:te.ToInteger(f);
var c=s<0?R(n+s,0):_(s,n);
var l=_(c-u,n-a);
var p=1;
if(u<a&&a<u+l){
p=-1;
u+=l-1;
a+=l-1
}
while(l>0){
if(u in r){
r[a]=r[u]
}else{
delete r[a]
}
u+=p;
a+=p;
l-=1
}
return r
},
fill:function fill(e){
var t;
if(arguments.length>1){
t=arguments[1]
}
var r;
if(arguments.length>2){
r=arguments[2]
}
var n=te.ToObject(this);
var o=te.ToLength(n.length);
t=te.ToInteger(typeof t==='undefined'?0:t);
r=te.ToInteger(typeof r==='undefined'?o:r);
var i=t<0?R(o+t,0):_(t,o);
var a=r<0?o+r:r;
for(var u=i;u<o&&u<a;++u){
n[u]=e
}
return n
},
find:function find(e){
var r=te.ToObject(this);
var n=te.ToLength(r.length);
if(!te.IsCallable(e)){
throw new TypeError('Array#find: predicate must be a function')
}
var o=arguments.length>1?arguments[1]:null;
for(var i=0,a;i<n;i++){
a=r[i];
if(o){
if(t(e,o,a,i,r)){
return a
}
}else if(e(a,i,r)){
return a
}
}
},
findIndex:function findIndex(e){
var r=te.ToObject(this);
var n=te.ToLength(r.length);
if(!te.IsCallable(e)){
throw new TypeError('Array#findIndex: predicate must be a function')
}
var o=arguments.length>1?arguments[1]:null;
for(var i=0;i<n;i++){
if(o){
if(t(e,o,r[i],i,r)){
return i
}
}else if(e(r[i],i,r)){
return i
}
}
return-1
},
keys:function keys(){
return new q(this,'key')
},
values:function values(){
return new q(this,'value')
},
entries:function entries(){
return new q(this,'entry')
}
};
if(Array.prototype.keys&&!te.IsCallable([1].keys().next)){
delete Array.prototype.keys
}
if(Array.prototype.entries&&!te.IsCallable([1].entries().next)){
delete Array.prototype.entries
}
if(Array.prototype.keys&&Array.prototype.entries&&!Array.prototype.values&&Array.prototype[Y]){
b(Array.prototype,{values:Array.prototype[Y]});
if(K.symbol(W.unscopables)){
Array.prototype[W.unscopables].values=true
}
}
if(c&&Array.prototype.values&&Array.prototype.values.name!=='values'){
var Je=Array.prototype.values;
X(Array.prototype,'values',function values(){
return te.Call(Je,this,arguments)
});
h(Array.prototype,Y,Array.prototype.values,true)
}
b(Array.prototype,Ue);
if(1/[true].indexOf(true,-0)<0){
h(Array.prototype,'indexOf',function indexOf(e){
var t=E(this,arguments);
if(t===0&&1/t<0){
return 0
}
return t
},true)
}
me(Array.prototype,function(){
return this.values()
});
if(Object.getPrototypeOf){
me(Object.getPrototypeOf([].values()))
}
var Ke=function(){
return a(function(){
return Array.from({length:-1}).length===0
})
}();
var Xe=function(){
var e=Array.from([0].entries());
return e.length===1&&r(e[0])&&e[0][0]===0&&e[0][1]===0
}();
if(!Ke||!Xe){
X(Array,'from',We.from)
}
var Ze=function(){
return a(function(){
return Array.from([0],void 0)
})
}();
if(!Ze){
var Ye=Array.from;
X(Array,'from',function from(e){
if(arguments.length>1&&typeof arguments[1]!=='undefined'){
return te.Call(Ye,this,arguments)
}else{
return t(Ye,this,e)
}
})
}
var Qe=-(Math.pow(2,32)-1);
var et=function(e,r){
var n={length:Qe};
n[r?(n.length>>>0)-1:0]=true;
return a(function(){
t(e,n,function(){
throw new RangeError('should not reach here')
},[]);
return true
})
};
if(!et(Array.prototype.forEach)){
var tt=Array.prototype.forEach;
X(Array.prototype,'forEach',function forEach(e){
return te.Call(tt,this.length>=0?this:[],arguments)
},true)
}
if(!et(Array.prototype.map)){
var rt=Array.prototype.map;
X(Array.prototype,'map',function map(e){
return te.Call(rt,this.length>=0?this:[],arguments)
},true)
}
if(!et(Array.prototype.filter)){
var nt=Array.prototype.filter;
X(Array.prototype,'filter',function filter(e){
return te.Call(nt,this.length>=0?this:[],arguments)
},true)
}
if(!et(Array.prototype.some)){
var ot=Array.prototype.some;
X(Array.prototype,'some',function some(e){
return te.Call(ot,this.length>=0?this:[],arguments)
},true)
}
if(!et(Array.prototype.every)){
var it=Array.prototype.every;
X(Array.prototype,'every',function every(e){
return te.Call(it,this.length>=0?this:[],arguments)
},true)
}
if(!et(Array.prototype.reduce)){
var at=Array.prototype.reduce;
X(Array.prototype,'reduce',function reduce(e){
return te.Call(at,this.length>=0?this:[],arguments)
},true)
}
if(!et(Array.prototype.reduceRight,true)){
var ut=Array.prototype.reduceRight;
X(Array.prototype,'reduceRight',function reduceRight(e){
return te.Call(ut,this.length>=0?this:[],arguments)
},true)
}
var ft=Number('0o10')!==8;
var st=Number('0b10')!==2;
var ct=y(Le,function(e){
return Number(e+0+e)===0
});
if(ft||st||ct){
var lt=Number;
var pt=/^0b[01]+$/i;
var vt=/^0o[0-7]+$/i;
var yt=pt.test.bind(pt);
var ht=vt.test.bind(vt);
var bt=function(e){
var t;
if(typeof e.valueOf==='function'){
t=e.valueOf();
if(K.primitive(t)){
return t
}
}
if(typeof e.toString==='function'){
t=e.toString();
if(K.primitive(t)){
return t
}
}
throw new TypeError('No default value')
};
var gt=De.test.bind(De);
var dt=ze.test.bind(ze);
var Ot=function(){
var e=function Number(t){
var r;
if(arguments.length>0){
r=K.primitive(t)?t:bt(t,'number')
}else{
r=0
}
if(typeof r==='string'){
r=te.Call(Fe,r);
if(yt(r)){
r=parseInt(C(r,2),2)
}else if(ht(r)){
r=parseInt(C(r,2),8)
}else if(gt(r)||dt(r)){
r=NaN
}
}
var n=this;
var o=a(function(){
lt.prototype.valueOf.call(n);
return true
});
if(n instanceof e&&!o){
return new lt(r)
}
return lt(r)
};
return e
}();
ge(lt,Ot,{});
b(Ot,{
NaN:lt.NaN,
MAX_VALUE:lt.MAX_VALUE,
MIN_VALUE:lt.MIN_VALUE,
NEGATIVE_INFINITY:lt.NEGATIVE_INFINITY,
POSITIVE_INFINITY:lt.POSITIVE_INFINITY
});
Number=Ot;
O.redefine(S,'Number',Ot)
}
var mt=Math.pow(2,53)-1;
b(Number,{
MAX_SAFE_INTEGER:mt,
MIN_SAFE_INTEGER:-mt,
EPSILON:2.220446049250313e-16,
parseInt:S.parseInt,
parseFloat:S.parseFloat,
isFinite:B,
isInteger:function isInteger(e){
return B(e)&&te.ToInteger(e)===e
},
isSafeInteger:function isSafeInteger(e){
return Number.isInteger(e)&&F(e)<=Number.MAX_SAFE_INTEGER
},
isNaN:V
});
h(Number,'parseInt',S.parseInt,Number.parseInt!==S.parseInt);
if(![
,
1
].find(function(e,t){
return t===0
})){
X(Array.prototype,'find',Ue.find)
}
if([
,
1
].findIndex(function(e,t){
return t===0
})!==0){
X(Array.prototype,'findIndex',Ue.findIndex)
}
var wt=Function.bind.call(Function.bind,Object.prototype.propertyIsEnumerable);
var jt=function ensureEnumerable(e,t){
if(s&&wt(e,t)){
Object.defineProperty(e,t,{enumerable:false})
}
};
var St=function sliceArgs(){
var e=Number(this);
var t=arguments.length;
var r=t-e;
var n=new Array(r<0?0:r);
for(var o=e;o<t;++o){
n[o-e]=arguments[o]
}
return n
};
var Tt=function assignTo(e){
return function assignToSource(t,r){
t[r]=e[r];
return t
}
};
var It=function(e,t){
var r=n(Object(t));
var o;
if(te.IsCallable(Object.getOwnPropertySymbols)){
o=v(Object.getOwnPropertySymbols(Object(t)),wt(t))
}
return p(P(r,o||[]),Tt(t),e)
};
var Et={
assign:function(e,t){
var r=te.ToObject(e,'Cannot convert undefined or null to object');
return p(te.Call(St,1,arguments),It,r)
},
is:function is(e,t){
return te.SameValue(e,t)
}
};
var Pt=Object.assign&&Object.preventExtensions&&function(){
var e=Object.preventExtensions({1:2});
try{
Object.assign(e,'xy')
}catch(t){
return e[1]==='y'
}
}();
if(Pt){
X(Object,'assign',Et.assign)
}
b(Object,Et);
if(s){
var Mt={
setPrototypeOf:function(e,r){
var n;
var o=function(e,t){
if(!te.TypeIsObject(e)){
throw new TypeError('cannot set prototype on a non-object')
}
if(!(t===null||te.TypeIsObject(t))){
throw new TypeError('can only set prototype to an object or null'+t)
}
};
var i=function(e,r){
o(e,r);
t(n,e,r);
return e
};
try{
n=e.getOwnPropertyDescriptor(e.prototype,r).set;
t(n,{},null)
}catch(a){
if(e.prototype!=={}[r]){
return
}
n=function(e){
this[r]=e
};
i.polyfill=i(i({},null),e.prototype)instanceof e
}
return i
}(Object,'__proto__')
};
b(Object,Mt)
}
if(Object.setPrototypeOf&&Object.getPrototypeOf&&Object.getPrototypeOf(Object.setPrototypeOf({},null))!==null&&Object.getPrototypeOf(Object.create(null))===null){
(function(){
var e=Object.create(null);
var t=Object.getPrototypeOf,r=Object.setPrototypeOf;
Object.getPrototypeOf=function(r){
var n=t(r);
return n===e?null:n
};
Object.setPrototypeOf=function(t,n){
var o=n===null?e:n;
return r(t,o)
};
Object.setPrototypeOf.polyfill=false
}())
}
var Ct=!i(function(){
Object.keys('foo')
});
if(!Ct){
var xt=Object.keys;
X(Object,'keys',function keys(e){
return xt(te.ToObject(e))
});
n=Object.keys
}
var Nt=i(function(){
Object.keys(/a/g)
});
if(Nt){
var At=Object.keys;
X(Object,'keys',function keys(e){
if(K.regex(e)){
var t=[];
for(var r in e){
if(z(e,r)){
x(t,r)
}
}
return t
}
return At(e)
});
n=Object.keys
}
if(Object.getOwnPropertyNames){
var Rt=!i(function(){
Object.getOwnPropertyNames('foo')
});
if(!Rt){
var _t=typeof window==='object'?Object.getOwnPropertyNames(window):[];
var kt=Object.getOwnPropertyNames;
X(Object,'getOwnPropertyNames',function getOwnPropertyNames(e){
var t=te.ToObject(e);
if(g(t)==='[object Window]'){
try{
return kt(t)
}catch(r){
return P([],_t)
}
}
return kt(t)
})
}
}
if(Object.getOwnPropertyDescriptor){
var Ft=!i(function(){
Object.getOwnPropertyDescriptor('foo','bar')
});
if(!Ft){
var Lt=Object.getOwnPropertyDescriptor;
X(Object,'getOwnPropertyDescriptor',function getOwnPropertyDescriptor(e,t){
return Lt(te.ToObject(e),t)
})
}
}
if(Object.seal){
var Dt=!i(function(){
Object.seal('foo')
});
if(!Dt){
var zt=Object.seal;
X(Object,'seal',function seal(e){
if(!K.object(e)){
return e
}
return zt(e)
})
}
}
if(Object.isSealed){
var qt=!i(function(){
Object.isSealed('foo')
});
if(!qt){
var Gt=Object.isSealed;
X(Object,'isSealed',function isSealed(e){
if(!K.object(e)){
return true
}
return Gt(e)
})
}
}
if(Object.freeze){
var Wt=!i(function(){
Object.freeze('foo')
});
if(!Wt){
var Ht=Object.freeze;
X(Object,'freeze',function freeze(e){
if(!K.object(e)){
return e
}
return Ht(e)
})
}
}
if(Object.isFrozen){
var Vt=!i(function(){
Object.isFrozen('foo')
});
if(!Vt){
var Bt=Object.isFrozen;
X(Object,'isFrozen',function isFrozen(e){
if(!K.object(e)){
return true
}
return Bt(e)
})
}
}
if(Object.preventExtensions){
var $t=!i(function(){
Object.preventExtensions('foo')
});
if(!$t){
var Ut=Object.preventExtensions;
X(Object,'preventExtensions',function preventExtensions(e){
if(!K.object(e)){
return e
}
return Ut(e)
})
}
}
if(Object.isExtensible){
var Jt=!i(function(){
Object.isExtensible('foo')
});
if(!Jt){
var Kt=Object.isExtensible;
X(Object,'isExtensible',function isExtensible(e){
if(!K.object(e)){
return false
}
return Kt(e)
})
}
}
if(Object.getPrototypeOf){
var Xt=!i(function(){
Object.getPrototypeOf('foo')
});
if(!Xt){
var Zt=Object.getPrototypeOf;
X(Object,'getPrototypeOf',function getPrototypeOf(e){
return Zt(te.ToObject(e))
})
}
}
var Yt=s&&function(){
var e=Object.getOwnPropertyDescriptor(RegExp.prototype,'flags');
return e&&te.IsCallable(e.get)
}();
if(s&&!Yt){
var Qt=function flags(){
if(!te.TypeIsObject(this)){
throw new TypeError('Method called on incompatible type: must be an object.')
}
var e='';
if(this.global){
e+='g'
}
if(this.ignoreCase){
e+='i'
}
if(this.multiline){
e+='m'
}
if(this.unicode){
e+='u'
}
if(this.sticky){
e+='y'
}
return e
};
O.getter(RegExp.prototype,'flags',Qt)
}
var er=s&&a(function(){
return String(new RegExp(/a/g,'i'))==='/a/i'
});
var tr=Z&&s&&function(){
var e=/./;
e[W.match]=false;
return RegExp(e)===e
}();
var rr=a(function(){
return RegExp.prototype.toString.call({source:'abc'})==='/abc/'
});
var nr=rr&&a(function(){
return RegExp.prototype.toString.call({
source:'a',
flags:'b'
})==='/a/b'
});
if(!rr||!nr){
var or=RegExp.prototype.toString;
h(RegExp.prototype,'toString',function toString(){
var e=te.RequireObjectCoercible(this);
if(K.regex(e)){
return t(or,e)
}
var r=ee(e.source);
var n=ee(e.flags);
return'/'+r+'/'+n
},true);
O.preserveToString(RegExp.prototype.toString,or)
}
if(s&&(!er||tr)){
var ir=Object.getOwnPropertyDescriptor(RegExp.prototype,'flags').get;
var ar=Object.getOwnPropertyDescriptor(RegExp.prototype,'source')||{};
var ur=function(){
return this.source
};
var fr=te.IsCallable(ar.get)?ar.get:ur;
var sr=RegExp;
var cr=function(){
return function RegExp(e,t){
var r=te.IsRegExp(e);
var n=this instanceof RegExp;
if(!n&&r&&typeof t==='undefined'&&e.constructor===RegExp){
return e
}
var o=e;
var i=t;
if(K.regex(e)){
o=te.Call(fr,e);
i=typeof t==='undefined'?te.Call(ir,e):t;
return new RegExp(o,i)
}else if(r){
o=e.source;
i=typeof t==='undefined'?e.flags:t
}
return new sr(e,t)
}
}();
ge(sr,cr,{$input:true});
RegExp=cr;
O.redefine(S,'RegExp',cr)
}
if(s){
var lr={
input:'$_',
lastMatch:'$&',
lastParen:'$+',
leftContext:'$`',
rightContext:'$\''
};
l(n(lr),function(e){
if(e in RegExp&&!(lr[e]in RegExp)){
O.getter(RegExp,lr[e],function get(){
return RegExp[e]
})
}
})
}
Oe(RegExp);
var pr=1/Number.EPSILON;
var vr=function roundTiesToEven(e){
return e+pr-pr
};
var yr=Math.pow(2,-23);
var hr=Math.pow(2,127)*(2-yr);
var br=Math.pow(2,-126);
var gr=Number.prototype.clz;
delete Number.prototype.clz;
var dr={
acosh:function acosh(e){
var t=Number(e);
if(Number.isNaN(t)||e<1){
return NaN
}
if(t===1){
return 0
}
if(t===Infinity){
return t
}
return L(t/Math.E+D(t+1)*D(t-1)/Math.E)+1
},
asinh:function asinh(e){
var t=Number(e);
if(t===0||!T(t)){
return t
}
return t<0?-Math.asinh(-t):L(t+D(t*t+1))
},
atanh:function atanh(e){
var t=Number(e);
if(Number.isNaN(t)||t<-1||t>1){
return NaN
}
if(t===-1){
return-Infinity
}
if(t===1){
return Infinity
}
if(t===0){
return t
}
return 0.5*L((1+t)/(1-t))
},
cbrt:function cbrt(e){
var t=Number(e);
if(t===0){
return t
}
var r=t<0,n;
if(r){
t=-t
}
if(t===Infinity){
n=Infinity
}else{
n=Math.exp(L(t)/3);
n=(t/(n*n)+2*n)/3
}
return r?-n:n
},
clz32:function clz32(e){
var t=Number(e);
var r=te.ToUint32(t);
if(r===0){
return 32
}
return gr?te.Call(gr,r):31-k(L(r+0.5)*Math.LOG2E)
},
cosh:function cosh(e){
var t=Number(e);
if(t===0){
return 1
}
if(Number.isNaN(t)){
return NaN
}
if(!T(t)){
return Infinity
}
if(t<0){
t=-t
}
if(t>21){
return Math.exp(t)/2
}
return(Math.exp(t)+Math.exp(-t))/2
},
expm1:function expm1(e){
var t=Number(e);
if(t===-Infinity){
return-1
}
if(!T(t)||t===0){
return t
}
if(F(t)>0.5){
return Math.exp(t)-1
}
var r=t;
var n=0;
var o=1;
while(n+r!==n){
n+=r;
o+=1;
r*=t/o
}
return n
},
hypot:function hypot(e,t){
var r=0;
var n=0;
for(var o=0;o<arguments.length;++o){
var i=F(Number(arguments[o]));
if(n<i){
r*=n/ i*(n/ i);
r+=1;
n=i
}else{
r+=i>0?i/n*(i/n):i
}
}
return n===Infinity?Infinity:n*D(r)
},
log2:function log2(e){
return L(e)*Math.LOG2E
},
log10:function log10(e){
return L(e)*Math.LOG10E
},
log1p:function log1p(e){
var t=Number(e);
if(t<-1||Number.isNaN(t)){
return NaN
}
if(t===0||t===Infinity){
return t
}
if(t===-1){
return-Infinity
}
return 1+t-1===0?t:t*(L(1+t)/(1+t-1))
},
sign:function sign(e){
var t=Number(e);
if(t===0){
return t
}
if(Number.isNaN(t)){
return t
}
return t<0?-1:1
},
sinh:function sinh(e){
var t=Number(e);
if(!T(t)||t===0){
return t
}
if(F(t)<1){
return(Math.expm1(t)-Math.expm1(-t))/2
}
return(Math.exp(t-1)-Math.exp(-t-1))*Math.E/2
},
tanh:function tanh(e){
var t=Number(e);
if(Number.isNaN(t)||t===0){
return t
}
if(t>=20){
return 1
}
if(t<=-20){
return-1
}
var r=Math.expm1(t);
var n=Math.expm1(-t);
if(r===Infinity){
return 1
}
if(n===Infinity){
return-1
}
return(r-n)/(Math.exp(t)+Math.exp(-t))
},
trunc:function trunc(e){
var t=Number(e);
return t<0?-k(-t):k(t)
},
imul:function imul(e,t){
var r=te.ToUint32(e);
var n=te.ToUint32(t);
var o=r>>>16&65535;
var i=r&65535;
var a=n>>>16&65535;
var u=n&65535;
return i*u+(o*u+i*a<<16>>>0)|0
},
fround:function fround(e){
var t=Number(e);
if(t===0||t===Infinity||t===-Infinity||V(t)){
return t
}
var r=Math.sign(t);
var n=F(t);
if(n<br){
return r*vr(n/br/yr)*br*yr
}
var o=(1+yr/Number.EPSILON)*n;
var i=o-(o-n);
if(i>hr||V(i)){
return r*Infinity
}
return r*i
}
};
b(Math,dr);
h(Math,'log1p',dr.log1p,Math.log1p(-1e-17)!==-1e-17);
h(Math,'asinh',dr.asinh,Math.asinh(-10000000)!==-Math.asinh(10000000));
h(Math,'tanh',dr.tanh,Math.tanh(-2e-17)!==-2e-17);
h(Math,'acosh',dr.acosh,Math.acosh(Number.MAX_VALUE)===Infinity);
h(Math,'cbrt',dr.cbrt,Math.abs(1-Math.cbrt(1e-300)/1e-100)/Number.EPSILON>8);
h(Math,'sinh',dr.sinh,Math.sinh(-2e-17)!==-2e-17);
var Or=Math.expm1(10);
h(Math,'expm1',dr.expm1,Or>22025.465794806718||Or<22025.465794806718);
var mr=Math.round;
var wr=Math.round(0.5-Number.EPSILON/4)===0&&Math.round(-0.5+Number.EPSILON/3.99)===1;
var jr=pr+1;
var Sr=2*pr-1;
var Tr=[
jr,
Sr
].every(function(e){
return Math.round(e)===e
});
h(Math,'round',function round(e){
var t=k(e);
var r=t===-1?-0:t+1;
return e-t<0.5?t:r
},!wr||!Tr);
O.preserveToString(Math.round,mr);
var Ir=Math.imul;
if(Math.imul(4294967295,5)!==-5){
Math.imul=dr.imul;
O.preserveToString(Math.imul,Ir)
}
if(Math.imul.length!==2){
X(Math,'imul',function imul(e,t){
return te.Call(Ir,Math,arguments)
})
}
var Er=function(){
var e=S.setTimeout;
if(typeof e!=='function'&&typeof e!=='object'){
return
}
te.IsPromise=function(e){
if(!te.TypeIsObject(e)){
return false
}
if(typeof e._promise==='undefined'){
return false
}
return true
};
var r=function(e){
if(!te.IsConstructor(e)){
throw new TypeError('Bad promise constructor')
}
var t=this;
var r=function(e,r){
if(t.resolve!==void 0||t.reject!==void 0){
throw new TypeError('Bad Promise implementation!')
}
t.resolve=e;
t.reject=r
};
t.resolve=void 0;
t.reject=void 0;
t.promise=new e(r);
if(!(te.IsCallable(t.resolve)&&te.IsCallable(t.reject))){
throw new TypeError('Bad promise constructor')
}
};
var n;
if(typeof window!=='undefined'&&te.IsCallable(window.postMessage)){
n=function(){
var e=[];
var t='zero-timeout-message';
var r=function(r){
x(e,r);
window.postMessage(t,'*')
};
var n=function(r){
if(r.source===window&&r.data===t){
r.stopPropagation();
if(e.length===0){
return
}
var n=A(e);
n()
}
};
window.addEventListener('message',n,true);
return r
}
}
var o=function(){
var e=S.Promise;
var t=e&&e.resolve&&e.resolve();
return t&&function(e){
return t.then(e)
}
};
var i=te.IsCallable(S.setImmediate)?S.setImmediate:typeof process==='object'&&process.nextTick?process.nextTick:o()||(te.IsCallable(n)?n():function(t){
e(t,0)
});
var a=function(e){
return e
};
var u=function(e){
throw e
};
var f=0;
var s=1;
var c=2;
var l=0;
var p=1;
var v=2;
var y={};
var h=function(e,t,r){
i(function(){
g(e,t,r)
})
};
var g=function(e,t,r){
var n,o;
if(t===y){
return e(r)
}
try{
n=e(r);
o=t.resolve
}catch(i){
n=i;
o=t.reject
}
o(n)
};
var d=function(e,t){
var r=e._promise;
var n=r.reactionLength;
if(n>0){
h(r.fulfillReactionHandler0,r.reactionCapability0,t);
r.fulfillReactionHandler0=void 0;
r.rejectReactions0=void 0;
r.reactionCapability0=void 0;
if(n>1){
for(var o=1,i=0;o<n;o++,i+=3){
h(r[i+l],r[i+v],t);
e[i+l]=void 0;
e[i+p]=void 0;
e[i+v]=void 0
}
}
}
r.result=t;
r.state=s;
r.reactionLength=0
};
var O=function(e,t){
var r=e._promise;
var n=r.reactionLength;
if(n>0){
h(r.rejectReactionHandler0,r.reactionCapability0,t);
r.fulfillReactionHandler0=void 0;
r.rejectReactions0=void 0;
r.reactionCapability0=void 0;
if(n>1){
for(var o=1,i=0;o<n;o++,i+=3){
h(r[i+p],r[i+v],t);
e[i+l]=void 0;
e[i+p]=void 0;
e[i+v]=void 0
}
}
}
r.result=t;
r.state=c;
r.reactionLength=0
};
var m=function(e){
var t=false;
var r=function(r){
var n;
if(t){
return
}
t=true;
if(r===e){
return O(e,new TypeError('Self resolution'))
}
if(!te.TypeIsObject(r)){
return d(e,r)
}
try{
n=r.then
}catch(o){
return O(e,o)
}
if(!te.IsCallable(n)){
return d(e,r)
}
i(function(){
j(e,r,n)
})
};
var n=function(r){
if(t){
return
}
t=true;
return O(e,r)
};
return{
resolve:r,
reject:n
}
};
var w=function(e,r,n,o){
if(e===I){
t(e,r,n,o,y)
}else{
t(e,r,n,o)
}
};
var j=function(e,t,r){
var n=m(e);
var o=n.resolve;
var i=n.reject;
try{
w(r,t,o,i)
}catch(a){
i(a)
}
};
var T,I;
var E=function(){
var e=function Promise(t){
if(!(this instanceof e)){
throw new TypeError('Constructor Promise requires "new"')
}
if(this&&this._promise){
throw new TypeError('Bad construction')
}
if(!te.IsCallable(t)){
throw new TypeError('not a valid resolver')
}
var r=Se(this,e,T,{
_promise:{
result:void 0,
state:f,
reactionLength:0,
fulfillReactionHandler0:void 0,
rejectReactionHandler0:void 0,
reactionCapability0:void 0
}
});
var n=m(r);
var o=n.reject;
try{
t(n.resolve,o)
}catch(i){
o(i)
}
return r
};
return e
}();
T=E.prototype;
var P=function(e,t,r,n){
var o=false;
return function(i){
if(o){
return
}
o=true;
t[e]=i;
if(--n.count===0){
var a=r.resolve;
a(t)
}
}
};
var M=function(e,t,r){
var n=e.iterator;
var o=[],i={count:1},a,u;
var f=0;
while(true){
try{
a=te.IteratorStep(n);
if(a===false){
e.done=true;
break
}
u=a.value
}catch(s){
e.done=true;
throw s
}
o[f]=void 0;
var c=t.resolve(u);
var l=P(f,o,r,i);
i.count+=1;
w(c.then,c,l,r.reject);
f+=1
}
if(--i.count===0){
var p=r.resolve;
p(o)
}
return r.promise
};
var C=function(e,t,r){
var n=e.iterator,o,i,a;
while(true){
try{
o=te.IteratorStep(n);
if(o===false){
e.done=true;
break
}
i=o.value
}catch(u){
e.done=true;
throw u
}
a=t.resolve(i);
w(a.then,a,r.resolve,r.reject)
}
return r.promise
};
b(E,{
all:function all(e){
var t=this;
if(!te.TypeIsObject(t)){
throw new TypeError('Promise is not object')
}
var n=new r(t);
var o,i;
try{
o=te.GetIterator(e);
i={
iterator:o,
done:false
};
return M(i,t,n)
}catch(a){
var u=a;
if(i&&!i.done){
try{
te.IteratorClose(o,true)
}catch(f){
u=f
}
}
var s=n.reject;
s(u);
return n.promise
}
},
race:function race(e){
var t=this;
if(!te.TypeIsObject(t)){
throw new TypeError('Promise is not object')
}
var n=new r(t);
var o,i;
try{
o=te.GetIterator(e);
i={
iterator:o,
done:false
};
return C(i,t,n)
}catch(a){
var u=a;
if(i&&!i.done){
try{
te.IteratorClose(o,true)
}catch(f){
u=f
}
}
var s=n.reject;
s(u);
return n.promise
}
},
reject:function reject(e){
var t=this;
if(!te.TypeIsObject(t)){
throw new TypeError('Bad promise constructor')
}
var n=new r(t);
var o=n.reject;
o(e);
return n.promise
},
resolve:function resolve(e){
var t=this;
if(!te.TypeIsObject(t)){
throw new TypeError('Bad promise constructor')
}
if(te.IsPromise(e)){
var n=e.constructor;
if(n===t){
return e
}
}
var o=new r(t);
var i=o.resolve;
i(e);
return o.promise
}
});
b(T,{
'catch':function(e){
return this.then(null,e)
},
then:function then(e,t){
var n=this;
if(!te.IsPromise(n)){
throw new TypeError('not a promise')
}
var o=te.SpeciesConstructor(n,E);
var i;
var b=arguments.length>2&&arguments[2]===y;
if(b&&o===E){
i=y
}else{
i=new r(o)
}
var g=te.IsCallable(e)?e:a;
var d=te.IsCallable(t)?t:u;
var O=n._promise;
var m;
if(O.state===f){
if(O.reactionLength===0){
O.fulfillReactionHandler0=g;
O.rejectReactionHandler0=d;
O.reactionCapability0=i
}else{
var w=3*(O.reactionLength-1);
O[w+l]=g;
O[w+p]=d;
O[w+v]=i
}
O.reactionLength+=1
}else if(O.state===s){
m=O.result;
h(g,i,m)
}else if(O.state===c){
m=O.result;
h(d,i,m)
}else{
throw new TypeError('unexpected Promise state')
}
return i.promise
}
});
y=new r(E);
I=T.then;
return E
}();
if(S.Promise){
delete S.Promise.accept;
delete S.Promise.defer;
delete S.Promise.prototype.chain
}
if(typeof Er==='function'){
b(S,{Promise:Er});
var Pr=w(S.Promise,function(e){
return e.resolve(42).then(function(){
})instanceof e
});
var Mr=!i(function(){
S.Promise.reject(42).then(null,5).then(null,G)
});
var Cr=i(function(){
S.Promise.call(3,G)
});
var xr=function(e){
var t=e.resolve(5);
t.constructor={};
var r=e.resolve(t);
try{
r.then(null,G).then(null,G)
}catch(n){
return true
}
return t===r
}(S.Promise);
var Nr=s&&function(){
var e=0;
var t=Object.defineProperty({},'then',{
get:function(){
e+=1
}
});
Promise.resolve(t);
return e===1
}();
var Ar=function BadResolverPromise(e){
var t=new Promise(e);
e(3,function(){
});
this.then=t.then;
this.constructor=BadResolverPromise
};
Ar.prototype=Promise.prototype;
Ar.all=Promise.all;
var Rr=a(function(){
return!!Ar.all([
1,
2
])
});
if(!Pr||!Mr||!Cr||xr||!Nr||Rr){
Promise=Er;
X(S,'Promise',Er)
}
if(Promise.all.length!==1){
var _r=Promise.all;
X(Promise,'all',function all(e){
return te.Call(_r,this,arguments)
})
}
if(Promise.race.length!==1){
var kr=Promise.race;
X(Promise,'race',function race(e){
return te.Call(kr,this,arguments)
})
}
if(Promise.resolve.length!==1){
var Fr=Promise.resolve;
X(Promise,'resolve',function resolve(e){
return te.Call(Fr,this,arguments)
})
}
if(Promise.reject.length!==1){
var Lr=Promise.reject;
X(Promise,'reject',function reject(e){
return te.Call(Lr,this,arguments)
})
}
jt(Promise,'all');
jt(Promise,'race');
jt(Promise,'resolve');
jt(Promise,'reject');
Oe(Promise)
}
var Dr=function(e){
var t=n(p(e,function(e,t){
e[t]=true;
return e
},{}));
return e.join(':')===t.join(':')
};
var zr=Dr([
'z',
'a',
'bb'
]);
var qr=Dr([
'z',
1,
'a',
'3',
2
]);
if(s){
var Gr=function fastkey(e){
if(!zr){
return null
}
if(typeof e==='undefined'||e===null){
return'^'+te.ToString(e)
}else if(typeof e==='string'){
return'$'+e
}else if(typeof e==='number'){
if(!qr){
return'n'+e
}
return e
}else if(typeof e==='boolean'){
return'b'+e
}
return null
};
var Wr=function emptyObject(){
return Object.create?Object.create(null):{}
};
var Hr=function addIterableToMap(e,n,o){
if(r(o)||K.string(o)){
l(o,function(e){
if(!te.TypeIsObject(e)){
throw new TypeError('Iterator value '+e+' is not an entry object')
}
n.set(e[0],e[1])
})
}else if(o instanceof e){
t(e.prototype.forEach,o,function(e,t){
n.set(t,e)
})
}else{
var i,a;
if(o!==null&&typeof o!=='undefined'){
a=n.set;
if(!te.IsCallable(a)){
throw new TypeError('bad map')
}
i=te.GetIterator(o)
}
if(typeof i!=='undefined'){
while(true){
var u=te.IteratorStep(i);
if(u===false){
break
}
var f=u.value;
try{
if(!te.TypeIsObject(f)){
throw new TypeError('Iterator value '+f+' is not an entry object')
}
t(a,n,f[0],f[1])
}catch(s){
te.IteratorClose(i,true);
throw s
}
}
}
}
};
var Vr=function addIterableToSet(e,n,o){
if(r(o)||K.string(o)){
l(o,function(e){
n.add(e)
})
}else if(o instanceof e){
t(e.prototype.forEach,o,function(e){
n.add(e)
})
}else{
var i,a;
if(o!==null&&typeof o!=='undefined'){
a=n.add;
if(!te.IsCallable(a)){
throw new TypeError('bad set')
}
i=te.GetIterator(o)
}
if(typeof i!=='undefined'){
while(true){
var u=te.IteratorStep(i);
if(u===false){
break
}
var f=u.value;
try{
t(a,n,f)
}catch(s){
te.IteratorClose(i,true);
throw s
}
}
}
}
};
var Br={
Map:function(){
var e={};
var r=function MapEntry(e,t){
this.key=e;
this.value=t;
this.next=null;
this.prev=null
};
r.prototype.isRemoved=function isRemoved(){
return this.key===e
};
var n=function isMap(e){
return!!e._es6map
};
var o=function requireMapSlot(e,t){
if(!te.TypeIsObject(e)||!n(e)){
throw new TypeError('Method Map.prototype.'+t+' called on incompatible receiver '+te.ToString(e))
}
};
var i=function MapIterator(e,t){
o(e,'[[MapIterator]]');
this.head=e._head;
this.i=this.head;
this.kind=t
};
i.prototype={
next:function next(){
var e=this.i,t=this.kind,r=this.head,n;
if(typeof this.i==='undefined'){
return{
value:void 0,
done:true
}
}
while(e.isRemoved()&&e!==r){
e=e.prev
}
while(e.next!==r){
e=e.next;
if(!e.isRemoved()){
if(t==='key'){
n=e.key
}else if(t==='value'){
n=e.value
}else{
n=[
e.key,
e.value
]
}
this.i=e;
return{
value:n,
done:false
}
}
}
this.i=void 0;
return{
value:void 0,
done:true
}
}
};
me(i.prototype);
var a;
var u=function Map(){
if(!(this instanceof Map)){
throw new TypeError('Constructor Map requires "new"')
}
if(this&&this._es6map){
throw new TypeError('Bad construction')
}
var e=Se(this,Map,a,{
_es6map:true,
_head:null,
_storage:Wr(),
_size:0
});
var t=new r(null,null);
t.next=t.prev=t;
e._head=t;
if(arguments.length>0){
Hr(Map,e,arguments[0])
}
return e
};
a=u.prototype;
O.getter(a,'size',function(){
if(typeof this._size==='undefined'){
throw new TypeError('size method called on incompatible Map')
}
return this._size
});
b(a,{
get:function get(e){
o(this,'get');
var t=Gr(e);
if(t!==null){
var r=this._storage[t];
if(r){
return r.value
}else{
return
}
}
var n=this._head,i=n;
while((i=i.next)!==n){
if(te.SameValueZero(i.key,e)){
return i.value
}
}
},
has:function has(e){
o(this,'has');
var t=Gr(e);
if(t!==null){
return typeof this._storage[t]!=='undefined'
}
var r=this._head,n=r;
while((n=n.next)!==r){
if(te.SameValueZero(n.key,e)){
return true
}
}
return false
},
set:function set(e,t){
o(this,'set');
var n=this._head,i=n,a;
var u=Gr(e);
if(u!==null){
if(typeof this._storage[u]!=='undefined'){
this._storage[u].value=t;
return this
}else{
a=this._storage[u]=new r(e,t);
i=n.prev
}
}
while((i=i.next)!==n){
if(te.SameValueZero(i.key,e)){
i.value=t;
return this
}
}
a=a||new r(e,t);
if(te.SameValue(-0,e)){
a.key=+0
}
a.next=this._head;
a.prev=this._head.prev;
a.prev.next=a;
a.next.prev=a;
this._size+=1;
return this
},
'delete':function(t){
o(this,'delete');
var r=this._head,n=r;
var i=Gr(t);
if(i!==null){
if(typeof this._storage[i]==='undefined'){
return false
}
n=this._storage[i].prev;
delete this._storage[i]
}
while((n=n.next)!==r){
if(te.SameValueZero(n.key,t)){
n.key=n.value=e;
n.prev.next=n.next;
n.next.prev=n.prev;
this._size-=1;
return true
}
}
return false
},
clear:function clear(){
o(this,'clear');
this._size=0;
this._storage=Wr();
var t=this._head,r=t,n=r.next;
while((r=n)!==t){
r.key=r.value=e;
n=r.next;
r.next=r.prev=t
}
t.next=t.prev=t
},
keys:function keys(){
o(this,'keys');
return new i(this,'key')
},
values:function values(){
o(this,'values');
return new i(this,'value')
},
entries:function entries(){
o(this,'entries');
return new i(this,'key+value')
},
forEach:function forEach(e){
o(this,'forEach');
var r=arguments.length>1?arguments[1]:null;
var n=this.entries();
for(var i=n.next();!i.done;i=n.next()){
if(r){
t(e,r,i.value[1],i.value[0],this)
}else{
e(i.value[1],i.value[0],this)
}
}
}
});
me(a,a.entries);
return u
}(),
Set:function(){
var e=function isSet(e){
return e._es6set&&typeof e._storage!=='undefined'
};
var r=function requireSetSlot(t,r){
if(!te.TypeIsObject(t)||!e(t)){
throw new TypeError('Set.prototype.'+r+' called on incompatible receiver '+te.ToString(t))
}
};
var o;
var i=function Set(){
if(!(this instanceof Set)){
throw new TypeError('Constructor Set requires "new"')
}
if(this&&this._es6set){
throw new TypeError('Bad construction')
}
var e=Se(this,Set,o,{
_es6set:true,
'[[SetData]]':null,
_storage:Wr()
});
if(!e._es6set){
throw new TypeError('bad set')
}
if(arguments.length>0){
Vr(Set,e,arguments[0])
}
return e
};
o=i.prototype;
var a=function(e){
var t=e;
if(t==='^null'){
return null
}else if(t==='^undefined'){
return void 0
}else{
var r=t.charAt(0);
if(r==='$'){
return C(t,1)
}else if(r==='n'){
return+C(t,1)
}else if(r==='b'){
return t==='btrue'
}
}
return+t
};
var u=function ensureMap(e){
if(!e['[[SetData]]']){
var t=e['[[SetData]]']=new Br.Map;
l(n(e._storage),function(e){
var r=a(e);
t.set(r,r)
});
e['[[SetData]]']=t
}
e._storage=null
};
O.getter(i.prototype,'size',function(){
r(this,'size');
if(this._storage){
return n(this._storage).length
}
u(this);
return this['[[SetData]]'].size
});
b(i.prototype,{
has:function has(e){
r(this,'has');
var t;
if(this._storage&&(t=Gr(e))!==null){
return!!this._storage[t]
}
u(this);
return this['[[SetData]]'].has(e)
},
add:function add(e){
r(this,'add');
var t;
if(this._storage&&(t=Gr(e))!==null){
this._storage[t]=true;
return this
}
u(this);
this['[[SetData]]'].set(e,e);
return this
},
'delete':function(e){
r(this,'delete');
var t;
if(this._storage&&(t=Gr(e))!==null){
var n=z(this._storage,t);
return delete this._storage[t]&&n
}
u(this);
return this['[[SetData]]']['delete'](e)
},
clear:function clear(){
r(this,'clear');
if(this._storage){
this._storage=Wr()
}
if(this['[[SetData]]']){
this['[[SetData]]'].clear()
}
},
values:function values(){
r(this,'values');
u(this);
return this['[[SetData]]'].values()
},
entries:function entries(){
r(this,'entries');
u(this);
return this['[[SetData]]'].entries()
},
forEach:function forEach(e){
r(this,'forEach');
var n=arguments.length>1?arguments[1]:null;
var o=this;
u(o);
this['[[SetData]]'].forEach(function(r,i){
if(n){
t(e,n,i,i,o)
}else{
e(i,i,o)
}
})
}
});
h(i.prototype,'keys',i.prototype.values,true);
me(i.prototype,i.prototype.values);
return i
}()
};
if(S.Map||S.Set){
var $r=a(function(){
return new Map([[
1,
2
]]).get(1)===2
});
if(!$r){
var Ur=S.Map;
S.Map=function Map(){
if(!(this instanceof Map)){
throw new TypeError('Constructor Map requires "new"')
}
var e=new Ur;
if(arguments.length>0){
Hr(Map,e,arguments[0])
}
delete e.constructor;
Object.setPrototypeOf(e,S.Map.prototype);
return e
};
S.Map.prototype=m(Ur.prototype);
h(S.Map.prototype,'constructor',S.Map,true);
O.preserveToString(S.Map,Ur)
}
var Jr=new Map;
var Kr=function(){
var e=new Map([
[
1,
0
],
[
2,
0
],
[
3,
0
],
[
4,
0
]
]);
e.set(-0,e);
return e.get(0)===e&&e.get(-0)===e&&e.has(0)&&e.has(-0)
}();
var Xr=Jr.set(1,2)===Jr;
if(!Kr||!Xr){
var Zr=Map.prototype.set;
X(Map.prototype,'set',function set(e,r){
t(Zr,this,e===0?0:e,r);
return this
})
}
if(!Kr){
var Yr=Map.prototype.get;
var Qr=Map.prototype.has;
b(Map.prototype,{
get:function get(e){
return t(Yr,this,e===0?0:e)
},
has:function has(e){
return t(Qr,this,e===0?0:e)
}
},true);
O.preserveToString(Map.prototype.get,Yr);
O.preserveToString(Map.prototype.has,Qr)
}
var en=new Set;
var tn=function(e){
e['delete'](0);
e.add(-0);
return!e.has(0)
}(en);
var rn=en.add(1)===en;
if(!tn||!rn){
var nn=Set.prototype.add;
Set.prototype.add=function add(e){
t(nn,this,e===0?0:e);
return this
};
O.preserveToString(Set.prototype.add,nn)
}
if(!tn){
var on=Set.prototype.has;
Set.prototype.has=function has(e){
return t(on,this,e===0?0:e)
};
O.preserveToString(Set.prototype.has,on);
var an=Set.prototype['delete'];
Set.prototype['delete']=function SetDelete(e){
return t(an,this,e===0?0:e)
};
O.preserveToString(Set.prototype['delete'],an)
}
var un=w(S.Map,function(e){
var t=new e([]);
t.set(42,42);
return t instanceof e
});
var fn=Object.setPrototypeOf&&!un;
var sn=function(){
try{
return!(S.Map()instanceof S.Map)
}catch(e){
return e instanceof TypeError
}
}();
if(S.Map.length!==0||fn||!sn){
var cn=S.Map;
S.Map=function Map(){
if(!(this instanceof Map)){
throw new TypeError('Constructor Map requires "new"')
}
var e=new cn;
if(arguments.length>0){
Hr(Map,e,arguments[0])
}
delete e.constructor;
Object.setPrototypeOf(e,Map.prototype);
return e
};
S.Map.prototype=cn.prototype;
h(S.Map.prototype,'constructor',S.Map,true);
O.preserveToString(S.Map,cn)
}
var ln=w(S.Set,function(e){
var t=new e([]);
t.add(42,42);
return t instanceof e
});
var pn=Object.setPrototypeOf&&!ln;
var vn=function(){
try{
return!(S.Set()instanceof S.Set)
}catch(e){
return e instanceof TypeError
}
}();
if(S.Set.length!==0||pn||!vn){
var yn=S.Set;
S.Set=function Set(){
if(!(this instanceof Set)){
throw new TypeError('Constructor Set requires "new"')
}
var e=new yn;
if(arguments.length>0){
Vr(Set,e,arguments[0])
}
delete e.constructor;
Object.setPrototypeOf(e,Set.prototype);
return e
};
S.Set.prototype=yn.prototype;
h(S.Set.prototype,'constructor',S.Set,true);
O.preserveToString(S.Set,yn)
}
var hn=!a(function(){
return new Map().keys().next().done
});
if(typeof S.Map.prototype.clear!=='function'||new S.Set().size!==0||new S.Map().size!==0||typeof S.Map.prototype.keys!=='function'||typeof S.Set.prototype.keys!=='function'||typeof S.Map.prototype.forEach!=='function'||typeof S.Set.prototype.forEach!=='function'||u(S.Map)||u(S.Set)||typeof new S.Map().keys().next!=='function'||hn||!un){
b(S,{
Map:Br.Map,
Set:Br.Set
},true)
}
if(S.Set.prototype.keys!==S.Set.prototype.values){
h(S.Set.prototype,'keys',S.Set.prototype.values,true)
}
me(Object.getPrototypeOf(new S.Map().keys()));
me(Object.getPrototypeOf(new S.Set().keys()));
if(c&&S.Set.prototype.has.name!=='has'){
var bn=S.Set.prototype.has;
X(S.Set.prototype,'has',function has(e){
return t(bn,this,e)
})
}
}
b(S,Br);
Oe(S.Map);
Oe(S.Set)
}
var gn=function throwUnlessTargetIsObject(e){
if(!te.TypeIsObject(e)){
throw new TypeError('target must be an object')
}
};
var dn={
apply:function apply(){
return te.Call(te.Call,null,arguments)
},
construct:function construct(e,t){
if(!te.IsConstructor(e)){
throw new TypeError('First argument must be a constructor.')
}
var r=arguments.length>2?arguments[2]:e;
if(!te.IsConstructor(r)){
throw new TypeError('new.target must be a constructor.')
}
return te.Construct(e,t,r,'internal')
},
deleteProperty:function deleteProperty(e,t){
gn(e);
if(s){
var r=Object.getOwnPropertyDescriptor(e,t);
if(r&&!r.configurable){
return false
}
}
return delete e[t]
},
has:function has(e,t){
gn(e);
return t in e
}
};
if(Object.getOwnPropertyNames){
Object.assign(dn,{
ownKeys:function ownKeys(e){
gn(e);
var t=Object.getOwnPropertyNames(e);
if(te.IsCallable(Object.getOwnPropertySymbols)){
N(t,Object.getOwnPropertySymbols(e))
}
return t
}
})
}
var On=function ConvertExceptionToBoolean(e){
return!i(e)
};
if(Object.preventExtensions){
Object.assign(dn,{
isExtensible:function isExtensible(e){
gn(e);
return Object.isExtensible(e)
},
preventExtensions:function preventExtensions(e){
gn(e);
return On(function(){
Object.preventExtensions(e)
})
}
})
}
if(s){
var mn=function get(e,t,r){
var n=Object.getOwnPropertyDescriptor(e,t);
if(!n){
var o=Object.getPrototypeOf(e);
if(o===null){
return void 0
}
return mn(o,t,r)
}
if('value'in n){
return n.value
}
if(n.get){
return te.Call(n.get,r)
}
return void 0
};
var wn=function set(e,r,n,o){
var i=Object.getOwnPropertyDescriptor(e,r);
if(!i){
var a=Object.getPrototypeOf(e);
if(a!==null){
return wn(a,r,n,o)
}
i={
value:void 0,
writable:true,
enumerable:true,
configurable:true
}
}
if('value'in i){
if(!i.writable){
return false
}
if(!te.TypeIsObject(o)){
return false
}
var u=Object.getOwnPropertyDescriptor(o,r);
if(u){
return Q.defineProperty(o,r,{value:n})
}else{
return Q.defineProperty(o,r,{
value:n,
writable:true,
enumerable:true,
configurable:true
})
}
}
if(i.set){
t(i.set,o,n);
return true
}
return false
};
Object.assign(dn,{
defineProperty:function defineProperty(e,t,r){
gn(e);
return On(function(){
Object.defineProperty(e,t,r)
})
},
getOwnPropertyDescriptor:function getOwnPropertyDescriptor(e,t){
gn(e);
return Object.getOwnPropertyDescriptor(e,t)
},
get:function get(e,t){
gn(e);
var r=arguments.length>2?arguments[2]:e;
return mn(e,t,r)
},
set:function set(e,t,r){
gn(e);
var n=arguments.length>3?arguments[3]:e;
return wn(e,t,r,n)
}
})
}
if(Object.getPrototypeOf){
var jn=Object.getPrototypeOf;
dn.getPrototypeOf=function getPrototypeOf(e){
gn(e);
return jn(e)
}
}
if(Object.setPrototypeOf&&dn.getPrototypeOf){
var Sn=function(e,t){
var r=t;
while(r){
if(e===r){
return true
}
r=dn.getPrototypeOf(r)
}
return false
};
Object.assign(dn,{
setPrototypeOf:function setPrototypeOf(e,t){
gn(e);
if(t!==null&&!te.TypeIsObject(t)){
throw new TypeError('proto must be an object or null')
}
if(t===Q.getPrototypeOf(e)){
return true
}
if(Q.isExtensible&&!Q.isExtensible(e)){
return false
}
if(Sn(e,t)){
return false
}
Object.setPrototypeOf(e,t);
return true
}
})
}
var Tn=function(e,t){
if(!te.IsCallable(S.Reflect[e])){
h(S.Reflect,e,t)
}else{
var r=a(function(){
S.Reflect[e](1);
S.Reflect[e](NaN);
S.Reflect[e](true);
return true
});
if(r){
X(S.Reflect,e,t)
}
}
};
Object.keys(dn).forEach(function(e){
Tn(e,dn[e])
});
var In=S.Reflect.getPrototypeOf;
if(c&&In&&In.name!=='getPrototypeOf'){
X(S.Reflect,'getPrototypeOf',function getPrototypeOf(e){
return t(In,S.Reflect,e)
})
}
if(S.Reflect.setPrototypeOf){
if(a(function(){
S.Reflect.setPrototypeOf(1,{});
return true
})){
X(S.Reflect,'setPrototypeOf',dn.setPrototypeOf)
}
}
if(S.Reflect.defineProperty){
if(!a(function(){
var e=!S.Reflect.defineProperty(1,'test',{value:1});
var t=typeof Object.preventExtensions!=='function'||!S.Reflect.defineProperty(Object.preventExtensions({}),'test',{});
return e&&t
})){
X(S.Reflect,'defineProperty',dn.defineProperty)
}
}
if(S.Reflect.construct){
if(!a(function(){
var e=function F(){
};
return S.Reflect.construct(function(){
},[],e)instanceof e
})){
X(S.Reflect,'construct',dn.construct)
}
}
if(String(new Date(NaN))!=='Invalid Date'){
var En=Date.prototype.toString;
var Pn=function toString(){
var e=+this;
if(e!==e){
return'Invalid Date'
}
return te.Call(En,this)
};
X(Date.prototype,'toString',Pn)
}
var Mn={
anchor:function anchor(e){
return te.CreateHTML(this,'a','name',e)
},
big:function big(){
return te.CreateHTML(this,'big','','')
},
blink:function blink(){
return te.CreateHTML(this,'blink','','')
},
bold:function bold(){
return te.CreateHTML(this,'b','','')
},
fixed:function fixed(){
return te.CreateHTML(this,'tt','','')
},
fontcolor:function fontcolor(e){
return te.CreateHTML(this,'font','color',e)
},
fontsize:function fontsize(e){
return te.CreateHTML(this,'font','size',e)
},
italics:function italics(){
return te.CreateHTML(this,'i','','')
},
link:function link(e){
return te.CreateHTML(this,'a','href',e)
},
small:function small(){
return te.CreateHTML(this,'small','','')
},
strike:function strike(){
return te.CreateHTML(this,'strike','','')
},
sub:function sub(){
return te.CreateHTML(this,'sub','','')
},
sup:function sub(){
return te.CreateHTML(this,'sup','','')
}
};
l(Object.keys(Mn),function(e){
var r=String.prototype[e];
var n=false;
if(te.IsCallable(r)){
var o=t(r,'',' " ');
var i=P([],o.match(/"/g)).length;
n=o!==o.toLowerCase()||i>2
}else{
n=true
}
if(n){
X(String.prototype,e,Mn[e])
}
});
var Cn=function(){
if(!Z){
return false
}
var e=typeof JSON==='object'&&typeof JSON.stringify==='function'?JSON.stringify:null;
if(!e){
return false
}
if(typeof e(W())!=='undefined'){
return true
}
if(e([W()])!=='[null]'){
return true
}
var t={a:W()};
t[W()]=true;
if(e(t)!=='{}'){
return true
}
return false
}();
var xn=a(function(){
if(!Z){
return true
}
return JSON.stringify(Object(W()))==='{}'&&JSON.stringify([Object(W())])==='[{}]'
});
if(Cn||!xn){
var Nn=JSON.stringify;
X(JSON,'stringify',function stringify(e){
if(typeof e==='symbol'){
return
}
var n;
if(arguments.length>1){
n=arguments[1]
}
var o=[e];
if(!r(n)){
var i=te.IsCallable(n)?n:null;
var a=function(e,r){
var n=i?t(i,this,e,r):r;
if(typeof n!=='symbol'){
if(K.symbol(n)){
return Tt({})(n)
}else{
return n
}
}
};
o.push(a)
}else{
o.push(n)
}
if(arguments.length>2){
o.push(arguments[2])
}
return Nn.apply(this,o)
})
}
return S
}));
/*!
 * async
 * https://github.com/caolan/async
 *
 * Copyright 2010-2014 Caolan McMahon
 * Released under the MIT license
 */
(function(){
var async={};
var root,previous_async;
root=this;
if(root!=null){
previous_async=root.async
}
async.noConflict=function(){
root.async=previous_async;
return async
};
function only_once(fn){
var called=false;
return function(){
if(called)
throw new Error('Callback was already called.');
called=true;
fn.apply(root,arguments)
}
}
var _toString=Object.prototype.toString;
var _isArray=Array.isArray||function(obj){
return _toString.call(obj)==='[object Array]'
};
var _each=function(arr,iterator){
if(arr.forEach){
return arr.forEach(iterator)
}
for(var i=0;i<arr.length;i+=1){
iterator(arr[i],i,arr)
}
};
var _map=function(arr,iterator){
if(arr.map){
return arr.map(iterator)
}
var results=[];
_each(arr,function(x,i,a){
results.push(iterator(x,i,a))
});
return results
};
var _reduce=function(arr,iterator,memo){
if(arr.reduce){
return arr.reduce(iterator,memo)
}
_each(arr,function(x,i,a){
memo=iterator(memo,x,i,a)
});
return memo
};
var _keys=function(obj){
if(Object.keys){
return Object.keys(obj)
}
var keys=[];
for(var k in obj){
if(obj.hasOwnProperty(k)){
keys.push(k)
}
}
return keys
};
if(typeof process==='undefined'||!process.nextTick){
if(typeof setImmediate==='function'){
async.nextTick=function(fn){
setImmediate(fn)
};
async.setImmediate=async.nextTick
}else{
async.nextTick=function(fn){
setTimeout(fn,0)
};
async.setImmediate=async.nextTick
}
}else{
async.nextTick=process.nextTick;
if(typeof setImmediate!=='undefined'){
async.setImmediate=function(fn){
setImmediate(fn)
}
}else{
async.setImmediate=async.nextTick
}
}
async.each=function(arr,iterator,callback){
callback=callback||function(){
};
if(!arr.length){
return callback()
}
var completed=0;
_each(arr,function(x){
iterator(x,only_once(done))
});
function done(err){
if(err){
callback(err);
callback=function(){
}
}else{
completed+=1;
if(completed>=arr.length){
callback()
}
}
}
};
async.forEach=async.each;
async.eachSeries=function(arr,iterator,callback){
callback=callback||function(){
};
if(!arr.length){
return callback()
}
var completed=0;
var iterate=function(){
iterator(arr[completed],function(err){
if(err){
callback(err);
callback=function(){
}
}else{
completed+=1;
if(completed>=arr.length){
callback()
}else{
iterate()
}
}
})
};
iterate()
};
async.forEachSeries=async.eachSeries;
async.eachLimit=function(arr,limit,iterator,callback){
var fn=_eachLimit(limit);
fn.apply(null,[
arr,
iterator,
callback
])
};
async.forEachLimit=async.eachLimit;
var _eachLimit=function(limit){
return function(arr,iterator,callback){
callback=callback||function(){
};
if(!arr.length||limit<=0){
return callback()
}
var completed=0;
var started=0;
var running=0;
(function replenish(){
if(completed>=arr.length){
return callback()
}
while(running<limit&&started<arr.length){
started+=1;
running+=1;
iterator(arr[started-1],function(err){
if(err){
callback(err);
callback=function(){
}
}else{
completed+=1;
running-=1;
if(completed>=arr.length){
callback()
}else{
replenish()
}
}
})
}
}())
}
};
var doParallel=function(fn){
return function(){
var args=Array.prototype.slice.call(arguments);
return fn.apply(null,[async.each].concat(args))
}
};
var doParallelLimit=function(limit,fn){
return function(){
var args=Array.prototype.slice.call(arguments);
return fn.apply(null,[_eachLimit(limit)].concat(args))
}
};
var doSeries=function(fn){
return function(){
var args=Array.prototype.slice.call(arguments);
return fn.apply(null,[async.eachSeries].concat(args))
}
};
var _asyncMap=function(eachfn,arr,iterator,callback){
arr=_map(arr,function(x,i){
return{
index:i,
value:x
}
});
if(!callback){
eachfn(arr,function(x,callback){
iterator(x.value,function(err){
callback(err)
})
})
}else{
var results=[];
eachfn(arr,function(x,callback){
iterator(x.value,function(err,v){
results[x.index]=v;
callback(err)
})
},function(err){
callback(err,results)
})
}
};
async.map=doParallel(_asyncMap);
async.mapSeries=doSeries(_asyncMap);
async.mapLimit=function(arr,limit,iterator,callback){
return _mapLimit(limit)(arr,iterator,callback)
};
var _mapLimit=function(limit){
return doParallelLimit(limit,_asyncMap)
};
async.reduce=function(arr,memo,iterator,callback){
async.eachSeries(arr,function(x,callback){
iterator(memo,x,function(err,v){
memo=v;
callback(err)
})
},function(err){
callback(err,memo)
})
};
async.inject=async.reduce;
async.foldl=async.reduce;
async.reduceRight=function(arr,memo,iterator,callback){
var reversed=_map(arr,function(x){
return x
}).reverse();
async.reduce(reversed,memo,iterator,callback)
};
async.foldr=async.reduceRight;
var _filter=function(eachfn,arr,iterator,callback){
var results=[];
arr=_map(arr,function(x,i){
return{
index:i,
value:x
}
});
eachfn(arr,function(x,callback){
iterator(x.value,function(v){
if(v){
results.push(x)
}
callback()
})
},function(err){
callback(_map(results.sort(function(a,b){
return a.index-b.index
}),function(x){
return x.value
}))
})
};
async.filter=doParallel(_filter);
async.filterSeries=doSeries(_filter);
async.select=async.filter;
async.selectSeries=async.filterSeries;
var _reject=function(eachfn,arr,iterator,callback){
var results=[];
arr=_map(arr,function(x,i){
return{
index:i,
value:x
}
});
eachfn(arr,function(x,callback){
iterator(x.value,function(v){
if(!v){
results.push(x)
}
callback()
})
},function(err){
callback(_map(results.sort(function(a,b){
return a.index-b.index
}),function(x){
return x.value
}))
})
};
async.reject=doParallel(_reject);
async.rejectSeries=doSeries(_reject);
var _detect=function(eachfn,arr,iterator,main_callback){
eachfn(arr,function(x,callback){
iterator(x,function(result){
if(result){
main_callback(x);
main_callback=function(){
}
}else{
callback()
}
})
},function(err){
main_callback()
})
};
async.detect=doParallel(_detect);
async.detectSeries=doSeries(_detect);
async.some=function(arr,iterator,main_callback){
async.each(arr,function(x,callback){
iterator(x,function(v){
if(v){
main_callback(true);
main_callback=function(){
}
}
callback()
})
},function(err){
main_callback(false)
})
};
async.any=async.some;
async.every=function(arr,iterator,main_callback){
async.each(arr,function(x,callback){
iterator(x,function(v){
if(!v){
main_callback(false);
main_callback=function(){
}
}
callback()
})
},function(err){
main_callback(true)
})
};
async.all=async.every;
async.sortBy=function(arr,iterator,callback){
async.map(arr,function(x,callback){
iterator(x,function(err,criteria){
if(err){
callback(err)
}else{
callback(null,{
value:x,
criteria:criteria
})
}
})
},function(err,results){
if(err){
return callback(err)
}else{
var fn=function(left,right){
var a=left.criteria,b=right.criteria;
return a<b?-1:a>b?1:0
};
callback(null,_map(results.sort(fn),function(x){
return x.value
}))
}
})
};
async.auto=function(tasks,callback){
callback=callback||function(){
};
var keys=_keys(tasks);
var remainingTasks=keys.length;
if(!remainingTasks){
return callback()
}
var results={};
var listeners=[];
var addListener=function(fn){
listeners.unshift(fn)
};
var removeListener=function(fn){
for(var i=0;i<listeners.length;i+=1){
if(listeners[i]===fn){
listeners.splice(i,1);
return
}
}
};
var taskComplete=function(){
remainingTasks--;
_each(listeners.slice(0),function(fn){
fn()
})
};
addListener(function(){
if(!remainingTasks){
var theCallback=callback;
callback=function(){
};
theCallback(null,results)
}
});
_each(keys,function(k){
var task=_isArray(tasks[k])?tasks[k]:[tasks[k]];
var taskCallback=function(err){
var args=Array.prototype.slice.call(arguments,1);
if(args.length<=1){
args=args[0]
}
if(err){
var safeResults={};
_each(_keys(results),function(rkey){
safeResults[rkey]=results[rkey]
});
safeResults[k]=args;
callback(err,safeResults);
callback=function(){
}
}else{
results[k]=args;
async.setImmediate(taskComplete)
}
};
var requires=task.slice(0,Math.abs(task.length-1))||[];
var ready=function(){
return _reduce(requires,function(a,x){
return a&&results.hasOwnProperty(x)
},true)&&!results.hasOwnProperty(k)
};
if(ready()){
task[task.length-1](taskCallback,results)
}else{
var listener=function(){
if(ready()){
removeListener(listener);
task[task.length-1](taskCallback,results)
}
};
addListener(listener)
}
})
};
async.retry=function(times,task,callback){
var DEFAULT_TIMES=5;
var attempts=[];
if(typeof times==='function'){
callback=task;
task=times;
times=DEFAULT_TIMES
}
times=parseInt(times,10)||DEFAULT_TIMES;
var wrappedTask=function(wrappedCallback,wrappedResults){
var retryAttempt=function(task,finalAttempt){
return function(seriesCallback){
task(function(err,result){
seriesCallback(!err||finalAttempt,{
err:err,
result:result
})
},wrappedResults)
}
};
while(times){
attempts.push(retryAttempt(task,!(times-=1)))
}
async.series(attempts,function(done,data){
data=data[data.length-1];
(wrappedCallback||callback)(data.err,data.result)
})
};
return callback?wrappedTask():wrappedTask
};
async.waterfall=function(tasks,callback){
callback=callback||function(){
};
if(!_isArray(tasks)){
var err=new Error('First argument to waterfall must be an array of functions');
return callback(err)
}
if(!tasks.length){
return callback()
}
var wrapIterator=function(iterator){
return function(err){
if(err){
callback.apply(null,arguments);
callback=function(){
}
}else{
var args=Array.prototype.slice.call(arguments,1);
var next=iterator.next();
if(next){
args.push(wrapIterator(next))
}else{
args.push(callback)
}
async.setImmediate(function(){
iterator.apply(null,args)
})
}
}
};
wrapIterator(async.iterator(tasks))()
};
var _parallel=function(eachfn,tasks,callback){
callback=callback||function(){
};
if(_isArray(tasks)){
eachfn.map(tasks,function(fn,callback){
if(fn){
fn(function(err){
var args=Array.prototype.slice.call(arguments,1);
if(args.length<=1){
args=args[0]
}
callback.call(null,err,args)
})
}
},callback)
}else{
var results={};
eachfn.each(_keys(tasks),function(k,callback){
tasks[k](function(err){
var args=Array.prototype.slice.call(arguments,1);
if(args.length<=1){
args=args[0]
}
results[k]=args;
callback(err)
})
},function(err){
callback(err,results)
})
}
};
async.parallel=function(tasks,callback){
_parallel({
map:async.map,
each:async.each
},tasks,callback)
};
async.parallelLimit=function(tasks,limit,callback){
_parallel({
map:_mapLimit(limit),
each:_eachLimit(limit)
},tasks,callback)
};
async.series=function(tasks,callback){
callback=callback||function(){
};
if(_isArray(tasks)){
async.mapSeries(tasks,function(fn,callback){
if(fn){
fn(function(err){
var args=Array.prototype.slice.call(arguments,1);
if(args.length<=1){
args=args[0]
}
callback.call(null,err,args)
})
}
},callback)
}else{
var results={};
async.eachSeries(_keys(tasks),function(k,callback){
tasks[k](function(err){
var args=Array.prototype.slice.call(arguments,1);
if(args.length<=1){
args=args[0]
}
results[k]=args;
callback(err)
})
},function(err){
callback(err,results)
})
}
};
async.iterator=function(tasks){
var makeCallback=function(index){
var fn=function(){
if(tasks.length){
tasks[index].apply(null,arguments)
}
return fn.next()
};
fn.next=function(){
return index<tasks.length-1?makeCallback(index+1):null
};
return fn
};
return makeCallback(0)
};
async.apply=function(fn){
var args=Array.prototype.slice.call(arguments,1);
return function(){
return fn.apply(null,args.concat(Array.prototype.slice.call(arguments)))
}
};
var _concat=function(eachfn,arr,fn,callback){
var r=[];
eachfn(arr,function(x,cb){
fn(x,function(err,y){
r=r.concat(y||[]);
cb(err)
})
},function(err){
callback(err,r)
})
};
async.concat=doParallel(_concat);
async.concatSeries=doSeries(_concat);
async.whilst=function(test,iterator,callback){
if(test()){
iterator(function(err){
if(err){
return callback(err)
}
async.whilst(test,iterator,callback)
})
}else{
callback()
}
};
async.doWhilst=function(iterator,test,callback){
iterator(function(err){
if(err){
return callback(err)
}
var args=Array.prototype.slice.call(arguments,1);
if(test.apply(null,args)){
async.doWhilst(iterator,test,callback)
}else{
callback()
}
})
};
async.until=function(test,iterator,callback){
if(!test()){
iterator(function(err){
if(err){
return callback(err)
}
async.until(test,iterator,callback)
})
}else{
callback()
}
};
async.doUntil=function(iterator,test,callback){
iterator(function(err){
if(err){
return callback(err)
}
var args=Array.prototype.slice.call(arguments,1);
if(!test.apply(null,args)){
async.doUntil(iterator,test,callback)
}else{
callback()
}
})
};
async.queue=function(worker,concurrency){
if(concurrency===undefined){
concurrency=1
}
function _insert(q,data,pos,callback){
if(!q.started){
q.started=true
}
if(!_isArray(data)){
data=[data]
}
if(data.length==0){
return async.setImmediate(function(){
if(q.drain){
q.drain()
}
})
}
_each(data,function(task){
var item={
data:task,
callback:typeof callback==='function'?callback:null
};
if(pos){
q.tasks.unshift(item)
}else{
q.tasks.push(item)
}
if(q.saturated&&q.tasks.length===q.concurrency){
q.saturated()
}
async.setImmediate(q.process)
})
}
var workers=0;
var q={
tasks:[],
concurrency:concurrency,
saturated:null,
empty:null,
drain:null,
started:false,
paused:false,
push:function(data,callback){
_insert(q,data,false,callback)
},
kill:function(){
q.drain=null;
q.tasks=[]
},
unshift:function(data,callback){
_insert(q,data,true,callback)
},
process:function(){
if(!q.paused&&workers<q.concurrency&&q.tasks.length){
var task=q.tasks.shift();
if(q.empty&&q.tasks.length===0){
q.empty()
}
workers+=1;
var next=function(){
workers-=1;
if(task.callback){
task.callback.apply(task,arguments)
}
if(q.drain&&q.tasks.length+workers===0){
q.drain()
}
q.process()
};
var cb=only_once(next);
worker(task.data,cb)
}
},
length:function(){
return q.tasks.length
},
running:function(){
return workers
},
idle:function(){
return q.tasks.length+workers===0
},
pause:function(){
if(q.paused===true){
return
}
q.paused=true;
q.process()
},
resume:function(){
if(q.paused===false){
return
}
q.paused=false;
q.process()
}
};
return q
};
async.cargo=function(worker,payload){
var working=false,tasks=[];
var cargo={
tasks:tasks,
payload:payload,
saturated:null,
empty:null,
drain:null,
drained:true,
push:function(data,callback){
if(!_isArray(data)){
data=[data]
}
_each(data,function(task){
tasks.push({
data:task,
callback:typeof callback==='function'?callback:null
});
cargo.drained=false;
if(cargo.saturated&&tasks.length===payload){
cargo.saturated()
}
});
async.setImmediate(cargo.process)
},
process:function process(){
if(working)
return;
if(tasks.length===0){
if(cargo.drain&&!cargo.drained)
cargo.drain();
cargo.drained=true;
return
}
var ts=typeof payload==='number'?tasks.splice(0,payload):tasks.splice(0,tasks.length);
var ds=_map(ts,function(task){
return task.data
});
if(cargo.empty)
cargo.empty();
working=true;
worker(ds,function(){
working=false;
var args=arguments;
_each(ts,function(data){
if(data.callback){
data.callback.apply(null,args)
}
});
process()
})
},
length:function(){
return tasks.length
},
running:function(){
return working
}
};
return cargo
};
var _console_fn=function(name){
return function(fn){
var args=Array.prototype.slice.call(arguments,1);
fn.apply(null,args.concat([function(err){
var args=Array.prototype.slice.call(arguments,1);
if(typeof console!=='undefined'){
if(err){
if(console.error){
;
}
}else if(console[name]){
_each(args,function(x){
;
})
}
}
}]))
}
};
async.log=_console_fn('log');
async.dir=_console_fn('dir');
async.memoize=function(fn,hasher){
var memo={};
var queues={};
hasher=hasher||function(x){
return x
};
var memoized=function(){
var args=Array.prototype.slice.call(arguments);
var callback=args.pop();
var key=hasher.apply(null,args);
if(key in memo){
async.nextTick(function(){
callback.apply(null,memo[key])
})
}else if(key in queues){
queues[key].push(callback)
}else{
queues[key]=[callback];
fn.apply(null,args.concat([function(){
memo[key]=arguments;
var q=queues[key];
delete queues[key];
for(var i=0,l=q.length;i<l;i++){
q[i].apply(null,arguments)
}
}]))
}
};
memoized.memo=memo;
memoized.unmemoized=fn;
return memoized
};
async.unmemoize=function(fn){
return function(){
return(fn.unmemoized||fn).apply(null,arguments)
}
};
async.times=function(count,iterator,callback){
var counter=[];
for(var i=0;i<count;i++){
counter.push(i)
}
return async.map(counter,iterator,callback)
};
async.timesSeries=function(count,iterator,callback){
var counter=[];
for(var i=0;i<count;i++){
counter.push(i)
}
return async.mapSeries(counter,iterator,callback)
};
async.seq=function(){
var fns=arguments;
return function(){
var that=this;
var args=Array.prototype.slice.call(arguments);
var callback=args.pop();
async.reduce(fns,args,function(newargs,fn,cb){
fn.apply(that,newargs.concat([function(){
var err=arguments[0];
var nextargs=Array.prototype.slice.call(arguments,1);
cb(err,nextargs)
}]))
},function(err,results){
callback.apply(that,[err].concat(results))
})
}
};
async.compose=function(){
return async.seq.apply(null,Array.prototype.reverse.call(arguments))
};
var _applyEach=function(eachfn,fns){
var go=function(){
var that=this;
var args=Array.prototype.slice.call(arguments);
var callback=args.pop();
return eachfn(fns,function(fn,cb){
fn.apply(that,args.concat([cb]))
},callback)
};
if(arguments.length>2){
var args=Array.prototype.slice.call(arguments,2);
return go.apply(this,args)
}else{
return go
}
};
async.applyEach=doParallel(_applyEach);
async.applyEachSeries=doSeries(_applyEach);
async.forever=function(fn,callback){
function next(err){
if(err){
if(callback){
return callback(err)
}
throw err
}
fn(next)
}
next()
};
if(typeof module!=='undefined'&&module.exports){
module.exports=async
}else if(typeof define!=='undefined'&&define.amd){
define([],function(){
return async
})
}else{
root.async=async
}
}());
Ext.ns('web.dev');
web.dev.enableWebshop=function(){
one.viewport.application.panels.components.enableWebshop()
};
web.dev.import=function(){
var app=one.viewport.application;
app.request({
parent:app.site.getLink(app.getSelected('page').id),
type:'import'
})
};
web.dev.enableGlobalStyleFormTab=function(){
one.viewport.application.windows.windows['web.windows.GlobalStyles'].win.enableGlobalStyleFormTab()
};
web.dev.enableAddContactForm=function(){
web.dd.creators.ContactForm.prototype.enableAddContactForm()
};
web.dev.alertNote=function(){
var w=window,d=document,b=d.body,h=function(div){
div.style.display='none'
};
return function(msg,hideDelay){
var div=d.createElement('div');
div.innerHTML=[
'<div style="position:fixed;left:0;top:0;width:100%;text-align:center;height:0;z-index:2147483647">',
'<table style="display:inline-table;border-collapse:collapse;width:auto"><tr><td style="padding:0px;border:0">',
'<div style="border:1px solid #eb7;background-color:#f9edbe;margin:0 10px;padding:2px 10px;max-width:980px;overflow:hidden;text-align:left;font:bold 13px Arial">',
'<div style="clear:both">',
'<div style="float:left;color:#000;word-break:break-all;text-align:center;max-height:100px;overflow-y:auto;">',
msg,
'</div>',
'</div>',
'</div>',
'</td></tr></table>',
'</div>'
].join('');
div.style.display='';
b.appendChild(div);
w.setTimeout(function(){
h(div)
},hideDelay||5000)
}
}();
web.dev.allInOne=function(){
var cmpUnifiedBookmarklet=Ext.getCmp('unified-bookmarklet');
if(cmpUnifiedBookmarklet){
try{
cmpUnifiedBookmarklet.destroy()
}catch(e){
;
}
}
var app=(one.viewport||{}).application;
var dal=(app||{}).dal;
var domain=(dal||{}).domain;
var remembersLastPageId=function(){
if(dal&&dal.uiState.get('lastPageId')){
return true
}
return false
}();
var crashNotifications=function(){
if(localStorage['one-crash-notifications']==='true'){
return true
}
return false
}();
var allowOldAndNewWsbTogether=function(){
if(localStorage['allowOldAndNewWsbTogether']==='yes'){
return true
}
return false
}();
var backupsFeature=function(){
if(localStorage['backups-feature']==='enabled'){
return true
}
return false
}();
var getAllPageDataBtnEnabled=function(){
var enabled=false;
try{
enabled=!app.sidebar.getItem('sitemap').tree.pageMenu.getAllPageDataBtn.hidden
}catch(e){
}
return enabled
}();
var changeLanguageForTesting=function(targetLocale){
var sourceLocale=window.undefined;
window.LOCALEID=targetLocale;
if(sourceLocale==='en_us'||sourceLocale==='en_gb'){
sourceLocale='en'
}
if(targetLocale==='en_us'||targetLocale==='en_gb'){
targetLocale='en'
}
var getAllTextNodes=function(){
var node,textNodes=[],walker=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,null,false);
while(true){
node=walker.nextNode();
if(!node){
break
}
textNodes.push({
node:node,
nodeValue:node.nodeValue
})
}
return textNodes
};
getAllTextNodes().forEach(function(ob,iNode){
Object.keys(window.I18NKEYS).forEach(function(key,iKey){
var strCurrentLanguage=window.I18NKEYS[key][sourceLocale],value;
if(ob.nodeValue===strCurrentLanguage){
value=window.I18NKEYS[key][targetLocale];
if(value){
ob.node.nodeValue=value
}
}else if(ob.nodeValue===strCurrentLanguage+':'){
value=window.I18NKEYS[key][targetLocale];
if(value){
ob.node.nodeValue=value+':'
}
}
})
})
};
var win=web.dev.allInOne.win=new Ext.Window({
id:'unified-bookmarklet',
title:'Unified bookmarklet',
width:575,
layout:'form',
items:[{
xtype:'container',
layout:'column',
layoutConfig:{columns:2},
defaults:{
columnWidth:0.5,
style:{margin:'10px 10px 0px 10px'}
},
items:[
{
xtype:'label',
text:'Reload JS:'
},
{
xtype:'container',
items:[
{
xtype:'textfield',
ref:'../../fileToReload',
width:217,
style:'marginTop:-2px;font-size:9px;border-right-width:0',
value:localStorage['one-reloadJS']||'/js/web/',
listeners:{
change:function(field,newValue){
var updateToValue=newValue.replace(/\\/g,'/');
var str='http-pub/';
var strIndex=updateToValue.indexOf(str);
if(strIndex!==-1){
updateToValue=updateToValue.substr(strIndex+str.length)
}
field.setValue(updateToValue)
}
}
},
{
xtype:'button',
text:'',
handler:function(btn){
var src=win.fileToReload.getValue();
var script=document.createElement('script');
script.setAttribute('src',src+'?'+Math.random());
script.onload=function(){
localStorage['one-reloadJS']=src;
web.dev.alertNote('Reloaded '+src)
};
document.body.appendChild(script)
}
}
]
},
{
xtype:'label',
text:'Restart (quick reload whole viewport):'
},
{
xtype:'button',
text:'Restart',
handler:function(btn){
web.dev.restart();
win.hide();
setTimeout(function(){
try{
web.dev.allInOne()
}catch(e){
}
},2000)
}
},
{
xtype:'label',
text:'Change language (texts in current view):'
},
{
xtype:'web-combobox',
mode:'local',
columnWidth:'0.495',
emptyText:'Click here to change',
triggerAction:'all',
selectedIndex:0,
editable:false,
store:new Ext.data.ArrayStore({
fields:[
'language_code',
'text1'
],
data:[
[
'en_us',
'en - English'
],
[
'cs',
'cs - etina (Czech)'
],
[
'da',
'da - Dansk (Danish)'
],
[
'de',
'de - Deutsch (German)'
],
[
'es',
'es - Espaol (Spanish)'
],
[
'fi',
'fi - Suomi (Finnish)'
],
[
'fr',
'fr - Franais (French)'
],
[
'it',
'it - Italiano (Italian)'
],
[
'nb',
'nb - Norsk bokml (Norwegian Bokml)'
],
[
'nl',
'nl - Nederlands (Dutch)'
],
[
'pl',
'pl - Polski (Polish)'
],
[
'pt',
'pt - Portugus (Portuguese)'
],
[
'sv',
'sv - Svenska (Swedish)'
]
]
}),
valueField:'language_code',
displayField:'text1',
listeners:{
select:function(combo,record,index){
changeLanguageForTesting(record.json[0]);
web.dev.alertNote('Changed language to: '+record.json[1]+'<br />Note that it does not reflect 100% accurate view.')
},
scope:this
}
},
{
xtype:'label',
text:'Import:'
},
{
xtype:'button',
text:'Recreate from webcreator',
handler:function(btn){
web.dev.import();
win.hide()
}
},
{
xtype:'label',
text:'Remembers last page id: '+(remembersLastPageId?'Yes':'No')
},
{
xtype:'button',
text:'Clear last page id',
disabled:!remembersLastPageId,
handler:function(btn){
dal.uiState['delete']('lastPageId');
btn.disable();
web.dev.alertNote('Cleared last page id');
win.hide()
}
},
{
xtype:'label',
text:'Crash notifications: '+(crashNotifications?'On':'Off'),
style:'margin:10px 10px 0px 10px; font-weight:bold;'
},
{
xtype:'button',
text:crashNotifications?'Turn off crash notifications':'Turn on crash notifications',
handler:function(btn){
if(crashNotifications){
delete localStorage['one-crash-notifications'];
web.dev.alertNote('Turned off crash notifications');
btn.setText('Turn on crash notifications')
}else{
localStorage['one-crash-notifications']='true';
web.dev.alertNote('Turned on crash notifications');
btn.setText('Turn off crash notifications')
}
win.hide()
}
},
{
xtype:'label',
text:'Rollback:'
},
{
xtype:'button',
text:'Show Rollback',
handler:function(btn){
new web.windows.Rollback().show();
win.hide()
}
},
{
xtype:'label',
text:'Get page data button:'
},
{
xtype:'button',
text:getAllPageDataBtnEnabled?'Get page data button is already enabled':'Enable get page data button',
disabled:getAllPageDataBtnEnabled,
handler:function(btn){
try{
app.sidebar.getItem('sitemap').tree.pageMenu.getAllPageDataBtn.show();
btn.setText('Get page data button is already enabled');
btn.disable();
web.dev.alertNote('Enabled Get page data button');
win.hide()
}catch(e){
Ext.Msg.alert('Error','Error.<br/>Could not show the Get Page Data button')
}
}
},
{
xtype:'label',
text:'Put/overwrite page/stylesheet/template:'
},
{
xtype:'button',
text:'Provide JSON',
handler:function(btn){
Ext.Msg.show({
cls:'dev-tools-overwrite-data',
multiline:300,
title:'Enter page/stylesheet/template data (JSON)',
msg:'<pre>'+'var dal = new web.DAL({domain: <b>"'+domain+'"</b>}),\n'+'    dm = new web.DM(),\n'+'    dmComponent = dm.create(<b><<{page/stylesheet/template json goes here}>></b>);\n'+'dal.set(dmComponent);\n'+'</pre>',
buttons:Ext.Msg.OKCANCEL,
fn:function(btnClicked,textEntered,config){
if(btnClicked==='ok'){
var dal,dm,dmComponent;
try{
var json=JSON.parse(textEntered);
if(!json.type||json.type!=='web.data.components.Page'&&json.type!=='web.data.components.Template'&&json.type!=='web.data.styles.Stylesheet'&&json.type!=='web.data.components.Stylesheet'){
Ext.Msg.alert('Error','Aborting.<br/><br/>The JSON object you provided does not have an appropriate "type".');
return
}
dal=new web.DAL({domain:domain});
dm=new web.DM;
dmComponent=dm.create(json)
}catch(e){
Ext.Msg.alert('Error','Error!<br/><br/>Some error has occurred even before attempting to put/overwrite page/template/stylesheet.');
return
}
dal.set(dmComponent,function(request,success,response){
if(success){
Ext.Msg.alert('Success','Done!<br/><br/>Response:<br/>'+(response&&response.responseText))
}else{
Ext.Msg.alert('Error','Error!<br/><br/>Some error has occurred.<br/><br/>Response:<br/>'+(response&&response.responseText))
}
})
}
}
});
var oldMsgHeight=Ext.Msg.height,dialog=Ext.Msg.getDialog().setHeight(600).center();
var beforehideHandler=function(){
Ext.Msg.height=oldMsgHeight;
dialog.setHeight(Ext.Msg.height).center().un('beforehide',beforehideHandler)
};
dialog.on('beforehide',beforehideHandler);
win.hide()
}
},
{
xtype:'label',
text:'Print Sitemap Tree in console:'
},
{
xtype:'button',
text:'Print Sitemap',
handler:function(btn){
function printSiteMap(linkPage,prefix){
;
if(linkPage.items&&linkPage.items.length){
linkPage.items.forEach(function(l){
printSiteMap(l,'--'+prefix)
})
}
}
;
app.site.folder.items.forEach(function(linkPage){
printSiteMap(linkPage,'')
})
}
},
{
xtype:'label',
text:'Enable backups feature: '+(backupsFeature?'Enabled':'Default'),
style:'margin:10px 10px 0px 10px;'
},
{
xtype:'button',
text:backupsFeature?'Click to use default behavior':'Click to enable',
handler:function(btn){
if(backupsFeature){
delete localStorage['backups-feature'];
web.dev.alertNote('Using default display setting for Backups feature');
btn.setText('Click to enable')
}else{
localStorage['backups-feature']='enabled';
web.dev.alertNote('Enabled Backups feature');
btn.setText('Click to use default behavior')
}
win.hide()
}
},
{
xtype:'label',
text:'Allow old and new WSB together: '+(allowOldAndNewWsbTogether?'Yes':'No'),
style:'margin:10px 10px 0px 10px; font-weight:bold;'
},
{
xtype:'button',
text:allowOldAndNewWsbTogether?'Reset to default behavior':'Allow',
handler:function(btn){
if(allowOldAndNewWsbTogether){
delete localStorage['allowOldAndNewWsbTogether'];
web.dev.alertNote('Next load onwards, you would get redirected to preferred WSB if that is the default behavior for your environment');
btn.setText('Allow')
}else{
localStorage['allowOldAndNewWsbTogether']='yes';
web.dev.alertNote('Now onwards, you can use both old and new WSB together');
btn.setText('Reset to default behavior')
}
win.hide()
}
},
{
xtype:'label',
text:'Try New WSB button status:',
style:'margin:10px 10px 0px 10px; font-weight:bold;'
},
{
xtype:'label',
style:'word-wrap:break-word; margin: 10px 10px 0',
text:(web.DAL.prototype.canUseNewWebsiteBuilder||{}).lastFailureReason||'Should be available'
}
]
}]
});
win.show();
win.setHeight(535);
win.center()
};
web.dev.restart=function(){
var $=oneJQuery;
$(window).unbind();
$('.web-app').remove();
$('.newui-shadows').remove();
$('.ddtree-options-ui').remove();
var msgBox=Ext.Msg.getDialog();
var allInOneWindow=web.dev.allInOne.win;
var isPartOfRequiredWindow=function(that){
var flag=false;
while(that){
if(that===msgBox||allInOneWindow&&that===allInOneWindow){
flag=true
}
that=that.ownerCt
}
return flag
};
Ext.ComponentMgr.all.each(function(){
try{
if(this.destroy&&!this.tipAnchor&&!this.progressBar&&!isPartOfRequiredWindow(this)){
this.destroy()
}
}catch(e){
}
});
new one.Viewport({
getLocaleFileUrl:function(fileName){
return{
'cs.js':'static/cs.325e77b413.js',
'da.js':'static/da.876f87b4f2.js',
'de.js':'static/de.2b2af8bf60.js',
'en_gb.js':'static/en_gb.f25f80d6b5.js',
'en_us.js':'static/en_us.1670cc549a.js',
'es.js':'static/es.505399543c.js',
'fi.js':'static/fi.df1eb4965e.js',
'fr.js':'static/fr.eaf13f5313.js',
'it.js':'static/it.7f96c9c731.js',
'nb.js':'static/nb.b06e0e5bc3.js',
'nl.js':'static/nl.da1b7189fb.js',
'pl.js':'static/pl.43121d84b4.js',
'pt.js':'static/pt.2ac13d8b32.js',
'sv.js':'static/sv.ca6b0264fd.js'
}[fileName]
},
localeId:'en_gb',
applicationConstructor:web.Application,
invokeTime:new Date
})
};
web.dev.testFolders=function(noQuestions){
var testFolders=[],mediaFolder='/onewebmedia/';
for(var i=0;i<5;i+=1){
testFolders.push('oneweb-test-'+(i+1))
}
var app=one.viewport.application;
var dal=app.dal;
dal.unlink=function(path,callback,scope){
this.queueRequest({
method:'DELETE',
url:this.defaultUrl+'/webspace'+path,
callback:callback,
scope:scope||this
})
};
var refreshFileChooser=function(path){
Ext.ComponentMgr.all.items.forEach(function(c){
if(c.currentPath&&c.showPath){
c.showPath(path||c.currentPath)
}
})
};
var createTestFolders=function(){
dal.getWebspaceContent(mediaFolder,function(x,y,data){
var arr=JSON.parse(data.responseText).entries,list=arr.map(function(item){
return item.href
}),join=testFolders.length;
testFolders.forEach(function(f){
var path=mediaFolder+f+'/';
if(list.indexOf(f+'/')===-1){
dal.createWebspaceDirectory(path,function(){
;
if(--join===0){
emptyTestFolders()
}
})
}else{
if(--join===0){
emptyTestFolders()
}
}
})
})
};
var emptyTestFolders=function(){
var files=[],join=testFolders.length;
var unlinkAll=function(){
join=files.length;
files.forEach(function(f){
if(f!=='.'&&f!=='..'){
;
dal.unlink(f,function(){
if(--join===0){
;
refreshFileChooser()
}
})
}
});
if(files.length===0){
refreshFileChooser()
}
};
testFolders.forEach(function(f){
var folder=mediaFolder+f+'/';
dal.getWebspaceContent(folder,function(x,y,data){
var arr=JSON.parse(data.responseText).entries;
if(arr){
files=files.concat(arr.filter(function(item){
return item.href[0]!=='.'
}).map(function(item){
return folder+item.href
}));
if(--join===0){
unlinkAll()
}
}
})
})
};
var removeTestFolders=function(){
dal.getWebspaceContent(mediaFolder,function(x,y,data){
var arr=JSON.parse(data.responseText).entries,list=arr.map(function(item){
return item.href
}),join=function(){
refreshFileChooser('/onewebmedia/')
},joinCount=testFolders.length;
testFolders.forEach(function(f){
var path=mediaFolder+f+'/';
if(list.indexOf(f+'/')>=0){
dal.unlink(path,function(){
;
if(--joinCount===0){
join()
}
})
}else{
if(--joinCount===0){
join()
}
}
})
})
};
var w=new Ext.Window({
title:'Create test folders (and clear files inside)?',
modal:true,
buttons:[
{
text:'Cancel',
cls:'x-btn-secondary large wide',
xtype:'button',
handler:function(){
w.hide()
}
},
{
text:'Generate Empty Folders',
cls:'x-btn-primary large wide',
xtype:'button',
handler:createTestFolders
},
{
text:'Remove',
cls:'x-btn-primary large wide',
xtype:'button',
handler:removeTestFolders
}
],
items:[{
xtype:'container',
html:'This will create following test folders and delete files inside them:<br>'+testFolders.map(function(f){
return mediaFolder+f
}).join('<br>')+'<br><br>Remove option will also remove files inside them.'
}]
});
w.show()
};
web.dev.premium=function(){
if(location.href.match('webeditor.one.com')){
return
}
var hideShowUpgradeOptions=function(){
if(one.viewport.application.user.subscriptionStatus!==web.UserSubscriptionStatus.PREMIUM){
oneJQuery('.one').removeClass('hide-upgrade-options')
}else{
oneJQuery('.one').addClass('hide-upgrade-options')
}
};
var w=new Ext.Window({
cls:'web-window',
width:500,
height:350,
title:'Premium',
items:[
{
xtype:'container',
style:'margin-top: 20px',
html:'Make the user premium or normal'
},
{
xtype:'container',
layout:'hauto',
cls:'web-panel-button-group-new',
items:[
{
ref:'../premiumOn',
xtype:'button',
text:'Premium user',
toggleGroup:'premium',
cls:'large wide',
handler:function(){
one.viewport.application.user.subscriptionStatus=web.UserSubscriptionStatus.PREMIUM;
hideShowUpgradeOptions()
}
},
{
ref:'../premiumOff',
xtype:'button',
text:'Normal user',
toggleGroup:'premium',
cls:'large wide',
handler:function(){
one.viewport.application.user.subscriptionStatus=web.UserSubscriptionStatus.NORMAL;
hideShowUpgradeOptions()
}
}
]
},
{
xtype:'container',
style:'margin-top: 20px',
html:'Set or remove the free upgrade offer'
},
{
xtype:'container',
layout:'hauto',
cls:'web-panel-button-group-new',
items:[
{
ref:'../offerOn',
xtype:'button',
text:'Free upgrade offer',
toggleGroup:'offer',
cls:'large wide',
handler:function(){
one.viewport.application.user.freeUpgradeAvailable=true;
oneJQuery('.one').addClass('free-upgrade-offer')
}
},
{
ref:'../offerOff',
xtype:'button',
text:'No Offer',
toggleGroup:'offer',
cls:'large wide',
handler:function(){
one.viewport.application.user.freeUpgradeAvailable=false;
oneJQuery('.one').removeClass('free-upgrade-offer')
}
}
]
}
],
onShow:function(){
if(one.viewport.application.user.getSubscriptionStatus()===web.UserSubscriptionStatus.PREMIUM){
w.premiumOn.toggle(true)
}else{
w.premiumOff.toggle(true)
}
if(one.viewport.application.user.freeUpgradeAvailable){
w.offerOn.toggle(true)
}else{
w.offerOff.toggle(true)
}
hideShowUpgradeOptions()
}
});
w.show()
};
Ext.BLANK_IMAGE_URL='//webeditor-static.cdn-one.com/blank_1x1.fc94fb0c3e.gif';
Ext.onReady(function(){
var migrateLanguageCookie,checkBrowser,checkDimension,startApp;
checkBrowser=function(){
if(web.windows.UnsupportedBrowser.unsupported&&!web.windows.UnsupportedBrowser.unsupportedWarningSupressed){
new web.windows.UnsupportedBrowser(checkDimension)
}else{
checkDimension()
}
};
checkDimension=function(){
if(web.windows.UnsupportedDimension.unsupported){
new web.windows.UnsupportedDimension(startApp)
}else{
startApp()
}
};
migrateLanguageCookie=function(){
var oldCookie=Ext.util.Cookies.get('OneWebLang'),newCookie=Ext.util.Cookies.get('OneLang');
Ext.util.Cookies.clear('OneWebLang');
if(oldCookie&&!newCookie){
Ext.util.Cookies.set('OneLang',oldCookie,new Date(2099,0,1),'/','.one.com');
document.location.reload()
}
};
migrateLanguageCookie();
startApp=function(){
Ext.state.Manager.setProvider(new Ext.state.CookieProvider);
new one.Viewport({
getLocaleFileUrl:function(fileName){
return{
'cs.js':'static/cs.325e77b413.js',
'da.js':'static/da.876f87b4f2.js',
'de.js':'static/de.2b2af8bf60.js',
'en_gb.js':'static/en_gb.f25f80d6b5.js',
'en_us.js':'static/en_us.1670cc549a.js',
'es.js':'static/es.505399543c.js',
'fi.js':'static/fi.df1eb4965e.js',
'fr.js':'static/fr.eaf13f5313.js',
'it.js':'static/it.7f96c9c731.js',
'nb.js':'static/nb.b06e0e5bc3.js',
'nl.js':'static/nl.da1b7189fb.js',
'pl.js':'static/pl.43121d84b4.js',
'pt.js':'static/pt.2ac13d8b32.js',
'sv.js':'static/sv.ca6b0264fd.js'
}[fileName]
},
localeId:'en_gb',
applicationConstructor:web.Application,
invokeTime:new Date,
waitForLoading:true
})
};
checkBrowser()
});
(function(i,s,o,g,r,a,m){
i['GoogleAnalyticsObject']=r;
i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)
},i[r].l=1*new Date;
a=s.createElement(o),m=s.getElementsByTagName(o)[0];
a.async=1;
a.src=g;
m.parentNode.insertBefore(a,m)
}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'));
ga('create','UA-32755516-1','auto');
ga('send','pageview',location.pathname);
(function(){
var w=window;
var ic=w.Intercom;
if(typeof ic==='function'){
ic('reattach_activator');
ic('update',intercomSettings)
}else{
var d=document;
var i=function(){
i.c(arguments)
};
i.q=[];
i.c=function(args){
i.q.push(args)
};
w.Intercom=i;
function l(){
var s=d.createElement('script');
s.type='text/javascript';
s.async=true;
s.src='https://widget.intercom.io/widget/'+'nqpz9vww';
var x=d.getElementsByTagName('script')[0];
x.parentNode.insertBefore(s,x)
}
if(w.attachEvent){
w.attachEvent('onload',l)
}else{
w.addEventListener('load',l,false)
}
}
}());